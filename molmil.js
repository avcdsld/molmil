/*!
 * molmil.js
 *
 * Molmil molecular web viewer: https://github.com/gjbekker/molmil
 * 
 * By Gert-Jan Bekker
 * License: LGPLv3
 *   See https://github.com/gjbekker/molmil/blob/master/LICENCE.md
 */
;var molmil=molmil||{};molmil.canvasList=[];molmil.mouseDown=false;molmil.mouseDownS={};molmil.mouseMoved=false;molmil.Xcoord=0;molmil.Ycoord=0;molmil.Zcoord=0;molmil.activeCanvas=null;molmil.touchList=null;molmil.touchMode=false;molmil.longTouchTID=null;molmil.previousTouchEvent=null;molmil.ignoreBlackList=false;molmil.settings_default={src:"/molmil/",pdb_url:"http://ipr.pdbj.org/rest/displayPDBfile?format=mmjson-all&id=__ID__",comp_url:"http://ipr.pdbj.org/rest/displayCOMPfile?format=mmjson&id=__ID__",promodeE_check_url:"http://ipr.pdbj.org/rest/quick_search?fields=5&query=__ID__",promodeE_base_structure_url:"http://ipr.pdbj.org/rest/displayPromodeEfile?format=min&id=__ID__",promodeE_mode_vectors_url:"http://ipr.pdbj.org/rest/displayPromodeEfile?format=vec&id=__ID_____MODE__",promodeE_animation_url:"http://ipr.pdbj.org/rest/displayPromodeEfile?format=anm&id=__ID_____MODE__",molmil_video_url:"http://127.0.0.1:8080/app/"};molmil.cli_canvas=null;molmil.cli_soup=null;molmil.settings=window.molmil_settings||molmil.settings_default;for(var e in molmil.settings_default){if(!molmil.settings.hasOwnProperty(e)){molmil.settings[e]=molmil.settings_default[e]}}molmil.configBox={initFinished:false,liteMode:false,cullFace:true,vdwR:{DUMMY:1.7,H:1.09,D:1.09,C:1.7,N:1.55,O:1.52,S:1.8,Cl:1.75,B:1.8,P:1.8,Fe:1.8,Ba:1.8,So:1.8,Mg:1.8,Zn:1.8,Cu:1.4,Ni:1.8,Br:1.95,Ca:1.8,Mn:1.8,Al:1.8,Ti:1.8,Cr:1.8,Ag:1.8,F:1.47,Si:1.8,Au:1.8,I:2.15,Li:1.8,He:1.8,Se:1.9},sndStrucInfo:{1:[255,255,255],2:[255,255,0],3:[255,0,255],4:[0,0,255]},zNear:20,zFar:20000,QLV_SETTINGS:[{SPHERE_TESS_LV:0,CB_NOI:4,CB_NOVPR:4,CB_DOME_TESS_LV:0},{SPHERE_TESS_LV:1,CB_NOI:4,CB_NOVPR:8,CB_DOME_TESS_LV:1},{SPHERE_TESS_LV:2,CB_NOI:8,CB_NOVPR:16,CB_DOME_TESS_LV:2},{SPHERE_TESS_LV:3,CB_NOI:12,CB_NOVPR:32,CB_DOME_TESS_LV:3},{SPHERE_TESS_LV:4,CB_NOI:16,CB_NOVPR:32,CB_DOME_TESS_LV:4}],OES_element_index_uint:null,BGCOLOR:[0,0,0,1],backboneAtoms4Display:{N:1,C:1,O:1,H:1,OXT:1,H1:1,H2:1,H3:1,HA:1,HA2:1,HA3:1},backboneAtoms4DisplayXNA:{P:1,"O5'":1,OP1:1,OP2:1,"C3'":1,"C4'":1,"C5'":1,"O4'":1,"C2'":1,"O3'":1,"O2'":1,H:1},xna_simple_base_atoms:{"O5'":1,"C5'":1,"C4'":1,"O4'":1,"C3'":1,"O3'":1,"C2'":1,O6:1,N2:1,N4:1,P:1,OP1:1,OP2:1,O2:1,"O2'":1,N6:1,O4:1,"DO3'":1,D41:1,D42:1,D21:1,D22:1,D61:1,D62:1},projectionMode:1,colorMode:1,smoothFactor:2,glsl_shaders:[["shaders/standard.glsl"],["shaders/lines.glsl"],["shaders/picking.glsl"],["shaders/linesPicking.glsl"],["shaders/atomSelection.glsl"],["shaders/lines.glsl","lines_uniform_color","#define UNIFORM_COLOR 1\n"],["shaders/standard.glsl","standard_alpha","#define ALPHA_MODE 1\n"],["shaders/standard.glsl","standard_uniform_color","#define UNIFORM_COLOR 1\n"],["shaders/standard.glsl","standard_alpha_uniform_color","#define ALPHA_MODE 1\n#define UNIFORM_COLOR 1\n"]],glsl_fog:0,skipClearGeometryBuffer:true};molmil.AATypes={ALA:1,CYS:1,ASP:1,GLU:1,PHE:1,GLY:1,HIS:1,ILE:1,LYS:1,LEU:1,MET:1,ASN:1,PRO:1,GLN:1,ARG:1,SER:1,THR:1,VAL:1,TRP:1,TYR:1,ACE:1,NME:1,HIP:1,HIE:1,HID:1,CYX:1,A:1,T:1,G:1,C:1,DA:1,DT:1,DG:1,DC:1,U:1,DU:1,MSE:1,SEQ:1,CSW:1};molmil.AATypesBase={ALA:1,CYS:1,ASP:1,GLU:1,PHE:1,GLY:1,HIS:1,ILE:1,LYS:1,LEU:1,MET:1,ASN:1,PRO:1,GLN:1,ARG:1,SER:1,THR:1,VAL:1,TRP:1,TYR:1,ACE:1,NME:1,HIP:1,HIE:1,HID:1};molmil.initSettings=function(){var c,g=localStorage.getItem("molmil.settings_COLORS")||1;if(g==2){c={DUMMY:[255,20,147],H:[255,255,255],D:[255,255,255],C:[144,144,144],N:[48,80,248],O:[255,13,13],S:[255,255,48],Cl:[31,240,31],B:[255,181,181],P:[255,128,0],Fe:[224,102,51],Ba:[0,201,0],Mg:[138,255,0],Zn:[125,128,176],Cu:[200,128,51],Ni:[80,208,80],Br:[165,42,42],Ca:[61,255,0],Mn:[156,122,199],Al:[191,166,166],Ti:[191,194,199],Cr:[138,153,199],Ag:[192,192,192],F:[144,224,80],Si:[240,200,160],Au:[255,209,35],I:[148,0,148],Li:[204,128,255],He:[217,255,255]}}else{if(g==3){c={DUMMY:[255,127,0],H:[204,204,204],D:[204,204,204],C:[0,255,255],N:[0,0,255],O:[255,0,0],P:[255,255,0],S:[0,255,0]}}else{c={DUMMY:[255,20,147],H:[255,255,255],D:[255,255,255],C:[200,200,200],N:[143,143,255],O:[240,0,0],S:[255,200,50],Cl:[0,255,0],B:[0,255,0],P:[255,165,0],Fe:[255,165,0],Ba:[255,165,0],Mg:[34,139,34],Zn:[165,42,42],Cu:[165,42,42],Ni:[165,42,42],Br:[165,42,42],Ca:[128,128,144],Mn:[128,128,144],Al:[128,128,144],Ti:[128,128,144],Cr:[128,128,144],Ag:[128,128,144],F:[218,165,32],Si:[218,165,32],Au:[218,165,32],I:[160,32,240],Li:[178,34,34],He:[255,192,203]}}}molmil.configBox.elementColors={};for(var f in c){molmil.configBox.elementColors[f]=[c[f][0],c[f][1],c[f][2],255]}molmil.configBox.sndStrucColor={};for(var f in molmil.configBox.sndStrucInfo){molmil.configBox.sndStrucColor[f]=[molmil.configBox.sndStrucInfo[f][0],molmil.configBox.sndStrucInfo[f][1],molmil.configBox.sndStrucInfo[f][2],255]}molmil.configBox.bu_colors=[[0,204,255],[255,51,255],[0,255,102],[153,102,255],[255,255,0],[204,102,102],[153,204,102],[204,153,204],[153,153,102],[0,204,204],[153,153,153],[51,153,204],[0,255,153],[51,153,255],[204,102,153],[0,255,204],[51,204,255],[204,102,204],[0,255,255],[102,153,204],[204,153,0],[51,204,102],[102,153,255],[204,153,51],[51,204,153],[102,204,255],[204,153,102],[51,204,204],[153,102,204],[204,153,153],[51,255,51],[51,255,102],[153,153,204],[204,204,0],[51,255,153],[153,153,255],[204,204,51],[51,255,204],[153,204,255],[204,204,102],[51,255,255],[204,102,255],[204,204,153],[102,153,153],[204,153,255],[204,204,204],[102,204,51],[204,204,255],[255,51,204],[102,204,102],[102,204,153],[255,102,51],[102,204,204],[255,102,102],[102,255,0],[255,102,153],[102,255,51],[255,102,204],[102,255,102],[255,102,255],[102,255,153],[255,153,0],[102,255,204],[255,153,51],[102,255,255],[255,153,102],[153,204,0],[255,153,153],[153,204,51],[255,153,204],[255,153,255],[153,204,153],[255,204,0],[153,204,204],[255,204,51],[153,255,0],[255,204,102],[153,255,51],[255,204,153],[153,255,102],[255,204,204],[153,255,153],[255,204,255],[153,255,204],[153,255,255],[255,255,51],[204,255,0],[255,255,102],[204,255,51],[255,255,153],[204,255,102],[255,255,204],[204,255,153],[255,255,255],[204,255,204],[204,255,255]];molmil.configBox.glsl_fog=localStorage.getItem("molmil.settings_glsl_fog")==1;molmil.configBox.projectionMode=localStorage.getItem("molmil.settings_PROJECTION")||1;molmil.configBox.smoothFactor=localStorage.getItem("molmil.settings_BBSF")||2;var d=localStorage.getItem("molmil.settings_BGCOLOR");if(d){try{molmil.configBox.BGCOLOR=JSON.parse(d)}catch(f){}}};molmil.displayMode_None=0;molmil.displayMode_Default=1;molmil.displayMode_Spacefill=2;molmil.displayMode_Spacefill_SC=2.5;molmil.displayMode_BallStick=3;molmil.displayMode_BallStick_SC=3.5;molmil.displayMode_Stick=4;molmil.displayMode_Stick_SC=4.5;molmil.displayMode_Wireframe=5;molmil.displayMode_Wireframe_SC=5.5;molmil.displayMode_CaTrace=6;molmil.displayMode_Tube=7;molmil.displayMode_Cartoon=8;molmil.displayMode_CartoonRocket=8.5;molmil.displayMode_ChainSurfaceCG=10;molmil.displayMode_XNA=400;molmil.colorEntry_Default=1;molmil.colorEntry_Structure=2;molmil.colorEntry_CPK=3;molmil.colorEntry_Group=4;molmil.colorEntry_Chain=5;molmil.colorEntry_Custom=6;molmil.colorEntry_ChainAlt=7;molmil.colorEntry_ABEGO=8;molmil.atomObject=function(h,f,d,g,c){this.xyz=h;this.element=d.charAt(0).toUpperCase()+d.slice(1).toLowerCase();this.atomName=f;this.displayMode=0;this.status=1;this.rgba=[0,0,0,255];this.molecule=g;this.chain=c;this.radius=0;this.AID=0};molmil.atomObject.prototype.toString=function(){return" Atom "+this.atomName+" ("+this.AID+")"};molmil.molObject=function(c,f,d){this.atoms=[];this.name=c;this.id=f;this.RSID=f;this.chain=d;this.ligand=true;this.water=false;this.status=1;this.next=null,this.previous=null;this.rgba=[0,0,0,255];this.sndStruc=1;this.xna=false;this.showSC=false};molmil.molObject.prototype.toString=function(){return" Residue"};molmil.chainObject=function(c,d){this.name=c;this.authName=c;this.molecules=[];this.entry=d;this.display=true;this.modelsXYZ=[[]];this.atoms=[];this.bonds=[];this.bondsOK=false;this.displayMode=molmil.displayMode_Default;this.isHet=true;this.rgba=[255,255,255,255]};molmil.chainObject.prototype.toString=function(){return" Chain"};molmil.entryObject=function(c){this.chains=[];this.meta=c||{}};molmil.polygonObject=function(c){this.programs=[];this.meta=c||{}};molmil.entryObject.prototype.toString=function(){return" Entry"};molmil.animationObj=function(c){this.soup=c;this.renderer=c.renderer;this.frameNo=0;this.motionMode=1;this.init=false;this.delay=66;this.frameAction=function(){};this.detail_or=-1;this.infoBox=null};molmil.animationObj.prototype.initialise=function(c){this.renderer.animationMode=true;this.number_of_frames=this.soup.structures.length?this.soup.structures[0].number_of_frames:0;this.init=true;this.infoBox=c};molmil.animationObj.prototype.updateInfoBox=function(){if(!this.infoBox){return}if(this.infoBox.timeBox){if(this.soup.frameInfo){this.infoBox.timeBox.innerHTML=this.soup.frameInfo[this.frameNo][1]+"ps"}else{this.infoBox.timeBox.innerHTML=this.frameNo}}if(this.infoBox.sliderBox){if(this.soup.frameInfo){this.infoBox.timeBox.value=this.soup.frameInfo[this.frameNo][1]}else{this.infoBox.timeBox.value=this.frameNo}this.infoBox.sliderBox.value=this.frameNo}};molmil.animationObj.prototype.beginning=function(){if(!this.init){this.initialise()}this.frameNo=0;this.renderer.selectFrame(this.frameNo,this.detail_or);this.soup.canvas.update=true;this.frameAction();this.updateInfoBox()};molmil.animationObj.prototype.go2Frame=function(c){if(!this.init){this.initialise()}this.frameNo=c;this.renderer.selectFrame(this.frameNo,this.detail_or);this.soup.canvas.update=true;this.frameAction();this.updateInfoBox()};molmil.animationObj.prototype.previous=function(){if(!this.init){this.initialise()}this.frameNo-=1;if(this.frameNo<0){this.frameNo=0}this.renderer.selectFrame(this.frameNo,this.detail_or);this.soup.canvas.update=true;this.frameAction();this.updateInfoBox()};molmil.animationObj.prototype.pause=function(){if(this.TID){clearTimeout(this.TID);this.TID=null}};molmil.animationObj.prototype.play=function(){if(!this.init){this.initialise()}this.playing=true;if(this.motionMode==2){this.TID=molmil_dep.asyncStart(this.backwardRenderer,[],this,this.delay)}else{this.TID=molmil_dep.asyncStart(this.forwardRenderer,[],this,this.delay)}};molmil.animationObj.prototype.next=function(){if(!this.init){this.initialise()}this.frameNo+=1;if(this.frameNo>=this.number_of_frames){this.frameNo=this.number_of_frames-1}this.renderer.selectFrame(this.frameNo,this.detail_or);this.soup.canvas.update=true;this.frameAction();this.updateInfoBox()};molmil.animationObj.prototype.end=function(){if(!this.init){this.initialise()}this.frameNo=this.number_of_frames-1;this.renderer.selectFrame(this.frameNo,this.detail_or);this.soup.canvas.update=true;this.frameAction();this.updateInfoBox()};molmil.animationObj.prototype.forwardRenderer=function(){this.frameNo+=1;if(this.frameNo>=this.number_of_frames){if(this.motionMode==3){this.frameNo-=1;return this.backwardRenderer()}else{this.playing=false}}else{this.renderer.selectFrame(this.frameNo,this.detail_or);this.soup.canvas.update=true;this.TID=molmil_dep.asyncStart(this.forwardRenderer,[],this,this.delay);this.frameAction();this.updateInfoBox()}};molmil.animationObj.prototype.backwardRenderer=function(){this.frameNo-=1;if(this.frameNo<0){if(this.motionMode==3){this.frameNo+=1;return this.forwardRenderer()}else{this.playing=false}}else{this.renderer.selectFrame(this.frameNo,this.detail_or);this.soup.canvas.update=true;this.TID=molmil_dep.asyncStart(this.backwardRenderer,[],this,this.delay);this.frameAction();this.updateInfoBox()}};molmil.viewer=function(c){this.canvas=c;this.renderer=new molmil.render(this);this.UI=new molmil.UI(this);this.defaultCanvas=[c,this.renderer];this.onAtomPick=function(){};this.animation=new molmil.animationObj(this);this.clear()};molmil.viewer.prototype.toString=function(){return" SOUP"};molmil.viewer.prototype.reloadSettings=function(){this.renderer.reloadSettings()};molmil.viewer.prototype.clear=function(){this.structureFiles=[];this.trajectory=[];this.structures=[];this.chains=[];this.files=[];this.bumats=[];this.BUmatrices={};this.BUassemblies={};this.poly_asym_ids=[];this.BUcache={};this.BUmode=false;this.avgX=0;this.avgY=0;this.avgZ=0;this.stdX=0;this.stdY=0;this.stdZ=0;this.avgXYZ=[];this.stdXYZ=[];this.COR=[0,0,0];this.geomRanges=[0,0,0,0,0,0];this.maxRange=0;this.atomRef={};this.AID=1;this.CID=1;this.MID=1;this.BU=false;this.atomSelection=[];this.hideWaters=false;this.hideHydrogens=false;this.sceneBU=null;this.canvases=[];this.SCstuff=false;if(this.canvas){this.canvas.atomCORset=false;this.canvases=[this.canvas]}this.renderer.clear()};molmil.viewer.prototype.gotoMol=function(n){if(n.N&&n.CA&&n.C){var o,l,h,g=[0,0,0];var o=[n.chain.modelsXYZ[this.renderer.modelId][n.N.xyz],n.chain.modelsXYZ[this.renderer.modelId][n.N.xyz+1],n.chain.modelsXYZ[this.renderer.modelId][n.N.xyz+2]];var l=[n.chain.modelsXYZ[this.renderer.modelId][n.C.xyz],n.chain.modelsXYZ[this.renderer.modelId][n.C.xyz+1],n.chain.modelsXYZ[this.renderer.modelId][n.C.xyz+2]];var h=[n.chain.modelsXYZ[this.renderer.modelId][n.CA.xyz],n.chain.modelsXYZ[this.renderer.modelId][n.CA.xyz+1],n.chain.modelsXYZ[this.renderer.modelId][n.CA.xyz+2]];o[0]-=this.avgXYZ[0];o[1]-=this.avgXYZ[1];o[2]-=this.avgXYZ[2];l[0]-=this.avgXYZ[0];l[1]-=this.avgXYZ[1];l[2]-=this.avgXYZ[2];h[0]-=this.avgXYZ[0];h[1]-=this.avgXYZ[1];h[2]-=this.avgXYZ[2];g[0]=h[0]-((o[0]+l[0])*0.5);g[1]=h[1]-((o[1]+l[1])*0.5);g[2]=h[2]-((o[2]+l[2])*0.5);vec3.normalize(g,g);this.renderer.camera.reset();var f=[o[0]-h[0],o[1]-h[1],o[2]-h[2]];vec3.normalize(f,f);var d=[l[0]-h[0],l[1]-h[1],l[2]-h[2]];vec3.normalize(d,d);var c=vec3.cross([0,0,0],f,d);vec3.normalize(c,c);var p=[g[0]*5-h[0],g[1]*5-h[1],g[2]*5-h[2]];var w=vec3.cross([0,0,0],g,c);vec3.normalize(w,w);var t=vec3.cross([0,0,0],w,g);var q=mat4.create();q[0]=w[0];q[4]=w[1];q[8]=w[2];q[1]=t[0];q[5]=t[1];q[9]=t[2];q[2]=-g[0];q[6]=-g[1];q[10]=-g[2];q[12]=-vec3.dot(w,p);q[13]=-vec3.dot(t,p);q[14]=-vec3.dot(g,p);this.renderer.camera.x=-q[12];this.renderer.camera.y=-q[13];this.renderer.camera.z=q[14]-molmil.configBox.zNear;quat.fromMat3(this.renderer.camera.QView,mat3.fromMat4(mat3.create(),q));quat.normalize(this.renderer.camera.QView,this.renderer.camera.QView)}};molmil.viewer.prototype.waterToggle=function(g){for(var d=0,h,f;d<this.structures.length;d++){if(!this.structures[d].chains){continue}for(h=0;h<this.structures[d].chains.length;h++){for(f=0;f<this.structures[d].chains[h].atoms.length;f++){if(this.structures[d].chains[h].atoms[f].molecule.water){this.structures[d].chains[h].atoms[f].status=g}}}}this.hideWaters=!g};molmil.viewer.prototype.hydrogenToggle=function(g){for(var d=0,h,f;d<this.structures.length;d++){if(!this.structures[d].chains){continue}for(h=0;h<this.structures[d].chains.length;h++){for(f=0;f<this.structures[d].chains[h].atoms.length;f++){if(this.structures[d].chains[h].atoms[f].element=="H"||this.structures[d].chains[h].atoms[f].element=="D"){this.structures[d].chains[h].atoms[f].status=g}}}}this.hideHydrogens=!g};molmil.viewer.prototype.restoreDefaultCanvas=function(c){this.canvas=this.defaultCanvas[0];this.renderer=this.defaultCanvas[1]};molmil.getSelectedAtom=function(d,c){d=d||0;c=c||molmil.cli_soup;if(d>=c.atomSelection.length){return}return c.atomSelection[d]};molmil.viewer.prototype.selectObject=function(p,o,c){o=this.canvas.height-o;var g=this.renderer.gl;if(!this.renderer.FBOs.pickingBuffer){this.renderer.FBOs.pickingBuffer=new molmil.FBO(g,this.renderer.width,this.renderer.height);this.renderer.FBOs.pickingBuffer.addTexture("colourBuffer",g.RGBA,g.RGBA);this.renderer.FBOs.pickingBuffer.setup()}else{if(this.renderer.FBOs.pickingBuffer.width!=this.renderer.width||this.renderer.FBOs.pickingBuffer.height!=this.renderer.height){this.renderer.FBOs.pickingBuffer.resize(this.renderer.width,this.renderer.height)}}this.renderer.FBOs.pickingBuffer.bind();this.renderer.renderPicking();var f=new Uint8Array(4);g.readPixels(p,o,1,1,g.RGBA,g.UNSIGNED_BYTE,f);var n=Math.round(vec4.dot([f[0]/255,f[1]/255,f[2]/255,f[3]/255],[1/(255*255*255),1/(255*255),1/255,1])*4228250625);this.renderer.FBOs.pickingBuffer.unbind();if(n!=0){var h=this.atomRef[n];if(h){var l=this.canvas.commandLine?this.canvas.commandLine.environment.console:console;l.log("Clicked on atom: ",h);console.log("Clicked on atom: ",h);if(c&&c.ctrlKey){var q=true;for(var d=0;d<this.atomSelection.length;d++){if(this.atomSelection[d]==h){q=false;break}}if(q){this.atomSelection.push(h)}if(this.atomSelection.length==2){l.log("Distance: ",molmil.calcMMDistance(this.atomSelection[0],this.atomSelection[1],this)," | ",this.atomSelection[0],this.atomSelection[1])}else{if(this.atomSelection.length==3){l.log("Angle: ",molmil.calcMMAngle(this.atomSelection[0],this.atomSelection[1],this.atomSelection[2],this)," | ",this.atomSelection[0],this.atomSelection[1],this.atomSelection[2])}else{if(this.atomSelection.length==4){l.log("Torsion: ",molmil.calcMMTorsion(this.atomSelection[0],this.atomSelection[1],this.atomSelection[2],this.atomSelection[3],this)," | ",this.atomSelection[0],this.atomSelection[1],this.atomSelection[2],this.atomSelection[3])}}}}else{this.atomSelection=[h]}this.onAtomPick(h);this.canvas.renderer.updateSelection()}}else{this.atomSelection=[];this.canvas.renderer.updateSelection()}this.canvas.update=true};var explorePDB_badData_workaround=false;molmil.viewer.prototype.loadStructure=function(l,o,q,d){d=d||{};var p=l.substr(-3).toLowerCase()==".gz"&&!d.no_pako_gz;if(p&&!window.hasOwnProperty("pako")){var n=document.getElementsByTagName("head")[0];var h=molmil_dep.dcE("script");h.src=molmil.settings.src+"pako.js";h.soup=this;h.argList=[l,o,q,d];h.onload=function(){molmil_dep.asyncStart(this.soup.loadStructure,this.argList,this.soup,0)};n.appendChild(h);return}var g=new molmil_dep.CallRemote("GET"),c=molmil_dep.getKeyFromObject(d||{},"async",true);g.ASYNC=c;g.target=this;g.gz=p;if(g.gz){g.responseType="arraybuffer"}if(this.onloaderror){g.OnError=this.onloaderror}g.filename=l.substr(l.lastIndexOf("/")+1);if(o==1||(o+"").toLowerCase()=="mmjson"){var f=l;if(explorePDB_badData_workaround==true){l+=(l.indexOf("?")==-1?"?":"&")+"t="+(new Date()).getTime()}if(g.ASYNC&&!g.gz){g.responseType="json"}g.parse=function(){if(this.gz){var s=JSON.parse(pako.inflate(new Uint8Array(this.request.response),{to:"string"}))}else{var s=g.request.response}try{if(typeof s!="object"&&s!=null){s=JSON.parse(this.request.responseText)}else{if(s==null){throw""}}}catch(t){explorePDB_badData_workaround=true;return this.target.loadStructure(f,o,q,d)}explorePDB_badData_workaround=false;return this.target.load_PDBx(s,this.pdbid,this.filename)}}else{if(o==2||(o+"").toLowerCase()=="mmcif"){g.parse=function(){return this.target.load_mmCIF(this.gz?pako.inflate(new Uint8Array(this.request.response),{to:"string"}):this.request.responseText,this.filename)}}else{if(o==3||(o+"").toLowerCase()=="pdbml"){g.parse=function(){return this.target.load_PDBML(this.gz?pako.inflate(new Uint8Array(this.request.response),{to:"string"}):this.request.responseXML,this.filename)}}else{if(o==4||(o+"").toLowerCase()=="pdb"){g.parse=function(){return this.target.load_PDB(this.gz?pako.inflate(new Uint8Array(this.request.response),{to:"string"}):this.request.responseText,this.filename)}}else{if(o==5||(o+"").toLowerCase()=="polygon-xml"){g.parse=function(){return this.target.load_polygonXML(this.gz?pako.inflate(new Uint8Array(this.request.response),{to:"string"}):this.request.responseXML||this.request.responseText,this.filename,d)}}else{if(o==6||(o+"").toLowerCase()=="polygon-json"){g.ASYNC=true;g.responseType="json";g.parse=function(){var s=this.gz?JSON.parse(pako.inflate(new Uint8Array(this.request.response),{to:"string"})):g.request.response;if(typeof s!="object"&&s!=null){s=JSON.parse(this.request.responseText)}return this.target.load_polygonJSON(s,this.filename)}}else{if(o==7||(o+"").toLowerCase()=="gro"){g.parse=function(){return this.target.load_GRO(this.gz?pako.inflate(new Uint8Array(this.request.response),{to:"string"}):this.request.responseText,this.filename)}}else{if(o==8||(o+"").toLowerCase()=="mpbf"){g.ASYNC=true;g.responseType="arraybuffer";g.parse=function(){return this.target.load_MPBF(this.request.response,this.filename)}}else{if((o+"").toLowerCase()=="ccp4"){g.ASYNC=true;g.responseType="arraybuffer";g.parse=function(){return this.target.load_ccp4(this.request.response,this.filename)}}else{if((o+"").toLowerCase()=="obj"){g.ASYNC=true;g.parse=function(){return this.target.load_obj(this.request.response,this.filename)}}else{if((o+"").toLowerCase()=="mdl"){g.parse=function(){return this.target.load_mdl(this.gz?pako.inflate(new Uint8Array(this.request.response),{to:"string"}):this.request.responseText,this.filename)}}else{if((o+"").toLowerCase()=="mol2"){g.parse=function(){return this.target.load_mol2(this.gz?pako.inflate(new Uint8Array(this.request.response),{to:"string"}):this.request.responseText,this.filename)}}else{if((o+"").toLowerCase()=="xyz"){g.parse=function(){return this.target.load_xyz(this.gz?pako.inflate(new Uint8Array(this.request.response),{to:"string"}):this.request.responseText,this.filename)}}else{if(o.toLowerCase()=="gromacs-trr"){g.ASYNC=true;g.responseType="arraybuffer";g.parse=function(){return this.target.loadGromacsTRR(this.request.response,this.filename)}}else{if(o.toLowerCase()=="gromacs-xtc"){g.ASYNC=true;g.responseType="arraybuffer";g.parse=function(){return this.target.loadGromacsXTC(this.request.response,this.filename)}}else{if(o.toLowerCase()=="psygene-traj"){g.ASYNC=true;g.responseType="arraybuffer";g.parse=function(){var s=this.request.response;this.target.loadMyPrestoTrj(s,molmil_dep.getKeyFromObject(d||{},"fxcell",null));return this.target.structures}}else{console.log("Unknown format: "+o);return}}}}}}}}}}}}}}}}g.ondone=q;g.OnDone=function(){var s=this.parse();if(!s){return}molmil.safeStartViewer(this.target.canvas);if(q){q(this.target,s)}else{molmil.displayEntry(s,1);molmil.colorEntry(s,1,null,true,this.target)}};g.Send(l)};molmil.toBigEndian32=function(d,l,o,h){var c=new Uint32Array(d,l,o),f,g;for(f=0;f<o;f++){g=c[f];c[f]=(((g&255)<<24)|((g&65280)<<8)|((g>>8)&65280)|((g>>24)&255))}return new h(d,l,o)};molmil.toBigEndian64=function(c,l,o,h){var g=new DataView(c,l,o*8);var d=new Float64Array(o);for(var f=0;f<o;f++){d[f]=g.getFloat64(f*8)}return d};molmil.toBigEndian64_=function(h,g,f,d){var o=new Uint32Array(h,g,f),l,q,p;for(l=0;l<f*2;l+=2){q=o[l];p=o[l+1];o[l+1]=((q&255)<<24)|((q&65280)<<8)|((q>>8)&65280)|((q>>24)&255);o[l]=((p&255)<<24)|((p&65280)<<8)|((p>>8)&65280)|((p>>24)&255)}if(d==Float64Array&&g%8!=0){var c=new DataView(h,g,f);var s=new Float64Array(f);for(l=0;l<f;l++){}}return new d(h,g,f)};molmil.xtc_sizeofint=function(d){var c=1,f=0;while(d>=c&&f<32){f++;c<<=1}return f};molmil.xtc_sizeofints=function(n,o){var h,l,d,g,p=new Uint8Array(32),c,f;d=1;p[0]=1;g=0;for(h=0;h<n;h++){f=0;for(c=0;c<d;c++){f=p[c]*o[h]+f;p[c]=f&255;f>>=8}while(f!=0){p[c++]=f&255;f>>=8}d=c}l=1;d--;while(p[d]>=l){g++;l*=2}return g+d*8};molmil.xtc_decodebits=function(g,f,n){var h,d,c=(1<<n)-1,l=new Uint32Array(g.subarray(1,3));h=g[0];d=0;while(n>=8){l[1]=(l[1]<<8)|f[h++];d|=(l[1]>>l[0])<<(n-8);n-=8}if(n>0){if(l[0]<n){l[0]+=8;l[1]=(l[1]<<8)|f[h++]}l[0]-=n;d|=(l[1]>>l[0])&((1<<n)-1)}d&=c;g[0]=h;g[1]=l[0];g[2]=l[1];return d};molmil.xtc_decodeints=function(d,g,q,l,t,s){var u=new Int32Array(32),n,h,f,c,o;u[1]=u[2]=u[3]=0;f=0;while(l>8){u[f++]=molmil.xtc_decodebits(d,g,8);l-=8}if(l>0){u[f++]=molmil.xtc_decodebits(d,g,l)}for(n=q-1;n>0;n--){o=0;for(h=f-1;h>=0;h--){o=(o<<8)|u[h];c=(o/t[n])|0;u[h]=c;o=o-c*t[n]}s[n]=o}s[0]=u[0]|(u[1]<<8)|(u[2]<<16)|(u[3]<<24)};molmil.viewer.prototype.loadGromacsXTC=function(x){var p=this.structures[0].chains,V=[],U,E=[];for(U=0;U<p.length;U++){V.push([(p[U].atoms[0].AID-1)*3,p[U].atoms.length*3]);p[U].modelsXYZ=[]}this.frameInfo=[];var F=[0,0,0,0,0,0,0,0,0,8,10,12,16,20,25,32,40,50,64,80,101,128,161,203,256,322,406,512,645,812,1024,1290,1625,2048,2580,3250,4096,5060,6501,8192,10321,13003,16384,20642,26007,32768,41285,52015,65536,82570,104031,131072,165140,208063,262144,330280,416127,524287,660561,832255,1048576,1321122,1664510,2097152,2642245,3329021,4194304,5284491,6658042,8388607,10568983,13316085,16777216];var q=9;var T=F.length;var H=0,J,d,A=molmil.toBigEndian32,U,B,S,K,s,w,M,n,R,C,G,h,t,Q,u,I,f,l,y,O,z,o,D,P,N,g,L;var u=new Int32Array(3);while(true){d={};J=molmil.toBigEndian32(x,H,3,Int32Array);H+=12;d.magicnum=J[0];d.natoms=J[1];d.step=J[2];J=A(x,H,10,Float32Array);H+=40;d.time=J[0];d.box=J.subarray(1);if(d.natoms<=9){d.x=A(x,H,d.natoms*3,Float32Array);H+=d.natoms*4}else{u[0]=u[1]=u[2]=0;s=[0,0,0];t=[0,0,0];w=[0,0,0];z=[0,0,0];o=[0,0,0];d.x=new Float32Array(d.natoms*3);g=0;B=molmil.toBigEndian32(x,H,1,Int32Array)[0];H+=4;S=A(x,H,1,Float32Array)[0];H+=4;K=molmil.toBigEndian32(x,H,6,Int32Array);H+=24;s[0]=K[3]-K[0]+1;s[1]=K[4]-K[1]+1;s[2]=K[5]-K[2]+1;if((s[0]|s[1]|s[2])>16777215){w[0]=molmil.xtc_sizeofint(s[0]);w[1]=molmil.xtc_sizeofint(s[1]);w[2]=molmil.xtc_sizeofint(s[2]);M=0}else{M=molmil.xtc_sizeofints(3,s)}n=molmil.toBigEndian32(x,H,1,Int32Array)[0];H+=4;J=n+8;R=(T<J)?T:J;C=R-8;J=n-1;J=(q>J)?q:J;G=(F[J]/2)|0;h=(F[n]/2)|0;t[0]=t[1]=t[2]=F[n];Q=F[R];L=molmil.toBigEndian32(x,H,1,Int32Array)[0];H+=4;L=Math.ceil(L/4)*4;l=1/S;y=0;O=0;I=new Uint8Array(x,H);z[0]=z[1]=z[2]=0;while(O<B){if(M==0){z[0]=molmil.xtc_decodebits(u,I,w[0]);z[1]=molmil.xtc_decodebits(u,I,w[1]);z[2]=molmil.xtc_decodebits(u,I,w[2])}else{molmil.xtc_decodeints(u,I,3,M,s,z)}O++;z[0]+=K[0];z[1]+=K[1];z[2]+=K[2];o[0]=z[0];o[1]=z[1];o[2]=z[2];D=molmil.xtc_decodebits(u,I,1);P=0;if(D==1){y=molmil.xtc_decodebits(u,I,5);P=y%3;y-=P;P--}if(y>0){z[0]=z[1]=z[2]=0;for(N=0;N<y;N+=3){molmil.xtc_decodeints(u,I,3,n,t,z);O++;z[0]+=o[0]-h;z[1]+=o[1]-h;z[2]+=o[2]-h;if(N==0){J=z[0];z[0]=o[0];o[0]=J;J=z[1];z[1]=o[1];o[1]=J;J=z[2];z[2]=o[2];o[2]=J;d.x[g++]=o[0]*l;d.x[g++]=o[1]*l;d.x[g++]=o[2]*l}else{o[0]=z[0];o[1]=z[1];o[2]=z[2]}d.x[g++]=z[0]*l;d.x[g++]=z[1]*l;d.x[g++]=z[2]*l}}else{d.x[g++]=z[0]*l;d.x[g++]=z[1]*l;d.x[g++]=z[2]*l}n+=P;if(P<0){h=G;if(n>q){G=(F[n-1]/2)|0}else{G=0}}else{if(P>0){G=h;h=(F[n]/2)|0}}t[0]=t[1]=t[2]=F[n];if(t[0]==0||t[1]==0||t[2]==0){console.error("(xdrfile error) Undefined error.");return}}H+=L}E.push(d.x);for(U=0;U<V.length;U++){p[U].modelsXYZ.push(d.x.subarray(V[U][0],V[U][0]+V[U][1]))}for(U=0;U<d.natoms*3;U++){d.x[U]*=10}this.frameInfo.push([d.step,d.time]);if(H>=x.byteLength){break}}this.structures[0].number_of_frames=this.structures[0].chains.length?this.structures[0].chains[0].modelsXYZ.length:0;return[this.structures.length?this.structures[0]:{}]};molmil.viewer.prototype.loadGromacsTRR=function(o){var h,n=0,l,p,q,d,w,u,g=[],t;var s=this.structures[0].chains,f=[];for(t=0;t<s.length;t++){f.push([(s[t].atoms[0].AID-1)*3,s[t].atoms.length*3]);s[t].modelsXYZ=[]}this.frameInfo=[];while(true){h={};q=molmil.toBigEndian32(o,n,2,Int32Array);n+=8;h.magicnum=q[0];h.i1=q[1];l=molmil.toBigEndian32(o,n,1,Int32Array)[0];n+=4;h.version=molmil.decodeUtf8(new Uint8Array(o,n,l));n+=l;q=molmil.toBigEndian32(o,n,13,Int32Array);n+=13*4;h.ir_size=q[0];h.e_size=q[1];h.box_size=q[2];h.vir_size=q[3];h.pres_size=q[4];h.top_size=q[5];h.sym_size=q[6];h.x_size=q[7];h.v_size=q[8];h.f_size=q[9];h.natoms=q[10];h.step=q[11];h.nre=q[12];d=h.box_size/9;if(d==8){w=molmil.toBigEndian64;u=Float64Array}else{w=molmil.toBigEndian32;u=Float32Array}q=w(o,n,2,u);n+=2*d;h.time=q[0];h.lam=q[1];if(h.box_size){h.box=w(o,n,9,u);n+=h.box_size}if(h.vir_size){h.vir=w(o,n,9,u);n+=h.vir_size}if(h.pres_size){h.pres=w(o,n,9,u);n+=h.pres_size}if(h.x_size){h.x=w(o,n,h.natoms*3,u);for(t=0;t<h.natoms*3;t++){h.x[t]*=10}n+=h.x_size;g.push(h.x);for(t=0;t<f.length;t++){s[t].modelsXYZ.push(h.x.subarray(f[t][0],f[t][0]+f[t][1]))}}if(h.v_size){n+=h.v_size}if(h.f_size){n+=h.f_size}this.frameInfo.push([h.step,h.time]);if(n>=o.byteLength){break}}this.structures[0].number_of_frames=this.structures[0].chains.length?this.structures[0].chains[0].modelsXYZ.length:0;return[this.structures.length?this.structures[0]:{}]};molmil.viewer.prototype.loadMyPrestoTrj=function(F,C){var t=0,y,G,J,L;this.trajectoryMD=[];var h=[];var I=this.structures[0].chains,u=[];for(L=0;L<I.length;L++){u.push([(I[L].atoms[0].AID-1)*3,I[L].atoms.length*3]);I[L].modelsXYZ=[]}while(true){y=[];Array.prototype.push.apply(y,new Int32Array(F,t,2));t+=8;Array.prototype.push.apply(y,new Float32Array(F,t,7));t+=28;Array.prototype.push.apply(y,new Int32Array(F,t,2));t+=8;Array.prototype.push.apply(y,new Float32Array(F,t,1));t+=4;Array.prototype.push.apply(y,new Int32Array(F,t,2));t+=8;this.trajectoryMD.push(y);G=new Float32Array(F,t,y[13]/4);t+=y[13];t+=4;h.push(G);for(L=0;L<u.length;L++){I[L].modelsXYZ.push(G.subarray(u[L][0],u[L][0]+u[L][1]))}if(t>=F.byteLength){break}}this.structures[0].number_of_frames=this.structures[0].chains.length?this.structures[0].chains[0].modelsXYZ.length:0;if(C&&C.length&&(C[0]!=0||C[1]!=0||C[2]!=0)){var d=this.structures[0];var H,L,E,M,z,s,p,o,x,D,B,A,l,K,w,q=Math.round,N,n,g,f;for(H=0;H<h.length;H++){n=h[H];for(L=0;L<d.chains.length;L++){N=d.chains[L].molecules;for(E=0;E<N.length-1;E++){z=N[E].N||N[E].CA;if(!z){continue}x=N[E+1].N||N[E+1].CA;if(!x){continue}g=(x.AID-1)*3;f=(z.AID-1)*3;K=n[g]-n[f];w=q(K/C[0]);n[f]+=w*C[0];g++;f++;K=n[g]-n[f];w=q(K/C[1]);n[f]+=w*C[1];g++;f++;K=n[g]-n[f];w=q(K/C[2]);n[f]+=w*C[2]}for(E=1;E<N.length;E++){z=N[E].N||N[E].CA;if(!z){continue}x=N[E-1].N||N[E-1].CA;if(!x){continue}g=(x.AID-1)*3;f=(z.AID-1)*3;K=n[g]-n[f];w=q(K/C[0]);n[f]+=w*C[0];g++;f++;K=n[g]-n[f];w=q(K/C[1]);n[f]+=w*C[1];g++;f++;K=n[g]-n[f];w=q(K/C[2]);n[f]+=w*C[2];l=N[E].atoms;for(M=0;M<l.length;M++){g=(z.AID-1)*3;f=(l[M].AID-1)*3;K=n[g]-n[f];w=q(K/C[0]);n[f]+=w*C[0];g++;f++;K=n[g]-n[f];w=q(K/C[1]);n[f]+=w*C[1];g++;f++;K=n[g]-n[f];w=q(K/C[2]);n[f]+=w*C[2]}}}}}return[this.structures.length?this.structures[0]:{}]};molmil.viewer.prototype.loadStructureData=function(g,h,d,c,f){var l;if(h==1||(h+"").toLowerCase()=="mmjson"){l=this.load_PDBx(typeof g=="string"?JSON.parse(g):g,d)}else{if(h==2||(h+"").toLowerCase()=="cif"){l=this.load_mmCIF(g,d)}else{if(h==3||(h+"").toLowerCase()=="pdbml"){l=this.load_PDBML(g,d)}else{if(h==4||(h+"").toLowerCase()=="pdb"){l=this.load_PDB(g,d)}else{if(h==5||(h+"").toLowerCase()=="polygon-xml"){l=this.load_polygonXML(g,d,f)}else{if(h==6||(h+"").toLowerCase()=="polygon-json"){l=this.load_polygonJSON(typeof g=="object"?g:JSON.parse(g),d)}else{if(h==7||(h+"").toLowerCase()=="gro"){l=this.load_GRO(g,d)}else{if(h==8||(h+"").toLowerCase()=="mpbf"){l=this.load_MPBF(g,d)}else{if((h+"").toLowerCase()=="mdl"){l=this.load_mdl(g,d)}else{if((h+"").toLowerCase()=="mol2"){l=this.load_mol2(g,d)}else{if((h+"").toLowerCase()=="xyz"){l=this.load_xyz(g,d)}else{if((h+"").toLowerCase()=="ccp4"){l=this.load_ccp4(g,d)}else{if((h+"").toLowerCase()=="psygene-traj"){l=this.loadMyPrestoTrj(g,molmil_dep.getKeyFromObject(f||{},"fxcell",null))}else{if((h+"").toLowerCase()=="gromacs-trr"){l=this.loadGromacsTRR(g)}else{if((h+"").toLowerCase()=="gromacs-xtc"){l=this.loadGromacsXTC(g)}}}}}}}}}}}}}}}if(!l){return}if(this.canvas){molmil.safeStartViewer(this.canvas)}if(c){c(this,l)}else{molmil.displayEntry(l,1);molmil.colorEntry(l,1,null,true,this)}};molmil.viewer.prototype.buildAminoChain=function(c){if(c.isHet){return}var p,o,f,d,g,n,h=c.entry;var l=c.modelsXYZ[0];c.bonds=[];for(p=0;p<c.molecules.length;p++){g=c.molecules[p].xna?64:16;for(o=p+1;o<c.molecules.length;o++){if(c.molecules[p].xna!=c.molecules[o].xna){continue}if(c.molecules[p].C&&c.molecules[o].N){f=c.molecules[p].C.xyz;d=c.molecules[o].N.xyz;dx=l[f]-l[d];dx*=dx;dy=l[f+1]-l[d+1];dy*=dy;dz=l[f+2]-l[d+2];dz*=dz;r=dx+dy+dz;if(r<=3.24){c.molecules[p].next=c.molecules[o];c.molecules[o].previous=c.molecules[p];c.bonds.push([c.molecules[p].C,c.molecules[o].N,1]);break}else{if(c.molecules[o].C&&c.molecules[p].N){f=c.molecules[o].C.xyz;d=c.molecules[p].N.xyz;dx=l[f]-l[d];dx*=dx;dy=l[f+1]-l[d+1];dy*=dy;dz=l[f+2]-l[d+2];dz*=dz;r=dx+dy+dz;if(r<=3.24){c.molecules[p].next=c.molecules[o];c.molecules[o].previous=c.molecules[p];c.bonds.push([c.molecules[p].C,c.molecules[o].N,1]);break}}}}else{if(c.molecules[p].CA&&c.molecules[o].CA){f=c.molecules[p].CA.xyz;d=c.molecules[o].CA.xyz;dx=l[f]-l[d];dx*=dx;dy=l[f+1]-l[d+1];dy*=dy;dz=l[f+2]-l[d+2];dz*=dz;r=dx+dy+dz;if(r<=g){c.molecules[p].next=c.molecules[o];c.molecules[o].previous=c.molecules[p];break}}}}}};molmil.viewer.prototype.buildBondList=function(d,s){var w,u,l,h;var z,x,t,c,g,f,o,n,y=molmil.configBox.vdwR;if(s||d.bonds.length==0){this.buildAminoChain(d)}var q=d.modelsXYZ[0],p=false;d.bondsOK=true;for(w=0;w<d.molecules.length;w++){molmil.buildBondsList4Molecule(d.bonds,d.molecules[w],q);if(d.molecules[w].CA){if(d.molecules[w].name=="CYS"){l=molmil.getAtomFromMolecule(d.molecules[w],"SG");if(!l){continue}for(u=w+1;u<d.molecules.length;u++){if(d.molecules[w].CA){if(d.molecules[u].name!="CYS"){continue}h=molmil.getAtomFromMolecule(d.molecules[u],"SG");if(!h){continue}o=l.xyz;n=h.xyz;z=q[o]-q[n];z*=z;x=q[o+1]-q[n+1];x*=x;t=q[o+2]-q[n+2];t*=t;c=z+x+t;if(c<=5){d.bonds.push([l,h,1]);break}}}}}else{if(d.molecules[w].ligand){for(u=w+1;u<d.molecules.length;u++){if(!d.molecules[u].ligand){continue}for(g=0;g<d.molecules[w].atoms.length;g++){if(d.molecules[w].atoms[g].element=="H"||d.molecules[w].atoms[g].element=="D"){continue}o=d.molecules[w].atoms[g].xyz;for(f=0;f<d.molecules[u].atoms.length;f++){if(d.molecules[u].atoms[f].element=="H"||d.molecules[u].atoms[f].element=="D"){continue}n=d.molecules[u].atoms[f].xyz;z=q[o]-q[n];z*=z;x=q[o+1]-q[n+1];x*=x;t=q[o+2]-q[n+2];t*=t;c=z+x+t;maxDistance=3.24;if(y[d.molecules[w].atoms[g].element]===undefined||y[d.molecules[w].atoms[g].element]>=1.8){if(y[d.molecules[u].atoms[f].element]===undefined||y[d.molecules[u].atoms[f].element]>=1.8){maxDistance=6}else{maxDistance=4.5}}else{if(y[d.molecules[u].atoms[f].element]===undefined||y[d.molecules[u].atoms[f].element]>=1.8){if(y[d.molecules[w].atoms[g].element]===undefined||y[d.molecules[w].atoms[g].element]>=1.8){maxDistance=6}else{maxDistance=4.5}}}if(c<=maxDistance){d.bonds.push([d.molecules[w].atoms[g],d.molecules[u].atoms[f],1])}}}}}}}};molmil.viewer.prototype.getChain=function(f,h){var d=[];for(var g=0;g<f.chains.length;g++){if(f.chains[g].name==h){d.push(f.chains[g])}}return d};molmil.viewer.prototype.getChainAuth=function(f,h){var d=[];for(var g=0;g<f.chains.length;g++){if(f.chains[g].authName==h){d.push(f.chains[g])}}return d};molmil.viewer.prototype.getMolObject4Chain=function(f,h){if(!f instanceof Array){f=[f]}for(var g=0,d;g<f.length;g++){for(d=0;d<f[g].molecules.length;d++){if(f[g].molecules[d].id==h){return f[g].molecules[d]}}}return null};molmil.viewer.prototype.getMolObject4ChainAlt=function(f,g){if(!f instanceof Array){f=[f]}for(var h=0,d;h<f.length;h++){for(d=0;d<f[h].molecules.length;d++){if(f[h].molecules[d].RSID==g){return f[h].molecules[d]}}}return null};molmil.decodeUtf8=function(l){var d="",g=0,o=0,h=0,f=0,n=new Uint8Array(l);if(n.length>=3&&n[0]===239&&n[1]===187&&n[2]===191){g=3}while(g<n.length){o=n[g];if(o<128){d+=String.fromCharCode(o);g++}else{if(o>191&&o<224){if(g+1>=n.length){throw"UTF-8 Decode failed. Two byte character was truncated."}f=n[g+1];d+=String.fromCharCode(((o&31)<<6)|(f&63));g+=2}else{if(g+2>=n.length){throw"UTF-8 Decode failed. Multi byte character was truncated."}f=n[g+1];c3=n[g+2];d+=String.fromCharCode(((o&15)<<12)|((f&63)<<6)|(c3&63));g+=3}}}return d};molmil.viewer.prototype.load_obj=function(C,u,y){if(!y){y={solid:true}}C=C.split("\n");var z,x;var g=[],f=[],o=[],t,w=[0,0,0,0];var c=[1e+99,-1e+99,1e+99,-1e+99,1e+99,-1e+99];for(x=0;x<C.length;x++){if(C[x].substr(0,2)=="vn"){z=C[x].split(/\s+/);f.push(t=[parseFloat(z[1]),parseFloat(z[2]),parseFloat(z[3])]);vec3.normalize(t,t)}else{if(C[x].substr(0,1)=="v"){z=C[x].split(/\s+/);g.push(t=[parseFloat(z[1]),parseFloat(z[2]),parseFloat(z[3])]);if(t[0]<c[0]){c[0]=t[0]}if(t[0]>c[1]){c[1]=t[0]}if(t[1]<c[2]){c[2]=t[1]}if(t[1]>c[3]){c[3]=t[1]}if(t[2]<c[4]){c[4]=t[2]}if(t[2]>c[5]){c[5]=t[2]}w[0]+=t[0];w[1]+=t[1];w[2]+=t[2];w[3]+=1}else{if(C[x].substr(0,1)=="f"){z=C[x].split(/\s+/);o.push([parseInt(z[1].split("//")[0])-1,parseInt(z[2].split("//")[0])-1,parseInt(z[3].split("//")[0])-1])}}}}var h=new Float32Array(g.length*7);var d=new Int32Array(o.length*3);var A=new Uint8Array(h.buffer);var x,q=0,B=0;for(x=0;x<g.length;x++,B+=28){h[q++]=g[x][0];h[q++]=g[x][1];h[q++]=g[x][2];h[q++]=f[x][0];h[q++]=f[x][1];h[q++]=f[x][2];A[B+24]=255;A[B+25]=255;A[B+26]=255;A[B+27]=255;q++}q=0;for(x=0;x<o.length;x++){d[q++]=o[x][0];d[q++]=o[x][1];d[q++]=o[x][2]}var s=new molmil.polygonObject({filename:u,COR:w});canvas.molmilViewer.structures.push(s);s.options=[];s.meta.geomRanges=c;var l=molmil.geometry.build_simple_render_program(h,d,canvas.renderer,y);canvas.renderer.programs.push(l);canvas.molmilViewer.calculateCOG();this.renderer.camera.z=this.calcZ();canvas.renderer.initBuffers();canvas.update=true;molmil.safeStartViewer(canvas)};molmil.viewer.prototype.load_ccp4=function(G,I,U){if(!U){U={sigma:1}}var ad=new Int32Array(G,0,10);var ac=new Float32Array(G,40,6);var aa=new Int32Array(G,64,3);var Y=new Float32Array(G,76,3);var X=new Int32Array(G,88,1);var W=new Int32Array(G,92,233);var V=new Float32Array(G,1024,W[0]/4);var T=new Float32Array(G,0,256);if(!U.hasOwnProperty("solid")){U.solid=true}if(!U.hasOwnProperty("sigma")){U.sigma=1}var u=ad[0]*ad[1]*ad[2];var J=new Float32Array(G,1024+W[0],u);if(!U.skipNormalization){var y=1/new Float32Array(G,54*4,1)[0];for(var S=0;S<u;S++){J[S]=(J[S]-Y[2])*y}}var N=[aa[0]-1,aa[1]-1,aa[2]-1];var C=[ac[N[0]]/ad[N[0]+7],ac[N[1]]/ad[N[1]+7],ac[N[2]]/ad[N[2]+7]];var z=[C[0]*ad[N[0]+4],C[1]*ad[N[1]+4],C[2]*ad[N[2]+4]];var t=[ad[N[0]],ad[N[1]],ad[N[2]]];var K=[[z[0],z[1],z[2]],[(t[0]*C[0])+z[0],(t[1]*C[1])+z[1],(t[2]*C[2])+z[2]]];var q=U.sigma*2;var L=function(d,g,f){var c=arguments[N[0]]+ad[0]*(arguments[N[1]]+ad[1]*arguments[N[2]]);return q-J[c]};var A={};var M=[1/C[0],1/C[1],1/C[2]];var n=function(f,ae,g){var d=arguments[N[0]]+ad[0]*(arguments[N[1]]+ad[1]*arguments[N[2]]);if(A[d]!==undefined){return A[d]}else{A[d]=[0,0,0];var c,h;c=(arguments[N[0]]-1)+ad[0]*(arguments[N[1]]+ad[1]*arguments[N[2]]);h=(arguments[N[0]]+1)+ad[0]*(arguments[N[1]]+ad[1]*arguments[N[2]]);if(c<0){c=arguments[N[0]]+ad[0]*(arguments[N[1]]+ad[1]*arguments[N[2]]);c=q-J[c];h=q-J[h];A[d][N[0]]=(h-c)*M[N[0]]}else{if(h>t[N[0]]){h=arguments[N[0]]+ad[0]*(arguments[N[1]]+ad[1]*arguments[N[2]]);c=q-J[c];h=q-J[h];A[d][N[0]]=(h-c)*M[N[0]]}else{c=q-J[c];h=q-J[h];A[d][N[0]]=(h-c)*M[N[0]]*0.5}}c=arguments[N[0]]+ad[0]*((arguments[N[1]]-1)+ad[1]*arguments[N[2]]);h=arguments[N[0]]+ad[0]*((arguments[N[1]]+1)+ad[1]*arguments[N[2]]);if(c<0){c=arguments[N[0]]+ad[0]*(arguments[N[1]]+ad[1]*arguments[N[2]]);c=q-J[c];h=q-J[h];A[d][N[1]]=(h-c)*M[N[1]]}else{if(h>t[N[0]]){h=arguments[N[0]]+ad[0]*(arguments[N[1]]+ad[1]*arguments[N[2]]);c=q-J[c];h=q-J[h];A[d][N[1]]=(h-c)*M[N[1]]}else{c=q-J[c];h=q-J[h];A[d][N[1]]=(h-c)*M[N[1]]*0.5}}c=arguments[N[0]]+ad[0]*(arguments[N[1]]+ad[1]*(arguments[N[2]]-1));h=arguments[N[0]]+ad[0]*(arguments[N[1]]+ad[1]*(arguments[N[2]]+1));if(c<0){c=arguments[N[0]]+ad[0]*(arguments[N[1]]+ad[1]*arguments[N[2]]);c=q-J[c];h=q-J[h];A[d][N[2]]=(h-c)*M[N[2]]}else{if(h>t[N[0]]){h=arguments[N[0]]+ad[0]*(arguments[N[1]]+ad[1]*arguments[N[2]]);c=q-J[c];h=q-J[h];A[d][N[2]]=(h-c)*M[N[2]]}else{c=q-J[c];h=q-J[h];A[d][N[2]]=(h-c)*M[N[2]]*0.5}}return A[d]}};var D=molmil.surfaceNets2(t,L,K);var O=[],p=[],S,R,ad=[0,0,0],ac=[0,0,0],aa;for(S=0;S<D.vertices.length;S++){p.push([])}for(S=0;S<D.faces.length;S++){ad[0]=D.vertices[D.faces[S][1]][0]-D.vertices[D.faces[S][0]][0];ad[1]=D.vertices[D.faces[S][1]][1]-D.vertices[D.faces[S][0]][1];ad[2]=D.vertices[D.faces[S][1]][2]-D.vertices[D.faces[S][0]][2];ac[0]=D.vertices[D.faces[S][2]][0]-D.vertices[D.faces[S][0]][0];ac[1]=D.vertices[D.faces[S][2]][1]-D.vertices[D.faces[S][0]][1];ac[2]=D.vertices[D.faces[S][2]][2]-D.vertices[D.faces[S][0]][2];O.push([ad[1]*ac[2]-ad[2]*ac[1],ad[2]*ac[0]-ad[0]*ac[2],ad[0]*ac[1]-ad[1]*ac[0]]);p[D.faces[S][0]].push(S);p[D.faces[S][1]].push(S);p[D.faces[S][2]].push(S)}var E=[];for(S=0;S<D.vertices.length;S++){ad=[0,0,0];for(R=0;R<p[S].length;R++){ad[0]+=O[p[S][R]][0];ad[1]+=O[p[S][R]][1];ad[2]+=O[p[S][R]][2]}vec3.normalize(ad,ad);E.push(ad)}molmil.taubinSmoothing(E,D.faces,0.33,-0.331,50);for(S=0;S<E.length;S++){vec3.normalize(E[S],E[S])}molmil.taubinSmoothing(D.vertices,D.faces,0.33,-0.331,50);var o=new Float32Array(D.vertices.length*7);var s=new Int32Array(D.faces.length*3);var F=new Uint8Array(o.buffer);var H=[0,0,0,0],Q=[0,0,0];var w=[1e+99,-1e+99,1e+99,-1e+99,1e+99,-1e+99];for(var P=0,ab,Z;P<D.vertices.length;P++){ab=P*7;Z=P*28;o[ab+3]=E[P][0];o[ab+4]=E[P][1];o[ab+5]=E[P][2];o[ab]=D.vertices[P][0];o[ab+1]=D.vertices[P][1];o[ab+2]=D.vertices[P][2];H[0]+=D.vertices[P][0];H[1]+=D.vertices[P][1];H[2]+=D.vertices[P][2];H[3]+=1;if(o[ab]<w[0]){w[0]=o[ab]}if(o[ab]>w[1]){w[1]=o[ab]}if(o[ab+1]<w[2]){w[2]=o[ab+1]}if(o[ab+1]>w[3]){w[3]=o[ab+1]}if(o[ab+2]<w[4]){w[4]=o[ab+2]}if(o[ab+2]>w[5]){w[5]=o[ab+2]}F[Z+24]=255;F[Z+25]=255;F[Z+26]=255;F[Z+27]=255}var B=new molmil.polygonObject({filename:I,COR:H});canvas.molmilViewer.structures.push(B);B.options=[];B.meta.geomRanges=w;for(var S=0,x;S<D.faces.length;S++){x=S*3;s[x]=D.faces[S][0];s[x+1]=D.faces[S][1];s[x+2]=D.faces[S][2]}var l=molmil.geometry.build_simple_render_program(o,s,canvas.renderer,U);canvas.renderer.programs.push(l);canvas.molmilViewer.calculateCOG();this.renderer.camera.z=this.calcZ();canvas.renderer.initBuffers();canvas.update=true;molmil.safeStartViewer(canvas)};molmil.viewer.prototype.load_MPBF=function(o,c){var n=0;while(n<o.byteLength){var u=[0,0,0,0];var y=new Int32Array(o,n,4);n+=16;var d=molmil.decodeUtf8(new Uint8Array(o,n,y[3]));n+=y[3]+(y[3]%4!=0?4-y[3]%4:0);var g=n;var w=new Float32Array(o,n,7*y[1]);n+=7*y[1]*4;var z=new Int32Array(o,n,y[2]*3);n+=y[2]*3*4;var l=[1e+99,-1e+99,1e+99,-1e+99,1e+99,-1e+99];for(var q=0;q<w.length;q+=7){u[0]+=w[q];u[1]+=w[q+1];u[2]+=w[q+2];u[3]++;if(w[q]<l[0]){l[0]=w[q]}if(w[q]>l[1]){l[1]=w[q]}if(w[q+1]<l[2]){l[2]=w[q+1]}if(w[q+1]>l[3]){l[3]=w[q+1]}if(w[q+2]<l[4]){l[4]=w[q+2]}if(w[q+2]>l[5]){l[5]=w[q+2]}}var h=new molmil.polygonObject({filename:c,COR:u});this.structures.push(h);h.options=[];h.meta.geomRanges=l;var x=this.renderer;var t=x.gl;var s=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,s);t.bufferData(t.ARRAY_BUFFER,w,t.STATIC_DRAW);var f=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,f);t.bufferData(t.ELEMENT_ARRAY_BUFFER,z,t.STATIC_DRAW);var p={};p.gl=x.gl;p.renderer=x;p.nElements=y[2]*3;p.vertexBuffer=s;p.indexBuffer=f;p.angle=x.angle;p.shader=x.shaders.standard_alpha;p.attributes=x.shaders.standard_alpha.attributes;p.status=true;p.render=function(A,B){if(!this.status){return}var C=mat3.create();mat3.normalFromMat4(C,A);this.gl.useProgram(this.shader.program);this.gl.uniformMatrix4fv(this.shader.uniforms.modelViewMatrix,false,A);this.gl.uniformMatrix3fv(this.shader.uniforms.normalMatrix,false,C);this.gl.uniformMatrix4fv(this.shader.uniforms.projectionMatrix,false,this.renderer.projectionMatrix);this.gl.uniform3f(this.shader.uniforms.COR,B[0],B[1],B[2]);this.gl.uniform1f(this.shader.uniforms.focus,this.renderer.fogStart);this.gl.uniform1f(this.shader.uniforms.fogSpan,this.renderer.fogStart+(this.renderer.clearCut*2));this.gl.uniform4f(this.shader.uniforms.backgroundColor,molmil.configBox.BGCOLOR[0],molmil.configBox.BGCOLOR[1],molmil.configBox.BGCOLOR[2],1);this.render_internal()};p.render_internal=function(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer);this.gl.vertexAttribPointer(this.attributes.in_Position,3,this.gl.FLOAT,false,28,0);this.gl.vertexAttribPointer(this.attributes.in_Normal,3,this.gl.FLOAT,false,28,12);this.gl.vertexAttribPointer(this.attributes.in_Colour,4,this.gl.UNSIGNED_BYTE,true,28,24);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);if(this.angle){var B=0,A;while(true){A=Math.min(this.nElements-B,3000000);if(A<1){break}this.gl.drawElements(this.gl.TRIANGLES,A,t.UNSIGNED_INT,B*4);B+=A}}else{this.gl.drawElements(this.gl.TRIANGLES,this.nElements,t.UNSIGNED_INT,0)}};p.renderPicking=function(){};x.programs.push(p);h.options.push([d,p]);if(molmil.configBox.skipClearGeometryBuffer){h.data=h.data||{};h.data.vertexBuffer=w;h.data.indexBuffer=z;h.data.vertexSize=7;h.data.vertices_offset=g}}this.renderer.initBD=true;this.calculateCOG();if(!this.skipCOGupdate){this.renderer.camera.z=this.calcZ()}if(molmil.geometry.onGenerate){molmil_dep.asyncStart(molmil.geometry.onGenerate[0],molmil.geometry.onGenerate[1],molmil.geometry.onGenerate[2],0)}return h};molmil.viewer.prototype.load_xyz=function(h,c,g){g=g||{skipBonds:true};var l,d,n,q,p,o,f;h=h.split("\n");for(i=0;i<h.length;i++){h[i]=molmil_dep.Strip(h[i]);if(!h[i].length){continue}h[i]=h[i].split(/[ ,\t]+/);if(h[i].length==1&&h[i]&&!isNaN(parseInt(h[i][0],10))){this.structures.push(l=new molmil.entryObject({id:c}));l.chains.push(d=new molmil.chainObject("",l));d.CID=this.CID++;this.chains.push(d);d.molecules.push(f=new molmil.molObject("???",0,d));if(g.skipBonds){d.bondsOK=true}continue}n=h[i][0];q=parseFloat(h[i][1]);p=parseFloat(h[i][2]);o=parseFloat(h[i][3]);Xpos=d.modelsXYZ[0].length;d.modelsXYZ[0].push(q,p,o);f.atoms.push(atom=new molmil.atomObject(Xpos,n,n,f,d));d.atoms.push(atom)}this.calculateCOG();molmil.resetColors(null,this);this.renderer.camera.z=this.calcZ();return l};molmil.viewer.prototype.load_mol2=function(F,B){F=F.split("\n");var C,G="",u=false,c=[],l=false,w=[],D=false,A={},E,d;for(C=0;C<F.length;C++){if(F[C].substr(0,9).toUpperCase()=="@<TRIPOS>"){u=false;l=false;D=false}if(u){c.push(F[C])}if(l){w.push(F[C])}if(D){E=F[C].trim().split(/[ ,]+/);A[parseInt(E[0])]=E[1]}if(F[C].substr(0,17).toUpperCase()=="@<TRIPOS>MOLECULE"){G=F[C+1].trim()}else{if(F[C].substr(0,13).toUpperCase()=="@<TRIPOS>ATOM"){u=true}else{if(F[C].substr(0,13).toUpperCase()=="@<TRIPOS>BOND"){l=true}else{if(F[C].substr(0,21).toUpperCase()=="@<TRIPOS>SUBSTRUCTURE"){D=true}}}}}var t,s,p,f,h,o,g,n,q;this.structures.push(d=new molmil.entryObject({id:B}));d.chains.push(n=new molmil.chainObject("",d));n.CID=this.CID++;for(C=0;C<c.length;C++){E=c[C].trim().split(/[ ,]+/);f=E[1];t=parseFloat(E[2]);s=parseFloat(E[3]);p=parseFloat(E[4]);h=E.length>5?E[5]:"";o=E.length>5?E[6]:"";if(o!=g){n.molecules.push(q=new molmil.molObject(molmil_dep.getKeyFromObject(A,o,o),o,n));q.MID=this.MID++;g=o}Xpos=n.modelsXYZ[0].length;n.modelsXYZ[0].push(t,s,p);q.atoms.push(atom=new molmil.atomObject(Xpos,f,h.split(".")[0],q,n));n.atoms.push(atom);atom.status=true;atom.AID=this.AID++;this.atomRef[atom.AID]=atom}this.calculateCOG();for(C=0;C<w.length;C++){E=w[C].trim().split(/[ ,]+/);if(E[0]==""){continue}a1=parseInt(E[1])-1;a2=parseInt(E[2])-1;if(E[3]=="ar"){E[3]=2}bt=parseInt(E[3]);n.bonds.push([n.atoms[a1],n.atoms[a2],bt])}n.bondsOK=true;this.chains.push(n);molmil.resetColors(null,this);this.renderer.camera.z=this.calcZ();return d};molmil.viewer.prototype.load_mdl=function(C,t){C=C.split("\n");var E=C[0].trim()||t;var f=C[3].trim().split(/\s/);var s=parseInt(f[0]),q=parseInt(f[1]),u,c,g,o,p,n,l,h,d,D,B,A;this.structures.push(c=new molmil.entryObject({id:t}));c.chains.push(g=new molmil.chainObject("",c));g.CID=this.CID++;g.molecules.push(o=new molmil.molObject(E,1,g));o.MID=this.MID++;var w={};for(u=4;u<s+4;u++){p=parseFloat(C[u].substring(0,11).trim());n=parseFloat(C[u].substring(11,21).trim());l=parseFloat(C[u].substring(21,31).trim());d=C[u].substring(31,35).trim();if(w[d]===undefined){w[d]=1}else{w[d]++}h=g.modelsXYZ[0].length;g.modelsXYZ[0].push(p,n,l);o.atoms.push(atom=new molmil.atomObject(h,d+w[d],d,o,g));g.atoms.push(atom);atom.status=true;atom.AID=this.AID++;this.atomRef[atom.AID]=atom}this.calculateCOG();for(u=s+4;u<s+4+q;u++){f=C[u].trim().split(/[ ,]+/);D=parseInt(f[0])-1;B=parseInt(f[1])-1;A=parseInt(f[2]);g.bonds.push([o.atoms[D],o.atoms[B],A])}g.bondsOK=true;this.chains.push(g);molmil.resetColors(null,this);this.renderer.camera.z=this.calcZ();return c};molmil.viewer.prototype.load_GRO=function(V,L){V=V.trim().split("\n");var A=null;var o=null;var E=null;var H=null;var l,M;var s,T,g,U,F,D,C,t,n,N,P,J,q,p,K,S;var G=[];var O=[];var f=[];var d=null,B,I;this.structures.push(d=new molmil.entryObject({id:L}));s="";d.chains.push(A=new molmil.chainObject(s,d));A.CID=this.CID++;o=s;H=null;for(M=2;M<V.length-1;M++){T=V[M].substring(0,5).trim();g=V[M].substring(11,15).trim();U=V[M].substring(5,11).trim();F=parseFloat(V[M].substring(20,28).trim())*10;D=parseFloat(V[M].substring(28,36).trim())*10;C=parseFloat(V[M].substring(36,44).trim())*10;if(T!=H){A.molecules.push(E=new molmil.molObject(U,T,A));E.MID=this.MID++;H=T}for(t=0;t<g.length;t++){if(!molmil_dep.isNumber(g[t])){break}}if(g.length>1&&!molmil_dep.isNumber(g[1])&&g[1]==g[1].toLowerCase()){n=g.substring(t,t+2)}else{n=g.substring(t,t+1)}B=A.modelsXYZ[0].length;A.modelsXYZ[0].push(F,D,C);E.atoms.push(l=new molmil.atomObject(B,g,n,E,A));if(!molmil.AATypes.hasOwnProperty(E.name.substr(0,3))){if(E.name=="HOH"||E.name=="DOD"||E.name=="WAT"||E.name=="SOL"){E.water=true;E.ligand=false;l.status=false}else{if(l.atomName=="P"){E.N=l;E.xna=true;E.ligand=false;if(!E.CA){A.isHet=false;E.CA=l}}else{if(l.atomName=="C1'"){A.isHet=false;E.CA=l;E.xna=true;E.ligand=false}else{if(l.atomName=="O3'"){E.C=l;E.xna=true;E.ligand=false}}}}}else{if(l.atomName=="N"){E.N=l;E.ligand=false}else{if(l.atomName=="CA"){E.CA=l;E.ligand=false}else{if(l.atomName=="C"){A.isHet=false;E.C=l;E.ligand=false}else{if(l.atomName=="O"){E.O=l;E.ligand=false}}}}}if(l.element=="H"||l.element=="D"){l.status=false}A.atoms.push(l);l.AID=this.AID++;this.atomRef[l.AID]=l}this.calculateCOG();for(S=0;S<d.chains.length;S++){this.buildAminoChain(d.chains[S])}var R=[],u,w,h;for(S=0;S<d.chains.length;S++){A=d.chains[S];u=A,w=A.molecules.length;for(h=0;h<w;h++){A.molecules[h].chain_alt=A.molecules[h].chain;A.molecules[h].chain=u;if(((!A.molecules[h].next&&h<w-1)||(!A.molecules[h].previous&&h!=0))&&(!(A.molecules[h].water||A.molecules[h].ligand)||(h&&A.molecules[h-1].name!=A.molecules[h].name))){u=new molmil.chainObject(molmil_dep.Strip(u.name),u.entry);u.isHet=false;R.push(u);if(!A.molecules[h].previous){A.molecules[h].chain=u}}}}if(R.length){Array.prototype.push.apply(d.chains,R);var Q=[];for(S=0;S<d.chains.length;S++){d.chains[S].name=(S+1)+"";Array.prototype.push.apply(Q,d.chains[S].molecules);d.chains[S].molecules=[];d.chains[S].modelsXYZ_old=d.chains[S].modelsXYZ;d.chains[S].modelsXYZ=[];for(h=0;h<d.chains[S].modelsXYZ_old.length;h++){d.chains[S].modelsXYZ.push([])}d.chains[S].atoms=[]}for(h=0;h<Q.length;h++){Q[h].chain.molecules.push(Q[h]);for(M=0;M<Q[h].atoms.length;M++){l=Q[h].atoms[M].xyz;for(S=0;S<Q[h].chain_alt.modelsXYZ_old.length;S++){Q[h].chain.modelsXYZ[S].push(Q[h].chain_alt.modelsXYZ_old[S][l],Q[h].chain_alt.modelsXYZ_old[S][l+1],Q[h].chain_alt.modelsXYZ_old[S][l+2])}Q[h].atoms[M].xyz=Q[h].chain.modelsXYZ[0].length-3;Q[h].atoms[M].chain=Q[h].chain}Array.prototype.push.apply(Q[h].chain.atoms,Q[h].atoms);delete Q[h].chain_alt}for(S=0;S<d.chains.length;S++){delete d.chains[S].modelsXYZ_old}for(S=0;S<d.chains.length;S++){if(d.chains[S].molecules.length==0){d.chains.splice(S,1);S--;continue}if(d.chains[S].molecules[0].water||d.chains[S].molecules[0].ligand){d.chains[S].name=(d.chains[S].name?d.chains[S].name+" - ":"")+d.chains[S].molecules[0].name;d.chains[S].isHet=true}}}for(S=0;S<d.chains.length;S++){this.chains.push(d.chains[S])}for(S=0;S<d.chains.length;S++){this.ssAssign(d.chains[S])}molmil.resetColors(null,this);this.renderer.camera.z=this.calcZ();return d};molmil.viewer.prototype.load_PDB=function(U,C){var t=null;var Q=null;var X=null;var F=null;var d,S;var U=U.split("\n");var O,E,w,h,M,I,G,N,q,u,l,n,f,R,H,V;var D=[];var A=[];var s=[];var K=null,J,B;for(S=0;S<U.length;S++){if((U[S].substring(0,5)=="MODEL"&&t)||!K){if(K){break}this.structures.push(K=new molmil.entryObject({id:C}));B=U[S].substr(5).trim();Q=F=null}if(U[S].substring(0,4)=="ATOM"||U[S].substring(0,6)=="HETATM"){O=U[S].substring(21,22).trim();E=U[S].substring(22,28).trim();w=U[S].substring(11,16).trim();h=U[S].substring(17,21).trim();M=parseFloat(U[S].substring(30,38).trim());I=parseFloat(U[S].substring(38,46).trim());G=parseFloat(U[S].substring(46,54).trim());for(N=0;N<w.length;N++){if(!molmil_dep.isNumber(w[N])){break}}if(w.length>1&&!molmil_dep.isNumber(w[1])&&w[1]==w[1].toLowerCase()){q=w.substring(N,N+2)}else{q=w.substring(N,N+1)}if(O!=Q){this.chains.push(t=new molmil.chainObject(O,K));K.chains.push(t);t.CID=this.CID++;Q=O;F=null}if(E!=F){t.molecules.push(X=new molmil.molObject(h,E,t));X.MID=this.MID++;F=E}J=t.modelsXYZ[0].length;t.modelsXYZ[0].push(M,I,G);X.atoms.push(d=new molmil.atomObject(J,w,q,X,t));if(U[S].substr(0,4)!="ATOM"||!molmil.AATypes.hasOwnProperty(X.name.substr(0,3))){if(X.name=="HOH"||X.name=="DOD"||X.name=="WAT"||X.name=="SOL"){X.water=true;X.ligand=false;d.status=false}else{if(d.atomName=="P"){X.N=d;X.xna=true;X.ligand=false;if(!X.CA){t.isHet=false;X.CA=d}}else{if(d.atomName=="C1'"){t.isHet=false;X.CA=d;X.xna=true;X.ligand=false}else{if(d.atomName=="O3'"){X.C=d;X.xna=true;X.ligand=false}}}}}else{if(d.atomName=="N"){X.N=d;X.ligand=false}else{if(d.atomName=="CA"){X.CA=d;X.ligand=false}else{if(d.atomName=="C"){t.isHet=false;X.C=d;X.ligand=false}else{if(d.atomName=="O"){X.O=d;X.ligand=false}}}}}if(d.element=="H"||d.element=="D"){d.status=false}t.atoms.push(d);d.AID=this.AID++;this.atomRef[d.AID]=d}}var o=0,p;for(;S<U.length;S++){if(U[S].substring(0,5)=="MODEL"){Q=o=-1}if(U[S].substring(0,4)=="ATOM"||U[S].substring(0,6)=="HETATM"){O=U[S].substring(21,22).trim();M=parseFloat(U[S].substring(30,38).trim());I=parseFloat(U[S].substring(38,46).trim());G=parseFloat(U[S].substring(46,54).trim());if(O!=Q){Q=O;o+=1;K.chains[o].modelsXYZ.push(p=[])}p.push(M,I,G)}}K.number_of_frames=K.chains.length?K.chains[0].modelsXYZ.length:0;this.calculateCOG();for(V=0;V<K.chains.length;V++){this.buildAminoChain(K.chains[V])}var L=[],W,g,T;for(V=0;V<K.chains.length;V++){t=K.chains[V];W=t,g=t.molecules.length;for(T=0;T<g;T++){t.molecules[T].chain_alt=t.molecules[T].chain;t.molecules[T].chain=W;if(((!t.molecules[T].next&&T<g-1)||(!t.molecules[T].previous&&T!=0))&&(!(t.molecules[T].water||t.molecules[T].ligand)||(T&&t.molecules[T-1].name!=t.molecules[T].name))){W=new molmil.chainObject(molmil_dep.Strip(W.name),W.entry);W.isHet=false;L.push(W);if(!t.molecules[T].previous){t.molecules[T].chain=W}}}}if(L.length){Array.prototype.push.apply(this.chains,L);Array.prototype.push.apply(K.chains,L);var P=[];for(V=0;V<K.chains.length;V++){Array.prototype.push.apply(P,K.chains[V].molecules);K.chains[V].molecules=[];K.chains[V].modelsXYZ_old=K.chains[V].modelsXYZ;K.chains[V].modelsXYZ=[];for(T=0;T<K.chains[V].modelsXYZ_old.length;T++){K.chains[V].modelsXYZ.push([])}K.chains[V].atoms=[]}for(T=0;T<P.length;T++){P[T].chain.molecules.push(P[T]);for(S=0;S<P[T].atoms.length;S++){d=P[T].atoms[S].xyz;for(V=0;V<P[T].chain_alt.modelsXYZ_old.length;V++){P[T].chain.modelsXYZ[V].push(P[T].chain_alt.modelsXYZ_old[V][d],P[T].chain_alt.modelsXYZ_old[V][d+1],P[T].chain_alt.modelsXYZ_old[V][d+2])}P[T].atoms[S].xyz=P[T].chain.modelsXYZ[0].length-3;P[T].atoms[S].chain=P[T].chain}Array.prototype.push.apply(P[T].chain.atoms,P[T].atoms);delete P[T].chain_alt}for(V=0;V<K.chains.length;V++){delete K.chains[V].modelsXYZ_old}for(V=0;V<K.chains.length;V++){if(K.chains[V].molecules.length==0){K.chains.splice(V,1);V--;continue}if(K.chains[V].molecules[0].water||K.chains[V].molecules[0].ligand){K.chains[V].name=(K.chains[V].name?K.chains[V].name+" - ":"")+K.chains[V].molecules[0].name;K.chains[V].isHet=true}}}for(V=0;V<K.chains.length;V++){this.ssAssign(K.chains[V])}molmil.resetColors(null,this);this.renderer.camera.z=this.calcZ();return K};molmil.viewer.prototype.calcZ=function(c){var f=c;c=c||this.geomRanges;var d=Math.max(Math.abs(c[0]),Math.abs(c[1]),Math.abs(c[2]),Math.abs(c[3]),Math.abs(c[4]),Math.abs(c[5]));if(f){this.renderer.maxRange=(Math.max(Math.abs(c[1]-c[0]),Math.abs(c[3]-c[2]),Math.abs(c[5]-c[4]))*0.5)-molmil.configBox.zNear-5}if(molmil.configBox.projectionMode==1){return -(d*molmil.configBox.zFar/3000)-molmil.configBox.zNear-1}else{return -((d/Math.min(this.renderer.width,this.renderer.height))*molmil.configBox.zFar*(0.625))-molmil.configBox.zNear-1}};molmil.viewer.prototype.load_polygonJSON=function(l,d,n){n=n||{};var y=l.vertices||[],u=l.triangles_lists||[],z=l.lines_lists||[],h=[],f=[],t;var w=[0,0,0,0];if(l.hasOwnProperty("vertices2")){for(var s=0;s<l.vertices2.length;s++){l.vertices2[s].splice(3,0,0,0,0)}Array.prototype.push.apply(y,l.vertices2)}for(var s=0,q;s<u.length;s++){t=[];for(q=0;q<u[s].length;q++){t.push(u[s][q][0],u[s][q][1],u[s][q][2])}if(t.length){f.push(t.unique())}}for(var s=0;s<z.length;s++){t=[];for(q=0;q<z[s].length;q++){t.push(z[s][q][0],z[s][q][1])}if(t.length){t.unique();h.push(t)}}for(var s=0;s<y.length;s++){w[0]+=y[s][0];w[1]+=y[s][1];w[2]+=y[s][2];w[3]+=1;y[s][6]*=255;y[s][7]*=255;y[s][8]*=255}var p=0,x=0,s,q,c=0,g=0;for(s=0;s<f.length;s++){c+=f[s].length;g+=u[s].length}for(s=0;s<h.length;s++){p+=h[s].length;x+=z[s].length}if(!p&&!c){return null}var o=new molmil.polygonObject({filename:d,COR:w});this.structures.push(o);this.processPolygon3D(o,y,p,x,h,z,c,g,f,u,n);this.renderer.initBD=true;return o};molmil.viewer.prototype.processPolygon3D=function(A,g,D,w,B,d,y,p,J,x,I){var q,z,u,F=this.renderer.gl;var G,E,t,h,H,c,L={};var f=I.alpha||255;if(D){var s=new Float32Array(D*4),o=new Uint8Array(s.buffer);var n=new Uint32Array(w*2);for(G=0,t=0,c=0,h=0;G<B.length;G++){for(E=0;E<B[G].length;E++,h+=16){L[B[G][E]]=t/4;H=g[B[G][E]];s[t++]=H[0];s[t++]=H[1];s[t++]=H[2];o[h+12]=H[6];o[h+13]=H[7];o[h+14]=H[8];o[h+15]=255;t++}for(E=0;E<d[G].length;E++){n[c++]=L[d[G][E][0]];n[c++]=L[d[G][E][1]]}}q=molmil.geometry.build_simple_render_program(s,n,this.renderer,{lines_render:true});this.renderer.programs.push(q)}if(y){var C=new Float32Array(y*7),K=new Uint8Array(C.buffer);var l=new Uint32Array(p*3);L={};if(molmil.configBox.skipClearGeometryBuffer){A.data=A.data||{};A.data.vertexBuffer=C;A.data.indexBuffer=l;A.data.vertexSize=7}for(G=0,t=0,c=0,h=0;G<J.length;G++){for(E=0;E<J[G].length;E++,h+=28){L[J[G][E]]=t/7;H=g[J[G][E]];C[t++]=H[0];C[t++]=H[1];C[t++]=H[2];C[t++]=H[3];C[t++]=H[4];C[t++]=H[5];K[h+24]=H[6];K[h+25]=H[7];K[h+26]=H[8];K[h+27]=f;t++}for(E=0;E<x[G].length;E++){l[c++]=L[x[G][E][0]];l[c++]=L[x[G][E][1]];l[c++]=L[x[G][E][2]]}}q=molmil.geometry.build_simple_render_program(C,l,this.renderer,{solid:true});this.renderer.programs.push(q)}this.renderer.initBD=true;this.calculateCOG();if(!this.skipCOGupdate){this.renderer.camera.z=this.calcZ()}if(molmil.geometry.onGenerate){molmil_dep.asyncStart(molmil.geometry.onGenerate[0],molmil.geometry.onGenerate[1],molmil.geometry.onGenerate[2],0)}};molmil.viewer.prototype.load_polygonXML=function(f,A,D){if(typeof f=="string"){var d=new DOMParser();f=d.parseFromString(f,"text/xml")}D=D||{};var s=[],n={},c=[],l=[];var w=[],F=[],G,E;var g=[0,0,0,0],h=[1e+99,-1e+99,1e+99,-1e+99,1e+99,-1e+99];var t=f.documentElement.childNodes,z,B,H,y;for(var C=0;C<t.length;C++){if(t[C].tagName=="vertices"){z=t[C].childNodes;for(B=0;B<z.length;B++){if(z[B].tagName!="vertex"){continue}H=z[B].getAttribute("image").trim().split(/\s+/);for(y=0;y<9;y++){H[y]=parseFloat(H[y])}H[6]=H[6];H[7]=H[7];H[8]=H[8];n[z[B].getAttribute("id")]=l.length;g[0]+=H[0];g[1]+=H[1];g[2]+=H[2];g[3]++;if(H[0]<h[0]){h[0]=H[0]}if(H[0]>h[1]){h[1]=H[0]}if(H[1]<h[2]){h[2]=H[1]}if(H[1]>h[3]){h[3]=H[1]}if(H[2]<h[4]){h[4]=H[2]}if(H[2]>h[5]){h[5]=H[2]}l.push(H)}}else{if(t[C].tagName=="triangle_array"){z=t[C].childNodes;G=[];E=[];for(B=0;B<z.length;B++){if(z[B].tagName!="triangle"){continue}H=z[B].getAttribute("vertex").trim().split(/\s+/);for(y=0;y<3;y++){H[y]=n[H[y]]}E.push(H);G.push(H[0],H[1],H[2])}if(G.length){F.push(G.unique());s.push(E)}}else{if(t[C].tagName=="quad_array"){z=t[C].childNodes;G=[];E=[];for(B=0;B<z.length;B++){if(z[B].tagName!="quad"){continue}H=z[B].getAttribute("vertex").trim().split(/\s+/);for(y=0;y<4;y++){H[y]=n[H[y]]}E.push([H[0],H[1],H[2]]);G.push(H[0],H[1],H[2]);E.push([H[0],H[2],H[3]]);G.push(H[0],H[2],H[3])}if(G.length){F.push(G.unique());s.push(E)}}else{if(t[C].tagName=="line_array"){z=t[C].childNodes;G=[];E=[];for(B=0;B<z.length;B++){if(z[B].tagName!="line"){continue}H=z[B].getAttribute("vertex").trim().split(/\s+/);for(y=0;y<2;y++){H[y]=n[H[y]]}E.push(H);G.push(H[0],H[1])}if(G.length){w.push(G.unique());c.push(E)}}else{if(t[C].tagName=="polyline_array"){z=t[C].childNodes;G=[];E=[];for(B=0;B<z.length;B++){if(z[B].tagName!="polyline"){continue}H=z[B].getAttribute("vertex").trim().split(/\s+/);for(y=0;y<H.length;y++){H[y]=n[H[y]]}for(y=0;y<H.length-1;y++){E.push([H[y],H[y+1]]);G.push(H[y],H[y+1])}}if(G.length){w.push(G.unique());c.push(E)}}}}}}}var x=0,p=0,C,q=0,o=0;for(C=0;C<F.length;C++){q+=F[C].length;o+=s[C].length}for(C=0;C<w.length;C++){x+=w[C].length;p+=c[C].length}if(!x&&!q){return null}var u=new molmil.polygonObject({filename:A,COR:g,geomRanges:h});this.structures.push(u);this.processPolygon3D(u,l,x,p,w,c,q,o,F,s,D);this.renderer.initBD=true;return u};molmil.viewer.prototype.load_mmCIF=function(d){var c=loadCIF(d);return this.load_PDBx(c)};molmil.viewer.prototype.load_PDBML=function(d){if(typeof d=="string"){var f=new DOMParser();d=f.parseFromString(d,"text/xml")}var c=loadPDBML(d);return this.load_PDBx(c)};molmil.viewer.prototype.load_PDBx=function(au){var ab=Object.keys(au),J=[],aa;for(var ar=0;ar<ab.length;ar++){var o=ab[ar].substr(5).split("-")[0];var B=au[ab[ar]];var g=B.atom_site||B.chem_comp_atom||B.pdbx_chem_comp_model_atom||null;if(!g){continue}var q=B.hasOwnProperty("chem_comp_atom");var T=g.Cartn_x||(g.pdbx_model_Cartn_x_ideal&&g.pdbx_model_Cartn_x_ideal[0]!=null?g.pdbx_model_Cartn_x_ideal:g.model_Cartn_x)||g.model_Cartn_x;var R=g.Cartn_y||(g.pdbx_model_Cartn_y_ideal&&g.pdbx_model_Cartn_x_ideal[0]!=null?g.pdbx_model_Cartn_y_ideal:g.model_Cartn_y)||g.model_Cartn_y;var Q=g.Cartn_z||(g.pdbx_model_Cartn_z_ideal&&g.pdbx_model_Cartn_x_ideal[0]!=null?g.pdbx_model_Cartn_z_ideal:g.model_Cartn_z)||g.model_Cartn_z;var V=g.id;var t=g.auth_seq_id||[];var M=g.auth_comp_id;var E=g.label_seq_id||[];var L=g.label_comp_id||g.comp_id||g.model_id;var n=g.auth_asym_id||[];var l=g.label_asym_id||[];var G=g.label_alt_id||[];var y=g.auth_atom_id||g.atom_id||[];var w=g.label_atom_id||[];var ap=g.type_symbol||[];var ai=g.pdbx_PDB_model_num;var F=null;var ag=null;var ay=null;var X=null;var f;var Z=null,Y,O;var U={};try{for(var am=0;am<B.chem_comp.id.length;am++){if(B.chem_comp.mon_nstd_flag[am]||B.chem_comp.type[am].toLowerCase().indexOf("peptide")!=-1){U[B.chem_comp.id[am]]=true}}U.ACE=U.NME=true}catch(ar){U=molmil.AATypes}for(var ax=0;ax<T.length;ax++){if((ai&&ai[ax]!=O)||!Z){if(Z){break}this.structures.push(Z=new molmil.entryObject({id:o}));O=ai?ai[ax]:0;ag=X=null}if(l[ax]!=ag||!F){this.chains.push(F=new molmil.chainObject(l[ax],Z));Z.chains.push(F);F.authName=n[ax];F.CID=this.CID++;ag=l[ax];X=-1}if((E[ax]||t[ax])!=X||!ay||X==-1){F.molecules.push(ay=new molmil.molObject((L[ax]||M[ax]),(E[ax]||t[ax]),F));ay.RSID=t[ax]||E[ax];ay.MID=this.MID++;X=(E[ax]||t[ax])}Y=F.modelsXYZ[0].length;F.modelsXYZ[0].push(T[ax],R[ax],Q[ax]);ay.atoms.push(f=new molmil.atomObject(Y,y[ax]||w[ax]||"",ap[ax]||"",ay,F));if(!f.element){for(aa=0;aa<f.atomName.length;aa++){if(!molmil_dep.isNumber(f.atomName[aa])){break}}if(f.atomName.length>1&&!molmil_dep.isNumber(f.atomName[1])&&f.atomName[1]==f.atomName[1].toLowerCase()){f.element=f.atomName.substring(aa,aa+2)}else{f.element=f.atomName.substring(aa,aa+1)}}f.label_alt_id=G[ax];if(f.label_alt_id&&f.label_alt_id!="A"){f.status=false}if(q||!U.hasOwnProperty(ay.name)){if(ay.name=="HOH"||ay.name=="DOD"||ay.name=="WAT"){ay.water=true;ay.ligand=false}}else{F.isHet=false;if(f.atomName=="N"){ay.N=f;ay.ligand=false}else{if(f.atomName=="CA"){ay.CA=f;ay.ligand=false}else{if(f.atomName=="C"){ay.C=f;ay.ligand=false}else{if(f.atomName=="O"){ay.O=f;ay.ligand=false;ay.xna=false}else{if(f.atomName=="P"&&!ay.O){ay.N=f;ay.xna=true;ay.ligand=false;if(!ay.CA){ay.CA=f}}else{if(f.atomName=="C1'"&&!ay.O){ay.CA=f;ay.xna=true;ay.ligand=false}else{if(f.atomName=="O3'"&&!ay.O){ay.C=f;ay.xna=true;ay.ligand=false}}}}}}}}F.atoms.push(f);f.AID=this.AID++;this.atomRef[f.AID]=f}J.push(Z);var p=0,s;for(;ax<T.length;ax++){if(ai&&ai[ax]!=O){O=ai?ai[ax]:0;ag=null;p=-1}if(l[ax]!=ag||!F){ag=l[ax];p+=1;if(p>=Z.chains.length){s=[]}else{Z.chains[p].modelsXYZ.push(s=[])}}s.push(T[ax],R[ax],Q[ax])}Z.number_of_frames=Z.chains.length?Z.chains[0].modelsXYZ.length:0;this.calculateCOG();var S=B.chem_comp_bond||B.pdbx_chem_comp_model_bond;if(S){var at={};for(var am=0;am<Z.chains[0].atoms.length;am++){at[Z.chains[0].atoms[am].atomName]=Z.chains[0].atoms[am]}var ae,ad;for(var am=0;am<S.atom_id_1.length;am++){ae=at[S.atom_id_1[am]];ad=at[S.atom_id_2[am]];Z.chains[0].bonds.push([ae,ad,S.value_order[am]=="DOUB"?2:1])}Z.chains[0].bondsOK=true}else{for(var am=0;am<Z.chains.length;am++){this.buildAminoChain(Z.chains[am])}}var ac,W,h,ak,u,K,A;var D=false;var aw=B.struct_conf;if(aw&&T.length){for(var am=0,af;am<aw.id.length;am++){ac=aw.conf_type_id[am];if(ac=="HELX_P"){ac=3}else{if(ac=="TURN_P"){ac=4}else{continue}}W=aw.beg_label_asym_id[am];h=aw.beg_label_seq_id[am];ak=aw.end_label_asym_id[am];u=aw.end_label_seq_id[am];K=this.getMolObject4Chain(this.getChain(Z,W),h);A=this.getMolObject4Chain(this.getChain(Z,ak),u);while(A){if(K==null){break}K.sndStruc=ac;if(K==A){break}K=K.next}}D=true}var al=B.struct_sheet_range;if(al&&T.length){for(var am=0,af;am<al.beg_label_asym_id.length;am++){W=al.beg_label_asym_id[am];h=al.beg_label_seq_id[am];ak=al.end_label_asym_id[am];u=al.end_label_seq_id[am];K=this.getMolObject4Chain(this.getChain(Z,W),h);A=this.getMolObject4Chain(this.getChain(Z,ak),u);while(A){if(K==null){break}K.sndStruc=2;if(K==A){break}K=K.next}}D=true}if(!D){for(av=0;av<Z.chains.length;av++){this.ssAssign(Z.chains[av])}}var P;if(B.hasOwnProperty("entity_poly")){P=B.entity_poly.entity_id;for(var am=0;am<B.struct_asym.id.length;am++){if(P.indexOf(B.struct_asym.entity_id[am])!=-1){this.poly_asym_ids.push(B.struct_asym.id[am])}}}var H=B.pdbx_struct_oper_list;if(H){var am,C=H.type.length;var z=!H.hasOwnProperty("matrix[1][1]");for(am=0;am<C;am++){mat=mat4.create();mat[0]=H[z?"matrix11":"matrix[1][1]"][am];mat[4]=H[z?"matrix12":"matrix[1][2]"][am];mat[8]=H[z?"matrix13":"matrix[1][3]"][am];mat[12]=H[z?"vector1":"vector[1]"][am];mat[1]=H[z?"matrix21":"matrix[2][1]"][am];mat[5]=H[z?"matrix22":"matrix[2][2]"][am];mat[9]=H[z?"matrix23":"matrix[2][3]"][am];mat[13]=H[z?"vector2":"vector[2]"][am];mat[2]=H[z?"matrix31":"matrix[3][1]"][am];mat[6]=H[z?"matrix32":"matrix[3][2]"][am];mat[10]=H[z?"matrix33":"matrix[3][3]"][am];mat[14]=H[z?"vector3":"vector[3]"][am];if(mat[0]==1&&mat[1]==0&&mat[2]==0&&mat[3]==0&&mat[4]==0&&mat[5]==1&&mat[6]==0&&mat[7]==0&&mat[8]==0&&mat[9]==0&&mat[10]==1&&mat[11]==0&&mat[12]==0&&mat[13]==0&&mat[14]==0&&mat[15]==1){this.BUmatrices[H.id[am]]=["identity operation",mat]}else{this.BUmatrices[H.id[am]]=[H.type[am],mat]}}var N=B.pdbx_struct_assembly_gen,aq,ao,an=mat4.create(),aj,ah,I;C=N.assembly_id.length;var x=function(c){ao=[];c=c.split(",");for(aj=0;aj<c.length;aj++){if(c[aj].indexOf("-")!=-1){c[aj]=c[aj].replace("(","").replace(")","").split("-");for(ah=parseInt(c[aj][0]);ah<parseInt(c[aj][1])+1;ah++){ao.push(ah)}}else{ao.push(c[aj].replace("(","").replace(")",""))}}return ao};for(am=0;am<C;am++){if(!this.BUassemblies.hasOwnProperty(N.assembly_id[am])){this.BUassemblies[N.assembly_id[am]]=[]}I=[];if(N.oper_expression[am].indexOf(")(")!=-1){aq=N.oper_expression[am].split(")(");aq[0]=x(aq[0].substr(1));aq[1]=x(aq[1].substr(0,aq[1].length-1));for(aj=0;aj<aq[0].length;aj++){for(ah=0;ah<aq[1].length;ah++){P="combi_"+aq[0][aj]+"_"+aq[1][ah];if(!this.BUmatrices.hasOwnProperty(P)){mat4.multiply(an,this.BUmatrices[aq[0][aj]][1],this.BUmatrices[aq[1][ah]][1]);if(an[0]==1&&an[1]==0&&an[2]==0&&an[3]==0&&an[4]==0&&an[5]==1&&an[6]==0&&an[7]==0&&an[8]==0&&an[9]==0&&an[10]==1&&an[11]==0&&an[12]==0&&an[13]==0&&an[14]==0&&an[15]==1){this.BUmatrices[P]=["identity operation",an]}else{this.BUmatrices[P]=["combined",mat4.clone(an)]}}I.push(P)}}}else{I=x(N.oper_expression[am])}this.BUassemblies[N.assembly_id[am]].push([I,N.asym_id_list[am].split(",")])}}for(var av=0,af,d;av<Z.chains.length;av++){for(af=0;af<Z.chains[av].molecules.length;af++){d=Z.chains[av].molecules[af];if(!d.ligand&&!d.water&&!d.xna&&!molmil.AATypesBase.hasOwnProperty(d.name)){d.weirdAA=true}}}molmil.resetColors(Z,this)}this.renderer.camera.z=this.calcZ();this.pdbxData=B;delete B.atom_site;return J[0]};molmil.viewer.prototype.calculateCOG=function(){if(this.skipCOGupdate){return}this.avgX=0;this.avgY=0;this.avgZ=0;this.stdX=0;this.stdY=0;this.stdZ=0;this.avgXYZ=[0,0,0];this.stdXYZ=[0,0,0];var w=0;var p;var g,o;var z=[];this.geomRanges=[0,0,0,0,0,0],ALTs=[];var t,u,q,C,x,E;for(q=0;q<this.structures.length;q++){t=this.structures[q];if(t instanceof molmil.entryObject){for(C=0;C<t.chains.length;C++){u=t.chains[C];g=u.modelsXYZ[0];for(x=0;x<u.molecules.length;x++){if(!u.molecules[x].status){continue}if(u.molecules[x].ligand||u.molecules[x].water){for(E=0;E<u.molecules[x].atoms.length;E++){o=u.molecules[x].atoms[E].xyz;xyz=[g[o],g[o+1],g[o+2]];this.avgX+=xyz[0];this.avgY+=xyz[1];this.avgZ+=xyz[2];z.push(xyz);w++}}else{p=u.molecules[x].CA;if(p!=null){o=p.xyz;xyz=[g[o],g[o+1],g[o+2]];this.avgX+=xyz[0];this.avgY+=xyz[1];this.avgZ+=xyz[2];z.push(xyz);w+=1}}}}}else{if(t instanceof molmil.polygonObject){this.avgX+=t.meta.COR[0];this.avgY+=t.meta.COR[1];this.avgZ+=t.meta.COR[2];w+=t.meta.COR[3];if(t.meta.hasOwnProperty("geomRanges")){ALTs.push(t.meta.geomRanges,t.meta.COR[3])}}}}if(w==0){return}this.avgX/=w;this.avgY/=w;this.avgZ/=w;var A=1e+99,F=-1e+99,d=1e+99,f=-1e+99,h=1e+99,l=-1e+99;var B,D;for(var y=0;y<z.length;y++){B=z[y][0]-this.avgX;this.stdX+=B*B;if(B<A){A=B}if(B>F){F=B}B=z[y][1]-this.avgY;this.stdY+=B*B;if(B<d){d=B}if(B>f){f=B}B=z[y][2]-this.avgZ;this.stdZ+=B*B;if(B<h){h=B}if(B>l){l=B}}for(var y=0;y<ALTs.length;y+=2){D=ALTs[y][1];B=ALTs[y][0]-this.avgX;this.stdX+=(B*B)*D*0.5;if(B<A){A=B}B=ALTs[y][1]-this.avgX;this.stdX+=(B*B)*D*0.5;if(B>F){F=B}B=ALTs[y][2]-this.avgY;this.stdY+=(B*B)*D*0.5;if(B<d){d=B}B=ALTs[y][3]-this.avgY;this.stdY+=(B*B)*D*0.5;if(B>f){f=B}B=ALTs[y][4]-this.avgZ;this.stdZ+=(B*B)*D*0.5;if(B<h){h=B}B=ALTs[y][5]-this.avgZ;this.stdZ+=(B*B)*D*0.5;if(B>l){l=B}}this.stdX=Math.sqrt(this.stdX/w);this.stdY=Math.sqrt(this.stdY/w);this.stdZ=Math.sqrt(this.stdZ/w);this.avgXYZ=[this.avgX,this.avgY,this.avgZ];this.stdXYZ=[this.stdX,this.stdY,this.stdZ];this.COR=this.avgXYZ;this.geomRanges=[A,F,d,f,h,l]};molmil.viewer.prototype.ssAssign=function(F){var n,l,az=[0,0,0],aw=[0,0,0],at=[0,0,0],aq=[0,0,0],t,q;for(var aj=0;aj<F.molecules.length;aj++){n=F.molecules[aj];t=n.chain;if(n.ligand||n.water||n.name=="PRO"||n.xna){continue}if(n.previous){try{n.NH={xyz:[0,0,0]};az[0]=t.modelsXYZ[0][n.previous.C.xyz];az[1]=t.modelsXYZ[0][n.previous.C.xyz+1];az[2]=t.modelsXYZ[0][n.previous.C.xyz+2];aw[0]=t.modelsXYZ[0][n.previous.O.xyz];aw[1]=t.modelsXYZ[0][n.previous.O.xyz+1];aw[2]=t.modelsXYZ[0][n.previous.O.xyz+2];at[0]=t.modelsXYZ[0][n.N.xyz];at[1]=t.modelsXYZ[0][n.N.xyz+1];at[2]=t.modelsXYZ[0][n.N.xyz+2];vec3.subtract(n.NH.xyz,az,aw);vec3.normalize(n.NH.xyz,n.NH.xyz);vec3.add(n.NH.xyz,n.NH.xyz,at)}catch(ap){n.NH=null}}else{n.NH=true}}var af,ae,ad;var Z=function(d,c){af=c[0]-d[0];ae=c[1]-d[1];ad=c[2]-d[2];return af*af+ae*ae+ad*ad};var p={},f={},u=[],ar;var an,am,G,ai,ac,ag,aa;for(an=0;an<F.molecules.length;an++){n=F.molecules[an];t=n.chain;if(n.ligand||n.water||n.xna){continue}if(!n.previous){u.push(ar=[])}ar.push(n);for(am=an+2;am<F.molecules.length;am++){l=F.molecules[am];q=l.chain;if(l.ligand||l.water||n.xna||!n.N||!l.C||!n.C||!l.N){continue}az[0]=t.modelsXYZ[0][n.N.xyz];az[1]=t.modelsXYZ[0][n.N.xyz+1];az[2]=t.modelsXYZ[0][n.N.xyz+2];aw[0]=q.modelsXYZ[0][l.C.xyz];aw[1]=q.modelsXYZ[0][l.C.xyz+1];aw[2]=q.modelsXYZ[0][l.C.xyz+2];ai=Z(az,aw);if(ai<25&&n.NH&&l.O){ai=Math.sqrt(ai);at[0]=q.modelsXYZ[0][l.O.xyz];at[1]=q.modelsXYZ[0][l.O.xyz+1];at[2]=q.modelsXYZ[0][l.O.xyz+2];ac=Math.sqrt(Z(az,at));if(n.NH==true){ag=ai-1;aa=ac-1}else{ag=Math.sqrt(Z(n.NH.xyz,aw));aa=Math.sqrt(Z(n.NH.xyz,at))}G=0.084*((1/ac)+(1/ag)-(1/aa)-(1/ai))*332;if(G<-0.67){p[n.MID+"-"+l.MID]=G;if(!f.hasOwnProperty(n.MID)){f[n.MID]=[]}f[n.MID].push(l);if(!f.hasOwnProperty(l.MID)){f[l.MID]=[]}f[l.MID].push(n)}}az[0]=t.modelsXYZ[0][n.C.xyz];az[1]=t.modelsXYZ[0][n.C.xyz+1];az[2]=t.modelsXYZ[0][n.C.xyz+2];aw[0]=q.modelsXYZ[0][l.N.xyz];aw[1]=q.modelsXYZ[0][l.N.xyz+1];aw[2]=q.modelsXYZ[0][l.N.xyz+2];ai=Z(aw,az);if(ai<25&&n.O&&l.NH){ai=Math.sqrt(ai);at[0]=t.modelsXYZ[0][n.O.xyz];at[1]=t.modelsXYZ[0][n.O.xyz+1];at[2]=t.modelsXYZ[0][n.O.xyz+2];ac=Math.sqrt(Z(aw,at));if(l.NH==true){ag=ai-1;aa=ac-1}else{ag=Math.sqrt(Z(l.NH.xyz,az));aa=Math.sqrt(Z(l.NH.xyz,at))}G=0.084*((1/ac)+(1/ag)-(1/aa)-(1/ai))*332;if(G<-0.67){p[l.MID+"-"+n.MID]=G;if(!f.hasOwnProperty(n.MID)){f[n.MID]=[]}f[n.MID].push(l);if(!f.hasOwnProperty(l.MID)){f[l.MID]=[]}f[l.MID].push(n)}}}}if(Object.keys(f).length==0){var U=180/Math.PI;var aA=[0,0,0],ax=[0,0,0],au=[0,0,0],aC=[0,0,0],aB=[0,0,0],O=[0,0,0],g;var h=function(d,c,z,y){try{vec3.subtract(aA,c,d);vec3.subtract(ax,z,c);vec3.subtract(au,y,z);vec3.scale(aC,aA,vec3.length(ax));vec3.cross(aB,ax,au);ae=vec3.dot(aC,aB);vec3.cross(O,aA,ax);af=vec3.dot(O,aB);g=Math.atan2(ae,af)*U;if(g<0){g+=360}return g}catch(x){return 0}};var az,aw,at,aq,N,K,J,I,ah,M=[],ay=[];for(var T=0;T<u.length;T++){ar=u[T];M=[],ay=[];for(aj=2;aj<ar.length-1;aj++){az=ar[aj-2].CA;aw=ar[aj-1].CA;at=ar[aj].CA;aq=ar[aj+1].CA;if(!az||!aw||!at||!aq){M.push(0);ay.push(0);continue}az=az.xyz;aw=aw.xyz;at=at.xyz;aq=aq.xyz;N=[F.modelsXYZ[0][az],F.modelsXYZ[0][az+1],F.modelsXYZ[0][az+2]];K=[F.modelsXYZ[0][aw],F.modelsXYZ[0][aw+1],F.modelsXYZ[0][aw+2]];J=[F.modelsXYZ[0][at],F.modelsXYZ[0][at+1],F.modelsXYZ[0][at+2]];I=[F.modelsXYZ[0][aq],F.modelsXYZ[0][aq+1],F.modelsXYZ[0][aq+2]];ah=h(N,K,J,I);if(ah>=10&&ah<=120){M.push(1)}else{if(ah>=120&&ah<=270){M.push(2)}else{M.push(0)}}ay.push(ah)}M.push(0);for(aj=1;aj<ar.length-1;aj++){if(M[aj]==0){if(M[aj-1]==1&&M[aj+1]==1){M[aj]=1}if(M[aj-1]==2&&M[aj+1]==2){M[aj]=2}}}M[0]=M[1]=M[2];M[M.length-1]=M[M.length-2];var s=[-1,0],al;for(aj=0;aj<M.length;aj++){if(M[aj]!=s[1]){if(s[1]!=0&&aj-s[0]<4){for(al=s[0];al<aj;al++){M[al]=0}}s[0]=aj;s[1]=M[aj]}}for(aj=0;aj<ar.length;aj++){if(M[aj]==1){ar[aj].sndStruc=3}else{if(M[aj]==2){ar[aj].sndStruc=2}else{if(M[aj]==3){ar[aj].sndStruc=4}}}}}return}var ab=function(c){return c?c.MID:null};var W,V,o,w;var L=[],av,Y,X,ao,R,Q,H=[],S=false;for(var at=0;at<u.length;at++){L.push(av=[]);for(an=0;an<u[at].length;an++){o=0;W=ab(u[at][an]);Y=X=[at,an];if((p.hasOwnProperty(ab(u[at][an+3])+"-"+W))&&!S&&(H.length<3||p.hasOwnProperty(W+"-"+ab(u[at][an-3])))){o=3;Y=[at,an];X=[at,an+3]}else{if(p.hasOwnProperty(W+"-"+ab(u[at][an-3]))&&H.length>3){o=3;Y=[at,an-3];X=[at,an];S=true}}if(p.hasOwnProperty(ab(u[at][an+5])+"-"+W)&&!S&&(H.length<5||p.hasOwnProperty(W+"-"+ab(u[at][an-5])))){o=5;Y=[at,an];X=[at,an+5]}else{if(p.hasOwnProperty(W+"-"+ab(u[at][an-5]))&&H.length>5){o=5;Y=[at,an-5];X=[at,an];S=true}}if(p.hasOwnProperty(ab(u[at][an+4])+"-"+W)&&!S&&(H.length<4||p.hasOwnProperty(W+"-"+ab(u[at][an-4])))){o=4;Y=[at,an];X=[at,an+4]}else{if(p.hasOwnProperty(W+"-"+ab(u[at][an-4]))&&H.length>3){o=4;Y=[at,an-4];X=[at,an];S=true}}if(H.length&&H[H.length-1]!=o){H=[];S=false}H.push(o);av.push([o,Y,X])}}for(var at=0;at<L.length;at++){av=L[at];w=[];H=[];o=0;for(an=0;an<av.length;an++){if(av[an][0]!=o){if(o==3||o==4||o==5){if((w.length>1&&o!=3)||w.length>2){for(am=w[0][1][1];am<w[w.length-1][2][1];am++){u[at][am].sndStruc=3}}else{if(w.length){H.push([w[0][1][1],w[w.length-1][2][1]])}}}o=0;w=[]}if(av[an][0]){w.push(av[an]);o=av[an][0]}}for(an=0;an<H.length;an++){W=Math.max(0,H[an][0]-1);V=Math.min(u[at].length-1,H[an][1]+1);o=u[at][Math.max(0,H[an][0]-1)].sndStruc==3||u[at][Math.min(u[at].length-1,H[an][1]+1)].sndStruc==3?3:4;for(am=H[an][0];am<H[an][1];am++){u[at][am].sndStruc=o}}}var P;for(var at=0;at<u.length;at++){for(an=0;an<u[at].length;an++){if(u[at][an].sndStruc!=3){ao=null;if(u[at][an].previous&&u[at][an].next){R=f[ab(u[at][an].previous)];Q=f[ab(u[at][an].next)];if(R&&Q){for(var al=0,ak;al<R.length;al++){for(ak=0;ak<Q.length;ak++){if(R[al].previous&&R[al].previous==Q[ak].next){ao=[R[al].previous];break}else{if(Q[ak].previous&&Q[ak].previous==R[al].next){ao=[R[al].next];break}}}if(ao){break}}}}if(!ao){ao=f[ab(u[at][an])]}if(ao){for(P=0;P<ao.length;P++){if(ao[P].sndStruc==2){u[at][an].sndStruc=2;break}R=[u[at][an].previous,u[at][an],u[at][an].next];Q=[ao[P].previous,ao[P],ao[P].next];if(p.hasOwnProperty(ab(R[0])+"-"+ab(Q[1]))&&p.hasOwnProperty(ab(Q[1])+"-"+ab(R[2]))){R[0].sndStruc=R[1].sndStruc=R[2].sndStruc=Q[1].sndStruc=2}else{if(p.hasOwnProperty(ab(R[1])+"-"+ab(Q[0]))&&p.hasOwnProperty(ab(Q[2])+"-"+ab(R[1]))){R[1].sndStruc=Q[0].sndStruc=Q[1].sndStruc=Q[2].sndStruc=2}else{if(p.hasOwnProperty(ab(R[1])+"-"+ab(Q[1]))&&p.hasOwnProperty(ab(Q[1])+"-"+ab(R[1]))){R[1].sndStruc=Q[1].sndStruc=2}else{if(p.hasOwnProperty(ab(R[0])+"-"+ab(Q[2]))&&p.hasOwnProperty(ab(R[2])+"-"+ab(Q[0]))){R[0].sndStruc=R[1].sndStruc=R[2].sndStruc=Q[0].sndStruc=Q[1].sndStruc=Q[2].sndStruc=2}}}}}}}}}};molmil.viewer.prototype.setCOR=function(d){var h=this.renderer.modelId;if(this.lastKnowAS){resetCOR()}this.lastKnownAS=null;if(!this.atomSelection.length&&!d){return}if(!d){d=[this.atomSelection[0].chain.modelsXYZ[h][this.atomSelection[0].xyz],this.atomSelection[0].chain.modelsXYZ[h][this.atomSelection[0].xyz+1],this.atomSelection[0].chain.modelsXYZ[h][this.atomSelection[0].xyz+2]]}this.lastKnownAS=[d[0],d[1],d[2]];var f=mat3.create();mat3.fromMat4(f,this.renderer.modelViewMatrix);var g=vec3.subtract([0,0,0],this.lastKnownAS,this.avgXYZ);vec3.transformMat3(g,g,f);this.renderer.camera.x+=g[0];this.renderer.camera.y+=g[1];this.renderer.camera.z+=g[2];for(var c=0;c<this.canvases.length;c++){this.canvases[c].molmilViewer.COR=this.lastKnownAS}this.canvas.atomCORset=true};molmil.viewer.prototype.resetCOR=function(){var d=mat3.create();mat3.fromMat4(d,this.renderer.modelViewMatrix);var f=vec3.subtract([0,0,0],this.avgXYZ,this.lastKnownAS);vec3.transformMat3(f,f,d);this.renderer.camera.x+=f[0];this.renderer.camera.y+=f[1];this.renderer.camera.z+=f[2];for(var c=0;c<this.canvases.length;c++){this.canvases[c].molmilViewer.COR=this.avgXYZ}this.canvas.atomCORset=false;this.lastKnownAS=null};molmil.exportPLY=function(B){B=B||molmil.cli_soup;molmil.geometry.skipClearBuffer=true;molmil.geometry.reInitChains=true;B.renderer.initBuffers();B.renderer.canvas.update=true;molmil.geometry.generate(B.structures,B.renderer);var g=[];if(molmil.geometry.buffer1){g.push(molmil.geometry.buffer1)}if(molmil.geometry.buffer3){g.push(molmil.geometry.buffer3)}if(molmil.geometry.buffer4){g.push(molmil.geometry.buffer4)}for(var x=0;x<B.structures.length;x++){if(B.structures[x] instanceof molmil.polygonObject&&B.structures[x].data){g.push(B.structures[x].data)}}var t,d=0,p=0,u;for(t=0;t<g.length;t++){u=g[t].vertexSize||8;d+=g[t].vertexBuffer.length/u;p+=g[t].indexBuffer.length/3}var w="ply\nformat binary_little_endian 1.0\nelement vertex "+d+"\nproperty float x\nproperty float y\nproperty float z\nproperty float nx\nproperty float ny\nproperty float nz\nproperty uint8 red\nproperty uint8 green\nproperty uint8 blue\nproperty uint8 alpha\nelement face "+p+"\nproperty list int32 int32 vertex_indices\nend_header\n";var h=new Float32Array(d*7);var l=new Uint8Array(h.buffer);var o=new Int32Array(p*4);var q,C,z=0,A=0,n=0,y,s,f=0;for(t=0;t<g.length;t++){u=g[t].vertexSize||8;y=g[t].vertexBuffer;s=new Uint8Array(y.buffer,g[t].vertices_offset);for(q=0,C=0;q<y.length;q+=u,C+=(u*4),A+=28){h[z++]=y[q];h[z++]=y[q+1];h[z++]=y[q+2];h[z++]=y[q+3];h[z++]=y[q+4];h[z++]=y[q+5];l[A+24]=s[C+24];l[A+25]=s[C+25];l[A+26]=s[C+26];l[A+27]=s[C+27];z++}y=g[t].indexBuffer;for(q=0;q<y.length;q+=3){o[n++]=3;o[n++]=f+y[q];o[n++]=f+y[q+1];o[n++]=f+y[q+2]}f+=g[t].vertexBuffer.length/u}var c=new Blob([w,h,o],{type:"application/octet-binary"});saveAs(c,"molmil.ply");molmil.geometry.skipClearBuffer=false};molmil.exportSTL=function(B){B=B||molmil.cli_soup;molmil.geometry.skipClearBuffer=true;molmil.geometry.reInitChains=true;B.renderer.initBuffers();B.renderer.canvas.update=true;molmil.geometry.generate(B.structures,B.renderer);var n=[];if(molmil.geometry.buffer1){n.push(molmil.geometry.buffer1)}if(molmil.geometry.buffer3){n.push(molmil.geometry.buffer3)}if(molmil.geometry.buffer4){n.push(molmil.geometry.buffer4)}for(var y=0;y<B.structures.length;y++){if(B.structures[y] instanceof molmil.polygonObject&&B.structures[y].data){n.push(B.structures[y].data)}}var t,h=0,p=0,u;for(t=0;t<n.length;t++){u=n[t].vertexSize||8;h+=n[t].vertexBuffer.length/u;p+=n[t].indexBuffer.length/3}var x="generated by molmil";x+=new Array(80-x.length+1).join(" ");var q=new Uint32Array(1);q[0]=p;var s=[x,q];var t,C,l,z,o,y,g=[0,0,0],f=[0,0,0],d=[0,0,0],A=[0,0,0],w=[0,0,0];for(t=0;t<n.length;t++){z=n[t].vertexBuffer;o=n[t].indexBuffer;u=n[t].vertexSize||8;for(v=0;v<o.length;v+=3){C=new Float32Array(12);l=new Uint16Array(1);l[0]=0;y=o[v]*u;g[0]=C[3]=z[y];g[1]=C[4]=z[y+1];g[2]=C[5]=z[y+2];y=o[v+1]*u;f[0]=C[6]=z[y];f[1]=C[7]=z[y+1];f[2]=C[8]=z[y+2];y=o[v+2]*u;d[0]=C[9]=z[y];d[1]=C[10]=z[y+1];d[2]=C[11]=z[y+2];vec3.min(A,f,g);vec3.normalize(A,A);vec3.min(w,d,g);vec3.normalize(w,w);C[0]=A[1]*w[2]-A[2]*w[1];C[1]=A[2]*w[0]-A[0]*w[2];C[2]=A[0]*w[1]-A[1]*w[0];s.push(C);s.push(l)}}var c=new Blob(s,{type:"application/octet-binary"});saveAs(c,"molmil.stl");molmil.geometry.skipClearBuffer=false};molmil.geometry={templates:{sphere:{},cylinder:[],dome:{}},detail_lvs:5,dome:[0,0,-1],radius:0.25,sheetHeight:0.125,skipClearBuffer:false,onGenerate:null};molmil.geometry.getSphere=function(c,d){if(c in this.templates.sphere){return this.templates.sphere[c][d]}else{return this.generateSphere(c)[d]}};molmil.geometry.getCylinder=function(c){return this.templates.cylinder[c]};molmil.geometry.generateCylinder=function(){var f,n,d,c,q,o,l,h;for(var g=0;g<this.detail_lvs;g++){f=(g+1)*4;d=0;n=2/f;this.templates.cylinder.push({vertices:[],normals:[],indices:[]});for(c=0;c<f;c++){q=Math.cos(d*Math.PI);o=Math.sin(d*Math.PI);this.templates.cylinder[g].vertices.push(q,o,0);this.templates.cylinder[g].vertices.push(q,o,0.5);h=Math.sqrt(q*q+o*o);this.templates.cylinder[g].normals.push(q/h,o/h,0);this.templates.cylinder[g].normals.push(q/h,o/h,0);d+=n}for(c=0;c<(f-1)*2;c+=2){this.templates.cylinder[g].indices.push(c,c+2,c+3);this.templates.cylinder[g].indices.push(c+3,c+1,c)}this.templates.cylinder[g].indices.push(c,0,1);this.templates.cylinder[g].indices.push(1,c+1,c)}return this.templates.cylinder};molmil.geometry.generateCylinder();molmil.geometry.generateSphere=function(h){this.templates.sphere[h]=[];var g,f,d,c;for(g=0;g<this.detail_lvs;g++){d={vertices:[],normals:[],indices:[]};c=molmil.octaSphereBuilder(g);for(f=0;f<c.vertices.length;f++){d.vertices.push(c.vertices[f][0]*h,c.vertices[f][1]*h,c.vertices[f][2]*h)}for(f=0;f<c.faces.length;f++){d.indices.push(c.faces[f][0],c.faces[f][1],c.faces[f][2])}for(f=0;f<c.vertices.length;f++){d.normals.push(c.vertices[f][0],c.vertices[f][1],c.vertices[f][2])}this.templates.sphere[h].push(d)}return this.templates.sphere[h]};molmil.geometry.generate=function(h,g,l){this.reset();var n=[],d=[];for(var f=0,o;f<h.length;f++){if(!(h[f] instanceof molmil.entryObject)){continue}for(var o=0;o<h[f].chains.length;o++){if(h[f].chains[o].display&&h[f].chains[o].molecules.length>0&&!h[f].chains[o].isHet&&!h[f].chains[o].molecules[0].water){d.push(h[f].chains[o])}n.push(h[f].chains[o])}}this.initChains(n,g,l);this.initCartoon(d);this.generateAtoms();this.generateBonds();this.generateWireframe();this.generateCartoon();this.generateSurfaces(d);this.registerPrograms(g);if(!this.skipClearBuffer){this.reset()}if(this.onGenerate){molmil_dep.asyncStart(this.onGenerate[0],this.onGenerate[1],this.onGenerate[2],0)}};molmil.geometry.build_simple_render_program=function(l,f,g,d){var h=g.gl;var c={};c.settings=d;c.gl=g.gl;c.renderer=g;c.setBuffers=function(o,q){var p=this.gl.createBuffer();this.gl.bindBuffer(h.ARRAY_BUFFER,p);this.gl.bufferData(this.gl.ARRAY_BUFFER,o,this.gl.STATIC_DRAW);var n=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,n);this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,q,this.gl.STATIC_DRAW);this.nElements=q.length;this.vertexBuffer=p;this.indexBuffer=n};if(l&&f){c.setBuffers(l,f)}c.angle=g.angle;if(d.uniform_color){c.standard_shader=g.shaders.standard_uniform_color;c.wireframe_shader=g.shaders.lines_uniform_color}else{c.standard_shader=g.shaders.standard_alpha;c.wireframe_shader=g.shaders.lines}c.standard_attributes=c.standard_shader.attributes;c.wireframe_attributes=c.wireframe_shader.attributes;c.status=true;c.wireframe_render=function(o,s,q){if(!this.status){return}var t=mat3.create();this.gl.useProgram(this.wireframe_shader.program);this.gl.uniformMatrix4fv(this.wireframe_shader.uniforms.modelViewMatrix,false,o);this.gl.uniformMatrix4fv(this.wireframe_shader.uniforms.projectionMatrix,false,this.renderer.projectionMatrix);this.gl.uniform3f(this.wireframe_shader.uniforms.COR,s[0],s[1],s[2]);this.gl.uniform1f(this.wireframe_shader.uniforms.focus,this.renderer.fogStart);this.gl.uniform1f(this.wireframe_shader.uniforms.fogSpan,this.renderer.fogStart+(this.renderer.clearCut*2));if(this.settings.uniform_color){this.gl.uniform3f(this.wireframe_shader.uniforms.uniform_color,this.uniform_color[q][0]/255,this.uniform_color[q][1]/255,this.uniform_color[q][2]/255)}if(this.renderer.settings.slab){this.gl.uniform1f(this.wireframe_shader.uniforms.slabNear,-o[14]+this.renderer.settings.slabNear-molmil.configBox.zNear);this.gl.uniform1f(this.wireframe_shader.uniforms.slabFar,-o[14]+this.renderer.settings.slabFar-molmil.configBox.zNear)}this.gl.uniform4f(this.wireframe_shader.uniforms.backgroundColor,molmil.configBox.BGCOLOR[0],molmil.configBox.BGCOLOR[1],molmil.configBox.BGCOLOR[2],1);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer);if(this.settings.lines_render){if(this.settings.has_ID){this.gl.vertexAttribPointer(this.wireframe_attributes.in_Position,3,this.gl.FLOAT,false,20,0);if(!this.settings.uniform_color){this.gl.vertexAttribPointer(this.wireframe_attributes.in_Colour,4,this.gl.UNSIGNED_BYTE,true,20,12)}}else{this.gl.vertexAttribPointer(this.wireframe_attributes.in_Position,3,this.gl.FLOAT,false,16,0);this.gl.vertexAttribPointer(this.wireframe_attributes.in_Colour,4,this.gl.UNSIGNED_BYTE,true,16,12)}}else{if(this.settings.has_ID){this.gl.vertexAttribPointer(this.wireframe_attributes.in_Position,3,this.gl.FLOAT,false,32,0);this.gl.vertexAttribPointer(this.wireframe_attributes.in_Colour,4,this.gl.UNSIGNED_BYTE,true,32,24)}else{this.gl.vertexAttribPointer(this.wireframe_attributes.in_Position,3,this.gl.FLOAT,false,28,0);this.gl.vertexAttribPointer(this.wireframe_attributes.in_Colour,4,this.gl.UNSIGNED_BYTE,true,28,24)}}this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);if(this.angle){var p=0,n;while((n=Math.min(this.nElements-p,3000000))>0){this.gl.drawElements(this.gl.LINES,n,h.UNSIGNED_INT,p*4);p+=n}}else{this.gl.drawElements(this.gl.LINES,this.nElements,h.UNSIGNED_INT,0)}};c.standard_render=function(o,s,q){if(!this.status){return}var t=mat3.create();mat3.normalFromMat4(t,o);this.gl.useProgram(this.standard_shader.program);this.gl.uniformMatrix4fv(this.standard_shader.uniforms.modelViewMatrix,false,o);this.gl.uniformMatrix3fv(this.standard_shader.uniforms.normalMatrix,false,t);this.gl.uniformMatrix4fv(this.standard_shader.uniforms.projectionMatrix,false,this.renderer.projectionMatrix);this.gl.uniform3f(this.standard_shader.uniforms.COR,s[0],s[1],s[2]);this.gl.uniform1f(this.standard_shader.uniforms.focus,this.renderer.fogStart);this.gl.uniform1f(this.standard_shader.uniforms.fogSpan,this.renderer.fogStart+(this.renderer.clearCut*2));if(this.settings.uniform_color){this.gl.uniform3f(this.standard_shader.uniforms.uniform_color,this.uniform_color[q][0]/255,this.uniform_color[q][1]/255,this.uniform_color[q][2]/255)}this.gl.uniform4f(this.standard_shader.uniforms.backgroundColor,molmil.configBox.BGCOLOR[0],molmil.configBox.BGCOLOR[1],molmil.configBox.BGCOLOR[2],1);if(this.renderer.settings.slab){this.gl.uniform1f(this.standard_shader.uniforms.slabNear,-o[14]+this.renderer.settings.slabNear-molmil.configBox.zNear);this.gl.uniform1f(this.standard_shader.uniforms.slabFar,-o[14]+this.renderer.settings.slabFar-molmil.configBox.zNear)}this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer);if(this.settings.has_ID){this.gl.vertexAttribPointer(this.standard_attributes.in_Position,3,this.gl.FLOAT,false,32,0);this.gl.vertexAttribPointer(this.standard_attributes.in_Normal,3,this.gl.FLOAT,false,32,12);if(!this.settings.uniform_color){this.gl.vertexAttribPointer(this.standard_attributes.in_Colour,4,this.gl.UNSIGNED_BYTE,true,32,24)}}else{this.gl.vertexAttribPointer(this.standard_attributes.in_Position,3,this.gl.FLOAT,false,28,0);this.gl.vertexAttribPointer(this.standard_attributes.in_Normal,3,this.gl.FLOAT,false,28,12);this.gl.vertexAttribPointer(this.standard_attributes.in_Colour,4,this.gl.UNSIGNED_BYTE,true,28,24)}this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);if(this.angle){var p=0,n;while((n=Math.min(this.nElements-p,3000000))>0){this.gl.drawElements(this.gl.TRIANGLES,n,h.UNSIGNED_INT,p*4);p+=n}}else{this.gl.drawElements(this.gl.TRIANGLES,this.nElements,h.UNSIGNED_INT,0)}};if(!d.multiMatrix){if(!d.solid){c.render=c.wireframe_render}else{c.render=c.standard_render}}else{c.render=function(n,q){var p=mat4.create();for(var o=0;o<this.matrices.length;o++){mat4.multiply(p,n,this.matrices[o]);this.render_internal(p,q,o)}};if(!d.solid){c.render_internal=c.wireframe_render;c.shader=c.wireframe_shader}else{c.render_internal=c.standard_render;c.shader=c.standard_shader}}if(d.has_ID){if(d.lines_render){c.pickingShader=g.shaders.linesPicking;c.pickingAttributes=g.shaders.linesPicking.attributes;c.renderPicking=function(o,q){if(!this.status){return}this.gl.useProgram(this.pickingShader.program);this.gl.uniformMatrix4fv(this.pickingShader.uniforms.modelViewMatrix,false,o);this.gl.uniformMatrix4fv(this.pickingShader.uniforms.projectionMatrix,false,this.renderer.projectionMatrix);this.gl.uniform3f(this.pickingShader.uniforms.COR,q[0],q[1],q[2]);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer);this.gl.vertexAttribPointer(this.pickingAttributes.in_Position,3,this.gl.FLOAT,false,20,0);this.gl.vertexAttribPointer(this.pickingAttributes.in_ID,1,this.gl.FLOAT,false,20,16);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);if(this.angle){var p=0,n;while((n=Math.min(this.nElements-p,3000000))>0){this.gl.drawElements(this.gl.POINTS,n,h.UNSIGNED_INT,p*4);p+=n}}else{this.gl.drawElements(this.gl.POINTS,this.nElements,h.UNSIGNED_INT,0)}}}else{c.pickingShader=g.shaders.picking;c.pickingAttributes=g.shaders.picking.attributes;c.renderPicking=function(o,q){if(!this.status){return}this.gl.useProgram(this.pickingShader.program);this.gl.uniformMatrix4fv(this.pickingShader.uniforms.modelViewMatrix,false,o);this.gl.uniformMatrix4fv(this.pickingShader.uniforms.projectionMatrix,false,this.renderer.projectionMatrix);this.gl.uniform3f(this.pickingShader.uniforms.COR,q[0],q[1],q[2]);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer);this.gl.vertexAttribPointer(this.pickingAttributes.in_Position,3,this.gl.FLOAT,false,32,0);this.gl.vertexAttribPointer(this.pickingAttributes.in_ID,1,this.gl.FLOAT,false,32,28);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);if(this.angle){var p=0,n;while((n=Math.min(this.nElements-p,3000000))>0){this.gl.drawElements(this.gl.TRIANGLES,n,h.UNSIGNED_INT,p*4);p+=n}}else{this.gl.drawElements(this.gl.TRIANGLES,this.nElements,h.UNSIGNED_INT,0)}}}}else{c.renderPicking=function(){}}return c};molmil.geometry.registerPrograms=function(c){if(!c.program1){c.program1=this.build_simple_render_program(null,null,c,{has_ID:true,solid:true});c.programs.push(c.program1)}if(!c.program2){c.program2=this.build_simple_render_program(null,null,c,{has_ID:true,lines_render:true});c.programs.push(c.program2)}if(!c.program3){c.program3=this.build_simple_render_program(null,null,c,{has_ID:true,solid:true});c.programs.push(c.program3)}if(!c.program4){c.program4=this.build_simple_render_program(null,null,c,{has_ID:true,solid:true});c.programs.push(c.program4)}c.program1.setBuffers(this.buffer1.vertexBuffer,this.buffer1.indexBuffer);c.program2.setBuffers(this.buffer2.vertexBuffer,this.buffer2.indexBuffer);c.program3.setBuffers(this.buffer3.vertexBuffer,this.buffer3.indexBuffer);c.program4.setBuffers(this.buffer4.vertexBuffer,this.buffer4.indexBuffer);if(molmil.configBox.liteMode){molmil.geometry.reset()}};molmil.geometry.reset=function(){this.atoms2draw=[];this.wfatoms2draw=[];this.trace=[];this.bonds2draw=[];this.lines2draw=[];this.bondRef={};this.buffer1={vP:0,iP:0};this.buffer2={vP:0,iP:0};this.buffer3={vP:0,iP:0};this.buffer4={vP:0,iP:0}};molmil.geometry.initChains=function(A,I,g){g=g||0;var w,H,G;var o=this.atoms2draw;var s=this.wfatoms2draw;var E=this.bonds2draw;var t=this.lines2draw;var f=this.bondRef;var h=0,u=0,C;for(var D=0;D<A.length;D++){w=A[D];C=false;if(!w.display){continue}for(var H=0;H<w.atoms.length;H++){if(w.atoms[H].displayMode==0||!w.atoms[H].status){continue}else{if(w.atoms[H].displayMode==4){s.push(w.atoms[H])}else{o.push(w.atoms[H])}}C=true}if(C&&!w.bondsOK){I.soup.buildBondList(w,false)}for(var G=0;G<w.bonds.length;G++){if(w.bonds[G][0].displayMode<2||w.bonds[G][1].displayMode<2||!w.bonds[G][0].status||!w.bonds[G][1].status){continue}if(w.bonds[G][0].displayMode==4||w.bonds[G][1].displayMode==4){t.push(w.bonds[G])}else{E.push(w.bonds[G]);u+=w.bonds[G][2]*2;if(!f.hasOwnProperty(w.bonds[G][0].AID)){f[w.bonds[G][0].AID]=[]}if(!f.hasOwnProperty(w.bonds[G][1].AID)){f[w.bonds[G][1].AID]=[]}f[w.bonds[G][0].AID].push(w.bonds[G][1]);f[w.bonds[G][1].AID].push(w.bonds[G][0])}}if(w.displayMode==1){if(!w.bondsOK){I.soup.buildBondList(w,false)}for(var x=0;x<w.molecules.length;x++){if(w.molecules[x].CA){if(w.molecules[x].next&&w.molecules[x].next.displayMode==1&&w.molecules[x].next.CA){o.push(w.molecules[x].CA);E.push([w.molecules[x].CA,w.molecules[x].next.CA]);u+=2}else{if(w.molecules[x].previous&&w.molecules[x].previous.displayMode==1&&w.molecules[x].previous.CA){o.push(w.molecules[x].CA)}}}}}if(w.displayMode>1&&w.displayMode!=molmil.displayMode_ChainSurfaceCG){if(!w.twoDcache||this.reInitChains){molmil.prepare2DRepr(w,this.modelId||0)}h+=w.molecules.length}}this.reInitChains=false;var d=molmil.configBox.QLV_SETTINGS[I.QLV].SPHERE_TESS_LV;var F=molmil.configBox.QLV_SETTINGS[I.QLV].CB_NOI;var z=molmil.configBox.QLV_SETTINGS[I.QLV].CB_NOVPR;var y=o.length*(6*Math.pow(4,d+1));y+=E.length*(d+1)*4*2;y+=h*F*z;if(y>10000000){d-=1}if(y>30000000){d-=1}if(y>100000000){d-=1}if(y<250000&&d<3){d+=1}d=this.detail_lv=Math.max(d+g,0);if(molmil.configBox.liteMode){d=this.detail_lv=1}this.noi=molmil.configBox.QLV_SETTINGS[this.detail_lv].CB_NOI;this.novpr=molmil.configBox.QLV_SETTINGS[this.detail_lv].CB_NOVPR;if(molmil.configBox.liteMode){this.noi=1}var q=this.buffer1,n=this.buffer2;var y=0,p=0;var l=this.getSphere(1,d);y+=(l.vertices.length/3)*o.length;p+=l.indices.length*o.length;var B=this.getCylinder(d);y+=(B.vertices.length/3)*u;p+=B.indices.length*u;q.vertexBuffer=new Float32Array(y*8);q.vertexBuffer8=new Uint8Array(q.vertexBuffer.buffer);q.indexBuffer=new Uint32Array(p);n.vertexBuffer=new Float32Array(s.length*5);n.vertexBuffer8=new Uint8Array(n.vertexBuffer.buffer);n.indexBuffer=new Uint32Array(t.length*2)};molmil.geometry.initCartoon=function(F){var H,B,I,C=0,o=0,d,f=0,z=this.cartoonChains=[],K,J=this.nowps=[];var t=this.noi;var s=this.novpr;if(this.dome[2]!=this.detail_lv){var l=this.dome=[molmil.buildOctaDome(molmil.configBox.QLV_SETTINGS[this.detail_lv].CB_DOME_TESS_LV,0),molmil.buildOctaDome(molmil.configBox.QLV_SETTINGS[this.detail_lv].CB_DOME_TESS_LV,1),this.detail_lv];var n=mat4.create();mat4.rotateZ(n,n,(45*Math.PI)/180);for(var E=0;E<this.dome[0].vertices.length;E++){vec3.transformMat4(this.dome[0].vertices[E],this.dome[0].vertices[E],n);vec3.transformMat4(this.dome[1].vertices[E],this.dome[1].vertices[E],n)}var D=this.ringTemplate=[];var h=s,q=0,L=2/h,w,u,A,G;for(A=0;A<h;A++){w=Math.cos(q*Math.PI);u=Math.sin(q*Math.PI);D.push([w,u,0]);q+=L}this.squareVertices=[[-1,1,0],[1,1,0],[1,-1,0],[-1,-1,0],[-1,1,0]];this.squareVerticesN=[[-1,0,0],[0,1,0],[1,0,0],[0,-1,0],[-1,0,0]]}else{var l=this.dome}for(H=0;H<F.length;H++){B=F[H];if(B.displayMode<2||B.displayMode==molmil.displayMode_ChainSurfaceCG){continue}K=0;z.push(B);for(I=0;I<B.twoDcache.length;I++){d=B.twoDcache[I];if(B.displayMode>2&&d.sndStruc==2){if(!d.isFirst){C+=s;o+=s*2}C+=4+(d.molecules.length*8*(t+1))+8+s;o+=2+(d.molecules.length*8*(t+1))+(s*2);if(!d.isLast){C+=s}K+=d.molecules.length*(t+1);if(d.isLast){K-=t}}else{if(d.rocket){if(d.skip){continue}C+=s+1+(d.waypoints.length*s)+s+1;o+=s+(d.waypoints.length*s*2)+s;if(!d.isFirst){C+=s*(Math.round(t*0.5)+1);o+=s*2*(Math.round(t*0.5)+1)}if(!d.isLast){C+=s;C+=s*(Math.round(t*0.5)+2);o+=s*2*(Math.round(t*0.5)+2)}K+=d.molecules.length*(t+1)}else{if(d.isFirst){C+=l[0].vertices.length;o+=l[0].faces.length-(s*2)}if(d.isLast){C+=l[0].vertices.length+s;o+=l[0].faces.length+(s*2)}C+=d.molecules.length*s*(t+1);o+=d.molecules.length*s*2*(t+1);K+=d.molecules.length*(t+1);if(d.isLast){K-=t;C-=s*(t+1);o-=s*2*(t+1)}}}}J.push(K)}var g=this.buffer3;g.vertexBuffer=new Float32Array(C*8);g.vertexBuffer8=new Uint8Array(g.vertexBuffer.buffer);g.indexBuffer=new Uint32Array(o*3)};molmil.geometry.generateAtoms=function(){var d=this.atoms2draw,A=molmil.configBox.vdwR,c,l,u,w,n;vBuffer=this.buffer1.vertexBuffer,iBuffer=this.buffer1.indexBuffer,vP=this.buffer1.vP,iP=this.buffer1.iP,detail_lv=this.detail_lv,vBuffer8=this.buffer1.vertexBuffer8,vP8=vP*4;var f=vP/8;var h=this.modelId||0,o;var t,s,q;l=this.getSphere(1.7,detail_lv);var g=l.vertices.length/3;for(u=0;u<d.length;u++){if(d[u].displayMode==1){c=molmil_dep.getKeyFromObject(A,d[u].element,A.DUMMY)}else{if(d[u].displayMode==2){c=0.33}else{c=0.15}}l=this.getSphere(c,detail_lv);for(w=0;w<l.indices.length;w++,iP++){iBuffer[iP]=l.indices[w]+f}o=h;if(d[u].chain.modelsXYZ.length<=h){h=0}t=d[u].chain.modelsXYZ[h][d[u].xyz];s=d[u].chain.modelsXYZ[h][d[u].xyz+1];q=d[u].chain.modelsXYZ[h][d[u].xyz+2];n=d[u].rgba;for(w=0;w<l.vertices.length;w+=3,vP8+=32){vBuffer[vP++]=l.vertices[w]+t;vBuffer[vP++]=l.vertices[w+1]+s;vBuffer[vP++]=l.vertices[w+2]+q;vBuffer[vP++]=l.normals[w];vBuffer[vP++]=l.normals[w+1];vBuffer[vP++]=l.normals[w+2];vBuffer8[vP8+24]=n[0];vBuffer8[vP8+25]=n[1];vBuffer8[vP8+26]=n[2];vBuffer8[vP8+27]=n[3];vP++;vBuffer[vP++]=d[u].AID}f+=g}this.buffer1.vP=vP;this.buffer1.iP=iP};molmil.geometry.generateBonds=function(){var w=this.getCylinder(this.detail_lv);var A=this.modelId||0,O;var g=this.bonds2draw,o=this.buffer1.vertexBuffer,n=this.buffer1.indexBuffer,C=this.buffer1.vP,S=this.buffer1.iP,W=this.detail_lv,q=this.buffer1.vertexBuffer8,B=C*4;var N=w.vertices.length/3;var M,K,I,G,U=[0,0,0],T=[0,0,0],l=[0,0,0];var P=C/8,J,H,F,s,V,D,Q,R;var E=mat4.create();var u=[0,0,0,0],L=[0,0,0,0],h,f,d,c,t;for(b=0;b<g.length;b++){Q=g[b][2]==2?4:2;O=A;if(g[b][0].chain.modelsXYZ.length<=A){A=0}J=g[b][0].chain.modelsXYZ[A][g[b][0].xyz];H=g[b][0].chain.modelsXYZ[A][g[b][0].xyz+1];F=g[b][0].chain.modelsXYZ[A][g[b][0].xyz+2];s=g[b][1].chain.modelsXYZ[A][g[b][1].xyz];V=g[b][1].chain.modelsXYZ[A][g[b][1].xyz+1];D=g[b][1].chain.modelsXYZ[A][g[b][1].xyz+2];h=J-s;f=H-V;d=F-D;c=Math.sqrt((h*h)+(f*f)+(d*d));h/=c;f/=c;d/=c;t=Math.acos(-d);mat4.identity(E);mat4.rotate(E,E,t,[f,-h,0]);M=0.15;K=0;I=0;G=0;if(g[b][2]==2){M=0.075;K=-0.075}R=g[b][0].rgba;for(v=0;v<w.indices.length;v++,S++){n[S]=w.indices[v]+P}for(v=0;v<w.vertices.length;v+=3,B+=32){vec3.transformMat4(u,[(w.vertices[v]*M)+K,(w.vertices[v+1]*M)+I,(w.vertices[v+2]+G)*c],E);vec3.transformMat4(L,[w.normals[v],w.normals[v+1],w.normals[v+2]],E);o[C++]=u[0]+J;o[C++]=u[1]+H;o[C++]=u[2]+F;o[C++]=L[0];o[C++]=L[1];o[C++]=L[2];q[B+24]=R[0];q[B+25]=R[1];q[B+26]=R[2];q[B+27]=R[3];C++;o[C++]=0}P+=N;G+=0.5;R=g[b][1].rgba;for(v=0;v<w.indices.length;v++,S++){n[S]=w.indices[v]+P}for(v=0;v<w.vertices.length;v+=3,B+=32){vec3.transformMat4(u,[(w.vertices[v]*M)+K,(w.vertices[v+1]*M)+I,(w.vertices[v+2]+G)*c],E);vec3.transformMat4(L,[w.normals[v],w.normals[v+1],w.normals[v+2]],E);o[C++]=u[0]+J;o[C++]=u[1]+H;o[C++]=u[2]+F;o[C++]=L[0];o[C++]=L[1];o[C++]=L[2];q[B+24]=R[0];q[B+25]=R[1];q[B+26]=R[2];q[B+27]=R[3];C++;o[C++]=0}P+=N;if(g[b][2]==2){M=0.075;K=0.075;G=0;R=g[b][0].rgba;for(v=0;v<w.indices.length;v++,S++){n[S]=w.indices[v]+P}for(v=0;v<w.vertices.length;v+=3,B+=32){vec3.transformMat4(u,[(w.vertices[v]*M)+K,(w.vertices[v+1]*M)+I,(w.vertices[v+2]+G)*c],E);vec3.transformMat4(L,[w.normals[v],w.normals[v+1],w.normals[v+2]],E);o[C++]=u[0]+J;o[C++]=u[1]+H;o[C++]=u[2]+F;o[C++]=L[0];o[C++]=L[1];o[C++]=L[2];q[B+24]=R[0];q[B+25]=R[1];q[B+26]=R[2];q[B+27]=R[3];C++;o[C++]=0}P+=N;G+=0.5;R=g[b][1].rgba;for(v=0;v<w.indices.length;v++,S++){n[S]=w.indices[v]+P}for(v=0;v<w.vertices.length;v+=3,B+=32){vec3.transformMat4(u,[(w.vertices[v]*M)+K,(w.vertices[v+1]*M)+I,(w.vertices[v+2]+G)*c],E);vec3.transformMat4(L,[w.normals[v],w.normals[v+1],w.normals[v+2]],E);o[C++]=u[0]+J;o[C++]=u[1]+H;o[C++]=u[2]+F;o[C++]=L[0];o[C++]=L[1];o[C++]=L[2];q[B+24]=R[0];q[B+25]=R[1];q[B+26]=R[2];q[B+27]=R[3];C++;o[C++]=0}P+=N}}this.buffer1.vP=C;this.buffer1.iP=S};molmil.geometry.generateWireframe=function(){var l=this.wfatoms2draw,s=this.lines2draw,u,n=this.buffer2.vertexBuffer,q=this.buffer2.indexBuffer,o=this.buffer2.vP,x=this.buffer2.iP,w=this.buffer2.vertexBuffer8,h=o*4;var g=0.5;var c=o/5;var f={};var d=this.modelId||0;for(var u=0;u<l.length;u++,c++,h+=20){f[l[u].AID]=c;n[o++]=l[u].chain.modelsXYZ[d][l[u].xyz];n[o++]=l[u].chain.modelsXYZ[d][l[u].xyz+1];n[o++]=l[u].chain.modelsXYZ[d][l[u].xyz+2];w[h+12]=l[u].rgba[0];w[h+13]=l[u].rgba[1];w[h+14]=l[u].rgba[2];w[h+16]=l[u].rgba[3];o++;n[o++]=l[u].AID}for(var t=0;t<s.length;t++){q[x++]=f[s[t][0].AID];q[x++]=f[s[t][1].AID]}this.buffer2.vP=o;this.buffer2.iP=x};molmil.geometry.generateSurfaces=function(p){var u,l,d=[],x=0,f=0;for(u=0;u<p.length;u++){if(p[u].displayMode!=molmil.displayMode_ChainSurfaceCG){continue}l=molmil.coarseSurface(p[u],7.5,7.5*0.75);l.rgba=p[u].rgba;d.push(l);x+=l.vertices.length;f+=l.faces.length}var q=new Float32Array(x*8);var z=new Uint8Array(q.buffer);var y=new Uint32Array(f*3);var g=0,t=0,A,h,n=0,o=0;for(A=0;A<d.length;A++){l=d[A];h=l.rgba;for(u=0;u<l.vertices.length;u++,t+=32){q[g++]=l.vertices[u][0];q[g++]=l.vertices[u][1];q[g++]=l.vertices[u][2];q[g++]=l.normals[u][0];q[g++]=l.normals[u][1];q[g++]=l.normals[u][2];z[t+24]=h[0];z[t+25]=h[1];z[t+26]=h[2];z[t+27]=h[3];g++;g++}for(u=0;u<l.faces.length;u++){y[o++]=l.faces[u][0]+n;y[o++]=l.faces[u][1]+n;y[o++]=l.faces[u][2]+n}n+=l.vertices.length}var w=this.buffer4;w.vertexBuffer=q;w.vertexBuffer8=z;w.indexBuffer=y};molmil.geometry.generateCartoon=function(){var F=this.cartoonChains,J,M,o,D,w,C,g,A,h,l,n,E,d,G,p,y=0,O,B,z=[0,0,0],L=0.0001,u;var s=this.noi;var q=this.novpr;var K,f,I,x;var H=[];for(E=0;E<s+1;E++){H.push(E/(s+1))}for(J=0;J<F.length;J++){K=this.nowps[J];f=0;C=[],g=[],A=[],h=new Array(K),l=new Float32Array(K);chain=F[J];w=[];BNs=[];u=[];if(chain.displayMode==0){continue}for(M=0;M<chain.twoDcache.length;M++){u.push(w.length);currentBlock=chain.twoDcache[M];if(currentBlock.rocket){if(currentBlock.skip){continue}currentBlock.rocketPre=0;currentBlock.rocketPost=0;if(!currentBlock.isFirst){currentBlock.rocketPre=Math.round(s*0.5)+2;molmil.hermiteInterpolate(chain.twoDcache[M-1].xyz[D],currentBlock.waypoints[0],chain.twoDcache[M-1].tangents[D],currentBlock.waypoint_tangents[0],Math.round(s*0.5)+1,w,C);for(E=0;E<Math.round(s*0.5)+2;E++){h[f]=currentBlock.molecules[0].rgba;l[f]=0;f++}}for(D=0;D<currentBlock.waypoints.length;D++){h[f]=currentBlock.molecules[0].rgba;l[f]=0;f++;w.push(currentBlock.waypoints[D]);C.push(currentBlock.waypoint_tangents[D])}if(!currentBlock.isLast){currentBlock.rocketPost=Math.round(s*0.5)+2;for(o=M+1;o<chain.twoDcache.length;o++){if(!chain.twoDcache[o].skip){break}}I=C.length;molmil.hermiteInterpolate(currentBlock.waypoints[D-1],chain.twoDcache[o].xyz[0],currentBlock.waypoint_tangents[D-1],chain.twoDcache[o].tangents[0],Math.round(s*0.5)+1,w,C);z[0]=C[I][0]+C[I+1][0];z[1]=C[I][1]+C[I+1][1];z[2]=C[I][2]+C[I+1][2];vec3.normalize(z,z);C[I][0]=z[0];C[I][1]=z[1];C[I][2]=z[2];for(E=0;E<Math.round(s*0.5)+2;E++){h[f]=currentBlock.molecules[0].rgba;l[f]=0;f++}}}else{for(D=0;D<currentBlock.molecules.length-1;D++){molmil.hermiteInterpolate(currentBlock.xyz[D],currentBlock.xyz[D+1],currentBlock.tangents[D],currentBlock.tangents[D+1],s,w,C);for(E=0;E<s+1;E++){h[f]=currentBlock.molecules[D].rgba;l[f]=currentBlock.molecules[D].CA.AID;f++}}if(!currentBlock.isLast){if(!chain.twoDcache[M+1].rocket){molmil.hermiteInterpolate(currentBlock.xyz[D],chain.twoDcache[M+1].xyz[0],currentBlock.tangents[D],currentBlock.tangents[D+1],s,w,C);for(E=0;E<s+1;E++){h[f]=currentBlock.molecules[D].rgba;l[f]=currentBlock.molecules[D].CA.AID;f++}}}else{w.push([currentBlock.xyz[D][0],currentBlock.xyz[D][1],currentBlock.xyz[D][2]]);if(C.length){C.push(C[f-1])}else{C.push([1,0,0])}h[f]=currentBlock.molecules[D].rgba;l[f]=currentBlock.molecules[D].CA.AID;f++}}}u.push(w.length);for(M=0,y=0;M<chain.twoDcache.length;M++){currentBlock=chain.twoDcache[M];if(chain.displayMode>2&&(currentBlock.sndStruc==2||currentBlock.sndStruc==3)&&!currentBlock.rocket){n=null;if(currentBlock.sndStruc==2){n=currentBlock.normals;I=currentBlock.molecules.length-(currentBlock.isLast?1:0);for(D=0;D<I;D++){for(E=0;E<s+1;E++,y++){d=C[y];p=vec3.lerp([0,0,0],n[D],n[D+1],H[E]);vec3.normalize(p,p);vec3.scaleAndAdd(p,p,d,-vec3.dot(p,d)/vec3.dot(d,d));vec3.normalize(p,p);A.push(p);G=vec3.cross([0,0,0],p,d);vec3.normalize(G,G);vec3.negate(G,G);g.push(G)}}if(I!=currentBlock.molecules.length){d=C[y];p=vec3.lerp([0,0,0],n[D],n[D+1],H[E]);vec3.normalize(p,p);vec3.scaleAndAdd(p,p,d,-vec3.dot(p,d)/vec3.dot(d,d));vec3.normalize(p,p);A.push(p);G=vec3.cross([0,0,0],p,d);vec3.normalize(G,G);vec3.negate(G,G);g.push(G);y++}}else{if(currentBlock.sndStruc==3){n=currentBlock.binormals;if(!currentBlock.isFirst&&!currentBlock.Nresume&&x){vec3.cross(z,C[y-1],C[y]);if(vec3.length(z)>L){vec3.normalize(z,z);theta=Math.acos(Math.max(-1,Math.min(1,vec3.dot(C[y-1],C[y]))));mat4.rotate(x,identityMatrix,theta,z);vec3.transformMat4(O,O,x)}vec3.cross(B,C[y],O);n[0]=[B[0],B[1],B[2]];if(vec3.dot(n[0],n[1])<0){I=currentBlock;E=1;while(true){for(D=E;D<I.molecules.length;D++){vec3.negate(I.binormals[D],I.binormals[D])}I.invertedBinormals=!I.invertedBinormals;I=I.nextBlock;E=0;if(!I){break}}}}I=currentBlock.molecules.length-(currentBlock.isLast?1:0);for(D=0;D<I;D++){for(E=0;E<s+1;E++,y++){d=C[y];G=vec3.lerp([0,0,0],n[D],n[D+1],H[E]);vec3.normalize(G,G);vec3.scaleAndAdd(G,G,d,-vec3.dot(G,d)/vec3.dot(d,d));vec3.normalize(G,G);g.push(G);p=vec3.cross([0,0,0],G,d);vec3.normalize(p,p);A.push(p)}}if(I!=currentBlock.molecules.length){d=C[y];G=[n[D+1][0],n[D+1][1],n[D+1][2]];vec3.normalize(G,G);vec3.scaleAndAdd(G,G,d,-vec3.dot(G,d)/vec3.dot(d,d));vec3.normalize(G,G);g.push(G);p=vec3.cross([0,0,0],G,d);vec3.normalize(p,p);A.push(p);y++}}}}else{y=A.length;x=mat4.create(),identityMatrix=mat4.create();if(y==0){smallest=Number.MAX_VALUE;if(C[0][0]<=smallest){smallest=C[0][0];O=[1,0,0]}if(C[0][1]<=smallest){smallest=C[0][1];O=[0,1,0]}if(C[0][2]<=smallest){smallest=C[0][2];O=[0,0,1]}vec3.cross(z,C[0],O);vec3.normalize(z,z);vec3.cross(O,C[0],z);vec3.cross(B=[0,0,0],C[0],O);A.push([O[0],O[1],O[2]]);g.push([B[0],B[1],B[2]]);y++}else{O=[A[y-1][0],A[y-1][1],A[y-1][2]];B=[g[y-1][0],g[y-1][1],g[y-1][2]]}for(;y<u[M+1];y++){vec3.cross(z,C[y-1],C[y]);if(vec3.length(z)>L){vec3.normalize(z,z);theta=Math.acos(Math.max(-1,Math.min(1,vec3.dot(C[y-1],C[y]))));mat4.rotate(x,identityMatrix,theta,z);vec3.transformMat4(O,O,x)}vec3.cross(B,C[y],O);A.push([O[0],O[1],O[2]]);g.push([B[0],B[1],B[2]])}}}A.push(A[A.length-1]);g.push(g[g.length-1]);y=0;for(M=0;M<chain.twoDcache.length;M++){currentBlock=chain.twoDcache[M];if(chain.displayMode>2){if(currentBlock.sndStruc==2){y=this.buildSheet(u[M],u[M+1],w,C,A,g,h,l,currentBlock.isFirst,currentBlock.isLast);continue}else{if(currentBlock.rocket){if(currentBlock.skip){continue}y=this.buildLoop(u[M],u[M]+currentBlock.rocketPre+(currentBlock.rocketPre?1:0),w,C,A,g,h,l);y=this.buildRocket(u[M]+currentBlock.rocketPre,u[M+1]-currentBlock.rocketPost,w,C,A,g,h,l,currentBlock.isLast);y=this.buildLoop(u[M+1]-currentBlock.rocketPost,u[M+1],w,C,A,g,h,l);continue}else{if(currentBlock.sndStruc==3){if(currentBlock.isFirst){this.buildLoopNcap(u[M],w,C,A,g,h,l);y++;u[M]+=1}y=this.buildHelix(u[M],u[M+1],w,C,A,g,h,l,currentBlock);if(currentBlock.isLast){this.buildLoopCcap(u[M+1]-1,w,C,A,g,h,l)}continue}}}}if(currentBlock.isFirst){this.buildLoopNcap(u[M],w,C,A,g,h,l);y++;u[M]+=1}y=this.buildLoop(u[M],u[M+1],w,C,A,g,h,l);if(currentBlock.isLast){this.buildLoopCcap(u[M+1]-1,w,C,A,g,h,l)}}}};molmil.geometry.buildLoopNcap=function(A,u,n,x,D,q,s){var o=this.dome[0],l=this.radius,J,I=this.ringTemplate;var g=this.buffer3.vertexBuffer,y=this.buffer3.indexBuffer,z=this.buffer3.vP,f=this.buffer3.iP,H,G,F,U,R,Q,O,M,K,d,c,S,L,C,h=this.buffer3.vertexBuffer8,w=z*4;var E=z*0.125;H=u[A][0],G=u[A][1],F=u[A][2],d=n[A][0],c=n[A][1],S=n[A][2],U=x[A][0],R=x[A][1],Q=x[A][2],O=D[A][0],M=D[A][1],K=D[A][2],L=q[A],C=s[A];for(J=0;J<o.vertices.length;J++,w+=32){g[z++]=l*o.vertices[J][0]*U+l*o.vertices[J][1]*O+l*o.vertices[J][2]*d+H;g[z++]=l*o.vertices[J][0]*R+l*o.vertices[J][1]*M+l*o.vertices[J][2]*c+G;g[z++]=l*o.vertices[J][0]*Q+l*o.vertices[J][1]*K+l*o.vertices[J][2]*S+F;g[z++]=o.vertices[J][0]*U+o.vertices[J][1]*O+o.vertices[J][2]*d;g[z++]=o.vertices[J][0]*R+o.vertices[J][1]*M+o.vertices[J][2]*c;g[z++]=o.vertices[J][0]*Q+o.vertices[J][1]*K+o.vertices[J][2]*S;h[w+24]=L[0];h[w+25]=L[1];h[w+26]=L[2];h[w+27]=L[3];z++;g[z++]=s[A]}for(J=0;J<o.faces.length;J++){y[f++]=o.faces[J][0]+E;y[f++]=o.faces[J][1]+E;y[f++]=o.faces[J][2]+E}for(J=0;J<I.length;J++,w+=32){g[z++]=l*I[J][0]*U+l*I[J][1]*O+H;g[z++]=l*I[J][0]*R+l*I[J][1]*M+G;g[z++]=l*I[J][0]*Q+l*I[J][1]*K+F;g[z++]=I[J][0]*U+I[J][1]*O;g[z++]=I[J][0]*R+I[J][1]*M;g[z++]=I[J][0]*Q+I[J][1]*K;h[w+24]=L[0];h[w+25]=L[1];h[w+26]=L[2];h[w+27]=L[3];z++;g[z++]=s[A]}this.buffer3.vP=z;this.buffer3.iP=f};molmil.geometry.buildLoopCcap=function(A,u,n,x,D,q,s){var o=this.dome[1],l=this.radius,J,I=this.ringTemplate;var g=this.buffer3.vertexBuffer,y=this.buffer3.indexBuffer,z=this.buffer3.vP,f=this.buffer3.iP,H,G,F,U,R,Q,O,M,K,d,c,S,L,C,h=this.buffer3.vertexBuffer8,w=z*4;var E=z*0.125;H=u[A][0],G=u[A][1],F=u[A][2],d=n[A][0],c=n[A][1],S=n[A][2],U=x[A][0],R=x[A][1],Q=x[A][2],O=D[A][0],M=D[A][1],K=D[A][2],L=q[A],C=s[A];for(J=0;J<o.vertices.length;J++,w+=32){g[z++]=l*o.vertices[J][0]*U+l*o.vertices[J][1]*O+l*o.vertices[J][2]*d+H;g[z++]=l*o.vertices[J][0]*R+l*o.vertices[J][1]*M+l*o.vertices[J][2]*c+G;g[z++]=l*o.vertices[J][0]*Q+l*o.vertices[J][1]*K+l*o.vertices[J][2]*S+F;g[z++]=o.vertices[J][0]*U+o.vertices[J][1]*O+o.vertices[J][2]*d;g[z++]=o.vertices[J][0]*R+o.vertices[J][1]*M+o.vertices[J][2]*c;g[z++]=o.vertices[J][0]*Q+o.vertices[J][1]*K+o.vertices[J][2]*S;h[w+24]=L[0];h[w+25]=L[1];h[w+26]=L[2];h[w+27]=L[3];z++;g[z++]=C}for(J=0;J<o.faces.length;J++){y[f++]=o.faces[J][0]+E;y[f++]=o.faces[J][1]+E;y[f++]=o.faces[J][2]+E}this.buffer3.vP=z;this.buffer3.iP=f};molmil.geometry.buildLoop=function(D,C,u,n,x,F,q,s){var o=this.dome[0],l=this.radius,L,z=this.novpr;var K=this.ringTemplate,l=this.radius,J,I,H,X,V,U,S,R,O,f,c,W,Q,E;var g=this.buffer3.vertexBuffer,y=this.buffer3.indexBuffer,A=this.buffer3.vP,d=this.buffer3.iP,h=this.buffer3.vertexBuffer8,w=A*4;var G=A*0.125;var M=G-z;for(D;D<C;D++){J=u[D][0],I=u[D][1],H=u[D][2],f=n[D][0],c=n[D][1],W=n[D][2],X=x[D][0],V=x[D][1],U=x[D][2],S=F[D][0],R=F[D][1],O=F[D][2],Q=q[D],E=s[D];for(L=0;L<K.length;L++,w+=32){g[A++]=l*K[L][0]*X+l*K[L][1]*S+J;g[A++]=l*K[L][0]*V+l*K[L][1]*R+I;g[A++]=l*K[L][0]*U+l*K[L][1]*O+H;g[A++]=K[L][0]*X+K[L][1]*S;g[A++]=K[L][0]*V+K[L][1]*R;g[A++]=K[L][0]*U+K[L][1]*O;h[w+24]=Q[0];h[w+25]=Q[1];h[w+26]=Q[2];h[w+27]=Q[3];A++;g[A++]=E}for(L=0;L<(z*2)-2;L+=2,G+=1,M+=1){y[d++]=G;y[d++]=M;y[d++]=M+1;y[d++]=M+1;y[d++]=G+1;y[d++]=G}y[d++]=G;y[d++]=M;y[d++]=M-(z-1);y[d++]=M-(z-1);y[d++]=G-(z-1);y[d++]=G;G++;M++}this.buffer3.vP=A;this.buffer3.iP=d;return D};molmil.geometry.buildRocket=function(S,ab,n,l,q,F,W,I,aa){var U=1.15,X,d=this.novpr,x=false;var J=this.ringTemplate,M,L,K,D,C,A,u,s,o,H,G,E,f,c;var y=this.buffer3.vertexBuffer,w=this.buffer3.indexBuffer,Q=this.buffer3.vP,Y=this.buffer3.iP,z=this.buffer3.vertexBuffer8,O=Q*4;var V=Q*0.125;var g=V-d;var R=Q;M=n[S][0],L=n[S][1],K=n[S][2],H=l[S][0],G=l[S][1],E=l[S][2],D=q[S][0],C=q[S][1],A=q[S][2],u=F[S][0],s=F[S][1],o=F[S][2],f=W[S],c=I[S];y[Q++]=M;y[Q++]=L;y[Q++]=K;y[Q++]=-H;y[Q++]=-G;y[Q++]=-E;z[O+24]=f[0];z[O+25]=f[1];z[O+26]=f[2];z[O+27]=f[3];Q++;y[Q++]=c;O+=32;for(X=0;X<J.length;X++,O+=32){y[Q++]=U*J[X][0]*D+U*J[X][1]*u+M;y[Q++]=U*J[X][0]*C+U*J[X][1]*s+L;y[Q++]=U*J[X][0]*A+U*J[X][1]*o+K;y[Q++]=-H;y[Q++]=-G;y[Q++]=-E;z[O+24]=f[0];z[O+25]=f[1];z[O+26]=f[2];z[O+27]=f[3];Q++;y[Q++]=c}for(X=0;X<J.length;X++){w[Y++]=V+X+2;w[Y++]=V+X+1;w[Y++]=V}w[Y-3]=V+1;V+=J.length+1;g=V-d;for(S;S<ab;S++){M=n[S][0],L=n[S][1],K=n[S][2],H=l[S][0],G=l[S][1],E=l[S][2],D=q[S][0],C=q[S][1],A=q[S][2],u=F[S][0],s=F[S][1],o=F[S][2],f=W[S],c=I[S];for(X=0;X<J.length;X++,O+=32){y[Q++]=U*J[X][0]*D+U*J[X][1]*u+M;y[Q++]=U*J[X][0]*C+U*J[X][1]*s+L;y[Q++]=U*J[X][0]*A+U*J[X][1]*o+K;y[Q++]=J[X][0]*D+J[X][1]*u;y[Q++]=J[X][0]*C+J[X][1]*s;y[Q++]=J[X][0]*A+J[X][1]*o;z[O+24]=f[0];z[O+25]=f[1];z[O+26]=f[2];z[O+27]=f[3];Q++;y[Q++]=c}for(X=0;X<(d*2)-2;X+=2,V+=1,g+=1){w[Y++]=V+d;w[Y++]=g+d;w[Y++]=g+1+d;w[Y++]=g+1+d;w[Y++]=V+1+d;w[Y++]=V+d}w[Y++]=V+d;w[Y++]=g+d;w[Y++]=g-(d-1)+d;w[Y++]=g-(d-1)+d;w[Y++]=V-(d-1)+d;w[Y++]=V+d;V++;g++}for(X=Q-(J.length*8);X<Q;X+=8){y[X]-=H*2;y[X+1]-=G*2;y[X+2]-=E*2}for(X=0;X<J.length;X++,O+=32){y[Q++]=U*J[X][0]*D+U*J[X][1]*u+M-H*2;y[Q++]=U*J[X][0]*C+U*J[X][1]*s+L-G*2;y[Q++]=U*J[X][0]*A+U*J[X][1]*o+K-E*2;y[Q++]=J[X][0]*D+J[X][1]*u;y[Q++]=J[X][0]*C+J[X][1]*s;y[Q++]=J[X][0]*A+J[X][1]*o;z[O+24]=f[0];z[O+25]=f[1];z[O+26]=f[2];z[O+27]=f[3];Q++;y[Q++]=c}y[Q++]=M;y[Q++]=L;y[Q++]=K;y[Q++]=H;y[Q++]=G;y[Q++]=E;z[O+24]=f[0];z[O+25]=f[1];z[O+26]=f[2];z[O+27]=f[3];Q++;O+=32;y[Q++]=c;for(X=0;X<J.length;X++){w[Y++]=V+J.length;w[Y++]=V+X;w[Y++]=V+X+1}w[Y-1]=V;V+=J.length+1;g=V-d;U=this.radius;if(!aa){var Z=this.radius;for(X=0;X<J.length;X++,O+=32){y[Q++]=Z*J[X][0]*D+Z*J[X][1]*u+M-H*U*2;y[Q++]=Z*J[X][0]*C+Z*J[X][1]*s+L-G*U*2;y[Q++]=Z*J[X][0]*A+Z*J[X][1]*o+K-E*U*2;y[Q++]=J[X][0]*D+J[X][1]*u;y[Q++]=J[X][0]*C+J[X][1]*s;y[Q++]=J[X][0]*A+J[X][1]*o;z[O+24]=f[0];z[O+25]=f[1];z[O+26]=f[2];z[O+27]=f[3];Q++;y[Q++]=c}}this.buffer3.vP=Q;this.buffer3.iP=Y;return S};molmil.geometry.buildHelix=function(Y,aj,o,l,s,F,ae,L,W){var M=this.dome[0],Z=this.radius,ag,d=this.novpr;var O=this.ringTemplate,Z=this.radius,S,R,Q,D,C,A,w,u,q,H,G,E,g,c;var y=this.buffer3.vertexBuffer,x=this.buffer3.indexBuffer,V=this.buffer3.vP,ah=this.buffer3.iP,z=this.buffer3.vertexBuffer8,U=V*4;var ac=V*0.125;var h=ac-d;var af,X,f;var I=W.invertedBinormals,K=W.Nresume,J=W.Cresume;var ab=[0,0],ai=this.noi,aa=Y,ad=K?ai:0;for(Y;Y<aj;Y++){S=o[Y][0],R=o[Y][1],Q=o[Y][2],H=l[Y][0],G=l[Y][1],E=l[Y][2],D=s[Y][0],C=s[Y][1],A=s[Y][2],w=F[Y][0],u=F[Y][1],q=F[Y][2],g=ae[Y],c=L[Y];if(!K&&Y<aa+ai){af=(ad/ai);ad++}else{if(!J&&Y>aj-ai-2){af=(ad/(ai));ad--}else{af=1}}X=(5*af)+1;f=1/X;for(ag=0;ag<O.length;ag++,U+=32){y[V++]=Z*O[ag][0]*D+X*Z*O[ag][1]*w+S;y[V++]=Z*O[ag][0]*C+X*Z*O[ag][1]*u+R;y[V++]=Z*O[ag][0]*A+X*Z*O[ag][1]*q+Q;ab[0]=O[ag][0];ab[1]=f*O[ag][1];vec2.normalize(ab,ab);y[V++]=ab[0]*D+ab[1]*w;y[V++]=ab[0]*C+ab[1]*u;y[V++]=ab[0]*A+ab[1]*q;if(af>0.5&&((I&&y[V-3]*D+y[V-2]*C+y[V-1]*A<-0.01)||(!I&&y[V-3]*D+y[V-2]*C+y[V-1]*A>0.01))){z[U+24]=255;z[U+25]=255;z[U+26]=255;z[U+27]=255}else{z[U+24]=g[0];z[U+25]=g[1];z[U+26]=g[2];z[U+27]=g[3]}V++;y[V++]=c}for(ag=0;ag<(d*2)-2;ag+=2,ac+=1,h+=1){x[ah++]=ac;x[ah++]=h;x[ah++]=h+1;x[ah++]=h+1;x[ah++]=ac+1;x[ah++]=ac}x[ah++]=ac;x[ah++]=h;x[ah++]=h-(d-1);x[ah++]=h-(d-1);x[ah++]=ac-(d-1);x[ah++]=ac;ac++;h++}this.buffer3.vP=V;this.buffer3.iP=ah;return Y};molmil.geometry.buildSheet=function(aa,ak,s,o,x,I,ae,M,Q,aj){var O=this.dome[0],ab=this.radius,af,d=this.novpr;var R=this.ringTemplate,ab=this.radius,V,U,S,G,F,E,z,y,u,K,J,H,f,c;var C=this.buffer3.vertexBuffer,A=this.buffer3.indexBuffer,X=this.buffer3.vP,ag=this.buffer3.iP,D=this.buffer3.vertexBuffer8,W=X*4;var ac=X*0.125;var l=ac-d;var Z=this.squareVertices,ai=this.noi,L=this.squareVerticesN;var ah=this.sheetHeight,Y=ah*8;if(!Q){V=(s[aa][0]*0.75)+(s[aa+1][0]*0.25),U=(s[aa][1]*0.75)+(s[aa][1]*0.25),S=(s[aa][2]*0.75)+(s[aa][2]*0.25),K=o[aa-1][0],J=o[aa-1][1],H=o[aa-1][2],G=x[aa-1][0],F=x[aa-1][1],E=x[aa-1][2],z=I[aa-1][0],y=I[aa-1][1],u=I[aa-1][2],f=ae[aa-1],c=M[aa];for(af=0;af<R.length;af++,W+=32){C[X++]=ah*0.5*R[af][0]*G+ah*0.5*R[af][1]*z+V;C[X++]=ah*0.5*R[af][0]*F+ah*0.5*R[af][1]*y+U;C[X++]=ah*0.5*R[af][0]*E+ah*0.5*R[af][1]*u+S;C[X++]=((R[af][0]*G+R[af][1]*z)+K)*0.5;C[X++]=((R[af][0]*F+R[af][1]*y)+J)*0.5;C[X++]=((R[af][0]*E+R[af][1]*u)+H)*0.5;D[W+24]=f[0];D[W+25]=f[1];D[W+26]=f[2];D[W+27]=f[3];X++;C[X++]=M[aa-1]}for(af=0;af<(d*2)-2;af+=2,ac+=1,l+=1){A[ag++]=ac;A[ag++]=l;A[ag++]=l+1;A[ag++]=l+1;A[ag++]=ac+1;A[ag++]=ac}A[ag++]=ac;A[ag++]=l;A[ag++]=l-(d-1);A[ag++]=l-(d-1);A[ag++]=ac-(d-1);A[ag++]=ac;ac++;l++}V=s[aa][0],U=s[aa][1],S=s[aa][2],K=o[aa][0],J=o[aa][1],H=o[aa][2],G=x[aa][0],F=x[aa][1],E=x[aa][2],z=I[aa][0],y=I[aa][1],u=I[aa][2],f=ae[aa],c=M[aa];for(af=0;af<4;af++,W+=32){C[X++]=ah*Z[af][0]*G+Y*Z[af][1]*z+V;C[X++]=ah*Z[af][0]*F+Y*Z[af][1]*y+U;C[X++]=ah*Z[af][0]*E+Y*Z[af][1]*u+S;C[X++]=-K;C[X++]=-J;C[X++]=-H;D[W+24]=255;D[W+25]=255;D[W+26]=255;D[W+27]=255;X++;C[X++]=c}A[ag++]=ac;A[ag++]=ac+1;A[ag++]=ac+2;A[ag++]=ac;A[ag++]=ac+2;A[ag++]=ac+3;ac+=4;var q=Math.ceil(ai/1.5);var g=(ah*12)/q;q=ak-q;var ad=0;for(aa;aa<q;aa++,ad++){V=s[aa][0],U=s[aa][1],S=s[aa][2],K=o[aa][0],J=o[aa][1],H=o[aa][2],G=x[aa][0],F=x[aa][1],E=x[aa][2],z=I[aa][0],y=I[aa][1],u=I[aa][2],f=ae[aa],c=M[aa];for(af=0;af<4;af++,W+=32){C[X++]=ah*Z[af][0]*G+Y*Z[af][1]*z+V;C[X++]=ah*Z[af][0]*F+Y*Z[af][1]*y+U;C[X++]=ah*Z[af][0]*E+Y*Z[af][1]*u+S;C[X++]=L[af][0]*G+L[af][1]*z;C[X++]=L[af][0]*F+L[af][1]*y;C[X++]=L[af][0]*E+L[af][1]*u;if(af==1||af==3){D[W+24]=255;D[W+25]=255;D[W+26]=255;D[W+27]=255}else{D[W+24]=f[0];D[W+25]=f[1];D[W+26]=f[2];D[W+27]=f[3]}X++;C[X++]=c;W+=32;C[X++]=ah*Z[af][0]*G+Y*Z[af][1]*z+V;C[X++]=ah*Z[af][0]*F+Y*Z[af][1]*y+U;C[X++]=ah*Z[af][0]*E+Y*Z[af][1]*u+S;C[X++]=L[af+1][0]*G+L[af+1][1]*z;C[X++]=L[af+1][0]*F+L[af+1][1]*y;C[X++]=L[af+1][0]*E+L[af+1][1]*u;if(af==0||af==2){D[W+24]=255;D[W+25]=255;D[W+26]=255;D[W+27]=255}else{D[W+24]=f[0];D[W+25]=f[1];D[W+26]=f[2];D[W+27]=f[3]}X++;C[X++]=c}if(ad>0){A[ag++]=ac-8;A[ag++]=ac-1;A[ag++]=ac+7;A[ag++]=ac-8;A[ag++]=ac+7;A[ag++]=ac+0;A[ag++]=ac-7;A[ag++]=ac+1;A[ag++]=ac+2;A[ag++]=ac-7;A[ag++]=ac+2;A[ag++]=ac-6;A[ag++]=ac-5;A[ag++]=ac+3;A[ag++]=ac+4;A[ag++]=ac-5;A[ag++]=ac+4;A[ag++]=ac-4;A[ag++]=ac-2;A[ag++]=ac-3;A[ag++]=ac+5;A[ag++]=ac-2;A[ag++]=ac+5;A[ag++]=ac+6}ac+=8}Y=ah*12;aa--;for(;aa<ak;aa++,ad++){if(aa>=q){Y-=g}V=s[aa][0],U=s[aa][1],S=s[aa][2],K=o[aa][0],J=o[aa][1],H=o[aa][2],G=x[aa][0],F=x[aa][1],E=x[aa][2],z=I[aa][0],y=I[aa][1],u=I[aa][2],f=ae[aa],c=M[aa];for(af=0;af<4;af++,W+=32){C[X++]=ah*Z[af][0]*G+Y*Z[af][1]*z+V;C[X++]=ah*Z[af][0]*F+Y*Z[af][1]*y+U;C[X++]=ah*Z[af][0]*E+Y*Z[af][1]*u+S;C[X++]=L[af][0]*G+L[af][1]*z;C[X++]=L[af][0]*F+L[af][1]*y;C[X++]=L[af][0]*E+L[af][1]*u;if(af==1||af==3){D[W+24]=255;D[W+25]=255;D[W+26]=255;D[W+27]=255}else{D[W+24]=f[0];D[W+25]=f[1];D[W+26]=f[2];D[W+27]=f[3]}X++;W+=32;C[X++]=c;C[X++]=ah*Z[af][0]*G+Y*Z[af][1]*z+V;C[X++]=ah*Z[af][0]*F+Y*Z[af][1]*y+U;C[X++]=ah*Z[af][0]*E+Y*Z[af][1]*u+S;C[X++]=L[af+1][0]*G+L[af+1][1]*z;C[X++]=L[af+1][0]*F+L[af+1][1]*y;C[X++]=L[af+1][0]*E+L[af+1][1]*u;if(af==0||af==2){D[W+24]=255;D[W+25]=255;D[W+26]=255;D[W+27]=255}else{D[W+24]=f[0];D[W+25]=f[1];D[W+26]=f[2];D[W+27]=f[3]}X++;C[X++]=c}if(ad>0){A[ag++]=ac-8;A[ag++]=ac-1;A[ag++]=ac+7;A[ag++]=ac-8;A[ag++]=ac+7;A[ag++]=ac+0;A[ag++]=ac-7;A[ag++]=ac+1;A[ag++]=ac+2;A[ag++]=ac-7;A[ag++]=ac+2;A[ag++]=ac-6;A[ag++]=ac-5;A[ag++]=ac+3;A[ag++]=ac+4;A[ag++]=ac-5;A[ag++]=ac+4;A[ag++]=ac-4;A[ag++]=ac-2;A[ag++]=ac-3;A[ag++]=ac+5;A[ag++]=ac-2;A[ag++]=ac+5;A[ag++]=ac+6}ac+=8}if(!aj){K=o[aa][0],J=o[aa][1],H=o[aa][2],G=x[aa][0],F=x[aa][1],E=x[aa][2],z=I[aa][0],y=I[aa][1],u=I[aa][2],f=ae[aa],c=M[aa];for(af=0;af<R.length;af++,W+=32){C[X++]=V;C[X++]=U;C[X++]=S;C[X++]=-K;C[X++]=-J;C[X++]=-H;D[W+24]=f[0];D[W+25]=f[1];D[W+26]=f[2];D[W+27]=f[3];X++;C[X++]=M[aa]}ac+=R.length;for(af=0;af<R.length;af++,W+=32){C[X++]=ah*R[af][0]*G+ah*R[af][1]*z+V;C[X++]=ah*R[af][0]*F+ah*R[af][1]*y+U;C[X++]=ah*R[af][0]*E+ah*R[af][1]*u+S;C[X++]=((R[af][0]*G+R[af][1]*z)-K)*0.5;C[X++]=((R[af][0]*F+R[af][1]*y)-J)*0.5;C[X++]=((R[af][0]*E+R[af][1]*u)-H)*0.5;D[W+24]=f[0];D[W+25]=f[1];D[W+26]=f[2];D[W+27]=f[3];X++;C[X++]=M[aa]}l=ac-d;for(af=0;af<(d*2)-2;af+=2,ac+=1,l+=1){A[ag++]=ac;A[ag++]=l;A[ag++]=l+1;A[ag++]=l+1;A[ag++]=ac+1;A[ag++]=ac}A[ag++]=ac;A[ag++]=l;A[ag++]=l-(d-1);A[ag++]=l-(d-1);A[ag++]=ac-(d-1);A[ag++]=ac;ac++;l++}this.buffer3.vP=X;this.buffer3.iP=ag;return aa};molmil.priestle_smoothing=function(o,h,l,n,g){var p,d=l-h,c=new Array(d),f=new Array(d);for(m=0;m<d;m++){c[m]=[0,0,0]}for(p=0;p<g;p++){for(m=1;m<d-1;m++){c[m][0]=(o[h+m-1][0]+o[h+m+1][0])*0.5;c[m][1]=(o[h+m-1][1]+o[h+m+1][1])*0.5;c[m][2]=(o[h+m-1][2]+o[h+m+1][2])*0.5;c[m][0]=(c[m][0]+o[h+m][0])*0.5;c[m][1]=(c[m][1]+o[h+m][1])*0.5;c[m][2]=(c[m][2]+o[h+m][2])*0.5}for(m=1;m<d-1;m++){if(!n.hasOwnProperty(m)){o[h+m][0]=c[m][0];o[h+m][1]=c[m][1];o[h+m][2]=c[m][2]}}}};var numeric=(typeof exports==="undefined")?(function numeric(){}):(exports);if(typeof global!=="undefined"){global.numeric=numeric}numeric.version="1.2.6";numeric.dotMMsmall=function(B,A){var s,n,h,f,d,c,u,z,t,o,l,w,C,g;f=B.length;d=A.length;c=A[0].length;u=Array(f);for(s=f-1;s>=0;s--){z=Array(c);t=B[s];for(h=c-1;h>=0;h--){o=t[d-1]*A[d-1][h];for(n=d-2;n>=1;n-=2){l=n-1;o+=t[n]*A[n][h]+t[l]*A[l][h]}if(n===0){o+=t[0]*A[0][h]}z[h]=o}u[s]=z}return u};numeric._getCol=function(d,f,c){var h=d.length,g;for(g=h-1;g>0;--g){c[g]=d[g][f];--g;c[g]=d[g][f]}if(g===0){c[0]=d[0][f]}};numeric.dotMMbig=function(w,u){var B=numeric._getCol,c=u.length,C=Array(c);var g=w.length,f=u[0].length,d=new Array(g),s;var l=numeric.dotVV;var q,o,h,t;--c;--g;for(q=g;q!==-1;--q){d[q]=Array(f)}--f;for(q=f;q!==-1;--q){B(u,q,C);for(o=g;o!==-1;--o){t=0;s=w[o];d[o][q]=l(s,C)}}return d};numeric.dotMV=function(c,n){var h=c.length,g=n.length,f;var d=Array(h),l=numeric.dotVV;for(f=h-1;f>=0;f--){d[f]=l(c[f],n)}return d};numeric.dotVM=function(o,n){var C,B,A,u,t,s,H,F,E,h,z,l,f,D,g,d,c,w,G;u=o.length;t=n[0].length;H=Array(t);for(A=t-1;A>=0;A--){h=o[u-1]*n[u-1][A];for(B=u-2;B>=1;B-=2){z=B-1;h+=o[B]*n[B][A]+o[z]*n[z][A]}if(B===0){h+=o[0]*n[0][A]}H[A]=h}return H};numeric.dotVV=function(c,l){var f,h=c.length,g,d=c[h-1]*l[h-1];for(f=h-2;f>=1;f-=2){g=f-1;d+=c[f]*l[f]+c[g]*l[g]}if(f===0){d+=c[0]*l[0]}return d};numeric.dot=function(c,g){var f=numeric.dim;switch(f(c).length*1000+f(g).length){case 2002:if(g.length<10){return numeric.dotMMsmall(c,g)}else{return numeric.dotMMbig(c,g)}case 2001:return numeric.dotMV(c,g);case 1002:return numeric.dotVM(c,g);case 1001:return numeric.dotVV(c,g);case 1000:return numeric.mulVS(c,g);case 1:return numeric.mulSV(c,g);case 0:return c*g;default:throw new Error("numeric.dot only works on vectors and matrices")}};numeric.dim=function(c){var f,d;if(typeof c==="object"){f=c[0];if(typeof f==="object"){d=f[0];if(typeof d==="object"){return numeric._dim(c)}return[c.length,f.length]}return[c.length]}return[]};numeric.transpose=function(q){var o,h,f=q.length,c=q[0].length,p=Array(c),g,d,l;for(h=0;h<c;h++){p[h]=Array(f)}for(o=f-1;o>=1;o-=2){d=q[o];g=q[o-1];for(h=c-1;h>=1;--h){l=p[h];l[o]=d[h];l[o-1]=g[h];--h;l=p[h];l[o]=d[h];l[o-1]=g[h]}if(h===0){l=p[0];l[o]=d[0];l[o-1]=g[0]}}if(o===0){g=q[0];for(h=c-1;h>=1;--h){p[h][0]=g[h];--h;p[h][0]=g[h]}if(h===0){p[0][0]=g[0]}}return p};numeric.inv=function(t){var B=numeric.dim(t),C=Math.abs,g=B[0],f=B[1];var d=numeric.clone(t),w,q;var u=numeric.identity(g),c,z;var p,o,h,t;for(o=0;o<f;++o){var l=-1;var y=-1;for(p=o;p!==g;++p){h=C(d[p][o]);if(h>y){l=p;y=h}}q=d[l];d[l]=d[o];d[o]=q;z=u[l];u[l]=u[o];u[o]=z;t=q[o];for(h=o;h!==f;++h){q[h]/=t}for(h=f-1;h!==-1;--h){z[h]/=t}for(p=g-1;p!==-1;--p){if(p!==o){w=d[p];c=u[p];t=w[o];for(h=o+1;h!==f;++h){w[h]-=q[h]*t}for(h=f-1;h>0;--h){c[h]-=z[h]*t;--h;c[h]-=z[h]*t}if(h===0){c[0]-=z[0]*t}}}}return u};numeric.sclone=numeric.clone=function(c,d,h){if(typeof d==="undefined"){d=0}if(typeof h==="undefined"){h=numeric.dim(c).length}var g,f=Array(c.length);if(d===h-1){for(g in c){if(c.hasOwnProperty(g)){f[g]=c[g]}}return f}for(g in c){if(c.hasOwnProperty(g)){f[g]=numeric.clone(c[g],d+1,h)}}return f};numeric.identity=function(c){return numeric.diag(numeric.rep([c],1))};numeric.diag=function(o){var h,l,g,p=o.length,c=Array(p),f;for(h=p-1;h>=0;h--){f=Array(p);l=h+2;for(g=p-1;g>=l;g-=2){f[g]=0;f[g-1]=0}if(g>h){f[g]=0}f[h]=o[h];for(g=h-1;g>=1;g-=2){f[g]=0;f[g-1]=0}if(g===0){f[0]=0}c[h]=f}return c};numeric.rep=function(h,d,c){if(typeof c==="undefined"){c=0}var l=h[c],f=Array(l),g;if(c===h.length-1){for(g=l-2;g>=0;g-=2){f[g+1]=d;f[g]=d}if(g===-1){f[0]=d}return f}for(g=l-1;g>=0;g--){f[g]=numeric.rep(h,d,c+1)}return f};molmil.polynomialFit=function(t,s,d){var w=[],u,h,g;var q=numeric.transpose([s]);for(g=0;g<t.length;g++){u=[1];for(h=1;h<=d;h++){u.push(u[h-1]*t[g])}w.push(u)}var o=numeric.transpose(w);var n=numeric.dot(o,w);var c=numeric.inv(n);var l=numeric.dot(o,q);var p=numeric.dot(c,l);var f=[];for(h=0;h<p.length;h++){f.push(p[h][0])}return f};molmil.polynomialCalc=function(c,f){var d,g=f[0];for(d=1;d<f.length;d++){g+=f[d]*Math.pow(c,d)}return g};molmil.prepare2DRepr=function(Z,E){if(Z.modelsXYZ.length<=E){E=0}var f=32*Math.PI/180,d=-11*Math.PI/180,C=Math.cos(f),K=Math.sin(f),B=Math.cos(d),I=Math.sin(d),Y=4.7,g=0.5,u=5.2,ac,ab=[0,0,0],h=[0,0,0],W=[0,0,0],T=[0,0,0],D=molmil.configBox.smoothFactor,t;if(Z.molecules.length<2||Z.isHet){return Z.displayMode=0}var q=Z.twoDcache=[],O,Q,G,aa,N=Z.molecules.length,X,U,S,R,F,l=[],M,o,A;for(O=0;O<N;O++){if(!Z.molecules[O].CA){continue}if(Z.molecules[O].sndStruc!=Q||Z.molecules[O].previous==null){Q=Z.molecules[O].sndStruc;q.push(G={molecules:[],xyz:[],sndStruc:Q})}G.molecules.push(Z.molecules[O]);X=Z.molecules[O].CA.xyz;U=[Z.modelsXYZ[E][X],Z.modelsXYZ[E][X+1],Z.modelsXYZ[E][X+2]];G.xyz.push(U);l.push(U)}N=l.length;for(aa=0,M=0;aa<q.length;aa++){G=q[aa];if(G.molecules[0].xna){G.sndStruc=molmil.displayMode_XNA}G.isFirst=G.molecules[0].previous==null||G.molecules[0].previous.name=="ACE"||!G.molecules[0].previous.CA;G.isLast=G.molecules[G.molecules.length-1].next==null||G.molecules[G.molecules.length-1].next.name=="NME"||!G.molecules[G.molecules.length-1].next.CA;if(G.sndStruc==3){if(G.molecules.length>2){G.waypoints=[];G.waypoint_tangents=[];var w=[],L=[],J=[],H=[],s=Math.floor(G.molecules.length/8);if(s>5){s=5}else{if(s<1){s=1}}if(!G.isFirst){w.push(-(Math.sqrt(Math.pow(l[M-1][0]-l[M][0],2)+Math.pow(l[M-1][1]-l[M][1],2)+Math.pow(l[M-1][2]-l[M][2],2))));L.push(l[M-1][0]);J.push(l[M-1][1]);H.push(l[M-1][2])}for(X=0;X<G.molecules.length;X++){if(G.molecules[X].displayMode==31){G.rocket=true}if(X>0){w.push(w[w.length-1]+Math.sqrt(Math.pow(l[M+X][0]-l[M+X-1][0],2)+Math.pow(l[M+X][1]-l[M+X-1][1],2)+Math.pow(l[M+X][2]-l[M+X-1][2],2)))}else{w.push(0)}L.push(l[M+X][0]);J.push(l[M+X][1]);H.push(l[M+X][2])}if(!G.isLast){w.push(w[X-1]+Math.sqrt(Math.pow(l[M+X-1][0]-l[M+X][0],2)+Math.pow(l[M+X-1][1]-l[M+X][1],2)+Math.pow(l[M+X-1][2]-l[M+X][2],2)));L.push(l[M+X][0]);J.push(l[M+X][1]);H.push(l[M+X][2])}L=molmil.polynomialFit(w,L,s);J=molmil.polynomialFit(w,J,s);H=molmil.polynomialFit(w,H,s);var P=Math.round(G.molecules.length/2);if(P<2){P=2}if(molmil.configBox.liteMode){P=2}var p=(w[w.length-1]-6)/(P-1),c=3;for(X=0;X<P;X++){G.waypoints.push([molmil.polynomialCalc(c,L),molmil.polynomialCalc(c,J),molmil.polynomialCalc(c,H)]);c+=p}G.waypoint_tangents.push([G.waypoints[1][0]-G.waypoints[0][0],G.waypoints[1][1]-G.waypoints[0][1],G.waypoints[1][2]-G.waypoints[0][2]]);for(X=1;X<G.waypoints.length-1;X++){G.waypoint_tangents.push([G.waypoints[X+1][0]-G.waypoints[X-1][0],G.waypoints[X+1][1]-G.waypoints[X-1][1],G.waypoints[X+1][2]-G.waypoints[X-1][2]])}X=G.waypoints.length-1;G.waypoint_tangents.push([G.waypoints[X][0]-G.waypoints[X-1][0],G.waypoints[X][1]-G.waypoints[X-1][1],G.waypoints[X][2]-G.waypoints[X-1][2]]);for(X=0;X<G.waypoint_tangents.length;X++){vec3.normalize(G.waypoint_tangents[X],G.waypoint_tangents[X])}if(vec3.distance(G.waypoints[0],G.waypoints[G.waypoints.length-1])<2){G.rocket=false;G.sndStruc=1}if(G.rocket){l[M]=G.waypoints[0];l[M+G.molecules.length-1]=G.waypoints[G.waypoints.length-1]}}else{G.sndStruc=1}}M+=G.molecules.length}for(aa=0,M=0;aa<q.length;aa++){G=q[aa];if(G.molecules.length<3){G.sndStruc=1}if(G.sndStruc!=3&&G.sndStruc!=4&&G.sndStruc!=molmil.displayMode_XNA){if(G.sndStruc==2){G.normals=[[]],F=null;for(O=1;O<G.molecules.length-1;O++){F=vec3.add([0,0,0],G.xyz[O-1],G.xyz[O+1]);F[0]/=2;F[1]/=2;F[2]/=2;vec3.subtract(F,G.xyz[O],F);vec3.normalize(F,F);if(O>1&&vec3.dot(G.normals[O-1],F)<0){vec3.negate(F,F)}G.normals.push(F)}if(F==null){if(!G.isFirst&&!G.isLast){X=q[aa-1].xyz[q[aa-1].xyz.length-1];U=G.xyz[0];S=q[aa+1].xyz[0];F=vec3.add([0,0,0],X,S);F[0]/=2;F[1]/=2;F[2]/=2;vec3.subtract(F,U,F);vec3.normalize(F,F);W[0]=S[0]-U[0];W[1]=S[1]-U[1];W[2]=S[2]-U[2];vec3.normalize(W,W);vec3.cross(T,W,F);vec3.cross(F,T,W);G.normals.push(F)}else{F=[0,0,0];G.normals.push(F)}}else{G.normals.push(F)}while(G.normals.length<G.molecules.length){G.normals.push(F)}G.normals[0]=G.normals[1];G.normals[G.normals.length-1]=G.normals[G.normals.length-2];o=new Array(G.normals.length);for(X=0;X<2;X++){for(O=1;O<G.molecules.length-1;O++){o[O]=[G.normals[O-1][0]+G.normals[O][0]+G.normals[O+1][0],G.normals[O-1][1]+G.normals[O][1]+G.normals[O+1][1],G.normals[O-1][2]+G.normals[O][2]+G.normals[O+1][2]];vec3.normalize(o[O],o[O])}for(O=1;O<G.molecules.length-1;O++){G.normals[O]=o[O]}G.normals[0]=G.normals[1];G.normals[G.normals.length-1]=G.normals[G.normals.length-2]}for(O=0;O<G.molecules.length-1;O++){W[0]=G.xyz[O+1][0]-G.xyz[O][0];W[1]=G.xyz[O+1][1]-G.xyz[O][1];W[2]=G.xyz[O+1][2]-G.xyz[O][2];vec3.cross(T,W,G.normals[O]);vec3.cross(G.normals[O],T,W);vec3.normalize(G.normals[O],G.normals[O])}G.normals.push(G.normals[G.normals.length-1])}if(D>0){t={};for(O=0;O<G.molecules.length;O++){if(G.molecules[O].showSC){t[O+(G.isFirst?0:1)]=true}}if(!G.isLast&&q[aa+1].molecules[0].showSC){t[G.molecules.length]=true}molmil.priestle_smoothing(l,M-(G.isFirst?0:1),M+G.molecules.length+(G.isLast?0:1),t,D)}}M+=G.molecules.length}for(aa=0,M=0;aa<q.length;aa++){G=q[aa];G.tangents=new Array(G.molecules.length+1);for(O=0;O<G.molecules.length+1;O++){G.tangents[O]=[0,0,0]}if((G.sndStruc==3||G.sndStruc==4)&&G.molecules.length<3){G.sndStruc=1}if(G.molecules[0].xna){ac=u}else{ac=Y}if(G.sndStruc==molmil.displayMode_XNA){O=0;if(O+M<1){U=l[0];R=l[2]}else{if(O+M==N-1){U=l[O+M-1];R=l[O+M]}else{if(O+M<N-1){U=l[O+M-1];R=l[O+M+1]}}}W[0]=R[0]-U[0];W[1]=R[1]-U[1];W[2]=R[2]-U[2];vec3.normalize(W,W);G.tangents[0]=[W[0]*ac,W[1]*ac,W[2]*ac];F=G.molecules.length-(aa==q.length-1);for(O=1;O<F;O++){U=l[O+M-1];S=l[O+M];R=l[O+M+1];G.tangents[O][0]=R[0]-U[0];G.tangents[O][1]=R[1]-U[1];G.tangents[O][2]=R[2]-U[2];vec3.normalize(G.tangents[O],G.tangents[O]);G.tangents[O][0]*=ac;G.tangents[O][1]*=ac;G.tangents[O][2]*=ac}if(O+M<1){U=l[0];R=l[2]}else{if(O+M==N-1){U=l[O+M-1];R=l[O+M]}else{if(O+M<N-1){U=l[O+M-1];R=l[O+M+1]}}}W[0]=R[0]-U[0];W[1]=R[1]-U[1];W[2]=R[2]-U[2];vec3.normalize(W,W);G.tangents[G.tangents.length-1]=[W[0]*ac,W[1]*ac,W[2]*ac];if(F!=G.molecules.length&&G.molecules.length>2){G.tangents[G.tangents.length-2]=G.tangents[G.tangents.length-1]}}else{if(G.sndStruc==3||G.sndStruc==4){G.binormals=new Array(G.molecules.length+1);O=0;if(O+M<1){U=l[0];R=l[2]}else{if(O+M==N-1){U=l[O+M-1];R=l[O+M]}else{if(O+M<N-1){U=l[O+M-1];R=l[O+M+1]}}}W[0]=R[0]-U[0];W[1]=R[1]-U[1];W[2]=R[2]-U[2];vec3.normalize(W,W);G.tangents[0]=[W[0]*ac,W[1]*ac,W[2]*ac];F=G.molecules.length-(aa==q.length-1);for(O=1;O<F;O++){U=l[O+M-1];S=l[O+M];R=l[O+M+1];G.tangents[O][0]=R[0]-U[0];G.tangents[O][1]=R[1]-U[1];G.tangents[O][2]=R[2]-U[2];ab[0]=R[0]-U[0];ab[1]=R[1]-U[1];ab[2]=R[2]-U[2];vec3.normalize(ab,ab);W[0]=S[0]-U[0];W[1]=S[1]-U[1];W[2]=S[2]-U[2];T[0]=R[0]-S[0];T[1]=R[1]-S[1];T[2]=R[2]-S[2];vec3.cross(h,W,T);vec3.normalize(h,h);W[0]=C*h[0];W[1]=C*h[1];W[2]=C*h[2];T[0]=K*ab[0];T[1]=K*ab[1];T[2]=K*ab[2];G.binormals[O]=[W[0]+T[0],W[1]+T[1],W[2]+T[2]];W[0]=B*ab[0];W[1]=B*ab[1];W[2]=B*ab[2];T[0]=I*h[0];T[1]=I*h[1];T[2]=I*h[2];G.tangents[O][0]=(W[0]+T[0])*ac;G.tangents[O][1]=(W[1]+T[1])*ac;G.tangents[O][2]=(W[2]+T[2])*ac;vec3.cross(W,G.binormals[O],G.tangents[O]);vec3.cross(G.binormals[O],G.tangents[O],W);vec3.normalize(G.binormals[O],G.binormals[O])}if(O+M<1){U=l[0];R=l[2]}else{if(O+M==N-1){U=l[O+M-1];R=l[O+M]}else{if(O+M<N-1){U=l[O+M-1];R=l[O+M+1]}}}W[0]=R[0]-U[0];W[1]=R[1]-U[1];W[2]=R[2]-U[2];vec3.normalize(W,W);G.tangents[G.tangents.length-1]=[W[0]*ac,W[1]*ac,W[2]*ac];if(F!=G.molecules.length){G.tangents[G.tangents.length-2]=G.tangents[G.tangents.length-1];W=G.binormals[G.binormals.length-3];G.binormals[G.binormals.length-2]=[-W[0],-W[1],-W[2]]}G.binormals[0]=G.binormals[1];G.binormals[G.binormals.length-1]=G.binormals[G.binormals.length-2]}else{A=G.sndStruc==5?144:60;if(l.length<3){if(l.length==1){G.tangents[0]=G.tangents[1]=[1,0,0]}else{G.tangents[0]=G.tangents[1]=G.tangents[2]=[l[1][0]-l[0][0],l[1][1]-l[0][1],l[1][2]-l[0][2]]}}else{for(O=0;O<G.molecules.length+1;O++){if(O+M<1){U=l[0];R=l[2]}else{if(O+M==N-1){U=l[O+M-1];R=l[O+M]}else{if(O+M<N-1){U=l[O+M-1];R=l[O+M+1]}}}W[0]=R[0]-U[0];W[1]=R[1]-U[1];W[2]=R[2]-U[2];if(W[0]*W[0]+W[1]*W[1]+W[2]*W[2]>A){G.tangents[O]=G.tangents[O>0?O-1:O+1]}else{G.tangents[O][0]=W[0]*g;G.tangents[O][1]=W[1]*g;G.tangents[O][2]=W[2]*g}}if(G.molecules[O-2].next==null&&O+M-3>-1){G.tangents[O-1][0]=l[O+M-2][0]-l[O+M-3][0];G.tangents[O-1][1]=l[O+M-2][1]-l[O+M-3][1];G.tangents[O-1][2]=l[O+M-2][2]-l[O+M-3][2]}}}}M+=G.molecules.length}var V;for(aa=0;aa<q.length;aa++){G=q[aa];if(G.sndStruc==3&&!G.rocket){F=G.molecules.length-(aa==q.length-1?1:0);for(O=1;O<F;O++){if(vec3.dot(G.binormals[O-1],G.binormals[O])<0){V={molecules:[],xyz:[],tangents:[],binormals:[],sndStruc:3};G.nextBlock=V;G.Cresume=true;V.Nresume=true;V.invertedBinormals=!G.invertedBinormals;V.isLast=G.isLast;G.isLast=false;for(M=O;M<G.binormals.length;M++){vec3.negate(G.binormals[M],G.binormals[M])}V.molecules=G.molecules.slice(O);V.tangents=G.tangents.slice(O);V.binormals=G.binormals.slice(O);V.xyz=G.xyz.slice(O);G.molecules=G.molecules.splice(0,O);G.tangents=G.tangents.splice(0,O+1);G.binormals=G.binormals.splice(0,O+1);G.xyz=G.xyz.splice(0,O);if(G.rocket){V.rocket=V.skip=true;V.waypoints=G.waypoints;V.waypoint_tangents=G.waypoint_tangents}if(G.molecules.length==1){G.invertedBinormals=!G.invertedBinormals}q.splice(aa+1,0,V);break}}if(vec3.dot(G.binormals[O-1],G.binormals[O])<0){vec3.negate(G.binormals[O],G.binormals[O])}}}};molmil.render=function(c){this.canvas=null;this.reloadSettings();this.programs=[];this.clearCut=0;this.fogStart=0;this.camera=new molmil.glCamera();this.soup=c;this.modelViewMatrix=mat4.create();this.projectionMatrix=mat4.create();this.pitch=0;this.heading=0;this.TransX=0;this.TransY=0;this.TransZ=0;this.pitchAngle=0;this.headingAngle=0;this.TransB=[0.5,0.5,0];this.animationMode=false;this.framesDefinition=[];this.framesBuffer=[];this.textures={};this.FBOs={};this.shaders={};this.buffers={};this.gl=null;this.modelId=0};molmil.render.prototype.clear=function(){for(var c=0;c<this.programs.length;c++){this.gl.deleteBuffer(this.programs[c].vertexBuffer);this.gl.deleteBuffer(this.programs[c].indexBuffer)}this.programs=[];this.program1=this.program2=this.program3=this.program4=undefined};molmil.render.prototype.reloadSettings=function(){this.QLV=localStorage.getItem("molmil.settings_QLV");if(this.QLV==null){this.QLV=2;localStorage.setItem("molmil.settings_QLV",this.QLV)}else{this.QLV=parseInt(this.QLV)}if(molmil.configBox.liteMode){this.QLV=1}if(this.gl){this.gl.clearColor.apply(this.gl,molmil.configBox.BGCOLOR)}this.settings={}};molmil.render.prototype.selectDefaultContext=function(){this.gl=this.defaultContext};molmil.render.prototype.selectDataContext=function(){if(!this.dataContext){this.dataContext=this.canvas.getContext("webgl",{preserveDrawingBuffer:true})||this.canvas.getContext("experimental-webgl",{preserveDrawingBuffer:true})}this.gl=this.dataContext};molmil.render.prototype.initGL=function(d,g,c){this.defaultContext=d.getContext("webgl")||d.getContext("experimental-webgl");d.renderer=this;if(!this.defaultContext){this.altCanvas=molmil.__webglNotSupported__(d);return false}this.gl=this.defaultContext;molmil.configBox.OES_element_index_uint=this.gl.getExtension("OES_element_index_uint");this.width=g|d.width;this.height=c|d.height;this.gl.viewportWidth=this.width;this.gl.viewportHeight=this.height;d.onmousedown=molmil.handle_molmilViewer_mouseDown;document.onmouseup=molmil.handle_molmilViewer_mouseUp;document.onmousemove=molmil.handle_molmilViewer_mouseMove;d.addEventListener(molmil_dep.dBT.MFF?"DOMMouseScroll":"mousewheel",molmil.handle_molmilViewer_mouseScroll,false);d.addEventListener("touchstart",molmil.handle_molmilViewer_touchStart,false);d.addEventListener("touchmove",molmil.handle_molmilViewer_touchMove,false);d.addEventListener("touchend",molmil.handle_molmilViewer_touchEnd,false);this.gl.clearColor.apply(this.gl,molmil.configBox.BGCOLOR);this.gl.enable(this.gl.DEPTH_TEST);if(molmil.configBox.cullFace){this.gl.enable(this.gl.CULL_FACE);this.gl.cullFace(this.gl.BACK)}this.canvas=d;var f=this.gl.getParameter(this.gl.ALIASED_LINE_WIDTH_RANGE);this.angle=f&&f.length==2&&f[0]==1&&f[1]==1;return true};molmil.render.prototype.initRenderer=function(){this.initShaders(molmil.configBox.glsl_shaders);this.resizeViewPort()};molmil.shaderEngine={code:{}};molmil.shaderEngine.recompile=function(f){var d="";if(molmil.configBox.glsl_fog){d+="#define ENABLE_FOG 1\n"}if(f.settings.slab){d+="#define ENABLE_SLAB 1\n"}for(var c in f.shaders){f.shaders[c].compile(d)}};molmil.render.prototype.initShaders=function(f){var q=this;var c,h,t,o,g,f=molmil.configBox.glsl_shaders;for(var d=0;d<f.length;d++){g=f[d][0];c=f[d][1]||g.replace(/\\/g,"/").replace(/.*\//,"").split(".")[0];if(!molmil.shaderEngine.code.hasOwnProperty(molmil.settings.src+g)){var l=new molmil_dep.CallRemote("GET");l.ASYNC=false;l.Send(molmil.settings.src+g);molmil.shaderEngine.code[molmil.settings.src+g]=l.request.responseText}}var c,h,t,o,g,s,f=molmil.configBox.glsl_shaders,n;for(var d=0;d<f.length;d++){g=f[d][0];c=f[d][1]||g.replace(/\\/g,"/").replace(/.*\//,"").split(".")[0];source=molmil.shaderEngine.code[molmil.settings.src+g].split("//#");n=JSON.parse(source[0]);n.name=c;n.vertexShader=source[1].substr(7);n.fragmentShader=source[2].substr(9);n.defines=f[d][2]||"";n.compile=function(p){this.program=q.gl.createProgram();molmil.setupShader(q.gl,this.name+"_v",this.program,p+this.defines+this.vertexShader,q.gl.VERTEX_SHADER);molmil.setupShader(q.gl,this.name+"_f",this.program,p+this.defines+this.fragmentShader,q.gl.FRAGMENT_SHADER);q.gl.linkProgram(this.program);if(!q.gl.getProgramParameter(this.program,q.gl.LINK_STATUS)){console.log("Could not initialise shaders for "+this.name)}q.gl.useProgram(this.program);for(o in this.attributes){this.attributes[o]=q.gl.getAttribLocation(this.program,o);if(this.attributes[o]!=-1){q.gl.enableVertexAttribArray(this.attributes[o])}}for(o in this.uniforms){this.uniforms[o]=q.gl.getUniformLocation(this.program,o)}};q.shaders[c]=n}molmil.shaderEngine.recompile(q)};molmil.setupShader=function(l,d,c,h,f){var g=l.createShader(f);l.shaderSource(g,h);l.compileShader(g);if(!l.getShaderParameter(g,l.COMPILE_STATUS)){console.log(d+":\n"+l.getShaderInfoLog(g));return null}l.attachShader(c,g);return g};molmil.render.prototype.updateSelection=function(){var h=new Float32Array(this.soup.atomSelection.length*8*6),d=[255,255,0];var g;for(var f=0,l=0,c;f<this.soup.atomSelection.length;f++){if(this.soup.atomSelection[f].displayMode==1){g=molmil_dep.getKeyFromObject(molmil.configBox.vdwR,this.soup.atomSelection[f].element,molmil.configBox.vdwR.DUMMY)*1.1}else{g=0.5}for(c=0;c<6;c++){h[l++]=this.soup.atomSelection[f].chain.modelsXYZ[this.modelId][this.soup.atomSelection[f].xyz];h[l++]=this.soup.atomSelection[f].chain.modelsXYZ[this.modelId][this.soup.atomSelection[f].xyz+1];h[l++]=this.soup.atomSelection[f].chain.modelsXYZ[this.modelId][this.soup.atomSelection[f].xyz+2];h[l++]=d[0];h[l++]=d[1];h[l++]=d[2];if(c==0||c==5){h[l++]=-g;h[l++]=+g}else{if(c==1){h[l++]=+g;h[l++]=+g}else{if(c==2||c==3){h[l++]=+g;h[l++]=-g}else{if(c==4){h[l++]=-g;h[l++]=-g}}}}}}if(!this.buffers.atomSelectionBuffer){this.buffers.atomSelectionBuffer=this.gl.createBuffer()}this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.buffers.atomSelectionBuffer);this.gl.bufferData(this.gl.ARRAY_BUFFER,h,this.gl.STATIC_DRAW);this.buffers.atomSelectionBuffer.items=this.soup.atomSelection.length*6};molmil.render.prototype.selectFrame=function(c,d){this.modelId=molmil.geometry.modelId=c;molmil.geometry.reInitChains=true;molmil.geometry.generate(this.soup.structures,this,d);this.initBD=true};molmil.render.prototype.initBuffers=function(){molmil.geometry.generate(this.soup.structures,this);this.updateSelection();this.initBD=true};molmil.render.prototype.renderPicking=function(){if(!this.initBD){return}this.gl.clearColor(0,0,0,0);this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT);var d=[0,0,0];var c=mat3.create();mat3.fromMat4(c,this.modelViewMatrix);vec3.transformMat3(d,this.soup.COR,c);for(var f=0;f<this.programs.length;f++){this.programs[f].renderPicking(this.modelViewMatrix,d)}this.gl.useProgram(null)};molmil.render.prototype.render=function(){if(!this.canvas.update||!this.initBD){return}if(this.canvas.update){for(var l=0;l<this.soup.canvases.length;l++){if(this.soup.canvases[l]!=this.canvas){this.soup.canvases[l].update=-1}}this.canvas.update=false;this.camera.pitchAngle=this.pitchAngle||this.pitch*Math.min(Math.max((Math.pow(Math.abs(this.camera.z),0.1)*0.25),0.5),2);this.camera.headingAngle=this.headingAngle||this.heading*Math.min(Math.max((Math.pow(Math.abs(this.camera.z),0.1)*0.25),0.5),2);if(this.TransX||this.TransY){var q=mat4.invert(mat4.create(),this.projectionMatrix);var s=(-this.camera.z-molmil.configBox.zNear)/(molmil.configBox.zFar-molmil.configBox.zNear);var n=vec3.lerp([0,0,0],molmil.unproject(this.TransB[0],this.TransB[1],0,q),molmil.unproject(this.TransB[0],this.TransB[1],1,q),s);this.TransB[0]+=this.TransX/this.width;this.TransB[1]-=this.TransY/this.height;var o=vec3.lerp([0,0,0],molmil.unproject(this.TransB[0],this.TransB[1],0,q),molmil.unproject(this.TransB[0],this.TransB[1],1,q),s);this.camera.x+=2*(o[0]-n[0]);this.camera.y+=2*(o[1]-n[1])}this.camera.z+=this.TransZ*Math.max(-this.camera.z/(this.width*0.5),0.05);if(this.camera.z>this.maxRange){this.camera.z=this.maxRange}if(this.camera.z<-(this.maxRange+molmil.configBox.zFar)){this.camera.z=-(this.maxRange+molmil.configBox.zFar)}this.pitch=0,this.heading=0,this.TransX=0,this.TransY=0,this.TransZ=0,this.pitchAngle=0,this.headingAngle=0;this.camera.positionCamera();this.modelViewMatrix=this.camera.generateMatrix();if(molmil.configBox.projectionMode==2){var f=-(this.camera.z*2)/molmil.configBox.zFar;mat4.ortho(this.projectionMatrix,-this.width*f,this.width*f,-this.height*f,this.height*f,Math.max(molmil.configBox.zNear,0.1),this.camera.z+(molmil.configBox.zFar*10))}}else{this.canvas.update=false}this.clearCut=((1-Math.abs(this.camera.QView[0]))*this.soup.stdXYZ[0])+((1-Math.abs(this.camera.QView[1]))*this.soup.stdXYZ[1])+((1-Math.abs(this.camera.QView[2]))*this.soup.stdXYZ[2]);this.fogStart=-this.camera.z-(this.clearCut*0.5);if(this.fogStart<molmil.configBox.zNear+1){this.fogStart=molmil.configBox.zNear+1}this.gl.clearColor.apply(this.gl,molmil.configBox.BGCOLOR);this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT);var h=[0,0,0];var g=mat3.create();mat3.fromMat4(g,this.modelViewMatrix);vec3.transformMat3(h,this.soup.COR,g);for(var d=0;d<this.programs.length;d++){this.programs[d].render(this.modelViewMatrix,h)}if(this.buffers.atomSelectionBuffer){this.renderAtomSelection(this.modelViewMatrix,h)}if(this.onRenderFinish){this.onRenderFinish()}this.gl.useProgram(null)};molmil.render.prototype.initFBOs=function(){if("scene" in this.FBOs){this.FBOs.depth.resize(this.width,this.height);this.FBOs.scene.resize(this.width,this.height)}else{this.FBOs.depth=new molmil.FBO(this.gl,this.width,this.height);this.FBOs.depth.addTexture("depthBuffer",this.gl.RGBA,this.gl.RGBA);this.FBOs.depth.setup();this.FBOs.scene=new molmil.FBO(this.gl,this.width,this.height);this.FBOs.scene.addTexture("colourBuffer",this.gl.RGBA,this.gl.RGBA);this.FBOs.scene.setup()}};molmil.render.prototype.resizeViewPort=function(){this.width=this.canvas.width;this.height=this.canvas.height;if(molmil.configBox.projectionMode==1){mat4.perspective(this.projectionMatrix,45*(Math.PI/360),this.width/this.height,molmil.configBox.zNear,molmil.configBox.zFar)}this.gl.viewport(0,0,this.width,this.height)};molmil.render.prototype.renderAtomSelection=function(c,d){this.gl.useProgram(this.shaders.atomSelection.program);this.gl.uniform3f(this.shaders.atomSelection.uniforms.COR,d[0],d[1],d[2]);this.gl.uniformMatrix4fv(this.shaders.atomSelection.uniforms.modelViewMatrix,false,c);this.gl.uniformMatrix4fv(this.shaders.atomSelection.uniforms.projectionMatrix,false,this.projectionMatrix);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.buffers.atomSelectionBuffer);this.gl.vertexAttribPointer(this.shaders.atomSelection.attributes.in_Position,3,this.gl.FLOAT,false,32,0);this.gl.vertexAttribPointer(this.shaders.atomSelection.attributes.in_Colour,3,this.gl.FLOAT,false,32,12);this.gl.vertexAttribPointer(this.shaders.atomSelection.attributes.in_ScreenSpaceOffset,2,this.gl.FLOAT,false,32,24);this.gl.enable(this.gl.BLEND);if(molmil.configBox.cullFace){this.gl.disable(this.gl.CULL_FACE)}this.gl.blendEquation(this.gl.FUNC_ADD);this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA);this.gl.drawArrays(this.gl.TRIANGLES,0,this.buffers.atomSelectionBuffer.items);if(molmil.configBox.cullFace){this.gl.enable(this.gl.CULL_FACE)}this.gl.disable(this.gl.BLEND)};molmil.FBO=function(f,d,c){this.width=d;this.height=c;this.gl=f;this.textures={};this.colourNumber=0;this.fbo=null;this.depthBuffer=null};molmil.FBO.prototype.addTexture=function(g,c,f){if(g in this.textures){this.gl.bindTexture(this.gl.TEXTURE_2D,this.textures[g][0])}else{var d=this.gl.createTexture();this.textures[g]=[d,this.colourNumber++,c,f];this.gl.bindTexture(this.gl.TEXTURE_2D,d);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE)}this.gl.texImage2D(this.gl.TEXTURE_2D,0,c,this.width,this.height,0,f,this.gl.UNSIGNED_BYTE,null);this.gl.bindTexture(this.gl.TEXTURE_2D,null)};molmil.FBO.prototype.setup=function(){if(this.fbo!=null){this.rebindTextures(true)}else{this.fbo=this.gl.createFramebuffer();this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.fbo);this.rebindTextures(false);this.depthBuffer=this.gl.createRenderbuffer();this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.depthBuffer);this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_COMPONENT16,this.width,this.height);this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,this.depthBuffer);this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)}};molmil.FBO.prototype.rebindTextures=function(f){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.fbo);var d=[];for(var c in this.textures){this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0+this.textures[c][1],this.gl.TEXTURE_2D,this.textures[c][0],0);d.push(this.gl.COLOR_ATTACHMENT0+this.textures[c][1])}this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,this.depthBuffer);if(f){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)}};molmil.FBO.prototype.bindTextureToUniform=function(d,f,c){this.gl.activeTexture(this.gl.TEXTURE0+c);this.gl.bindTexture(this.gl.TEXTURE_2D,this.textures[d][0]);this.gl.uniform1i(f,c)};molmil.FBO.prototype.resize=function(f,c){if(f==this.width&&c==this.height){return}this.width=f;this.height=c;for(var d in this.textures){this.addTexture(d,this.textures[d][2],this.textures[d][3])}this.rebindTextures(false);this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.depthBuffer);this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_COMPONENT16,this.width,this.height);this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,this.depthBuffer);this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)};molmil.FBO.prototype.bind=function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.fbo)};molmil.FBO.prototype.unbind=function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)};molmil.glCamera=function(){this.reset()};molmil.glCamera.prototype.reset=function(){this.x=this.y=this.z=this.pitchAngle=this.headingAngle=0;this.QPitch=quat.create();this.QHeading=quat.create();this.QView=quat.create();this.pitchAngle=this.headingAngle=0};molmil.glCamera.prototype.generateMatrix=function(){var c=mat4.create();mat4.fromQuat(c,this.QView);c[12]=this.x;c[13]=this.y;c[14]=this.z;return c};molmil.glCamera.prototype.positionCamera=function(){quat.setAxisAngle(this.QPitch,[1,0,0],(this.pitchAngle/180)*Math.PI);quat.setAxisAngle(this.QHeading,[0,1,0],(this.headingAngle/180)*Math.PI);var c=quat.create();quat.multiply(c,this.QPitch,this.QHeading);quat.multiply(this.QView,c,this.QView);this.headingAngle=this.pitchAngle=0};molmil.handle_molmilViewer_mouseDown=function(c){molmil.activeCanvas=this;molmil.mouseDown=1;molmil.mouseDownS[c.which]=1;molmil.Xcoord=c.clientX;molmil.Ycoord=c.clientY;molmil.Zcoord=c.clientY;molmil.mouseMoved=false;document.oncontextmenu=molmil.disableContextMenu};molmil.disableContextMenu=function(c){if(c.stopPropagation){c.stopPropagation()}if(c.preventDefault){c.preventDefault()}c.cancelBubble=true;c.cancel=true;c.returnValue=false;return false};molmil.getOffset=function(d){var f=d.target,c=0,g=0;while(f&&!isNaN(f.offsetLeft)&&!isNaN(f.offsetTop)){c+=f.offsetLeft-f.scrollLeft;g+=f.offsetTop-f.scrollTop;f=f.offsetParent}c=d.clientX-c;g=d.clientY-g;return{x:c,y:g}};molmil.handle_molmilViewer_mouseUp=function(g){var d=molmil.activeCanvas;if(!molmil.mouseMoved&&d){if(g.ctrlKey!=d.atomCORset){if(g.ctrlKey){d.molmilViewer.setCOR()}else{d.molmilViewer.resetCOR()}d.renderer.modelViewMatrix=d.renderer.camera.generateMatrix()}if(d.isFullScreen){var l={x:g.screenX,y:g.screenY}}else{var l=molmil.getOffset(g)}var f=window.devicePixelRatio||1;d.renderer.soup.selectObject(l.x*f,l.y*f,g);if(g.which==3){d.renderer.soup.UI.showContextMenuAtom(g.clientX,g.clientY,g.pageX)}}molmil.mouseDownS[g.which]=0;if(molmil_dep.dBT.mac&&!g.ctrlKey&&molmil.mouseDownS[3]){molmil.mouseDownS[3]=0}var c=true;for(var h in molmil.mouseDownS){if(molmil.mouseDownS[h]){c=false;break}}molmil.mouseDown=c?0:1;if(c){setTimeout(function(){document.oncontextmenu=null},10);d=null}else{g.preventDefault();return false}};molmil.handle_molmilViewer_mouseMove=function(d){var c=molmil.activeCanvas;if(!molmil.mouseDown||!c){return}molmil.mouseMoved=true;if(molmil.mouseDownS[2]||(molmil.mouseDownS[1]&&molmil.mouseDownS[3])||(molmil.mouseDownS[1]&&d.shiftKey)){c.renderer.TransX+=(d.clientX-molmil.Xcoord)*0.5;c.renderer.TransY+=(d.clientY-molmil.Ycoord)*0.5;molmil.Xcoord=d.clientX;molmil.Zcoord=molmil.Ycoord=d.clientY}else{if(molmil.mouseDownS[1]){c.renderer.heading+=d.clientX-molmil.Xcoord;c.renderer.pitch+=d.clientY-molmil.Ycoord;molmil.Xcoord=d.clientX;molmil.Ycoord=d.clientY}else{if(molmil.mouseDownS[3]){c.renderer.TransZ=(d.clientY-molmil.Zcoord);molmil.Zcoord=d.clientY}}}if(d.ctrlKey!=c.atomCORset){if(d.ctrlKey){c.molmilViewer.setCOR()}else{c.molmilViewer.resetCOR()}}c.update=true;d.preventDefault()};molmil.handle_molmilViewer_mouseScroll=function(c){c.target.renderer.TransZ-=(c.wheelDelta||-c.detail*40);c.target.update=true;try{c.preventDefault()}catch(d){}return false};molmil.onDocumentMouseMove=function(c){if(molmil.mouseXstart==null){molmil.mouseXstart=c.clientX;molmil.mouseYstart=c.clientY}mouseX=c.clientX-molmil.mouseXstart;mouseY=c.clientY-molmil.mouseYstart;molmil.mouseXstart=c.clientX;molmil.mouseYstart=c.clientY};molmil.handle_molmilViewer_touchStart=function(f){if(document.body.onmousedown){document.body.onmousedown();document.body.onmousedown=null}molmil.activeCanvas=this;molmil.touchList=[];for(var d=0;d<f.touches.length;d++){molmil.touchList.push([f.touches[d].clientX,f.touches[d].clientY])}if(molmil.touchList.length==1){molmil.touchMode=1;molmil.previousTouchEvent=f;molmil.longTouchTID=setTimeout(molmil.handle_molmilViewer_touchHold,500)}else{if(molmil.touchList.length==2){var g=vec2.distance([0,0],[screen.width,screen.height]);var c=vec2.distance(molmil.touchList[0],molmil.touchList[1]);if(c/g<0.075){molmil.touchMode=3}else{molmil.touchMode=2}}}f.preventDefault()};molmil.handle_molmilViewer_touchHold=function(){if(!molmil.longTouchTID){return}if(molmil.previousTouchEvent){if(Math.sqrt((Math.pow(molmil.previousTouchEvent.touches[0].clientX-molmil.touchList[0][0],2))+(Math.pow(molmil.previousTouchEvent.touches[0].clientY-molmil.touchList[0][1],2)))<1){if(molmil.activeCanvas.isFullScreen){var d={x:molmil.previousTouchEvent.touches[0].screenX,y:molmil.previousTouchEvent.touches[0].screenY}}else{var d=molmil.getOffset(molmil.previousTouchEvent.touches[0])}var c=window.devicePixelRatio||1;molmil.activeCanvas.renderer.soup.selectObject(d.x*c,d.y*c,event)}molmil.activeCanvas.renderer.soup.UI.showContextMenuAtom(molmil.previousTouchEvent.touches[0].clientX,molmil.previousTouchEvent.touches[0].clientY,molmil.previousTouchEvent.touches[0].pageX)}molmil.longTouchTID=null;molmil.previousTouchEvent=null};molmil.handle_molmilViewer_touchMove=function(g){if(!molmil.touchList.length||!molmil.activeCanvas){return}if(molmil.longTouchTID){clearTimeout(molmil.longTouchTID);molmil.longTouchTID=null}var f=[];for(var d=0;d<g.touches.length;d++){f.push([g.touches[d].clientX,g.touches[d].clientY])}if(molmil.touchMode==1){molmil.activeCanvas.renderer.heading+=f[0][0]-molmil.touchList[0][0];molmil.activeCanvas.renderer.pitch+=f[0][1]-molmil.touchList[0][1]}else{if(molmil.touchMode==2){molmil.activeCanvas.renderer.TransZ=(vec2.distance(f[0],f[1])-vec2.distance(molmil.touchList[0],molmil.touchList[1]))*5}else{if(molmil.touchMode==3){var h=vec2.distance([0,0],[screen.width,screen.height]);var c=vec2.distance(molmil.touchList[0],molmil.touchList[1]);if(c/h<0.075){molmil.activeCanvas.renderer.TransX=((f[0][0]+f[1][0])/2)-((molmil.touchList[0][0]+molmil.touchList[1][0])/2);molmil.activeCanvas.renderer.TransY=((f[0][1]+f[1][1])/2)-((molmil.touchList[0][1]+molmil.touchList[1][1])/2)}}}}molmil.touchList=f;molmil.activeCanvas.update=true;g.preventDefault()};molmil.handle_molmilViewer_touchEnd=function(){if(molmil.previousTouchEvent&&molmil.touchMode==1){if(Math.sqrt((Math.pow(molmil.previousTouchEvent.touches[0].clientX-molmil.touchList[0][0],2))+(Math.pow(molmil.previousTouchEvent.touches[0].clientY-molmil.touchList[0][1],2)))<1){if(molmil.activeCanvas.isFullScreen){var d={x:molmil.previousTouchEvent.touches[0].screenX,y:molmil.previousTouchEvent.touches[0].screenY}}else{var d=molmil.getOffset(molmil.previousTouchEvent.touches[0])}var c=window.devicePixelRatio||1;molmil.activeCanvas.renderer.soup.selectObject(d.x*c,d.y*c,event)}}molmil.touchList=[];molmil.touchMode=0;molmil.longTouchTID=null};molmil.setOnContextMenu=function(d,c){d.oncontextmenu=c;d.addEventListener("touchstart",molmil.handle_contextMenu_touchStart,false);d.addEventListener("touchend",molmil.handle_contextMenu_touchEnd,false)};molmil.handle_contextMenu_touchStart=function(c){previousTouchEvent=c;longTouchTID=setTimeout(molmil.handle_contextMenu_touchHold,500);c.preventDefault()};molmil.handle_contextMenu_touchHold=function(){if(!longTouchTID){return}longTouchTID=null;previousTouchEvent.touches[0].target.oncontextmenu(previousTouchEvent.touches[0]);previousTouchEvent=null};molmil.handle_contextMenu_touchEnd=function(c){if(previousTouchEvent){previousTouchEvent.touches[0].target.onclick()}longTouchTID=null;clearTimeout(longTouchTID)};molmil.UI=function(c){this.soup=c;this.canvas=c.canvas;this.LM=null;this.RM=null};molmil.UI.prototype.init=function(){var d,g;d=document.createElement("span");d.className="molmil_UI_LB unselectableText";this.LM=g=document.createElement("span");g.className="molmil_UI_LB_icon";g.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="Layer_1" style="enable-background:new 0 0 32 32;/* background-color: red; */" version="1.1" viewBox="0 0 32 32" xml:space="preserve"><path d="M4,10h24c1.104,0,2-0.896,2-2s-0.896-2-2-2H4C2.896,6,2,6.896,2,8S2.896,10,4,10z M28,14H4c-1.104,0-2,0.896-2,2  s0.896,2,2,2h24c1.104,0,2-0.896,2-2S29.104,14,28,14z M28,22H4c-1.104,0-2,0.896-2,2s0.896,2,2,2h24c1.104,0,2-0.896,2-2  S29.104,22,28,22z" fill="red"/></svg>';g.UI=this;g.onclick=function(){this.UI.showLM(this)};d.appendChild(g);(this.canvas?this.canvas.parentNode:document.body).appendChild(d);d=document.createElement("span");d.className="molmil_UI_RB unselectableText";this.RM=g=document.createElement("div");if(molmil.configBox.BGCOLOR[0]==0&&molmil.configBox.BGCOLOR[1]==0&&molmil.configBox.BGCOLOR[2]==0){g.style.color="white"}g.className="molmil_UI_RB_icon";g.innerHTML="&lt;<br/>&lt;<br/>&lt;";g.title="Structures panel: contains a list of all loaded entries";g.UI=this;g.onclick=function(){this.UI.showRM(this)};d.appendChild(g);d.menu=d.pushNode("div");d.menu.style.display="none";d.menu.className="molmil_UI_RM";(this.canvas?this.canvas.parentNode:document.body).appendChild(d);var c=this.canvas;var f=function(n){var h=document.molmil_FSC;if(h!=c){return}var l=window.devicePixelRatio||1;if(!h.isFullScreen){h.renderer.width=h.width=screen.width*l;h.renderer.height=h.height=screen.height*l;h.style.width=screen.width+"px";h.style.height=screen.height+"px";h.isFullScreen=true}else{h.renderer.width=h.width=h.defaultSize[0]*l;h.renderer.height=h.height=h.defaultSize[1]*l;h.style.width=h.defaultSize[0]+"px";h.style.height=h.defaultSize[1]+"px";h.isFullScreen=false;document.molmil_FSC=null}h.renderer.resizeViewPort();h.update=true;h.renderer.render()};document.addEventListener("webkitfullscreenchange",f,false);document.addEventListener("mozfullscreenchange",f,false);document.addEventListener("MSFullscreenChange",f,false);document.addEventListener("fullscreenchange",f,false)};molmil.UI.prototype.deleteEntry=function(c){};molmil.UI.prototype.displayEntry=function(d,c){if(d.ref){molmil.displayEntry(d.ref,c,true,this.soup)}document.body.onmousedown()};molmil.UI.prototype.colorEntry=function(h,c){if(h.ref){if(c==molmil.colorEntry_Custom){var d=molmil_dep.dcE("div");d.setClass("molmil_menu_popup");d.pushNode("span","Color by: ");var g=d.pushNode("input");g.type="color";g.value="#FFFFFF";var f=d.pushNode("button","Apply");f.style.marginLeft="1em";f.entry=h;f.ci=g;f.popup=d;f.soup=this.soup;f.UI=this;f.onclick=function(){var l=molmil.hex2rgb(this.ci.value);l.push(255);if(this.entry.mtype==3.1){h.ref.rgba=l;this.UI.soup.renderer.initBuffers();this.UI.soup.renderer.canvas.update=true}else{if(this.entry.mtype==3.2){for(a=0;a<h.ref.atoms.length;a++){h.ref.atoms[a].rgba=l}this.UI.soup.renderer.initBuffers();this.UI.soup.renderer.canvas.update=true}else{molmil.colorEntry(this.entry.ref,molmil.colorEntry_Custom,l,true,this.soup)}}this.popup.parentNode.removeChild(this.popup)};this.LM.parentNode.pushNode(d)}else{molmil.colorEntry(h.ref,c,null,true,this.soup)}}document.body.onmousedown()};molmil.UI.prototype.showColorMenu=function(g,f){if(g.subMenu){clearTimeout(g.subMenu.TID);g.subMenu.style.display="";return}var n=molmil_dep.findPos(g);var l=g.subMenu=molmil_dep.dcE("div");l.className="contextMenu cM_sub";if(g.inv||f.inv){l.style.left="auto";l.style.right=((g.parentNode.clientWidth/molmil_dep.fontSize)+1.8)+"em"}else{l.style.left=((g.parentNode.clientWidth/molmil_dep.fontSize)+1.8)+"em"}var d,h=this;var c=function(o,q,p){d=l.pushNode("div",o);d.className="contextMenu_E";d.UI=h;d.entry=f;d.onclick=q;if(p){d.onmouseover=q;d.next=d.pushNode("span",">")}else{d.addEventListener("touchstart",function(){this.onclick()},false)}};if(f.mtype!=3.1&&f.mtype!=3.2){c("Default",function(){this.UI.colorEntry(f,1)})}if(f.mtype!=3.2){c("Structure",function(){if(f.mtype==3.1){var o=f.ref;o.rgba=molmil_dep.getKeyFromObject(molmil.configBox.sndStrucColor,o.sndStruc,molmil.configBox.sndStrucColor[1]);this.UI.soup.renderer.initBuffers();this.UI.soup.renderer.canvas.update=true;document.body.onmousedown()}else{this.UI.colorEntry(f,2)}})}if(f.mtype!=3.1){c("Atom (CPK)",function(){if(f.mtype==3.2){var o=f.ref;for(a=0;a<o.atoms.length;a++){o.atoms[a].rgba=molmil_dep.getKeyFromObject(molmil.configBox.elementColors,o.atoms[a].element,molmil.configBox.elementColors.DUMMY)}this.UI.soup.renderer.initBuffers();this.UI.soup.renderer.canvas.update=true;document.body.onmousedown()}else{this.UI.colorEntry(f,3)}})}if(f.mtype==1||f.mtype==2||f.mtype==0.5){c("Group",function(){this.UI.colorEntry(f,4)});c("ABEGO",function(){this.UI.colorEntry(f,molmil.colorEntry_ABEGO)})}if(f.mtype==1||f.mtype==0.5){c("Chain",function(){this.UI.colorEntry(f,5)});c("Chain alt.",function(){this.UI.colorEntry(f,molmil.colorEntry_ChainAlt)})}c("Custom",function(){this.UI.colorEntry(f,6)});g.onmouseout=function(){this.subMenu.TID=molmil_dep.asyncStart(function(){this.style.display="none"},[],g.subMenu,100)};g.pushNode(l)};molmil.UI.prototype.showDisplayMenuCM=function(g){var o=this.soup.atomSelection;if(!o.length){return}if(g.subMenu){clearTimeout(g.subMenu.TID);g.subMenu.style.display="";return}var q=molmil_dep.findPos(g);var f=g.subMenu=molmil_dep.dcE("div");if(g.inv){f.style.left="auto";f.style.right=((g.parentNode.clientWidth/molmil_dep.fontSize)+1.8)+"em"}else{f.style.left=((g.parentNode.clientWidth/molmil_dep.fontSize)+1.8)+"em"}var l=q[0]+(g.inv?-1:1)*(g.parentNode.clientWidth+(2*molmil_dep.fontSize));var t=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth;var n=t<l+(molmil_dep.fontSize*25);f.className="contextMenu cM_sub";var u,h=this;var d=function(w,y,x){u=f.pushNode("div",w);u.className="contextMenu_E";u.UI=h;u.entry=null;u.onclick=y;if(x){u.onmouseover=y;u.next=u.pushNode("span",">")}else{u.addEventListener("touchstart",function(){this.onclick()},false)}};var c=[];var p=[];for(var s=0;s<o.length;s++){c.push(o[s].molecule);p.push(o[s].molecule.chain)}d("Residue",function(){this.UI.showDisplayMenu(this,{mtype:3,ref:c,inv:n})},true);d("Chain",function(){this.UI.showDisplayMenu(this,{mtype:2,ref:p,inv:n})},true);g.onmouseout=function(){this.subMenu.TID=molmil_dep.asyncStart(function(){this.style.display="none"},[],g.subMenu,100)};g.pushNode(f)};molmil.UI.prototype.showColorMenuCM=function(g){var o=this.soup.atomSelection;if(!o.length){return}if(g.subMenu){clearTimeout(g.subMenu.TID);g.subMenu.style.display="";return}var q=molmil_dep.findPos(g);var f=g.subMenu=molmil_dep.dcE("div");if(g.inv){f.style.left="auto";f.style.right=((g.parentNode.clientWidth/molmil_dep.fontSize)+1.8)+"em"}else{f.style.left=((g.parentNode.clientWidth/molmil_dep.fontSize)+1.8)+"em"}var l=q[0]+(g.inv?-1:1)*(g.parentNode.clientWidth+(2*molmil_dep.fontSize));var t=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth;var n=t<l+(molmil_dep.fontSize*25);f.className="contextMenu cM_sub";var u,h=this;var d=function(w,y,x){u=f.pushNode("div",w);u.className="contextMenu_E";u.UI=h;u.entry=null;u.onclick=y;if(x){u.onmouseover=y;u.next=u.pushNode("span",">")}else{u.addEventListener("touchstart",function(){this.onclick()},false)}};var c=[];var p=[];for(var s=0;s<o.length;s++){c.push(o[s].molecule);p.push(o[s].molecule.chain)}d("Atom",function(){this.UI.showColorMenu(this,{mtype:4,ref:o,inv:n})},true);d("Residue",function(){this.UI.showColorMenu(this,{mtype:3,ref:c,inv:n})},true);d("Residue (cartoon)",function(){this.UI.showColorMenu(this,{mtype:3.1,ref:c,inv:n})},true);d("Residue (atoms)",function(){this.UI.showColorMenu(this,{mtype:3.2,ref:c,inv:n})},true);d("Chain",function(){this.UI.showColorMenu(this,{mtype:2,ref:p,inv:n})},true);g.onmouseout=function(){this.subMenu.TID=molmil_dep.asyncStart(function(){this.style.display="none"},[],g.subMenu,100)};g.pushNode(f)};molmil.UI.prototype.showDisplayMenu=function(f,o){if(f.subMenu){clearTimeout(f.subMenu.TID);f.subMenu.style.display="";return}var n=molmil_dep.findPos(f);var d=f.subMenu=molmil_dep.dcE("div");d.className="contextMenu cM_sub";var s,g=this;if(f.inv||o.inv){d.style.left="auto";d.style.right=((f.parentNode.clientWidth/molmil_dep.fontSize)+1.8)+"em"}else{d.style.left=((f.parentNode.clientWidth/molmil_dep.fontSize)+1.8)+"em"}var h=n[0]+(f.inv?-1:1)*(f.parentNode.clientWidth+(2*molmil_dep.fontSize));var q=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth;var l=q<h+(molmil_dep.fontSize*25);var c=function(t,w,u){s=d.pushNode("div",t);s.className="contextMenu_E";s.inv=l;s.UI=g;s.entry=o;s.onclick=w;if(u){s.onmouseover=w;s.next=s.pushNode("span",">")}else{s.addEventListener("touchstart",function(){this.onclick()},false)}};c("None",function(){this.UI.displayEntry(o,0)});if(o.mtype!=3){c("Default",function(){this.UI.displayEntry(o,1)})}if(o.mtype!=10){if(o.mtype==3&&(o.ref[0].ligand||o.ref[0].water)){c("Space fill",function(){this.UI.displayEntry(o,2)});c("Ball & stick",function(){this.UI.displayEntry(o,3)});c("Stick",function(){this.UI.displayEntry(o,4)});c("Wireframe",function(){this.UI.displayEntry(o,5)})}else{var p=function(t,y){if(t.subMenu){clearTimeout(t.subMenu.TID);t.subMenu.style.display="";return}var z=molmil_dep.findPos(t);var x=t.subMenu=molmil_dep.dcE("div");if(t.inv){x.style.left="auto";x.style.right=((t.parentNode.clientWidth/molmil_dep.fontSize)+1.8)+"em"}else{x.style.left=((t.parentNode.clientWidth/molmil_dep.fontSize)+1.8)+"em"}x.className="contextMenu cM_sub";var w;var u=function(A,C,B){w=x.pushNode("div",A);w.className="contextMenu_E";w.UI=g;w.entry=o;w.onclick=C;if(B){w.onmouseover=C;w.next=w.pushNode("span",">")}else{w.addEventListener("touchstart",function(){this.onclick()},false)}};u("Space fill",function(){this.UI.displayEntry(o,y==1?2:2.5)});u("Ball & stick",function(){this.UI.displayEntry(o,y==1?3:3.5)});u("Stick",function(){this.UI.displayEntry(o,y==1?4:4.5)});u("Wireframe",function(){this.UI.displayEntry(o,y==1?5:5.5)});t.onmouseout=function(){this.subMenu.TID=molmil_dep.asyncStart(function(){this.style.display="none"},[],t.subMenu,100)};t.pushNode(x)};c("Amino acid",function(){p(this,1)},true);c("Side chain",function(){p(this,2)},true)}if(o.mtype<3&&!(o.ref[0].ligand||o.ref[0].water)){c("Ca trace",function(){this.UI.displayEntry(o,6)});c("Tube",function(){this.UI.displayEntry(o,7)});c("Cartoon",function(){this.UI.displayEntry(o,8)});c("Rocket",function(){this.UI.displayEntry(o,8.5)});c("CG Surface",function(){this.UI.displayEntry(o,molmil.displayMode_ChainSurfaceCG)})}}f.onmouseout=function(){this.subMenu.TID=molmil_dep.asyncStart(function(){this.style.display="none"},[],f.subMenu,100)};f.pushNode(d)};molmil.UI.prototype.showContextMenuAtom=function(s,q,h){if(document.body.onmousedown){document.body.onmousedown()}var o=this.soup.atomSelection;if(!o.length){return}var t=0;var u=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth;if(u<h+(molmil_dep.fontSize*12)){t=(h+(molmil_dep.fontSize*12))-u}var l=u<h+(molmil_dep.fontSize*25);var d=molmil_dep.dcE("div");d.className="contextMenu";d.style.left=s-t+"px";d.style.top=q+(document.body.scrollTop||0)+"px";if(o.length>1){d.pushNode("div",this.soup.atomSelection.length+" atoms selected")}else{var p=o[0];var n=p.molecule.atoms.length>1;var f=d.pushNode("div",(n?p.atomName:p.element)+" - "+(n?(p.molecule.name||"")+" ":"")+(p.molecule.RSID||"")+(p.molecule.chain.name?" - Chain "+p.molecule.chain.name:""))}d.pushNode("HR");var g=this;var c=function(w,y,x){item=d.pushNode("div",w);if(!item.pushNode){return}item.className="contextMenu_E";item.UI=g;item.entry=null;item.inv=l;item.onclick=y;if(x){item.onmouseover=y;item.next=item.pushNode("span",">")}else{item.addEventListener("touchstart",function(){this.onclick()},false)}};c("Display",function(){this.UI.showDisplayMenuCM(this)},true);c("Color",function(){this.UI.showColorMenuCM(this)},true);document.body.pushNode(d);document.body.onmousedown=function(x){if(x&&x.target.className.indexOf("contextMenu_E")!=-1){return}var w=document.getElementsByClassName("contextMenu");for(var y=0;y<w.length;y++){w[y].parentNode.removeChild(w[y])}w=document.getElementsByClassName("contextMenu_E_sel")[0];document.body.onmousedown=null};return false};molmil.UI.prototype.showCM=function(h,f){if(document.body.onmousedown){document.body.onmousedown()}var o=0;var n=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth;if(n<h.pageX+(molmil_dep.fontSize*12)){o=(h.pageX+(molmil_dep.fontSize*12))-n}f.inv=n<h.pageX+(molmil_dep.fontSize*25);var l=molmil_dep.dcE("div");l.className="contextMenu";l.style.left=h.pageX-o+"px";l.style.top=h.pageY+"px";var d,g=this;f.setClass("contextMenu_E_sel");var c=function(p,s,q){d=l.pushNode("div",p);d.className="contextMenu_E";d.UI=g;d.entry=f;d.onclick=s;if(q){d.onmouseover=s;d.next=d.pushNode("span",">")}else{d.addEventListener("touchstart",function(){this.onclick()},false)}};if(f.mtype==0.5||f.mtype==1){if(this.soup.hideWaters){c("Show waters",function(){this.UI.toggleWaters(1)})}else{c("Hide waters",function(){this.UI.toggleWaters(0)})}if(this.soup.hideHydrogens){c("Show hydrogens",function(){this.UI.toggleHydrogens(1)})}else{c("Hide hydrogens",function(){this.UI.toggleHydrogens(0)})}}c("Display",function(){this.UI.showDisplayMenu(this,f)},true);if(f.mtype!=10){c("Color",function(){this.UI.showColorMenu(this,f)},true)}document.body.pushNode(l);document.body.onmousedown=function(q){if(q&&q.target.className.indexOf("contextMenu_E")!=-1){return}var p=document.getElementsByClassName("contextMenu");for(var s=0;s<p.length;s++){p[s].parentNode.removeChild(p[s])}p=document.getElementsByClassName("contextMenu_E_sel")[0];if(p){f.removeClass("contextMenu_E_sel")}document.body.onmousedown=null};try{h.preventDefault()}catch(h){}return false};molmil.UI.prototype.showRM=function(g){var n=g.parentNode.menu;if(n.style.display=="none"){g.innerHTML="&gt;<br/>&gt;<br/>&gt;";n.style.maxHeight=((this.canvas?this.canvas:document.body)-32)+"px";n.style.display=""}else{g.innerHTML="&lt;<br/>&lt;<br/>&lt;";n.style.display="none"}var l=this.canvas?this.canvas.molmilViewer.structures:[];if(n.childNodes.length>0){if(l.length==n.nof){return}}n.nof=l.length;n.pushNode("span","Structures:").className="optCat_k";n.pushNode("hr");var c,h,f;for(var d=0;d<l.length;d++){f=l[d];if(f instanceof molmil.entryObject){h=n.pushNode("div");h.plus=h.pushNode("a","+");h.plus.className="optCat_p";h.name=h.pushNode("a",f.meta.id);h.name.title="Left click to expand\nRight click to show the context menu for display & color options";h.name.className="optCat_n";h.plus.onclick=h.name.onclick=molmil_dep.expandCatTree;h.name.UI=h.UI=this;molmil.setOnContextMenu(h.name,function(o){this.UI.showCM(o,this)});h.name.mtype=1;h.payload=h.name.ref=[f];h.expandFunc=this.showChains}else{h=n.pushNode("div",f.filename);h.className="optCat_n";h.style.marginLeft="1.25em";h.UI=this;molmil.setOnContextMenu(h,function(o){this.UI.showCM(o,this)});h.mtype=10;h.ref=[f.polygon]}}};molmil.UI.prototype.showChains=function(h,g){var d,f;h.pushNode("span","Chains:").className="optCat_k";h.pushNode("hr");g=g instanceof Array?g[0]:g;for(var c=0;c<g.chains.length;c++){d=g.chains[c];f=h.pushNode("div");f.plus=f.pushNode("a","+");f.plus.className="optCat_p";f.name=f.pushNode("a",d.name?d.name:c+1);f.name.title="Left click to expand\nRight click to show the context menu for display & color options";f.name.className="optCat_n";f.plus.onclick=f.name.onclick=molmil_dep.expandCatTree;f.payload=d;f.name.UI=f.UI=this.UI;f.expandFunc=this.UI.showResidues;molmil.setOnContextMenu(f.name,function(l){this.UI.showCM(l,this)});f.name.mtype=2;f.name.ref=[d]}h.pushNode("hr")};molmil.UI.prototype.showResidues=function(h,g){h.pushNode("span","Residues/Ligands:").className="optCat_k";h.pushNode("hr");var f,d;g=g instanceof Array?g[0]:g;for(var c=0;c<g.molecules.length;c++){f=g.molecules[c];d=h.pushNode("div",f.name+(f.id?" ("+f.id+")":""));d.title="Double click to jump to residue\nRight click to show the context menu for display & color options";d.className="optCat_n";d.payload=f;d.UI=this.UI;molmil.setOnContextMenu(d,function(l){this.UI.showCM(l,this)});d.mtype=3;d.ref=[f];d.ondblclick=function(){this.UI.canvas.molmilViewer.gotoMol(this.payload)};d.onclick=function(){this.UI.canvas.molmilViewer.atomSelection=[this.payload.CA||this.payload.atoms[0]];this.UI.canvas.renderer.updateSelection();this.UI.canvas.update=true}}h.pushNode("hr")};molmil.UI.prototype.showLM=function(d){try{if(d.parentNode.childNodes.length>1){d.parentNode.removeChild(d.nextSibling);d.parentNode.removeChild(d.nextSibling);return}}catch(f){}var g=document.createElement("div"),f;g.className="molmil_UI_LM";f=g.appendChild(document.createElement("div"));f.menu=g;f.UI=this;f.className="molmil_UI_ME";f.innerHTML="Open >";f.title="Open files or entries";f.onclick=function(){molmil_dep.Clear(this.menu.sub);var h;this.menu.sub.style.display="";if(!molmil_dep.dBT.ios_version){h=this.menu.sub.pushNode("div","mmCIF file","molmil_UI_ME");h.UI=this.UI;h.onclick=function(){this.UI.open("mmCIF",2)};h=this.menu.sub.pushNode("div","PDBML file","molmil_UI_ME");h.UI=this.UI;h.onclick=function(){this.UI.open("PDBML",3)};h=this.menu.sub.pushNode("div","mmJSON file","molmil_UI_ME");h.UI=this.UI;h.onclick=function(){this.UI.open("mmJSON",1)};h=this.menu.sub.pushNode("div","PDB (flat) file","molmil_UI_ME");h.UI=this.UI;h.onclick=function(){this.UI.open("PDB",4)};h=this.menu.sub.pushNode("div","GRO file","molmil_UI_ME");h.UI=this.UI;h.onclick=function(){this.UI.open("GRO",7)};h=this.menu.sub.pushNode("div","CCP4 file","molmil_UI_ME");h.UI=this.UI;h.onclick=function(){this.UI.open("CCP4","ccp4",null,null,true)};h=this.menu.sub.pushNode("div","MDL mol file","molmil_UI_ME");h.UI=this.UI;h.onclick=function(){this.UI.open("MDL mol","mdl")};h=this.menu.sub.pushNode("div","Mol2 file","molmil_UI_ME");h.UI=this.UI;h.onclick=function(){this.UI.open("Mol2","mol2")};h=this.menu.sub.pushNode("div","Polygon XML file","molmil_UI_ME");h.UI=this.UI;h.onclick=function(){this.UI.open("Polygon XML file",5)};h=this.menu.sub.pushNode("div","Polygon JSON file","molmil_UI_ME");h.UI=this.UI;h.onclick=function(){this.UI.open("Polygon JSON file",6)};this.menu.sub.pushNode("hr")}h=this.menu.sub.pushNode("div","PDB (PDBj)","molmil_UI_ME");h.UI=this.UI;h.onclick=function(){this.UI.openID(1)};h=this.menu.sub.pushNode("div","PDB chem_comp (PDBj)","molmil_UI_ME");h.UI=this.UI;h.onclick=function(){this.UI.openID(2)};h=this.menu.sub.pushNode("div","Promode Elastic (PDBj)","molmil_UI_ME");h.UI=this.UI;h.onclick=function(){this.UI.openPMEID()}};f=g.appendChild(document.createElement("div"));f.menu=g;f.UI=this;f.className="molmil_UI_ME";f.innerHTML="Save >";f.onclick=function(){molmil_dep.Clear(this.menu.sub);var h;this.menu.sub.style.display="";h=this.menu.sub.pushNode("div","PNG image","molmil_UI_ME");h.UI=this.UI;h.onclick=function(){this.UI.savePNG()};h=this.menu.sub.pushNode("div","MP4 video","molmil_UI_ME");h.UI=this.UI;h.onclick=function(){molmil.initVideo(this.UI)};h=this.menu.sub.pushNode("div","PLY polygon file","molmil_UI_ME");h.UI=this.UI;h.onclick=function(){molmil.exportPLY(this.UI.soup)};h=this.menu.sub.pushNode("div","STL polygon file","molmil_UI_ME");h.UI=this.UI;h.onclick=function(){molmil.exportSTL(this.UI.soup)}};g.pushNode("hr");f=g.appendChild(document.createElement("div"));f.UI=this;f.LM=d;f.className="molmil_UI_ME";f.innerHTML="Settings";f.title="Opens Molmil's advanced settings panel";f.onclick=function(){this.LM.onclick();this.UI.settings()};var c=this.soup.structures.length?this.soup.structures[0].number_of_frames:0;if(c>1){f=g.appendChild(document.createElement("div"));f.menu=g;f.UI=this;f.className="molmil_UI_ME";f.innerHTML="Animation";f.canvas=this.canvas;f.LM=d;f.title="Displays Animation panel, useful for exploring multiple models or playing MD trajectories";f.onclick=function(){this.UI.animationPopUp();this.LM.onclick()};g.pushNode("hr")}if(!molmil_dep.dBT.ios_version){f=g.pushNode("div");f.className="molmil_UI_ME";f.innerHTML="Enable full-screen";f.canvas=this.canvas;f.LM=d;f.title="Enables full screen mode";f.onclick=function(){var h=this.canvas.requestFullScreen||this.canvas.webkitRequestFullScreen||this.canvas.mozRequestFullScreen||this.canvas.msRequestFullscreen||null;if(h){document.molmil_FSC=this.canvas;h.call(this.canvas)}this.LM.onclick()}}f=g.appendChild(document.createElement("div"));f.UI=this;f.className="molmil_UI_ME";f.innerHTML="Toggle CLI";f.title="Toggles between displaying and hiding the Command Line Interface";f.onclick=function(){this.UI.toggleCLI()};f=g.appendChild(document.createElement("div"));f.UI=this;f.className="molmil_UI_ME";f.innerHTML="Clear";f.title="Removes all loaded entries from this canvas";f.onclick=function(){this.UI.clear()};g.pushNode("hr");f=g.appendChild(document.createElement("div"));f.UI=this;f.className="molmil_UI_ME";f.innerHTML="Help";f.LM=d;f.onclick=function(){window.open("https://github.com/gjbekker/molmil/wiki");this.LM.onclick()};d.parentNode.appendChild(g);g.sub=d.parentNode.appendChild(document.createElement("div"));g.sub.className="molmil_UI_LM";g.sub.style.display="none"};molmil.UI.prototype.settings=function(){var c=molmil_dep.dcE("div");c.setClass("molmil_menu_popup");c.pushNode("div","Settings");c.pushNode("hr");var g=molmil_dep.dcE("button"),d;g.qlv=molmil_dep.dcE("input");g.qlv.type="range";g.qlv.min="0";g.qlv.max="4";g.qlv.step="1";g.qlv.value=localStorage.getItem("molmil.settings_QLV");g.qlv.ref=molmil_dep.dcE("span");g.qlv.ref.innerHTML=g.qlv.value;g.qlv.onmousemove=function(){this.ref.innerHTML=this.value};g.bbsf=molmil_dep.dcE("input");g.bbsf.value=molmil.configBox.smoothFactor;g.fog=molmil_dep.dcE("input");g.fog.type="checkbox";g.fog.checked=localStorage.getItem("molmil.settings_glsl_fog")==1;g.projectionMode=molmil_dep.dcE("select");d=g.projectionMode.pushNode("option","Perspective projection");d.value=1;d=g.projectionMode.pushNode("option","Orthographic projection");d.value=2;if(molmil.configBox.projectionMode==2){d.selected=true}g.colorMode=molmil_dep.dcE("select");d=g.colorMode.pushNode("option","Rasmol");d.value=1;d=g.colorMode.pushNode("option","Jmol");d.value=2;if(localStorage.getItem("molmil.settings_COLORS")==2){d.selected=true}d=g.colorMode.pushNode("option","Basic");d.value=3;if(localStorage.getItem("molmil.settings_COLORS")==3){d.selected=true}g.bgcolor=molmil_dep.dcE("span");g.bgcolor.pushNode("span","R: ");g.bgcolor.R=g.bgcolor.pushNode("input");g.bgcolor.pushNode("span"," G: ");g.bgcolor.G=g.bgcolor.pushNode("input");g.bgcolor.pushNode("span"," B: ");g.bgcolor.B=g.bgcolor.pushNode("input");g.bgcolor.pushNode("span"," A: ");g.bgcolor.A=g.bgcolor.pushNode("input");g.bgcolor.R.style.width=g.bgcolor.G.style.width=g.bgcolor.B.style.width=g.bgcolor.A.style.width="2.5em";g.bgcolor.R.value=Math.round(molmil.configBox.BGCOLOR[0]*255);g.bgcolor.G.value=Math.round(molmil.configBox.BGCOLOR[1]*255);g.bgcolor.B.value=Math.round(molmil.configBox.BGCOLOR[2]*255);g.bgcolor.A.value=Math.round(molmil.configBox.BGCOLOR[3]*255);var h=c.pushNode("table"),f,d;f=h.pushNode("tr");f.pushNode("td","Quality:");d=molmil_dep.dcE("div");d.pushNode(g.qlv);d.pushNode(g.qlv.ref);f.pushNode("td").pushNode(d);f=h.pushNode("tr");f.pushNode("td","Sheet/loop backbone smooth factor:");d=molmil_dep.dcE("div");d.pushNode(g.bbsf);f.pushNode("td").pushNode(d);f=h.pushNode("tr");f.pushNode("td","Fog:");d=molmil_dep.dcE("div");d.pushNode(g.fog);f.pushNode("td").pushNode(d);f=h.pushNode("tr");f.pushNode("td","Projection mode:");f.pushNode("td").pushNode(g.projectionMode);f=h.pushNode("tr");f.pushNode("td","Color scheme*:");f.pushNode("td").pushNode(g.colorMode);f.title="Atom (CPK) colors need to be manually re-applied to become effective";f=h.pushNode("tr");f.pushNode("td","BG color:");f.pushNode("td").pushNode(g.bgcolor);c.pushNode("hr");g.innerHTML="Apply";g.UI=this;g.popup=c;g.onclick=function(){localStorage.setItem("molmil.settings_QLV",this.qlv.value);localStorage.setItem("molmil.settings_glsl_fog",(molmil.configBox.glsl_fog=this.fog.checked)?"1":"0");localStorage.setItem("molmil.settings_PROJECTION",this.projectionMode.value);localStorage.setItem("molmil.settings_COLORS",this.colorMode.value);localStorage.setItem("molmil.settings_BGCOLOR",JSON.stringify([parseFloat(this.bgcolor.R.value)/255,parseFloat(this.bgcolor.G.value)/255,parseFloat(this.bgcolor.B.value)/255,parseFloat(this.bgcolor.A.value)/255]));localStorage.setItem("molmil.settings_BBSF",this.bbsf.value);molmil.initSettings();this.UI.soup.reloadSettings();molmil.configBox.projectionMode=this.projectionMode.value;this.UI.soup.renderer.resizeViewPort();molmil.shaderEngine.recompile(this.UI.soup.renderer);this.UI.soup.renderer.initBuffers();this.UI.soup.canvas.update=true;this.popup.parentNode.removeChild(this.popup)};c.pushNode(g);this.LM.parentNode.pushNode(c)};molmil.UI.prototype.toggleWaters=function(c){this.soup.waterToggle(c);this.soup.renderer.initBuffers();this.soup.canvas.update=true;document.body.onmousedown()};molmil.UI.prototype.toggleHydrogens=function(c){this.soup.hydrogenToggle(c);this.soup.renderer.initBuffers();this.soup.canvas.update=true;document.body.onmousedown()};molmil.UI.prototype.animationPopUp=function(){var c=molmil_dep.dcE("div");c.setClass("molmil_menu_popup");c.pushNode("div","Animation controls");c.pushNode("hr");this.soup.animation.initialise(c);if(this.soup.frameInfo){var f=c.pushNode("input");f.type="range";f.value=f.min=0;f.max=this.soup.frameInfo.length;f.soup=this.soup;f.oninput=function(g){this.soup.animation.go2Frame(g.srcElement.valueAsNumber)};c.sliderBox=f;var d=c.pushNode("span",this.soup.frameInfo[0][1]+"ps");c.timeBox=d}else{var f=c.pushNode("input");f.type="range";f.value=f.min=0;f.max=this.soup.chains[0].modelsXYZ.length;f.soup=this.soup;f.oninput=function(g){this.soup.animation.go2Frame(g.srcElement.valueAsNumber)};c.sliderBox=f;var d=c.pushNode("span","0");c.timeBox=d}c.pushNode("br");c.pushNode("span","Motion:");label=c.pushNode("label");inp=label.pushNode("input");inp.type="radio";inp.name="motion";if(this.soup.animation.motionMode==1){inp.checked=true}label.pushNode("span","Forward");label.AI=this.soup.animation;label.onclick=function(){this.AI.motionMode=1};label=c.pushNode("label");inp=label.pushNode("input");inp.type="radio";inp.name="motion";if(this.soup.animation.motionMode==2){inp.checked=true}label.pushNode("span","Backward");label.AI=this.soup.animation;label.onclick=function(){this.AI.motionMode=2};label=c.pushNode("label");inp=label.pushNode("input");inp.type="radio";inp.name="motion";if(this.soup.animation.motionMode==3){inp.checked=true}label.pushNode("span","Swing");label.AI=this.soup.animation;label.onclick=function(){this.AI.motionMode=3};c.pushNode("br");label=c.pushNode("div");label.setClass("unselectableText");label.style.fontStyle="normal";label.style.textAlign="center";inp=label.pushNode("span","|&#8920;");inp.setClass("smallButton");inp.AI=this.soup.animation;inp.onclick=function(){this.AI.beginning()};inp=label.pushNode("span","<");inp.setClass("smallButton");inp.AI=this.soup.animation;inp.onclick=function(){this.AI.previous()};inp=label.pushNode("span","ll");inp.setClass("smallButton");inp.AI=this.soup.animation;inp.onclick=function(){this.AI.pause()};inp=label.pushNode("span","&#9658;");inp.setClass("smallButton");inp.AI=this.soup.animation;inp.onclick=function(){this.AI.play()};inp=label.pushNode("span",">");inp.setClass("smallButton");inp.AI=this.soup.animation;inp.onclick=function(){this.AI.next()};inp=label.pushNode("span","&#8921;|");inp.setClass("smallButton");inp.AI=this.soup.animation;inp.onclick=function(){this.AI.end()};c.close=c.pushNode("button","Close");c.close.style.display="block";c.close.style.marginLeft=c.close.style.marginRight="auto";c.close.onclick=function(){this.popup.parentNode.removeChild(this.popup)};c.close.popup=c;this.LM.parentNode.pushNode(c)};molmil.UI.prototype.resetRM=function(){try{molmil_dep.Clear(this.RM.parentNode.menu);if(this.RM.parentNode.menu.style.display!="none"){this.showRM(this.RM)}}catch(c){}};molmil.UI.prototype.toggleCLI=function(){if(this.LM&&this.LM.parentNode.childNodes.length>1){this.LM.onclick()}if(!this.canvas.commandLine){new molmil.commandLine(this.canvas)}this.canvas.commandLine.icon.onclick();this.resetRM()};molmil.UI.prototype.clear=function(){if(this.LM&&this.LM.parentNode.childNodes.length>1){this.LM.onclick()}var c=molmil_dep.dcE("div");c.setClass("molmil_menu_popup");c.pushNode("div","Do you want to clear all loaded structures?");c.yes=c.pushNode("button","Yes");c.yes.canvas=this.canvas;c.yes.UI=this;c.yes.onclick=function(){if(this.canvas){molmil.clear(this.canvas)}this.UI.resetRM();c.cancel.onclick()};c.cancel=c.pushNode("button","Cancel");c.cancel.onclick=function(){this.popup.parentNode.removeChild(this.popup)};c.cancel.popup=c;this.LM.parentNode.pushNode(c)};molmil.UI.prototype.open=function(g,l,d,o,n){if(this.LM&&this.LM.parentNode.childNodes.length>1){this.LM.onclick()}var f=this.soup;var h=this;var c=molmil_dep.dcE("div");c.setClass("molmil_menu_popup");c.pushNode("div","Open "+g+" file: ");c.inp=c.pushNode("input");c.inp.type="file";c.load=c.pushNode("button","Load");c.load.fileFormat=l;c.settings={};c.load.onclick=function(){if(!c.inp.files.length){return}var p=new FileReader();p.fileFormat=this.fileFormat;p.filename=c.inp.files[0].name;p.onload=function(q){if(this.fileFormat){f.loadStructureData(q.target.result,this.fileFormat,this.filename,function(s,t){h.resetRM();if(d){d(s,t)}else{molmil.displayEntry(t,s.AID>100000?5:1);molmil.colorEntry(t,1,[],true,s)}},c.settings)}else{d(this.filename,q.target.result)}o=null;c.cancel.onclick()};if(n){p.readAsArrayBuffer(c.inp.files[0])}else{p.readAsText(c.inp.files[0])}};c.cancel=c.pushNode("button","Cancel");c.cancel.onclick=function(){this.popup.parentNode.removeChild(this.popup);if(o){o()}};c.cancel.popup=c;if(this.LM){this.LM.parentNode.pushNode(c)}return c};molmil.UI.prototype.openPMEID=function(){if(this.LM&&this.LM.parentNode.childNodes.length>1){this.LM.onclick()}var f=this;var c=molmil_dep.dcE("div");c.setClass("molmil_menu_popup");c.pushNode("div","Promode Elastic");c.pushNode("hr");c.pushNode("span","Display: ");c.dpm1=c.pushNode("label");c.dpm1.inp=c.dpm1.pushNode("input");c.dpm1.inp.type="radio";c.dpm1.inp.name="displayMode";c.dpm1.pushNode("span","Displacement vectors");c.dpm1.inp.checked=true;c.pushNode("br");c.dpm2=c.pushNode("label");c.dpm2.inp=c.dpm2.pushNode("input");c.dpm2.inp.type="radio";c.dpm2.inp.name="displayMode";c.dpm2.pushNode("span","Animation");c.pushNode("br");c.pushNode("span","Mode:").style.paddingRight="1.125em";c.mode=c.pushNode("select");c.mode.style.width="10em";for(var d=0;d<10;d++){c.mode.pushNode("option",d+1)}c.pushNode("br");c.pushNode("span","PDB ID: ");c.inp=c.pushNode("input");c.inp.type="text";c.inp.style.width="10em";c.inp.onkeyup=function(g){if(g.keyCode==13){this.load.onclick()}else{if(g.keyCode==27){this.cancel.onclick()}}};c.pushNode("br");c.pushNode("span","Variant:").style.paddingRight=".25em";c.sel=c.pushNode("select");c.sel.style.width="10em";c.pushNode("br");c.inp.load=c.load=c.pushNode("button","Load");c.load.canvas=this.canvas;c.load.inpBuf=null;c.load.doLoad=function(h){h=h||c.sel.childNodes[c.sel.selectedIndex].innerHTML;var g=c.mode.childNodes[c.mode.selectedIndex].innerHTML;if(c.dpm1.inp.checked){this.canvas.molmilViewer.loadStructure(molmil.settings.promodeE_base_structure_url.replace("__ID__",h),4);this.canvas.molmilViewer.loadStructure(molmil.settings.promodeE_mode_vectors_url.replace("__ID__",h).replace("__MODE__",g),5)}else{this.canvas.molmilViewer.loadStructure(molmil.settings.promodeE_animation_url.replace("__ID__",h).replace("__MODE__",g),4,function(l,n){molmil.displayEntry(n,l.AID>100000?5:1);molmil.colorEntry(n,1);l.animation.motionMode=3;l.animation.play()})}c.cancel.onclick()};c.load.onclick=function(){if(c.inp.value!=this.inpBuf){this.inpBuf=c.inp.value;var g=new molmil_dep.CallRemote("GET");g.ASYNC=true;g.OnDone=function(){molmil_dep.Clear(c.sel);var h=JSON.parse(this.request.responseText);if(h.length==1){return c.load.doLoad(h[0][2])}for(var l=0;l<h.length;l++){c.sel.pushNode("option",h[l][2])}};g.Send(molmil.settings.promodeE_check_url.replace("__ID__",this.inpBuf))}else{if(c.sel.length){c.load.doLoad()}}};c.inp.cancel=c.cancel=c.pushNode("button","Cancel");c.cancel.onclick=function(){this.popup.parentNode.removeChild(this.popup)};c.cancel.popup=c;this.LM.parentNode.pushNode(c);c.inp.focus()};molmil.UI.prototype.openID=function(c){if(this.LM&&this.LM.parentNode.childNodes.length>1){this.LM.onclick()}var h,f;if(c==1){h="PDB ID";f=molmil.settings.pdb_url}else{if(c==2){h="Comp ID";f=molmil.settings.comp_url}else{return}}var g=this;var d=molmil_dep.dcE("div");d.setClass("molmil_menu_popup");d.pushNode("span",h+": ");d.inp=d.pushNode("input");d.inp.type="text";d.inp.onkeyup=function(l){if(l.keyCode==13){this.load.onclick()}else{if(l.keyCode==27){this.cancel.onclick()}}};d.inp.load=d.load=d.pushNode("button","Load");d.load.canvas=this.canvas;d.load.url=f;d.load.onclick=function(){if(!d.inp.value){return}this.canvas.molmilViewer.loadStructure(this.url.replace("__ID__",d.inp.value),1,function(l,n){molmil.displayEntry(n,l.AID>100000?5:1);molmil.colorEntry(n,1,[],true,l);g.resetRM()});d.cancel.onclick()};d.inp.cancel=d.cancel=d.pushNode("button","Cancel");d.cancel.onclick=function(){this.popup.parentNode.removeChild(this.popup)};d.cancel.popup=d;this.LM.parentNode.pushNode(d);d.inp.focus()};molmil.UI.prototype.savePNG=function(){if(this.LM&&this.LM.parentNode.childNodes.length>1){this.LM.onclick()}var c=molmil_dep.dcE("div");c.setClass("molmil_menu_popup");c.pushNode("span"," ");c.range=c.pushNode("input");c.range.type="range";c.range.min="0.25";c.range.max="4";c.range.step=".25";c.range.value="1.0";c.range.onmousemove=function(){this.nfo.innerHTML=(this.canvas.width*this.value)+"px x "+(this.canvas.height*this.value)+"px"};c.range.nfo=c.pushNode("span");c.range.nfo.style.display="inline-block";c.save=c.pushNode("button","Save");c.range.canvas=c.save.canvas=this.canvas;c.save.onclick=function(){var h=parseInt(c.range.value);if(h!=1){var g=this.canvas.width;var d=this.canvas.height;var f=molmil.configBox.BGCOLOR[3];this.canvas.width*=h;this.canvas.height*=h;molmil.configBox.BGCOLOR[3]=0;this.canvas.renderer.selectDataContext();this.canvas.renderer.resizeViewPort();this.canvas.update=true;this.canvas.renderer.render();this.canvas.toBlob(function(l){saveAs(l,"image.png")});this.canvas.renderer.selectDefaultContext();this.canvas.width=g;this.canvas.height=d;molmil.configBox.BGCOLOR[3]=f;this.canvas.renderer.resizeViewPort();this.canvas.update=true;this.canvas.renderer.render()}else{var f=molmil.configBox.BGCOLOR[3];molmil.configBox.BGCOLOR[3]=0;this.canvas.renderer.selectDataContext();this.canvas.update=true;this.canvas.renderer.render();this.canvas.toBlob(function(l){saveAs(l,"image.png")});this.canvas.renderer.selectDefaultContext();molmil.configBox.BGCOLOR[3]=f;this.canvas.update=true;this.canvas.renderer.render()}c.cancel.onclick()};c.cancel=c.pushNode("button","Cancel");c.cancel.onclick=function(){this.popup.parentNode.removeChild(this.popup)};c.cancel.popup=c;c.range.onmousemove();this.LM.parentNode.pushNode(c)};molmil.UI.prototype.videoRenderer=function(){if(this.LM&&this.LM.parentNode.childNodes.length>1){this.LM.onclick()}var d=null;var f=null;this.canvas.renderer.onRenderFinish=function(){if(!d){return}if(f==null){f=new Uint8Array(this.canvas.width*this.canvas.width*4)}var g=new molmil_dep.CallRemote("POST");g.AddParameter("id",d);g.AddParameter("data",canvas.toDataURL());this.canvas.renderer.gl.readPixels(0,0,this.canvas.width,this.canvas.width,this.canvas.renderer.gl.RGBA,this.canvas.renderer.gl.UNSIGNED_BYTE,f);g.Send(molmil.settings.molmil_video_url+"addFrame")};var c=molmil_dep.dcE("div");c.setClass("molmil_menu_popup");c.preview=c.pushNode("button","Play & Preview");c.pushNode("br");c.record=c.pushNode("button","Play & Record");c.pushNode("br");c.canvas=c.preview.canvas=c.record.canvas=this.canvas;c.preview.popup=c.record.popup=c;c.preview.onclick=function(){d=null;this.canvas.molmilViewer.animation.beginning();this.canvas.molmilViewer.animation.play()};c.endVideo=function(){if(this.canvas.molmilViewer.animation.playing){molmil_dep.asyncStart(this.endVideo,[],this,250)}else{var g=new molmil_dep.CallRemote("GET");g.AddParameter("id",d);g.Send(molmil.settings.molmil_video_url+"deInitVideo");console.log(molmil.settings.molmil_video_url+"getVideo?id="+d);window.open(molmil.settings.molmil_video_url+"getVideo?id="+d);d=null}};c.record.onclick=function(){var g=new molmil_dep.CallRemote("GET");g.AddParameter("w",this.canvas.width);g.AddParameter("h",this.canvas.height);g.Send(molmil.settings.molmil_video_url+"initVideo");d=g.request.responseText;this.canvas.molmilViewer.animation.beginning();this.canvas.molmilViewer.animation.play();this.popup.endVideo()};c.cancel=c.pushNode("button","Cancel");c.cancel.canvas=this.canvas;c.cancel.onclick=function(){this.canvas.molmilViewer.animation.end();this.popup.endVideo();this.popup.parentNode.removeChild(this.popup)};c.cancel.popup=c;this.LM.parentNode.pushNode(c)};molmil.toggleEntry=function(n,f,l,g){g=g||molmil.cli_soup;var c,d,h;if(n instanceof molmil.entryObject){for(c=0;c<n.molecules.length;c++){h=n.molecules[c];if(!h.ligand&&!h.water){for(d=0;d<h.atoms.length;d++){h.atoms[d].status=f}}h.status=f}}else{if(n instanceof molmil.chainObject){for(c=0;c<n.molecules.length;c++){h=n.molecules[c];for(d=0;d<h.atoms.length;d++){h.atoms[d].status=f}h.status=f}}else{if(n instanceof molmil.molObject){for(d=0;d<n.atoms.length;d++){n.atoms[d].status=f}n.status=f}else{if(n instanceof molmil.atomObject){n.status=false}else{if(n instanceof polygonObject){n.display=f}else{return}}}}}if(l){g.renderer.initBuffers();g.renderer.canvas.update=true}};molmil.displayEntry=function(n,p,f,q){q=q||molmil.cli_soup;if(n instanceof Array){for(var o=0;o<n.length;o++){molmil.displayEntry(n[o],p)}if(f){q.renderer.initBuffers();q.renderer.canvas.update=true}return}if(q&&((q.SCstuff&&p%1==0)||(!q.SCstuff&&p%1!=0))){molmil.geometry.reInitChains=true}var g,u,s,d,l,t=molmil.configBox.backboneAtoms4Display,w=molmil.configBox.backboneAtoms4DisplayXNA,h=molmil.configBox.xna_simple_base_atoms,x;if(n instanceof molmil.entryObject){if(p==molmil.displayMode_None){for(s=0;s<n.chains.length;s++){d=n.chains[s];d.displayMode=0;for(var u=0;u<d.atoms.length;u++){d.atoms[u].displayMode=0}for(var g=0;g<d.molecules.length;g++){d.molecules[g].displayMode=0;d.molecules[g].showSC=false}}}else{if(p==molmil.displayMode_Default){for(s=0;s<n.chains.length;s++){d=n.chains[s];d.displayMode=3;for(g=0;g<d.molecules.length;g++){l=d.molecules[g];if(l.ligand||l.water){for(u=0;u<l.atoms.length;u++){l.atoms[u].displayMode=3}}else{if(l.xna){for(u=0;u<l.atoms.length;u++){l.atoms[u].displayMode=h.hasOwnProperty(l.atoms[u].atomName)||l.atoms[u].element=="H"?0:3}}else{if(l.weirdAA){for(u=0;u<l.atoms.length;u++){if(t.hasOwnProperty(l.atoms[u].atomName)){l.atoms[u].displayMode=0}else{l.atoms[u].displayMode=3}}}else{for(u=0;u<l.atoms.length;u++){l.atoms[u].displayMode=0}}}}l.displayMode=3;l.showSC=l.weirdAA}}molmil.geometry.reInitChains=true}else{if(p==molmil.displayMode_Spacefill){for(s=0;s<n.chains.length;s++){d=n.chains[s];d.displayMode=1;for(var u=0;u<d.atoms.length;u++){d.atoms[u].displayMode=1}for(var g=0;g<d.molecules.length;g++){d.molecules[g].displayMode=0;d.molecules[g].showSC=true;d.twoDcache=null}}}else{if(p==molmil.displayMode_Spacefill_SC){for(s=0;s<n.chains.length;s++){d=n.chains[s];for(var u=0;u<d.atoms.length;u++){if(d.atoms[u].molecule.xna){x=w}else{x=t}if(!d.atoms[u].molecule.ligand&&!d.atoms[u].molecule.water&&x.hasOwnProperty(d.atoms[u].atomName)){d.atoms[u].displayMode=0}else{d.atoms[u].displayMode=1}}for(var g=0;g<d.molecules.length;g++){d.molecules[g].showSC=true;d.twoDcache=null}}}else{if(p==molmil.displayMode_BallStick){for(s=0;s<n.chains.length;s++){d=n.chains[s];d.displayMode=1;for(var u=0;u<d.atoms.length;u++){d.atoms[u].displayMode=2}for(var g=0;g<d.molecules.length;g++){d.molecules[g].displayMode=0;d.molecules[g].showSC=true;d.twoDcache=null}}}else{if(p==molmil.displayMode_BallStick_SC){for(s=0;s<n.chains.length;s++){d=n.chains[s];for(var u=0;u<d.atoms.length;u++){if(d.atoms[u].molecule.xna){x=w}else{x=t}if(!d.atoms[u].molecule.ligand&&!d.atoms[u].molecule.water&&x.hasOwnProperty(d.atoms[u].atomName)){d.atoms[u].displayMode=0}else{d.atoms[u].displayMode=2}}for(var g=0;g<d.molecules.length;g++){d.molecules[g].showSC=true;d.twoDcache=null}}}else{if(p==molmil.displayMode_Stick){for(s=0;s<n.chains.length;s++){d=n.chains[s];d.displayMode=1;for(var u=0;u<d.atoms.length;u++){d.atoms[u].displayMode=3}for(var g=0;g<d.molecules.length;g++){d.molecules[g].displayMode=0;d.molecules[g].showSC=true;d.twoDcache=null}}}else{if(p==molmil.displayMode_Stick_SC){for(s=0;s<n.chains.length;s++){d=n.chains[s];for(var u=0;u<d.atoms.length;u++){if(d.atoms[u].molecule.xna){x=w}else{x=t}if(!d.atoms[u].molecule.ligand&&!d.atoms[u].molecule.water&&x.hasOwnProperty(d.atoms[u].atomName)){d.atoms[u].displayMode=0}else{d.atoms[u].displayMode=3}}for(var g=0;g<d.molecules.length;g++){d.molecules[g].showSC=true;d.twoDcache=null}}}else{if(p==molmil.displayMode_Wireframe){for(s=0;s<n.chains.length;s++){d=n.chains[s];d.displayMode=1;for(var u=0;u<d.atoms.length;u++){d.atoms[u].displayMode=4}for(var g=0;g<d.molecules.length;g++){d.molecules[g].displayMode=0;d.molecules[g].showSC=true;d.twoDcache=null}}}else{if(p==molmil.displayMode_Wireframe_SC){for(s=0;s<n.chains.length;s++){d=n.chains[s];for(var u=0;u<d.atoms.length;u++){if(d.atoms[u].molecule.xna){x=w}else{x=t}if(!d.atoms[u].molecule.ligand&&!d.atoms[u].molecule.water&&x.hasOwnProperty(d.atoms[u].atomName)){d.atoms[u].displayMode=0}else{d.atoms[u].displayMode=4}}for(var g=0;g<d.molecules.length;g++){d.molecules[g].showSC=true;d.twoDcache=null}}}else{if(p==molmil.displayMode_CaTrace){for(s=0;s<n.chains.length;s++){d=n.chains[s];d.displayMode=1;for(g=0;g<d.molecules.length;g++){l=d.molecules[g];if(!l.ligand&&!l.water){for(u=0;u<l.atoms.length;u++){l.atoms[u].displayMode=0}}l.displayMode=1;l.showSC=false}}}else{if(p==molmil.displayMode_Tube){for(s=0;s<n.chains.length;s++){d=n.chains[s];d.displayMode=2;for(g=0;g<d.molecules.length;g++){l=d.molecules[g];if(!l.ligand&&!l.water){for(u=0;u<l.atoms.length;u++){l.atoms[u].displayMode=0}}l.displayMode=2;l.showSC=false}}}else{if(p==molmil.displayMode_Cartoon){for(s=0;s<n.chains.length;s++){d=n.chains[s];d.displayMode=3;for(g=0;g<d.molecules.length;g++){l=d.molecules[g];if(!l.ligand&&!l.water){for(u=0;u<l.atoms.length;u++){l.atoms[u].displayMode=0}}l.displayMode=3;l.showSC=false}}}else{if(p==molmil.displayMode_CartoonRocket){for(s=0;s<n.chains.length;s++){d=n.chains[s];d.displayMode=3;d.twoDcache=null;for(g=0;g<d.molecules.length;g++){l=d.molecules[g];if(!l.ligand&&!l.water){for(u=0;u<l.atoms.length;u++){l.atoms[u].displayMode=0}}l.displayMode=31;l.showSC=false}}}else{if(p==molmil.displayMode_ChainSurfaceCG){for(s=0;s<n.chains.length;s++){d=n.chains[s];d.displayMode=molmil.displayMode_ChainSurfaceCG}}}}}}}}}}}}}}}}}else{if(n instanceof molmil.chainObject){if(p==molmil.displayMode_None){n.display=false;n.displayMode=0;for(g=0;g<n.molecules.length;g++){l=n.molecules[g];l.displayMode=0;for(u=0;u<l.atoms.length;u++){l.atoms[u].displayMode=0}l.showSC=false}}else{if(p==molmil.displayMode_Default){n.displayMode=3;for(g=0;g<n.molecules.length;g++){l=n.molecules[g];if(l.ligand&&!l.water){for(u=0;u<l.atoms.length;u++){l.atoms[u].displayMode=3}}else{if(l.xna){for(u=0;u<l.atoms.length;u++){l.atoms[u].displayMode=h.hasOwnProperty(l.atoms[u].atomName)||l.atoms[u].element=="H"?0:3}}else{for(u=0;u<l.atoms.length;u++){l.atoms[u].displayMode=0}}}l.displayMode=3;l.showSC=false}}else{if(p==molmil.displayMode_Spacefill){n.displayMode=1;for(g=0;g<n.molecules.length;g++){l=n.molecules[g];l.displayMode=0;for(u=0;u<l.atoms.length;u++){l.atoms[u].displayMode=1}l.showSC=true;l.chain.twoDcache=null}}else{if(p==molmil.displayMode_Spacefill_SC){for(g=0;g<n.molecules.length;g++){l=n.molecules[g];for(u=0;u<l.atoms.length;u++){if(l.xna){x=w}else{x=t}if(!l.ligand&&!l.water&&x.hasOwnProperty(l.atoms[u].atomName)){l.atoms[u].displayMode=0}else{l.atoms[u].displayMode=1}}l.showSC=true;l.chain.twoDcache=null}}else{if(p==molmil.displayMode_BallStick){n.displayMode=1;for(g=0;g<n.molecules.length;g++){l=n.molecules[g];l.displayMode=0;for(u=0;u<l.atoms.length;u++){l.atoms[u].displayMode=2}l.showSC=true;l.chain.twoDcache=null}}else{if(p==molmil.displayMode_BallStick_SC){for(g=0;g<n.molecules.length;g++){l=n.molecules[g];for(u=0;u<l.atoms.length;u++){if(l.xna){x=w}else{x=t}if(!l.ligand&&!l.water&&x.hasOwnProperty(l.atoms[u].atomName)){l.atoms[u].displayMode=0}else{l.atoms[u].displayMode=2}}l.showSC=true;l.chain.twoDcache=null}}else{if(p==molmil.displayMode_Stick){n.displayMode=1;for(g=0;g<n.molecules.length;g++){l=n.molecules[g];l.displayMode=0;for(u=0;u<l.atoms.length;u++){l.atoms[u].displayMode=3}l.showSC=true;l.chain.twoDcache=null}}else{if(p==molmil.displayMode_Stick_SC){for(g=0;g<n.molecules.length;g++){l=n.molecules[g];for(u=0;u<l.atoms.length;u++){if(l.xna){x=w}else{x=t}if(!l.ligand&&!l.water&&x.hasOwnProperty(l.atoms[u].atomName)){l.atoms[u].displayMode=0}else{l.atoms[u].displayMode=3}}l.showSC=true;l.chain.twoDcache=null}}else{if(p==molmil.displayMode_Wireframe){n.displayMode=1;for(g=0;g<n.molecules.length;g++){l=n.molecules[g];l.displayMode=0;for(u=0;u<l.atoms.length;u++){l.atoms[u].displayMode=4}l.showSC=true;l.chain.twoDcache=null}}else{if(p==molmil.displayMode_Wireframe_SC){n.displayMode=1;for(g=0;g<n.molecules.length;g++){l=n.molecules[g];for(u=0;u<l.atoms.length;u++){if(l.xna){x=w}else{x=t}if(!l.ligand&&!l.water&&x.hasOwnProperty(l.atoms[u].atomName)){l.atoms[u].displayMode=0}else{l.atoms[u].displayMode=4}}l.showSC=true;l.chain.twoDcache=null}}else{if(p==molmil.displayMode_CaTrace){n.displayMode=1;for(g=0;g<n.molecules.length;g++){l=n.molecules[g];if(!l.ligand&&!l.water){for(u=0;u<l.atoms.length;u++){l.atoms[u].displayMode=0}}l.displayMode=1;l.showSC=false}}else{if(p==molmil.displayMode_Tube){n.displayMode=2;for(g=0;g<n.molecules.length;g++){l=n.molecules[g];if(!l.ligand&&!l.water){for(u=0;u<l.atoms.length;u++){l.atoms[u].displayMode=0}}l.displayMode=2;l.showSC=false}}else{if(p==molmil.displayMode_Cartoon){if(n.displayMode==3){n.twoDcache=null}n.displayMode=3;for(g=0;g<n.molecules.length;g++){l=n.molecules[g];if(!l.ligand&&!l.water){for(u=0;u<l.atoms.length;u++){l.atoms[u].displayMode=0}}l.displayMode=3;l.showSC=false}}else{if(p==molmil.displayMode_CartoonRocket){if(n.displayMode==3){n.twoDcache=null}n.displayMode=3;for(g=0;g<n.molecules.length;g++){l=n.molecules[g];if(!l.ligand&&!l.water){for(u=0;u<l.atoms.length;u++){l.atoms[u].displayMode=0}}l.displayMode=31;l.showSC=false}}else{if(p==molmil.displayMode_ChainSurfaceCG){n.displayMode=molmil.displayMode_ChainSurfaceCG}}}}}}}}}}}}}}}}else{if(n instanceof molmil.molObject){if(p==molmil.displayMode_None){for(u=0;u<n.atoms.length;u++){n.atoms[u].displayMode=0}}else{if(p==molmil.displayMode_Default){if(n.ligand||n.water){for(u=0;u<n.atoms.length;u++){n.atoms[u].displayMode=3}}else{if(n.xna){for(u=0;u<n.atoms.length;u++){n.atoms[u].displayMode=h.hasOwnProperty(n.atoms[u].atomName)||n.atoms[u].element=="H"?0:3}}else{for(u=0;u<n.atoms.length;u++){n.atoms[u].displayMode=0}}}n.displayMode=3;n.showSC=false}else{if(p==molmil.displayMode_Spacefill){for(u=0;u<n.atoms.length;u++){n.atoms[u].displayMode=1}n.showSC=true;n.chain.twoDcache=null}else{if(p==molmil.displayMode_Spacefill_SC){for(u=0;u<n.atoms.length;u++){if(n.xna){x=w}else{x=t}if(!n.ligand&&!n.water&&x.hasOwnProperty(n.atoms[u].atomName)){n.atoms[u].displayMode=0}else{n.atoms[u].displayMode=1}}n.showSC=true;n.chain.twoDcache=null}else{if(p==molmil.displayMode_BallStick){for(u=0;u<n.atoms.length;u++){n.atoms[u].displayMode=2}n.showSC=true;n.chain.twoDcache=null}else{if(p==molmil.displayMode_BallStick_SC){for(u=0;u<n.atoms.length;u++){if(n.xna){x=w}else{x=t}if(!n.ligand&&!n.water&&x.hasOwnProperty(n.atoms[u].atomName)){n.atoms[u].displayMode=0}else{n.atoms[u].displayMode=2}}n.showSC=true;n.chain.twoDcache=null}else{if(p==molmil.displayMode_Stick){for(u=0;u<n.atoms.length;u++){n.atoms[u].displayMode=3}n.showSC=true;n.chain.twoDcache=null}else{if(p==molmil.displayMode_Stick_SC){for(u=0;u<n.atoms.length;u++){if(n.xna){x=w}else{x=t}if(!n.ligand&&!n.water&&x.hasOwnProperty(n.atoms[u].atomName)){n.atoms[u].displayMode=0}else{n.atoms[u].displayMode=3}}n.showSC=true;n.chain.twoDcache=null}else{if(p==molmil.displayMode_Wireframe){for(u=0;u<n.atoms.length;u++){n.atoms[u].displayMode=4}n.showSC=true;n.chain.twoDcache=null}else{if(p==molmil.displayMode_Wireframe_SC){for(u=0;u<n.atoms.length;u++){if(n.xna){x=w}else{x=t}if(!n.ligand&&!n.water&&x.hasOwnProperty(n.atoms[u].atomName)){n.atoms[u].displayMode=0}else{n.atoms[u].displayMode=4}}n.showSC=true;n.chain.twoDcache=null}else{if(p==molmil.displayMode_CaTrace){if(!n.ligand&&!n.water){for(u=0;u<n.atoms.length;u++){n.atoms[u].displayMode=0}}n.displayMode=1;n.showSC=false}else{if(p==molmil.displayMode_Tube){if(!n.ligand&&!n.water){for(u=0;u<n.atoms.length;u++){n.atoms[u].displayMode=0}}n.displayMode=2;n.showSC=false}else{if(p==molmil.displayMode_Cartoon){if(!n.ligand&&!n.water){for(u=0;u<n.atoms.length;u++){n.atoms[u].displayMode=0}}n.displayMode=3;n.showSC=false}else{if(p==molmil.displayMode_Cartoon){if(!n.ligand&&!n.water){for(u=0;u<n.atoms.length;u++){n.atoms[u].displayMode=0}}n.displayMode=31;n.showSC=false}}}}}}}}}}}}}}}else{if(n instanceof molmil.atomObject){if(p==molmil.displayMode_Spacefill){n.displayMode=1}else{if(p==molmil.displayMode_BallStick){n.displayMode=2}else{if(p==molmil.displayMode_Stick){n.displayMode=3}else{if(p==molmil.displayMode_Wireframe){n.displayMode=4}}}}}else{if(n instanceof molmil.polygonObject){n.display=p?true:false}}}}}if(f){q.renderer.initBuffers();q.renderer.canvas.update=true}};molmil.colorEntry=function(n,u,w,f,p){p=p||molmil.cli_soup;if(n instanceof Array){for(var o=0;o<n.length;o++){molmil.colorEntry(n[o],u,w,null,p)}if(f){p.renderer.initBuffers();p.renderer.canvas.update=true}return}var g,t,s,d,l,s,d,q;if(n instanceof molmil.entryObject){if(u==molmil.colorEntry_Default){for(s=0;s<n.chains.length;s++){d=n.chains[s];d.rgba=[255,255,255,255];for(g=0;g<d.molecules.length;g++){l=d.molecules[g];l.rgba=molmil_dep.getKeyFromObject(molmil.configBox.sndStrucColor,l.sndStruc,molmil.configBox.sndStrucColor[1]);for(t=0;t<l.atoms.length;t++){l.atoms[t].rgba=molmil_dep.getKeyFromObject(molmil.configBox.elementColors,l.atoms[t].element,molmil.configBox.elementColors.DUMMY)}}}}else{if(u==molmil.colorEntry_Structure){for(s=0;s<n.chains.length;s++){d=n.chains[s];for(g=0;g<d.molecules.length;g++){l=d.molecules[g];l.rgba=molmil_dep.getKeyFromObject(molmil.configBox.sndStrucColor,l.sndStruc,molmil.configBox.sndStrucColor[1]);for(t=0;t<l.atoms.length;t++){l.atoms[t].rgba=l.rgba}}}}else{if(u==molmil.colorEntry_CPK){for(s=0;s<n.chains.length;s++){d=n.chains[s];for(g=0;g<d.molecules.length;g++){l=d.molecules[g];for(t=0;t<l.atoms.length;t++){l.atoms[t].rgba=molmil_dep.getKeyFromObject(molmil.configBox.elementColors,l.atoms[t].element,molmil.configBox.elementColors.DUMMY)}l.rgba=molmil_dep.getKeyFromObject(molmil.configBox.elementColors,"C",molmil.configBox.elementColors.DUMMY)}}}else{if(u==molmil.colorEntry_Group){q=[];for(s=0;s<n.chains.length;s++){d=n.chains[s];if(d.molecules.length>1){q=molmil.interpolateBR(d.molecules.length)}else{q=[[0,0,255,255]]}for(g=0;g<d.molecules.length;g++){l=d.molecules[g];l.rgba=q[g];for(t=0;t<l.atoms.length;t++){l.atoms[t].rgba=q[g]}}}}else{if(u==molmil.colorEntry_Chain){q=molmil.interpolateBR(n.chains.length);for(s=0;s<n.chains.length;s++){d=n.chains[s];d.rgba=q[s];for(g=0;g<d.molecules.length;g++){l=d.molecules[g];l.rgba=q[s];for(t=0;t<l.atoms.length;t++){l.atoms[t].rgba=q[s]}}}}else{if(u==molmil.colorEntry_Custom){for(s=0;s<n.chains.length;s++){d=n.chains[s];d.rgba=w;for(g=0;g<d.molecules.length;g++){l=d.molecules[g];l.rgba=w;for(t=0;t<l.atoms.length;t++){l.atoms[t].rgba=w}}}}else{if(u==molmil.colorEntry_ChainAlt){q=molmil.configBox.bu_colors;var h=0;for(s=0;s<n.chains.length;s++){d=n.chains[s];d.rgba=[q[h][0],q[h][1],q[h][2],255];h++;for(g=0;g<d.molecules.length;g++){l=d.molecules[g];l.rgba=n.chains[s].rgba;for(t=0;t<l.atoms.length;t++){l.atoms[t].rgba=n.chains[s].rgba}}if(h>=q.length){h=0}}}else{if(u==molmil.colorEntry_ABEGO){for(s=0;s<n.chains.length;s++){d=n.chains[s];d.rgba=[255,255,255,255];if(d.isHet){continue}if(d.molecules[0].phiAngle==undefined){molmil.calculateBBTorsions(d,p)}for(g=0;g<d.molecules.length;g++){l=d.molecules[g];l.rgba=[255,255,255,255];if(l.omegaAngle<45&&l.omegaAngle>-45){l.rgba=[128,128,128,255]}else{if(l.phiAngle<0){if(l.psiAngle>50||l.psiAngle<-75){l.rgba=[0,0,255,255]}else{l.rgba=[255,0,0,255]}}else{if(l.psiAngle>100||l.psiAngle<-100){l.rgba=[255,255,0,255]}else{l.rgba=[0,255,0,255]}}}for(t=0;t<l.atoms.length;t++){l.atoms[t].rgba=l.rgba}}}}}}}}}}}}else{if(n instanceof molmil.chainObject){if(u==molmil.colorEntry_Default){n.rgba=[255,255,255,255];for(g=0;g<n.molecules.length;g++){l=n.molecules[g];l.rgba=molmil_dep.getKeyFromObject(molmil.configBox.sndStrucColor,l.sndStruc,molmil.configBox.sndStrucColor[1]);for(t=0;t<l.atoms.length;t++){l.atoms[t].rgba=molmil_dep.getKeyFromObject(molmil.configBox.elementColors,l.atoms[t].element,molmil.configBox.elementColors.DUMMY)}}}else{if(u==molmil.colorEntry_Structure){for(g=0;g<n.molecules.length;g++){l=n.molecules[g];l.rgba=molmil_dep.getKeyFromObject(molmil.configBox.sndStrucColor,l.sndStruc,molmil.configBox.sndStrucColor[1]);for(t=0;t<l.atoms.length;t++){l.atoms[t].rgba=l.rgba}}}else{if(u==molmil.colorEntry_CPK){for(g=0;g<n.molecules.length;g++){l=n.molecules[g];for(t=0;t<l.atoms.length;t++){l.atoms[t].rgba=molmil_dep.getKeyFromObject(molmil.configBox.elementColors,l.atoms[t].element,molmil.configBox.elementColors.DUMMY)}l.rgba=molmil_dep.getKeyFromObject(molmil.configBox.elementColors,"C",molmil.configBox.elementColors.DUMMY)}}else{if(u==molmil.colorEntry_Group){q=[];d=n;if(d.molecules.length>1){q=molmil.interpolateBR(d.molecules.length)}else{q=[[1,1,1]]}for(g=0;g<d.molecules.length;g++){l=d.molecules[g];l.rgba=q[g];for(t=0;t<l.atoms.length;t++){l.atoms[t].rgba=q[g]}}}else{if(u==molmil.colorEntry_Custom){n.rgba=w;for(g=0;g<n.molecules.length;g++){l=n.molecules[g];l.rgba=w;for(t=0;t<l.atoms.length;t++){l.atoms[t].rgba=w}}}else{if(u==molmil.colorEntry_ABEGO&&!n.isHet){d=n;d.rgba=[255,255,255,255];if(d.molecules[0].phiAngle==undefined){molmil.calculateBBTorsions(d,p)}for(g=0;g<d.molecules.length;g++){l=d.molecules[g];l.rgba=[255,255,255,255];if(l.omegaAngle<45&&l.omegaAngle>-45){l.rgba=[128,128,128,255]}else{if(l.phiAngle<0){if(l.psiAngle>50||l.psiAngle<-75){l.rgba=[0,0,255,255]}else{l.rgba=[255,0,0,255]}}else{if(l.psiAngle>100||l.psiAngle<-100){l.rgba=[255,255,0,255]}else{l.rgba=[0,255,0,255]}}}for(t=0;t<l.atoms.length;t++){l.atoms[t].rgba=l.rgba}}}}}}}}}else{if(n instanceof molmil.molObject){if(u==molmil.colorEntry_Default){l=n;l.rgba=molmil_dep.getKeyFromObject(molmil.configBox.sndStrucColor,l.sndStruc,molmil.configBox.sndStrucColor[1]);for(t=0;t<l.atoms.length;t++){l.atoms[t].rgba=molmil_dep.getKeyFromObject(molmil.configBox.elementColors,l.atoms[t].element,molmil.configBox.elementColors.DUMMY)}}else{if(u==molmil.colorEntry_Structure){l=n;l.rgba=molmil_dep.getKeyFromObject(molmil.configBox.sndStrucColor,l.sndStruc,molmil.configBox.sndStrucColor[1]);for(t=0;t<l.atoms.length;t++){l.atoms[t].rgba=l.rgba}}else{if(u==molmil.colorEntry_CPK){l=n;for(t=0;t<l.atoms.length;t++){l.atoms[t].rgba=molmil_dep.getKeyFromObject(molmil.configBox.elementColors,l.atoms[t].element,molmil.configBox.elementColors.DUMMY)}l.rgba=molmil_dep.getKeyFromObject(molmil.configBox.elementColors,"C",molmil.configBox.elementColors.DUMMY)}else{if(u==3.2){l=n;for(t=0;t<l.atoms.length;t++){l.atoms[t].rgba=molmil_dep.getKeyFromObject(molmil.configBox.elementColors,l.atoms[t].element,molmil.configBox.elementColors.DUMMY)}}else{if(u==molmil.colorEntry_Custom){n.rgba=w;for(t=0;t<n.atoms.length;t++){n.atoms[t].rgba=n.rgba}}}}}}}else{if(n instanceof molmil.atomObject){if(u==molmil.colorEntry_Default||u==molmil.colorEntry_CPK){n.rgba=molmil_dep.getKeyFromObject(molmil.configBox.elementColors,n.element,molmil.configBox.elementColors.DUMMY)}else{if(u==molmil.colorEntry_Structure){l=n.molecule;n.rgba=molmil_dep.getKeyFromObject(molmil.configBox.sndStrucColor,l.sndStruc,molmil.configBox.sndStrucColor[1])}else{if(u==molmil.colorEntry_Custom){n.rgba=w}}}}else{if(n instanceof molmil.polygonObject){}else{return}}}}}if(f){p.renderer.initBuffers();p.renderer.canvas.update=true}};molmil.getAtomFromMolecule=function(c,f){for(var d=0;d<c.atoms.length;d++){if(c.atoms[d].atomName==f){return c.atoms[d]}}return null};molmil.resetColors=function(l,g){g=g||molmil.cli_soup;for(var d=0,f,o,n,h;d<g.structures.length;d++){if(l&&g.structures[d]!=l){continue}if(!g.structures[d].chains){continue}for(o=0;o<g.structures[d].chains.length;o++){h=g.structures[d].chains[o];for(f=0;f<h.atoms.length;f++){h.atoms[f].rgba=molmil_dep.getKeyFromObject(molmil.configBox.elementColors,h.atoms[f].element,molmil.configBox.elementColors.DUMMY)}for(n=0;n<h.molecules.length;n++){h.molecules[n].rgba=molmil_dep.getKeyFromObject(molmil.configBox.sndStrucColor,h.molecules[n].sndStruc,molmil.configBox.sndStrucColor[1])}}}};molmil.fetchFrom=function(g,f){var c=[],d;if(g instanceof Array){for(d=0;d<g.length;d++){c=c.concat(molmil.getProteinChains(g[d],f))}}else{if(g instanceof molmil.atomObject){if(f==molmil.molObject){c.push(g.molecule)}else{if(f==molmil.chainObject){c.push(g.chain)}else{if(f==molmil.entryObject){c.push(g.chain.entry)}}}}else{if(g instanceof molmil.molObject){if(f==molmil.atomObject){c=c.concat(g.atoms)}else{if(f==molmil.chainObject){c.push(g.chain)}else{if(f==molmil.entryObject){c.push(g.chain.entry)}}}}else{if(g instanceof molmil.chainObject){if(f==molmil.atomObject){c=c.concat(g.atoms)}else{if(f==molmil.molObject){c=c.concat(g.molecules)}else{if(f==molmil.entryObject){c.push(g.entry)}}}}else{if(g instanceof molmil.entryObject){if(f==molmil.atomObject){for(d=0;d<g.chains.length;d++){c=c.concat(g.atoms[d])}}else{if(f==molmil.molObject){for(d=0;d<g.chains.length;d++){c=c.concat(g.molecules[d])}}else{if(f==molmil.chainObject){c=c.concat(g.chains)}}}}}}}}return c.unique()};molmil.getProteinChains=function(g){var d=[];if(g instanceof Array){for(var f=0;f<g.length;f++){d=d.concat(molmil.getProteinChains(g[f]))}}else{if(g instanceof molmil.entryObject){for(var h=0;h<g.chains.length;h++){if(!g.chains[h].isHet&&g.chains[h].molecules.length&&!g.chains[h].molecules[0].water){d.push(g.chains[h])}}}else{if(g instanceof molmil.chainObj){if(!g.isHet&&g.molecules.length&&!g.molecules[0].water){d.push(g)}}}}return d};molmil.setCanvas=function(d,c){d.canvas=c;if(!c.renderer){d.renderer=c.renderer=new molmil.render(d)}};molmil.initTexture=function(d){var c=this.gl.createTexture();c.image=new Image();c.image.texture=c;c.loaded=false;c.image.onload=function(){molmil.handleLoadedTexture(this.texture)};c.image.src=d;return c};molmil.handleLoadedTexture=function(c){this.gl.bindTexture(this.gl.TEXTURE_2D,c);this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,true);this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,c.image);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE);this.gl.bindTexture(this.gl.TEXTURE_2D,null);c.loaded=true};molmil.safeStartViewer=function(c){for(var d in c.textures){if(!c.textures[d].loaded){return molmil_dep.asyncStart(molmil.safeStartViewer,[c],null,100)}}molmil.canvasList.push(c);if(document.body.classList!==undefined){document.body.classList.add("entryLoaded")}};molmil.animate_molmilViewers=function(){molmil.settings.animationFrameID=requestAnimationFrame(molmil.animate_molmilViewers);for(var d=0;d<molmil.canvasList.length;d++){molmil.canvasList[d].renderer.render()}};molmil.unproject=function(d,c,g,f){d=2*d-1;c=2*c-1;g=2*g-1;var h=[d,c,g,1];vec4.transformMat4(h,h,f);h[3]=1/h[3];return[h[0]*h[3],h[1]*h[3],h[2]*h[3]]};molmil.hermiteInterpolate=function(d,c,p,n,g,B,u,x){var z,A,y,w,q,o,l,h,f;for(z=0;z<(g+(x?2:1));z+=1){A=z/(g+1);y=A*A;w=y*A;q=2*w-3*y+1;o=-2*w+3*y;l=w-2*y+A;h=w-y;B.push([(d[0]*q)+(c[0]*o)+(p[0]*l)+(n[0]*h),(d[1]*q)+(c[1]*o)+(p[1]*l)+(n[1]*h),(d[2]*q)+(c[2]*o)+(p[2]*l)+(n[2]*h)])}for(z=0;z<(g+(x?2:1));z+=1){A=z/(g+1);y=A*A;q=6*(y-A);o=6*(-y+A);l=3*y-4*A+1;h=3*y-2*A;f=[(d[0]*q)+(c[0]*o)+(p[0]*l)+(n[0]*h),(d[1]*q)+(c[1]*o)+(p[1]*l)+(n[1]*h),(d[2]*q)+(c[2]*o)+(p[2]*l)+(n[2]*h)];vec3.normalize(f,f);u.push(f)}};molmil.octaSphereBuilder=function(n){var q=[],h=[],p=0,l,o,z,y,w,u,A,d,g,x,s={};d=function(c,t,f){g=Math.sqrt(c*c+t*t+f*f);q.push([c/g,t/g,f/g]);return p++};x=function(D,B){var c=D<B;smallerIndex=c?D:B;greaterIndex=c?B:D;key=[smallerIndex,greaterIndex];ret=molmil_dep.getKeyFromObject(s,key,null);if(ret!=null){return ret}var C=q[D];var t=q[B];var f=d((C[0]+t[0])*0.5,(C[1]+t[1])*0.5,(C[2]+t[2])*0.5);s[key]=f;return f};d(-1,1,0);d(1,1,0);d(1,-1,0);d(-1,-1,0);d(0,0,-1);d(0,0,1);h.push([0,1,4]);h.push([1,2,4]);h.push([2,3,4]);h.push([3,0,4]);h.push([5,1,0]);h.push([5,2,1]);h.push([5,3,2]);h.push([5,0,3]);for(l=0;l<n;l++){z=[];for(o=0;o<h.length;o++){y=x(h[o][0],h[o][1]);w=x(h[o][1],h[o][2]);u=x(h[o][2],h[o][0]);z.push([h[o][0],y,u]);z.push([h[o][1],w,y]);z.push([h[o][2],u,w]);z.push([y,w,u])}h=z}return{vertices:q,faces:h}};molmil.buildOctaDome=function(p,l){var c=molmil.octaSphereBuilder(p),s,q,o,h,n=[],f;for(var g=0;g<c.vertices.length;g++){s=c.vertices[4][0]-c.vertices[g][0];q=c.vertices[4][1]-c.vertices[g][1];o=c.vertices[4][2]-c.vertices[g][2];h=s*s+q*q+o*o;if((l==0&&h>2.00001)||(l==1&&h<1.99999)){n.push(g)}}for(var g=n.length-1;g>-1;g--){c.vertices.splice(n[g],1)}for(g=0;g<c.faces.length;g++){if(n.indexOf(c.faces[g][0])!=-1||n.indexOf(c.faces[g][1])!=-1||n.indexOf(c.faces[g][2])!=-1){c.faces.splice(g,1);g-=1}else{for(f=0;f<c.faces[g].length;f++){for(k=n.length-1;k>-1;k--){if(c.faces[g][f]>n[k]){c.faces[g][f]-=1}}}}}return c};molmil.buildBondsList4Molecule=function(n,l,o){var t,q,p,c,f,d,h,g,s=molmil.configBox.vdwR;for(f=0;f<l.atoms.length;f++){for(d=f+1;d<l.atoms.length;d++){if(l.atoms[f].label_alt_id!=l.atoms[d].label_alt_id&&l.atoms[f].label_alt_id!=null&&l.atoms[d].label_alt_id!=null){continue}h=l.atoms[f].xyz;g=l.atoms[d].xyz;t=o[h]-o[g];t*=t;q=o[h+1]-o[g+1];q*=q;p=o[h+2]-o[g+2];p*=p;c=t+q+p;maxDistance=3.24;if(s[l.atoms[f].element]===undefined||s[l.atoms[f].element]>=1.8){if(s[l.atoms[d].element]===undefined||s[l.atoms[d].element]>=1.8){maxDistance=6}else{maxDistance=4.5}}else{if(s[l.atoms[d].element]===undefined||s[l.atoms[d].element]>=1.8){if(s[l.atoms[f].element]===undefined||s[l.atoms[f].element]>=1.8){maxDistance=6}else{maxDistance=4.5}}else{if(l.atoms[f].element=="H"||l.atoms[d].element=="H"||l.atoms[f].element=="D"||l.atoms[d].element=="D"){maxDistance=1.6}}}if(c<=maxDistance){n.push([l.atoms[f],l.atoms[d],1])}}}};molmil.isBlackListed=function(){if(molmil.ignoreBlackList){return false}if(navigator.userAgent.indexOf("Mac OS X 10.6")!=-1){return true}else{if(navigator.userAgent.indexOf("Mac OS X 10_6")!=-1){return true}}return false};molmil.addEnableMolmilButton=function(c){c.renderer=c.molmilViewer.renderer;var f=molmil_dep.dcE("DIV");var d=f.pushNode(molmil_dep.createButton("Enable"));c.style.display="none";c.parentNode.pushNode(f);d.onclick=function(){molmil.ignoreBlackList=true;molmil_dep.reloadPage()};return f};molmil.createViewer=function(n,g,c,l,f){var d;var h=window.devicePixelRatio||1;if(n.tagName.toLowerCase()=="canvas"){d=n}else{d=n.pushNode("canvas")}g=g||d.width;c=c||d.height;d.width=g*h;d.height=c*h;d.defaultSize=[g,c];d.style.width=g+"px";d.style.height=c+"px";d.setSize=function(o,p){var q=window.devicePixelRatio||1;this.renderer.width=this.width=o*q;this.renderer.height=this.height=p*q;this.style.width=o+"px";this.style.height=p+"px";this.renderer.resizeViewPort();this.update=true;this.renderer.render()};if(l){d.molmilViewer=l;molmil.setCanvas(l,d);d.molmilViewer.renderer.camera=d.molmilViewer.defaultCanvas[1].camera;d.molmilViewer.renderer.QLV=d.molmilViewer.defaultCanvas[1].QLV}else{d.molmilViewer=new molmil.viewer(d);if(molmil.isBlackListed()){return molmil.addEnableMolmilButton(d)}}if(!d.molmilViewer.renderer.initGL(d)){return d.molmilViewer.renderer.altCanvas}d.style.backgroundColor="rgb("+Math.round(molmil.configBox.BGCOLOR[0]*255)+", "+Math.round(molmil.configBox.BGCOLOR[1]*255)+", "+Math.round(molmil.configBox.BGCOLOR[2]*255)+")";if(!f){d.molmilViewer.UI.init()}d.molmilViewer.renderer.initRenderer();if(l){d.renderer.initBuffers();d.update=true;molmil.safeStartViewer(d)}return d};molmil.selectQLV=function(f,c,d){c=Math.min(Math.max(c,0),molmil.configBox.QLV_SETTINGS.length-1);if(molmil.configBox.liteMode){c=1}f.QLV=c;if(d){f.initBuffers();f.canvas.update=true}};molmil.interpolateBR=function(f){if(f==1){return[[0,0,255,255]]}var g=[],d;for(var c=0;c<f;c++){d=molmil.hslToRgb123((1-(c/(f-1)))*(2/3),1,0.5);g.push([d[0]*255,d[1]*255,d[2]*255,255])}return g};molmil.resetCOG=function(d,c){if(c){d.molmilViewer.calculateCOG()}d.molmilViewer.avgXYZ=[d.molmilViewer.avgX,d.molmilViewer.avgY,d.molmilViewer.avgZ];d.molmilViewer.stdXYZ=[d.molmilViewer.stdX,d.molmilViewer.stdY,d.molmilViewer.stdZ];d.molmilViewer.COR=d.molmilViewer.avgXYZ;d.renderer.camera.z=d.molmilViewer.calcZ()};molmil.loadFile=function(h,g,c,f,d){d=d||molmil.cli_soup;d.loadStructure(h,g,c||function(l,n){molmil.displayEntry(n,1);molmil.colorEntry(n,1,null,true,d)},{async:f?true:false})};molmil.loadPDBlite=function(d,c,l,f){molmil.configBox.liteMode=true;f=f||molmil.cli_soup;var h=new molmil_dep.CallRemote("GET"),l=true;h.ASYNC=l;h.OnDone=function(){this.atom_data=JSON.parse(this.request.responseText)};h.OnError=function(){this.error=true;f=f||molmil.cli_soup;f.loadStructure(molmil.settings.pdb_url.replace("__ID__",d),1,c||function(n,o){delete n.pdbxData;molmil.displayEntry(o,molmil.displayMode_Default);molmil.displayEntry(o,molmil.displayMode_CartoonRocket);molmil.colorEntry(o,1,null,true,f)},{async:l?true:false})};h.Send(molmil.settings.pdb_url.replace("format=mmjson-all","format=mmjson-lite").replace("__ID__",d));var g=new molmil_dep.CallRemote("GET"),l=true;g.ASYNC=l;g.target=this;g.requestA=h;g.OnDone=function(){if(this.requestA.error){return}if(!this.requestA.atom_data){return molmil_dep.asyncStart(this.OnDone,[],this,100)}var n=JSON.parse(this.request.responseText);n["data_"+d.toUpperCase()]["atom_site"]=this.requestA.atom_data["data_"+d.toUpperCase()]["atom_site"];f.loadStructureData(n,"mmjson",d+".json",c||function(o,p){delete o.pdbxData;molmil.displayEntry(p,molmil.displayMode_Default);molmil.displayEntry(p,molmil.displayMode_CartoonRocket);molmil.colorEntry(p,1,null,true,f)})};g.Send(molmil.settings.pdb_url.replace("__ID__",d).replace("format=mmjson-all","format=mmjson-plus-noatom"))};molmil.loadPDB=function(d,c,g,f){f=f||molmil.cli_soup;f.loadStructure(molmil.settings.pdb_url.replace("__ID__",d),1,c||function(h,l){if(f.AID>150000&&(navigator.userAgent.toLowerCase().indexOf("mobile")!=-1||navigator.userAgent.toLowerCase().indexOf("android")!=-1||window.navigator.msMaxTouchPoints)){molmil.displayEntry(l,molmil.displayMode_Wireframe)}else{molmil.displayEntry(l,1)}molmil.colorEntry(l,1,null,true,f)},{async:g?true:false})};molmil.loadCC=function(g,c,f,d){d=d||molmil.cli_soup;d.loadStructure(molmil.settings.comp_url.replace("__ID__",g),1,c||function(h,l){molmil.displayEntry(l,1);molmil.colorEntry(l,1,null,true,d)},{async:f?true:false})};molmil.clear=function(c){c=c||molmil.cli_canvas;c.molmilViewer.clear();c.renderer.initBuffers();c.renderer.camera.reset();c.update=true;if(document.body.classList!==undefined){document.body.classList.remove("entryLoaded")}};molmil.coarseSurface=function(ac,Q,ah){var B=Q*0.5;var C=1/Q;var M=ac.atoms;var ag=ac.modelsXYZ[0];var w=[1e+99,-1e+99,1e+99,-1e+99,1e+99,-1e+99],af,ab,o={},Y,X,W,N,L,K,t,A={},O={},p=[0,0,0,0,0,0],u,D,s=molmil.configBox.vdwR,U,J,I,F,S,H,g,z,V,P,q,n,l,f,y,x;for(af=0;af<M.length;af++){ab=ag[M[af].xyz];if(ab<w[0]){w[0]=ab}if(ab>w[1]){w[1]=ab}ab=ag[M[af].xyz+1];if(ab<w[2]){w[2]=ab}if(ab>w[3]){w[3]=ab}ab=ag[M[af].xyz+2];if(ab<w[4]){w[4]=ab}if(ab>w[5]){w[5]=ab}o[M[af].element]=1}Y=Math.ceil((w[1]-w[0]+(2*ah)+(2*1.8))/Q)+2;X=Math.ceil((w[3]-w[2]+(2*ah)+(2*1.8))/Q)+2;W=Math.ceil((w[5]-w[4]+(2*ah)+(2*1.8))/Q)+2;N=-w[0]+ah+1.8+Q;L=-w[2]+ah+1.8+Q;K=-w[4]+ah+1.8+Q;t=Y*X*W;for(af in o){A[af]=new Float32Array(t);O[af]=[];for(S=0;S<t;S++){A[af][S]=1e+99;O[af].push(null)}o[af]=molmil_dep.getKeyFromObject(s,af,s.DUMMY)}for(af=0;af<M.length;af++){u=A[M[af].element];D=O[M[af].element];U=o[M[af].element];J=ag[M[af].xyz]+N;I=ag[M[af].xyz+1]+L;F=ag[M[af].xyz+2]+K;p[0]=Math.min(0,Math.floor(J-U-ah));p[1]=Math.max(Math.ceil(J+U+ah),Y);p[2]=Math.min(0,Math.floor(I-U-ah));p[3]=Math.max(Math.ceil(I+U+ah),X);p[4]=Math.min(0,Math.floor(F-U-ah));p[5]=Math.max(Math.ceil(F+U+ah),W);p[0]=0;p[1]=Y;p[2]=0;p[3]=X;p[4]=0;p[5]=W;for(S=p[0];S<p[1];S++){V=S*Q;for(H=p[2];H<p[3];H++){P=H*Q;for(g=p[4];g<p[5];g++){q=g*Q;z=S+Y*(H+X*g);n=J-V;l=I-P;f=F-q;ab=n*n+l*l+f*f;if(ab<u[z]){u[z]=ab;D[z]=[n,l,f,U,J,I,F]}}}}}y=new Float32Array(t);x=new Float32Array(t*3);for(S=0;S<t;S++){z=1e+99;J=I=F=null;for(af in o){U=Math.sqrt(A[af][S]);ab=U;U-=ah+O[af][S][3];if(U<z){ab=1/ab;J=O[af][S][0]*ab*U*C;I=O[af][S][1]*ab*U*C;F=O[af][S][2]*ab*U*C;z=U}}U=S*3;y[S]=z*C;x[U]=J;x[U+1]=I;x[U+2]=F}var R=function(ai,ak,aj){var c=ai+Y*(ak+X*aj);return y[c]};var d=function(ai,ak,aj){var c=ai+Y*(ak+X*aj);c*=3;return[x[c],x[c+1],x[c+2]]};var E=molmil.surfaceNets([Y,X,W],R,d);var T=[],h=[],aa,Z,af=[0,0,0],ae=[0,0,0],ad;for(aa=0;aa<E.vertices.length;aa++){h.push([])}for(aa=0;aa<E.faces.length;aa++){af[0]=E.vertices[E.faces[aa][1]][0]-E.vertices[E.faces[aa][0]][0];af[1]=E.vertices[E.faces[aa][1]][1]-E.vertices[E.faces[aa][0]][1];af[2]=E.vertices[E.faces[aa][1]][2]-E.vertices[E.faces[aa][0]][2];ae[0]=E.vertices[E.faces[aa][2]][0]-E.vertices[E.faces[aa][0]][0];ae[1]=E.vertices[E.faces[aa][2]][1]-E.vertices[E.faces[aa][0]][1];ae[2]=E.vertices[E.faces[aa][2]][2]-E.vertices[E.faces[aa][0]][2];T.push([af[1]*ae[2]-af[2]*ae[1],af[2]*ae[0]-af[0]*ae[2],af[0]*ae[1]-af[1]*ae[0]]);h[E.faces[aa][0]].push(aa);h[E.faces[aa][1]].push(aa);h[E.faces[aa][2]].push(aa)}var G=[];for(aa=0;aa<E.vertices.length;aa++){af=[0,0,0];for(Z=0;Z<h[aa].length;Z++){af[0]+=T[h[aa][Z]][0];af[1]+=T[h[aa][Z]][1];af[2]+=T[h[aa][Z]][2]}vec3.normalize(af,af);G.push(af)}molmil.taubinSmoothing(G,E.faces,0.33,-0.331,50);for(aa=0;aa<G.length;aa++){vec3.normalize(G[aa],G[aa])}for(aa=0;aa<G.length;aa++){E.vertices[aa][0]=((E.vertices[aa][0]-G[aa][0]*ah*0.15)*Q)-N;E.vertices[aa][1]=((E.vertices[aa][1]-G[aa][1]*ah*0.15)*Q)-L;E.vertices[aa][2]=((E.vertices[aa][2]-G[aa][2]*ah*0.15)*Q)-K}molmil.taubinSmoothing(E.vertices,E.faces,0.33,-0.331,50);E.normals=G;return E};molmil.taubinSmoothing=function(s,d,q,y,t){var n,p,w,l=[0,0,0,0],c,h;var u=[],o=[];for(w=0;w<s.length;w++){u.push({});o.push([0,0,0])}for(p=0;p<d.length;p++){u[d[p][0]][d[p][1]]=true;u[d[p][0]][d[p][2]]=true;u[d[p][1]][d[p][0]]=true;u[d[p][1]][d[p][2]]=true;u[d[p][2]][d[p][0]]=true;u[d[p][2]][d[p][1]]=true}for(w=0;w<s.length;w++){u[w]=Object.keys(u[w])}var x=function(f){for(w=0;w<s.length;w++){l[0]=0;l[1]=0;l[2]=0;l[3]=0;for(n=0;n<u[w].length;n++){c=s[u[w][n]];l[0]+=c[0];l[1]+=c[1];l[2]+=c[2];l[3]+=1}if(l[3]==0){continue}h=1/l[3];l[0]*=h;l[1]*=h;l[2]*=h;o[w][0]=s[w][0]+f*(l[0]-s[w][0]);o[w][1]=s[w][1]+f*(l[1]-s[w][1]);o[w][2]=s[w][2]+f*(l[2]-s[w][2])}};for(var g=0;g<t;g++){x(q);for(w=0;w<s.length;w++){s[w][0]=o[w][0];s[w][1]=o[w][1];s[w][2]=o[w][2]}x(y);for(w=0;w<s.length;w++){s[w][0]=o[w][0];s[w][1]=o[w][1];s[w][2]=o[w][2]}}};var sn_cube_edges=new Int32Array(24),sn_edge_table=new Int32Array(256);(function(){var f=0;for(var l=0;l<8;++l){for(var g=1;g<=4;g<<=1){var n=l^g;if(l<=n){sn_cube_edges[f++]=l;sn_cube_edges[f++]=n}}}for(var l=0;l<256;++l){var h=0;for(var g=0;g<24;g+=2){var d=!!(l&(1<<sn_cube_edges[g])),c=!!(l&(1<<sn_cube_edges[g+1]));h|=d!==c?(1<<(g>>1)):0}sn_edge_table[l]=h}})();var sn_buffer=new Array(4096);(function(){for(var c=0;c<sn_buffer.length;++c){sn_buffer[c]=0}})();molmil.surfaceNets=function(H,F,h,t){if(!t){t=[[0,0,0],H]}var U=[0,0,0];var O=[0,0,0];for(var N=0;N<3;++N){U[N]=(t[1][N]-t[0][N])/H[N];O[N]=t[0][N]}var s=[],d=[],I=0,z=[0,0,0],q=[1,(H[0]+1),(H[0]+1)*(H[1]+1)],c=[0,0,0,0,0,0,0,0],Q=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],T=1;if(q[2]*2>sn_buffer.length){var B=sn_buffer.length;sn_buffer.length=q[2]*2;while(B<sn_buffer.length){sn_buffer[B++]=0}}for(z[2]=0;z[2]<H[2]-1;++z[2],I+=H[0],T^=1,q[2]=-q[2]){var J=1+(H[0]+1)*(1+T*(H[1]+1));for(z[1]=0;z[1]<H[1]-1;++z[1],++I,J+=2){for(z[0]=0;z[0]<H[0]-1;++z[0],++I,++J){var M=0,P=0;for(var K=0;K<2;++K){for(var L=0;L<2;++L){for(var N=0;N<2;++N,++P){var G=F(z[0]+N,z[1]+L,z[2]+K);c[P]=G;Q[P][0]=z[0]+N;Q[P][1]=z[1]+L;Q[P][2]=z[2]+K;M|=(G<0)?(1<<P):0}}}if(M===0||M===255){continue}var E=sn_edge_table[M];var y=[0,0,0],f=0,S;for(var N=0;N<12;++N){if(!(E&(1<<N))){continue}var w=sn_cube_edges[N<<1],u=sn_cube_edges[(N<<1)+1];S=h(Q[w][0],Q[w][1],Q[w][2]);y[0]+=Q[w][0]+S[0];y[1]+=Q[w][1]+S[1];y[2]+=Q[w][2]+S[2];S=h(Q[u][0],Q[u][1],Q[u][2]);y[0]+=Q[u][0]+S[0];y[1]+=Q[u][1]+S[1];y[2]+=Q[u][2]+S[2];f+=2}y[0]/=f;y[1]/=f;y[2]/=f;var A=[0,0,0];for(var N=0;N<3;++N){A[N]=U[N]*y[N]+O[N]}sn_buffer[J]=s.length;s.push(A);for(var N=0;N<3;++N){if(!(E&(1<<N))){continue}var o=(N+1)%3,l=(N+2)%3;if(z[o]===0||z[l]===0){continue}var D=q[o],C=q[l];if(M&1){d.push([sn_buffer[J],sn_buffer[J-D],sn_buffer[J-C]]);d.push([sn_buffer[J-C],sn_buffer[J-D],sn_buffer[J-D-C]])}else{d.push([sn_buffer[J],sn_buffer[J-C],sn_buffer[J-D]]);d.push([sn_buffer[J-D],sn_buffer[J-C],sn_buffer[J-D-C]])}}}}}return{vertices:s,faces:d}};molmil.surfaceNets2=function(f,G,F){if(!F){F=[[0,0,0],f]}var D=[0,0,0];var C=[0,0,0];for(var W=0;W<3;++W){D[W]=(F[1][W]-F[0][W])/f[W];C[W]=F[0][W]}var c=[],u=[],O=0,H=[0,0,0],q=[1,(f[0]+1),(f[0]+1)*(f[1]+1)],J=[0,0,0,0,0,0,0,0],M=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],w=1;if(q[2]*2>sn_buffer.length){var E=sn_buffer.length;sn_buffer.length=q[2]*2;while(E<sn_buffer.length){sn_buffer[E++]=0}}for(H[2]=0;H[2]<f[2]-1;++H[2],O+=f[0],w^=1,q[2]=-q[2]){var P=1+(f[0]+1)*(1+w*(f[1]+1));for(H[1]=0;H[1]<f[1]-1;++H[1],++O,P+=2){for(H[0]=0;H[0]<f[0]-1;++H[0],++O,++P){var Q=0,X=0;for(var S=0;S<2;++S){for(var U=0;U<2;++U){for(var W=0;W<2;++W,++X){var N=G(H[0]+W,H[1]+U,H[2]+S);J[X]=N;M[X][0]=H[0]+W;M[X][1]=H[1]+U;M[X][2]=H[2]+S;Q|=(N<0)?(1<<X):0}}}if(Q===0||Q===255){continue}var h=sn_edge_table[Q],I=[0,0,0],d=0;for(var W=0;W<12;++W){if(!(h&(1<<W))){continue}++d;var B=sn_cube_edges[W<<1],A=sn_cube_edges[(W<<1)+1],V=J[B],T=J[A],K=V-T;if(Math.abs(K)>0.000001){K=V/K}else{continue}for(var U=0,S=1;U<3;++U,S<<=1){var Z=B&S,Y=A&S;if(Z!==Y){I[U]+=Z?1-K:K}else{I[U]+=Z?1:0}}}var L=1/d;for(var W=0;W<3;++W){I[W]=D[W]*(H[W]+L*I[W])+C[W]}sn_buffer[P]=c.length;c.push(I);for(var W=0;W<3;++W){if(!(h&(1<<W))){continue}var z=(W+1)%3,y=(W+2)%3;if(H[z]===0||H[y]===0){continue}var o=q[z],l=q[y];if(Q&1){u.push([sn_buffer[P],sn_buffer[P-o],sn_buffer[P-l]]);u.push([sn_buffer[P-l],sn_buffer[P-o],sn_buffer[P-o-l]])}else{u.push([sn_buffer[P],sn_buffer[P-l],sn_buffer[P-o]]);u.push([sn_buffer[P-o],sn_buffer[P-l],sn_buffer[P-o-l]])}}}}}return{vertices:c,faces:u}};molmil.lighterRGB=function(h,d,f){var c=[h[0],h[1],h[2]];var g=c[0]+c[1]+c[2];var l=((255*3-g)*d)/3;c[0]+=l;c[1]+=l;c[2]+=l;c=molmil.redistributeRGB(c);if(f){return c}else{return[Math.round(c[0]),Math.round(c[1]),Math.round(c[2])]}};molmil.redistributeRGB=function(h){var g=255;var f=Math.max(Math.max(h[0],h[1]),h[2]);if(f<=g){return h}var l=h[0]+h[1]+h[2];if(l>=3*g){return[g,g,g]}var d=(3*g-l)/(3*f-l);var c=g-d*f;h[0]=c+d*h[0];h[1]=c+d*h[1];h[2]=c+d*h[2];return h};var buCheck=molmil.buCheck=function(I,H,s,C,L){L=L||molmil.cli_soup;if(!C){for(var G=0;G<L.structures.length;G++){if(L.structures[G] instanceof molmil.entryObject){C=L.structures[G];break}}}var w={};w.displayedChains={};w.COR=JSON.parse(JSON.stringify(L.COR));w.geomRanges=JSON.parse(JSON.stringify(L.geomRanges));for(var J=0;J<C.chains.length;J++){if(C.chains[J].display){w.displayedChains[C.chains[J].name]=true}}var E=L.BUassemblies[I];var l,D;var l=JSON.parse(JSON.stringify(molmil.configBox.backboneAtoms4Display));l.CA=1;var B=0,G,J,F,K,z,u=[],q,d=[0,0,0,0],o=[0,0,0],g;var n={},y;for(B,J=0;B<E.length;B++){z=[];for(G=0;G<E[B][1].length;G++){if(L.poly_asym_ids.indexOf(E[B][1][G])!=-1){z.push(E[B][1][G])}else{n[E[B][1][G]]=z}}u.push(z);for(G=0,K=0;G<E[B][0].length;G++){F=L.BUmatrices[E[B][0][G]];if(F[0]=="identity operation"){continue}K++}J+=z.length*K}var h={},x=false,A=0;for(B=0;B<E.length;B++){z=u[B];for(G=0;G<z.length;G++){no_identity=true;if(!h.hasOwnProperty(z[G])){h[z[G]]=[]}for(J=0;J<E[B][0].length;J++){F=L.BUmatrices[E[B][0][J]];if(F[0]=="identity operation"){no_identity=false;continue}h[z[G]].push(F[1])}var f=[];if((H==1&&s==1)||(H==2&&s==1)||(H==2&&s==4)){for(J=0;J<E[B][0].length;J++){F=L.BUmatrices[E[B][0][J]];if(F[0]=="identity operation"){no_identity=false;continue}f.push(F[1])}}else{if((H==3||H==4)&&s==4){for(J=0;J<E[B][0].length;J++){F=L.BUmatrices[E[B][0][J]];if(F[0]=="identity operation"){no_identity=false;continue}f.push(F[1])}}else{if((H==3||H==4||H==5)&&(s==2||s==3||s==5)){for(J=0;J<E[B][0].length;J++){F=L.BUmatrices[E[B][0][J]];if(F[0]=="identity operation"){no_identity=false;continue}f.push(F[1])}}else{for(J=0;J<E[B][0].length;J++){F=L.BUmatrices[E[B][0][J]];if(F[0]=="identity operation"){no_identity=false;continue}f.push(F[1])}}}}for(J=0;J<f.length;J++){A++}if(!no_identity){x=true}}}w.chainInfo=h;w.NOC=A;w.no_identity=!x;var t=false;for(J=0;J<C.chains.length;J++){if(n.hasOwnProperty(C.chains[J].name)){z=n[C.chains[J].name];if(z instanceof Array){K=false;for(G=0;G<z.length;G++){if(n.hasOwnProperty(z[G])){K=true;break}}if(!K){w.displayedChains[C.chains[J].name]=false;continue}}if(!w.displayedChains[C.chains[J].name]){w.displayedChains[C.chains[J].name]=true}}else{if(w.displayedChains[C.chains[J].name]){w.displayedChains[C.chains[J].name]=false}}}w.assembly_id=I;return w};molmil.toggleBU=function(ag,P,x,C,az){az=az||molmil.cli_soup;if(!C){for(var ao=0;ao<az.structures.length;ao++){if(az.structures[ao] instanceof molmil.entryObject){C=az.structures[ao];break}}}var W=az.renderer;var w=W.gl;var af=az.models;if(!az.sceneBU){az.sceneBU={};az.sceneBU.displayedChains={};az.sceneBU.COR=JSON.parse(JSON.stringify(az.COR));az.sceneBU.geomRanges=JSON.parse(JSON.stringify(az.geomRanges))}for(av=0;av<C.chains.length;av++){if(C.chains[av].display){C.chains[av].display=az.sceneBU.displayedChains[C.chains[av].name]=true}}for(var ai=0;ai<W.programs.length;ai++){if(W.programs[ai].BUprogram){W.programs.splice(ai,1);ai--}}if(ag==-1){az.COR=JSON.parse(JSON.stringify(az.sceneBU.COR));az.geomRanges=JSON.parse(JSON.stringify(az.sceneBU.geomRanges));var S=false;for(av=0;av<C.chains.length;av++){if(!C.chains[av].display){C.chains[av].display=az.sceneBU.displayedChains[C.chains[av].name]=true;S=true}}if(az.sceneBU.no_identity){az.renderer.program1.status=az.renderer.program2.status=az.renderer.program3.status=true;az.sceneBU.no_identity=false}if(S){W.initBuffers()}az.canvas.update=true;if(az.sceneBU.assembly_id!=ag){W.camera.z=az.calcZ()}az.sceneBU.assembly_id=ag;return}var R=az.BUassemblies[ag];var J,au;var J=JSON.parse(JSON.stringify(molmil.configBox.backboneAtoms4Display));J.CA=1;var T,q,am,l,M,n,Q,ae,Z;var ai=0,an,ao,av,al,ak,aw,O,o=[],U,g=[0,0,0,0],X=[0,0,0],f;var t=0;var V={},ax;for(ai,av=0;ai<R.length;ai++){O=[];for(ao=0;ao<R[ai][1].length;ao++){if(az.poly_asym_ids.indexOf(R[ai][1][ao])!=-1){O.push(R[ai][1][ao])}else{V[R[ai][1][ao]]=O}}o.push(O);for(ao=0,aw=0;ao<R[ai][0].length;ao++){al=az.BUmatrices[R[ai][0][ao]];if(al[0]=="identity operation"){continue}aw++}t+=aw;av+=O.length*aw}var ab=[],G=true,h;if(x==2){aw=(o[0]||[]).length}else{if(x==3){aw=av}else{if(x instanceof Array){ab=x;if(!(ab[0] instanceof Array)){ab=[ab]}x=5;aw=0}}}for(ao=0,al=0;ao<aw;ao++,al++){if(al>=molmil.configBox.bu_colors.length){al=0}if(P==5){ab.push(molmil.lighterRGB(molmil.configBox.bu_colors[al],0.5))}else{ab.push(molmil.configBox.bu_colors[al])}}var ar=1e+99,L=-1e+99,E=1e+99,aj=-1e+99,ad=1e+99,u=-1e+99,z=[0,0,0],y=[0,0,0];var K={},Y=false,N=0,aa;for(ai=0,an=0;ai<R.length;ai++){O=o[ai];for(ao=0;ao<O.length;ao++){aa=null;G=true;if(!K.hasOwnProperty(O[ao])){K[O[ao]]=[]}if(az.BUcache.hasOwnProperty(O[ao])&&az.BUcache[O[ao]].hasOwnProperty(P)){av=az.BUcache[O[ao]][P];ae=av[0];Z=av[1];U=av[2];ax=av[3];aa=av[4]}else{if(P==3||P==4){var I=[],ac=[],ah,D,s=[];var ay=2;if(P==4){ay=3}U=[0,0,0,0];z[0]=z[1]=z[2]=1e+99;y[0]=y[1]=y[2]=-1e+99;for(av=0;av<C.chains.length;av++){if(C.chains[av].molecules.length<1||C.chains[av].isHet||C.chains[av].molecules[0].water){continue}if(C.chains[av].name!=O[ao]){continue}s.push(C.chains[av]);I.push(C.chains[av].displayMode);C.chains[av].displayMode=ay;ac.push(ah=[]);for(al=0;al<C.chains[av].molecules.length;al++){ah.push(C.chains[av].molecules[al].rgba);C.chains[av].molecules[al].rgba=molmil_dep.getKeyFromObject(molmil.configBox.sndStrucColor,C.chains[av].molecules[al].sndStruc,molmil.configBox.sndStrucColor[1]);if(C.chains[av].molecules[al].CA){D=C.chains[av].molecules[al].CA.xyz;U[0]+=C.chains[av].modelsXYZ[0][D];U[1]+=C.chains[av].modelsXYZ[0][D+1];U[2]+=C.chains[av].modelsXYZ[0][D+2];U[3]+=1;if(C.chains[av].modelsXYZ[0][D]<z[0]){z[0]=C.chains[av].modelsXYZ[0][D]}if(C.chains[av].modelsXYZ[0][D+1]<z[1]){z[1]=C.chains[av].modelsXYZ[0][D+1]}if(C.chains[av].modelsXYZ[0][D+2]<z[2]){z[2]=C.chains[av].modelsXYZ[0][D+2]}if(C.chains[av].modelsXYZ[0][D]>y[0]){y[0]=C.chains[av].modelsXYZ[0][D]}if(C.chains[av].modelsXYZ[0][D+1]>y[1]){y[1]=C.chains[av].modelsXYZ[0][D+1]}if(C.chains[av].modelsXYZ[0][D+2]>y[2]){y[2]=C.chains[av].modelsXYZ[0][D+2]}}}}U[0]/=U[3];U[1]/=U[3];U[2]/=U[3];molmil.geometry.reset();h=0;if(t>10){h--}if(t>100){h--}if(t>1000){h--}molmil.geometry.initChains(s,W,h);molmil.geometry.initCartoon(s);molmil.geometry.generateCartoon(s);ae=w.createBuffer();w.bindBuffer(w.ARRAY_BUFFER,ae);w.bufferData(w.ARRAY_BUFFER,molmil.geometry.buffer3.vertexBuffer,w.STATIC_DRAW);Z=w.createBuffer();w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,Z);w.bufferData(w.ELEMENT_ARRAY_BUFFER,molmil.geometry.buffer3.indexBuffer,w.STATIC_DRAW);if(!az.BUcache.hasOwnProperty(O[ao])){az.BUcache[O[ao]]={}}az.BUcache[O[ao]][P]=[ae,Z,U,ax=molmil.geometry.buffer3.indexBuffer.length,[]];for(av=0;av<s.length;av++){s[av].displayMode=I[av];for(al=0;al<s[av].molecules.length;al++){s[av].molecules[al].rgba=ac[av][al]}}molmil.geometry.reset()}else{if(P==5){var H;for(av=0;av<C.chains.length;av++){if(C.chains[av].molecules.length<1||C.chains[av].isHet||C.chains[av].molecules[0].water){continue}if(C.chains[av].name!=O[ao]){continue}H=molmil.coarseSurface(C.chains[av],7.5,7.5*0.75);l=new Float32Array(H.vertices.length*8);M=new Uint8Array(l.buffer);n=new Uint32Array(H.faces.length*3);U=[0,0,0,0];z[0]=z[1]=z[2]=1e+99;y[0]=y[1]=y[2]=-1e+99;for(av=0,al=0,ak=0;av<H.vertices.length;av++,ak+=32){l[al++]=H.vertices[av][0];l[al++]=H.vertices[av][1];l[al++]=H.vertices[av][2];U[0]+=H.vertices[av][0];U[1]+=H.vertices[av][1];U[2]+=H.vertices[av][2];U[3]+=1;if(H.vertices[av][0]<z[0]){z[0]=H.vertices[av][0]}if(H.vertices[av][1]<z[1]){z[1]=H.vertices[av][1]}if(H.vertices[av][2]<z[2]){z[2]=H.vertices[av][2]}if(H.vertices[av][0]>y[0]){y[0]=H.vertices[av][0]}if(H.vertices[av][1]>y[1]){y[1]=H.vertices[av][1]}if(H.vertices[av][2]>y[2]){y[2]=H.vertices[av][2]}l[al++]=H.normals[av][0];l[al++]=H.normals[av][1];l[al++]=H.normals[av][2];al++;al++}U[0]/=U[3];U[1]/=U[3];U[2]/=U[3];for(av=0,al=0;av<H.faces.length;av++){n[al++]=H.faces[av][0];n[al++]=H.faces[av][1];n[al++]=H.faces[av][2]}ae=w.createBuffer();w.bindBuffer(w.ARRAY_BUFFER,ae);w.bufferData(w.ARRAY_BUFFER,l,w.STATIC_DRAW);Z=w.createBuffer();w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,Z);w.bufferData(w.ELEMENT_ARRAY_BUFFER,n,w.STATIC_DRAW);if(!az.BUcache.hasOwnProperty(O[ao])){az.BUcache[O[ao]]={}}az.BUcache[O[ao]][P]=[ae,Z,U,ax=H.faces.length*3,[]]}}else{T=[];q={};if(P==1){for(av=0;av<C.chains.length;av++){au=C.chains[av];if(!au.bondsOK){W.soup.buildBondList(au,false)}for(aw=0;aw<au.bonds.length;aw++){if(J.hasOwnProperty(au.bonds[aw][0].atomName)&&J.hasOwnProperty(au.bonds[aw][1].atomName)&&au.bonds[aw][0].molecule.chain.name==O[ao]&&au.bonds[aw][1].molecule.chain.name==O[ao]){T.push(au.bonds[aw]);q[au.bonds[aw][0].AID]=au.bonds[aw][0];q[au.bonds[aw][1].AID]=au.bonds[aw][1]}}}}else{if(P==2){for(av=0;av<C.chains.length;av++){au=C.chains[av];for(al=0;al<au.molecules.length;al++){if(au.molecules[al].CA&&au.molecules[al].next&&au.molecules[al].chain.name==O[ao]){T.push([au.molecules[al].CA,au.molecules[al].next.CA]);q[au.molecules[al].CA.AID]=au.molecules[al].CA;q[au.molecules[al].next.CA.AID]=au.molecules[al].next.CA}}}}}AIDs=Object.keys(q);Q={};l=new Float32Array((AIDs.length)*5);M=new Uint8Array(l.buffer);n=new Uint32Array(T.length*2);U=[0,0,0,0];z[0]=z[1]=z[2]=1e+99;y[0]=y[1]=y[2]=-1e+99;if(P==2&&x==4){for(av=0,al=0,ak=0;av<AIDs.length;av++,ak+=20){f=q[AIDs[av]];au=f.chain;l[al++]=au.modelsXYZ[0][f.xyz];l[al++]=au.modelsXYZ[0][f.xyz+1];l[al++]=au.modelsXYZ[0][f.xyz+2];U[0]+=l[al-3];U[1]+=l[al-2];U[2]+=l[al-1];if(l[al-3]<z[0]){z[0]=l[al-3]}if(l[al-2]<z[1]){z[1]=l[al-2]}if(l[al-1]<z[2]){z[2]=l[al-1]}if(l[al-3]>y[0]){y[0]=l[al-3]}if(l[al-2]>y[1]){y[1]=l[al-2]}if(l[al-1]>y[2]){y[2]=l[al-1]}am=molmil_dep.getKeyFromObject(molmil.configBox.sndStrucColor,q[AIDs[av]].molecule.sndStruc,molmil.configBox.sndStrucColor[1]);M[ak+12]=am[0];M[ak+13]=am[1];M[ak+14]=am[2];M[ak+15]=am[3];al++;l[al++]=AIDs[av];Q[AIDs[av]]=av}}else{for(av=0,al=0,ak=0;av<AIDs.length;av++,ak+=20){f=q[AIDs[av]];au=f.chain;l[al++]=au.modelsXYZ[0][f.xyz];l[al++]=au.modelsXYZ[0][f.xyz+1];l[al++]=au.modelsXYZ[0][f.xyz+2];U[0]+=l[al-3];U[1]+=l[al-2];U[2]+=l[al-1];if(l[al-3]<z[0]){z[0]=l[al-3]}if(l[al-2]<z[1]){z[1]=l[al-2]}if(l[al-1]<z[2]){z[2]=l[al-1]}if(l[al-3]>y[0]){y[0]=l[al-3]}if(l[al-2]>y[1]){y[1]=l[al-2]}if(l[al-1]>y[2]){y[2]=l[al-1]}am=molmil_dep.getKeyFromObject(molmil.configBox.elementColors,q[AIDs[av]].element,molmil.configBox.elementColors.DUMMY);M[ak+12]=am[0];M[ak+13]=am[1];M[ak+14]=am[2];M[ak+15]=am[3];al++;l[al++]=AIDs[av];Q[AIDs[av]]=av}}U[0]/=AIDs.length;U[1]/=AIDs.length;U[2]/=AIDs.length;U[3]=AIDs.length;for(av=0,al=0;av<T.length;av++){n[al++]=Q[T[av][0].AID];n[al++]=Q[T[av][1].AID]}ae=w.createBuffer();w.bindBuffer(w.ARRAY_BUFFER,ae);w.bufferData(w.ARRAY_BUFFER,l,w.STATIC_DRAW);Z=w.createBuffer();w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,Z);w.bufferData(w.ELEMENT_ARRAY_BUFFER,n,w.STATIC_DRAW);if(!az.BUcache.hasOwnProperty(O[ao])){az.BUcache[O[ao]]={}}az.BUcache[O[ao]][P]=[ae,Z,U,ax=n.length,[]]}}}for(av=0;av<R[ai][0].length;av++){al=az.BUmatrices[R[ai][0][av]];if(al[0]=="identity operation"){G=false;continue}K[O[ao]].push(al[1])}var ap={multiMatrix:true},aq=[],F=[];if((P==1&&x==1)||(P==2&&x==1)||(P==2&&x==4)){for(av=0;av<R[ai][0].length;av++){al=az.BUmatrices[R[ai][0][av]];if(al[0]=="identity operation"){G=false;continue}aq.push(al[1])}ap.has_ID=true;ap.lines_render=true}else{if((P==3||P==4)&&x==4){for(av=0;av<R[ai][0].length;av++){al=az.BUmatrices[R[ai][0][av]];if(al[0]=="identity operation"){G=false;continue}aq.push(al[1])}ap.solid=true;ap.has_ID=true}else{if((P==3||P==4||P==5)&&(x==2||x==3||x==5)){F=[];for(av=0;av<R[ai][0].length;av++){al=az.BUmatrices[R[ai][0][av]];if(al[0]=="identity operation"){G=false;continue}aq.push(al[1]);if(x==2){F.push(ab[ao]||[255,255,255])}else{if(x==3){F.push(ab[an++]||[255,255,255])}else{if(x==5){F.push(ab[an++]||[255,255,255])}}}if(an>=ab.length){an=0}}ap.solid=true;ap.uniform_color=true;ap.has_ID=true}else{F=[];for(av=0;av<R[ai][0].length;av++){al=az.BUmatrices[R[ai][0][av]];if(al[0]=="identity operation"){G=false;continue}aq.push(al[1]);if(x==2){F.push(ab[ao])}else{if(x==3){F.push(ab[an++])}else{if(x==5){F.push(ab[an++]||[255,255,255])}}}if(an>=ab.length){an=0}}ap.lines_render=true;ap.uniform_color=true;ap.has_ID=true}}}var d=molmil.geometry.build_simple_render_program(null,null,W,ap);d.vertexBuffer=ae;d.indexBuffer=Z;d.nElements=ax;d.BUprogram=true;d.matrices=aq;d.uniform_color=F;if(d.matrices.length){W.programs.push(d)}if(aa){z=aa[0];y=aa[1]}else{try{az.BUcache[O[ao]][P][4]=[[z[0],z[1],z[2]],[y[0],y[1],y[2]]]}catch(at){}}if(!G){if(U[3]!=0){g[0]+=U[0];g[1]+=U[1];g[2]+=U[2];g[3]+=1;if(z[0]<ar){ar=z[0]}if(z[1]<E){E=z[1]}if(z[2]<ad){ad=z[2]}if(y[0]>L){L=y[0]}if(y[1]>aj){aj=y[1]}if(y[2]>u){u=y[2]}}V[O[ao]]=1}for(av=0;av<d.matrices.length;av++){if(U[3]==0){continue}vec3.transformMat4(X,U,d.matrices[av]);g[0]+=X[0];g[1]+=X[1];g[2]+=X[2];g[3]+=1;vec3.transformMat4(X,z,d.matrices[av]);if(X[0]<ar){ar=X[0]}if(X[1]<E){E=X[1]}if(X[2]<ad){ad=X[2]}vec3.transformMat4(X,y,d.matrices[av]);if(X[0]>L){L=X[0]}if(X[1]>aj){aj=X[1]}if(X[2]>u){u=X[2]}N++}if(!G){Y=true}}}if(g[3]){g[0]/=g[3];g[1]/=g[3];g[2]/=g[3]}az.COR[0]=g[0];az.COR[1]=g[1];az.COR[2]=g[2];az.sceneBU.chainInfo=K;az.sceneBU.NOC=N;if(!Y){az.renderer.program1.status=az.renderer.program2.status=az.renderer.program3.status=false}else{az.renderer.program1.status=az.renderer.program2.status=az.renderer.program3.status=true}az.sceneBU.no_identity=!Y;var S=false;for(av=0;av<C.chains.length;av++){if(V.hasOwnProperty(C.chains[av].name)){O=V[C.chains[av].name];if(O instanceof Array){aw=false;for(ao=0;ao<O.length;ao++){if(V.hasOwnProperty(O[ao])){aw=true;break}}if(!aw){C.chains[av].display=az.sceneBU.displayedChains[C.chains[av].name]=false;S=true;continue}}if(!C.chains[av].display){C.chains[av].display=az.sceneBU.displayedChains[C.chains[av].name]=true;S=true}}else{if(C.chains[av].display){C.chains[av].display=az.sceneBU.displayedChains[C.chains[av].name]=false;S=true}}}for(av=0;av<C.chains.length;av++){if(C.chains[av].display&&C.chains[av].isHet){for(ao=0;ao<C.chains[av].atoms.length;ao++){if(!C.chains[av].atoms[ao].status){continue}aw=C.chains[av].atoms[ao].xyz;if(C.chains[av].modelsXYZ[0][aw]<ar){ar=C.chains[av].modelsXYZ[0][aw]}if(C.chains[av].modelsXYZ[0][aw+1]<E){E=C.chains[av].modelsXYZ[0][aw+1]}if(C.chains[av].modelsXYZ[0][aw+2]<ad){ad=C.chains[av].modelsXYZ[0][aw+2]}if(C.chains[av].modelsXYZ[0][aw]>L){L=C.chains[av].modelsXYZ[0][aw]}if(C.chains[av].modelsXYZ[0][aw+1]>aj){aj=C.chains[av].modelsXYZ[0][aw+1]}if(C.chains[av].modelsXYZ[0][aw+2]>u){u=C.chains[av].modelsXYZ[0][aw+2]}}}}if(ar<1000000000){az.geomRanges=[ar-g[0],L-g[0],E-g[1],aj-g[1],ad-g[2],u-g[2]]}if(g[3]==0){az.COR=JSON.parse(JSON.stringify(az.sceneBU.COR));az.geomRanges=JSON.parse(JSON.stringify(az.sceneBU.geomRanges))}if(S||!W.initBD){W.initBuffers()}if(az.sceneBU.assembly_id!=ag){W.camera.z=az.calcZ()}az.sceneBU.assembly_id=ag;az.canvas.update=true};molmil.hslToRgb123=function(t,x,o){var c,u,w;if(x==0){c=u=w=o}else{function n(l,h,g){if(g<0){g+=1}if(g>1){g-=1}if(g<1/6){return l+(h-l)*6*g}if(g<1/2){return h}if(g<2/3){return l+(h-l)*(2/3-g)*6}return l}var d=o<0.5?o*(1+x):o+x-o*x;var f=2*o-d;c=n(f,d,t+1/3);u=n(f,d,t);w=n(f,d,t-1/3)}return[c,u,w]};molmil.calcMMDistance=function(d,c,f){var n=f.renderer.modelId,l,h;l=[d.chain.modelsXYZ[n][d.xyz],d.chain.modelsXYZ[n][d.xyz+1],d.chain.modelsXYZ[n][d.xyz+2]];h=[c.chain.modelsXYZ[n][c.xyz],c.chain.modelsXYZ[n][c.xyz+1],c.chain.modelsXYZ[n][c.xyz+2]];try{return vec3.distance(l,h)}catch(g){return NaN}};molmil.calcMMAngle=function(g,f,d,o){var t=o.renderer.modelId,n,l,h;n=[g.chain.modelsXYZ[t][g.xyz],g.chain.modelsXYZ[t][g.xyz+1],g.chain.modelsXYZ[t][g.xyz+2]];l=[f.chain.modelsXYZ[t][f.xyz],f.chain.modelsXYZ[t][f.xyz+1],f.chain.modelsXYZ[t][f.xyz+2]];h=[d.chain.modelsXYZ[t][d.xyz],d.chain.modelsXYZ[t][d.xyz+1],d.chain.modelsXYZ[t][d.xyz+2]];var c=180/Math.PI,s=[0,0,0],q=[0,0,0];try{vec3.subtract(s,n,l);vec3.normalize(s,s);vec3.subtract(q,h,l);vec3.normalize(q,q);return Math.acos(vec3.dot(s,q))*c}catch(p){return NaN}};molmil.calcMMTorsion=function(F,C,B,A,E){var g=E.renderer.modelId,l,f,d,c;l=[F.chain.modelsXYZ[g][F.xyz],F.chain.modelsXYZ[g][F.xyz+1],F.chain.modelsXYZ[g][F.xyz+2]];f=[C.chain.modelsXYZ[g][C.xyz],C.chain.modelsXYZ[g][C.xyz+1],C.chain.modelsXYZ[g][C.xyz+2]];d=[B.chain.modelsXYZ[g][B.xyz],B.chain.modelsXYZ[g][B.xyz+1],B.chain.modelsXYZ[g][B.xyz+2]];c=[A.chain.modelsXYZ[g][A.xyz],A.chain.modelsXYZ[g][A.xyz+1],A.chain.modelsXYZ[g][A.xyz+2]];var D=180/Math.PI,o=[0,0,0],n=[0,0,0],h=[0,0,0],t=[0,0,0],s=[0,0,0],q,p,z=[0,0,0];try{vec3.subtract(o,f,l);vec3.negate(o,o);vec3.subtract(n,d,f);vec3.normalize(n,n);vec3.subtract(h,c,d);vec3.subtract(t,o,vec3.scale(z,n,vec3.dot(o,n)));vec3.subtract(s,h,vec3.scale(z,n,vec3.dot(h,n)));q=vec3.dot(t,s);p=vec3.dot(vec3.cross(z,n,t),s);return Math.atan2(p,q)*D}catch(u){return NaN}};molmil.calculateBBTorsions=function(f,d){if(f.molecules.length<2){return}for(var c=1;c<f.molecules.length-1;c++){f.molecules[c].phiAngle=molmil.calcMMTorsion(f.molecules[c-1].C,f.molecules[c].N,f.molecules[c].CA,f.molecules[c].C,d);f.molecules[c].psiAngle=molmil.calcMMTorsion(f.molecules[c].N,f.molecules[c].CA,f.molecules[c].C,f.molecules[c+1].N,d);f.molecules[c].omegaAngle=molmil.calcMMTorsion(f.molecules[c-1].CA,f.molecules[c-1].C,f.molecules[c].N,f.molecules[c].CA,d)}f.molecules[0].psiAngle=molmil.calcMMTorsion(f.molecules[0].N,f.molecules[0].CA,f.molecules[0].C,f.molecules[1].N,d);f.molecules[c].phiAngle=molmil.calcMMTorsion(f.molecules[c-1].C,f.molecules[c].N,f.molecules[c].CA,f.molecules[c].C,d);f.molecules[c].omegaAngle=molmil.calcMMTorsion(f.molecules[c-1].CA,f.molecules[c-1].C,f.molecules[c].N,f.molecules[c].CA,d);f.molecules[0].phiAngle=f.molecules[1].phiAngle;f.molecules[c].psiAngle=f.molecules[c-1].psiAngle;f.molecules[0].omegaAngle=f.molecules[1].omegaAngle};molmil.linkCanvases=function(d){for(var c=1;c<d.length;c++){d[c].renderer.camera=d[0].renderer.camera}for(var c=0;c<d.length;c++){d[c].molmilViewer.canvases=d}};molmil.__webglNotSupported__=function(c){if(window.webglNotSupported){return webglNotSupported(c)}var d=molmil_dep.dcE("DIV");d.innerHTML='Your browser does not seem to support WebGL. Please visit the <a target="blank" class="external" href="http://get.webgl.org/">WebGL website</a> for more info on how to gain WebGL support on your browser.<br />';d.style.border="1px solid #ddd";d.style.margin=d.style.padding=".25em";c.parentNode.replaceChild(d,c);return d};molmil.calcRMSD=function(s,p,G){if(s.length!=p.length){console.log("ERROR: both structures should have the same number of atoms");return}var f=0,d=0,I=0,H=0,w=0,u=0,c=s.length,W,Q;if(s instanceof Float32Array){W=s;Q=p;c/=3;for(var U=0,P=0;U<c;U++,P+=3){f+=W[P];I+=W[P+1];w+=W[P+2];d+=Q[P];H+=Q[P+1];u+=Q[P+2]}}else{W=new Float32Array(c*3);Q=new Float32Array(c*3);for(var U=0,P=0;U<c;U++,P+=3){W[P]=s[U].xyz[0];W[P+1]=s[U].xyz[1];W[P+2]=s[U].xyz[2];Q[P]=p[U].xyz[0];Q[P+1]=p[U].xyz[1];Q[P+2]=p[U].xyz[2];f+=W[P];I+=W[P+1];w+=W[P+2];d+=Q[P];H+=Q[P+1];u+=Q[P+2]}}var T=0,y=0;f/=c;I/=c;w/=c;d/=c;H/=c;u/=c;for(var U=0,P=0;U<c;U++,P+=3){W[P]-=f;W[P+1]-=I;W[P+2]-=w;Q[P]-=d;Q[P+1]-=H;Q[P+2]-=u;T+=W[P]*W[P]+W[P+1]*W[P+1]+W[P+2]*W[P+2];y+=Q[P]*Q[P]+Q[P+1]*Q[P+1]+Q[P+2]*Q[P+2]}var o=new Float64Array(9);for(var U=0;U<c*3;U+=3){o[0]+=W[U]*Q[U];o[1]+=W[U]*Q[U+1];o[2]+=W[U]*Q[U+2];o[3]+=W[U+1]*Q[U];o[4]+=W[U+1]*Q[U+1];o[5]+=W[U+1]*Q[U+2];o[6]+=W[U+2]*Q[U];o[7]+=W[U+2]*Q[U+1];o[8]+=W[U+2]*Q[U+2]}var l=new Float64Array(16);l[0]=o[0]+o[4]+o[8];l[5]=o[0]-o[4]-o[8];l[10]=-o[0]+o[4]-o[8];l[15]=-o[0]-o[4]+o[8];l[1]=l[4]=o[5]-o[7];l[2]=l[8]=o[6]-o[2];l[3]=l[12]=o[1]-o[3];l[6]=l[9]=o[1]+o[3];l[7]=l[13]=o[2]+o[6];l[11]=l[14]=o[5]+o[7];var O=[1,1,1,1];var V=molmil.EVpowerMethod(O,l);vec4.negate(O,O);var E=[Math.sqrt(Math.max(0,(T+y)-(2*V))/c)];if(G){var F=2*O[0],D=2*O[1],C=2*O[2],B=2*O[3];var N=F*O[0]-1,L=F*O[1],K=F*O[2],J=F*O[3],A=D*O[1],z=D*O[2],x=D*O[3],h=C*O[2],g=C*O[3],M=B*O[3];var t=new Float64Array(16);t[0]=N+A;t[1]=z-J;t[2]=x+K;t[4]=z+J;t[5]=N+h;t[6]=g-L;t[8]=x-K;t[9]=g+L;t[10]=N+M;t[15]=1;E.push(t,[f,I,w],[d,H,u])}return E};molmil.EVpowerMethod=function(h,c,n){n=n||10000;var g=1e-9,l=0,d=0,f=0,o=new Float64Array(4);f=Math.sqrt(h[0]*h[0]+h[1]*h[1]+h[2]*h[2]+h[3]*h[3]);h[0]/=f;h[1]/=f;h[2]/=f;h[3]/=f;while(l<=n){vec4.transformMat4(o,h,c);f=Math.sqrt(o[0]*o[0]+o[1]*o[1]+o[2]*o[2]+o[3]*o[3]);h[0]=o[0]/f;h[1]=o[1]/f;h[2]=o[2]/f;h[3]=o[3]/f;if(Math.abs((f-d)/f)<g){return f}d=f;l++}return null};molmil.invertColor=function(c){return"#"+("000000"+(16777215^parseInt(c.substring(1),16)).toString(16)).slice(-6)};molmil.componentToHex=function(f){var d=f.toString(16);return d.length==1?"0"+d:d};molmil.rgbToHex=function(f,d,c){return"#"+molmil.componentToHex(f)+molmil.componentToHex(d)+molmil.componentToHex(c)};molmil.hex2rgb=function(c){c=(c.charAt(0)=="#"?c.substr(1,7):c);return[parseInt(c.substring(0,2),16),parseInt(c.substring(2,4),16),parseInt(c.substring(4,6),16)]};molmil.commandLines={};molmil.commandLine=function(canvas){this.environment={};for(var e in window){this.environment[e]=undefined}this.environment.setTimeout=function(cb,tm){window.setTimeout(cb,tm)};this.environment.clearTimeout=function(){window.clearTimeout()};this.environment.navigator=window.navigator;this.environment.console={};this.environment.molmil=molmil;this.canvas=this.environment.cli_canvas=canvas;this.soup=this.environment.cli_soup=canvas.molmilViewer;canvas.commandLine=this;this.buildGUI();this.environment.console.log=function(){arguments=Array.prototype.slice.call(arguments,0);var tmp=document.createElement("div");tmp.textContent=arguments.join(", ");this.custom(tmp)};this.environment.console.warning=function(){arguments=Array.prototype.slice.call(arguments,0);var tmp=document.createElement("div");tmp.textContent=arguments.join(", ");tmp.style.color="yellow";this.custom(tmp)};this.environment.console.error=function(){arguments=Array.prototype.slice.call(arguments,0);var tmp=document.createElement("div");tmp.textContent=arguments.join(", ");tmp.style.color="red";this.custom(tmp)};this.environment.console.logCommand=function(){arguments=Array.prototype.slice.call(arguments,0);var tmp=document.createElement("div");tmp.textContent=arguments.join("\n");tmp.style.color="#00BFFF";this.custom(tmp,true)};this.environment.console.custom=function(obj,noPopup){if(!obj.textContent){return}this.logBox.appendChild(obj);this.logBox.scrollTop=this.logBox.scrollHeight;if(noPopup!=true){this.logBox.icon.onclick(true)}};this.environment.console.runCommand=function(command){if(!molmil.isBalancedStatement(command)){return}if(command.indexOf("{")==-1&&command.indexOf(";")!=-1){var sub_commands=command.split(";");for(var i=0;i<sub_commands.length;i++){sub_commands[i]=sub_commands[i].trim();this.logCommand(sub_commands[i]);this.cli.eval(sub_commands[i]);this.backlog.unshift(sub_commands[i])}}else{command=command.trim();this.logCommand(command);this.cli.eval(command);this.backlog.unshift(command)}this.buffer="";this.blSel=-1};this.environment.console.backlog=[];this.environment.console.buffer="";this.environment.console.blSel=-1;this.environment.console.logBox=this.logBox;this.environment.console.cli=this;this.environment.colors={red:[255,0,0,255],green:[0,255,0,255],blue:[0,0,255,255]};this.bindPymolInterface();this.icon.onclick();this.icon.onclick()};molmil.commandLine.prototype.buildGUI=function(){this.consoleBox=this.canvas.parentNode.pushNode("span");this.consoleBox.className="molmil_UI_cl_box";this.consoleBox.style.overflow="initial";this.logBox=this.consoleBox.pushNode("span");this.logBox.icon=this.icon=this.consoleBox.pushNode("span");this.icon.innerHTML="<";this.icon.title="Display command line";this.icon.className="molmil_UI_cl_icon";this.icon.style.color=molmil.invertColor(molmil.rgbToHex(molmil.configBox.BGCOLOR[0]*255,molmil.configBox.BGCOLOR[1]*255,molmil.configBox.BGCOLOR[2]*255));this.icon.onclick=function(c){if(c==true){if(this.inp.style.display!=""){this.cli.logBox.style.display="";this.cli.consoleBox.style.height="8em";this.cli.logBox.style.pointerEvents="none";this.cli.logBox.style.overflow="hidden";var d=molmil.invertColor(molmil.rgbToHex(molmil.configBox.BGCOLOR[0]*255,molmil.configBox.BGCOLOR[1]*255,molmil.configBox.BGCOLOR[2]*255));this.cli.consoleBox.style.color=d;this.logBox.scrollTop=this.logBox.scrollHeight}return}if(this.inp.style.display==""){this.innerHTML="<";this.title="Display command line";this.inp.style.display="none";this.cli.logBox.style.display="none"}else{this.innerHTML=">";this.title="Hide command line";var d=molmil.invertColor(molmil.rgbToHex(molmil.configBox.BGCOLOR[0]*255,molmil.configBox.BGCOLOR[1]*255,molmil.configBox.BGCOLOR[2]*255));this.cli.logBox.style.border="1px solid "+d;this.cli.logBox.style.borderBottom="";this.cli.logBox.style.borderRadius=".33em";this.cli.consoleBox.style.color=d;this.cli.logBox.style.backgroundColor="rgba("+molmil.configBox.BGCOLOR[0]*255+","+molmil.configBox.BGCOLOR[1]*255+","+molmil.configBox.BGCOLOR[2]*255+",.5)";this.inp.style.backgroundColor="rgb("+molmil.configBox.BGCOLOR[0]*255+","+molmil.configBox.BGCOLOR[1]*255+","+molmil.configBox.BGCOLOR[2]*255+")";this.inp.style.display="";this.cli.logBox.style.display="";this.cli.consoleBox.style.height=this.cli.consoleBox.style.maxHeight="calc("+this.cli.canvas.clientHeight+"px - 6em)";this.cli.consoleBox.style.overflow="";this.cli.logBox.style.pointerEvents="";this.inp.focus()}};this.logBox.onmouseover=function(){this.style.backgroundColor="rgba("+molmil.configBox.BGCOLOR[0]*255+","+molmil.configBox.BGCOLOR[1]*255+","+molmil.configBox.BGCOLOR[2]*255+",.85)"};this.logBox.onmouseout=function(){this.style.backgroundColor="rgba("+molmil.configBox.BGCOLOR[0]*255+","+molmil.configBox.BGCOLOR[1]*255+","+molmil.configBox.BGCOLOR[2]*255+",.25)"};this.inp=this.icon.inp=this.consoleBox.pushNode("span");this.inp.className="molmil_UI_cl_input";this.inp.style.display="none";this.inp.contentEditable=true;this.inp.cli=this.icon.cli=this;this.icon.logBox=this.inp.logBox=this.logBox;this.logBox.className="molmil_UI_cl_logbox";this.logBox.style.display="none";this.inp.console=this.environment.console;this.inp.onkeydown=function(c){var d=this.textContent;if(c.keyCode==13&&!c.shiftKey&&molmil.isBalancedStatement(d)){this.console.runCommand(d);this.textContent="";return false}if(c.keyCode==38&&c.ctrlKey){this.console.blSel++;if(this.console.blSel>=this.console.backlog.length){this.console.blSel=this.console.backlog.length-1}this.textContent=this.console.backlog[this.console.blSel]}if(c.keyCode==40&&c.ctrlKey){this.console.blSel--;if(this.console.blSel<-1){this.console.blSel=0}if(this.console.blSel==-1){this.textContent=this.console.buffer}else{this.textContent=this.console.backlog[this.console.blSel]}}if(this.console.blSel==-1){this.console.buffer=d}}};molmil.commandLine.prototype.eval=function(c){if(!this.altCommandIF(this.environment,c)){this.runCommand.apply(this.environment,[c])}};molmil.commandLine.prototype.runCommand=function(command){molmil.cli_canvas=this.cli_canvas;molmil.cli_soup=this.cli_soup;command=(" "+command).replace(/(\s|;)var\s+(\w+)\s*=/g,"$1this.$2 =");command=command.replace(/(\s|;)function\s+(\w+)/g,"$1this.$2 = function");command=command.replace(/(\s|;)return\sthis;/g,"$1return window;");try{with(this){eval(command)}}catch(e){this.console.error(e.message)}molmil.cli_canvas=null;molmil.cli_soup=null};molmil.isBalancedStatement=function(f){var l="[]{}()",c=[],g,h,d;for(g=0;h=f[g];g++){d=l.indexOf(h);if(d===-1){continue}if(d%2===0){c.push(d+1)}else{if(c.pop()!==d){return false}}}return c.length===0};molmil.commandLine.prototype.bindNullInterface=function(){if(this.altCommandIF){this.environment.console.log("Previous command interface unbound.")}this.altCommandIF=function(c,d){return false}};molmil.commandLine.prototype.bindPymolInterface=function(){this.environment.console.log("Pymol-like command interface bound.");this.pyMol={};this.pyMol.keywords={select:molmil.commandLines.pyMol.selectCommand,color:molmil.commandLines.pyMol.colorCommand,set_color:molmil.commandLines.pyMol.setColorCommand,show:molmil.commandLines.pyMol.showCommand};this.altCommandIF=molmil.commandLines.pyMol.tryExecute};molmil.commandLines.pyMol={};molmil.commandLines.pyMol.tryExecute=function(c,f){var d=(f.trim().match(/^[\S]+/)||[""])[0].toLowerCase();if(!this.pyMol.keywords.hasOwnProperty(d)||!this.pyMol.keywords[d].apply(null,[c,f])){return false}return true};molmil.commandLines.pyMol.selectCommand=function(c,f){f=f.match(/select[\s]+([a-zA-Z0-9_]+)[\s]*,[\s]*(.*)/);try{c[f[1]]=molmil.commandLines.pyMol.select.apply(c,[f[2]])}catch(d){return false}return true};molmil.commandLines.pyMol.colorCommand=function(c,f){f=f.match(/color[\s]+([a-zA-Z0-9_]+)[\s]*,[\s]*(.*)/);try{molmil.commandLines.pyMol.color.apply(c,[f[1],f[2]])}catch(d){return false}return true};molmil.commandLines.pyMol.setColorCommand=function(c,d){d=d.match(/set_color[\s]+([a-zA-Z0-9_]+)[\s]*,[\s]*(.*)/);molmil.commandLines.pyMol.set_color(d[1],JSON.parse(d[2]));return true};molmil.commandLines.pyMol.showCommand=function(c,f){f=f.match(/show[\s]+([a-zA-Z0-9_]+)[\s]*,[\s]*(.*)/);try{molmil.commandLines.pyMol.show.apply(c,[f[1],f[2]])}catch(d){return false}return true};molmil.quickSelect=molmil.commandLines.pyMol.select=molmil.commandLines.pyMol.pymolSelectEngine=function(expr,soup){if(!molmil.isBalancedStatement(expr)){throw"Incorrect statement"}var new_expr="";var word="",key,toUpper=false,ss=false,ss_conv={h:3,s:2,l:1};this.soupObject=this.soupObject||molmil.cli_soup||soup||this.cli_soup;var sub_expr_handler=function(){if(key&&word){if(toUpper){word=word.toUpperCase()}else{if(ss){if(word){word=ss_conv[word]}tmp=ss_conv[tmp]}}new_expr+=key.replace("%s",word)}else{if(word=="hydro"){new_expr+="this.soupObject.atomRef[a].molecule.water == true"}else{if(word=="hetatm"){new_expr+="this.soupObject.atomRef[a].molecule.ligand == true"}}}};for(var i=0;i<expr.length;i++){if(expr[i].match(/\s/)){toUpper=false,ss=false;if(word=="name"){key="this.soupObject.atomRef[a].atomName == '%s'";toUpper=true}else{if(word=="symbol"){key="this.soupObject.atomRef[a].element == '%s'"}else{if(word=="resn"){key="this.soupObject.atomRef[a].molecule.name.toLowerCase() == '%s'.toLowerCase()"}else{if(word=="resi"){key="this.soupObject.atomRef[a].molecule.RSID == %s"}else{if(word=="ss"){key="this.soupObject.atomRef[a].molecule.sndStruc == %s";ss=true}else{if(word=="chain"){key="this.soupObject.atomRef[a].molecule.chain.name == '%s'"}else{if(word=="hydro"){new_expr+="this.soupObject.atomRef[a].molecule.water == true"}else{if(word=="hetatm"){new_expr+="this.soupObject.atomRef[a].molecule.ligand == true"}else{if(word=="and"){new_expr+=" && "}else{if(word=="or"){new_expr+=" || "}else{if(key&&word){new_expr+=key.replace("%s",word)}else{key=""}}}}}}}}}}}word=""}else{if(expr[i]=="+"&&key){var tmp=expr.substr(i+1),pos=tmp.search(/[^a-zA-Z0-9]/),tmp=pos!=-1?tmp.substr(0,pos):tmp;if(tmp){if(toUpper){tmp=tmp.toUpperCase();word=word.toUpperCase()}if(ss){if(word){word=ss_conv[word]}tmp=ss_conv[tmp]}new_expr+=(word?key.replace("%s",word):"")+" || "+key.replace("%s",tmp);word=""}i+=pos==-1?tmp.length:pos}else{if(expr[i]=="-"){var tmp=expr.substr(i+1),pos=tmp.search(/[^a-zA-Z0-9]/),tmp=pos!=-1?tmp.substr(0,pos):tmp;new_expr+="("+key.replace(/ == %s/," >= "+word)+" && "+key.replace(/ == %s/," <= "+tmp)+")";word="";i+=pos==-1?tmp.length:pos}else{if(expr[i].match(/\(|\)|!/)){sub_expr_handler();new_expr+=expr[i];key=word=""}else{word+=expr[i]}}}}}sub_expr_handler();var list=[];new_expr="for (var a in this.soupObject.atomRef) if ("+new_expr+") list.push(this.soupObject.atomRef[a]);";try{eval(new_expr)}catch(e){this.console.error("Unable to process PyMol command: "+e)}return list};molmil.commandLines.pyMol.color=function(f,d,g){if(typeof d!="object"){if(this.hasOwnProperty(d)){d=this[d]}else{d=molmil.commandLines.pyMol.select(d)}}if(f=="default"){var c=[];for(var l=0;l<d.length;l++){c.push(d[l].molecule)}molmil.colorEntry(c,1,null,g)}else{if(f=="structure"){var c=[];for(var l=0;l<d.length;l++){c.push(d[l].molecule)}molmil.colorEntry(c,2,null,g)}else{if(f=="cpk"){molmil.colorEntry(d,3,null,g)}else{if(f=="group"){var c=[];for(var l=0;l<d.length;l++){c.push(d[l].molecule)}molmil.colorEntry(c,4,null,g)}else{if(f=="chain"){var c=[];for(var l=0;l<d.length;l++){c.push(d[l].molecule)}molmil.colorEntry(c,5,null,g)}else{if(typeof f=="string"){var h=this.colors[f];if(!h){h=JSON.parse(f);if(h[0]>1||h[1]>1||h[2]>1||h[3]>1){h=[h[0],h[1],h[2],h[3]]}}}else{var h=f}for(var l=0;l<d.length;l++){d[l].rgba=h;if(d[l].molecule.CA==d[l]){d[l].molecule.rgba=h}}if(!g){this.soupObject.renderer.initBuffers();this.soupObject.renderer.canvas.update=true}}}}}}};molmil.commandLines.pyMol.set_color=function(c,d){if(d[0]>1||d[1]>1||d[2]>1||d[3]>1){d=[d[0],d[1],d[2],d[3]]}this.colors[c]=d};molmil.commandLines.pyMol.show=function(c,d,f){if(typeof d!="object"){if(this.hasOwnProperty(d)){d=this[d]}else{d=molmil.commandLines.pyMol.select(d)}}if(c=="spheres"){for(var g=0;g<d.length;g++){d[g].displayMode=1;if(d[g].molecule.CA==d[g]){d[g].molecule.displayMode=0;d[g].molecule.showSC=true;d[g].molecule.chain.twoDcache=null}}}else{if(c=="ball_stick"){for(var g=0;g<d.length;g++){d[g].displayMode=2;if(d[g].molecule.CA==d[g]){d[g].molecule.displayMode=0;d[g].molecule.showSC=true;d[g].molecule.chain.twoDcache=null}}}else{if(c=="sticks"){for(var g=0;g<d.length;g++){d[g].displayMode=3;if(d[g].molecule.CA==d[g]){d[g].molecule.displayMode=0;d[g].molecule.showSC=true;d[g].molecule.chain.twoDcache=null}}}else{if(c=="lines"){for(var g=0;g<d.length;g++){d[g].displayMode=4;if(d[g].molecule.CA==d[g]){d[g].molecule.displayMode=0;d[g].molecule.showSC=true;d[g].molecule.chain.twoDcache=null}}}else{if(c=="cartoon"){for(var g=0;g<d.length;g++){d[g].displayMode=0;if(d[g].molecule.CA==d[g]){d[g].molecule.displayMode=3;d[g].molecule.showSC=false}}}else{if(c=="tube"){for(var g=0;g<d.length;g++){d[g].displayMode=0;if(d[g].molecule.CA==d[g]){d[g].molecule.displayMode=2;d[g].molecule.showSC=false}}}else{if(c=="ca-trace"){for(var g=0;g<d.length;g++){d[g].displayMode=0;if(d[g].molecule.CA==d[g]){d[g].molecule.displayMode=1;d[g].molecule.showSC=false}}}}}}}}}if(!f){this.soupObject.renderer.initBuffers();this.soupObject.renderer.canvas.update=true}};molmil.bindCanvasInputs=function(d){var c=function(g){g.preventDefault();return false};var f=function(p){p.preventDefault();var o=0,n=[];try{n=p.dataTransfer.files;o=n.length}catch(q){}var g,l,h;for(l=0;l<o;l++){g=new FileReader();g.filename=n[l].name;g.fileHandle=n[l];for(h=0;h<this.inputFunctions.length;h++){if(this.inputFunctions[h](d,g)){break}}}return false};d.addEventListener("dragover",c);d.addEventListener("dragenter",c);d.addEventListener("drop",f);d.inputFunctions=[];d.inputFunctions.push(function(h,g){if(g.filename.indexOf(".gz",g.filename.length-3)!==-1){if(!window.hasOwnProperty("pako")){var l=molmil_dep.dcE("script");l.src=molmil.settings.src+"pako.js";document.getElementsByTagName("head")[0].appendChild(l)}g.onload=function(o){if(!window.hasOwnProperty("pako")){return molmil_dep.asyncStart(this.onload,[o],this,50)}var n={filename:g.filename.substr(0,g.filename.length-3)};n.readAsText=function(){var p=pako.inflate(new Uint8Array(o.target.result),{to:"string"});this.onload({target:{result:p}})};n.readAsArrayBuffer=function(){var p=pako.inflate(new Uint8Array(o.target.result));this.onload({target:{result:p.buffer}})};for(j=0;j<h.inputFunctions.length;j++){if(h.inputFunctions[j](h,n)){break}}};g.readAsArrayBuffer(g.fileHandle);return true}});d.inputFunctions.push(function(h,g){if(g.filename.indexOf(".pdb",g.filename.length-4)!==-1||g.filename.indexOf(".ent",g.filename.length-4)!==-1){g.onload=function(l){h.molmilViewer.loadStructureData(l.target.result,4,this.filename)};g.readAsText(g.fileHandle);return true}});d.inputFunctions.push(function(h,g){if(g.filename.indexOf(".cif",g.filename.length-4)!==-1){g.onload=function(l){h.molmilViewer.loadStructureData(l.target.result,"cif",this.filename)};g.readAsText(g.fileHandle);return true}});d.inputFunctions.push(function(h,g){if(g.filename.indexOf(".gro",g.filename.length-4)!==-1){g.onload=function(l){h.molmilViewer.loadStructureData(l.target.result,7,this.filename)};g.readAsText(g.fileHandle);return true}});d.inputFunctions.push(function(h,g){if(g.filename.indexOf(".trr",g.filename.length-4)!==-1){g.onload=function(l){h.molmilViewer.loadStructureData(l.target.result,"gromacs-trr",this.filename)};g.readAsArrayBuffer(g.fileHandle);return true}});d.inputFunctions.push(function(h,g){if(g.filename.indexOf(".xtc",g.filename.length-4)!==-1){g.onload=function(l){h.molmilViewer.loadStructureData(l.target.result,"gromacs-xtc",this.filename)};g.readAsArrayBuffer(g.fileHandle);return true}});d.inputFunctions.push(function(h,g){if(g.filename.indexOf(".cor",g.filename.length-4)!==-1){g.onload=function(l){h.molmilViewer.loadStructureData(l.target.result,"psygene-traj",this.filename)};g.readAsArrayBuffer(g.fileHandle);return true}});d.inputFunctions.push(function(h,g){if(g.filename.indexOf(".mpbf",g.filename.length-5)!==-1){g.onload=function(l){h.molmilViewer.loadStructureData(l.target.result,8,this.filename)};g.readAsArrayBuffer(g.fileHandle);return true}});d.inputFunctions.push(function(h,g){if(g.filename.indexOf(".ccp4",g.filename.length-5)!==-1){g.onload=function(l){h.molmilViewer.loadStructureData(l.target.result,"ccp4",this.filename)};g.readAsArrayBuffer(g.fileHandle);return true}});d.inputFunctions.push(function(h,g){if(g.filename.indexOf(".mdl",g.filename.length-4)!==-1){g.onload=function(l){h.molmilViewer.loadStructureData(l.target.result,"mdl",this.filename)};g.readAsText(g.fileHandle);return true}});d.inputFunctions.push(function(h,g){if(g.filename.indexOf(".mol2",g.filename.length-5)!==-1){g.onload=function(l){h.molmilViewer.loadStructureData(l.target.result,"mol2",this.filename)};g.readAsText(g.fileHandle);return true}});d.inputFunctions.push(function(h,g){if(g.filename.indexOf(".xyz",g.filename.length-5)!==-1){g.onload=function(l){h.molmilViewer.loadStructureData(l.target.result,"xyz",this.filename)};g.readAsText(g.fileHandle);return true}})};molmil.initVideo=function(d){var c=new molmil_dep.CallRemote("POST");c.ASYNC=true;c.UI=d;c.OnDone=function(){var f=JSON.parse(this.request.responseText);if(!f.found){return this.OnError()}molmil_dep.asyncStart(this.UI.videoRenderer,[],this.UI,0)};c.OnError=function(){alert("The support server to construct the video could not be found...")};c.Send(molmil.settings.molmil_video_url+"has_molmil_video_support")};molmil.setSlab=function(f,c,d){d=d||molmil.cli_soup;if(!d.renderer.settings.slab){d.renderer.settings.slab=true;molmil.configBox.glsl_fog=false;molmil.shaderEngine.recompile(d.renderer)}d.renderer.settings.slabNear=f;d.renderer.settings.slabFar=c;d.canvas.update=true};molmil.selectAtoms=function(f,c,g){g=g||molmil.cli_soup;if(!c){g.atomSelection=[]}for(var d=0;d<f.length;d++){g.atomSelection.push(f[d])}};molmil.selectionFocus=function(d){d=d||molmil.cli_soup;var l,p,n,q=d.renderer.modelId,h=0,g=0,f=0;var c=[1e+99,-1e+99,1e+99,-1e+99,1e+99,-1e+99];for(var o=0;o<d.atomSelection.length;o++){p=d.atomSelection[o].xyz;n=d.atomSelection[o].chain.modelsXYZ[q];l=[n[p],n[p+1],n[p+2]];h+=l[0];g+=l[1];f+=l[2]}h/=d.atomSelection.length;g/=d.atomSelection.length;f/=d.atomSelection.length;for(var o=0;o<d.atomSelection.length;o++){p=d.atomSelection[o].xyz;n=d.atomSelection[o].chain.modelsXYZ[q];l=[n[p]-h,n[p+1]-g,n[p+2]-f];if(l[0]<c[0]){c[0]=l[0]}if(l[0]>c[1]){c[1]=l[0]}if(l[1]<c[2]){c[2]=l[1]}if(l[1]>c[3]){c[3]=l[1]}if(l[2]<c[4]){c[4]=l[2]}if(l[2]>c[5]){c[5]=l[2]}}d.renderer.camera.z=d.calcZ(c);d.setCOR([h,g,f]);d.renderer.camera.x=d.renderer.camera.y=0;d.renderer.modelViewMatrix=d.renderer.camera.generateMatrix();d.canvas.atomCORset=false};molmil.selectSequence=function(u,o){o=o||molmil.cli_soup;var h=[],q={A:"ALA",C:"CYS",D:"ASP",E:"GLU",F:"PHE",G:"GLY",H:"HIS",I:"ILE",K:"LYS",L:"LEU",M:"MET",N:"ASN",P:"PRO",Q:"GLN",R:"ARG",S:"SER",T:"THR",V:"VAL",W:"TRP",Y:"TYR"};molmil.AATypesBase={ALA:1,CYS:1,ASP:1,GLU:1,PHE:1,GLY:1,HIS:1,ILE:1,LYS:1,LEU:1,MET:1,ASN:1,PRO:1,GLN:1,ARG:1,SER:1,THR:1,VAL:1,TRP:1,TYR:1,ACE:1,NME:1,HIP:1,HIE:1,HID:1};for(var l=0;l<u.length;l++){if(q.hasOwnProperty(u[l])){h.push(q[u[l]])}else{h.push("***")}}var f=[],t,s,d,g;for(var p=0;p<o.chains.length;p++){for(t=0;t<o.chains[p].molecules.length;t++){g=true;for(s=t,d=0;s<Math.min(o.chains[p].molecules.length,t+h.length);s++,d++){if(o.chains[p].molecules[s].name!=h[d]){g=false;break}}if(g){for(s=t;s<t+h.length;s++){f.push(o.chains[p].molecules[s])}}}}return f};molmil.mergeStructuresToModels=function(c){};molmil.splitModelsToStructures=function(c){};if(typeof(requestAnimationFrame)!="undefined"){molmil.animate_molmilViewers()}if(!window.molmil_dep){var dep=document.createElement("script");dep.src=molmil.settings.src+"molmil_dep.js";var head=document.getElementsByTagName("head")[0];head.appendChild(dep)}molmil.initSettings();