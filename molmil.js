/*!
 * molmil.js
 *
 * Molmil molecular web viewer: https://github.com/gjbekker/molmil
 * 
 * By Gert-Jan Bekker
 * License: LGPLv3
 *   See https://github.com/gjbekker/molmil/blob/master/LICENCE.md
 */
;var molmil=molmil||{};molmil.canvasList=[];molmil.mouseDown=false;molmil.mouseDownS={};molmil.mouseMoved=false;molmil.Xcoord=0;molmil.Ycoord=0;molmil.Zcoord=0;molmil.activeCanvas=null;molmil.touchList=null;molmil.touchMode=false;molmil.longTouchTID=null;molmil.previousTouchEvent=null;molmil.ignoreBlackList=false;molmil.settings_default={src:"/molmil/",pdb_url:"http://ipr.pdbj.org/rest/displayPDBfile?format=mmjson-all&id=__ID__",comp_url:"http://ipr.pdbj.org/rest/displayCOMPfile?format=mmjson&id=__ID__",promodeE_check_url:"http://ipr.pdbj.org/rest/quick_search?fields=5&query=__ID__",promodeE_base_structure_url:"http://ipr.pdbj.org/rest/displayPromodeEfile?format=min&id=__ID__",promodeE_mode_vectors_url:"http://ipr.pdbj.org/rest/displayPromodeEfile?format=vec&id=__ID_____MODE__",promodeE_animation_url:"http://ipr.pdbj.org/rest/displayPromodeEfile?format=anm&id=__ID_____MODE__",molmil_video_url:"http://127.0.0.1:8080/app/"};molmil.cli_canvas=null;molmil.cli_soup=null;molmil.settings=window.molmil_settings||molmil.settings_default;for(var e in molmil.settings_default){if(!molmil.settings.hasOwnProperty(e)){molmil.settings[e]=molmil.settings_default[e]}}molmil.configBox={initFinished:false,vdwR:{DUMMY:1.7,H:1.09,D:1.09,C:1.7,N:1.55,O:1.52,S:1.8,Cl:1.75,B:1.8,P:1.8,Fe:1.8,Ba:1.8,So:1.8,Mg:1.8,Zn:1.8,Cu:1.4,Ni:1.8,Br:1.95,Ca:1.8,Mn:1.8,Al:1.8,Ti:1.8,Cr:1.8,Ag:1.8,F:1.47,Si:1.8,Au:1.8,I:2.15,Li:1.8,He:1.8,Se:1.9},sndStrucInfo:{1:[255,255,255],2:[255,255,0],3:[255,0,255],4:[0,0,255]},zNear:20,zFar:20000,QLV_SETTINGS:[{SPHERE_TESS_LV:0,CB_NOI:4,CB_NOVPR:4,CB_DOME_TESS_LV:0},{SPHERE_TESS_LV:1,CB_NOI:4,CB_NOVPR:8,CB_DOME_TESS_LV:1},{SPHERE_TESS_LV:2,CB_NOI:8,CB_NOVPR:16,CB_DOME_TESS_LV:2},{SPHERE_TESS_LV:3,CB_NOI:12,CB_NOVPR:32,CB_DOME_TESS_LV:3},{SPHERE_TESS_LV:4,CB_NOI:16,CB_NOVPR:32,CB_DOME_TESS_LV:4}],OES_element_index_uint:null,BGCOLOR:[0,0,0,1],backboneAtoms4Display:{N:1,C:1,O:1,H:1,OXT:1,H1:1,H2:1,H3:1,HA:1,HA2:1,HA3:1},backboneAtoms4DisplayXNA:{P:1,"O5'":1,OP1:1,OP2:1,"C3'":1,"C4'":1,"C5'":1,"O4'":1,"C2'":1,"O3'":1,"O2'":1,H:1},xna_simple_base_atoms:{"O5'":1,"C5'":1,"C4'":1,"O4'":1,"C3'":1,"O3'":1,"C2'":1,O6:1,N2:1,N4:1,P:1,OP1:1,OP2:1,O2:1,"O2'":1,N6:1,O4:1,"DO3'":1,D41:1,D42:1,D21:1,D22:1,D61:1,D62:1},projectionMode:1,colorMode:1,smoothFactor:2,glsl_shaders:[["shaders/standard.glsl"],["shaders/lines.glsl"],["shaders/picking.glsl"],["shaders/linesPicking.glsl"],["shaders/atomSelection.glsl"],["shaders/lines.glsl","lines_uniform_color","#define UNIFORM_COLOR 1\n"],["shaders/standard.glsl","standard_alpha","#define ALPHA_MODE 1\n"],["shaders/standard.glsl","standard_uniform_color","#define UNIFORM_COLOR 1\n"],["shaders/standard.glsl","standard_alpha_uniform_color","#define ALPHA_MODE 1\n#define UNIFORM_COLOR 1\n"]],glsl_fog:0,skipClearGeometryBuffer:true};molmil.AATypes={ALA:1,CYS:1,ASP:1,GLU:1,PHE:1,GLY:1,HIS:1,ILE:1,LYS:1,LEU:1,MET:1,ASN:1,PRO:1,GLN:1,ARG:1,SER:1,THR:1,VAL:1,TRP:1,TYR:1,ACE:1,NME:1,HIP:1,HIE:1,HID:1,CYX:1,A:1,T:1,G:1,C:1,DA:1,DT:1,DG:1,DC:1,U:1,DU:1,MSE:1,SEQ:1,CSW:1};molmil.AATypesBase={ALA:1,CYS:1,ASP:1,GLU:1,PHE:1,GLY:1,HIS:1,ILE:1,LYS:1,LEU:1,MET:1,ASN:1,PRO:1,GLN:1,ARG:1,SER:1,THR:1,VAL:1,TRP:1,TYR:1,ACE:1,NME:1,HIP:1,HIE:1,HID:1};molmil.initSettings=function(){var c,g=localStorage.getItem("molmil.settings_COLORS")||1;if(g==2){c={DUMMY:[255,20,147],H:[255,255,255],D:[255,255,255],C:[144,144,144],N:[48,80,248],O:[255,13,13],S:[255,255,48],Cl:[31,240,31],B:[255,181,181],P:[255,128,0],Fe:[224,102,51],Ba:[0,201,0],Mg:[138,255,0],Zn:[125,128,176],Cu:[200,128,51],Ni:[80,208,80],Br:[165,42,42],Ca:[61,255,0],Mn:[156,122,199],Al:[191,166,166],Ti:[191,194,199],Cr:[138,153,199],Ag:[192,192,192],F:[144,224,80],Si:[240,200,160],Au:[255,209,35],I:[148,0,148],Li:[204,128,255],He:[217,255,255]}}else{if(g==3){c={DUMMY:[255,127,0],H:[204,204,204],D:[204,204,204],C:[0,255,255],N:[0,0,255],O:[255,0,0],P:[255,255,0],S:[0,255,0]}}else{c={DUMMY:[255,20,147],H:[255,255,255],D:[255,255,255],C:[200,200,200],N:[143,143,255],O:[240,0,0],S:[255,200,50],Cl:[0,255,0],B:[0,255,0],P:[255,165,0],Fe:[255,165,0],Ba:[255,165,0],Mg:[34,139,34],Zn:[165,42,42],Cu:[165,42,42],Ni:[165,42,42],Br:[165,42,42],Ca:[128,128,144],Mn:[128,128,144],Al:[128,128,144],Ti:[128,128,144],Cr:[128,128,144],Ag:[128,128,144],F:[218,165,32],Si:[218,165,32],Au:[218,165,32],I:[160,32,240],Li:[178,34,34],He:[255,192,203]}}}molmil.configBox.elementColors={};for(var f in c){molmil.configBox.elementColors[f]=[c[f][0],c[f][1],c[f][2],255]}molmil.configBox.sndStrucColor={};for(var f in molmil.configBox.sndStrucInfo){molmil.configBox.sndStrucColor[f]=[molmil.configBox.sndStrucInfo[f][0],molmil.configBox.sndStrucInfo[f][1],molmil.configBox.sndStrucInfo[f][2],255]}molmil.configBox.bu_colors=[[0,204,255],[255,51,255],[0,255,102],[153,102,255],[255,255,0],[204,102,102],[153,204,102],[204,153,204],[153,153,102],[0,204,204],[153,153,153],[51,153,204],[0,255,153],[51,153,255],[204,102,153],[0,255,204],[51,204,255],[204,102,204],[0,255,255],[102,153,204],[204,153,0],[51,204,102],[102,153,255],[204,153,51],[51,204,153],[102,204,255],[204,153,102],[51,204,204],[153,102,204],[204,153,153],[51,255,51],[51,255,102],[153,153,204],[204,204,0],[51,255,153],[153,153,255],[204,204,51],[51,255,204],[153,204,255],[204,204,102],[51,255,255],[204,102,255],[204,204,153],[102,153,153],[204,153,255],[204,204,204],[102,204,51],[204,204,255],[255,51,204],[102,204,102],[102,204,153],[255,102,51],[102,204,204],[255,102,102],[102,255,0],[255,102,153],[102,255,51],[255,102,204],[102,255,102],[255,102,255],[102,255,153],[255,153,0],[102,255,204],[255,153,51],[102,255,255],[255,153,102],[153,204,0],[255,153,153],[153,204,51],[255,153,204],[255,153,255],[153,204,153],[255,204,0],[153,204,204],[255,204,51],[153,255,0],[255,204,102],[153,255,51],[255,204,153],[153,255,102],[255,204,204],[153,255,153],[255,204,255],[153,255,204],[153,255,255],[255,255,51],[204,255,0],[255,255,102],[204,255,51],[255,255,153],[204,255,102],[255,255,204],[204,255,153],[255,255,255],[204,255,204],[204,255,255]];molmil.configBox.glsl_fog=localStorage.getItem("molmil.settings_glsl_fog")==1;molmil.configBox.projectionMode=localStorage.getItem("molmil.settings_PROJECTION")||1;molmil.configBox.smoothFactor=localStorage.getItem("molmil.settings_BBSF")||2;var d=localStorage.getItem("molmil.settings_BGCOLOR");if(d){try{molmil.configBox.BGCOLOR=JSON.parse(d)}catch(f){}}};molmil.displayMode_None=0;molmil.displayMode_Default=1;molmil.displayMode_Spacefill=2;molmil.displayMode_Spacefill_SC=2.5;molmil.displayMode_BallStick=3;molmil.displayMode_BallStick_SC=3.5;molmil.displayMode_Stick=4;molmil.displayMode_Stick_SC=4.5;molmil.displayMode_Wireframe=5;molmil.displayMode_Wireframe_SC=5.5;molmil.displayMode_CaTrace=6;molmil.displayMode_Tube=7;molmil.displayMode_Cartoon=8;molmil.displayMode_ChainSurfaceCG=10;molmil.displayMode_XNA=400;molmil.colorEntry_Default=1;molmil.colorEntry_Structure=2;molmil.colorEntry_CPK=3;molmil.colorEntry_Group=4;molmil.colorEntry_Chain=5;molmil.colorEntry_Custom=6;molmil.colorEntry_ChainAlt=7;molmil.atomObject=function(h,f,d,g,c){this.xyz=h;this.element=d.charAt(0).toUpperCase()+d.slice(1).toLowerCase();this.atomName=f;this.displayMode=0;this.status=1;this.rgba=[0,0,0,255];this.molecule=g;this.chain=c;this.radius=0;this.AID=0};molmil.atomObject.prototype.toString=function(){return" Atom "+this.atomName+" ("+this.AID+")"};molmil.molObject=function(c,f,d){this.atoms=[];this.name=c;this.id=f;this.RSID=f;this.chain=d;this.ligand=true;this.water=false;this.status=1;this.next=null,this.previous=null;this.rgba=[0,0,0,255];this.sndStruc=1;this.xna=false;this.showSC=false};molmil.molObject.prototype.toString=function(){return" Residue"};molmil.chainObject=function(c,d){this.name=c;this.authName=c;this.molecules=[];this.entry=d;this.display=true;this.modelsXYZ=[[]];this.atoms=[];this.bonds=[];this.bondsOK=false;this.displayMode=molmil.displayMode_Default;this.isHet=true};molmil.chainObject.prototype.toString=function(){return" Chain"};molmil.entryObject=function(c){this.chains=[];this.meta=c||{}};molmil.polygonObject=function(c){this.programs=[];this.meta=c||{}};molmil.entryObject.prototype.toString=function(){return" Entry"};molmil.animationObj=function(c){this.soup=c;this.renderer=c.renderer;this.frameNo=0;this.motionMode=1;this.init=false;this.delay=66;this.frameAction=function(){};this.detail_or=-1;this.infoBox=null};molmil.animationObj.prototype.initialise=function(c){this.renderer.animationMode=true;this.number_of_frames=this.soup.structures.length?this.soup.structures[0].number_of_frames:0;this.init=true;this.infoBox=c};molmil.animationObj.prototype.updateInfoBox=function(){if(!this.infoBox){return}if(this.infoBox.timeBox){if(this.soup.frameInfo){this.infoBox.timeBox.innerHTML=this.soup.frameInfo[this.frameNo][1]+"ps"}else{this.infoBox.timeBox.innerHTML=this.frameNo}}if(this.infoBox.sliderBox){if(this.soup.frameInfo){this.infoBox.timeBox.value=this.soup.frameInfo[this.frameNo][1]}else{this.infoBox.timeBox.value=this.frameNo}this.infoBox.sliderBox.value=this.frameNo}};molmil.animationObj.prototype.beginning=function(){if(!this.init){this.initialise()}this.frameNo=0;this.renderer.selectFrame(this.frameNo,this.detail_or);this.soup.canvas.update=true;this.frameAction();this.updateInfoBox()};molmil.animationObj.prototype.go2Frame=function(c){if(!this.init){this.initialise()}this.frameNo=c;this.renderer.selectFrame(this.frameNo,this.detail_or);this.soup.canvas.update=true;this.frameAction();this.updateInfoBox()};molmil.animationObj.prototype.previous=function(){if(!this.init){this.initialise()}this.frameNo-=1;if(this.frameNo<0){this.frameNo=0}this.renderer.selectFrame(this.frameNo,this.detail_or);this.soup.canvas.update=true;this.frameAction();this.updateInfoBox()};molmil.animationObj.prototype.pause=function(){if(this.TID){clearTimeout(this.TID);this.TID=null}};molmil.animationObj.prototype.play=function(){if(!this.init){this.initialise()}this.playing=true;if(this.motionMode==2){this.TID=molmil_dep.asyncStart(this.backwardRenderer,[],this,this.delay)}else{this.TID=molmil_dep.asyncStart(this.forwardRenderer,[],this,this.delay)}};molmil.animationObj.prototype.next=function(){if(!this.init){this.initialise()}this.frameNo+=1;if(this.frameNo>=this.number_of_frames){this.frameNo=this.number_of_frames-1}this.renderer.selectFrame(this.frameNo,this.detail_or);this.soup.canvas.update=true;this.frameAction();this.updateInfoBox()};molmil.animationObj.prototype.end=function(){if(!this.init){this.initialise()}this.frameNo=this.number_of_frames-1;this.renderer.selectFrame(this.frameNo,this.detail_or);this.soup.canvas.update=true;this.frameAction();this.updateInfoBox()};molmil.animationObj.prototype.forwardRenderer=function(){this.frameNo+=1;if(this.frameNo>=this.number_of_frames){if(this.motionMode==3){this.frameNo-=1;return this.backwardRenderer()}else{this.playing=false}}else{this.renderer.selectFrame(this.frameNo,this.detail_or);this.soup.canvas.update=true;this.TID=molmil_dep.asyncStart(this.forwardRenderer,[],this,this.delay);this.frameAction();this.updateInfoBox()}};molmil.animationObj.prototype.backwardRenderer=function(){this.frameNo-=1;if(this.frameNo<0){if(this.motionMode==3){this.frameNo+=1;return this.forwardRenderer()}else{this.playing=false}}else{this.renderer.selectFrame(this.frameNo,this.detail_or);this.soup.canvas.update=true;this.TID=molmil_dep.asyncStart(this.backwardRenderer,[],this,this.delay);this.frameAction();this.updateInfoBox()}};molmil.viewer=function(c){this.canvas=c;this.renderer=new molmil.render(this);this.UI=new molmil.UI(this);this.defaultCanvas=[c,this.renderer];this.onAtomPick=function(){};this.animation=new molmil.animationObj(this);this.clear()};molmil.viewer.prototype.toString=function(){return" SOUP"};molmil.viewer.prototype.reloadSettings=function(){this.renderer.reloadSettings()};molmil.viewer.prototype.clear=function(){this.structureFiles=[];this.trajectory=[];this.structures=[];this.chains=[];this.files=[];this.bumats=[];this.BUmatrices={};this.BUassemblies={};this.poly_asym_ids=[];this.BUcache={};this.BUmode=false;this.avgX=0;this.avgY=0;this.avgZ=0;this.stdX=0;this.stdY=0;this.stdZ=0;this.avgXYZ=[];this.stdXYZ=[];this.COR=[0,0,0];this.geomRanges=[0,0,0,0,0,0];this.maxRange=0;this.atomRef={};this.AID=1;this.CID=1;this.MID=1;this.BU=false;this.atomSelection=[];this.hideWaters=false;this.hideHydrogens=false;this.sceneBU=null;this.canvases=[];this.SCstuff=false;if(this.canvas){this.canvas.atomCORset=false;this.canvases=[this.canvas]}this.renderer.clear()};molmil.viewer.prototype.gotoMol=function(j){if(j.N&&j.CA&&j.C){var l,i,h,g=[0,0,0];var l=[j.chain.modelsXYZ[this.renderer.modelId][j.N.xyz],j.chain.modelsXYZ[this.renderer.modelId][j.N.xyz+1],j.chain.modelsXYZ[this.renderer.modelId][j.N.xyz+2]];var i=[j.chain.modelsXYZ[this.renderer.modelId][j.C.xyz],j.chain.modelsXYZ[this.renderer.modelId][j.C.xyz+1],j.chain.modelsXYZ[this.renderer.modelId][j.C.xyz+2]];var h=[j.chain.modelsXYZ[this.renderer.modelId][j.CA.xyz],j.chain.modelsXYZ[this.renderer.modelId][j.CA.xyz+1],j.chain.modelsXYZ[this.renderer.modelId][j.CA.xyz+2]];l[0]-=this.avgXYZ[0];l[1]-=this.avgXYZ[1];l[2]-=this.avgXYZ[2];i[0]-=this.avgXYZ[0];i[1]-=this.avgXYZ[1];i[2]-=this.avgXYZ[2];h[0]-=this.avgXYZ[0];h[1]-=this.avgXYZ[1];h[2]-=this.avgXYZ[2];g[0]=h[0]-((l[0]+i[0])*0.5);g[1]=h[1]-((l[1]+i[1])*0.5);g[2]=h[2]-((l[2]+i[2])*0.5);vec3.normalize(g,g);this.renderer.camera.reset();var f=[l[0]-h[0],l[1]-h[1],l[2]-h[2]];vec3.normalize(f,f);var d=[i[0]-h[0],i[1]-h[1],i[2]-h[2]];vec3.normalize(d,d);var c=vec3.cross([0,0,0],f,d);vec3.normalize(c,c);var n=[g[0]*5-h[0],g[1]*5-h[1],g[2]*5-h[2]];var q=vec3.cross([0,0,0],g,c);vec3.normalize(q,q);var p=vec3.cross([0,0,0],q,g);var o=mat4.create();o[0]=q[0];o[4]=q[1];o[8]=q[2];o[1]=p[0];o[5]=p[1];o[9]=p[2];o[2]=-g[0];o[6]=-g[1];o[10]=-g[2];o[12]=-vec3.dot(q,n);o[13]=-vec3.dot(p,n);o[14]=-vec3.dot(g,n);this.renderer.camera.x=-o[12];this.renderer.camera.y=-o[13];this.renderer.camera.z=o[14]-molmil.configBox.zNear;quat.fromMat3(this.renderer.camera.QView,mat3.fromMat4(mat3.create(),o));quat.normalize(this.renderer.camera.QView,this.renderer.camera.QView)}};molmil.viewer.prototype.waterToggle=function(g){for(var d=0,h,f;d<this.structures.length;d++){if(!this.structures[d].chains){continue}for(h=0;h<this.structures[d].chains.length;h++){for(f=0;f<this.structures[d].chains[h].atoms.length;f++){if(this.structures[d].chains[h].atoms[f].molecule.water){this.structures[d].chains[h].atoms[f].status=g}}}}this.hideWaters=!g};molmil.viewer.prototype.hydrogenToggle=function(g){for(var d=0,h,f;d<this.structures.length;d++){if(!this.structures[d].chains){continue}for(h=0;h<this.structures[d].chains.length;h++){for(f=0;f<this.structures[d].chains[h].atoms.length;f++){if(this.structures[d].chains[h].atoms[f].element=="H"||this.structures[d].chains[h].atoms[f].element=="D"){this.structures[d].chains[h].atoms[f].status=g}}}}this.hideHydrogens=!g};molmil.viewer.prototype.restoreDefaultCanvas=function(c){this.canvas=this.defaultCanvas[0];this.renderer=this.defaultCanvas[1]};molmil.getSelectedAtom=function(d,c){d=d||0;c=c||molmil.cli_soup;if(d>=c.atomSelection.length){return}return c.atomSelection[d]};molmil.viewer.prototype.selectObject=function(o,n,c){n=this.canvas.height-n;var g=this.renderer.gl;if(!this.renderer.FBOs.pickingBuffer){this.renderer.FBOs.pickingBuffer=new molmil.FBO(g,this.renderer.width,this.renderer.height);this.renderer.FBOs.pickingBuffer.addTexture("colourBuffer",g.RGBA,g.RGBA);this.renderer.FBOs.pickingBuffer.setup()}else{if(this.renderer.FBOs.pickingBuffer.width!=this.renderer.width||this.renderer.FBOs.pickingBuffer.height!=this.renderer.height){this.renderer.FBOs.pickingBuffer.resize(this.renderer.width,this.renderer.height)}}this.renderer.FBOs.pickingBuffer.bind();this.renderer.renderPicking();var f=new Uint8Array(4);g.readPixels(o,n,1,1,g.RGBA,g.UNSIGNED_BYTE,f);var l=Math.round(vec4.dot([f[0]/255,f[1]/255,f[2]/255,f[3]/255],[1/(255*255*255),1/(255*255),1/255,1])*4228250625);this.renderer.FBOs.pickingBuffer.unbind();if(l!=0){var h=this.atomRef[l];if(h){var j=this.canvas.commandLine?this.canvas.commandLine.environment.console:console;j.log("Clicked on atom: ",h);console.log("Clicked on atom: ",h);if(c&&c.ctrlKey){var p=true;for(var d=0;d<this.atomSelection.length;d++){if(this.atomSelection[d]==h){p=false;break}}if(p){this.atomSelection.push(h)}if(this.atomSelection.length==2){j.log("Distance: ",molmil.calcMMDistance(this.atomSelection[0],this.atomSelection[1],this)," | ",this.atomSelection[0],this.atomSelection[1])}else{if(this.atomSelection.length==3){j.log("Angle: ",molmil.calcMMAngle(this.atomSelection[0],this.atomSelection[1],this.atomSelection[2],this)," | ",this.atomSelection[0],this.atomSelection[1],this.atomSelection[2])}else{if(this.atomSelection.length==4){j.log("Torsion: ",molmil.calcMMTorsion(this.atomSelection[0],this.atomSelection[1],this.atomSelection[2],this.atomSelection[3],this)," | ",this.atomSelection[0],this.atomSelection[1],this.atomSelection[2],this.atomSelection[3])}}}}else{this.atomSelection=[h]}this.onAtomPick(h);this.canvas.renderer.updateSelection()}}else{this.atomSelection=[];this.canvas.renderer.updateSelection()}this.canvas.update=true};molmil.viewer.prototype.loadStructure=function(h,j,n,d){d=d||{};var l=h.substr(-3).toLowerCase()==".gz"&&!d.no_pako_gz;if(l&&!window.hasOwnProperty("pako")){var i=document.getElementsByTagName("head")[0];var g=molmil_dep.dcE("script");g.src=molmil.settings.src+"pako.js";g.soup=this;g.argList=[h,j,n,d];g.onload=function(){molmil_dep.asyncStart(this.soup.loadStructure,this.argList,this.soup,0)};i.appendChild(g);return}var f=new molmil_dep.CallRemote("GET"),c=molmil_dep.getKeyFromObject(d||{},"async",true);f.ASYNC=c;f.target=this;f.gz=l;if(f.gz){f.responseType="arraybuffer"}if(this.onloaderror){f.OnError=this.onloaderror}f.filename=h.substr(h.lastIndexOf("/")+1);if(j==1||(j+"").toLowerCase()=="mmjson"){if(f.ASYNC&&!f.gz){f.responseType="json"}f.parse=function(){if(this.gz){var o=JSON.parse(pako.inflate(new Uint8Array(this.request.response),{to:"string"}))}else{var o=f.request.response}if(typeof o!="object"&&o!=null){o=JSON.parse(this.request.responseText)}return this.target.load_PDBx(o,this.pdbid,this.filename)}}else{if(j==2||(j+"").toLowerCase()=="mmcif"){f.parse=function(){return this.target.load_mmCIF(this.gz?pako.inflate(new Uint8Array(this.request.response),{to:"string"}):this.request.responseText,this.filename)}}else{if(j==3||(j+"").toLowerCase()=="pdbml"){f.parse=function(){return this.target.load_PDBML(this.gz?pako.inflate(new Uint8Array(this.request.response),{to:"string"}):this.request.responseXML,this.filename)}}else{if(j==4||(j+"").toLowerCase()=="pdb"){f.parse=function(){return this.target.load_PDB(this.gz?pako.inflate(new Uint8Array(this.request.response),{to:"string"}):this.request.responseText,this.filename)}}else{if(j==5||(j+"").toLowerCase()=="polygon-xml"){f.parse=function(){return this.target.load_polygonXML(this.gz?pako.inflate(new Uint8Array(this.request.response),{to:"string"}):this.request.responseXML||this.request.responseText,this.filename,d)}}else{if(j==6||(j+"").toLowerCase()=="polygon-json"){f.ASYNC=true;f.responseType="json";f.parse=function(){var o=this.gz?JSON.parse(pako.inflate(new Uint8Array(this.request.response),{to:"string"})):f.request.response;if(typeof o!="object"&&o!=null){o=JSON.parse(this.request.responseText)}return this.target.load_polygonJSON(o,this.filename)}}else{if(j==7||(j+"").toLowerCase()=="gro"){f.parse=function(){return this.target.load_GRO(this.gz?pako.inflate(new Uint8Array(this.request.response),{to:"string"}):this.request.responseText,this.filename)}}else{if(j==8||(j+"").toLowerCase()=="mpbf"){f.ASYNC=true;f.responseType="arraybuffer";f.parse=function(){return this.target.load_MPBF(this.request.response,this.filename)}}else{if((j+"").toLowerCase()=="ccp4"){f.ASYNC=true;f.responseType="arraybuffer";f.parse=function(){return this.target.load_ccp4(this.request.response,this.filename)}}else{if((j+"").toLowerCase()=="mdl"){f.parse=function(){return this.target.load_mdl(this.gz?pako.inflate(new Uint8Array(this.request.response),{to:"string"}):this.request.responseText,this.filename)}}else{if((j+"").toLowerCase()=="mol2"){f.parse=function(){return this.target.load_mol2(this.gz?pako.inflate(new Uint8Array(this.request.response),{to:"string"}):this.request.responseText,this.filename)}}else{if(j.toLowerCase()=="gromacs-trr"){f.ASYNC=true;f.responseType="arraybuffer";f.parse=function(){return this.target.loadGromacsTRR(this.request.response,this.filename)}}else{if(j.toLowerCase()=="gromacs-xtc"){f.ASYNC=true;f.responseType="arraybuffer";f.parse=function(){return this.target.loadGromacsXTC(this.request.response,this.filename)}}else{if(j.toLowerCase()=="psygene-traj"){f.ASYNC=true;f.responseType="arraybuffer";f.parse=function(){var o=this.request.response;this.target.loadMyPrestoTrj(o,molmil_dep.getKeyFromObject(d||{},"fxcell",null));return this.target.structures}}else{console.log("Unknown format: "+j);return}}}}}}}}}}}}}}f.ondone=n;f.OnDone=function(){var o=this.parse();if(!o){return}molmil.safeStartViewer(this.target.canvas);if(n){n(this.target,o)}else{molmil.displayEntry(o,1);molmil.colorEntry(o,1,null,true,this.target)}};f.Send(h)};molmil.toBigEndian32=function(d,j,l,h){var c=new Uint32Array(d,j,l),f,g;for(f=0;f<l;f++){g=c[f];c[f]=(((g&255)<<24)|((g&65280)<<8)|((g>>8)&65280)|((g>>24)&255))}return new h(d,j,l)};molmil.toBigEndian64=function(c,j,l,h){var g=new DataView(c,j,l*8);var d=new Float64Array(l);for(var f=0;f<l;f++){d[f]=g.getFloat64(f*8)}return d};molmil.toBigEndian64_=function(h,g,f,d){var l=new Uint32Array(h,g,f),j,p,o;for(j=0;j<f*2;j+=2){p=l[j];o=l[j+1];l[j+1]=((p&255)<<24)|((p&65280)<<8)|((p>>8)&65280)|((p>>24)&255);l[j]=((o&255)<<24)|((o&65280)<<8)|((o>>8)&65280)|((o>>24)&255)}if(d==Float64Array&&g%8!=0){var c=new DataView(h,g,f);var q=new Float64Array(f);for(j=0;j<f;j++){}}return new d(h,g,f)};molmil.xtc_sizeofint=function(d){var c=1,f=0;while(d>=c&&f<32){f++;c<<=1}return f};molmil.xtc_sizeofints=function(l,n){var h,j,d,g,o=new Uint8Array(32),c,f;d=1;o[0]=1;g=0;for(h=0;h<l;h++){f=0;for(c=0;c<d;c++){f=o[c]*n[h]+f;o[c]=f&255;f>>=8}while(f!=0){o[c++]=f&255;f>>=8}d=c}j=1;d--;while(o[d]>=j){g++;j*=2}return g+d*8};molmil.xtc_decodebits=function(g,f,j){var h,d,c=(1<<j)-1,i=new Uint32Array(g.subarray(1,3));h=g[0];d=0;while(j>=8){i[1]=(i[1]<<8)|f[h++];d|=(i[1]>>i[0])<<(j-8);j-=8}if(j>0){if(i[0]<j){i[0]+=8;i[1]=(i[1]<<8)|f[h++]}i[0]-=j;d|=(i[1]>>i[0])&((1<<j)-1)}d&=c;g[0]=h;g[1]=i[0];g[2]=i[1];return d};molmil.xtc_decodeints=function(d,g,q,l,t,s){var u=new Int32Array(32),n,h,f,c,o;u[1]=u[2]=u[3]=0;f=0;while(l>8){u[f++]=molmil.xtc_decodebits(d,g,8);l-=8}if(l>0){u[f++]=molmil.xtc_decodebits(d,g,l)}for(n=q-1;n>0;n--){o=0;for(h=f-1;h>=0;h--){o=(o<<8)|u[h];c=(o/t[n])|0;u[h]=c;o=o-c*t[n]}s[n]=o}s[0]=u[0]|(u[1]<<8)|(u[2]<<16)|(u[3]<<24)};molmil.viewer.prototype.loadGromacsXTC=function(w){var o=this.structures[0].chains,U=[],T,D=[];for(T=0;T<o.length;T++){U.push([(o[T].atoms[0].AID-1)*3,o[T].atoms.length*3]);o[T].modelsXYZ=[]}this.frameInfo=[];var E=[0,0,0,0,0,0,0,0,0,8,10,12,16,20,25,32,40,50,64,80,101,128,161,203,256,322,406,512,645,812,1024,1290,1625,2048,2580,3250,4096,5060,6501,8192,10321,13003,16384,20642,26007,32768,41285,52015,65536,82570,104031,131072,165140,208063,262144,330280,416127,524287,660561,832255,1048576,1321122,1664510,2097152,2642245,3329021,4194304,5284491,6658042,8388607,10568983,13316085,16777216];var p=9;var S=E.length;var G=0,I,d,z=molmil.toBigEndian32,T,A,R,J,q,u,L,l,Q,B,F,h,s,P,t,H,f,j,x,N,y,n,C,O,M,g,K;var t=new Int32Array(3);while(true){d={};I=molmil.toBigEndian32(w,G,3,Int32Array);G+=12;d.magicnum=I[0];d.natoms=I[1];d.step=I[2];I=z(w,G,10,Float32Array);G+=40;d.time=I[0];d.box=I.subarray(1);if(d.natoms<=9){d.x=z(w,G,d.natoms*3,Float32Array);G+=d.natoms*4}else{t[0]=t[1]=t[2]=0;q=[0,0,0];s=[0,0,0];u=[0,0,0];y=[0,0,0];n=[0,0,0];d.x=new Float32Array(d.natoms*3);g=0;A=molmil.toBigEndian32(w,G,1,Int32Array)[0];G+=4;R=z(w,G,1,Float32Array)[0];G+=4;J=molmil.toBigEndian32(w,G,6,Int32Array);G+=24;q[0]=J[3]-J[0]+1;q[1]=J[4]-J[1]+1;q[2]=J[5]-J[2]+1;if((q[0]|q[1]|q[2])>16777215){u[0]=molmil.xtc_sizeofint(q[0]);u[1]=molmil.xtc_sizeofint(q[1]);u[2]=molmil.xtc_sizeofint(q[2]);L=0}else{L=molmil.xtc_sizeofints(3,q)}l=molmil.toBigEndian32(w,G,1,Int32Array)[0];G+=4;I=l+8;Q=(S<I)?S:I;B=Q-8;I=l-1;I=(p>I)?p:I;F=(E[I]/2)|0;h=(E[l]/2)|0;s[0]=s[1]=s[2]=E[l];P=E[Q];K=molmil.toBigEndian32(w,G,1,Int32Array)[0];G+=4;K=Math.ceil(K/4)*4;j=1/R;x=0;N=0;H=new Uint8Array(w,G);y[0]=y[1]=y[2]=0;while(N<A){if(L==0){y[0]=molmil.xtc_decodebits(t,H,u[0]);y[1]=molmil.xtc_decodebits(t,H,u[1]);y[2]=molmil.xtc_decodebits(t,H,u[2])}else{molmil.xtc_decodeints(t,H,3,L,q,y)}N++;y[0]+=J[0];y[1]+=J[1];y[2]+=J[2];n[0]=y[0];n[1]=y[1];n[2]=y[2];C=molmil.xtc_decodebits(t,H,1);O=0;if(C==1){x=molmil.xtc_decodebits(t,H,5);O=x%3;x-=O;O--}if(x>0){y[0]=y[1]=y[2]=0;for(M=0;M<x;M+=3){molmil.xtc_decodeints(t,H,3,l,s,y);N++;y[0]+=n[0]-h;y[1]+=n[1]-h;y[2]+=n[2]-h;if(M==0){I=y[0];y[0]=n[0];n[0]=I;I=y[1];y[1]=n[1];n[1]=I;I=y[2];y[2]=n[2];n[2]=I;d.x[g++]=n[0]*j;d.x[g++]=n[1]*j;d.x[g++]=n[2]*j}else{n[0]=y[0];n[1]=y[1];n[2]=y[2]}d.x[g++]=y[0]*j;d.x[g++]=y[1]*j;d.x[g++]=y[2]*j}}else{d.x[g++]=y[0]*j;d.x[g++]=y[1]*j;d.x[g++]=y[2]*j}l+=O;if(O<0){h=F;if(l>p){F=(E[l-1]/2)|0}else{F=0}}else{if(O>0){F=h;h=(E[l]/2)|0}}s[0]=s[1]=s[2]=E[l];if(s[0]==0||s[1]==0||s[2]==0){console.error("(xdrfile error) Undefined error.");return}}G+=K}D.push(d.x);for(T=0;T<U.length;T++){o[T].modelsXYZ.push(d.x.subarray(U[T][0],U[T][0]+U[T][1]))}for(T=0;T<d.natoms*3;T++){d.x[T]*=10}this.frameInfo.push([d.step,d.time]);if(G>=w.byteLength){break}}this.structures[0].number_of_frames=this.structures[0].chains.length?this.structures[0].chains[0].modelsXYZ.length:0;return[this.structures.length?this.structures[0]:{}]};molmil.viewer.prototype.loadGromacsTRR=function(n){var h,l=0,j,o,p,d,u,t,g=[],s;var q=this.structures[0].chains,f=[];for(s=0;s<q.length;s++){f.push([(q[s].atoms[0].AID-1)*3,q[s].atoms.length*3]);q[s].modelsXYZ=[]}this.frameInfo=[];while(true){h={};p=molmil.toBigEndian32(n,l,2,Int32Array);l+=8;h.magicnum=p[0];h.i1=p[1];j=molmil.toBigEndian32(n,l,1,Int32Array)[0];l+=4;h.version=molmil.decodeUtf8(new Uint8Array(n,l,j));l+=j;p=molmil.toBigEndian32(n,l,13,Int32Array);l+=13*4;h.ir_size=p[0];h.e_size=p[1];h.box_size=p[2];h.vir_size=p[3];h.pres_size=p[4];h.top_size=p[5];h.sym_size=p[6];h.x_size=p[7];h.v_size=p[8];h.f_size=p[9];h.natoms=p[10];h.step=p[11];h.nre=p[12];d=h.box_size/9;if(d==8){u=molmil.toBigEndian64;t=Float64Array}else{u=molmil.toBigEndian32;t=Float32Array}p=u(n,l,2,t);l+=2*d;h.time=p[0];h.lam=p[1];if(h.box_size){h.box=u(n,l,9,t);l+=h.box_size}if(h.vir_size){h.vir=u(n,l,9,t);l+=h.vir_size}if(h.pres_size){h.pres=u(n,l,9,t);l+=h.pres_size}if(h.x_size){h.x=u(n,l,h.natoms*3,t);for(s=0;s<h.natoms*3;s++){h.x[s]*=10}l+=h.x_size;g.push(h.x);for(s=0;s<f.length;s++){q[s].modelsXYZ.push(h.x.subarray(f[s][0],f[s][0]+f[s][1]))}}if(h.v_size){l+=h.v_size}if(h.f_size){l+=h.f_size}this.frameInfo.push([h.step,h.time]);if(l>=n.byteLength){break}}this.structures[0].number_of_frames=this.structures[0].chains.length?this.structures[0].chains[0].modelsXYZ.length:0;return[this.structures.length?this.structures[0]:{}]};molmil.viewer.prototype.loadMyPrestoTrj=function(E,B){var s=0,x,F,I,K;this.trajectoryMD=[];var h=[];var H=this.structures[0].chains,t=[];for(K=0;K<H.length;K++){t.push([(H[K].atoms[0].AID-1)*3,H[K].atoms.length*3]);H[K].modelsXYZ=[]}while(true){x=[];Array.prototype.push.apply(x,new Int32Array(E,s,2));s+=8;Array.prototype.push.apply(x,new Float32Array(E,s,7));s+=28;Array.prototype.push.apply(x,new Int32Array(E,s,2));s+=8;Array.prototype.push.apply(x,new Float32Array(E,s,1));s+=4;Array.prototype.push.apply(x,new Int32Array(E,s,2));s+=8;this.trajectoryMD.push(x);F=new Float32Array(E,s,x[13]/4);s+=x[13];s+=4;h.push(F);for(K=0;K<t.length;K++){H[K].modelsXYZ.push(F.subarray(t[K][0],t[K][0]+t[K][1]))}if(s>=E.byteLength){break}}this.structures[0].number_of_frames=this.structures[0].chains.length?this.structures[0].chains[0].modelsXYZ.length:0;if(B&&B.length&&(B[0]!=0||B[1]!=0||B[2]!=0)){var d=this.structures[0];var G,K,D,L,y,q,o,n,w,C,A,z,j,J,u,p=Math.round,M,l,g,f;for(G=0;G<h.length;G++){l=h[G];for(K=0;K<d.chains.length;K++){M=d.chains[K].molecules;for(D=0;D<M.length-1;D++){y=M[D].N||M[D].CA;if(!y){continue}w=M[D+1].N||M[D+1].CA;if(!w){continue}g=(w.AID-1)*3;f=(y.AID-1)*3;J=l[g]-l[f];u=p(J/B[0]);l[f]+=u*B[0];g++;f++;J=l[g]-l[f];u=p(J/B[1]);l[f]+=u*B[1];g++;f++;J=l[g]-l[f];u=p(J/B[2]);l[f]+=u*B[2]}for(D=1;D<M.length;D++){y=M[D].N||M[D].CA;if(!y){continue}w=M[D-1].N||M[D-1].CA;if(!w){continue}g=(w.AID-1)*3;f=(y.AID-1)*3;J=l[g]-l[f];u=p(J/B[0]);l[f]+=u*B[0];g++;f++;J=l[g]-l[f];u=p(J/B[1]);l[f]+=u*B[1];g++;f++;J=l[g]-l[f];u=p(J/B[2]);l[f]+=u*B[2];j=M[D].atoms;for(L=0;L<j.length;L++){g=(y.AID-1)*3;f=(j[L].AID-1)*3;J=l[g]-l[f];u=p(J/B[0]);l[f]+=u*B[0];g++;f++;J=l[g]-l[f];u=p(J/B[1]);l[f]+=u*B[1];g++;f++;J=l[g]-l[f];u=p(J/B[2]);l[f]+=u*B[2]}}}}}return[this.structures.length?this.structures[0]:{}]};molmil.viewer.prototype.loadStructureData=function(g,h,d,c,f){var i;if(h==1||(h+"").toLowerCase()=="mmjson"){i=this.load_PDBx(typeof g=="string"?JSON.parse(g):g,d)}else{if(h==2||(h+"").toLowerCase()=="cif"){i=this.load_mmCIF(g,d)}else{if(h==3||(h+"").toLowerCase()=="pdbml"){i=this.load_PDBML(g,d)}else{if(h==4||(h+"").toLowerCase()=="pdb"){i=this.load_PDB(g,d)}else{if(h==5||(h+"").toLowerCase()=="polygon-xml"){i=this.load_polygonXML(g,d,f)}else{if(h==6||(h+"").toLowerCase()=="polygon-json"){i=this.load_polygonJSON(typeof g=="object"?g:JSON.parse(g),d)}else{if(h==7||(h+"").toLowerCase()=="gro"){i=this.load_GRO(g,d)}else{if(h==8||(h+"").toLowerCase()=="mpbf"){i=this.load_MPBF(g,d)}else{if((h+"").toLowerCase()=="mdl"){i=this.load_mdl(g,d)}else{if((h+"").toLowerCase()=="mol2"){i=this.load_mol2(g,d)}else{if((h+"").toLowerCase()=="ccp4"){i=this.load_ccp4(g,d)}else{if((h+"").toLowerCase()=="psygene-traj"){i=this.loadMyPrestoTrj(g,molmil_dep.getKeyFromObject(f||{},"fxcell",null))}else{if((h+"").toLowerCase()=="gromacs-trr"){i=this.loadGromacsTRR(g)}else{if((h+"").toLowerCase()=="gromacs-xtc"){i=this.loadGromacsXTC(g)}}}}}}}}}}}}}}if(!i){return}if(this.canvas){molmil.safeStartViewer(this.canvas)}if(c){c(this,i)}else{molmil.displayEntry(i,1);molmil.colorEntry(i,1,null,true,this)}};molmil.viewer.prototype.buildAminoChain=function(c){var n,l,f,d,g,j,h=c.entry;var i=c.modelsXYZ[0];c.bonds=[];for(n=0;n<c.molecules.length;n++){if(c.molecules[n].CA){g=c.molecules[n].xna?64:16;for(l=n+1;l<c.molecules.length;l++){if(c.molecules[n].xna!=c.molecules[l].xna){continue}if(c.molecules[n].C&&c.molecules[l].N){f=c.molecules[n].C.xyz;d=c.molecules[l].N.xyz;dx=i[f]-i[d];dx*=dx;dy=i[f+1]-i[d+1];dy*=dy;dz=i[f+2]-i[d+2];dz*=dz;r=dx+dy+dz;if(r<=3.24){c.molecules[n].next=c.molecules[l];c.molecules[l].previous=c.molecules[n];c.bonds.push([c.molecules[n].C,c.molecules[l].N,1]);break}else{if(c.molecules[l].C&&c.molecules[n].N){f=c.molecules[l].C.xyz;d=c.molecules[n].N.xyz;dx=i[f]-i[d];dx*=dx;dy=i[f+1]-i[d+1];dy*=dy;dz=i[f+2]-i[d+2];dz*=dz;r=dx+dy+dz;if(r<=3.24){c.molecules[n].next=c.molecules[l];c.molecules[l].previous=c.molecules[n];c.bonds.push([c.molecules[n].C,c.molecules[l].N,1]);break}}}}else{if(c.molecules[l].CA){f=c.molecules[n].CA.xyz;d=c.molecules[l].CA.xyz;dx=i[f]-i[d];dx*=dx;dy=i[f+1]-i[d+1];dy*=dy;dz=i[f+2]-i[d+2];dz*=dz;r=dx+dy+dz;if(r<=g){c.molecules[n].next=c.molecules[l];c.molecules[l].previous=c.molecules[n];break}}}}}}};molmil.viewer.prototype.buildBondList=function(d,p){var t,s,i,h;var x,u,q,c,g,f,l,j,w=molmil.configBox.vdwR;if(p){this.buildAminoChain(d)}var o=d.modelsXYZ[0],n=false;d.bondsOK=true;for(t=0;t<d.molecules.length;t++){molmil.buildBondsList4Molecule(d.bonds,d.molecules[t],o);if(d.molecules[t].CA){if(d.molecules[t].name=="CYS"){i=molmil.getAtomFromMolecule(d.molecules[t],"SG");if(!i){continue}for(s=t+1;s<d.molecules.length;s++){if(d.molecules[t].CA){if(d.molecules[s].name!="CYS"){continue}h=molmil.getAtomFromMolecule(d.molecules[s],"SG");if(!h){continue}l=i.xyz;j=h.xyz;x=o[l]-o[j];x*=x;u=o[l+1]-o[j+1];u*=u;q=o[l+2]-o[j+2];q*=q;c=x+u+q;if(c<=5){d.bonds.push([i,h,1]);break}}}}}else{if(d.molecules[t].ligand){for(s=t+1;s<d.molecules.length;s++){if(!d.molecules[s].ligand){continue}for(g=0;g<d.molecules[t].atoms.length;g++){if(d.molecules[t].atoms[g].element=="H"||d.molecules[t].atoms[g].element=="D"){continue}l=d.molecules[t].atoms[g].xyz;for(f=0;f<d.molecules[s].atoms.length;f++){if(d.molecules[s].atoms[f].element=="H"||d.molecules[s].atoms[f].element=="D"){continue}j=d.molecules[s].atoms[f].xyz;x=o[l]-o[j];x*=x;u=o[l+1]-o[j+1];u*=u;q=o[l+2]-o[j+2];q*=q;c=x+u+q;maxDistance=3.24;if(w[d.molecules[t].atoms[g].element]===undefined||w[d.molecules[t].atoms[g].element]>=1.8){if(w[d.molecules[s].atoms[f].element]===undefined||w[d.molecules[s].atoms[f].element]>=1.8){maxDistance=6}else{maxDistance=4.5}}else{if(w[d.molecules[s].atoms[f].element]===undefined||w[d.molecules[s].atoms[f].element]>=1.8){if(w[d.molecules[t].atoms[g].element]===undefined||w[d.molecules[t].atoms[g].element]>=1.8){maxDistance=6}else{maxDistance=4.5}}}if(c<=maxDistance){d.bonds.push([d.molecules[t].atoms[g],d.molecules[s].atoms[f],1])}}}}}}}};molmil.viewer.prototype.getChain=function(d,h){var f=[];for(var g=0;g<d.chains.length;g++){if(d.chains[g].name==h){f.push(d.chains[g])}}return f};molmil.viewer.prototype.getChainAuth=function(d,h){var f=[];for(var g=0;g<d.chains.length;g++){if(d.chains[g].authName==h){f.push(d.chains[g])}}return f};molmil.viewer.prototype.getMolObject4Chain=function(f,h){if(!f instanceof Array){f=[f]}for(var g=0,d;g<f.length;g++){for(d=0;d<f[g].molecules.length;d++){if(f[g].molecules[d].id==h){return f[g].molecules[d]}}}return null};molmil.viewer.prototype.getMolObject4ChainAlt=function(f,g){if(!f instanceof Array){f=[f]}for(var h=0,d;h<f.length;h++){for(d=0;d<f[h].molecules.length;d++){if(f[h].molecules[d].RSID==g){return f[h].molecules[d]}}}return null};molmil.decodeUtf8=function(j){var d="",g=0,n=0,h=0,f=0,l=new Uint8Array(j);if(l.length>=3&&l[0]===239&&l[1]===187&&l[2]===191){g=3}while(g<l.length){n=l[g];if(n<128){d+=String.fromCharCode(n);g++}else{if(n>191&&n<224){if(g+1>=l.length){throw"UTF-8 Decode failed. Two byte character was truncated."}f=l[g+1];d+=String.fromCharCode(((n&31)<<6)|(f&63));g+=2}else{if(g+2>=l.length){throw"UTF-8 Decode failed. Multi byte character was truncated."}f=l[g+1];c3=l[g+2];d+=String.fromCharCode(((n&15)<<12)|((f&63)<<6)|(c3&63));g+=3}}}return d};molmil.viewer.prototype.load_ccp4=function(H,J,X){if(!X){X={sigma:1}}var ag=new Int32Array(H,0,10);var af=new Float32Array(H,40,6);var ad=new Int32Array(H,64,3);var ab=new Float32Array(H,76,3);var aa=new Int32Array(H,88,1);var Z=new Int32Array(H,92,233);var Y=new Float32Array(H,1024,Z[0]/4);var W=new Float32Array(H,0,256);X.solid=true;var u=ag[0]*ag[1]*ag[2];var K=new Float32Array(H,1024+Z[0],u);if(!X.skipNormalization){var y=1/new Float32Array(H,54*4,1)[0];for(var V=0;V<u;V++){K[V]=(K[V]-ab[2])*y}}var P=[ad[0]-1,ad[1]-1,ad[2]-1];var D=[af[P[0]]/ag[P[0]+7],af[P[1]]/ag[P[1]+7],af[P[2]]/ag[P[2]+7]];var z=[D[0]*ag[P[0]+4],D[1]*ag[P[1]+4],D[2]*ag[P[2]+4]];var t=[ag[P[0]],ag[P[1]],ag[P[2]]];var L=[[z[0],z[1],z[2]],[(t[0]*D[0])+z[0],(t[1]*D[1])+z[1],(t[2]*D[2])+z[2]]];var q=X.sigma*2;var M=function(d,g,f){var c=arguments[P[0]]+ag[0]*(arguments[P[1]]+ag[1]*arguments[P[2]]);return q-K[c]};var B={};var N=[1/D[0],1/D[1],1/D[2]];var n=function(f,i,g){var d=arguments[P[0]]+ag[0]*(arguments[P[1]]+ag[1]*arguments[P[2]]);if(B[d]!==undefined){return B[d]}else{B[d]=[0,0,0];var c,h;c=(arguments[P[0]]-1)+ag[0]*(arguments[P[1]]+ag[1]*arguments[P[2]]);h=(arguments[P[0]]+1)+ag[0]*(arguments[P[1]]+ag[1]*arguments[P[2]]);if(c<0){c=arguments[P[0]]+ag[0]*(arguments[P[1]]+ag[1]*arguments[P[2]]);c=q-K[c];h=q-K[h];B[d][P[0]]=(h-c)*N[P[0]]}else{if(h>t[P[0]]){h=arguments[P[0]]+ag[0]*(arguments[P[1]]+ag[1]*arguments[P[2]]);c=q-K[c];h=q-K[h];B[d][P[0]]=(h-c)*N[P[0]]}else{c=q-K[c];h=q-K[h];B[d][P[0]]=(h-c)*N[P[0]]*0.5}}c=arguments[P[0]]+ag[0]*((arguments[P[1]]-1)+ag[1]*arguments[P[2]]);h=arguments[P[0]]+ag[0]*((arguments[P[1]]+1)+ag[1]*arguments[P[2]]);if(c<0){c=arguments[P[0]]+ag[0]*(arguments[P[1]]+ag[1]*arguments[P[2]]);c=q-K[c];h=q-K[h];B[d][P[1]]=(h-c)*N[P[1]]}else{if(h>t[P[0]]){h=arguments[P[0]]+ag[0]*(arguments[P[1]]+ag[1]*arguments[P[2]]);c=q-K[c];h=q-K[h];B[d][P[1]]=(h-c)*N[P[1]]}else{c=q-K[c];h=q-K[h];B[d][P[1]]=(h-c)*N[P[1]]*0.5}}c=arguments[P[0]]+ag[0]*(arguments[P[1]]+ag[1]*(arguments[P[2]]-1));h=arguments[P[0]]+ag[0]*(arguments[P[1]]+ag[1]*(arguments[P[2]]+1));if(c<0){c=arguments[P[0]]+ag[0]*(arguments[P[1]]+ag[1]*arguments[P[2]]);c=q-K[c];h=q-K[h];B[d][P[2]]=(h-c)*N[P[2]]}else{if(h>t[P[0]]){h=arguments[P[0]]+ag[0]*(arguments[P[1]]+ag[1]*arguments[P[2]]);c=q-K[c];h=q-K[h];B[d][P[2]]=(h-c)*N[P[2]]}else{c=q-K[c];h=q-K[h];B[d][P[2]]=(h-c)*N[P[2]]*0.5}}return B[d]}};var E=molmil.surfaceNets2(t,M,L);var Q=[],p=[],V,U,ag=[0,0,0],af=[0,0,0],ad;for(V=0;V<E.vertices.length;V++){p.push([])}for(V=0;V<E.faces.length;V++){ag[0]=E.vertices[E.faces[V][1]][0]-E.vertices[E.faces[V][0]][0];ag[1]=E.vertices[E.faces[V][1]][1]-E.vertices[E.faces[V][0]][1];ag[2]=E.vertices[E.faces[V][1]][2]-E.vertices[E.faces[V][0]][2];af[0]=E.vertices[E.faces[V][2]][0]-E.vertices[E.faces[V][0]][0];af[1]=E.vertices[E.faces[V][2]][1]-E.vertices[E.faces[V][0]][1];af[2]=E.vertices[E.faces[V][2]][2]-E.vertices[E.faces[V][0]][2];Q.push([ag[1]*af[2]-ag[2]*af[1],ag[2]*af[0]-ag[0]*af[2],ag[0]*af[1]-ag[1]*af[0]]);p[E.faces[V][0]].push(V);p[E.faces[V][1]].push(V);p[E.faces[V][2]].push(V)}var F=[];for(V=0;V<E.vertices.length;V++){ag=[0,0,0];for(U=0;U<p[V].length;U++){ag[0]+=Q[p[V][U]][0];ag[1]+=Q[p[V][U]][1];ag[2]+=Q[p[V][U]][2]}vec3.normalize(ag,ag);F.push(ag)}molmil.taubinSmoothing(F,E.faces,0.33,-0.331,50);for(V=0;V<F.length;V++){vec3.normalize(F[V],F[V])}molmil.taubinSmoothing(E.vertices,E.faces,0.33,-0.331,50);var o=new Float32Array(E.vertices.length*7);var s=new Int32Array(E.faces.length*3);var G=new Uint8Array(o.buffer);var I=[0,0,0,0],T=[0,0,0];var w=[1e+99,-1e+99,1e+99,-1e+99,1e+99,-1e+99];for(var R=0,ae,ac;R<E.vertices.length;R++){ae=R*7;ac=R*28;o[ae+3]=F[R][0];o[ae+4]=F[R][1];o[ae+5]=F[R][2];o[ae]=E.vertices[R][0];o[ae+1]=E.vertices[R][1];o[ae+2]=E.vertices[R][2];I[0]+=E.vertices[R][0];I[1]+=E.vertices[R][1];I[2]+=E.vertices[R][2];I[3]+=1;if(o[ae]<w[0]){w[0]=o[ae]}if(o[ae]>w[1]){w[1]=o[ae]}if(o[ae+1]<w[2]){w[2]=o[ae+1]}if(o[ae+1]>w[3]){w[3]=o[ae+1]}if(o[ae+2]<w[4]){w[4]=o[ae+2]}if(o[ae+2]>w[5]){w[5]=o[ae+2]}G[ac+24]=255;G[ac+25]=255;G[ac+26]=255;G[ac+27]=255}var C=new molmil.polygonObject({filename:J,COR:I});canvas.molmilViewer.structures.push(C);C.options=[];C.meta.geomRanges=w;for(var V=0,x;V<E.faces.length;V++){x=V*3;s[x]=E.faces[V][0];s[x+1]=E.faces[V][1];s[x+2]=E.faces[V][2]}var A=canvas.renderer.gl;var S=A.createBuffer();A.bindBuffer(A.ARRAY_BUFFER,S);A.bufferData(A.ARRAY_BUFFER,o,A.STATIC_DRAW);var O=A.createBuffer();A.bindBuffer(A.ELEMENT_ARRAY_BUFFER,O);A.bufferData(A.ELEMENT_ARRAY_BUFFER,s,A.STATIC_DRAW);var l={};l.settings=X;l.gl=canvas.renderer.gl;l.renderer=canvas.renderer;l.nElements=E.faces.length*3;l.vertexBuffer=S;l.indexBuffer=O;l.angle=canvas.renderer.angle;l.standard_shader=canvas.renderer.shaders.standard_alpha;l.standard_attributes=canvas.renderer.shaders.standard_alpha.attributes;l.wireframe_shader=canvas.renderer.shaders.lines;l.wireframe_attributes=canvas.renderer.shaders.lines.attributes;l.status=true;l.render=function(c,d){if(this.settings.solid){this.standard_render(c,d)}else{this.wireframe_render(c,d)}};l.wireframe_render=function(d,g){if(!this.status){return}var h=mat3.create();this.gl.useProgram(this.wireframe_shader.program);this.gl.uniformMatrix4fv(this.wireframe_shader.uniforms.modelViewMatrix,false,d);this.gl.uniformMatrix4fv(this.wireframe_shader.uniforms.projectionMatrix,false,this.renderer.projectionMatrix);this.gl.uniform3f(this.wireframe_shader.uniforms.COR,g[0],g[1],g[2]);this.gl.uniform1f(this.wireframe_shader.uniforms.focus,this.renderer.fogStart);this.gl.uniform1f(this.wireframe_shader.uniforms.fogSpan,this.renderer.fogStart+(this.renderer.clearCut*2));this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer);this.gl.vertexAttribPointer(this.wireframe_attributes.in_Position,3,this.gl.FLOAT,false,28,0);this.gl.vertexAttribPointer(this.wireframe_attributes.in_Colour,4,this.gl.UNSIGNED_BYTE,true,28,24);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);if(this.angle){var f=0,c;while((c=Math.min(this.nElements-f,3000000))>0){this.gl.drawElements(this.gl.LINES,c,A.UNSIGNED_INT,f*4);f+=c}}else{this.gl.drawElements(this.gl.LINES,this.nElements,A.UNSIGNED_INT,0)}};l.standard_render=function(d,g){if(!this.status){return}var h=mat3.create();mat3.normalFromMat4(h,d);this.gl.useProgram(this.standard_shader.program);this.gl.uniformMatrix4fv(this.standard_shader.uniforms.modelViewMatrix,false,d);this.gl.uniformMatrix3fv(this.standard_shader.uniforms.normalMatrix,false,h);this.gl.uniformMatrix4fv(this.standard_shader.uniforms.projectionMatrix,false,this.renderer.projectionMatrix);this.gl.uniform3f(this.standard_shader.uniforms.COR,g[0],g[1],g[2]);this.gl.uniform1f(this.standard_shader.uniforms.focus,this.renderer.fogStart);this.gl.uniform1f(this.standard_shader.uniforms.fogSpan,this.renderer.fogStart+(this.renderer.clearCut*2));this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer);this.gl.vertexAttribPointer(this.standard_attributes.in_Position,3,this.gl.FLOAT,false,28,0);this.gl.vertexAttribPointer(this.standard_attributes.in_Normal,3,this.gl.FLOAT,false,28,12);this.gl.vertexAttribPointer(this.standard_attributes.in_Colour,4,this.gl.UNSIGNED_BYTE,true,28,24);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);if(this.angle){var f=0,c;while((c=Math.min(this.nElements-f,3000000))>0){this.gl.drawElements(this.gl.TRIANGLES,c,A.UNSIGNED_INT,f*4);f+=c}}else{this.gl.drawElements(this.gl.TRIANGLES,this.nElements,A.UNSIGNED_INT,0)}};l.renderPicking=function(){};canvas.renderer.programs.push(l);canvas.molmilViewer.calculateCOG();this.renderer.camera.z=this.calcZ();canvas.renderer.initBuffers();canvas.update=true;molmil.safeStartViewer(canvas)};molmil.viewer.prototype.load_MPBF=function(n,c){var l=0;while(l<n.byteLength){var t=[0,0,0,0];var x=new Int32Array(n,l,4);l+=16;var d=molmil.decodeUtf8(new Uint8Array(n,l,x[3]));l+=x[3]+(x[3]%4!=0?4-x[3]%4:0);var g=l;var u=new Float32Array(n,l,7*x[1]);l+=7*x[1]*4;var y=new Int32Array(n,l,x[2]*3);l+=x[2]*3*4;var j=[1e+99,-1e+99,1e+99,-1e+99,1e+99,-1e+99];for(var p=0;p<u.length;p+=7){t[0]+=u[p];t[1]+=u[p+1];t[2]+=u[p+2];t[3]++;if(u[p]<j[0]){j[0]=u[p]}if(u[p]>j[1]){j[1]=u[p]}if(u[p+1]<j[2]){j[2]=u[p+1]}if(u[p+1]>j[3]){j[3]=u[p+1]}if(u[p+2]<j[4]){j[4]=u[p+2]}if(u[p+2]>j[5]){j[5]=u[p+2]}}var h=new molmil.polygonObject({filename:c,COR:t});this.structures.push(h);h.options=[];h.meta.geomRanges=j;var w=this.renderer;var s=w.gl;var q=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,q);s.bufferData(s.ARRAY_BUFFER,u,s.STATIC_DRAW);var f=s.createBuffer();s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,f);s.bufferData(s.ELEMENT_ARRAY_BUFFER,y,s.STATIC_DRAW);var o={};o.gl=w.gl;o.renderer=w;o.nElements=x[2]*3;o.vertexBuffer=q;o.indexBuffer=f;o.angle=w.angle;o.shader=w.shaders.standard_alpha;o.attributes=w.shaders.standard_alpha.attributes;o.status=true;o.render=function(i,z){if(!this.status){return}var A=mat3.create();mat3.normalFromMat4(A,i);this.gl.useProgram(this.shader.program);this.gl.uniformMatrix4fv(this.shader.uniforms.modelViewMatrix,false,i);this.gl.uniformMatrix3fv(this.shader.uniforms.normalMatrix,false,A);this.gl.uniformMatrix4fv(this.shader.uniforms.projectionMatrix,false,this.renderer.projectionMatrix);this.gl.uniform3f(this.shader.uniforms.COR,z[0],z[1],z[2]);this.gl.uniform1f(this.shader.uniforms.focus,this.renderer.fogStart);this.gl.uniform1f(this.shader.uniforms.fogSpan,this.renderer.fogStart+(this.renderer.clearCut*2));this.render_internal()};o.render_internal=function(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer);this.gl.vertexAttribPointer(this.attributes.in_Position,3,this.gl.FLOAT,false,28,0);this.gl.vertexAttribPointer(this.attributes.in_Normal,3,this.gl.FLOAT,false,28,12);this.gl.vertexAttribPointer(this.attributes.in_Colour,4,this.gl.UNSIGNED_BYTE,true,28,24);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);if(this.angle){var z=0,i;while(true){i=Math.min(this.nElements-z,3000000);if(i<1){break}this.gl.drawElements(this.gl.TRIANGLES,i,s.UNSIGNED_INT,z*4);z+=i}}else{this.gl.drawElements(this.gl.TRIANGLES,this.nElements,s.UNSIGNED_INT,0)}};o.renderPicking=function(){};w.programs.push(o);h.options.push([d,o]);if(molmil.configBox.skipClearGeometryBuffer){h.data=h.data||{};h.data.vertexBuffer=u;h.data.indexBuffer=y;h.data.vertexSize=7;h.data.vertices_offset=g}}this.renderer.initBD=true;this.calculateCOG();if(!this.skipCOGupdate){this.renderer.camera.z=this.calcZ()}if(molmil.geometry.onGenerate){molmil_dep.asyncStart(molmil.geometry.onGenerate[0],molmil.geometry.onGenerate[1],molmil.geometry.onGenerate[2],0)}return h};molmil.viewer.prototype.load_mol2=function(D,w){D=D.split("\n");var A,E="",s=false,c=[],h=false,t=[],B=false,u={},C;for(A=0;A<D.length;A++){if(D[A].substr(0,9).toUpperCase()=="@<TRIPOS>"){s=false;h=false;B=false}if(s){c.push(D[A])}if(h){t.push(D[A])}if(B){C=D[A].trim().split(/[ ,]+/);u[parseInt(C[0])]=C[1]}if(D[A].substr(0,17).toUpperCase()=="@<TRIPOS>MOLECULE"){E=D[A+1].trim()}else{if(D[A].substr(0,13).toUpperCase()=="@<TRIPOS>ATOM"){s=true}else{if(D[A].substr(0,13).toUpperCase()=="@<TRIPOS>BOND"){h=true}else{if(D[A].substr(0,21).toUpperCase()=="@<TRIPOS>SUBSTRUCTURE"){B=true}}}}}var q,p,l,d,g,n,f,j,o;this.structures.push(struc=new molmil.entryObject({id:w}));struc.chains.push(j=new molmil.chainObject("",struc));j.CID=this.CID++;for(A=0;A<c.length;A++){C=c[A].trim().split(/[ ,]+/);d=C[1];q=parseFloat(C[2]);p=parseFloat(C[3]);l=parseFloat(C[4]);g=C.length>5?C[5]:"";n=C.length>5?C[6]:"";if(n!=f){j.molecules.push(o=new molmil.molObject(molmil_dep.getKeyFromObject(u,n,n),n,j));o.MID=this.MID++;f=n}Xpos=j.modelsXYZ[0].length;j.modelsXYZ[0].push(q,p,l);o.atoms.push(atom=new molmil.atomObject(Xpos,d,g.split(".")[0],o,j));j.atoms.push(atom);atom.status=true;atom.AID=this.AID++;this.atomRef[atom.AID]=atom}this.calculateCOG();for(A=0;A<t.length;A++){C=t[A].trim().split(/[ ,]+/);if(C[0]==""){continue}a1=parseInt(C[1])-1;a2=parseInt(C[2])-1;if(C[3]=="ar"){C[3]=2}bt=parseInt(C[3]);j.bonds.push([j.atoms[a1],j.atoms[a2],bt])}j.bondsOK=true;this.chains.push(j);molmil.resetColors(null,this);this.renderer.camera.z=this.calcZ();return struc};molmil.viewer.prototype.load_mdl=function(B,s){B=B.split("\n");var D=B[0].trim()||s;var f=B[3].trim().split(/\s/);var q=parseInt(f[0]),p=parseInt(f[1]),t,c,g,n,o,l,j,h,d,C,A,w;this.structures.push(c=new molmil.entryObject({id:s}));c.chains.push(g=new molmil.chainObject("",c));g.CID=this.CID++;g.molecules.push(n=new molmil.molObject(D,1,g));n.MID=this.MID++;var u={};for(t=4;t<q+4;t++){o=parseFloat(B[t].substring(0,11).trim());l=parseFloat(B[t].substring(11,21).trim());j=parseFloat(B[t].substring(21,31).trim());d=B[t].substring(31,35).trim();if(u[d]===undefined){u[d]=1}else{u[d]++}h=g.modelsXYZ[0].length;g.modelsXYZ[0].push(o,l,j);n.atoms.push(atom=new molmil.atomObject(h,d+u[d],d,n,g));g.atoms.push(atom);atom.status=true;atom.AID=this.AID++;this.atomRef[atom.AID]=atom}this.calculateCOG();for(t=q+4;t<q+4+p;t++){f=B[t].trim().split(/[ ,]+/);C=parseInt(f[0])-1;A=parseInt(f[1])-1;w=parseInt(f[2]);g.bonds.push([n.atoms[C],n.atoms[A],w])}g.bondsOK=true;this.chains.push(g);molmil.resetColors(null,this);this.renderer.camera.z=this.calcZ();return c};molmil.viewer.prototype.load_GRO=function(U,K){U=U.trim().split("\n");var w=null;var n=null;var D=null;var G=null;var j,L;var q,S,g,T,E,C,B,s,l,M,O,I,p,o,J,R;var F=[];var N=[];var f=[];var d=null,A,H;this.structures.push(d=new molmil.entryObject({id:K}));q="";d.chains.push(w=new molmil.chainObject(q,d));w.CID=this.CID++;n=q;G=null;for(L=2;L<U.length-1;L++){S=U[L].substring(0,5).trim();g=U[L].substring(11,15).trim();T=U[L].substring(5,11).trim();E=parseFloat(U[L].substring(20,28).trim())*10;C=parseFloat(U[L].substring(28,36).trim())*10;B=parseFloat(U[L].substring(36,44).trim())*10;if(S!=G){w.molecules.push(D=new molmil.molObject(T,S,w));D.MID=this.MID++;G=S}for(s=0;s<g.length;s++){if(!molmil_dep.isNumber(g[s])){break}}if(g.length>1&&!molmil_dep.isNumber(g[1])&&g[1]==g[1].toLowerCase()){l=g.substring(s,s+2)}else{l=g.substring(s,s+1)}A=w.modelsXYZ[0].length;w.modelsXYZ[0].push(E,C,B);D.atoms.push(j=new molmil.atomObject(A,g,l,D,w));if(!molmil.AATypes.hasOwnProperty(D.name.substr(0,3))){if(D.name=="HOH"||D.name=="DOD"||D.name=="WAT"||D.name=="SOL"){D.water=true;D.ligand=false;j.status=false}else{if(j.atomName=="P"){D.N=j;D.xna=true;D.ligand=false;if(!D.CA){w.isHet=false;D.CA=j}}else{if(j.atomName=="C1'"){w.isHet=false;D.CA=j;D.xna=true;D.ligand=false}else{if(j.atomName=="O3'"){D.C=j;D.xna=true;D.ligand=false}}}}}else{if(j.atomName=="N"){D.N=j;D.ligand=false}else{if(j.atomName=="CA"){D.CA=j;D.ligand=false}else{if(j.atomName=="C"){w.isHet=false;D.C=j;D.ligand=false}else{if(j.atomName=="O"){D.O=j;D.ligand=false}}}}}if(j.element=="H"||j.element=="D"){j.status=false}w.atoms.push(j);j.AID=this.AID++;this.atomRef[j.AID]=j}this.calculateCOG();for(R=0;R<d.chains.length;R++){this.buildAminoChain(d.chains[R])}var Q=[],t,u,h;for(R=0;R<d.chains.length;R++){w=d.chains[R];t=w,u=w.molecules.length;for(h=0;h<u;h++){w.molecules[h].chain_alt=w.molecules[h].chain;w.molecules[h].chain=t;if(((!w.molecules[h].next&&h<u-1)||(!w.molecules[h].previous&&h!=0))&&(!(w.molecules[h].water||w.molecules[h].ligand)||(h&&w.molecules[h-1].name!=w.molecules[h].name))){t=new molmil.chainObject(molmil_dep.Strip(t.name),t.entry);t.isHet=false;Q.push(t);if(!w.molecules[h].previous){w.molecules[h].chain=t}}}}if(Q.length){Array.prototype.push.apply(d.chains,Q);var P=[];for(R=0;R<d.chains.length;R++){d.chains[R].name=(R+1)+"";Array.prototype.push.apply(P,d.chains[R].molecules);d.chains[R].molecules=[];d.chains[R].modelsXYZ_old=d.chains[R].modelsXYZ;d.chains[R].modelsXYZ=[];for(h=0;h<d.chains[R].modelsXYZ_old.length;h++){d.chains[R].modelsXYZ.push([])}d.chains[R].atoms=[]}for(h=0;h<P.length;h++){P[h].chain.molecules.push(P[h]);for(L=0;L<P[h].atoms.length;L++){j=P[h].atoms[L].xyz;for(R=0;R<P[h].chain_alt.modelsXYZ_old.length;R++){P[h].chain.modelsXYZ[R].push(P[h].chain_alt.modelsXYZ_old[R][j],P[h].chain_alt.modelsXYZ_old[R][j+1],P[h].chain_alt.modelsXYZ_old[R][j+2])}P[h].atoms[L].xyz=P[h].chain.modelsXYZ[0].length-3;P[h].atoms[L].chain=P[h].chain}Array.prototype.push.apply(P[h].chain.atoms,P[h].atoms);delete P[h].chain_alt}for(R=0;R<d.chains.length;R++){delete d.chains[R].modelsXYZ_old}for(R=0;R<d.chains.length;R++){if(d.chains[R].molecules.length==0){d.chains.splice(R,1);R--;continue}if(d.chains[R].molecules[0].water||d.chains[R].molecules[0].ligand){d.chains[R].name=(d.chains[R].name?d.chains[R].name+" - ":"")+d.chains[R].molecules[0].name}}}for(R=0;R<d.chains.length;R++){this.chains.push(d.chains[R])}for(R=0;R<d.chains.length;R++){this.ssAssign(d.chains[R])}molmil.resetColors(null,this);this.renderer.camera.z=this.calcZ();return d};molmil.viewer.prototype.load_PDB=function(T,B){var s=null;var P=null;var W=null;var E=null;var d,R;var T=T.split("\n");var N,D,u,h,L,H,F,M,p,t,j,l,f,Q,G,U;var C=[];var w=[];var q=[];var J=null,I,A;for(R=0;R<T.length;R++){if((T[R].substring(0,5)=="MODEL"&&s)||!J){if(J){break}this.structures.push(J=new molmil.entryObject({id:B}));A=T[R].substr(5).trim();P=E=null}if(T[R].substring(0,4)=="ATOM"||T[R].substring(0,6)=="HETATM"){N=T[R].substring(21,22).trim();D=T[R].substring(22,28).trim();u=T[R].substring(11,16).trim();h=T[R].substring(17,21).trim();L=parseFloat(T[R].substring(30,38).trim());H=parseFloat(T[R].substring(38,46).trim());F=parseFloat(T[R].substring(46,54).trim());for(M=0;M<u.length;M++){if(!molmil_dep.isNumber(u[M])){break}}if(u.length>1&&!molmil_dep.isNumber(u[1])&&u[1]==u[1].toLowerCase()){p=u.substring(M,M+2)}else{p=u.substring(M,M+1)}if(N!=P){this.chains.push(s=new molmil.chainObject(N,J));J.chains.push(s);s.CID=this.CID++;P=N;E=null}if(D!=E){s.molecules.push(W=new molmil.molObject(h,D,s));W.MID=this.MID++;E=D}I=s.modelsXYZ[0].length;s.modelsXYZ[0].push(L,H,F);W.atoms.push(d=new molmil.atomObject(I,u,p,W,s));if(T[R].substr(0,4)!="ATOM"||!molmil.AATypes.hasOwnProperty(W.name.substr(0,3))){if(W.name=="HOH"||W.name=="DOD"||W.name=="WAT"||W.name=="SOL"){W.water=true;W.ligand=false;d.status=false}else{if(d.atomName=="P"){W.N=d;W.xna=true;W.ligand=false;if(!W.CA){s.isHet=false;W.CA=d}}else{if(d.atomName=="C1'"){s.isHet=false;W.CA=d;W.xna=true;W.ligand=false}else{if(d.atomName=="O3'"){W.C=d;W.xna=true;W.ligand=false}}}}}else{if(d.atomName=="N"){W.N=d;W.ligand=false}else{if(d.atomName=="CA"){W.CA=d;W.ligand=false}else{if(d.atomName=="C"){s.isHet=false;W.C=d;W.ligand=false}else{if(d.atomName=="O"){W.O=d;W.ligand=false}}}}}if(d.element=="H"||d.element=="D"){d.status=false}s.atoms.push(d);d.AID=this.AID++;this.atomRef[d.AID]=d}}var n=0,o;for(;R<T.length;R++){if(T[R].substring(0,5)=="MODEL"){P=n=-1}if(T[R].substring(0,4)=="ATOM"||T[R].substring(0,6)=="HETATM"){N=T[R].substring(21,22).trim();L=parseFloat(T[R].substring(30,38).trim());H=parseFloat(T[R].substring(38,46).trim());F=parseFloat(T[R].substring(46,54).trim());if(N!=P){P=N;n+=1;J.chains[n].modelsXYZ.push(o=[])}o.push(L,H,F)}}J.number_of_frames=J.chains.length?J.chains[0].modelsXYZ.length:0;this.calculateCOG();for(U=0;U<J.chains.length;U++){this.buildAminoChain(J.chains[U])}var K=[],V,g,S;for(U=0;U<J.chains.length;U++){s=J.chains[U];V=s,g=s.molecules.length;for(S=0;S<g;S++){s.molecules[S].chain_alt=s.molecules[S].chain;s.molecules[S].chain=V;if(((!s.molecules[S].next&&S<g-1)||(!s.molecules[S].previous&&S!=0))&&(!(s.molecules[S].water||s.molecules[S].ligand)||(S&&s.molecules[S-1].name!=s.molecules[S].name))){V=new molmil.chainObject(molmil_dep.Strip(V.name),V.entry);V.isHet=false;K.push(V);if(!s.molecules[S].previous){s.molecules[S].chain=V}}}}if(K.length){Array.prototype.push.apply(this.chains,K);Array.prototype.push.apply(J.chains,K);var O=[];for(U=0;U<J.chains.length;U++){Array.prototype.push.apply(O,J.chains[U].molecules);J.chains[U].molecules=[];J.chains[U].modelsXYZ_old=J.chains[U].modelsXYZ;J.chains[U].modelsXYZ=[];for(S=0;S<J.chains[U].modelsXYZ_old.length;S++){J.chains[U].modelsXYZ.push([])}J.chains[U].atoms=[]}for(S=0;S<O.length;S++){O[S].chain.molecules.push(O[S]);for(R=0;R<O[S].atoms.length;R++){d=O[S].atoms[R].xyz;for(U=0;U<O[S].chain_alt.modelsXYZ_old.length;U++){O[S].chain.modelsXYZ[U].push(O[S].chain_alt.modelsXYZ_old[U][d],O[S].chain_alt.modelsXYZ_old[U][d+1],O[S].chain_alt.modelsXYZ_old[U][d+2])}O[S].atoms[R].xyz=O[S].chain.modelsXYZ[0].length-3;O[S].atoms[R].chain=O[S].chain}Array.prototype.push.apply(O[S].chain.atoms,O[S].atoms);delete O[S].chain_alt}for(U=0;U<J.chains.length;U++){delete J.chains[U].modelsXYZ_old}for(U=0;U<J.chains.length;U++){if(J.chains[U].molecules.length==0){J.chains.splice(U,1);U--;continue}if(J.chains[U].molecules[0].water||J.chains[U].molecules[0].ligand){J.chains[U].name=(J.chains[U].name?J.chains[U].name+" - ":"")+J.chains[U].molecules[0].name}}}for(U=0;U<J.chains.length;U++){this.ssAssign(J.chains[U])}molmil.resetColors(null,this);this.renderer.camera.z=this.calcZ();return J};molmil.viewer.prototype.calcZ=function(){var c=Math.max(Math.abs(this.geomRanges[0]),Math.abs(this.geomRanges[1]),Math.abs(this.geomRanges[2]),Math.abs(this.geomRanges[3]),Math.abs(this.geomRanges[4]),Math.abs(this.geomRanges[5]));this.renderer.maxRange=(Math.max(Math.abs(this.geomRanges[1]-this.geomRanges[0]),Math.abs(this.geomRanges[3]-this.geomRanges[2]),Math.abs(this.geomRanges[5]-this.geomRanges[4]))*0.5)-molmil.configBox.zNear-5;if(molmil.configBox.projectionMode==1){return -(c*molmil.configBox.zFar/3000)-molmil.configBox.zNear-1}else{return -((c/Math.min(this.renderer.width,this.renderer.height))*molmil.configBox.zFar*(0.625))-molmil.configBox.zNear-1}};molmil.viewer.prototype.load_polygonJSON=function(l,d,n){n=n||{};var y=l.vertices||[],u=l.triangles_lists||[],z=l.lines_lists||[],h=[],f=[],t;var w=[0,0,0,0];if(l.hasOwnProperty("vertices2")){for(var s=0;s<l.vertices2.length;s++){l.vertices2[s].splice(3,0,0,0,0)}Array.prototype.push.apply(y,l.vertices2)}for(var s=0,q;s<u.length;s++){t=[];for(q=0;q<u[s].length;q++){t.push(u[s][q][0],u[s][q][1],u[s][q][2])}if(t.length){f.push(t.unique())}}for(var s=0;s<z.length;s++){t=[];for(q=0;q<z[s].length;q++){t.push(z[s][q][0],z[s][q][1])}if(t.length){t.unique();h.push(t)}}for(var s=0;s<y.length;s++){w[0]+=y[s][0];w[1]+=y[s][1];w[2]+=y[s][2];w[3]+=1;y[s][6]*=255;y[s][7]*=255;y[s][8]*=255}var p=0,x=0,s,q,c=0,g=0;for(s=0;s<f.length;s++){c+=f[s].length;g+=u[s].length}for(s=0;s<h.length;s++){p+=h[s].length;x+=z[s].length}if(!p&&!c){return null}var o=new molmil.polygonObject({filename:d,COR:w});this.structures.push(o);this.processPolygon3D(o,y,p,x,h,z,c,g,f,u,n);this.renderer.initBD=true;return o};molmil.viewer.prototype.processPolygon3D=function(A,g,D,w,B,d,y,p,J,x,I){var q,z,u,F=this.renderer.gl;var G,E,t,h,H,c,L={};var f=I.alpha||255;if(D){var s=new Float32Array(D*4),o=new Uint8Array(s.buffer);var n=new Uint32Array(w*2);for(G=0,t=0,c=0,h=0;G<B.length;G++){for(E=0;E<B[G].length;E++,h+=16){L[B[G][E]]=t/4;H=g[B[G][E]];s[t++]=H[0];s[t++]=H[1];s[t++]=H[2];o[h+12]=H[6];o[h+13]=H[7];o[h+14]=H[8];o[h+15]=255;t++}for(E=0;E<d[G].length;E++){n[c++]=L[d[G][E][0]];n[c++]=L[d[G][E][1]]}}q={};A.programs.push(q);q.gl=F;q.renderer=this.renderer;q.angle=this.renderer.angle;q.shader=this.renderer.shaders.lines;q.attributes=q.shader.attributes;q.render=function(j,N){var O=mat3.create();mat3.normalFromMat4(O,j);this.gl.useProgram(this.shader.program);this.gl.uniformMatrix4fv(this.shader.uniforms.modelViewMatrix,false,j);this.gl.uniformMatrix4fv(this.shader.uniforms.projectionMatrix,false,this.renderer.projectionMatrix);this.gl.uniform3f(this.shader.uniforms.COR,N[0],N[1],N[2]);this.gl.uniform1f(this.shader.uniforms.focus,this.renderer.fogStart);this.gl.uniform1f(this.shader.uniforms.fogSpan,this.renderer.fogStart+(this.renderer.clearCut*2));this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer);this.gl.vertexAttribPointer(this.attributes.in_Position,3,this.gl.FLOAT,false,16,0);this.gl.vertexAttribPointer(this.attributes.in_Colour,4,this.gl.UNSIGNED_BYTE,true,16,12);this.gl.vertexAttribPointer(2,4,this.gl.UNSIGNED_BYTE,true,16,12);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);if(this.angle){var M=0,i;while((i=Math.min(this.nElements-M,3000000))>0){this.gl.drawElements(this.gl.LINES,i,F.UNSIGNED_INT,M*4);M+=i}}else{this.gl.drawElements(this.gl.LINES,this.nElements,F.UNSIGNED_INT,0)}};q.renderPicking=function(i,j){};this.renderer.programs.push(q);q.vertexBuffer=z=F.createBuffer();F.bindBuffer(F.ARRAY_BUFFER,z);F.bufferData(F.ARRAY_BUFFER,s,F.STATIC_DRAW);q.indexBuffer=u=F.createBuffer();F.bindBuffer(F.ELEMENT_ARRAY_BUFFER,u);F.bufferData(F.ELEMENT_ARRAY_BUFFER,n,F.STATIC_DRAW);q.nElements=n.length}if(y){var C=new Float32Array(y*7),K=new Uint8Array(C.buffer);var l=new Uint32Array(p*3);L={};if(molmil.configBox.skipClearGeometryBuffer){A.data=A.data||{};A.data.vertexBuffer=C;A.data.indexBuffer=l;A.data.vertexSize=7}for(G=0,t=0,c=0,h=0;G<J.length;G++){for(E=0;E<J[G].length;E++,h+=28){L[J[G][E]]=t/7;H=g[J[G][E]];C[t++]=H[0];C[t++]=H[1];C[t++]=H[2];C[t++]=H[3];C[t++]=H[4];C[t++]=H[5];K[h+24]=H[6];K[h+25]=H[7];K[h+26]=H[8];K[h+27]=f;t++}for(E=0;E<x[G].length;E++){l[c++]=L[x[G][E][0]];l[c++]=L[x[G][E][1]];l[c++]=L[x[G][E][2]]}}q={};A.programs.push(q);q.gl=F;q.renderer=this.renderer;q.angle=this.renderer.angle;q.shader=this.renderer.shaders.standard_alpha;q.attributes=q.shader.attributes;q.alpha=f;q.render=function(j,N){var O=mat3.create();mat3.normalFromMat4(O,j);this.gl.useProgram(this.shader.program);this.gl.uniformMatrix4fv(this.shader.uniforms.modelViewMatrix,false,j);this.gl.uniformMatrix3fv(this.shader.uniforms.normalMatrix,false,O);this.gl.uniformMatrix4fv(this.shader.uniforms.projectionMatrix,false,this.renderer.projectionMatrix);this.gl.uniform3f(this.shader.uniforms.COR,N[0],N[1],N[2]);this.gl.uniform1f(this.shader.uniforms.focus,this.renderer.fogStart);this.gl.uniform1f(this.shader.uniforms.fogSpan,this.renderer.fogStart+(this.renderer.clearCut*2));this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer);this.gl.vertexAttribPointer(this.attributes.in_Position,3,this.gl.FLOAT,false,28,0);this.gl.vertexAttribPointer(this.attributes.in_Normal,3,this.gl.FLOAT,false,28,12);this.gl.vertexAttribPointer(this.attributes.in_Colour,4,this.gl.UNSIGNED_BYTE,true,28,24);if(this.alpha<255){this.gl.enable(this.gl.BLEND);this.gl.blendEquation(this.gl.FUNC_ADD);this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA)}this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);if(this.angle){var M=0,i;while((i=Math.min(this.nElements-M,3000000))>0){this.gl.drawElements(this.gl.TRIANGLES,i,F.UNSIGNED_INT,M*4);M+=i}}else{this.gl.drawElements(this.gl.TRIANGLES,this.nElements,F.UNSIGNED_INT,0)}if(this.alpha>254){this.gl.disable(this.gl.BLEND)}};q.renderPicking=function(i,j){};this.renderer.programs.push(q);q.vertexBuffer=z=F.createBuffer();F.bindBuffer(F.ARRAY_BUFFER,z);F.bufferData(F.ARRAY_BUFFER,C,F.STATIC_DRAW);q.indexBuffer=u=F.createBuffer();F.bindBuffer(F.ELEMENT_ARRAY_BUFFER,u);F.bufferData(F.ELEMENT_ARRAY_BUFFER,l,F.STATIC_DRAW);q.nElements=l.length}this.renderer.initBD=true;this.calculateCOG();if(!this.skipCOGupdate){this.renderer.camera.z=this.calcZ()}if(molmil.geometry.onGenerate){molmil_dep.asyncStart(molmil.geometry.onGenerate[0],molmil.geometry.onGenerate[1],molmil.geometry.onGenerate[2],0)}};molmil.viewer.prototype.load_polygonXML=function(f,A,D){if(typeof f=="string"){var d=new DOMParser();f=d.parseFromString(f,"text/xml")}D=D||{};var s=[],n={},c=[],l=[];var w=[],F=[],G,E;var g=[0,0,0,0],h=[1e+99,-1e+99,1e+99,-1e+99,1e+99,-1e+99];var t=f.documentElement.childNodes,z,B,H,y;for(var C=0;C<t.length;C++){if(t[C].tagName=="vertices"){z=t[C].childNodes;for(B=0;B<z.length;B++){if(z[B].tagName!="vertex"){continue}H=z[B].getAttribute("image").trim().split(/\s+/);for(y=0;y<9;y++){H[y]=parseFloat(H[y])}H[6]=H[6];H[7]=H[7];H[8]=H[8];n[z[B].getAttribute("id")]=l.length;g[0]+=H[0];g[1]+=H[1];g[2]+=H[2];g[3]++;if(H[0]<h[0]){h[0]=H[0]}if(H[0]>h[1]){h[1]=H[0]}if(H[1]<h[2]){h[2]=H[1]}if(H[1]>h[3]){h[3]=H[1]}if(H[2]<h[4]){h[4]=H[2]}if(H[2]>h[5]){h[5]=H[2]}l.push(H)}}else{if(t[C].tagName=="triangle_array"){z=t[C].childNodes;G=[];E=[];for(B=0;B<z.length;B++){if(z[B].tagName!="triangle"){continue}H=z[B].getAttribute("vertex").trim().split(/\s+/);for(y=0;y<3;y++){H[y]=n[H[y]]}E.push(H);G.push(H[0],H[1],H[2])}if(G.length){F.push(G.unique());s.push(E)}}else{if(t[C].tagName=="quad_array"){z=t[C].childNodes;G=[];E=[];for(B=0;B<z.length;B++){if(z[B].tagName!="quad"){continue}H=z[B].getAttribute("vertex").trim().split(/\s+/);for(y=0;y<4;y++){H[y]=n[H[y]]}E.push([H[0],H[1],H[2]]);G.push(H[0],H[1],H[2]);E.push([H[0],H[2],H[3]]);G.push(H[0],H[2],H[3])}if(G.length){F.push(G.unique());s.push(E)}}else{if(t[C].tagName=="line_array"){z=t[C].childNodes;G=[];E=[];for(B=0;B<z.length;B++){if(z[B].tagName!="line"){continue}H=z[B].getAttribute("vertex").trim().split(/\s+/);for(y=0;y<2;y++){H[y]=n[H[y]]}E.push(H);G.push(H[0],H[1])}if(G.length){w.push(G.unique());c.push(E)}}else{if(t[C].tagName=="polyline_array"){z=t[C].childNodes;G=[];E=[];for(B=0;B<z.length;B++){if(z[B].tagName!="polyline"){continue}H=z[B].getAttribute("vertex").trim().split(/\s+/);for(y=0;y<H.length;y++){H[y]=n[H[y]]}for(y=0;y<H.length-1;y++){E.push([H[y],H[y+1]]);G.push(H[y],H[y+1])}}if(G.length){w.push(G.unique());c.push(E)}}}}}}}var x=0,p=0,C,q=0,o=0;for(C=0;C<F.length;C++){q+=F[C].length;o+=s[C].length}for(C=0;C<w.length;C++){x+=w[C].length;p+=c[C].length}if(!x&&!q){return null}var u=new molmil.polygonObject({filename:A,COR:g,geomRanges:h});this.structures.push(u);this.processPolygon3D(u,l,x,p,w,c,q,o,F,s,D);this.renderer.initBD=true;return u};molmil.viewer.prototype.load_mmCIF=function(d){var c=loadCIF(d);return this.load_PDBx(c)};molmil.viewer.prototype.load_PDBML=function(d){if(typeof d=="string"){var f=new DOMParser();d=f.parseFromString(d,"text/xml")}var c=loadPDBML(d);return this.load_PDBx(c)};molmil.viewer.prototype.load_PDBx=function(u){var ac=Object.keys(u),K=[];for(var at=0;at<ac.length;at++){var o=ac[at].substr(5).split("-")[0];var C=u["data_"+o];var g=C.atom_site||C.chem_comp_atom||C.pdbx_chem_comp_model_atom||null;if(!g){continue}var q=C.hasOwnProperty("chem_comp_atom");var V=g.group_PDB||g.atom_id;var U=g.Cartn_x||(g.pdbx_model_Cartn_x_ideal&&g.pdbx_model_Cartn_x_ideal[0]!=null?g.pdbx_model_Cartn_x_ideal:g.model_Cartn_x)||g.model_Cartn_x;var S=g.Cartn_y||(g.pdbx_model_Cartn_y_ideal&&g.pdbx_model_Cartn_x_ideal[0]!=null?g.pdbx_model_Cartn_y_ideal:g.model_Cartn_y)||g.model_Cartn_y;var R=g.Cartn_z||(g.pdbx_model_Cartn_z_ideal&&g.pdbx_model_Cartn_x_ideal[0]!=null?g.pdbx_model_Cartn_z_ideal:g.model_Cartn_z)||g.model_Cartn_z;var X=g.id;var t=g.auth_seq_id||[];var N=g.auth_comp_id;var F=g.label_seq_id||[];var M=g.label_comp_id||g.comp_id||g.model_id;var n=g.auth_asym_id||[];var l=g.label_asym_id||[];var H=g.label_alt_id||[];var z=g.auth_atom_id||g.atom_id;var x=g.label_atom_id||[];var aq=g.type_symbol;var aj=g.pdbx_PDB_model_num;var G=null;var ah=null;var ay=null;var Z=null;var f;var ab=null,aa,P;var W={};try{for(var an=0;an<C.chem_comp.id.length;an++){if(C.chem_comp.mon_nstd_flag[an]||C.chem_comp.type[an].toLowerCase().indexOf("peptide")!=-1){W[C.chem_comp.id[an]]=true}}W.ACE=W.NME=true}catch(at){W=molmil.AATypes}for(var ax=0;ax<V.length;ax++){if((aj&&aj[ax]!=P)||!ab){if(ab){break}this.structures.push(ab=new molmil.entryObject({id:o}));P=aj?aj[ax]:0;ah=Z=null}if(l[ax]!=ah||!G){this.chains.push(G=new molmil.chainObject(l[ax],ab));ab.chains.push(G);G.authName=n[ax];G.CID=this.CID++;ah=l[ax];Z=null}if((F[ax]||t[ax])!=Z||!ay){G.molecules.push(ay=new molmil.molObject((M[ax]||N[ax]),(F[ax]||t[ax]),G));ay.RSID=t[ax]||F[ax];ay.MID=this.MID++;Z=(F[ax]||t[ax])}aa=G.modelsXYZ[0].length;G.modelsXYZ[0].push(U[ax],S[ax],R[ax]);ay.atoms.push(f=new molmil.atomObject(aa,z[ax]||x[ax]||"",aq[ax]||"",ay,G));f.label_alt_id=H[ax];if(f.label_alt_id&&f.label_alt_id!="A"){f.status=false}if(q||!W.hasOwnProperty(ay.name)){if(ay.name=="HOH"||ay.name=="DOD"||ay.name=="WAT"){ay.water=true;ay.ligand=false}}else{G.isHet=false;if(f.atomName=="N"){ay.N=f;ay.ligand=false}else{if(f.atomName=="CA"){ay.CA=f;ay.ligand=false}else{if(f.atomName=="C"){ay.C=f;ay.ligand=false}else{if(f.atomName=="O"){ay.O=f;ay.ligand=false;ay.xna=false}else{if(f.atomName=="P"&&!ay.O){ay.N=f;ay.xna=true;ay.ligand=false;if(!ay.CA){ay.CA=f}}else{if(f.atomName=="C1'"&&!ay.O){ay.CA=f;ay.xna=true;ay.ligand=false}else{if(f.atomName=="O3'"&&!ay.O){ay.C=f;ay.xna=true;ay.ligand=false}}}}}}}}G.atoms.push(f);f.AID=this.AID++;this.atomRef[f.AID]=f}K.push(ab);var p=0,s;for(;ax<V.length;ax++){if(aj&&aj[ax]!=P){P=aj?aj[ax]:0;ah=null;p=-1}if(l[ax]!=ah||!G){ah=l[ax];p+=1;if(p>=ab.chains.length){s=[]}else{ab.chains[p].modelsXYZ.push(s=[])}}s.push(U[ax],S[ax],R[ax])}ab.number_of_frames=ab.chains.length?ab.chains[0].modelsXYZ.length:0;this.calculateCOG();var T=C.chem_comp_bond||C.pdbx_chem_comp_model_bond;if(T){var au={};for(var an=0;an<ab.chains[0].atoms.length;an++){au[ab.chains[0].atoms[an].atomName]=ab.chains[0].atoms[an]}var af,ae;for(var an=0;an<T.atom_id_1.length;an++){af=au[T.atom_id_1[an]];ae=au[T.atom_id_2[an]];ab.chains[0].bonds.push([af,ae,T.value_order[an]=="DOUB"?2:1])}ab.chains[0].bondsOK=true}else{for(var an=0;an<ab.chains.length;an++){this.buildAminoChain(ab.chains[an])}}var ad,Y,h,al,w,L,B;var E=false;var aw=C.struct_conf;if(aw&&V.length){for(var an=0,ag;an<aw.id.length;an++){ad=aw.conf_type_id[an];if(ad=="HELX_P"){ad=3}else{if(ad=="TURN_P"){ad=4}else{continue}}Y=aw.beg_label_asym_id[an];h=aw.beg_label_seq_id[an];al=aw.end_label_asym_id[an];w=aw.end_label_seq_id[an];L=this.getMolObject4Chain(this.getChain(ab,Y),h);B=this.getMolObject4Chain(this.getChain(ab,al),w);while(B){if(L==null){break}L.sndStruc=ad;if(L==B){break}L=L.next}}E=true}var am=C.struct_sheet_range;if(am&&V.length){for(var an=0,ag;an<am.beg_label_asym_id.length;an++){Y=am.beg_label_asym_id[an];h=am.beg_label_seq_id[an];al=am.end_label_asym_id[an];w=am.end_label_seq_id[an];L=this.getMolObject4Chain(this.getChain(ab,Y),h);B=this.getMolObject4Chain(this.getChain(ab,al),w);while(B){if(L==null){break}L.sndStruc=2;if(L==B){break}L=L.next}}E=true}if(!E){for(av=0;av<ab.chains.length;av++){this.ssAssign(ab.chains[av])}}var Q;if(C.hasOwnProperty("entity_poly")){Q=C.entity_poly.entity_id;for(var an=0;an<C.struct_asym.id.length;an++){if(Q.indexOf(C.struct_asym.entity_id[an])!=-1){this.poly_asym_ids.push(C.struct_asym.id[an])}}}var I=C.pdbx_struct_oper_list;if(I){var an,D=I.type.length;var A=!I.hasOwnProperty("matrix[1][1]");for(an=0;an<D;an++){mat=mat4.create();mat[0]=I[A?"matrix11":"matrix[1][1]"][an];mat[4]=I[A?"matrix12":"matrix[1][2]"][an];mat[8]=I[A?"matrix13":"matrix[1][3]"][an];mat[12]=I[A?"vector1":"vector[1]"][an];mat[1]=I[A?"matrix21":"matrix[2][1]"][an];mat[5]=I[A?"matrix22":"matrix[2][2]"][an];mat[9]=I[A?"matrix23":"matrix[2][3]"][an];mat[13]=I[A?"vector2":"vector[2]"][an];mat[2]=I[A?"matrix31":"matrix[3][1]"][an];mat[6]=I[A?"matrix32":"matrix[3][2]"][an];mat[10]=I[A?"matrix33":"matrix[3][3]"][an];mat[14]=I[A?"vector3":"vector[3]"][an];if(mat[0]==1&&mat[1]==0&&mat[2]==0&&mat[3]==0&&mat[4]==0&&mat[5]==1&&mat[6]==0&&mat[7]==0&&mat[8]==0&&mat[9]==0&&mat[10]==1&&mat[11]==0&&mat[12]==0&&mat[13]==0&&mat[14]==0&&mat[15]==1){this.BUmatrices[I.id[an]]=["identity operation",mat]}else{this.BUmatrices[I.id[an]]=[I.type[an],mat]}}var O=C.pdbx_struct_assembly_gen,ar,ap,ao=mat4.create(),ak,ai,J;D=O.assembly_id.length;var y=function(c){ap=[];c=c.split(",");for(ak=0;ak<c.length;ak++){if(c[ak].indexOf("-")!=-1){c[ak]=c[ak].replace("(","").replace(")","").split("-");for(ai=parseInt(c[ak][0]);ai<parseInt(c[ak][1])+1;ai++){ap.push(ai)}}else{ap.push(c[ak].replace("(","").replace(")",""))}}return ap};for(an=0;an<D;an++){if(!this.BUassemblies.hasOwnProperty(O.assembly_id[an])){this.BUassemblies[O.assembly_id[an]]=[]}J=[];if(O.oper_expression[an].indexOf(")(")!=-1){ar=O.oper_expression[an].split(")(");ar[0]=y(ar[0].substr(1));ar[1]=y(ar[1].substr(0,ar[1].length-1));for(ak=0;ak<ar[0].length;ak++){for(ai=0;ai<ar[1].length;ai++){Q="combi_"+ar[0][ak]+"_"+ar[1][ai];if(!this.BUmatrices.hasOwnProperty(Q)){mat4.multiply(ao,this.BUmatrices[ar[0][ak]][1],this.BUmatrices[ar[1][ai]][1]);if(ao[0]==1&&ao[1]==0&&ao[2]==0&&ao[3]==0&&ao[4]==0&&ao[5]==1&&ao[6]==0&&ao[7]==0&&ao[8]==0&&ao[9]==0&&ao[10]==1&&ao[11]==0&&ao[12]==0&&ao[13]==0&&ao[14]==0&&ao[15]==1){this.BUmatrices[Q]=["identity operation",ao]}else{this.BUmatrices[Q]=["combined",mat4.clone(ao)]}}J.push(Q)}}}else{J=y(O.oper_expression[an])}this.BUassemblies[O.assembly_id[an]].push([J,O.asym_id_list[an].split(",")])}}for(var av=0,ag,d;av<ab.chains.length;av++){for(ag=0;ag<ab.chains[av].molecules.length;ag++){d=ab.chains[av].molecules[ag];if(!d.ligand&&!d.water&&!d.xna&&!molmil.AATypesBase.hasOwnProperty(d.name)){d.weirdAA=true}}}molmil.resetColors(ab,this)}this.renderer.camera.z=this.calcZ();this.pdbxData=C;delete C.atom_site;return K[0]};molmil.viewer.prototype.calculateCOG=function(){if(this.skipCOGupdate){return}this.avgX=0;this.avgY=0;this.avgZ=0;this.stdX=0;this.stdY=0;this.stdZ=0;this.avgXYZ=[0,0,0];this.stdXYZ=[0,0,0];var u=0;var o;var g,l;var y=[];this.geomRanges=[0,0,0,0,0,0],ALTs=[];var q,t,p,B,w,D;for(p=0;p<this.structures.length;p++){q=this.structures[p];if(q instanceof molmil.entryObject){for(B=0;B<q.chains.length;B++){t=q.chains[B];g=t.modelsXYZ[0];for(w=0;w<t.molecules.length;w++){if(!t.molecules[w].status){continue}if(t.molecules[w].ligand||t.molecules[w].water){for(D=0;D<t.molecules[w].atoms.length;D++){l=t.molecules[w].atoms[D].xyz;xyz=[g[l],g[l+1],g[l+2]];this.avgX+=xyz[0];this.avgY+=xyz[1];this.avgZ+=xyz[2];y.push(xyz);u++}}else{o=t.molecules[w].CA;if(o!=null){l=o.xyz;xyz=[g[l],g[l+1],g[l+2]];this.avgX+=xyz[0];this.avgY+=xyz[1];this.avgZ+=xyz[2];y.push(xyz);u+=1}}}}}else{if(q instanceof molmil.polygonObject){this.avgX+=q.meta.COR[0];this.avgY+=q.meta.COR[1];this.avgZ+=q.meta.COR[2];u+=q.meta.COR[3];if(q.meta.hasOwnProperty("geomRanges")){ALTs.push(q.meta.geomRanges,q.meta.COR[3])}}}}if(u==0){return}this.avgX/=u;this.avgY/=u;this.avgZ/=u;var z=1e+99,E=-1e+99,d=1e+99,f=-1e+99,h=1e+99,j=-1e+99;var A,C;for(var x=0;x<y.length;x++){A=y[x][0]-this.avgX;this.stdX+=A*A;if(A<z){z=A}if(A>E){E=A}A=y[x][1]-this.avgY;this.stdY+=A*A;if(A<d){d=A}if(A>f){f=A}A=y[x][2]-this.avgZ;this.stdZ+=A*A;if(A<h){h=A}if(A>j){j=A}}for(var x=0;x<ALTs.length;x+=2){A=ALTs[x][0]-this.avgX;this.stdX+=(A*A)*C*0.5;if(A<z){z=A}A=ALTs[x][1]-this.avgX;this.stdX+=(A*A)*C*0.5;if(A>E){E=A}A=ALTs[x][2]-this.avgY;this.stdY+=(A*A)*C*0.5;if(A<d){d=A}A=ALTs[x][3]-this.avgY;this.stdY+=(A*A)*C*0.5;if(A>f){f=A}A=ALTs[x][4]-this.avgZ;this.stdZ+=(A*A)*C*0.5;if(A<h){h=A}A=ALTs[x][5]-this.avgZ;this.stdZ+=(A*A)*C*0.5;if(A>j){j=A}}this.stdX=Math.sqrt(this.stdX/u);this.stdY=Math.sqrt(this.stdY/u);this.stdZ=Math.sqrt(this.stdZ/u);this.avgXYZ=[this.avgX,this.avgY,this.avgZ];this.stdXYZ=[this.stdX,this.stdY,this.stdZ];this.COR=this.avgXYZ;this.geomRanges=[z,E,d,f,h,j]};molmil.viewer.prototype.ssAssign=function(F){var n,l,az=[0,0,0],aw=[0,0,0],at=[0,0,0],aq=[0,0,0],t,q;for(var aj=0;aj<F.molecules.length;aj++){n=F.molecules[aj];t=n.chain;if(n.ligand||n.water||n.name=="PRO"||n.xna){continue}if(n.previous){try{n.NH={xyz:[0,0,0]};az[0]=t.modelsXYZ[0][n.previous.C.xyz];az[1]=t.modelsXYZ[0][n.previous.C.xyz+1];az[2]=t.modelsXYZ[0][n.previous.C.xyz+2];aw[0]=t.modelsXYZ[0][n.previous.O.xyz];aw[1]=t.modelsXYZ[0][n.previous.O.xyz+1];aw[2]=t.modelsXYZ[0][n.previous.O.xyz+2];at[0]=t.modelsXYZ[0][n.N.xyz];at[1]=t.modelsXYZ[0][n.N.xyz+1];at[2]=t.modelsXYZ[0][n.N.xyz+2];vec3.subtract(n.NH.xyz,az,aw);vec3.normalize(n.NH.xyz,n.NH.xyz);vec3.add(n.NH.xyz,n.NH.xyz,at)}catch(ap){n.NH=null}}else{n.NH=true}}var af,ae,ad;var Z=function(d,c){af=c[0]-d[0];ae=c[1]-d[1];ad=c[2]-d[2];return af*af+ae*ae+ad*ad};var p={},f={},u=[],ar;var an,am,G,ai,ac,ag,aa;for(an=0;an<F.molecules.length;an++){n=F.molecules[an];t=n.chain;if(n.ligand||n.water||n.xna){continue}if(!n.previous){u.push(ar=[])}ar.push(n);for(am=an+2;am<F.molecules.length;am++){l=F.molecules[am];q=l.chain;if(l.ligand||l.water||n.xna||!n.N||!l.C||!n.C||!l.N){continue}az[0]=t.modelsXYZ[0][n.N.xyz];az[1]=t.modelsXYZ[0][n.N.xyz+1];az[2]=t.modelsXYZ[0][n.N.xyz+2];aw[0]=q.modelsXYZ[0][l.C.xyz];aw[1]=q.modelsXYZ[0][l.C.xyz+1];aw[2]=q.modelsXYZ[0][l.C.xyz+2];ai=Z(az,aw);if(ai<25&&n.NH&&l.O){ai=Math.sqrt(ai);at[0]=q.modelsXYZ[0][l.O.xyz];at[1]=q.modelsXYZ[0][l.O.xyz+1];at[2]=q.modelsXYZ[0][l.O.xyz+2];ac=Math.sqrt(Z(az,at));if(n.NH==true){ag=ai-1;aa=ac-1}else{ag=Math.sqrt(Z(n.NH.xyz,aw));aa=Math.sqrt(Z(n.NH.xyz,at))}G=0.084*((1/ac)+(1/ag)-(1/aa)-(1/ai))*332;if(G<-0.67){p[n.MID+"-"+l.MID]=G;if(!f.hasOwnProperty(n.MID)){f[n.MID]=[]}f[n.MID].push(l);if(!f.hasOwnProperty(l.MID)){f[l.MID]=[]}f[l.MID].push(n)}}az[0]=t.modelsXYZ[0][n.C.xyz];az[1]=t.modelsXYZ[0][n.C.xyz+1];az[2]=t.modelsXYZ[0][n.C.xyz+2];aw[0]=q.modelsXYZ[0][l.N.xyz];aw[1]=q.modelsXYZ[0][l.N.xyz+1];aw[2]=q.modelsXYZ[0][l.N.xyz+2];ai=Z(aw,az);if(ai<25&&n.O&&l.NH){ai=Math.sqrt(ai);at[0]=t.modelsXYZ[0][n.O.xyz];at[1]=t.modelsXYZ[0][n.O.xyz+1];at[2]=t.modelsXYZ[0][n.O.xyz+2];ac=Math.sqrt(Z(aw,at));if(l.NH==true){ag=ai-1;aa=ac-1}else{ag=Math.sqrt(Z(l.NH.xyz,az));aa=Math.sqrt(Z(l.NH.xyz,at))}G=0.084*((1/ac)+(1/ag)-(1/aa)-(1/ai))*332;if(G<-0.67){p[l.MID+"-"+n.MID]=G;if(!f.hasOwnProperty(n.MID)){f[n.MID]=[]}f[n.MID].push(l);if(!f.hasOwnProperty(l.MID)){f[l.MID]=[]}f[l.MID].push(n)}}}}if(Object.keys(f).length==0){var U=180/Math.PI;var aA=[0,0,0],ax=[0,0,0],au=[0,0,0],aC=[0,0,0],aB=[0,0,0],O=[0,0,0],g;var h=function(d,c,x,j){try{vec3.subtract(aA,c,d);vec3.subtract(ax,x,c);vec3.subtract(au,j,x);vec3.scale(aC,aA,vec3.length(ax));vec3.cross(aB,ax,au);ae=vec3.dot(aC,aB);vec3.cross(O,aA,ax);af=vec3.dot(O,aB);g=Math.atan2(ae,af)*U;if(g<0){g+=360}return g}catch(i){return 0}};var az,aw,at,aq,N,K,J,I,ah,M=[],ay=[];for(var T=0;T<u.length;T++){ar=u[T];M=[],ay=[];for(aj=2;aj<ar.length-1;aj++){az=ar[aj-2].CA;aw=ar[aj-1].CA;at=ar[aj].CA;aq=ar[aj+1].CA;if(!az||!aw||!at||!aq){M.push(0);ay.push(0);continue}az=az.xyz;aw=aw.xyz;at=at.xyz;aq=aq.xyz;N=[F.modelsXYZ[0][az],F.modelsXYZ[0][az+1],F.modelsXYZ[0][az+2]];K=[F.modelsXYZ[0][aw],F.modelsXYZ[0][aw+1],F.modelsXYZ[0][aw+2]];J=[F.modelsXYZ[0][at],F.modelsXYZ[0][at+1],F.modelsXYZ[0][at+2]];I=[F.modelsXYZ[0][aq],F.modelsXYZ[0][aq+1],F.modelsXYZ[0][aq+2]];ah=h(N,K,J,I);if(ah>=10&&ah<=120){M.push(1)}else{if(ah>=120&&ah<=270){M.push(2)}else{M.push(0)}}ay.push(ah)}M.push(0);for(aj=1;aj<ar.length-1;aj++){if(M[aj]==0){if(M[aj-1]==1&&M[aj+1]==1){M[aj]=1}if(M[aj-1]==2&&M[aj+1]==2){M[aj]=2}}}M[0]=M[1]=M[2];M[M.length-1]=M[M.length-2];var s=[-1,0],al;for(aj=0;aj<M.length;aj++){if(M[aj]!=s[1]){if(s[1]!=0&&aj-s[0]<4){for(al=s[0];al<aj;al++){M[al]=0}}s[0]=aj;s[1]=M[aj]}}for(aj=0;aj<ar.length;aj++){if(M[aj]==1){ar[aj].sndStruc=3}else{if(M[aj]==2){ar[aj].sndStruc=2}else{if(M[aj]==3){ar[aj].sndStruc=4}}}}}return}var ab=function(c){return c?c.MID:null};var W,V,o,w;var L=[],av,Y,X,ao,R,Q,H=[],S=false;for(var at=0;at<u.length;at++){L.push(av=[]);for(an=0;an<u[at].length;an++){o=0;W=ab(u[at][an]);Y=X=[at,an];if((p.hasOwnProperty(ab(u[at][an+3])+"-"+W))&&!S&&(H.length<3||p.hasOwnProperty(W+"-"+ab(u[at][an-3])))){o=3;Y=[at,an];X=[at,an+3]}else{if(p.hasOwnProperty(W+"-"+ab(u[at][an-3]))&&H.length>3){o=3;Y=[at,an-3];X=[at,an];S=true}}if(p.hasOwnProperty(ab(u[at][an+5])+"-"+W)&&!S&&(H.length<5||p.hasOwnProperty(W+"-"+ab(u[at][an-5])))){o=5;Y=[at,an];X=[at,an+5]}else{if(p.hasOwnProperty(W+"-"+ab(u[at][an-5]))&&H.length>5){o=5;Y=[at,an-5];X=[at,an];S=true}}if(p.hasOwnProperty(ab(u[at][an+4])+"-"+W)&&!S&&(H.length<4||p.hasOwnProperty(W+"-"+ab(u[at][an-4])))){o=4;Y=[at,an];X=[at,an+4]}else{if(p.hasOwnProperty(W+"-"+ab(u[at][an-4]))&&H.length>3){o=4;Y=[at,an-4];X=[at,an];S=true}}if(H.length&&H[H.length-1]!=o){H=[];S=false}H.push(o);av.push([o,Y,X])}}for(var at=0;at<L.length;at++){av=L[at];w=[];H=[];o=0;for(an=0;an<av.length;an++){if(av[an][0]!=o){if(o==3||o==4||o==5){if((w.length>1&&o!=3)||w.length>2){for(am=w[0][1][1];am<w[w.length-1][2][1];am++){u[at][am].sndStruc=3}}else{if(w.length){H.push([w[0][1][1],w[w.length-1][2][1]])}}}o=0;w=[]}if(av[an][0]){w.push(av[an]);o=av[an][0]}}for(an=0;an<H.length;an++){W=Math.max(0,H[an][0]-1);V=Math.min(u[at].length-1,H[an][1]+1);o=u[at][Math.max(0,H[an][0]-1)].sndStruc==3||u[at][Math.min(u[at].length-1,H[an][1]+1)].sndStruc==3?3:4;for(am=H[an][0];am<H[an][1];am++){u[at][am].sndStruc=o}}}var P;for(var at=0;at<u.length;at++){for(an=0;an<u[at].length;an++){if(u[at][an].sndStruc!=3){ao=null;if(u[at][an].previous&&u[at][an].next){R=f[ab(u[at][an].previous)];Q=f[ab(u[at][an].next)];if(R&&Q){for(var al=0,ak;al<R.length;al++){for(ak=0;ak<Q.length;ak++){if(R[al].previous&&R[al].previous==Q[ak].next){ao=[R[al].previous];break}else{if(Q[ak].previous&&Q[ak].previous==R[al].next){ao=[R[al].next];break}}}if(ao){break}}}}if(!ao){ao=f[ab(u[at][an])]}if(ao){for(P=0;P<ao.length;P++){if(ao[P].sndStruc==2){u[at][an].sndStruc=2;break}R=[u[at][an].previous,u[at][an],u[at][an].next];Q=[ao[P].previous,ao[P],ao[P].next];if(p.hasOwnProperty(ab(R[0])+"-"+ab(Q[1]))&&p.hasOwnProperty(ab(Q[1])+"-"+ab(R[2]))){R[0].sndStruc=R[1].sndStruc=R[2].sndStruc=Q[1].sndStruc=2}else{if(p.hasOwnProperty(ab(R[1])+"-"+ab(Q[0]))&&p.hasOwnProperty(ab(Q[2])+"-"+ab(R[1]))){R[1].sndStruc=Q[0].sndStruc=Q[1].sndStruc=Q[2].sndStruc=2}else{if(p.hasOwnProperty(ab(R[1])+"-"+ab(Q[1]))&&p.hasOwnProperty(ab(Q[1])+"-"+ab(R[1]))){R[1].sndStruc=Q[1].sndStruc=2}else{if(p.hasOwnProperty(ab(R[0])+"-"+ab(Q[2]))&&p.hasOwnProperty(ab(R[2])+"-"+ab(Q[0]))){R[0].sndStruc=R[1].sndStruc=R[2].sndStruc=Q[0].sndStruc=Q[1].sndStruc=Q[2].sndStruc=2}}}}}}}}}};molmil.viewer.prototype.setCOR=function(){var g=this.renderer.modelId;if(this.lastKnowAS){resetCOR()}this.lastKnownAS=null;if(!this.atomSelection.length){return}this.lastKnownAS=[this.atomSelection[0].chain.modelsXYZ[g][this.atomSelection[0].xyz],this.atomSelection[0].chain.modelsXYZ[g][this.atomSelection[0].xyz+1],this.atomSelection[0].chain.modelsXYZ[g][this.atomSelection[0].xyz+2]];var d=mat3.create();mat3.fromMat4(d,this.renderer.modelViewMatrix);var f=vec3.subtract([0,0,0],this.lastKnownAS,this.avgXYZ);vec3.transformMat3(f,f,d);this.renderer.camera.x+=f[0];this.renderer.camera.y+=f[1];this.renderer.camera.z+=f[2];for(var c=0;c<this.canvases.length;c++){this.canvases[c].molmilViewer.COR=this.lastKnownAS}this.canvas.atomCORset=true};molmil.viewer.prototype.resetCOR=function(){var d=mat3.create();mat3.fromMat4(d,this.renderer.modelViewMatrix);var f=vec3.subtract([0,0,0],this.avgXYZ,this.lastKnownAS);vec3.transformMat3(f,f,d);this.renderer.camera.x+=f[0];this.renderer.camera.y+=f[1];this.renderer.camera.z+=f[2];for(var c=0;c<this.canvases.length;c++){this.canvases[c].molmilViewer.COR=this.avgXYZ}this.canvas.atomCORset=false;this.lastKnownAS=null};molmil.exportPLY=function(A){A=A||molmil.cli_soup;molmil.geometry.skipClearBuffer=true;molmil.geometry.reInitChains=true;A.renderer.initBuffers();A.renderer.canvas.update=true;molmil.geometry.generate(A.structures,A.renderer);var g=[];if(molmil.geometry.buffer1){g.push(molmil.geometry.buffer1)}if(molmil.geometry.buffer3){g.push(molmil.geometry.buffer3)}if(molmil.geometry.buffer4){g.push(molmil.geometry.buffer4)}for(var w=0;w<A.structures.length;w++){if(A.structures[w] instanceof molmil.polygonObject&&A.structures[w].data){g.push(A.structures[w].data)}}var s,d=0,o=0,t;for(s=0;s<g.length;s++){t=g[s].vertexSize||8;d+=g[s].vertexBuffer.length/t;o+=g[s].indexBuffer.length/3}var u="ply\nformat binary_little_endian 1.0\nelement vertex "+d+"\nproperty float x\nproperty float y\nproperty float z\nproperty float nx\nproperty float ny\nproperty float nz\nproperty uint8 red\nproperty uint8 green\nproperty uint8 blue\nproperty uint8 alpha\nelement face "+o+"\nproperty list int32 int32 vertex_indices\nend_header\n";var h=new Float32Array(d*7);var j=new Uint8Array(h.buffer);var n=new Int32Array(o*4);var p,B,y=0,z=0,l=0,x,q,f=0;for(s=0;s<g.length;s++){t=g[s].vertexSize||8;x=g[s].vertexBuffer;q=new Uint8Array(x.buffer,g[s].vertices_offset);for(p=0,B=0;p<x.length;p+=t,B+=(t*4),z+=28){h[y++]=x[p];h[y++]=x[p+1];h[y++]=x[p+2];h[y++]=x[p+3];h[y++]=x[p+4];h[y++]=x[p+5];j[z+24]=q[B+24];j[z+25]=q[B+25];j[z+26]=q[B+26];j[z+27]=q[B+27];y++}x=g[s].indexBuffer;for(p=0;p<x.length;p+=3){n[l++]=3;n[l++]=f+x[p];n[l++]=f+x[p+1];n[l++]=f+x[p+2]}f+=g[s].vertexBuffer.length/t}var c=new Blob([u,h,n],{type:"application/octet-binary"});saveAs(c,"molmil.ply");molmil.geometry.skipClearBuffer=false};molmil.exportSTL=function(A){A=A||molmil.cli_soup;molmil.geometry.skipClearBuffer=true;molmil.geometry.reInitChains=true;A.renderer.initBuffers();A.renderer.canvas.update=true;molmil.geometry.generate(A.structures,A.renderer);var l=[];if(molmil.geometry.buffer1){l.push(molmil.geometry.buffer1)}if(molmil.geometry.buffer3){l.push(molmil.geometry.buffer3)}if(molmil.geometry.buffer4){l.push(molmil.geometry.buffer4)}for(var x=0;x<A.structures.length;x++){if(A.structures[x] instanceof molmil.polygonObject&&A.structures[x].data){l.push(A.structures[x].data)}}var s,h=0,o=0,t;for(s=0;s<l.length;s++){t=l[s].vertexSize||8;h+=l[s].vertexBuffer.length/t;o+=l[s].indexBuffer.length/3}var w="generated by molmil";w+=new Array(80-w.length+1).join(" ");var p=new Uint32Array(1);p[0]=o;var q=[w,p];var s,B,j,y,n,x,g=[0,0,0],f=[0,0,0],d=[0,0,0],z=[0,0,0],u=[0,0,0];for(s=0;s<l.length;s++){y=l[s].vertexBuffer;n=l[s].indexBuffer;t=l[s].vertexSize||8;for(v=0;v<n.length;v+=3){B=new Float32Array(12);j=new Uint16Array(1);j[0]=0;x=n[v]*t;g[0]=B[3]=y[x];g[1]=B[4]=y[x+1];g[2]=B[5]=y[x+2];x=n[v+1]*t;f[0]=B[6]=y[x];f[1]=B[7]=y[x+1];f[2]=B[8]=y[x+2];x=n[v+2]*t;d[0]=B[9]=y[x];d[1]=B[10]=y[x+1];d[2]=B[11]=y[x+2];vec3.min(z,f,g);vec3.normalize(z,z);vec3.min(u,d,g);vec3.normalize(u,u);B[0]=z[1]*u[2]-z[2]*u[1];B[1]=z[2]*u[0]-z[0]*u[2];B[2]=z[0]*u[1]-z[1]*u[0];q.push(B);q.push(j)}}var c=new Blob(q,{type:"application/octet-binary"});saveAs(c,"molmil.stl");molmil.geometry.skipClearBuffer=false};molmil.geometry={templates:{sphere:{},cylinder:[],dome:{}},detail_lvs:5,dome:[0,0,-1],radius:0.25,sheetHeight:0.125,skipClearBuffer:false,onGenerate:null};molmil.geometry.getSphere=function(c,d){if(c in this.templates.sphere){return this.templates.sphere[c][d]}else{return this.generateSphere(c)[d]}};molmil.geometry.getCylinder=function(c){return this.templates.cylinder[c]};molmil.geometry.generateCylinder=function(){var f,j,d,c,n,l,i,h;for(var g=0;g<this.detail_lvs;g++){f=(g+1)*4;d=0;j=2/f;this.templates.cylinder.push({vertices:[],normals:[],indices:[]});for(c=0;c<f;c++){n=Math.cos(d*Math.PI);l=Math.sin(d*Math.PI);this.templates.cylinder[g].vertices.push(n,l,0);this.templates.cylinder[g].vertices.push(n,l,0.5);h=Math.sqrt(n*n+l*l);this.templates.cylinder[g].normals.push(n/h,l/h,0);this.templates.cylinder[g].normals.push(n/h,l/h,0);d+=j}for(c=0;c<(f-1)*2;c+=2){this.templates.cylinder[g].indices.push(c,c+2,c+3);this.templates.cylinder[g].indices.push(c+3,c+1,c)}this.templates.cylinder[g].indices.push(c,0,1);this.templates.cylinder[g].indices.push(1,c+1,c)}return this.templates.cylinder};molmil.geometry.generateCylinder();molmil.geometry.generateSphere=function(h){this.templates.sphere[h]=[];var g,f,d,c;for(g=0;g<this.detail_lvs;g++){d={vertices:[],normals:[],indices:[]};c=molmil.octaSphereBuilder(g);for(f=0;f<c.vertices.length;f++){d.vertices.push(c.vertices[f][0]*h,c.vertices[f][1]*h,c.vertices[f][2]*h)}for(f=0;f<c.faces.length;f++){d.indices.push(c.faces[f][0],c.faces[f][1],c.faces[f][2])}for(f=0;f<c.vertices.length;f++){d.normals.push(c.vertices[f][0],c.vertices[f][1],c.vertices[f][2])}this.templates.sphere[h].push(d)}return this.templates.sphere[h]};molmil.geometry.generate=function(h,g,i){this.reset();var j=[],d=[];for(var f=0,l;f<h.length;f++){if(!(h[f] instanceof molmil.entryObject)){continue}for(var l=0;l<h[f].chains.length;l++){if(h[f].chains[l].display&&h[f].chains[l].molecules.length>0&&!h[f].chains[l].isHet&&!h[f].chains[l].molecules[0].water){d.push(h[f].chains[l])}j.push(h[f].chains[l])}}this.initChains(j,g,i);this.initCartoon(d);this.generateAtoms();this.generateBonds();this.generateWireframe();this.generateCartoon();this.generateSurfaces(d);this.registerPrograms(g);if(!this.skipClearBuffer){this.reset()}if(this.onGenerate){molmil_dep.asyncStart(this.onGenerate[0],this.onGenerate[1],this.onGenerate[2],0)}};molmil.geometry.registerPrograms=function(g){var h=g.gl,d,f,c;if(!g.program1){d=g.program1={};d.status=true;d.gl=h;d.renderer=g;d.angle=g.angle;d.shader=g.shaders.standard_alpha;d.pickingShader=g.shaders.picking;d.pickingAttributes=d.pickingShader.attributes;d.attributes=d.shader.attributes;d.render=function(j,n){if(!this.status){return}var o=mat3.create();mat3.normalFromMat4(o,j);this.gl.useProgram(this.shader.program);this.gl.uniformMatrix4fv(this.shader.uniforms.modelViewMatrix,false,j);this.gl.uniformMatrix3fv(this.shader.uniforms.normalMatrix,false,o);this.gl.uniformMatrix4fv(this.shader.uniforms.projectionMatrix,false,this.renderer.projectionMatrix);this.gl.uniform3f(this.shader.uniforms.COR,n[0],n[1],n[2]);this.gl.uniform1f(this.shader.uniforms.focus,this.renderer.fogStart);this.gl.uniform1f(this.shader.uniforms.fogSpan,this.renderer.fogStart+(this.renderer.clearCut*2));this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer);this.gl.vertexAttribPointer(this.attributes.in_Position,3,this.gl.FLOAT,false,32,0);this.gl.vertexAttribPointer(this.attributes.in_Normal,3,this.gl.FLOAT,false,32,12);this.gl.vertexAttribPointer(this.attributes.in_Colour,4,this.gl.UNSIGNED_BYTE,true,32,24);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);if(this.angle){var l=0,i;while((i=Math.min(this.nElements-l,3000000))>0){this.gl.drawElements(this.gl.TRIANGLES,i,h.UNSIGNED_INT,l*4);l+=i}}else{this.gl.drawElements(this.gl.TRIANGLES,this.nElements,h.UNSIGNED_INT,0)}};d.renderPicking=function(j,n){if(!this.status){return}this.gl.useProgram(this.pickingShader.program);this.gl.uniformMatrix4fv(this.pickingShader.uniforms.modelViewMatrix,false,j);this.gl.uniformMatrix4fv(this.pickingShader.uniforms.projectionMatrix,false,this.renderer.projectionMatrix);this.gl.uniform3f(this.pickingShader.uniforms.COR,n[0],n[1],n[2]);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer);this.gl.vertexAttribPointer(this.pickingAttributes.in_Position,3,this.gl.FLOAT,false,32,0);this.gl.vertexAttribPointer(this.pickingAttributes.in_ID,1,this.gl.FLOAT,false,32,28);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);if(this.angle){var l=0,i;while((i=Math.min(this.nElements-l,3000000))>0){this.gl.drawElements(this.gl.TRIANGLES,i,h.UNSIGNED_INT,l*4);l+=i}}else{this.gl.drawElements(this.gl.TRIANGLES,this.nElements,h.UNSIGNED_INT,0)}};g.programs.push(d)}if(!g.program2){d=g.program2={};d.status=true;d.gl=h;d.renderer=g;d.angle=g.angle;d.shader=g.shaders.lines;d.pickingShader=g.shaders.linesPicking;d.pickingAttributes=d.pickingShader.attributes;d.attributes=d.shader.attributes;d.render=function(j,n){if(!this.status){return}var o=mat3.create();mat3.normalFromMat4(o,j);this.gl.useProgram(this.shader.program);this.gl.uniformMatrix4fv(this.shader.uniforms.modelViewMatrix,false,j);this.gl.uniformMatrix4fv(this.shader.uniforms.projectionMatrix,false,this.renderer.projectionMatrix);this.gl.uniform3f(this.shader.uniforms.COR,n[0],n[1],n[2]);this.gl.uniform1f(this.shader.uniforms.focus,this.renderer.fogStart);this.gl.uniform1f(this.shader.uniforms.fogSpan,this.renderer.fogStart+(this.renderer.clearCut*2));this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer);this.gl.vertexAttribPointer(this.attributes.in_Position,3,this.gl.FLOAT,false,20,0);this.gl.vertexAttribPointer(this.attributes.in_Colour,4,this.gl.UNSIGNED_BYTE,true,20,12);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);if(this.angle){var l=0,i;while((i=Math.min(this.nElements-l,3000000))>0){this.gl.drawElements(this.gl.LINES,i,h.UNSIGNED_INT,l*4);l+=i}}else{this.gl.drawElements(this.gl.LINES,this.nElements,h.UNSIGNED_INT,0)}};d.renderPicking=function(j,n){if(!this.status){return}this.gl.useProgram(this.pickingShader.program);this.gl.uniformMatrix4fv(this.pickingShader.uniforms.modelViewMatrix,false,j);this.gl.uniformMatrix4fv(this.pickingShader.uniforms.projectionMatrix,false,this.renderer.projectionMatrix);this.gl.uniform3f(this.pickingShader.uniforms.COR,n[0],n[1],n[2]);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer);this.gl.vertexAttribPointer(this.pickingAttributes.in_Position,3,this.gl.FLOAT,false,20,0);this.gl.vertexAttribPointer(this.pickingAttributes.in_ID,1,this.gl.FLOAT,false,20,16);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);if(this.angle){var l=0,i;while((i=Math.min(this.nElements-l,3000000))>0){this.gl.drawElements(this.gl.POINTS,i,h.UNSIGNED_INT,l*4);l+=i}}else{this.gl.drawElements(this.gl.POINTS,this.nElements,h.UNSIGNED_INT,0)}};g.programs.push(d)}if(!g.program3){d=g.program3={};d.status=true;d.gl=h;d.renderer=g;d.angle=g.angle;d.shader=g.shaders.standard_alpha;d.pickingShader=g.shaders.picking;d.pickingAttributes=d.pickingShader.attributes;d.attributes=d.shader.attributes;d.render=function(j,n){if(!this.status){return}var o=mat3.create();mat3.normalFromMat4(o,j);this.gl.useProgram(this.shader.program);this.gl.uniformMatrix4fv(this.shader.uniforms.modelViewMatrix,false,j);this.gl.uniformMatrix3fv(this.shader.uniforms.normalMatrix,false,o);this.gl.uniformMatrix4fv(this.shader.uniforms.projectionMatrix,false,this.renderer.projectionMatrix);this.gl.uniform3f(this.shader.uniforms.COR,n[0],n[1],n[2]);this.gl.uniform1f(this.shader.uniforms.focus,this.renderer.fogStart);this.gl.uniform1f(this.shader.uniforms.fogSpan,this.renderer.fogStart+(this.renderer.clearCut*2));this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer);this.gl.vertexAttribPointer(this.attributes.in_Position,3,this.gl.FLOAT,false,32,0);this.gl.vertexAttribPointer(this.attributes.in_Normal,3,this.gl.FLOAT,false,32,12);this.gl.vertexAttribPointer(this.attributes.in_Colour,4,this.gl.UNSIGNED_BYTE,true,32,24);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);if(this.angle){var l=0,i;while((i=Math.min(this.nElements-l,3000000))>0){this.gl.drawElements(this.gl.TRIANGLES,i,h.UNSIGNED_INT,l*4);l+=i}}else{this.gl.drawElements(this.gl.TRIANGLES,this.nElements,h.UNSIGNED_INT,0)}};d.renderPicking=function(j,n){if(!this.status){return}this.gl.useProgram(this.pickingShader.program);this.gl.uniformMatrix4fv(this.pickingShader.uniforms.modelViewMatrix,false,j);this.gl.uniformMatrix4fv(this.pickingShader.uniforms.projectionMatrix,false,this.renderer.projectionMatrix);this.gl.uniform3f(this.pickingShader.uniforms.COR,n[0],n[1],n[2]);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer);this.gl.vertexAttribPointer(this.pickingAttributes.in_Position,3,this.gl.FLOAT,false,32,0);this.gl.vertexAttribPointer(this.pickingAttributes.in_ID,1,this.gl.FLOAT,false,32,28);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);if(this.angle){var l=0,i;while((i=Math.min(this.nElements-l,3000000))>0){this.gl.drawElements(this.gl.TRIANGLES,i,h.UNSIGNED_INT,l*4);l+=i}}else{this.gl.drawElements(this.gl.TRIANGLES,this.nElements,h.UNSIGNED_INT,0)}};g.programs.push(d)}if(!g.program4){d=g.program4={};d.status=true;d.gl=h;d.renderer=g;d.angle=g.angle;d.shader=g.shaders.standard_alpha;d.pickingShader=g.shaders.picking;d.pickingAttributes=d.pickingShader.attributes;d.attributes=d.shader.attributes;d.render=function(j,n){if(!this.status){return}var o=mat3.create();mat3.normalFromMat4(o,j);this.gl.useProgram(this.shader.program);this.gl.uniformMatrix4fv(this.shader.uniforms.modelViewMatrix,false,j);this.gl.uniformMatrix3fv(this.shader.uniforms.normalMatrix,false,o);this.gl.uniformMatrix4fv(this.shader.uniforms.projectionMatrix,false,this.renderer.projectionMatrix);this.gl.uniform3f(this.shader.uniforms.COR,n[0],n[1],n[2]);this.gl.uniform1f(this.shader.uniforms.focus,this.renderer.fogStart);this.gl.uniform1f(this.shader.uniforms.fogSpan,this.renderer.fogStart+(this.renderer.clearCut*2));this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer);this.gl.vertexAttribPointer(this.attributes.in_Position,3,this.gl.FLOAT,false,32,0);this.gl.vertexAttribPointer(this.attributes.in_Normal,3,this.gl.FLOAT,false,32,12);this.gl.vertexAttribPointer(this.attributes.in_Colour,4,this.gl.UNSIGNED_BYTE,true,32,24);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);if(this.angle){var l=0,i;while((i=Math.min(this.nElements-l,3000000))>0){this.gl.drawElements(this.gl.TRIANGLES,i,h.UNSIGNED_INT,l*4);l+=i}}else{this.gl.drawElements(this.gl.TRIANGLES,this.nElements,h.UNSIGNED_INT,0)}};d.renderPicking=function(i,j){};g.programs.push(d)}f=h.createBuffer();h.bindBuffer(h.ARRAY_BUFFER,f);h.bufferData(h.ARRAY_BUFFER,this.buffer1.vertexBuffer,h.STATIC_DRAW);c=h.createBuffer();h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,c);h.bufferData(h.ELEMENT_ARRAY_BUFFER,this.buffer1.indexBuffer,h.STATIC_DRAW);g.program1.nElements=this.buffer1.indexBuffer.length;g.program1.vertexBuffer=f;g.program1.indexBuffer=c;f=h.createBuffer();h.bindBuffer(h.ARRAY_BUFFER,f);h.bufferData(h.ARRAY_BUFFER,this.buffer2.vertexBuffer,h.STATIC_DRAW);c=h.createBuffer();h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,c);h.bufferData(h.ELEMENT_ARRAY_BUFFER,this.buffer2.indexBuffer,h.STATIC_DRAW);g.program2.nElements=this.buffer2.indexBuffer.length;g.program2.vertexBuffer=f;g.program2.indexBuffer=c;f=h.createBuffer();h.bindBuffer(h.ARRAY_BUFFER,f);h.bufferData(h.ARRAY_BUFFER,this.buffer3.vertexBuffer,h.STATIC_DRAW);c=h.createBuffer();h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,c);h.bufferData(h.ELEMENT_ARRAY_BUFFER,this.buffer3.indexBuffer,h.STATIC_DRAW);g.program3.nElements=this.buffer3.indexBuffer.length;g.program3.vertexBuffer=f;g.program3.indexBuffer=c;f=h.createBuffer();h.bindBuffer(h.ARRAY_BUFFER,f);h.bufferData(h.ARRAY_BUFFER,this.buffer4.vertexBuffer,h.STATIC_DRAW);c=h.createBuffer();h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,c);h.bufferData(h.ELEMENT_ARRAY_BUFFER,this.buffer4.indexBuffer,h.STATIC_DRAW);g.program4.nElements=this.buffer4.indexBuffer.length;g.program4.vertexBuffer=f;g.program4.indexBuffer=c};molmil.geometry.reset=function(){this.atoms2draw=[];this.wfatoms2draw=[];this.trace=[];this.bonds2draw=[];this.lines2draw=[];this.bondRef={};this.buffer1={vP:0,iP:0};this.buffer2={vP:0,iP:0};this.buffer3={vP:0,iP:0};this.buffer4={vP:0,iP:0}};molmil.geometry.initChains=function(y,G,g){g=g||0;var t,F,E;var l=this.atoms2draw;var p=this.wfatoms2draw;var C=this.bonds2draw;var q=this.lines2draw;var f=this.bondRef;var h=0,s=0,A;for(var B=0;B<y.length;B++){t=y[B];A=false;if(!t.display){continue}for(var F=0;F<t.atoms.length;F++){if(t.atoms[F].displayMode==0||!t.atoms[F].status){continue}else{if(t.atoms[F].displayMode==4){p.push(t.atoms[F])}else{l.push(t.atoms[F])}}A=true}if(A&&!t.bondsOK){G.soup.buildBondList(t,false)}for(var E=0;E<t.bonds.length;E++){if(t.bonds[E][0].displayMode<2||t.bonds[E][1].displayMode<2||!t.bonds[E][0].status||!t.bonds[E][1].status){continue}if(t.bonds[E][0].displayMode==4||t.bonds[E][1].displayMode==4){q.push(t.bonds[E])}else{C.push(t.bonds[E]);s+=t.bonds[E][2]*2;if(!f.hasOwnProperty(t.bonds[E][0].AID)){f[t.bonds[E][0].AID]=[]}if(!f.hasOwnProperty(t.bonds[E][1].AID)){f[t.bonds[E][1].AID]=[]}f[t.bonds[E][0].AID].push(t.bonds[E][1]);f[t.bonds[E][1].AID].push(t.bonds[E][0])}}if(t.displayMode==1){if(!t.bondsOK){G.soup.buildBondList(t,false)}for(var u=0;u<t.molecules.length;u++){if(t.molecules[u].CA){if(t.molecules[u].next&&t.molecules[u].next.displayMode==1&&t.molecules[u].next.CA){l.push(t.molecules[u].CA);C.push([t.molecules[u].CA,t.molecules[u].next.CA]);s+=2}else{if(t.molecules[u].previous&&t.molecules[u].previous.displayMode==1&&t.molecules[u].previous.CA){l.push(t.molecules[u].CA)}}}}}if(t.displayMode>1&&t.displayMode!=molmil.displayMode_ChainSurfaceCG){if(!t.twoDcache||this.reInitChains){molmil.prepare2DRepr(t,this.modelId||0)}h+=t.molecules.length}}this.reInitChains=false;var d=molmil.configBox.QLV_SETTINGS[G.QLV].SPHERE_TESS_LV;var D=molmil.configBox.QLV_SETTINGS[G.QLV].CB_NOI;var x=molmil.configBox.QLV_SETTINGS[G.QLV].CB_NOVPR;var w=l.length*(6*Math.pow(4,d+1));w+=C.length*(d+1)*4*2;w+=h*D*x;if(w>10000000){d-=1}if(w>30000000){d-=1}if(w>100000000){d-=1}if(w<250000&&d<3){d+=1}d=this.detail_lv=Math.max(d+g,0);this.noi=molmil.configBox.QLV_SETTINGS[this.detail_lv].CB_NOI;this.novpr=molmil.configBox.QLV_SETTINGS[this.detail_lv].CB_NOVPR;var o=this.buffer1,j=this.buffer2;var w=0,n=0;var i=this.getSphere(1,d);w+=(i.vertices.length/3)*l.length;n+=i.indices.length*l.length;var z=this.getCylinder(d);w+=(z.vertices.length/3)*s;n+=z.indices.length*s;o.vertexBuffer=new Float32Array(w*8);o.vertexBuffer8=new Uint8Array(o.vertexBuffer.buffer);o.indexBuffer=new Uint32Array(n);j.vertexBuffer=new Float32Array(p.length*5);j.vertexBuffer8=new Uint8Array(j.vertexBuffer.buffer);j.indexBuffer=new Uint32Array(q.length*2)};molmil.geometry.initCartoon=function(E){var G,A,H,B=0,n=0,d,f=0,w=this.cartoonChains=[],J,I=this.nowps=[];var s=this.noi;var q=this.novpr;if(this.dome[2]!=this.detail_lv){var j=this.dome=[molmil.buildOctaDome(molmil.configBox.QLV_SETTINGS[this.detail_lv].CB_DOME_TESS_LV,0),molmil.buildOctaDome(molmil.configBox.QLV_SETTINGS[this.detail_lv].CB_DOME_TESS_LV,1),this.detail_lv];var l=mat4.create();mat4.rotateZ(l,l,(45*Math.PI)/180);for(var D=0;D<this.dome[0].vertices.length;D++){vec3.transformMat4(this.dome[0].vertices[D],this.dome[0].vertices[D],l);vec3.transformMat4(this.dome[1].vertices[D],this.dome[1].vertices[D],l)}var C=this.ringTemplate=[];var h=q,o=0,K=2/h,u,t,z,F;for(z=0;z<h;z++){u=Math.cos(o*Math.PI);t=Math.sin(o*Math.PI);C.push([u,t,0]);o+=K}this.squareVertices=[[-1,1,0],[1,1,0],[1,-1,0],[-1,-1,0],[-1,1,0]];this.squareVerticesN=[[-1,0,0],[0,1,0],[1,0,0],[0,-1,0],[-1,0,0]]}else{var j=this.dome}for(G=0;G<E.length;G++){A=E[G];if(A.displayMode<2||A.displayMode==molmil.displayMode_ChainSurfaceCG){continue}J=0;w.push(A);for(H=0;H<A.twoDcache.length;H++){d=A.twoDcache[H];if(A.displayMode>2&&d.sndStruc==2){if(!d.isFirst){B+=q;n+=q*2}B+=4+(d.molecules.length*8*(s+1))+8+q;n+=2+(d.molecules.length*8*(s+1))+(q*2);if(!d.isLast){B+=q}J+=d.molecules.length*(s+1);if(d.isLast){J-=s}}else{if(d.isFirst){B+=j[0].vertices.length;n+=j[0].faces.length-(q*2)}if(d.isLast){B+=j[0].vertices.length+q;n+=j[0].faces.length+(q*2)}B+=d.molecules.length*q*(s+1);n+=d.molecules.length*q*2*(s+1);J+=d.molecules.length*(s+1);if(d.isLast){J-=s;B-=q*(s+1);n-=q*2*(s+1)}}}I.push(J)}var g=this.buffer3;g.vertexBuffer=new Float32Array(B*8);g.vertexBuffer8=new Uint8Array(g.vertexBuffer.buffer);g.indexBuffer=new Uint32Array(n*3)};molmil.geometry.generateAtoms=function(){var d=this.atoms2draw,t=molmil.configBox.vdwR,c,i,q,s,j;vBuffer=this.buffer1.vertexBuffer,iBuffer=this.buffer1.indexBuffer,vP=this.buffer1.vP,iP=this.buffer1.iP,detail_lv=this.detail_lv,vBuffer8=this.buffer1.vertexBuffer8,vP8=vP*4;var f=vP/8;var h=this.modelId||0;var o,n,l;i=this.getSphere(1.7,detail_lv);var g=i.vertices.length/3;for(q=0;q<d.length;q++){if(d[q].displayMode==1){c=molmil_dep.getKeyFromObject(t,d[q].element,t.DUMMY)}else{if(d[q].displayMode==2){c=0.33}else{c=0.15}}i=this.getSphere(c,detail_lv);for(s=0;s<i.indices.length;s++,iP++){iBuffer[iP]=i.indices[s]+f}o=d[q].chain.modelsXYZ[h][d[q].xyz];n=d[q].chain.modelsXYZ[h][d[q].xyz+1];l=d[q].chain.modelsXYZ[h][d[q].xyz+2];j=d[q].rgba;for(s=0;s<i.vertices.length;s+=3,vP8+=32){vBuffer[vP++]=i.vertices[s]+o;vBuffer[vP++]=i.vertices[s+1]+n;vBuffer[vP++]=i.vertices[s+2]+l;vBuffer[vP++]=i.normals[s];vBuffer[vP++]=i.normals[s+1];vBuffer[vP++]=i.normals[s+2];vBuffer8[vP8+24]=j[0];vBuffer8[vP8+25]=j[1];vBuffer8[vP8+26]=j[2];vBuffer8[vP8+27]=j[3];vP++;vBuffer[vP++]=d[q].AID}f+=g}this.buffer1.vP=vP;this.buffer1.iP=iP};molmil.geometry.generateBonds=function(){var P=this.getCylinder(this.detail_lv);var f=this.modelId||0;var S=this.bonds2draw,g=this.buffer1.vertexBuffer,s=this.buffer1.indexBuffer,D=this.buffer1.vP,c=this.buffer1.iP,d=this.detail_lv,n=this.buffer1.vertexBuffer8,q=D*4;var l=P.vertices.length/3;var G,R,Q,N,j=[0,0,0],h=[0,0,0],I=[0,0,0];var H=D/8,A,u,t,K,i,C,J,o;var F=mat4.create();var M=[0,0,0,0],T=[0,0,0,0],E,B,w,L,O;for(b=0;b<S.length;b++){J=S[b][2]==2?4:2;A=S[b][0].chain.modelsXYZ[f][S[b][0].xyz];u=S[b][0].chain.modelsXYZ[f][S[b][0].xyz+1];t=S[b][0].chain.modelsXYZ[f][S[b][0].xyz+2];K=S[b][1].chain.modelsXYZ[f][S[b][1].xyz];i=S[b][1].chain.modelsXYZ[f][S[b][1].xyz+1];C=S[b][1].chain.modelsXYZ[f][S[b][1].xyz+2];E=A-K;B=u-i;w=t-C;L=Math.sqrt((E*E)+(B*B)+(w*w));E/=L;B/=L;w/=L;O=Math.acos(-w);mat4.identity(F);mat4.rotate(F,F,O,[B,-E,0]);G=0.15;R=0;Q=0;N=0;if(S[b][2]==2){G=0.075;R=-0.075}o=S[b][0].rgba;for(v=0;v<P.indices.length;v++,c++){s[c]=P.indices[v]+H}for(v=0;v<P.vertices.length;v+=3,q+=32){vec3.transformMat4(M,[(P.vertices[v]*G)+R,(P.vertices[v+1]*G)+Q,(P.vertices[v+2]+N)*L],F);vec3.transformMat4(T,[P.normals[v],P.normals[v+1],P.normals[v+2]],F);g[D++]=M[0]+A;g[D++]=M[1]+u;g[D++]=M[2]+t;g[D++]=T[0];g[D++]=T[1];g[D++]=T[2];n[q+24]=o[0];n[q+25]=o[1];n[q+26]=o[2];n[q+27]=o[3];D++;g[D++]=0}H+=l;N+=0.5;o=S[b][1].rgba;for(v=0;v<P.indices.length;v++,c++){s[c]=P.indices[v]+H}for(v=0;v<P.vertices.length;v+=3,q+=32){vec3.transformMat4(M,[(P.vertices[v]*G)+R,(P.vertices[v+1]*G)+Q,(P.vertices[v+2]+N)*L],F);vec3.transformMat4(T,[P.normals[v],P.normals[v+1],P.normals[v+2]],F);g[D++]=M[0]+A;g[D++]=M[1]+u;g[D++]=M[2]+t;g[D++]=T[0];g[D++]=T[1];g[D++]=T[2];n[q+24]=o[0];n[q+25]=o[1];n[q+26]=o[2];n[q+27]=o[3];D++;g[D++]=0}H+=l;if(S[b][2]==2){G=0.075;R=0.075;N=0;o=S[b][0].rgba;for(v=0;v<P.indices.length;v++,c++){s[c]=P.indices[v]+H}for(v=0;v<P.vertices.length;v+=3,q+=32){vec3.transformMat4(M,[(P.vertices[v]*G)+R,(P.vertices[v+1]*G)+Q,(P.vertices[v+2]+N)*L],F);vec3.transformMat4(T,[P.normals[v],P.normals[v+1],P.normals[v+2]],F);g[D++]=M[0]+A;g[D++]=M[1]+u;g[D++]=M[2]+t;g[D++]=T[0];g[D++]=T[1];g[D++]=T[2];n[q+24]=o[0];n[q+25]=o[1];n[q+26]=o[2];n[q+27]=o[3];D++;g[D++]=0}H+=l;N+=0.5;o=S[b][1].rgba;for(v=0;v<P.indices.length;v++,c++){s[c]=P.indices[v]+H}for(v=0;v<P.vertices.length;v+=3,q+=32){vec3.transformMat4(M,[(P.vertices[v]*G)+R,(P.vertices[v+1]*G)+Q,(P.vertices[v+2]+N)*L],F);vec3.transformMat4(T,[P.normals[v],P.normals[v+1],P.normals[v+2]],F);g[D++]=M[0]+A;g[D++]=M[1]+u;g[D++]=M[2]+t;g[D++]=T[0];g[D++]=T[1];g[D++]=T[2];n[q+24]=o[0];n[q+25]=o[1];n[q+26]=o[2];n[q+27]=o[3];D++;g[D++]=0}H+=l}}this.buffer1.vP=D;this.buffer1.iP=c};molmil.geometry.generateWireframe=function(){var i=this.wfatoms2draw,o=this.lines2draw,s,j=this.buffer2.vertexBuffer,n=this.buffer2.indexBuffer,l=this.buffer2.vP,u=this.buffer2.iP,t=this.buffer2.vertexBuffer8,h=l*4;var g=0.5;var c=l/5;var f={};var d=this.modelId||0;for(var s=0;s<i.length;s++,c++,h+=20){f[i[s].AID]=c;j[l++]=i[s].chain.modelsXYZ[d][i[s].xyz];j[l++]=i[s].chain.modelsXYZ[d][i[s].xyz+1];j[l++]=i[s].chain.modelsXYZ[d][i[s].xyz+2];t[h+12]=i[s].rgba[0];t[h+13]=i[s].rgba[1];t[h+14]=i[s].rgba[2];t[h+16]=i[s].rgba[3];l++;j[l++]=i[s].AID}for(var q=0;q<o.length;q++){n[u++]=f[o[q][0].AID];n[u++]=f[o[q][1].AID]}this.buffer2.vP=l;this.buffer2.iP=u};molmil.geometry.generateSurfaces=function(o){var t,j,d=[],w=0,f=0;for(t=0;t<o.length;t++){if(o[t].displayMode!=molmil.displayMode_ChainSurfaceCG){continue}j=molmil.coarseSurface(o[t],7.5,7.5*0.75);j.rgba=o[t].rgba;d.push(j);w+=j.vertices.length;f+=j.faces.length}var p=new Float32Array(w*8);var y=new Uint8Array(p.buffer);var x=new Uint32Array(f*3);var g=0,q=0,z,h,l=0,n=0;for(z=0;z<d.length;z++){j=d[z];h=j.rgba;for(t=0;t<j.vertices.length;t++,q+=32){p[g++]=j.vertices[t][0];p[g++]=j.vertices[t][1];p[g++]=j.vertices[t][2];p[g++]=j.normals[t][0];p[g++]=j.normals[t][1];p[g++]=j.normals[t][2];y[q+24]=h[0];y[q+25]=h[1];y[q+26]=h[2];y[q+27]=h[3];g++;g++}for(t=0;t<j.faces.length;t++){x[n++]=j.faces[t][0]+l;x[n++]=j.faces[t][1]+l;x[n++]=j.faces[t][2]+l}l+=j.vertices.length}var u=this.buffer4;u.vertexBuffer=p;u.vertexBuffer8=y;u.indexBuffer=x};molmil.geometry.generateCartoon=function(){var D=this.cartoonChains,H,K,B,s,A,g,y,h,j,l,C,d,E,n,w=0,L,z,x=[0,0,0],J=0.0001,q;var p=this.noi;var o=this.novpr;var I,f,G,u;var F=[];for(C=0;C<p+1;C++){F.push(C/(p+1))}for(H=0;H<D.length;H++){I=this.nowps[H];f=0;A=[],g=[],y=[],h=new Array(I),j=new Float32Array(I);chain=D[H];s=[];BNs=[];q=[];if(chain.displayMode==0){continue}for(K=0;K<chain.twoDcache.length;K++){q.push(s.length);currentBlock=chain.twoDcache[K];for(B=0;B<currentBlock.molecules.length-1;B++){molmil.hermiteInterpolate(currentBlock.xyz[B],currentBlock.xyz[B+1],currentBlock.tangents[B],currentBlock.tangents[B+1],p,s,A);for(C=0;C<p+1;C++){h[f]=currentBlock.molecules[B].rgba;j[f]=currentBlock.molecules[B].CA.AID;f++}}if(!currentBlock.isLast){molmil.hermiteInterpolate(currentBlock.xyz[B],chain.twoDcache[K+1].xyz[0],currentBlock.tangents[B],currentBlock.tangents[B+1],p,s,A);for(C=0;C<p+1;C++){h[f]=currentBlock.molecules[B].rgba;j[f]=currentBlock.molecules[B].CA.AID;f++}}else{s.push([currentBlock.xyz[B][0],currentBlock.xyz[B][1],currentBlock.xyz[B][2]]);if(A.length){A.push(A[f-1])}else{A.push([1,0,0])}h[f]=currentBlock.molecules[B].rgba;j[f]=currentBlock.molecules[B].CA.AID;f++}}q.push(s.length);for(K=0,w=0;K<chain.twoDcache.length;K++){currentBlock=chain.twoDcache[K];if(chain.displayMode>2&&(currentBlock.sndStruc==2||currentBlock.sndStruc==3)){l=null;if(currentBlock.sndStruc==2){l=currentBlock.normals;G=currentBlock.molecules.length-(currentBlock.isLast?1:0);for(B=0;B<G;B++){for(C=0;C<p+1;C++,w++){d=A[w];n=vec3.lerp([0,0,0],l[B],l[B+1],F[C]);vec3.normalize(n,n);vec3.scaleAndAdd(n,n,d,-vec3.dot(n,d)/vec3.dot(d,d));vec3.normalize(n,n);y.push(n);E=vec3.cross([0,0,0],n,d);vec3.normalize(E,E);vec3.negate(E,E);g.push(E)}}if(G!=currentBlock.molecules.length){d=A[w];n=vec3.lerp([0,0,0],l[B],l[B+1],F[C]);vec3.normalize(n,n);vec3.scaleAndAdd(n,n,d,-vec3.dot(n,d)/vec3.dot(d,d));vec3.normalize(n,n);y.push(n);E=vec3.cross([0,0,0],n,d);vec3.normalize(E,E);vec3.negate(E,E);g.push(E);w++}}else{if(currentBlock.sndStruc==3){l=currentBlock.binormals;if(!currentBlock.isFirst&&!currentBlock.Nresume&&u){vec3.cross(x,A[w-1],A[w]);if(vec3.length(x)>J){vec3.normalize(x,x);theta=Math.acos(Math.max(-1,Math.min(1,vec3.dot(A[w-1],A[w]))));mat4.rotate(u,identityMatrix,theta,x);vec3.transformMat4(L,L,u)}vec3.cross(z,A[w],L);l[0]=[z[0],z[1],z[2]];if(vec3.dot(l[0],l[1])<0){G=currentBlock;C=1;while(true){for(B=C;B<G.molecules.length;B++){vec3.negate(G.binormals[B],G.binormals[B])}G.invertedBinormals=!G.invertedBinormals;G=G.nextBlock;C=0;if(!G){break}}}}G=currentBlock.molecules.length-(currentBlock.isLast?1:0);for(B=0;B<G;B++){for(C=0;C<p+1;C++,w++){d=A[w];E=vec3.lerp([0,0,0],l[B],l[B+1],F[C]);vec3.normalize(E,E);vec3.scaleAndAdd(E,E,d,-vec3.dot(E,d)/vec3.dot(d,d));vec3.normalize(E,E);g.push(E);n=vec3.cross([0,0,0],E,d);vec3.normalize(n,n);y.push(n)}}if(G!=currentBlock.molecules.length){d=A[w];E=[l[B+1][0],l[B+1][1],l[B+1][2]];vec3.normalize(E,E);vec3.scaleAndAdd(E,E,d,-vec3.dot(E,d)/vec3.dot(d,d));vec3.normalize(E,E);g.push(E);n=vec3.cross([0,0,0],E,d);vec3.normalize(n,n);y.push(n);w++}}}}else{w=y.length;u=mat4.create(),identityMatrix=mat4.create();if(w==0){smallest=Number.MAX_VALUE;if(A[0][0]<=smallest){smallest=A[0][0];L=[1,0,0]}if(A[0][1]<=smallest){smallest=A[0][1];L=[0,1,0]}if(A[0][2]<=smallest){smallest=A[0][2];L=[0,0,1]}vec3.cross(x,A[0],L);vec3.normalize(x,x);vec3.cross(L,A[0],x);vec3.cross(z=[0,0,0],A[0],L);y.push([L[0],L[1],L[2]]);g.push([z[0],z[1],z[2]]);w++}else{L=[y[w-1][0],y[w-1][1],y[w-1][2]];z=[g[w-1][0],g[w-1][1],g[w-1][2]]}for(;w<q[K+1];w++){vec3.cross(x,A[w-1],A[w]);if(vec3.length(x)>J){vec3.normalize(x,x);theta=Math.acos(Math.max(-1,Math.min(1,vec3.dot(A[w-1],A[w]))));mat4.rotate(u,identityMatrix,theta,x);vec3.transformMat4(L,L,u)}vec3.cross(z,A[w],L);y.push([L[0],L[1],L[2]]);g.push([z[0],z[1],z[2]])}}}y.push(y[y.length-1]);g.push(g[g.length-1]);w=0;for(K=0;K<chain.twoDcache.length;K++){currentBlock=chain.twoDcache[K];if(chain.displayMode>2){if(currentBlock.sndStruc==2){w=this.buildSheet(q[K],q[K+1],s,A,y,g,h,j,currentBlock.isFirst,currentBlock.isLast);continue}else{if(currentBlock.sndStruc==3){if(currentBlock.isFirst){this.buildLoopNcap(q[K],s,A,y,g,h,j);w++;q[K]+=1}w=this.buildHelix(q[K],q[K+1],s,A,y,g,h,j,currentBlock);if(currentBlock.isLast){this.buildLoopCcap(q[K+1]-1,s,A,y,g,h,j)}continue}}}if(currentBlock.isFirst){this.buildLoopNcap(q[K],s,A,y,g,h,j);w++;q[K]+=1}w=this.buildLoop(q[K],q[K+1],s,A,y,g,h,j);if(currentBlock.isLast){this.buildLoopCcap(q[K+1]-1,s,A,y,g,h,j)}}}};molmil.geometry.buildLoopNcap=function(z,s,l,w,C,o,q){var n=this.dome[0],j=this.radius,I,H=this.ringTemplate;var g=this.buffer3.vertexBuffer,x=this.buffer3.indexBuffer,y=this.buffer3.vP,f=this.buffer3.iP,G,F,E,S,Q,O,M,L,J,d,c,R,K,A,h=this.buffer3.vertexBuffer8,u=y*4;var D=y*0.125;G=s[z][0],F=s[z][1],E=s[z][2],d=l[z][0],c=l[z][1],R=l[z][2],S=w[z][0],Q=w[z][1],O=w[z][2],M=C[z][0],L=C[z][1],J=C[z][2],K=o[z],A=q[z];for(I=0;I<n.vertices.length;I++,u+=32){g[y++]=j*n.vertices[I][0]*S+j*n.vertices[I][1]*M+j*n.vertices[I][2]*d+G;g[y++]=j*n.vertices[I][0]*Q+j*n.vertices[I][1]*L+j*n.vertices[I][2]*c+F;g[y++]=j*n.vertices[I][0]*O+j*n.vertices[I][1]*J+j*n.vertices[I][2]*R+E;g[y++]=n.vertices[I][0]*S+n.vertices[I][1]*M+n.vertices[I][2]*d;g[y++]=n.vertices[I][0]*Q+n.vertices[I][1]*L+n.vertices[I][2]*c;g[y++]=n.vertices[I][0]*O+n.vertices[I][1]*J+n.vertices[I][2]*R;h[u+24]=K[0];h[u+25]=K[1];h[u+26]=K[2];h[u+27]=K[3];y++;g[y++]=q[z]}for(I=0;I<n.faces.length;I++){x[f++]=n.faces[I][0]+D;x[f++]=n.faces[I][1]+D;x[f++]=n.faces[I][2]+D}for(I=0;I<H.length;I++,u+=32){g[y++]=j*H[I][0]*S+j*H[I][1]*M+G;g[y++]=j*H[I][0]*Q+j*H[I][1]*L+F;g[y++]=j*H[I][0]*O+j*H[I][1]*J+E;g[y++]=H[I][0]*S+H[I][1]*M;g[y++]=H[I][0]*Q+H[I][1]*L;g[y++]=H[I][0]*O+H[I][1]*J;h[u+24]=K[0];h[u+25]=K[1];h[u+26]=K[2];h[u+27]=K[3];y++;g[y++]=q[z]}this.buffer3.vP=y;this.buffer3.iP=f};molmil.geometry.buildLoopCcap=function(z,s,l,w,C,o,q){var n=this.dome[1],j=this.radius,I,H=this.ringTemplate;var g=this.buffer3.vertexBuffer,x=this.buffer3.indexBuffer,y=this.buffer3.vP,f=this.buffer3.iP,G,F,E,S,Q,O,M,L,J,d,c,R,K,A,h=this.buffer3.vertexBuffer8,u=y*4;var D=y*0.125;G=s[z][0],F=s[z][1],E=s[z][2],d=l[z][0],c=l[z][1],R=l[z][2],S=w[z][0],Q=w[z][1],O=w[z][2],M=C[z][0],L=C[z][1],J=C[z][2],K=o[z],A=q[z];for(I=0;I<n.vertices.length;I++,u+=32){g[y++]=j*n.vertices[I][0]*S+j*n.vertices[I][1]*M+j*n.vertices[I][2]*d+G;g[y++]=j*n.vertices[I][0]*Q+j*n.vertices[I][1]*L+j*n.vertices[I][2]*c+F;g[y++]=j*n.vertices[I][0]*O+j*n.vertices[I][1]*J+j*n.vertices[I][2]*R+E;g[y++]=n.vertices[I][0]*S+n.vertices[I][1]*M+n.vertices[I][2]*d;g[y++]=n.vertices[I][0]*Q+n.vertices[I][1]*L+n.vertices[I][2]*c;g[y++]=n.vertices[I][0]*O+n.vertices[I][1]*J+n.vertices[I][2]*R;h[u+24]=K[0];h[u+25]=K[1];h[u+26]=K[2];h[u+27]=K[3];y++;g[y++]=A}for(I=0;I<n.faces.length;I++){x[f++]=n.faces[I][0]+D;x[f++]=n.faces[I][1]+D;x[f++]=n.faces[I][2]+D}this.buffer3.vP=y;this.buffer3.iP=f};molmil.geometry.buildLoop=function(C,A,s,l,w,E,o,q){var n=this.dome[0],j=this.radius,K,y=this.novpr;var J=this.ringTemplate,j=this.radius,I,H,G,W,U,S,R,Q,M,f,c,V,O,D;var g=this.buffer3.vertexBuffer,x=this.buffer3.indexBuffer,z=this.buffer3.vP,d=this.buffer3.iP,h=this.buffer3.vertexBuffer8,u=z*4;var F=z*0.125;var L=F-y;for(C;C<A;C++){I=s[C][0],H=s[C][1],G=s[C][2],f=l[C][0],c=l[C][1],V=l[C][2],W=w[C][0],U=w[C][1],S=w[C][2],R=E[C][0],Q=E[C][1],M=E[C][2],O=o[C],D=q[C];for(K=0;K<J.length;K++,u+=32){g[z++]=j*J[K][0]*W+j*J[K][1]*R+I;g[z++]=j*J[K][0]*U+j*J[K][1]*Q+H;g[z++]=j*J[K][0]*S+j*J[K][1]*M+G;g[z++]=J[K][0]*W+J[K][1]*R;g[z++]=J[K][0]*U+J[K][1]*Q;g[z++]=J[K][0]*S+J[K][1]*M;h[u+24]=O[0];h[u+25]=O[1];h[u+26]=O[2];h[u+27]=O[3];z++;g[z++]=D}for(K=0;K<(y*2)-2;K+=2,F+=1,L+=1){x[d++]=F;x[d++]=L;x[d++]=L+1;x[d++]=L+1;x[d++]=F+1;x[d++]=F}x[d++]=F;x[d++]=L;x[d++]=L-(y-1);x[d++]=L-(y-1);x[d++]=F-(y-1);x[d++]=F;F++;L++}this.buffer3.vP=z;this.buffer3.iP=d;return C};molmil.geometry.buildHelix=function(X,ai,l,j,q,E,ad,K,V){var L=this.dome[0],Y=this.radius,af,d=this.novpr;var M=this.ringTemplate,Y=this.radius,R,Q,O,C,A,z,u,s,o,G,F,D,g,c;var x=this.buffer3.vertexBuffer,w=this.buffer3.indexBuffer,U=this.buffer3.vP,ag=this.buffer3.iP,y=this.buffer3.vertexBuffer8,S=U*4;var ab=U*0.125;var h=ab-d;var ae,W,f;var H=V.invertedBinormals,J=V.Nresume,I=V.Cresume;var aa=[0,0],ah=this.noi,Z=X,ac=J?ah:0;for(X;X<ai;X++){R=l[X][0],Q=l[X][1],O=l[X][2],G=j[X][0],F=j[X][1],D=j[X][2],C=q[X][0],A=q[X][1],z=q[X][2],u=E[X][0],s=E[X][1],o=E[X][2],g=ad[X],c=K[X];if(!J&&X<Z+ah){ae=(ac/ah);ac++}else{if(!I&&X>ai-ah-2){ae=(ac/(ah));ac--}else{ae=1}}W=(5*ae)+1;f=1/W;for(af=0;af<M.length;af++,S+=32){x[U++]=Y*M[af][0]*C+W*Y*M[af][1]*u+R;x[U++]=Y*M[af][0]*A+W*Y*M[af][1]*s+Q;x[U++]=Y*M[af][0]*z+W*Y*M[af][1]*o+O;aa[0]=M[af][0];aa[1]=f*M[af][1];vec2.normalize(aa,aa);x[U++]=aa[0]*C+aa[1]*u;x[U++]=aa[0]*A+aa[1]*s;x[U++]=aa[0]*z+aa[1]*o;if(ae>0.5&&((H&&x[U-3]*C+x[U-2]*A+x[U-1]*z<-0.01)||(!H&&x[U-3]*C+x[U-2]*A+x[U-1]*z>0.01))){y[S+24]=255;y[S+25]=255;y[S+26]=255;y[S+27]=255}else{y[S+24]=g[0];y[S+25]=g[1];y[S+26]=g[2];y[S+27]=g[3]}U++;x[U++]=c}for(af=0;af<(d*2)-2;af+=2,ab+=1,h+=1){w[ag++]=ab;w[ag++]=h;w[ag++]=h+1;w[ag++]=h+1;w[ag++]=ab+1;w[ag++]=ab}w[ag++]=ab;w[ag++]=h;w[ag++]=h-(d-1);w[ag++]=h-(d-1);w[ag++]=ab-(d-1);w[ag++]=ab;ab++;h++}this.buffer3.vP=U;this.buffer3.iP=ag;return X};molmil.geometry.buildSheet=function(Z,aj,q,l,u,H,ad,L,O,ai){var M=this.dome[0],aa=this.radius,ae,d=this.novpr;var Q=this.ringTemplate,aa=this.radius,U,S,R,F,E,D,y,x,s,J,I,G,f,c;var A=this.buffer3.vertexBuffer,z=this.buffer3.indexBuffer,W=this.buffer3.vP,af=this.buffer3.iP,C=this.buffer3.vertexBuffer8,V=W*4;var ab=W*0.125;var j=ab-d;var Y=this.squareVertices,ah=this.noi,K=this.squareVerticesN;var ag=this.sheetHeight,X=ag*8;if(!O){U=(q[Z][0]*0.75)+(q[Z+1][0]*0.25),S=(q[Z][1]*0.75)+(q[Z][1]*0.25),R=(q[Z][2]*0.75)+(q[Z][2]*0.25),J=l[Z-1][0],I=l[Z-1][1],G=l[Z-1][2],F=u[Z-1][0],E=u[Z-1][1],D=u[Z-1][2],y=H[Z-1][0],x=H[Z-1][1],s=H[Z-1][2],f=ad[Z-1],c=L[Z];for(ae=0;ae<Q.length;ae++,V+=32){A[W++]=ag*0.5*Q[ae][0]*F+ag*0.5*Q[ae][1]*y+U;A[W++]=ag*0.5*Q[ae][0]*E+ag*0.5*Q[ae][1]*x+S;A[W++]=ag*0.5*Q[ae][0]*D+ag*0.5*Q[ae][1]*s+R;A[W++]=((Q[ae][0]*F+Q[ae][1]*y)+J)*0.5;A[W++]=((Q[ae][0]*E+Q[ae][1]*x)+I)*0.5;A[W++]=((Q[ae][0]*D+Q[ae][1]*s)+G)*0.5;C[V+24]=f[0];C[V+25]=f[1];C[V+26]=f[2];C[V+27]=f[3];W++;A[W++]=L[Z-1]}for(ae=0;ae<(d*2)-2;ae+=2,ab+=1,j+=1){z[af++]=ab;z[af++]=j;z[af++]=j+1;z[af++]=j+1;z[af++]=ab+1;z[af++]=ab}z[af++]=ab;z[af++]=j;z[af++]=j-(d-1);z[af++]=j-(d-1);z[af++]=ab-(d-1);z[af++]=ab;ab++;j++}U=q[Z][0],S=q[Z][1],R=q[Z][2],J=l[Z][0],I=l[Z][1],G=l[Z][2],F=u[Z][0],E=u[Z][1],D=u[Z][2],y=H[Z][0],x=H[Z][1],s=H[Z][2],f=ad[Z],c=L[Z];for(ae=0;ae<4;ae++,V+=32){A[W++]=ag*Y[ae][0]*F+X*Y[ae][1]*y+U;A[W++]=ag*Y[ae][0]*E+X*Y[ae][1]*x+S;A[W++]=ag*Y[ae][0]*D+X*Y[ae][1]*s+R;A[W++]=-J;A[W++]=-I;A[W++]=-G;C[V+24]=255;C[V+25]=255;C[V+26]=255;C[V+27]=255;W++;A[W++]=c}z[af++]=ab;z[af++]=ab+1;z[af++]=ab+2;z[af++]=ab;z[af++]=ab+2;z[af++]=ab+3;ab+=4;var o=Math.ceil(ah/1.5);var g=(ag*12)/o;o=aj-o;var ac=0;for(Z;Z<o;Z++,ac++){U=q[Z][0],S=q[Z][1],R=q[Z][2],J=l[Z][0],I=l[Z][1],G=l[Z][2],F=u[Z][0],E=u[Z][1],D=u[Z][2],y=H[Z][0],x=H[Z][1],s=H[Z][2],f=ad[Z],c=L[Z];for(ae=0;ae<4;ae++,V+=32){A[W++]=ag*Y[ae][0]*F+X*Y[ae][1]*y+U;A[W++]=ag*Y[ae][0]*E+X*Y[ae][1]*x+S;A[W++]=ag*Y[ae][0]*D+X*Y[ae][1]*s+R;A[W++]=K[ae][0]*F+K[ae][1]*y;A[W++]=K[ae][0]*E+K[ae][1]*x;A[W++]=K[ae][0]*D+K[ae][1]*s;if(ae==1||ae==3){C[V+24]=255;C[V+25]=255;C[V+26]=255;C[V+27]=255}else{C[V+24]=f[0];C[V+25]=f[1];C[V+26]=f[2];C[V+27]=f[3]}W++;A[W++]=c;V+=32;A[W++]=ag*Y[ae][0]*F+X*Y[ae][1]*y+U;A[W++]=ag*Y[ae][0]*E+X*Y[ae][1]*x+S;A[W++]=ag*Y[ae][0]*D+X*Y[ae][1]*s+R;A[W++]=K[ae+1][0]*F+K[ae+1][1]*y;A[W++]=K[ae+1][0]*E+K[ae+1][1]*x;A[W++]=K[ae+1][0]*D+K[ae+1][1]*s;if(ae==0||ae==2){C[V+24]=255;C[V+25]=255;C[V+26]=255;C[V+27]=255}else{C[V+24]=f[0];C[V+25]=f[1];C[V+26]=f[2];C[V+27]=f[3]}W++;A[W++]=c}if(ac>0){z[af++]=ab-8;z[af++]=ab-1;z[af++]=ab+7;z[af++]=ab-8;z[af++]=ab+7;z[af++]=ab+0;z[af++]=ab-7;z[af++]=ab+1;z[af++]=ab+2;z[af++]=ab-7;z[af++]=ab+2;z[af++]=ab-6;z[af++]=ab-5;z[af++]=ab+3;z[af++]=ab+4;z[af++]=ab-5;z[af++]=ab+4;z[af++]=ab-4;z[af++]=ab-2;z[af++]=ab-3;z[af++]=ab+5;z[af++]=ab-2;z[af++]=ab+5;z[af++]=ab+6}ab+=8}X=ag*12;Z--;for(;Z<aj;Z++,ac++){if(Z>=o){X-=g}U=q[Z][0],S=q[Z][1],R=q[Z][2],J=l[Z][0],I=l[Z][1],G=l[Z][2],F=u[Z][0],E=u[Z][1],D=u[Z][2],y=H[Z][0],x=H[Z][1],s=H[Z][2],f=ad[Z],c=L[Z];for(ae=0;ae<4;ae++,V+=32){A[W++]=ag*Y[ae][0]*F+X*Y[ae][1]*y+U;A[W++]=ag*Y[ae][0]*E+X*Y[ae][1]*x+S;A[W++]=ag*Y[ae][0]*D+X*Y[ae][1]*s+R;A[W++]=K[ae][0]*F+K[ae][1]*y;A[W++]=K[ae][0]*E+K[ae][1]*x;A[W++]=K[ae][0]*D+K[ae][1]*s;if(ae==1||ae==3){C[V+24]=255;C[V+25]=255;C[V+26]=255;C[V+27]=255}else{C[V+24]=f[0];C[V+25]=f[1];C[V+26]=f[2];C[V+27]=f[3]}W++;V+=32;A[W++]=c;A[W++]=ag*Y[ae][0]*F+X*Y[ae][1]*y+U;A[W++]=ag*Y[ae][0]*E+X*Y[ae][1]*x+S;A[W++]=ag*Y[ae][0]*D+X*Y[ae][1]*s+R;A[W++]=K[ae+1][0]*F+K[ae+1][1]*y;A[W++]=K[ae+1][0]*E+K[ae+1][1]*x;A[W++]=K[ae+1][0]*D+K[ae+1][1]*s;if(ae==0||ae==2){C[V+24]=255;C[V+25]=255;C[V+26]=255;C[V+27]=255}else{C[V+24]=f[0];C[V+25]=f[1];C[V+26]=f[2];C[V+27]=f[3]}W++;A[W++]=c}if(ac>0){z[af++]=ab-8;z[af++]=ab-1;z[af++]=ab+7;z[af++]=ab-8;z[af++]=ab+7;z[af++]=ab+0;z[af++]=ab-7;z[af++]=ab+1;z[af++]=ab+2;z[af++]=ab-7;z[af++]=ab+2;z[af++]=ab-6;z[af++]=ab-5;z[af++]=ab+3;z[af++]=ab+4;z[af++]=ab-5;z[af++]=ab+4;z[af++]=ab-4;z[af++]=ab-2;z[af++]=ab-3;z[af++]=ab+5;z[af++]=ab-2;z[af++]=ab+5;z[af++]=ab+6}ab+=8}if(!ai){J=l[Z][0],I=l[Z][1],G=l[Z][2],F=u[Z][0],E=u[Z][1],D=u[Z][2],y=H[Z][0],x=H[Z][1],s=H[Z][2],f=ad[Z],c=L[Z];for(ae=0;ae<Q.length;ae++,V+=32){A[W++]=U;A[W++]=S;A[W++]=R;A[W++]=-J;A[W++]=-I;A[W++]=-G;C[V+24]=f[0];C[V+25]=f[1];C[V+26]=f[2];C[V+27]=f[3];W++;A[W++]=L[Z]}ab+=Q.length;for(ae=0;ae<Q.length;ae++,V+=32){A[W++]=ag*Q[ae][0]*F+ag*Q[ae][1]*y+U;A[W++]=ag*Q[ae][0]*E+ag*Q[ae][1]*x+S;A[W++]=ag*Q[ae][0]*D+ag*Q[ae][1]*s+R;A[W++]=((Q[ae][0]*F+Q[ae][1]*y)-J)*0.5;A[W++]=((Q[ae][0]*E+Q[ae][1]*x)-I)*0.5;A[W++]=((Q[ae][0]*D+Q[ae][1]*s)-G)*0.5;C[V+24]=f[0];C[V+25]=f[1];C[V+26]=f[2];C[V+27]=f[3];W++;A[W++]=L[Z]}j=ab-d;for(ae=0;ae<(d*2)-2;ae+=2,ab+=1,j+=1){z[af++]=ab;z[af++]=j;z[af++]=j+1;z[af++]=j+1;z[af++]=ab+1;z[af++]=ab}z[af++]=ab;z[af++]=j;z[af++]=j-(d-1);z[af++]=j-(d-1);z[af++]=ab-(d-1);z[af++]=ab;ab++;j++}this.buffer3.vP=W;this.buffer3.iP=af;return Z};molmil.priestle_smoothing=function(l,h,i,j,g){var n,d=i-h,c=new Array(d),f=new Array(d);for(m=0;m<d;m++){c[m]=[0,0,0]}for(n=0;n<g;n++){for(m=1;m<d-1;m++){c[m][0]=(l[h+m-1][0]+l[h+m+1][0])*0.5;c[m][1]=(l[h+m-1][1]+l[h+m+1][1])*0.5;c[m][2]=(l[h+m-1][2]+l[h+m+1][2])*0.5;c[m][0]=(c[m][0]+l[h+m][0])*0.5;c[m][1]=(c[m][1]+l[h+m][1])*0.5;c[m][2]=(c[m][2]+l[h+m][2])*0.5}for(m=1;m<d-1;m++){if(!j.hasOwnProperty(m)){l[h+m][0]=c[m][0];l[h+m][1]=c[m][1];l[h+m][2]=c[m][2]}}}};molmil.prepare2DRepr=function(F,f){var z=32*Math.PI/180,y=-11*Math.PI/180,o=Math.cos(z),O=Math.sin(z),j=Math.cos(y),N=Math.sin(y),J=4.7,E=0.5,C=5.2,t,x=[0,0,0],B=[0,0,0],l=[0,0,0],i=[0,0,0],q=molmil.configBox.smoothFactor,I;if(F.molecules.length<2||F.isHet){return F.displayMode=0}var w=F.twoDcache=[],H,u,p,M,s=F.molecules.length,h,g,d,c,K,L=[],G,D,P;for(H=0;H<s;H++){if(!F.molecules[H].CA){continue}if(F.molecules[H].sndStruc!=u||F.molecules[H].previous==null){u=F.molecules[H].sndStruc;w.push(p={molecules:[],xyz:[],sndStruc:u})}p.molecules.push(F.molecules[H]);h=F.molecules[H].CA.xyz;g=[F.modelsXYZ[f][h],F.modelsXYZ[f][h+1],F.modelsXYZ[f][h+2]];p.xyz.push(g);L.push(g)}s=L.length;for(M=0,G=0;M<w.length;M++){p=w[M];if(p.molecules[0].xna){p.sndStruc=molmil.displayMode_XNA}p.isFirst=p.molecules[0].previous==null;p.isLast=p.molecules[p.molecules.length-1].next==null||p.molecules[p.molecules.length-1].next.name=="NME"||!p.molecules[p.molecules.length-1].next.CA;if(p.molecules.length<3){p.sndStruc=1}if(p.sndStruc!=3&&p.sndStruc!=4&&p.sndStruc!=molmil.displayMode_XNA){if(p.sndStruc==2){p.normals=[[]],K=null;for(H=1;H<p.molecules.length-1;H++){K=vec3.add([0,0,0],p.xyz[H-1],p.xyz[H+1]);K[0]/=2;K[1]/=2;K[2]/=2;vec3.subtract(K,p.xyz[H],K);vec3.normalize(K,K);if(H>1&&vec3.dot(p.normals[H-1],K)<0){vec3.negate(K,K)}p.normals.push(K)}if(K==null){if(!p.isFirst&&!p.isLast){h=w[M-1].xyz[w[M-1].xyz.length-1];g=p.xyz[0];d=w[M+1].xyz[0];K=vec3.add([0,0,0],h,d);K[0]/=2;K[1]/=2;K[2]/=2;vec3.subtract(K,g,K);vec3.normalize(K,K);l[0]=d[0]-g[0];l[1]=d[1]-g[1];l[2]=d[2]-g[2];vec3.normalize(l,l);vec3.cross(i,l,K);vec3.cross(K,i,l);p.normals.push(K)}else{K=[0,0,0];p.normals.push(K)}}else{p.normals.push(K)}while(p.normals.length<p.molecules.length){p.normals.push(K)}p.normals[0]=p.normals[1];p.normals[p.normals.length-1]=p.normals[p.normals.length-2];D=new Array(p.normals.length);for(h=0;h<2;h++){for(H=1;H<p.molecules.length-1;H++){D[H]=[p.normals[H-1][0]+p.normals[H][0]+p.normals[H+1][0],p.normals[H-1][1]+p.normals[H][1]+p.normals[H+1][1],p.normals[H-1][2]+p.normals[H][2]+p.normals[H+1][2]];vec3.normalize(D[H],D[H])}for(H=1;H<p.molecules.length-1;H++){p.normals[H]=D[H]}p.normals[0]=p.normals[1];p.normals[p.normals.length-1]=p.normals[p.normals.length-2]}for(H=0;H<p.molecules.length-1;H++){l[0]=p.xyz[H+1][0]-p.xyz[H][0];l[1]=p.xyz[H+1][1]-p.xyz[H][1];l[2]=p.xyz[H+1][2]-p.xyz[H][2];vec3.cross(i,l,p.normals[H]);vec3.cross(p.normals[H],i,l);vec3.normalize(p.normals[H],p.normals[H])}p.normals.push(p.normals[p.normals.length-1])}if(q>0){I={};for(H=0;H<p.molecules.length;H++){if(p.molecules[H].showSC){I[H+(p.isFirst?0:1)]=true}}if(!p.isLast&&w[M+1].molecules[0].showSC){I[p.molecules.length]=true}molmil.priestle_smoothing(L,G-(p.isFirst?0:1),G+p.molecules.length+(p.isLast?0:1),I,q)}}G+=p.molecules.length}for(M=0,G=0;M<w.length;M++){p=w[M];p.tangents=new Array(p.molecules.length+1);for(H=0;H<p.molecules.length+1;H++){p.tangents[H]=[0,0,0]}if((p.sndStruc==3||p.sndStruc==4)&&p.molecules.length<3){p.sndStruc=1}if(p.molecules[0].xna){t=C}else{t=J}if(p.sndStruc==molmil.displayMode_XNA){H=0;if(H+G<1){g=L[0];c=L[2]}else{if(H+G==s-1){g=L[H+G-1];c=L[H+G]}else{if(H+G<s-1){g=L[H+G-1];c=L[H+G+1]}}}l[0]=c[0]-g[0];l[1]=c[1]-g[1];l[2]=c[2]-g[2];vec3.normalize(l,l);p.tangents[0]=[l[0]*t,l[1]*t,l[2]*t];K=p.molecules.length-(M==w.length-1);for(H=1;H<K;H++){g=L[H+G-1];d=L[H+G];c=L[H+G+1];p.tangents[H][0]=c[0]-g[0];p.tangents[H][1]=c[1]-g[1];p.tangents[H][2]=c[2]-g[2];vec3.normalize(p.tangents[H],p.tangents[H]);p.tangents[H][0]*=t;p.tangents[H][1]*=t;p.tangents[H][2]*=t}if(H+G<1){g=L[0];c=L[2]}else{if(H+G==s-1){g=L[H+G-1];c=L[H+G]}else{if(H+G<s-1){g=L[H+G-1];c=L[H+G+1]}}}l[0]=c[0]-g[0];l[1]=c[1]-g[1];l[2]=c[2]-g[2];vec3.normalize(l,l);p.tangents[p.tangents.length-1]=[l[0]*t,l[1]*t,l[2]*t];if(K!=p.molecules.length&&p.molecules.length>2){p.tangents[p.tangents.length-2]=p.tangents[p.tangents.length-1]}}else{if(p.sndStruc==3||p.sndStruc==4){p.binormals=new Array(p.molecules.length+1);H=0;if(H+G<1){g=L[0];c=L[2]}else{if(H+G==s-1){g=L[H+G-1];c=L[H+G]}else{if(H+G<s-1){g=L[H+G-1];c=L[H+G+1]}}}l[0]=c[0]-g[0];l[1]=c[1]-g[1];l[2]=c[2]-g[2];vec3.normalize(l,l);p.tangents[0]=[l[0]*t,l[1]*t,l[2]*t];K=p.molecules.length-(M==w.length-1);for(H=1;H<K;H++){g=L[H+G-1];d=L[H+G];c=L[H+G+1];p.tangents[H][0]=c[0]-g[0];p.tangents[H][1]=c[1]-g[1];p.tangents[H][2]=c[2]-g[2];x[0]=c[0]-g[0];x[1]=c[1]-g[1];x[2]=c[2]-g[2];vec3.normalize(x,x);l[0]=d[0]-g[0];l[1]=d[1]-g[1];l[2]=d[2]-g[2];i[0]=c[0]-d[0];i[1]=c[1]-d[1];i[2]=c[2]-d[2];vec3.cross(B,l,i);vec3.normalize(B,B);l[0]=o*B[0];l[1]=o*B[1];l[2]=o*B[2];i[0]=O*x[0];i[1]=O*x[1];i[2]=O*x[2];p.binormals[H]=[l[0]+i[0],l[1]+i[1],l[2]+i[2]];l[0]=j*x[0];l[1]=j*x[1];l[2]=j*x[2];i[0]=N*B[0];i[1]=N*B[1];i[2]=N*B[2];p.tangents[H][0]=(l[0]+i[0])*t;p.tangents[H][1]=(l[1]+i[1])*t;p.tangents[H][2]=(l[2]+i[2])*t;vec3.cross(l,p.binormals[H],p.tangents[H]);vec3.cross(p.binormals[H],p.tangents[H],l);vec3.normalize(p.binormals[H],p.binormals[H])}if(H+G<1){g=L[0];c=L[2]}else{if(H+G==s-1){g=L[H+G-1];c=L[H+G]}else{if(H+G<s-1){g=L[H+G-1];c=L[H+G+1]}}}l[0]=c[0]-g[0];l[1]=c[1]-g[1];l[2]=c[2]-g[2];vec3.normalize(l,l);p.tangents[p.tangents.length-1]=[l[0]*t,l[1]*t,l[2]*t];if(K!=p.molecules.length){p.tangents[p.tangents.length-2]=p.tangents[p.tangents.length-1];l=p.binormals[p.binormals.length-3];p.binormals[p.binormals.length-2]=[-l[0],-l[1],-l[2]]}p.binormals[0]=p.binormals[1];p.binormals[p.binormals.length-1]=p.binormals[p.binormals.length-2]}else{P=p.sndStruc==5?144:60;if(L.length<3){if(L.length==1){p.tangents[0]=p.tangents[1]=[1,0,0]}else{p.tangents[0]=p.tangents[1]=p.tangents[2]=[L[1][0]-L[0][0],L[1][1]-L[0][1],L[1][2]-L[0][2]]}}else{for(H=0;H<p.molecules.length+1;H++){if(H+G<1){g=L[0];c=L[2]}else{if(H+G==s-1){g=L[H+G-1];c=L[H+G]}else{if(H+G<s-1){g=L[H+G-1];c=L[H+G+1]}}}l[0]=c[0]-g[0];l[1]=c[1]-g[1];l[2]=c[2]-g[2];if(l[0]*l[0]+l[1]*l[1]+l[2]*l[2]>P){p.tangents[H]=p.tangents[H>0?H-1:H+1]}else{p.tangents[H][0]=l[0]*E;p.tangents[H][1]=l[1]*E;p.tangents[H][2]=l[2]*E}}if(p.molecules[H-2].next==null&&H+G-3>-1){p.tangents[H-1][0]=L[H+G-2][0]-L[H+G-3][0];p.tangents[H-1][1]=L[H+G-2][1]-L[H+G-3][1];p.tangents[H-1][2]=L[H+G-2][2]-L[H+G-3][2]}}}}G+=p.molecules.length}var A;for(M=0;M<w.length;M++){p=w[M];if(p.sndStruc==3){K=p.molecules.length-(M==w.length-1?1:0);for(H=1;H<K;H++){if(vec3.dot(p.binormals[H-1],p.binormals[H])<0){A={molecules:[],xyz:[],tangents:[],binormals:[],sndStruc:3};p.nextBlock=A;p.Cresume=true;A.Nresume=true;A.invertedBinormals=!p.invertedBinormals;A.isLast=p.isLast;p.isLast=false;for(G=H;G<p.binormals.length;G++){vec3.negate(p.binormals[G],p.binormals[G])}A.molecules=p.molecules.slice(H);A.tangents=p.tangents.slice(H);A.binormals=p.binormals.slice(H);A.xyz=p.xyz.slice(H);p.molecules=p.molecules.splice(0,H);p.tangents=p.tangents.splice(0,H+1);p.binormals=p.binormals.splice(0,H+1);p.xyz=p.xyz.splice(0,H);if(p.molecules.length==1){p.invertedBinormals=!p.invertedBinormals}w.splice(M+1,0,A);break}}if(vec3.dot(p.binormals[H-1],p.binormals[H])<0){vec3.negate(p.binormals[H],p.binormals[H])}}}};molmil.render=function(c){this.canvas=null;this.reloadSettings();this.programs=[];this.clearCut=0;this.fogStart=0;this.camera=new molmil.glCamera();this.soup=c;this.modelViewMatrix=mat4.create();this.projectionMatrix=mat4.create();this.pitch=0;this.heading=0;this.TransX=0;this.TransY=0;this.TransZ=0;this.pitchAngle=0;this.headingAngle=0;this.TransB=[0.5,0.5,0];this.animationMode=false;this.framesDefinition=[];this.framesBuffer=[];this.textures={};this.FBOs={};this.shaders={};this.buffers={};this.gl=null;this.modelId=0};molmil.render.prototype.clear=function(){for(var c=0;c<this.programs.length;c++){this.gl.deleteBuffer(this.programs[c].vertexBuffer);this.gl.deleteBuffer(this.programs[c].indexBuffer)}this.programs=[];this.program1=this.program2=this.program3=this.program4=undefined};molmil.render.prototype.reloadSettings=function(){this.QLV=localStorage.getItem("molmil.settings_QLV");if(this.QLV==null){this.QLV=2;localStorage.setItem("molmil.settings_QLV",this.QLV)}else{this.QLV=parseInt(this.QLV)}if(this.gl){this.gl.clearColor.apply(this.gl,molmil.configBox.BGCOLOR)}};molmil.render.prototype.selectDefaultContext=function(){this.gl=this.defaultContext};molmil.render.prototype.selectDataContext=function(){if(!this.dataContext){this.dataContext=this.canvas.getContext("webgl",{preserveDrawingBuffer:true})||this.canvas.getContext("experimental-webgl",{preserveDrawingBuffer:true})}this.gl=this.dataContext};molmil.render.prototype.initGL=function(d,g,c){this.defaultContext=d.getContext("webgl")||d.getContext("experimental-webgl");d.renderer=this;if(!this.defaultContext){this.altCanvas=molmil.__webglNotSupported__(d);return false}this.gl=this.defaultContext;molmil.configBox.OES_element_index_uint=this.gl.getExtension("OES_element_index_uint");this.width=g|d.width;this.height=c|d.height;this.gl.viewportWidth=this.width;this.gl.viewportHeight=this.height;d.onmousedown=molmil.handle_molmilViewer_mouseDown;document.onmouseup=molmil.handle_molmilViewer_mouseUp;document.onmousemove=molmil.handle_molmilViewer_mouseMove;d.addEventListener(molmil_dep.dBT.MFF?"DOMMouseScroll":"mousewheel",molmil.handle_molmilViewer_mouseScroll,false);d.addEventListener("touchstart",molmil.handle_molmilViewer_touchStart,false);d.addEventListener("touchmove",molmil.handle_molmilViewer_touchMove,false);d.addEventListener("touchend",molmil.handle_molmilViewer_touchEnd,false);this.gl.clearColor.apply(this.gl,molmil.configBox.BGCOLOR);this.gl.enable(this.gl.DEPTH_TEST);this.gl.enable(this.gl.CULL_FACE);this.gl.cullFace(this.gl.BACK);this.canvas=d;var f=this.gl.getParameter(this.gl.ALIASED_LINE_WIDTH_RANGE);this.angle=f&&f.length==2&&f[0]==1&&f[1]==1;return true};molmil.render.prototype.initRenderer=function(){this.initShaders(molmil.configBox.glsl_shaders);this.resizeViewPort()};molmil.render.prototype.initShaders=function(h){this.shaders={};var f,c,l,j,d,g;for(var i=0;i<h.length;i++){d=h[i][0];f=h[i][1]||d.replace(/\\/g,"/").replace(/.*\//,"").split(".")[0];g=h[i][2]||"";this.shaders[f]=molmil.loadShader(molmil.settings.src+d,g);this.shaders[f].program=this.gl.createProgram();l=molmil.setupShader(this.gl,f+"_v",this.shaders[f].program,this.shaders[f].vertexShader,this.gl.VERTEX_SHADER);c=molmil.setupShader(this.gl,f+"_f",this.shaders[f].program,this.shaders[f].fragmentShader,this.gl.FRAGMENT_SHADER);this.gl.linkProgram(this.shaders[f].program);if(!this.gl.getProgramParameter(this.shaders[f].program,this.gl.LINK_STATUS)){console.log("Could not initialise shaders for "+f)}this.gl.useProgram(this.shaders[f].program);for(j in this.shaders[f].attributes){this.shaders[f].attributes[j]=this.gl.getAttribLocation(this.shaders[f].program,j);if(this.shaders[f].attributes[j]!=-1){this.gl.enableVertexAttribArray(this.shaders[f].attributes[j])}}for(j in this.shaders[f].uniforms){this.shaders[f].uniforms[j]=this.gl.getUniformLocation(this.shaders[f].program,j)}}this.gl.useProgram(null)};molmil.render.prototype.updateSelection=function(){var h=new Float32Array(this.soup.atomSelection.length*8*6),d;var g;for(var f=0,l=0,c;f<this.soup.atomSelection.length;f++){g=molmil_dep.getKeyFromObject(molmil.configBox.vdwR,this.soup.atomSelection[f].element,molmil.configBox.vdwR.DUMMY)*1.5;if(f==0){d=[1,0,0]}else{if(f==1){d=[0,1,0]}else{if(f==2){d=[0,0,1]}else{d=[0.8,0.8,0.8]}}}for(c=0;c<6;c++){h[l++]=this.soup.atomSelection[f].chain.modelsXYZ[this.modelId][this.soup.atomSelection[f].xyz];h[l++]=this.soup.atomSelection[f].chain.modelsXYZ[this.modelId][this.soup.atomSelection[f].xyz+1];h[l++]=this.soup.atomSelection[f].chain.modelsXYZ[this.modelId][this.soup.atomSelection[f].xyz+2];h[l++]=d[0];h[l++]=d[1];h[l++]=d[2];if(c==0||c==5){h[l++]=-g;h[l++]=+g}else{if(c==1){h[l++]=+g;h[l++]=+g}else{if(c==2||c==3){h[l++]=+g;h[l++]=-g}else{if(c==4){h[l++]=-g;h[l++]=-g}}}}}}if(!this.buffers.atomSelectionBuffer){this.buffers.atomSelectionBuffer=this.gl.createBuffer()}this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.buffers.atomSelectionBuffer);this.gl.bufferData(this.gl.ARRAY_BUFFER,h,this.gl.STATIC_DRAW);this.buffers.atomSelectionBuffer.items=this.soup.atomSelection.length*6};molmil.render.prototype.selectFrame=function(c,d){this.modelId=molmil.geometry.modelId=c;molmil.geometry.reInitChains=true;molmil.geometry.generate(this.soup.structures,this,d);this.initBD=true};molmil.render.prototype.initBuffers=function(){molmil.geometry.generate(this.soup.structures,this);this.initBD=true};molmil.render.prototype.renderPicking=function(){if(!this.initBD){return}this.gl.clearColor(0,0,0,0);this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT);var d=[0,0,0];var c=mat3.create();mat3.fromMat4(c,this.modelViewMatrix);vec3.transformMat3(d,this.soup.COR,c);for(var f=0;f<this.programs.length;f++){this.programs[f].renderPicking(this.modelViewMatrix,d)}this.gl.useProgram(null)};molmil.render.prototype.render=function(){if(!this.canvas.update||!this.initBD){return}if(this.canvas.update){for(var i=0;i<this.soup.canvases.length;i++){if(this.soup.canvases[i]!=this.canvas){this.soup.canvases[i].update=-1}}this.canvas.update=false;this.camera.pitchAngle=this.pitchAngle||this.pitch*Math.min(Math.max((Math.pow(Math.abs(this.camera.z),0.1)*0.25),0.5),2);this.camera.headingAngle=this.headingAngle||this.heading*Math.min(Math.max((Math.pow(Math.abs(this.camera.z),0.1)*0.25),0.5),2);if(this.TransX||this.TransY){var n=mat4.invert(mat4.create(),this.projectionMatrix);var o=(-this.camera.z-molmil.configBox.zNear)/(molmil.configBox.zFar-molmil.configBox.zNear);var j=vec3.lerp([0,0,0],molmil.unproject(this.TransB[0],this.TransB[1],0,n),molmil.unproject(this.TransB[0],this.TransB[1],1,n),o);this.TransB[0]+=this.TransX/this.width;this.TransB[1]-=this.TransY/this.height;var l=vec3.lerp([0,0,0],molmil.unproject(this.TransB[0],this.TransB[1],0,n),molmil.unproject(this.TransB[0],this.TransB[1],1,n),o);this.camera.x+=2*(l[0]-j[0]);this.camera.y+=2*(l[1]-j[1])}this.camera.z+=this.TransZ*Math.max(-this.camera.z/(this.width*0.5),0.05);if(this.camera.z>this.maxRange){this.camera.z=this.maxRange}if(this.camera.z<-(this.maxRange+molmil.configBox.zFar)){this.camera.z=-(this.maxRange+molmil.configBox.zFar)}this.pitch=0,this.heading=0,this.TransX=0,this.TransY=0,this.TransZ=0,this.pitchAngle=0,this.headingAngle=0;this.camera.positionCamera();this.modelViewMatrix=this.camera.generateMatrix();if(molmil.configBox.projectionMode==2){var f=-(this.camera.z*2)/molmil.configBox.zFar;mat4.ortho(this.projectionMatrix,-this.width*f,this.width*f,-this.height*f,this.height*f,Math.max(molmil.configBox.zNear,0.1),this.camera.z+(molmil.configBox.zFar*10))}}else{this.canvas.update=false}this.clearCut=((1-Math.abs(this.camera.QView[0]))*this.soup.stdXYZ[0])+((1-Math.abs(this.camera.QView[1]))*this.soup.stdXYZ[1])+((1-Math.abs(this.camera.QView[2]))*this.soup.stdXYZ[2]);this.fogStart=-this.camera.z-(this.clearCut*0.5);if(this.fogStart<molmil.configBox.zNear+1){this.fogStart=molmil.configBox.zNear+1}this.gl.clearColor.apply(this.gl,molmil.configBox.BGCOLOR);this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT);var h=[0,0,0];var g=mat3.create();mat3.fromMat4(g,this.modelViewMatrix);vec3.transformMat3(h,this.soup.COR,g);for(var d=0;d<this.programs.length;d++){this.programs[d].render(this.modelViewMatrix,h)}if(this.buffers.atomSelectionBuffer){this.renderAtomSelection(this.modelViewMatrix,h)}if(this.onRenderFinish){this.onRenderFinish()}this.gl.useProgram(null)};molmil.render.prototype.initFBOs=function(){if("scene" in this.FBOs){this.FBOs.depth.resize(this.width,this.height);this.FBOs.scene.resize(this.width,this.height)}else{this.FBOs.depth=new molmil.FBO(this.gl,this.width,this.height);this.FBOs.depth.addTexture("depthBuffer",this.gl.RGBA,this.gl.RGBA);this.FBOs.depth.setup();this.FBOs.scene=new molmil.FBO(this.gl,this.width,this.height);this.FBOs.scene.addTexture("colourBuffer",this.gl.RGBA,this.gl.RGBA);this.FBOs.scene.setup()}};molmil.render.prototype.resizeViewPort=function(){this.width=this.canvas.width;this.height=this.canvas.height;if(molmil.configBox.projectionMode==1){mat4.perspective(this.projectionMatrix,45*(Math.PI/360),this.width/this.height,molmil.configBox.zNear,molmil.configBox.zFar)}this.gl.viewport(0,0,this.width,this.height)};molmil.render.prototype.renderAtomSelection=function(c,d){this.gl.useProgram(this.shaders.atomSelection.program);this.gl.uniform3f(this.shaders.atomSelection.uniforms.COR,d[0],d[1],d[2]);this.gl.uniformMatrix4fv(this.shaders.atomSelection.uniforms.modelViewMatrix,false,c);this.gl.uniformMatrix4fv(this.shaders.atomSelection.uniforms.projectionMatrix,false,this.projectionMatrix);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.buffers.atomSelectionBuffer);this.gl.vertexAttribPointer(this.shaders.atomSelection.attributes.in_Position,3,this.gl.FLOAT,false,32,0);this.gl.vertexAttribPointer(this.shaders.atomSelection.attributes.in_Colour,3,this.gl.FLOAT,false,32,12);this.gl.vertexAttribPointer(this.shaders.atomSelection.attributes.in_ScreenSpaceOffset,2,this.gl.FLOAT,false,32,24);this.gl.enable(this.gl.BLEND);this.gl.disable(this.gl.CULL_FACE);this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA);this.gl.drawArrays(this.gl.TRIANGLES,0,this.buffers.atomSelectionBuffer.items);this.gl.enable(this.gl.CULL_FACE);this.gl.disable(this.gl.BLEND)};molmil.FBO=function(f,d,c){this.width=d;this.height=c;this.gl=f;this.textures={};this.colourNumber=0;this.fbo=null;this.depthBuffer=null};molmil.FBO.prototype.addTexture=function(g,c,f){if(g in this.textures){this.gl.bindTexture(this.gl.TEXTURE_2D,this.textures[g][0])}else{var d=this.gl.createTexture();this.textures[g]=[d,this.colourNumber++,c,f];this.gl.bindTexture(this.gl.TEXTURE_2D,d);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE)}this.gl.texImage2D(this.gl.TEXTURE_2D,0,c,this.width,this.height,0,f,this.gl.UNSIGNED_BYTE,null);this.gl.bindTexture(this.gl.TEXTURE_2D,null)};molmil.FBO.prototype.setup=function(){if(this.fbo!=null){this.rebindTextures(true)}else{this.fbo=this.gl.createFramebuffer();this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.fbo);this.rebindTextures(false);this.depthBuffer=this.gl.createRenderbuffer();this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.depthBuffer);this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_COMPONENT16,this.width,this.height);this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,this.depthBuffer);this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)}};molmil.FBO.prototype.rebindTextures=function(f){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.fbo);var d=[];for(var c in this.textures){this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0+this.textures[c][1],this.gl.TEXTURE_2D,this.textures[c][0],0);d.push(this.gl.COLOR_ATTACHMENT0+this.textures[c][1])}this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,this.depthBuffer);if(f){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)}};molmil.FBO.prototype.bindTextureToUniform=function(d,f,c){this.gl.activeTexture(this.gl.TEXTURE0+c);this.gl.bindTexture(this.gl.TEXTURE_2D,this.textures[d][0]);this.gl.uniform1i(f,c)};molmil.FBO.prototype.resize=function(f,c){if(f==this.width&&c==this.height){return}this.width=f;this.height=c;for(var d in this.textures){this.addTexture(d,this.textures[d][2],this.textures[d][3])}this.rebindTextures(false);this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.depthBuffer);this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_COMPONENT16,this.width,this.height);this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,this.depthBuffer);this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)};molmil.FBO.prototype.bind=function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.fbo)};molmil.FBO.prototype.unbind=function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)};molmil.glCamera=function(){this.reset()};molmil.glCamera.prototype.reset=function(){this.x=this.y=this.z=this.pitchAngle=this.headingAngle=0;this.QPitch=quat.create();this.QHeading=quat.create();this.QView=quat.create();this.pitchAngle=this.headingAngle=0};molmil.glCamera.prototype.generateMatrix=function(){var c=mat4.create();mat4.fromQuat(c,this.QView);c[12]=this.x;c[13]=this.y;c[14]=this.z;return c};molmil.glCamera.prototype.positionCamera=function(){quat.setAxisAngle(this.QPitch,[1,0,0],(this.pitchAngle/180)*Math.PI);quat.setAxisAngle(this.QHeading,[0,1,0],(this.headingAngle/180)*Math.PI);var c=quat.create();quat.multiply(c,this.QPitch,this.QHeading);quat.multiply(this.QView,c,this.QView);this.headingAngle=this.pitchAngle=0};molmil.handle_molmilViewer_mouseDown=function(c){molmil.activeCanvas=this;molmil.mouseDown=1;molmil.mouseDownS[c.which]=1;molmil.Xcoord=c.clientX;molmil.Ycoord=c.clientY;molmil.Zcoord=c.clientY;molmil.mouseMoved=false;document.oncontextmenu=molmil.disableContextMenu};molmil.disableContextMenu=function(c){if(c.stopPropagation){c.stopPropagation()}if(c.preventDefault){c.preventDefault()}c.cancelBubble=true;c.cancel=true;c.returnValue=false;return false};molmil.getOffset=function(d){var f=d.target,c=0,g=0;while(f&&!isNaN(f.offsetLeft)&&!isNaN(f.offsetTop)){c+=f.offsetLeft-f.scrollLeft;g+=f.offsetTop-f.scrollTop;f=f.offsetParent}c=d.clientX-c;g=d.clientY-g;return{x:c,y:g}};molmil.handle_molmilViewer_mouseUp=function(g){var d=molmil.activeCanvas;if(!molmil.mouseMoved&&d){if(g.ctrlKey!=d.atomCORset){if(g.ctrlKey){d.molmilViewer.setCOR()}else{d.molmilViewer.resetCOR()}d.renderer.modelViewMatrix=d.renderer.camera.generateMatrix()}if(d.isFullScreen){var i={x:g.screenX,y:g.screenY}}else{var i=molmil.getOffset(g)}var f=window.devicePixelRatio||1;d.renderer.soup.selectObject(i.x*f,i.y*f,g);if(g.which==3){d.renderer.soup.UI.showContextMenuAtom(g.clientX,g.clientY,g.pageX)}}molmil.mouseDownS[g.which]=0;if(molmil_dep.dBT.mac&&!g.ctrlKey&&molmil.mouseDownS[3]){molmil.mouseDownS[3]=0}var c=true;for(var h in molmil.mouseDownS){if(molmil.mouseDownS[h]){c=false;break}}molmil.mouseDown=c?0:1;if(c){setTimeout(function(){document.oncontextmenu=null},10);d=null}else{g.preventDefault();return false}};molmil.handle_molmilViewer_mouseMove=function(d){var c=molmil.activeCanvas;if(!molmil.mouseDown||!c){return}molmil.mouseMoved=true;if(molmil.mouseDownS[2]||(molmil.mouseDownS[1]&&molmil.mouseDownS[3])||(molmil.mouseDownS[1]&&d.shiftKey)){c.renderer.TransX+=(d.clientX-molmil.Xcoord)*0.5;c.renderer.TransY+=(d.clientY-molmil.Ycoord)*0.5;molmil.Xcoord=d.clientX;molmil.Zcoord=molmil.Ycoord=d.clientY}else{if(molmil.mouseDownS[1]){c.renderer.heading+=d.clientX-molmil.Xcoord;c.renderer.pitch+=d.clientY-molmil.Ycoord;molmil.Xcoord=d.clientX;molmil.Ycoord=d.clientY}else{if(molmil.mouseDownS[3]){c.renderer.TransZ=(d.clientY-molmil.Zcoord);molmil.Zcoord=d.clientY}}}if(d.ctrlKey!=c.atomCORset){if(d.ctrlKey){c.molmilViewer.setCOR()}else{c.molmilViewer.resetCOR()}}c.update=true;d.preventDefault()};molmil.handle_molmilViewer_mouseScroll=function(c){c.target.renderer.TransZ-=(c.wheelDelta||-c.detail*40);c.target.update=true;try{c.preventDefault()}catch(d){}return false};molmil.onDocumentMouseMove=function(c){if(molmil.mouseXstart==null){molmil.mouseXstart=c.clientX;molmil.mouseYstart=c.clientY}mouseX=c.clientX-molmil.mouseXstart;mouseY=c.clientY-molmil.mouseYstart;molmil.mouseXstart=c.clientX;molmil.mouseYstart=c.clientY};molmil.handle_molmilViewer_touchStart=function(f){if(document.body.onmousedown){document.body.onmousedown();document.body.onmousedown=null}molmil.activeCanvas=this;molmil.touchList=[];for(var d=0;d<f.touches.length;d++){molmil.touchList.push([f.touches[d].clientX,f.touches[d].clientY])}if(molmil.touchList.length==1){molmil.touchMode=1;molmil.previousTouchEvent=f;molmil.longTouchTID=setTimeout(molmil.handle_molmilViewer_touchHold,500)}else{if(molmil.touchList.length==2){var g=vec2.distance([0,0],[screen.width,screen.height]);var c=vec2.distance(molmil.touchList[0],molmil.touchList[1]);if(c/g<0.075){molmil.touchMode=3}else{molmil.touchMode=2}}}f.preventDefault()};molmil.handle_molmilViewer_touchHold=function(){if(!molmil.longTouchTID){return}if(molmil.previousTouchEvent){if(Math.sqrt((Math.pow(molmil.previousTouchEvent.touches[0].clientX-molmil.touchList[0][0],2))+(Math.pow(molmil.previousTouchEvent.touches[0].clientY-molmil.touchList[0][1],2)))<1){if(molmil.activeCanvas.isFullScreen){var d={x:molmil.previousTouchEvent.touches[0].screenX,y:molmil.previousTouchEvent.touches[0].screenY}}else{var d=molmil.getOffset(molmil.previousTouchEvent.touches[0])}var c=window.devicePixelRatio||1;molmil.activeCanvas.renderer.soup.selectObject(d.x*c,d.y*c,event)}molmil.activeCanvas.renderer.soup.UI.showContextMenuAtom(molmil.previousTouchEvent.touches[0].clientX,molmil.previousTouchEvent.touches[0].clientY,molmil.previousTouchEvent.touches[0].pageX)}molmil.longTouchTID=null;molmil.previousTouchEvent=null};molmil.handle_molmilViewer_touchMove=function(g){if(!molmil.touchList.length||!molmil.activeCanvas){return}if(molmil.longTouchTID){clearTimeout(molmil.longTouchTID);molmil.longTouchTID=null}var f=[];for(var d=0;d<g.touches.length;d++){f.push([g.touches[d].clientX,g.touches[d].clientY])}if(molmil.touchMode==1){molmil.activeCanvas.renderer.heading+=f[0][0]-molmil.touchList[0][0];molmil.activeCanvas.renderer.pitch+=f[0][1]-molmil.touchList[0][1]}else{if(molmil.touchMode==2){molmil.activeCanvas.renderer.TransZ=(vec2.distance(f[0],f[1])-vec2.distance(molmil.touchList[0],molmil.touchList[1]))*5}else{if(molmil.touchMode==3){var h=vec2.distance([0,0],[screen.width,screen.height]);var c=vec2.distance(molmil.touchList[0],molmil.touchList[1]);if(c/h<0.075){molmil.activeCanvas.renderer.TransX=((f[0][0]+f[1][0])/2)-((molmil.touchList[0][0]+molmil.touchList[1][0])/2);molmil.activeCanvas.renderer.TransY=((f[0][1]+f[1][1])/2)-((molmil.touchList[0][1]+molmil.touchList[1][1])/2)}}}}molmil.touchList=f;molmil.activeCanvas.update=true;g.preventDefault()};molmil.handle_molmilViewer_touchEnd=function(){if(molmil.previousTouchEvent&&molmil.touchMode==1){if(Math.sqrt((Math.pow(molmil.previousTouchEvent.touches[0].clientX-molmil.touchList[0][0],2))+(Math.pow(molmil.previousTouchEvent.touches[0].clientY-molmil.touchList[0][1],2)))<1){if(molmil.activeCanvas.isFullScreen){var d={x:molmil.previousTouchEvent.touches[0].screenX,y:molmil.previousTouchEvent.touches[0].screenY}}else{var d=molmil.getOffset(molmil.previousTouchEvent.touches[0])}var c=window.devicePixelRatio||1;molmil.activeCanvas.renderer.soup.selectObject(d.x*c,d.y*c,event)}}molmil.touchList=[];molmil.touchMode=0;molmil.longTouchTID=null};molmil.setOnContextMenu=function(d,c){d.oncontextmenu=c;d.addEventListener("touchstart",molmil.handle_contextMenu_touchStart,false);d.addEventListener("touchend",molmil.handle_contextMenu_touchEnd,false)};molmil.handle_contextMenu_touchStart=function(c){previousTouchEvent=c;longTouchTID=setTimeout(molmil.handle_contextMenu_touchHold,500);c.preventDefault()};molmil.handle_contextMenu_touchHold=function(){if(!longTouchTID){return}longTouchTID=null;previousTouchEvent.touches[0].target.oncontextmenu(previousTouchEvent.touches[0]);previousTouchEvent=null};molmil.handle_contextMenu_touchEnd=function(c){if(previousTouchEvent){previousTouchEvent.touches[0].target.onclick()}longTouchTID=null;clearTimeout(longTouchTID)};molmil.UI=function(c){this.soup=c;this.canvas=c.canvas;this.LM=null;this.RM=null};molmil.UI.prototype.init=function(){var d,g;d=document.createElement("span");d.className="molmil_UI_LB unselectableText";this.LM=g=document.createElement("span");g.className="molmil_UI_LB_icon";g.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="Layer_1" style="enable-background:new 0 0 32 32;/* background-color: red; */" version="1.1" viewBox="0 0 32 32" xml:space="preserve"><path d="M4,10h24c1.104,0,2-0.896,2-2s-0.896-2-2-2H4C2.896,6,2,6.896,2,8S2.896,10,4,10z M28,14H4c-1.104,0-2,0.896-2,2  s0.896,2,2,2h24c1.104,0,2-0.896,2-2S29.104,14,28,14z M28,22H4c-1.104,0-2,0.896-2,2s0.896,2,2,2h24c1.104,0,2-0.896,2-2  S29.104,22,28,22z" fill="red"/></svg>';g.UI=this;g.onclick=function(){this.UI.showLM(this)};d.appendChild(g);(this.canvas?this.canvas.parentNode:document.body).appendChild(d);d=document.createElement("span");d.className="molmil_UI_RB unselectableText";this.RM=g=document.createElement("div");if(molmil.configBox.BGCOLOR[0]==0&&molmil.configBox.BGCOLOR[1]==0&&molmil.configBox.BGCOLOR[2]==0){g.style.color="white"}g.className="molmil_UI_RB_icon";g.innerHTML="&lt;<br/>&lt;<br/>&lt;";g.UI=this;g.onclick=function(){this.UI.showRM(this)};d.appendChild(g);d.menu=d.pushNode("div");d.menu.style.display="none";d.menu.className="molmil_UI_RM";(this.canvas?this.canvas.parentNode:document.body).appendChild(d);var c=this.canvas;var f=function(j){var h=document.molmil_FSC;if(h!=c){return}var i=window.devicePixelRatio||1;if(!h.isFullScreen){h.renderer.width=h.width=screen.width*i;h.renderer.height=h.height=screen.height*i;h.style.width=screen.width+"px";h.style.height=screen.height+"px";h.isFullScreen=true}else{h.renderer.width=h.width=h.defaultSize[0]*i;h.renderer.height=h.height=h.defaultSize[1]*i;h.style.width=h.defaultSize[0]+"px";h.style.height=h.defaultSize[1]+"px";h.isFullScreen=false;document.molmil_FSC=null}h.renderer.resizeViewPort();h.update=true;h.renderer.render()};document.addEventListener("webkitfullscreenchange",f,false);document.addEventListener("mozfullscreenchange",f,false);document.addEventListener("MSFullscreenChange",f,false);document.addEventListener("fullscreenchange",f,false)};molmil.UI.prototype.deleteEntry=function(c){};molmil.UI.prototype.displayEntry=function(d,c){if(d.ref){molmil.displayEntry(d.ref,c,true,this.soup)}document.body.onmousedown()};molmil.UI.prototype.colorEntry=function(h,c){if(h.ref){if(c==molmil.colorEntry_Custom){var d=molmil_dep.dcE("div");d.setClass("molmil_menu_popup");d.pushNode("span","Color by: ");var g=d.pushNode("input");g.type="color";g.value="#FFFFFF";var f=d.pushNode("button","Apply");f.style.marginLeft="1em";f.entry=h;f.ci=g;f.popup=d;f.soup=this.soup;f.UI=this;f.onclick=function(){var i=molmil.hex2rgb(this.ci.value);i.push(255);if(this.entry.mtype==3.1){h.ref.rgba=i;this.UI.soup.renderer.initBuffers();this.UI.soup.renderer.canvas.update=true}else{if(this.entry.mtype==3.2){for(a=0;a<h.ref.atoms.length;a++){h.ref.atoms[a].rgba=i}this.UI.soup.renderer.initBuffers();this.UI.soup.renderer.canvas.update=true}else{molmil.colorEntry(this.entry.ref,molmil.colorEntry_Custom,i,true,this.soup)}}this.popup.parentNode.removeChild(this.popup)};this.LM.parentNode.pushNode(d)}else{molmil.colorEntry(h.ref,c,null,true,this.soup)}}document.body.onmousedown()};molmil.UI.prototype.showColorMenu=function(g,f){if(g.subMenu){clearTimeout(g.subMenu.TID);g.subMenu.style.display="";return}var j=molmil_dep.findPos(g);var i=g.subMenu=molmil_dep.dcE("div");i.className="contextMenu cM_sub";if(g.inv||f.inv){i.style.left="auto";i.style.right=((g.parentNode.clientWidth/molmil_dep.fontSize)+1.8)+"em"}else{i.style.left=((g.parentNode.clientWidth/molmil_dep.fontSize)+1.8)+"em"}var d,h=this;var c=function(l,o,n){d=i.pushNode("div",l);d.className="contextMenu_E";d.UI=h;d.entry=f;d.onclick=o;if(n){d.onmouseover=o;d.next=d.pushNode("span",">")}else{d.addEventListener("touchstart",function(){this.onclick()},false)}};if(f.mtype!=3.1&&f.mtype!=3.2){c("Default",function(){this.UI.colorEntry(f,1)})}if(f.mtype!=3.2){c("Structure",function(){if(f.mtype==3.1){var l=f.ref;l.rgba=molmil_dep.getKeyFromObject(molmil.configBox.sndStrucColor,l.sndStruc,molmil.configBox.sndStrucColor[1]);this.UI.soup.renderer.initBuffers();this.UI.soup.renderer.canvas.update=true;document.body.onmousedown()}else{this.UI.colorEntry(f,2)}})}if(f.mtype!=3.1){c("Atom (CPK)",function(){if(f.mtype==3.2){var l=f.ref;for(a=0;a<l.atoms.length;a++){l.atoms[a].rgba=molmil_dep.getKeyFromObject(molmil.configBox.elementColors,l.atoms[a].element,molmil.configBox.elementColors.DUMMY)}this.UI.soup.renderer.initBuffers();this.UI.soup.renderer.canvas.update=true;document.body.onmousedown()}else{this.UI.colorEntry(f,3)}})}if(f.mtype==1||f.mtype==2||f.mtype==0.5){c("Group",function(){this.UI.colorEntry(f,4)})}if(f.mtype==1||f.mtype==0.5){c("Chain",function(){this.UI.colorEntry(f,5)});c("Chain alt.",function(){this.UI.colorEntry(f,molmil.colorEntry_ChainAlt)})}c("Custom",function(){this.UI.colorEntry(f,6)});g.onmouseout=function(){this.subMenu.TID=molmil_dep.asyncStart(function(){this.style.display="none"},[],g.subMenu,100)};g.pushNode(i)};molmil.UI.prototype.showDisplayMenuCM=function(f){var j=this.soup.atomSelection[this.soup.atomSelection.length-1];if(!j){return}if(f.subMenu){clearTimeout(f.subMenu.TID);f.subMenu.style.display="";return}var l=molmil_dep.findPos(f);var d=f.subMenu=molmil_dep.dcE("div");if(f.inv){d.style.left="auto";d.style.right=((f.parentNode.clientWidth/molmil_dep.fontSize)+1.8)+"em"}else{d.style.left=((f.parentNode.clientWidth/molmil_dep.fontSize)+1.8)+"em"}var h=l[0]+(f.inv?-1:1)*(f.parentNode.clientWidth+(2*molmil_dep.fontSize));var n=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth;var i=n<h+(molmil_dep.fontSize*25);d.className="contextMenu cM_sub";var o,g=this;var c=function(p,s,q){o=d.pushNode("div",p);o.className="contextMenu_E";o.UI=g;o.entry=null;o.onclick=s;if(q){o.onmouseover=s;o.next=o.pushNode("span",">")}else{o.addEventListener("touchstart",function(){this.onclick()},false)}};c("Residue",function(){this.UI.showDisplayMenu(this,{mtype:3,ref:j.molecule,inv:i})},true);c("Chain",function(){this.UI.showDisplayMenu(this,{mtype:2,ref:j.molecule.chain,inv:i})},true);f.onmouseout=function(){this.subMenu.TID=molmil_dep.asyncStart(function(){this.style.display="none"},[],f.subMenu,100)};f.pushNode(d)};molmil.UI.prototype.showColorMenuCM=function(f){var j=this.soup.atomSelection[this.soup.atomSelection.length-1];if(!j){return}if(f.subMenu){clearTimeout(f.subMenu.TID);f.subMenu.style.display="";return}var l=molmil_dep.findPos(f);var d=f.subMenu=molmil_dep.dcE("div");if(f.inv){d.style.left="auto";d.style.right=((f.parentNode.clientWidth/molmil_dep.fontSize)+1.8)+"em"}else{d.style.left=((f.parentNode.clientWidth/molmil_dep.fontSize)+1.8)+"em"}var h=l[0]+(f.inv?-1:1)*(f.parentNode.clientWidth+(2*molmil_dep.fontSize));var n=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth;var i=n<h+(molmil_dep.fontSize*25);d.className="contextMenu cM_sub";var o,g=this;var c=function(p,s,q){o=d.pushNode("div",p);o.className="contextMenu_E";o.UI=g;o.entry=null;o.onclick=s;if(q){o.onmouseover=s;o.next=o.pushNode("span",">")}else{o.addEventListener("touchstart",function(){this.onclick()},false)}};c("Atom",function(){this.UI.showColorMenu(this,{mtype:4,ref:j,inv:i})},true);c("Residue",function(){this.UI.showColorMenu(this,{mtype:3,ref:j.molecule,inv:i})},true);c("Residue (cartoon)",function(){this.UI.showColorMenu(this,{mtype:3.1,ref:j.molecule,inv:i})},true);c("Residue (atoms)",function(){this.UI.showColorMenu(this,{mtype:3.2,ref:j.molecule,inv:i})},true);c("Chain",function(){this.UI.showColorMenu(this,{mtype:2,ref:j.molecule.chain,inv:i})},true);f.onmouseout=function(){this.subMenu.TID=molmil_dep.asyncStart(function(){this.style.display="none"},[],f.subMenu,100)};f.pushNode(d)};molmil.UI.prototype.showDisplayMenu=function(f,l){if(f.subMenu){clearTimeout(f.subMenu.TID);f.subMenu.style.display="";return}var j=molmil_dep.findPos(f);var d=f.subMenu=molmil_dep.dcE("div");d.className="contextMenu cM_sub";var p,g=this;if(f.inv||l.inv){d.style.left="auto";d.style.right=((f.parentNode.clientWidth/molmil_dep.fontSize)+1.8)+"em"}else{d.style.left=((f.parentNode.clientWidth/molmil_dep.fontSize)+1.8)+"em"}var h=j[0]+(f.inv?-1:1)*(f.parentNode.clientWidth+(2*molmil_dep.fontSize));var o=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth;var i=o<h+(molmil_dep.fontSize*25);var c=function(q,t,s){p=d.pushNode("div",q);p.className="contextMenu_E";p.inv=i;p.UI=g;p.entry=l;p.onclick=t;if(s){p.onmouseover=t;p.next=p.pushNode("span",">")}else{p.addEventListener("touchstart",function(){this.onclick()},false)}};c("None",function(){this.UI.displayEntry(l,0)});if(l.mtype!=3){c("Default",function(){this.UI.displayEntry(l,1)})}if(l.mtype!=10){if(l.mtype==3&&(l.ref.ligand||l.ref.water)){c("Space fill",function(){this.UI.displayEntry(l,2)});c("Ball & stick",function(){this.UI.displayEntry(l,3)});c("Stick",function(){this.UI.displayEntry(l,4)});c("Wireframe",function(){this.UI.displayEntry(l,5)})}else{var n=function(q,w){if(q.subMenu){clearTimeout(q.subMenu.TID);q.subMenu.style.display="";return}var x=molmil_dep.findPos(q);var u=q.subMenu=molmil_dep.dcE("div");if(q.inv){u.style.left="auto";u.style.right=((q.parentNode.clientWidth/molmil_dep.fontSize)+1.8)+"em"}else{u.style.left=((q.parentNode.clientWidth/molmil_dep.fontSize)+1.8)+"em"}u.className="contextMenu cM_sub";var t;var s=function(y,A,z){t=u.pushNode("div",y);t.className="contextMenu_E";t.UI=g;t.entry=l;t.onclick=A;if(z){t.onmouseover=A;t.next=t.pushNode("span",">")}else{t.addEventListener("touchstart",function(){this.onclick()},false)}};s("Space fill",function(){this.UI.displayEntry(l,w==1?2:2.5)});s("Ball & stick",function(){this.UI.displayEntry(l,w==1?3:3.5)});s("Stick",function(){this.UI.displayEntry(l,w==1?4:4.5)});s("Wireframe",function(){this.UI.displayEntry(l,w==1?5:5.5)});q.onmouseout=function(){this.subMenu.TID=molmil_dep.asyncStart(function(){this.style.display="none"},[],q.subMenu,100)};q.pushNode(u)};c("Amino acid",function(){n(this,1)},true);c("Side chain",function(){n(this,2)},true)}if(l.mtype<3&&!(l.ref.ligand||l.ref.water)){c("Ca trace",function(){this.UI.displayEntry(l,6)});c("Tube",function(){this.UI.displayEntry(l,7)});c("Cartoon",function(){this.UI.displayEntry(l,8)});c("CG Surface",function(){this.UI.displayEntry(l,molmil.displayMode_ChainSurfaceCG)})}}f.onmouseout=function(){this.subMenu.TID=molmil_dep.asyncStart(function(){this.style.display="none"},[],f.subMenu,100)};f.pushNode(d)};molmil.UI.prototype.showContextMenuAtom=function(o,n,h){if(document.body.onmousedown){document.body.onmousedown()}var l=this.soup.atomSelection[this.soup.atomSelection.length-1];if(!l){return}var p=0;var q=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth;if(q<h+(molmil_dep.fontSize*12)){p=(h+(molmil_dep.fontSize*12))-q}var i=q<h+(molmil_dep.fontSize*25);var d=molmil_dep.dcE("div");d.className="contextMenu";d.style.left=o-p+"px";d.style.top=n+(document.body.scrollTop||0)+"px";var j=l.molecule.atoms.length>1;var f=d.pushNode("div",(j?l.atomName:l.element)+" - "+(j?(l.molecule.name||"")+" ":"")+(l.molecule.RSID||"")+(l.molecule.chain.name?" - Chain "+l.molecule.chain.name:""));d.pushNode("HR");var g=this;var c=function(s,u,t){item=d.pushNode("div",s);if(!item.pushNode){return}item.className="contextMenu_E";item.UI=g;item.entry=null;item.inv=i;item.onclick=u;if(t){item.onmouseover=u;item.next=item.pushNode("span",">")}else{item.addEventListener("touchstart",function(){this.onclick()},false)}};c("Display",function(){this.UI.showDisplayMenuCM(this)},true);c("Color",function(){this.UI.showColorMenuCM(this)},true);document.body.pushNode(d);document.body.onmousedown=function(t){if(t&&t.target.className.indexOf("contextMenu_E")!=-1){return}var s=document.getElementsByClassName("contextMenu");for(var u=0;u<s.length;u++){s[u].parentNode.removeChild(s[u])}s=document.getElementsByClassName("contextMenu_E_sel")[0];document.body.onmousedown=null};return false};molmil.UI.prototype.showCM=function(h,f){if(document.body.onmousedown){document.body.onmousedown()}var l=0;var j=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth;if(j<h.pageX+(molmil_dep.fontSize*12)){l=(h.pageX+(molmil_dep.fontSize*12))-j}f.inv=j<h.pageX+(molmil_dep.fontSize*25);var i=molmil_dep.dcE("div");i.className="contextMenu";i.style.left=h.pageX-l+"px";i.style.top=h.pageY+"px";var d,g=this;f.setClass("contextMenu_E_sel");var c=function(n,p,o){d=i.pushNode("div",n);d.className="contextMenu_E";d.UI=g;d.entry=f;d.onclick=p;if(o){d.onmouseover=p;d.next=d.pushNode("span",">")}else{d.addEventListener("touchstart",function(){this.onclick()},false)}};if(f.mtype==0.5||f.mtype==1){if(this.soup.hideWaters){c("Show waters",function(){this.UI.toggleWaters(1)})}else{c("Hide waters",function(){this.UI.toggleWaters(0)})}if(this.soup.hideHydrogens){c("Show hydrogens",function(){this.UI.toggleHydrogens(1)})}else{c("Hide hydrogens",function(){this.UI.toggleHydrogens(0)})}}c("Display",function(){this.UI.showDisplayMenu(this,f)},true);if(f.mtype!=10){c("Color",function(){this.UI.showColorMenu(this,f)},true)}document.body.pushNode(i);document.body.onmousedown=function(o){if(o&&o.target.className.indexOf("contextMenu_E")!=-1){return}var n=document.getElementsByClassName("contextMenu");for(var p=0;p<n.length;p++){n[p].parentNode.removeChild(n[p])}n=document.getElementsByClassName("contextMenu_E_sel")[0];if(n){f.removeClass("contextMenu_E_sel")}document.body.onmousedown=null};try{h.preventDefault()}catch(h){}return false};molmil.UI.prototype.showRM=function(g){var l=g.parentNode.menu;if(l.style.display=="none"){g.innerHTML="&gt;<br/>&gt;<br/>&gt;";l.style.maxHeight=((this.canvas?this.canvas:document.body)-32)+"px";l.style.display=""}else{g.innerHTML="&lt;<br/>&lt;<br/>&lt;";l.style.display="none"}var j=this.canvas?this.canvas.molmilViewer.structures:[];if(l.childNodes.length>0){if(j.length==l.nof){return}}l.nof=j.length;l.pushNode("span","Structures:").className="optCat_k";l.pushNode("hr");var c,h,f;for(var d=0;d<j.length;d++){f=j[d];if(f instanceof molmil.entryObject){h=l.pushNode("div");h.plus=h.pushNode("a","+");h.plus.className="optCat_p";h.name=h.pushNode("a",f.meta.id);h.name.className="optCat_n";h.plus.onclick=h.name.onclick=molmil_dep.expandCatTree;h.name.UI=h.UI=this;molmil.setOnContextMenu(h.name,function(i){this.UI.showCM(i,this)});h.name.mtype=1;h.payload=h.name.ref=f;h.expandFunc=this.showChains}else{h=l.pushNode("div",f.filename);h.className="optCat_n";h.style.marginLeft="1.25em";h.UI=this;molmil.setOnContextMenu(h,function(i){this.UI.showCM(i,this)});h.mtype=10;h.ref=f.polygon}}};molmil.UI.prototype.showChains=function(h,g){var d,f;h.pushNode("span","Chains:").className="optCat_k";h.pushNode("hr");for(var c=0;c<g.chains.length;c++){d=g.chains[c];f=h.pushNode("div");f.plus=f.pushNode("a","+");f.plus.className="optCat_p";f.name=f.pushNode("a",d.name?d.name:c+1);f.name.className="optCat_n";f.plus.onclick=f.name.onclick=molmil_dep.expandCatTree;f.payload=d;f.name.UI=f.UI=this.UI;f.expandFunc=this.UI.showResidues;molmil.setOnContextMenu(f.name,function(i){this.UI.showCM(i,this)});f.name.mtype=2;f.name.ref=d}h.pushNode("hr")};molmil.UI.prototype.showResidues=function(h,g){h.pushNode("span","Residues/Ligands:").className="optCat_k";h.pushNode("hr");var f,d;for(var c=0;c<g.molecules.length;c++){f=g.molecules[c];d=h.pushNode("div",f.name+(f.id?" ("+f.id+")":""));d.className="optCat_n";d.payload=f;d.UI=this.UI;molmil.setOnContextMenu(d,function(i){this.UI.showCM(i,this)});d.mtype=3;d.ref=f;d.ondblclick=function(){this.UI.canvas.molmilViewer.gotoMol(this.payload)};d.onclick=function(){this.UI.canvas.molmilViewer.atomSelection=[this.payload.CA||this.payload.atoms[0]];this.UI.canvas.renderer.updateSelection();this.UI.canvas.update=true}}h.pushNode("hr")};molmil.UI.prototype.showLM=function(d){try{if(d.parentNode.childNodes.length>1){d.parentNode.removeChild(d.nextSibling);d.parentNode.removeChild(d.nextSibling);return}}catch(f){}var g=document.createElement("div"),f;g.className="molmil_UI_LM";f=g.appendChild(document.createElement("div"));f.menu=g;f.UI=this;f.className="molmil_UI_ME";f.innerHTML="Open >";f.onclick=function(){molmil_dep.Clear(this.menu.sub);var h;this.menu.sub.style.display="";if(!molmil_dep.dBT.ios_version){h=this.menu.sub.pushNode("div","mmCIF file","molmil_UI_ME");h.UI=this.UI;h.onclick=function(){this.UI.open("mmCIF",2)};h=this.menu.sub.pushNode("div","PDBML file","molmil_UI_ME");h.UI=this.UI;h.onclick=function(){this.UI.open("PDBML",3)};h=this.menu.sub.pushNode("div","mmJSON file","molmil_UI_ME");h.UI=this.UI;h.onclick=function(){this.UI.open("mmJSON",1)};h=this.menu.sub.pushNode("div","PDB (flat) file","molmil_UI_ME");h.UI=this.UI;h.onclick=function(){this.UI.open("PDB",4)};h=this.menu.sub.pushNode("div","GRO file","molmil_UI_ME");h.UI=this.UI;h.onclick=function(){this.UI.open("GRO",7)};h=this.menu.sub.pushNode("div","CCP4 file","molmil_UI_ME");h.UI=this.UI;h.onclick=function(){this.UI.open("CCP4","ccp4",null,null,true)};h=this.menu.sub.pushNode("div","MDL mol file","molmil_UI_ME");h.UI=this.UI;h.onclick=function(){this.UI.open("MDL mol","mdl")};h=this.menu.sub.pushNode("div","Mol2 file","molmil_UI_ME");h.UI=this.UI;h.onclick=function(){this.UI.open("Mol2","mol2")};h=this.menu.sub.pushNode("div","Polygon XML file","molmil_UI_ME");h.UI=this.UI;h.onclick=function(){this.UI.open("Polygon XML file",5)};h=this.menu.sub.pushNode("div","Polygon JSON file","molmil_UI_ME");h.UI=this.UI;h.onclick=function(){this.UI.open("Polygon JSON file",6)};this.menu.sub.pushNode("hr")}h=this.menu.sub.pushNode("div","PDB (PDBj)","molmil_UI_ME");h.UI=this.UI;h.onclick=function(){this.UI.openID(1)};h=this.menu.sub.pushNode("div","PDB chem_comp (PDBj)","molmil_UI_ME");h.UI=this.UI;h.onclick=function(){this.UI.openID(2)};h=this.menu.sub.pushNode("div","Promode Elastic (PDBj)","molmil_UI_ME");h.UI=this.UI;h.onclick=function(){this.UI.openPMEID()}};f=g.appendChild(document.createElement("div"));f.menu=g;f.UI=this;f.className="molmil_UI_ME";f.innerHTML="Save >";f.onclick=function(){molmil_dep.Clear(this.menu.sub);var h;this.menu.sub.style.display="";h=this.menu.sub.pushNode("div","PNG image","molmil_UI_ME");h.UI=this.UI;h.onclick=function(){this.UI.savePNG()};h=this.menu.sub.pushNode("div","MP4 video","molmil_UI_ME");h.UI=this.UI;h.onclick=function(){molmil.initVideo(this.UI)};h=this.menu.sub.pushNode("div","PLY polygon file","molmil_UI_ME");h.UI=this.UI;h.onclick=function(){molmil.exportPLY(this.UI.soup)};h=this.menu.sub.pushNode("div","STL polygon file","molmil_UI_ME");h.UI=this.UI;h.onclick=function(){molmil.exportSTL(this.UI.soup)}};g.pushNode("hr");f=g.appendChild(document.createElement("div"));f.UI=this;f.LM=d;f.className="molmil_UI_ME";f.innerHTML="Settings";f.onclick=function(){this.LM.onclick();this.UI.settings()};var c=this.soup.structures.length?this.soup.structures[0].number_of_frames:0;if(c>1){f=g.appendChild(document.createElement("div"));f.menu=g;f.UI=this;f.className="molmil_UI_ME";f.innerHTML="Animation";f.canvas=this.canvas;f.LM=d;f.onclick=function(){this.UI.animationPopUp();this.LM.onclick()};g.pushNode("hr")}if(!molmil_dep.dBT.ios_version){f=g.pushNode("div");f.className="molmil_UI_ME";f.innerHTML="Enable full-screen";f.canvas=this.canvas;f.LM=d;f.onclick=function(){var h=this.canvas.requestFullScreen||this.canvas.webkitRequestFullScreen||this.canvas.mozRequestFullScreen||this.canvas.msRequestFullscreen||null;if(h){document.molmil_FSC=this.canvas;h.call(this.canvas)}this.LM.onclick()}}f=g.appendChild(document.createElement("div"));f.UI=this;f.className="molmil_UI_ME";f.innerHTML="Clear";f.onclick=function(){this.UI.clear()};g.pushNode("hr");f=g.appendChild(document.createElement("div"));f.UI=this;f.className="molmil_UI_ME";f.innerHTML="Help";f.LM=d;f.onclick=function(){window.open("https://github.com/gjbekker/molmil/wiki");this.LM.onclick()};d.parentNode.appendChild(g);g.sub=d.parentNode.appendChild(document.createElement("div"));g.sub.className="molmil_UI_LM";g.sub.style.display="none"};molmil.UI.prototype.settings=function(){var c=molmil_dep.dcE("div");c.setClass("molmil_menu_popup");c.pushNode("div","Settings");c.pushNode("hr");var g=molmil_dep.dcE("button"),d;g.qlv=molmil_dep.dcE("input");g.qlv.type="range";g.qlv.min="0";g.qlv.max="4";g.qlv.step="1";g.qlv.value=localStorage.getItem("molmil.settings_QLV");g.qlv.ref=molmil_dep.dcE("span");g.qlv.ref.innerHTML=g.qlv.value;g.qlv.onmousemove=function(){this.ref.innerHTML=this.value};g.bbsf=molmil_dep.dcE("input");g.bbsf.value=molmil.configBox.smoothFactor;g.fog=molmil_dep.dcE("input");g.fog.type="checkbox";g.fog.checked=localStorage.getItem("molmil.settings_glsl_fog")==1;g.projectionMode=molmil_dep.dcE("select");d=g.projectionMode.pushNode("option","Perspective projection");d.value=1;d=g.projectionMode.pushNode("option","Orthographic projection");d.value=2;if(molmil.configBox.projectionMode==2){d.selected=true}g.colorMode=molmil_dep.dcE("select");d=g.colorMode.pushNode("option","Rasmol");d.value=1;d=g.colorMode.pushNode("option","Jmol");d.value=2;if(localStorage.getItem("molmil.settings_COLORS")==2){d.selected=true}d=g.colorMode.pushNode("option","Basic");d.value=3;if(localStorage.getItem("molmil.settings_COLORS")==3){d.selected=true}g.bgcolor=molmil_dep.dcE("span");g.bgcolor.pushNode("span","R: ");g.bgcolor.R=g.bgcolor.pushNode("input");g.bgcolor.pushNode("span"," G: ");g.bgcolor.G=g.bgcolor.pushNode("input");g.bgcolor.pushNode("span"," B: ");g.bgcolor.B=g.bgcolor.pushNode("input");g.bgcolor.pushNode("span"," A: ");g.bgcolor.A=g.bgcolor.pushNode("input");g.bgcolor.R.style.width=g.bgcolor.G.style.width=g.bgcolor.B.style.width=g.bgcolor.A.style.width="2.5em";g.bgcolor.R.value=Math.round(molmil.configBox.BGCOLOR[0]*255);g.bgcolor.G.value=Math.round(molmil.configBox.BGCOLOR[1]*255);g.bgcolor.B.value=Math.round(molmil.configBox.BGCOLOR[2]*255);g.bgcolor.A.value=Math.round(molmil.configBox.BGCOLOR[3]*255);var h=c.pushNode("table"),f,d;f=h.pushNode("tr");f.pushNode("td","Quality:");d=molmil_dep.dcE("div");d.pushNode(g.qlv);d.pushNode(g.qlv.ref);f.pushNode("td").pushNode(d);f=h.pushNode("tr");f.pushNode("td","Sheet/loop backbone smooth factor:");d=molmil_dep.dcE("div");d.pushNode(g.bbsf);f.pushNode("td").pushNode(d);f=h.pushNode("tr");f.pushNode("td","Fog:");d=molmil_dep.dcE("div");d.pushNode(g.fog);f.pushNode("td").pushNode(d);f=h.pushNode("tr");f.pushNode("td","Projection mode:");f.pushNode("td").pushNode(g.projectionMode);f=h.pushNode("tr");f.pushNode("td","Color scheme*:");f.pushNode("td").pushNode(g.colorMode);f.title="Atom (CPK) colors need to be manually re-applied to become effective";f=h.pushNode("tr");f.pushNode("td","BG color:");f.pushNode("td").pushNode(g.bgcolor);c.pushNode("hr");g.innerHTML="Apply";g.UI=this;g.popup=c;g.onclick=function(){localStorage.setItem("molmil.settings_QLV",this.qlv.value);localStorage.setItem("molmil.settings_glsl_fog",(molmil.configBox.glsl_fog=this.fog.checked)?"1":"0");localStorage.setItem("molmil.settings_PROJECTION",this.projectionMode.value);localStorage.setItem("molmil.settings_COLORS",this.colorMode.value);localStorage.setItem("molmil.settings_BGCOLOR",JSON.stringify([parseFloat(this.bgcolor.R.value)/255,parseFloat(this.bgcolor.G.value)/255,parseFloat(this.bgcolor.B.value)/255,parseFloat(this.bgcolor.A.value)/255]));localStorage.setItem("molmil.settings_BBSF",this.bbsf.value);molmil.initSettings();this.UI.soup.reloadSettings();molmil.configBox.projectionMode=this.projectionMode.value;this.UI.soup.renderer.resizeViewPort();this.UI.soup.renderer.initShaders(molmil.configBox.glsl_shaders);this.UI.soup.renderer.initBuffers();this.UI.soup.canvas.update=true;this.popup.parentNode.removeChild(this.popup)};c.pushNode(g);this.LM.parentNode.pushNode(c)};molmil.UI.prototype.toggleWaters=function(c){this.soup.waterToggle(c);this.soup.renderer.initBuffers();this.soup.canvas.update=true;document.body.onmousedown()};molmil.UI.prototype.toggleHydrogens=function(c){this.soup.hydrogenToggle(c);this.soup.renderer.initBuffers();this.soup.canvas.update=true;document.body.onmousedown()};molmil.UI.prototype.animationPopUp=function(){var c=molmil_dep.dcE("div");c.setClass("molmil_menu_popup");c.pushNode("div","Animation controls");c.pushNode("hr");this.soup.animation.initialise(c);if(this.soup.frameInfo){var f=c.pushNode("input");f.type="range";f.value=f.min=0;f.max=this.soup.frameInfo.length;f.soup=this.soup;f.oninput=function(g){this.soup.animation.go2Frame(g.srcElement.valueAsNumber)};c.sliderBox=f;var d=c.pushNode("span",this.soup.frameInfo[0][1]+"ps");c.timeBox=d}else{var f=c.pushNode("input");f.type="range";f.value=f.min=0;f.max=this.soup.chains[0].modelsXYZ.length;f.soup=this.soup;f.oninput=function(g){this.soup.animation.go2Frame(g.srcElement.valueAsNumber)};c.sliderBox=f;var d=c.pushNode("span","0");c.timeBox=d}c.pushNode("br");c.pushNode("span","Motion:");label=c.pushNode("label");inp=label.pushNode("input");inp.type="radio";inp.name="motion";if(this.soup.animation.motionMode==1){inp.checked=true}label.pushNode("span","Forward");label.AI=this.soup.animation;label.onclick=function(){this.AI.motionMode=1};label=c.pushNode("label");inp=label.pushNode("input");inp.type="radio";inp.name="motion";if(this.soup.animation.motionMode==2){inp.checked=true}label.pushNode("span","Backward");label.AI=this.soup.animation;label.onclick=function(){this.AI.motionMode=2};label=c.pushNode("label");inp=label.pushNode("input");inp.type="radio";inp.name="motion";if(this.soup.animation.motionMode==3){inp.checked=true}label.pushNode("span","Swing");label.AI=this.soup.animation;label.onclick=function(){this.AI.motionMode=3};c.pushNode("br");label=c.pushNode("div");label.setClass("unselectableText");label.style.fontStyle="normal";label.style.textAlign="center";inp=label.pushNode("span","|&#8920;");inp.setClass("smallButton");inp.AI=this.soup.animation;inp.onclick=function(){this.AI.beginning()};inp=label.pushNode("span","<");inp.setClass("smallButton");inp.AI=this.soup.animation;inp.onclick=function(){this.AI.previous()};inp=label.pushNode("span","ll");inp.setClass("smallButton");inp.AI=this.soup.animation;inp.onclick=function(){this.AI.pause()};inp=label.pushNode("span","&#9658;");inp.setClass("smallButton");inp.AI=this.soup.animation;inp.onclick=function(){this.AI.play()};inp=label.pushNode("span",">");inp.setClass("smallButton");inp.AI=this.soup.animation;inp.onclick=function(){this.AI.next()};inp=label.pushNode("span","&#8921;|");inp.setClass("smallButton");inp.AI=this.soup.animation;inp.onclick=function(){this.AI.end()};c.close=c.pushNode("button","Close");c.close.style.display="block";c.close.style.marginLeft=c.close.style.marginRight="auto";c.close.onclick=function(){this.popup.parentNode.removeChild(this.popup)};c.close.popup=c;this.LM.parentNode.pushNode(c)};molmil.UI.prototype.resetRM=function(){try{molmil_dep.Clear(this.RM.parentNode.menu);if(this.RM.parentNode.menu.style.display!="none"){this.showRM(this.RM)}}catch(c){}};molmil.UI.prototype.clear=function(){if(this.LM&&this.LM.parentNode.childNodes.length>1){this.LM.onclick()}var c=molmil_dep.dcE("div");c.setClass("molmil_menu_popup");c.pushNode("div","Do you want to clear all loaded structures?");c.yes=c.pushNode("button","Yes");c.yes.canvas=this.canvas;c.yes.UI=this;c.yes.onclick=function(){if(this.canvas){molmil.clear(this.canvas)}this.UI.resetRM();c.cancel.onclick()};c.cancel=c.pushNode("button","Cancel");c.cancel.onclick=function(){this.popup.parentNode.removeChild(this.popup)};c.cancel.popup=c;this.LM.parentNode.pushNode(c)};molmil.UI.prototype.open=function(g,i,d,l,j){if(this.LM&&this.LM.parentNode.childNodes.length>1){this.LM.onclick()}var f=this.soup;var h=this;var c=molmil_dep.dcE("div");c.setClass("molmil_menu_popup");c.pushNode("div","Open "+g+" file: ");c.inp=c.pushNode("input");c.inp.type="file";c.load=c.pushNode("button","Load");c.load.fileFormat=i;c.settings={};c.load.onclick=function(){if(!c.inp.files.length){return}var n=new FileReader();n.fileFormat=this.fileFormat;n.filename=c.inp.files[0].name;n.onload=function(o){if(this.fileFormat){f.loadStructureData(o.target.result,this.fileFormat,this.filename,function(p,q){h.resetRM();if(d){d(p,q)}else{molmil.displayEntry(q,p.AID>100000?5:1);molmil.colorEntry(q,1,[],true,p)}},c.settings)}else{d(this.filename,o.target.result)}l=null;c.cancel.onclick()};if(j){n.readAsArrayBuffer(c.inp.files[0])}else{n.readAsText(c.inp.files[0])}};c.cancel=c.pushNode("button","Cancel");c.cancel.onclick=function(){this.popup.parentNode.removeChild(this.popup);if(l){l()}};c.cancel.popup=c;if(this.LM){this.LM.parentNode.pushNode(c)}return c};molmil.UI.prototype.openPMEID=function(){if(this.LM&&this.LM.parentNode.childNodes.length>1){this.LM.onclick()}var f=this;var c=molmil_dep.dcE("div");c.setClass("molmil_menu_popup");c.pushNode("div","Promode Elastic");c.pushNode("hr");c.pushNode("span","Display: ");c.dpm1=c.pushNode("label");c.dpm1.inp=c.dpm1.pushNode("input");c.dpm1.inp.type="radio";c.dpm1.inp.name="displayMode";c.dpm1.pushNode("span","Displacement vectors");c.dpm1.inp.checked=true;c.pushNode("br");c.dpm2=c.pushNode("label");c.dpm2.inp=c.dpm2.pushNode("input");c.dpm2.inp.type="radio";c.dpm2.inp.name="displayMode";c.dpm2.pushNode("span","Animation");c.pushNode("br");c.pushNode("span","Mode:").style.paddingRight="1.125em";c.mode=c.pushNode("select");c.mode.style.width="10em";for(var d=0;d<10;d++){c.mode.pushNode("option",d+1)}c.pushNode("br");c.pushNode("span","PDB ID: ");c.inp=c.pushNode("input");c.inp.type="text";c.inp.style.width="10em";c.inp.onkeyup=function(g){if(g.keyCode==13){this.load.onclick()}else{if(g.keyCode==27){this.cancel.onclick()}}};c.pushNode("br");c.pushNode("span","Variant:").style.paddingRight=".25em";c.sel=c.pushNode("select");c.sel.style.width="10em";c.pushNode("br");c.inp.load=c.load=c.pushNode("button","Load");c.load.canvas=this.canvas;c.load.inpBuf=null;c.load.doLoad=function(h){h=h||c.sel.childNodes[c.sel.selectedIndex].innerHTML;var g=c.mode.childNodes[c.mode.selectedIndex].innerHTML;if(c.dpm1.inp.checked){this.canvas.molmilViewer.loadStructure(molmil.settings.promodeE_base_structure_url.replace("__ID__",h),4);this.canvas.molmilViewer.loadStructure(molmil.settings.promodeE_mode_vectors_url.replace("__ID__",h).replace("__MODE__",g),5)}else{this.canvas.molmilViewer.loadStructure(molmil.settings.promodeE_animation_url.replace("__ID__",h).replace("__MODE__",g),4,function(i,j){molmil.displayEntry(j,i.AID>100000?5:1);molmil.colorEntry(j,1);i.animation.motionMode=3;i.animation.play()})}c.cancel.onclick()};c.load.onclick=function(){if(c.inp.value!=this.inpBuf){this.inpBuf=c.inp.value;var g=new molmil_dep.CallRemote("GET");g.ASYNC=true;g.OnDone=function(){molmil_dep.Clear(c.sel);var h=JSON.parse(this.request.responseText);if(h.length==1){return c.load.doLoad(h[0][2])}for(var j=0;j<h.length;j++){c.sel.pushNode("option",h[j][2])}};g.Send(molmil.settings.promodeE_check_url.replace("__ID__",this.inpBuf))}else{if(c.sel.length){c.load.doLoad()}}};c.inp.cancel=c.cancel=c.pushNode("button","Cancel");c.cancel.onclick=function(){this.popup.parentNode.removeChild(this.popup)};c.cancel.popup=c;this.LM.parentNode.pushNode(c);c.inp.focus()};molmil.UI.prototype.openID=function(c){if(this.LM&&this.LM.parentNode.childNodes.length>1){this.LM.onclick()}var h,f;if(c==1){h="PDB ID";f=molmil.settings.pdb_url}else{if(c==2){h="Comp ID";f=molmil.settings.comp_url}else{return}}var g=this;var d=molmil_dep.dcE("div");d.setClass("molmil_menu_popup");d.pushNode("span",h+": ");d.inp=d.pushNode("input");d.inp.type="text";d.inp.onkeyup=function(i){if(i.keyCode==13){this.load.onclick()}else{if(i.keyCode==27){this.cancel.onclick()}}};d.inp.load=d.load=d.pushNode("button","Load");d.load.canvas=this.canvas;d.load.url=f;d.load.onclick=function(){if(!d.inp.value){return}this.canvas.molmilViewer.loadStructure(this.url.replace("__ID__",d.inp.value),1,function(i,j){molmil.displayEntry(j,i.AID>100000?5:1);molmil.colorEntry(j,1,[],true,i);g.resetRM()});d.cancel.onclick()};d.inp.cancel=d.cancel=d.pushNode("button","Cancel");d.cancel.onclick=function(){this.popup.parentNode.removeChild(this.popup)};d.cancel.popup=d;this.LM.parentNode.pushNode(d);d.inp.focus()};molmil.UI.prototype.savePNG=function(){if(this.LM&&this.LM.parentNode.childNodes.length>1){this.LM.onclick()}var c=molmil_dep.dcE("div");c.setClass("molmil_menu_popup");c.pushNode("span"," ");c.range=c.pushNode("input");c.range.type="range";c.range.min="0.25";c.range.max="4";c.range.step=".25";c.range.value="1.0";c.range.onmousemove=function(){this.nfo.innerHTML=(this.canvas.width*this.value)+"px x "+(this.canvas.height*this.value)+"px"};c.range.nfo=c.pushNode("span");c.range.nfo.style.display="inline-block";c.save=c.pushNode("button","Save");c.range.canvas=c.save.canvas=this.canvas;c.save.onclick=function(){var h=parseInt(c.range.value);if(h!=1){var g=this.canvas.width;var d=this.canvas.height;var f=molmil.configBox.BGCOLOR[3];this.canvas.width*=h;this.canvas.height*=h;molmil.configBox.BGCOLOR[3]=0;this.canvas.renderer.selectDataContext();this.canvas.renderer.resizeViewPort();this.canvas.update=true;this.canvas.renderer.render();this.canvas.toBlob(function(i){saveAs(i,"image.png")});this.canvas.renderer.selectDefaultContext();this.canvas.width=g;this.canvas.height=d;molmil.configBox.BGCOLOR[3]=f;this.canvas.renderer.resizeViewPort();this.canvas.update=true;this.canvas.renderer.render()}else{var f=molmil.configBox.BGCOLOR[3];molmil.configBox.BGCOLOR[3]=0;this.canvas.renderer.selectDataContext();this.canvas.update=true;this.canvas.renderer.render();this.canvas.toBlob(function(i){saveAs(i,"image.png")});this.canvas.renderer.selectDefaultContext();molmil.configBox.BGCOLOR[3]=f;this.canvas.update=true;this.canvas.renderer.render()}c.cancel.onclick()};c.cancel=c.pushNode("button","Cancel");c.cancel.onclick=function(){this.popup.parentNode.removeChild(this.popup)};c.cancel.popup=c;c.range.onmousemove();this.LM.parentNode.pushNode(c)};molmil.UI.prototype.videoRenderer=function(){if(this.LM&&this.LM.parentNode.childNodes.length>1){this.LM.onclick()}var d=null;var f=null;this.canvas.renderer.onRenderFinish=function(){if(!d){return}if(f==null){f=new Uint8Array(this.canvas.width*this.canvas.width*4)}var g=new molmil_dep.CallRemote("POST");g.AddParameter("id",d);g.AddParameter("data",canvas.toDataURL());this.canvas.renderer.gl.readPixels(0,0,this.canvas.width,this.canvas.width,this.canvas.renderer.gl.RGBA,this.canvas.renderer.gl.UNSIGNED_BYTE,f);g.Send(molmil.settings.molmil_video_url+"addFrame")};var c=molmil_dep.dcE("div");c.setClass("molmil_menu_popup");c.preview=c.pushNode("button","Play & Preview");c.pushNode("br");c.record=c.pushNode("button","Play & Record");c.pushNode("br");c.canvas=c.preview.canvas=c.record.canvas=this.canvas;c.preview.popup=c.record.popup=c;c.preview.onclick=function(){d=null;this.canvas.molmilViewer.animation.beginning();this.canvas.molmilViewer.animation.play()};c.endVideo=function(){if(this.canvas.molmilViewer.animation.playing){molmil_dep.asyncStart(this.endVideo,[],this,250)}else{var g=new molmil_dep.CallRemote("GET");g.AddParameter("id",d);g.Send(molmil.settings.molmil_video_url+"deInitVideo");console.log(molmil.settings.molmil_video_url+"getVideo?id="+d);window.open(molmil.settings.molmil_video_url+"getVideo?id="+d);d=null}};c.record.onclick=function(){var g=new molmil_dep.CallRemote("GET");g.AddParameter("w",this.canvas.width);g.AddParameter("h",this.canvas.height);g.Send(molmil.settings.molmil_video_url+"initVideo");d=g.request.responseText;this.canvas.molmilViewer.animation.beginning();this.canvas.molmilViewer.animation.play();this.popup.endVideo()};c.cancel=c.pushNode("button","Cancel");c.cancel.canvas=this.canvas;c.cancel.onclick=function(){this.canvas.molmilViewer.animation.end();this.popup.endVideo();this.popup.parentNode.removeChild(this.popup)};c.cancel.popup=c;this.LM.parentNode.pushNode(c)};molmil.toggleEntry=function(j,f,i,g){g=g||molmil.cli_soup;var c,d,h;if(j instanceof molmil.entryObject){for(c=0;c<j.molecules.length;c++){h=j.molecules[c];if(!h.ligand&&!h.water){for(d=0;d<h.atoms.length;d++){h.atoms[d].status=f}}h.status=f}}else{if(j instanceof molmil.chainObject){for(c=0;c<j.molecules.length;c++){h=j.molecules[c];for(d=0;d<h.atoms.length;d++){h.atoms[d].status=f}h.status=f}}else{if(j instanceof molmil.molObject){for(d=0;d<j.atoms.length;d++){j.atoms[d].status=f}j.status=f}else{if(j instanceof molmil.atomObject){j.status=false}else{if(j instanceof polygonObject){j.display=f}else{return}}}}}if(i){g.renderer.initBuffers();g.renderer.canvas.update=true}};molmil.displayEntry=function(l,o,f,p){p=p||molmil.cli_soup;if(l instanceof Array){for(var n=0;n<l.length;n++){molmil.displayEntry(l[n],o)}if(f){p.renderer.initBuffers();p.renderer.canvas.update=true}return}if(p&&((p.SCstuff&&o%1==0)||(!p.SCstuff&&o%1!=0))){molmil.geometry.reInitChains=true}var g,t,q,d,j,s=molmil.configBox.backboneAtoms4Display,u=molmil.configBox.backboneAtoms4DisplayXNA,h=molmil.configBox.xna_simple_base_atoms,w;if(l instanceof molmil.entryObject){if(o==molmil.displayMode_None){for(q=0;q<l.chains.length;q++){d=l.chains[q];d.displayMode=0;for(var t=0;t<d.atoms.length;t++){d.atoms[t].displayMode=0}for(var g=0;g<d.molecules.length;g++){d.molecules[g].displayMode=0;d.molecules[g].showSC=false}}}else{if(o==molmil.displayMode_Default){for(q=0;q<l.chains.length;q++){d=l.chains[q];d.displayMode=3;for(g=0;g<d.molecules.length;g++){j=d.molecules[g];if(j.ligand||j.water){for(t=0;t<j.atoms.length;t++){j.atoms[t].displayMode=3}}else{if(j.xna){for(t=0;t<j.atoms.length;t++){j.atoms[t].displayMode=h.hasOwnProperty(j.atoms[t].atomName)||j.atoms[t].element=="H"?0:3}}else{if(j.weirdAA){for(t=0;t<j.atoms.length;t++){if(s.hasOwnProperty(j.atoms[t].atomName)){j.atoms[t].displayMode=0}else{j.atoms[t].displayMode=3}}}else{for(t=0;t<j.atoms.length;t++){j.atoms[t].displayMode=0}}}}j.displayMode=3;j.showSC=j.weirdAA}}molmil.geometry.reInitChains=true}else{if(o==molmil.displayMode_Spacefill){for(q=0;q<l.chains.length;q++){d=l.chains[q];d.displayMode=1;for(var t=0;t<d.atoms.length;t++){d.atoms[t].displayMode=1}for(var g=0;g<d.molecules.length;g++){d.molecules[g].displayMode=0;d.molecules[g].showSC=true}}}else{if(o==molmil.displayMode_Spacefill_SC){for(q=0;q<l.chains.length;q++){d=l.chains[q];for(var t=0;t<d.atoms.length;t++){if(d.atoms[t].molecule.xna){w=u}else{w=s}if(!d.atoms[t].molecule.ligand&&!d.atoms[t].molecule.water&&w.hasOwnProperty(d.atoms[t].atomName)){d.atoms[t].displayMode=0}else{d.atoms[t].displayMode=1}}for(var g=0;g<d.molecules.length;g++){d.molecules[g].showSC=true}}}else{if(o==molmil.displayMode_BallStick){for(q=0;q<l.chains.length;q++){d=l.chains[q];d.displayMode=1;for(var t=0;t<d.atoms.length;t++){d.atoms[t].displayMode=2}for(var g=0;g<d.molecules.length;g++){d.molecules[g].displayMode=0;d.molecules[g].showSC=true}}}else{if(o==molmil.displayMode_BallStick_SC){for(q=0;q<l.chains.length;q++){d=l.chains[q];for(var t=0;t<d.atoms.length;t++){if(d.atoms[t].molecule.xna){w=u}else{w=s}if(!d.atoms[t].molecule.ligand&&!d.atoms[t].molecule.water&&w.hasOwnProperty(d.atoms[t].atomName)){d.atoms[t].displayMode=0}else{d.atoms[t].displayMode=2}}for(var g=0;g<d.molecules.length;g++){d.molecules[g].showSC=true}}}else{if(o==molmil.displayMode_Stick){for(q=0;q<l.chains.length;q++){d=l.chains[q];d.displayMode=1;for(var t=0;t<d.atoms.length;t++){d.atoms[t].displayMode=3}for(var g=0;g<d.molecules.length;g++){d.molecules[g].displayMode=0;d.molecules[g].showSC=true}}}else{if(o==molmil.displayMode_Stick_SC){for(q=0;q<l.chains.length;q++){d=l.chains[q];for(var t=0;t<d.atoms.length;t++){if(d.atoms[t].molecule.xna){w=u}else{w=s}if(!d.atoms[t].molecule.ligand&&!d.atoms[t].molecule.water&&w.hasOwnProperty(d.atoms[t].atomName)){d.atoms[t].displayMode=0}else{d.atoms[t].displayMode=3}}for(var g=0;g<d.molecules.length;g++){d.molecules[g].showSC=true;d.molecules[g].showSC=true}}}else{if(o==molmil.displayMode_Wireframe){for(q=0;q<l.chains.length;q++){d=l.chains[q];d.displayMode=1;for(var t=0;t<d.atoms.length;t++){d.atoms[t].displayMode=4}for(var g=0;g<d.molecules.length;g++){d.molecules[g].displayMode=0;d.molecules[g].showSC=true}}}else{if(o==molmil.displayMode_Wireframe_SC){for(q=0;q<l.chains.length;q++){d=l.chains[q];for(var t=0;t<d.atoms.length;t++){if(d.atoms[t].molecule.xna){w=u}else{w=s}if(!d.atoms[t].molecule.ligand&&!d.atoms[t].molecule.water&&w.hasOwnProperty(d.atoms[t].atomName)){d.atoms[t].displayMode=0}else{d.atoms[t].displayMode=4}}for(var g=0;g<d.molecules.length;g++){d.molecules[g].showSC=true;d.molecules[g].showSC=true}}}else{if(o==molmil.displayMode_CaTrace){for(q=0;q<l.chains.length;q++){d=l.chains[q];d.displayMode=1;for(g=0;g<d.molecules.length;g++){j=d.molecules[g];if(!j.ligand&&!j.water){for(t=0;t<j.atoms.length;t++){j.atoms[t].displayMode=0}}j.displayMode=1;j.showSC=false}}}else{if(o==molmil.displayMode_Tube){for(q=0;q<l.chains.length;q++){d=l.chains[q];d.displayMode=2;for(g=0;g<d.molecules.length;g++){j=d.molecules[g];if(!j.ligand&&!j.water){for(t=0;t<j.atoms.length;t++){j.atoms[t].displayMode=0}}j.displayMode=2;j.showSC=false}}}else{if(o==molmil.displayMode_Cartoon){for(q=0;q<l.chains.length;q++){d=l.chains[q];d.displayMode=3;for(g=0;g<d.molecules.length;g++){j=d.molecules[g];if(!j.ligand&&!j.water){for(t=0;t<j.atoms.length;t++){j.atoms[t].displayMode=0}}j.displayMode=3;j.showSC=false}}}else{if(o==molmil.displayMode_ChainSurfaceCG){for(q=0;q<l.chains.length;q++){d=l.chains[q];d.displayMode=molmil.displayMode_ChainSurfaceCG}}}}}}}}}}}}}}}}else{if(l instanceof molmil.chainObject){if(o==molmil.displayMode_None){l.display=false;l.displayMode=0;for(g=0;g<l.molecules.length;g++){j=l.molecules[g];j.displayMode=0;for(t=0;t<j.atoms.length;t++){j.atoms[t].displayMode=0}j.showSC=false}}else{if(o==molmil.displayMode_Default){l.displayMode=3;for(g=0;g<l.molecules.length;g++){j=l.molecules[g];if(j.ligand&&!j.water){for(t=0;t<j.atoms.length;t++){j.atoms[t].displayMode=3}}else{if(j.xna){for(t=0;t<j.atoms.length;t++){j.atoms[t].displayMode=h.hasOwnProperty(j.atoms[t].atomName)||j.atoms[t].element=="H"?0:3}}else{for(t=0;t<j.atoms.length;t++){j.atoms[t].displayMode=0}}}j.displayMode=3;j.showSC=false}}else{if(o==molmil.displayMode_Spacefill){l.displayMode=1;for(g=0;g<l.molecules.length;g++){j=l.molecules[g];j.displayMode=0;for(t=0;t<j.atoms.length;t++){j.atoms[t].displayMode=1}j.showSC=true}}else{if(o==molmil.displayMode_Spacefill_SC){for(g=0;g<l.molecules.length;g++){j=l.molecules[g];for(t=0;t<j.atoms.length;t++){if(j.xna){w=u}else{w=s}if(!j.ligand&&!j.water&&w.hasOwnProperty(j.atoms[t].atomName)){j.atoms[t].displayMode=0}else{j.atoms[t].displayMode=1}}j.showSC=true}}else{if(o==molmil.displayMode_BallStick){l.displayMode=1;for(g=0;g<l.molecules.length;g++){j=l.molecules[g];j.displayMode=0;for(t=0;t<j.atoms.length;t++){j.atoms[t].displayMode=2}j.showSC=true}}else{if(o==molmil.displayMode_BallStick_SC){for(g=0;g<l.molecules.length;g++){j=l.molecules[g];for(t=0;t<j.atoms.length;t++){if(j.xna){w=u}else{w=s}if(!j.ligand&&!j.water&&w.hasOwnProperty(j.atoms[t].atomName)){j.atoms[t].displayMode=0}else{j.atoms[t].displayMode=2}}j.showSC=true}}else{if(o==molmil.displayMode_Stick){l.displayMode=1;for(g=0;g<l.molecules.length;g++){j=l.molecules[g];j.displayMode=0;for(t=0;t<j.atoms.length;t++){j.atoms[t].displayMode=3}j.showSC=true}}else{if(o==molmil.displayMode_Stick_SC){for(g=0;g<l.molecules.length;g++){j=l.molecules[g];for(t=0;t<j.atoms.length;t++){if(j.xna){w=u}else{w=s}if(!j.ligand&&!j.water&&w.hasOwnProperty(j.atoms[t].atomName)){j.atoms[t].displayMode=0}else{j.atoms[t].displayMode=3}}j.showSC=true}}else{if(o==molmil.displayMode_Wireframe){l.displayMode=1;for(g=0;g<l.molecules.length;g++){j=l.molecules[g];j.displayMode=0;for(t=0;t<j.atoms.length;t++){j.atoms[t].displayMode=4}j.showSC=true}}else{if(o==molmil.displayMode_Wireframe_SC){l.displayMode=1;for(g=0;g<l.molecules.length;g++){j=l.molecules[g];for(t=0;t<j.atoms.length;t++){if(j.xna){w=u}else{w=s}if(!j.ligand&&!j.water&&w.hasOwnProperty(j.atoms[t].atomName)){j.atoms[t].displayMode=0}else{j.atoms[t].displayMode=4}}j.showSC=true}}else{if(o==molmil.displayMode_CaTrace){l.displayMode=1;for(g=0;g<l.molecules.length;g++){j=l.molecules[g];if(!j.ligand&&!j.water){for(t=0;t<j.atoms.length;t++){j.atoms[t].displayMode=0}}j.displayMode=1;j.showSC=false}}else{if(o==molmil.displayMode_Tube){l.displayMode=2;for(g=0;g<l.molecules.length;g++){j=l.molecules[g];if(!j.ligand&&!j.water){for(t=0;t<j.atoms.length;t++){j.atoms[t].displayMode=0}}j.displayMode=2;j.showSC=false}}else{if(o==molmil.displayMode_Cartoon){for(g=0;g<l.molecules.length;g++){j=l.molecules[g];if(!j.ligand&&!j.water){for(t=0;t<j.atoms.length;t++){j.atoms[t].displayMode=0}}j.displayMode=3;j.showSC=false}}else{if(o==molmil.displayMode_ChainSurfaceCG){l.displayMode=molmil.displayMode_ChainSurfaceCG}}}}}}}}}}}}}}}else{if(l instanceof molmil.molObject){if(o==molmil.displayMode_None){for(t=0;t<l.atoms.length;t++){l.atoms[t].displayMode=0}}else{if(o==molmil.displayMode_Default){if(l.ligand||l.water){for(t=0;t<l.atoms.length;t++){l.atoms[t].displayMode=3}}else{if(l.xna){for(t=0;t<l.atoms.length;t++){l.atoms[t].displayMode=h.hasOwnProperty(l.atoms[t].atomName)||l.atoms[t].element=="H"?0:3}}else{for(t=0;t<l.atoms.length;t++){l.atoms[t].displayMode=0}}}l.displayMode=3;l.showSC=false}else{if(o==molmil.displayMode_Spacefill){for(t=0;t<l.atoms.length;t++){l.atoms[t].displayMode=1}l.showSC=true}else{if(o==molmil.displayMode_Spacefill_SC){for(t=0;t<l.atoms.length;t++){if(l.xna){w=u}else{w=s}if(!l.ligand&&!l.water&&w.hasOwnProperty(l.atoms[t].atomName)){l.atoms[t].displayMode=0}else{l.atoms[t].displayMode=1}}l.showSC=true}else{if(o==molmil.displayMode_BallStick){for(t=0;t<l.atoms.length;t++){l.atoms[t].displayMode=2}l.showSC=true}else{if(o==molmil.displayMode_BallStick_SC){for(t=0;t<l.atoms.length;t++){if(l.xna){w=u}else{w=s}if(!l.ligand&&!l.water&&w.hasOwnProperty(l.atoms[t].atomName)){l.atoms[t].displayMode=0}else{l.atoms[t].displayMode=2}}l.showSC=true}else{if(o==molmil.displayMode_Stick){for(t=0;t<l.atoms.length;t++){l.atoms[t].displayMode=3}l.showSC=true}else{if(o==molmil.displayMode_Stick_SC){for(t=0;t<l.atoms.length;t++){if(l.xna){w=u}else{w=s}if(!l.ligand&&!l.water&&w.hasOwnProperty(l.atoms[t].atomName)){l.atoms[t].displayMode=0}else{l.atoms[t].displayMode=3}}l.showSC=true}else{if(o==molmil.displayMode_Wireframe){for(t=0;t<l.atoms.length;t++){l.atoms[t].displayMode=4}l.showSC=true}else{if(o==molmil.displayMode_Wireframe_SC){for(t=0;t<l.atoms.length;t++){if(l.xna){w=u}else{w=s}if(!l.ligand&&!l.water&&w.hasOwnProperty(l.atoms[t].atomName)){l.atoms[t].displayMode=0}else{l.atoms[t].displayMode=4}}l.showSC=true}else{if(o==molmil.displayMode_CaTrace){if(!l.ligand&&!l.water){for(t=0;t<l.atoms.length;t++){l.atoms[t].displayMode=0}}l.displayMode=1;l.showSC=false}else{if(o==molmil.displayMode_Tube){if(!l.ligand&&!l.water){for(t=0;t<l.atoms.length;t++){l.atoms[t].displayMode=0}}l.displayMode=2;l.showSC=false}else{if(o==molmil.displayMode_Cartoon){if(!l.ligand&&!l.water){for(t=0;t<l.atoms.length;t++){l.atoms[t].displayMode=0}}l.displayMode=3;l.showSC=false}}}}}}}}}}}}}}else{if(l instanceof molmil.atomObject){if(o==molmil.displayMode_Spacefill){l.displayMode=1}else{if(o==molmil.displayMode_BallStick){l.displayMode=2}else{if(o==molmil.displayMode_Stick){l.displayMode=3}else{if(o==molmil.displayMode_Wireframe){l.displayMode=4}}}}}else{if(l instanceof molmil.polygonObject){l.display=o?true:false}}}}}if(f){p.renderer.initBuffers();p.renderer.canvas.update=true}};molmil.colorEntry=function(n,u,w,f,p){p=p||molmil.cli_soup;if(n instanceof Array){for(var o=0;o<n.length;o++){molmil.colorEntry(n[o],u,w)}if(f){p.renderer.initBuffers();p.renderer.canvas.update=true}return}var g,t,s,d,l,s,d,q;if(n instanceof molmil.entryObject){if(u==molmil.colorEntry_Default){for(s=0;s<n.chains.length;s++){d=n.chains[s];d.rgba=[255,255,255,255];for(g=0;g<d.molecules.length;g++){l=d.molecules[g];l.rgba=molmil_dep.getKeyFromObject(molmil.configBox.sndStrucColor,l.sndStruc,molmil.configBox.sndStrucColor[1]);for(t=0;t<l.atoms.length;t++){l.atoms[t].rgba=molmil_dep.getKeyFromObject(molmil.configBox.elementColors,l.atoms[t].element,molmil.configBox.elementColors.DUMMY)}}}}else{if(u==molmil.colorEntry_Structure){for(s=0;s<n.chains.length;s++){d=n.chains[s];for(g=0;g<d.molecules.length;g++){l=d.molecules[g];l.rgba=molmil_dep.getKeyFromObject(molmil.configBox.sndStrucColor,l.sndStruc,molmil.configBox.sndStrucColor[1]);for(t=0;t<l.atoms.length;t++){l.atoms[t].rgba=l.rgba}}}}else{if(u==molmil.colorEntry_CPK){for(s=0;s<n.chains.length;s++){d=n.chains[s];for(g=0;g<d.molecules.length;g++){l=d.molecules[g];for(t=0;t<l.atoms.length;t++){l.atoms[t].rgba=molmil_dep.getKeyFromObject(molmil.configBox.elementColors,l.atoms[t].element,molmil.configBox.elementColors.DUMMY)}l.rgba=molmil_dep.getKeyFromObject(molmil.configBox.elementColors,"C",molmil.configBox.elementColors.DUMMY)}}}else{if(u==molmil.colorEntry_Group){q=[];for(s=0;s<n.chains.length;s++){d=n.chains[s];if(d.molecules.length>1){q=molmil.interpolateBR(d.molecules.length)}else{q=[[0,0,255,255]]}for(g=0;g<d.molecules.length;g++){l=d.molecules[g];l.rgba=q[g];for(t=0;t<l.atoms.length;t++){l.atoms[t].rgba=q[g]}}}}else{if(u==molmil.colorEntry_Chain){q=molmil.interpolateBR(n.chains.length);for(s=0;s<n.chains.length;s++){d=n.chains[s];d.rgba=q[s];for(g=0;g<d.molecules.length;g++){l=d.molecules[g];l.rgba=q[s];for(t=0;t<l.atoms.length;t++){l.atoms[t].rgba=q[s]}}}}else{if(u==molmil.colorEntry_Custom){for(s=0;s<n.chains.length;s++){d=n.chains[s];d.rgba=w;for(g=0;g<d.molecules.length;g++){l=d.molecules[g];l.rgba=w;for(t=0;t<l.atoms.length;t++){l.atoms[t].rgba=w}}}}else{if(u==molmil.colorEntry_ChainAlt){q=molmil.configBox.bu_colors;var h=0;for(s=0;s<n.chains.length;s++){d=n.chains[s];d.rgba=[q[h][0],q[h][1],q[h][2],255];h++;for(g=0;g<d.molecules.length;g++){l=d.molecules[g];l.rgba=n.chains[s].rgba;for(t=0;t<l.atoms.length;t++){l.atoms[t].rgba=n.chains[s].rgba}}if(h>=q.length){h=0}}}}}}}}}}else{if(n instanceof molmil.chainObject){if(u==molmil.colorEntry_Default){n.rgba=[255,255,255,255];for(g=0;g<n.molecules.length;g++){l=n.molecules[g];l.rgba=molmil_dep.getKeyFromObject(molmil.configBox.sndStrucColor,l.sndStruc,molmil.configBox.sndStrucColor[1]);for(t=0;t<l.atoms.length;t++){l.atoms[t].rgba=molmil_dep.getKeyFromObject(molmil.configBox.elementColors,l.atoms[t].element,molmil.configBox.elementColors.DUMMY)}}}else{if(u==molmil.colorEntry_Structure){for(g=0;g<n.molecules.length;g++){l=n.molecules[g];l.rgba=molmil_dep.getKeyFromObject(molmil.configBox.sndStrucColor,l.sndStruc,molmil.configBox.sndStrucColor[1]);for(t=0;t<l.atoms.length;t++){l.atoms[t].rgba=l.rgba}}}else{if(u==molmil.colorEntry_CPK){for(g=0;g<n.molecules.length;g++){l=n.molecules[g];for(t=0;t<l.atoms.length;t++){l.atoms[t].rgba=molmil_dep.getKeyFromObject(molmil.configBox.elementColors,l.atoms[t].element,molmil.configBox.elementColors.DUMMY)}l.rgba=molmil_dep.getKeyFromObject(molmil.configBox.elementColors,"C",molmil.configBox.elementColors.DUMMY)}}else{if(u==molmil.colorEntry_Group){q=[];d=n;if(d.molecules.length>1){q=molmil.interpolateBR(d.molecules.length)}else{q=[[1,1,1]]}for(g=0;g<d.molecules.length;g++){l=d.molecules[g];l.rgba=q[g];for(t=0;t<l.atoms.length;t++){l.atoms[t].rgba=q[g]}}}else{if(u==molmil.colorEntry_Custom){n.rgba=w;for(g=0;g<n.molecules.length;g++){l=n.molecules[g];l.rgba=w;for(t=0;t<l.atoms.length;t++){l.atoms[t].rgba=w}}}}}}}}else{if(n instanceof molmil.molObject){if(u==molmil.colorEntry_Default){l=n;l.rgba=molmil_dep.getKeyFromObject(molmil.configBox.sndStrucColor,l.sndStruc,molmil.configBox.sndStrucColor[1]);for(t=0;t<l.atoms.length;t++){l.atoms[t].rgba=molmil_dep.getKeyFromObject(molmil.configBox.elementColors,l.atoms[t].element,molmil.configBox.elementColors.DUMMY)}}else{if(u==molmil.colorEntry_Structure){l=n;l.rgba=molmil_dep.getKeyFromObject(molmil.configBox.sndStrucColor,l.sndStruc,molmil.configBox.sndStrucColor[1]);for(t=0;t<l.atoms.length;t++){l.atoms[t].rgba=l.rgba}}else{if(u==molmil.colorEntry_CPK){l=n;for(t=0;t<l.atoms.length;t++){l.atoms[t].rgba=molmil_dep.getKeyFromObject(molmil.configBox.elementColors,l.atoms[t].element,molmil.configBox.elementColors.DUMMY)}l.rgba=molmil_dep.getKeyFromObject(molmil.configBox.elementColors,"C",molmil.configBox.elementColors.DUMMY)}else{if(u==3.2){l=n;for(t=0;t<l.atoms.length;t++){l.atoms[t].rgba=molmil_dep.getKeyFromObject(molmil.configBox.elementColors,l.atoms[t].element,molmil.configBox.elementColors.DUMMY)}}else{if(u==molmil.colorEntry_Custom){n.rgba=w;for(t=0;t<n.atoms.length;t++){n.atoms[t].rgba=n.rgba}}}}}}}else{if(n instanceof molmil.atomObject){if(u==molmil.colorEntry_Default||u==molmil.colorEntry_CPK){n.rgba=molmil_dep.getKeyFromObject(molmil.configBox.elementColors,n.element,molmil.configBox.elementColors.DUMMY)}else{if(u==molmil.colorEntry_Structure){l=n.molecule;n.rgba=molmil_dep.getKeyFromObject(molmil.configBox.sndStrucColor,l.sndStruc,molmil.configBox.sndStrucColor[1])}else{if(u==molmil.colorEntry_Custom){n.rgba=w}}}}else{if(n instanceof molmil.polygonObject){}else{return}}}}}if(f){p.renderer.initBuffers();p.renderer.canvas.update=true}};molmil.getAtomFromMolecule=function(c,f){for(var d=0;d<c.atoms.length;d++){if(c.atoms[d].atomName==f){return c.atoms[d]}}return null};molmil.resetColors=function(i,g){g=g||molmil.cli_soup;for(var d=0,f,l,j,h;d<g.structures.length;d++){if(i&&g.structures[d]!=i){continue}if(!g.structures[d].chains){continue}for(l=0;l<g.structures[d].chains.length;l++){h=g.structures[d].chains[l];for(f=0;f<h.atoms.length;f++){h.atoms[f].rgba=molmil_dep.getKeyFromObject(molmil.configBox.elementColors,h.atoms[f].element,molmil.configBox.elementColors.DUMMY)}for(j=0;j<h.molecules.length;j++){h.molecules[j].rgba=molmil_dep.getKeyFromObject(molmil.configBox.sndStrucColor,h.molecules[j].sndStruc,molmil.configBox.sndStrucColor[1])}}}};molmil.fetchFrom=function(g,f){var c=[],d;if(g instanceof Array){for(d=0;d<g.length;d++){c=c.concat(molmil.getProteinChains(g[d],f))}}else{if(g instanceof molmil.atomObject){if(f==molmil.molObject){c.push(g.molecule)}else{if(f==molmil.chainObject){c.push(g.chain)}else{if(f==molmil.entryObject){c.push(g.chain.entry)}}}}else{if(g instanceof molmil.molObject){if(f==molmil.atomObject){c=c.concat(g.atoms)}else{if(f==molmil.chainObject){c.push(g.chain)}else{if(f==molmil.entryObject){c.push(g.chain.entry)}}}}else{if(g instanceof molmil.chainObject){if(f==molmil.atomObject){c=c.concat(g.atoms)}else{if(f==molmil.molObject){c=c.concat(g.molecules)}else{if(f==molmil.entryObject){c.push(g.entry)}}}}else{if(g instanceof molmil.entryObject){if(f==molmil.atomObject){for(d=0;d<g.chains.length;d++){c=c.concat(g.atoms[d])}}else{if(f==molmil.molObject){for(d=0;d<g.chains.length;d++){c=c.concat(g.molecules[d])}}else{if(f==molmil.chainObject){c=c.concat(g.chains)}}}}}}}}return c.unique()};molmil.getProteinChains=function(g){var d=[];if(g instanceof Array){for(var f=0;f<g.length;f++){d=d.concat(molmil.getProteinChains(g[f]))}}else{if(g instanceof molmil.entryObject){for(var h=0;h<g.chains.length;h++){if(!g.chains[h].isHet&&g.chains[h].molecules.length&&!g.chains[h].molecules[0].water){d.push(g.chains[h])}}}else{if(g instanceof molmil.chainObj){if(!g.isHet&&g.molecules.length&&!g.molecules[0].water){d.push(g)}}}}return d};molmil.setCanvas=function(d,c){d.canvas=c;if(!c.renderer){d.renderer=c.renderer=new molmil.render(d)}};molmil.initTexture=function(d){var c=this.gl.createTexture();c.image=new Image();c.image.texture=c;c.loaded=false;c.image.onload=function(){molmil.handleLoadedTexture(this.texture)};c.image.src=d;return c};molmil.handleLoadedTexture=function(c){this.gl.bindTexture(this.gl.TEXTURE_2D,c);this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,true);this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,c.image);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE);this.gl.bindTexture(this.gl.TEXTURE_2D,null);c.loaded=true};molmil.safeStartViewer=function(c){for(var d in c.textures){if(!c.textures[d].loaded){return molmil_dep.asyncStart(molmil.safeStartViewer,[c],null,100)}}molmil.canvasList.push(c);if(document.body.classList!==undefined){document.body.classList.add("entryLoaded")}};molmil.animate_molmilViewers=function(){molmil.settings.animationFrameID=requestAnimationFrame(molmil.animate_molmilViewers);for(var d=0;d<molmil.canvasList.length;d++){molmil.canvasList[d].renderer.render()}};molmil.unproject=function(d,c,g,f){d=2*d-1;c=2*c-1;g=2*g-1;var h=[d,c,g,1];vec4.transformMat4(h,h,f);h[3]=1/h[3];return[h[0]*h[3],h[1]*h[3],h[2]*h[3]]};molmil.loadShader=function(h,d){var f=new molmil_dep.CallRemote("GET");f.Send(h);var g=f.request.responseText.split("//#");var c=JSON.parse(g[0]);c.vertexShader=g[1].substr(7);c.fragmentShader=g[2].substr(9);if(!d){d=""}if(molmil.configBox.glsl_fog){d+="#define ENABLE_FOG 1\n"}c.vertexShader=d+c.vertexShader;c.fragmentShader=d+c.fragmentShader;return c};molmil.setupShader=function(i,d,c,h,f){var g=i.createShader(f);i.shaderSource(g,h);i.compileShader(g);if(!i.getShaderParameter(g,i.COMPILE_STATUS)){console.log(d+":\n"+i.getShaderInfoLog(g));return null}i.attachShader(c,g);return g};molmil.hermiteInterpolate=function(d,c,n,j,g,z,p,u){var x,y,w,q,o,l,i,h,f;for(x=0;x<(g+(u?2:1));x+=1){y=x/(g+1);w=y*y;q=w*y;o=2*q-3*w+1;l=-2*q+3*w;i=q-2*w+y;h=q-w;z.push([(d[0]*o)+(c[0]*l)+(n[0]*i)+(j[0]*h),(d[1]*o)+(c[1]*l)+(n[1]*i)+(j[1]*h),(d[2]*o)+(c[2]*l)+(n[2]*i)+(j[2]*h)])}for(x=0;x<(g+(u?2:1));x+=1){y=x/(g+1);w=y*y;o=6*(w-y);l=6*(-w+y);i=3*w-4*y+1;h=3*w-2*y;f=[(d[0]*o)+(c[0]*l)+(n[0]*i)+(j[0]*h),(d[1]*o)+(c[1]*l)+(n[1]*i)+(j[1]*h),(d[2]*o)+(c[2]*l)+(n[2]*i)+(j[2]*h)];vec3.normalize(f,f);p.push(f)}};molmil.octaSphereBuilder=function(l){var p=[],h=[],o=0,j,n,y,x,u,s,z,d,g,w,q={};d=function(c,i,f){g=Math.sqrt(c*c+i*i+f*f);p.push([c/g,i/g,f/g]);return o++};w=function(C,A){var c=C<A;smallerIndex=c?C:A;greaterIndex=c?A:C;key=[smallerIndex,greaterIndex];ret=molmil_dep.getKeyFromObject(q,key,null);if(ret!=null){return ret}var B=p[C];var t=p[A];var f=d((B[0]+t[0])*0.5,(B[1]+t[1])*0.5,(B[2]+t[2])*0.5);q[key]=f;return f};d(-1,1,0);d(1,1,0);d(1,-1,0);d(-1,-1,0);d(0,0,-1);d(0,0,1);h.push([0,1,4]);h.push([1,2,4]);h.push([2,3,4]);h.push([3,0,4]);h.push([5,1,0]);h.push([5,2,1]);h.push([5,3,2]);h.push([5,0,3]);for(j=0;j<l;j++){y=[];for(n=0;n<h.length;n++){x=w(h[n][0],h[n][1]);u=w(h[n][1],h[n][2]);s=w(h[n][2],h[n][0]);y.push([h[n][0],x,s]);y.push([h[n][1],u,x]);y.push([h[n][2],s,u]);y.push([x,u,s])}h=y}return{vertices:p,faces:h}};molmil.buildOctaDome=function(p,l){var c=molmil.octaSphereBuilder(p),s,q,o,h,n=[],f;for(var g=0;g<c.vertices.length;g++){s=c.vertices[4][0]-c.vertices[g][0];q=c.vertices[4][1]-c.vertices[g][1];o=c.vertices[4][2]-c.vertices[g][2];h=s*s+q*q+o*o;if((l==0&&h>2.00001)||(l==1&&h<1.99999)){n.push(g)}}for(var g=n.length-1;g>-1;g--){c.vertices.splice(n[g],1)}for(g=0;g<c.faces.length;g++){if(n.indexOf(c.faces[g][0])!=-1||n.indexOf(c.faces[g][1])!=-1||n.indexOf(c.faces[g][2])!=-1){c.faces.splice(g,1);g-=1}else{for(f=0;f<c.faces[g].length;f++){for(k=n.length-1;k>-1;k--){if(c.faces[g][f]>n[k]){c.faces[g][f]-=1}}}}}return c};molmil.buildBondsList4Molecule=function(j,i,l){var q,o,n,c,f,d,h,g,p=molmil.configBox.vdwR;for(f=0;f<i.atoms.length;f++){for(d=f+1;d<i.atoms.length;d++){if(i.atoms[f].label_alt_id!=i.atoms[d].label_alt_id&&i.atoms[f].label_alt_id!=null&&i.atoms[d].label_alt_id!=null){continue}h=i.atoms[f].xyz;g=i.atoms[d].xyz;q=l[h]-l[g];q*=q;o=l[h+1]-l[g+1];o*=o;n=l[h+2]-l[g+2];n*=n;c=q+o+n;maxDistance=3.24;if(p[i.atoms[f].element]===undefined||p[i.atoms[f].element]>=1.8){if(p[i.atoms[d].element]===undefined||p[i.atoms[d].element]>=1.8){maxDistance=6}else{maxDistance=4.5}}else{if(p[i.atoms[d].element]===undefined||p[i.atoms[d].element]>=1.8){if(p[i.atoms[f].element]===undefined||p[i.atoms[f].element]>=1.8){maxDistance=6}else{maxDistance=4.5}}else{if(i.atoms[f].element=="H"||i.atoms[d].element=="H"||i.atoms[f].element=="D"||i.atoms[d].element=="D"){maxDistance=1.6}}}if(c<=maxDistance){j.push([i.atoms[f],i.atoms[d],1])}}}};molmil.isBlackListed=function(){if(molmil.ignoreBlackList){return false}if(navigator.userAgent.indexOf("Mac OS X 10.6")!=-1){return true}else{if(navigator.userAgent.indexOf("Mac OS X 10_6")!=-1){return true}}return false};molmil.addEnableMolmilButton=function(c){c.renderer=c.molmilViewer.renderer;var f=molmil_dep.dcE("DIV");var d=f.pushNode(molmil_dep.createButton("Enable"));c.style.display="none";c.parentNode.pushNode(f);d.onclick=function(){molmil.ignoreBlackList=true;molmil_dep.reloadPage()};return f};molmil.createViewer=function(j,g,c,i,f){var d;var h=window.devicePixelRatio||1;if(j.tagName.toLowerCase()=="canvas"){d=j}else{d=j.pushNode("canvas")}g=g||d.width;c=c||d.height;d.width=g*h;d.height=c*h;d.defaultSize=[g,c];d.style.width=g+"px";d.style.height=c+"px";d.setSize=function(l,n){var o=window.devicePixelRatio||1;this.renderer.width=this.width=l*o;this.renderer.height=this.height=n*o;this.style.width=l+"px";this.style.height=n+"px";this.renderer.resizeViewPort();this.update=true;this.renderer.render()};if(i){d.molmilViewer=i;molmil.setCanvas(i,d);d.molmilViewer.renderer.camera=d.molmilViewer.defaultCanvas[1].camera;d.molmilViewer.renderer.QLV=d.molmilViewer.defaultCanvas[1].QLV}else{d.molmilViewer=new molmil.viewer(d);if(molmil.isBlackListed()){return molmil.addEnableMolmilButton(d)}}if(!d.molmilViewer.renderer.initGL(d)){return d.molmilViewer.renderer.altCanvas}d.style.backgroundColor="rgb("+Math.round(molmil.configBox.BGCOLOR[0]*255)+", "+Math.round(molmil.configBox.BGCOLOR[1]*255)+", "+Math.round(molmil.configBox.BGCOLOR[2]*255)+")";if(!f){d.molmilViewer.UI.init()}d.molmilViewer.renderer.initRenderer();if(i){d.renderer.initBuffers();d.update=true;molmil.safeStartViewer(d)}return d};molmil.selectQLV=function(f,c,d){c=Math.min(Math.max(c,0),molmil.configBox.QLV_SETTINGS.length-1);f.QLV=c;if(d){f.initBuffers();f.canvas.update=true}};molmil.interpolateBR=function(f){if(f==1){return[[0,0,255,255]]}var g=[],d;for(var c=0;c<f;c++){d=molmil.hslToRgb123((1-(c/(f-1)))*(2/3),1,0.5);g.push([d[0]*255,d[1]*255,d[2]*255,255])}return g};molmil.resetCOG=function(d,c){if(c){d.molmilViewer.calculateCOG()}d.molmilViewer.avgXYZ=[d.molmilViewer.avgX,d.molmilViewer.avgY,d.molmilViewer.avgZ];d.molmilViewer.stdXYZ=[d.molmilViewer.stdX,d.molmilViewer.stdY,d.molmilViewer.stdZ];d.molmilViewer.COR=d.molmilViewer.avgXYZ;d.renderer.camera.z=d.molmilViewer.calcZ()};molmil.loadFile=function(h,g,c,f,d){d=d||molmil.cli_soup;d.loadStructure(h,g,c||function(i,j){molmil.displayEntry(j,1);molmil.colorEntry(j,1,null,true,d)},{async:f?true:false})};molmil.loadPDB=function(d,c,g,f){f=f||molmil.cli_soup;f.loadStructure(molmil.settings.pdb_url.replace("__ID__",d),1,c||function(h,i){if(f.AID>150000&&(navigator.userAgent.toLowerCase().indexOf("mobile")!=-1||navigator.userAgent.toLowerCase().indexOf("android")!=-1||window.navigator.msMaxTouchPoints)){molmil.displayEntry(i,molmil.displayMode_Wireframe)}else{molmil.displayEntry(i,1)}molmil.colorEntry(i,1,null,true,f)},{async:g?true:false})};molmil.loadCC=function(g,c,f,d){d=d||molmil.cli_soup;d.loadStructure(molmil.settings.comp_url.replace("__ID__",g),1,c||function(h,i){molmil.displayEntry(i,1);molmil.colorEntry(i,1,null,true,d)},{async:f?true:false})};molmil.clear=function(c){c=c||molmil.cli_canvas;c.molmilViewer.clear();c.renderer.initBuffers();c.renderer.camera.reset();c.update=true;if(document.body.classList!==undefined){document.body.classList.remove("entryLoaded")}};molmil.coarseSurface=function(ac,Q,ah){var B=Q*0.5;var C=1/Q;var M=ac.atoms;var ag=ac.modelsXYZ[0];var w=[1e+99,-1e+99,1e+99,-1e+99,1e+99,-1e+99],af,ab,o={},Y,X,W,N,L,K,t,A={},O={},p=[0,0,0,0,0,0],u,D,s=molmil.configBox.vdwR,U,J,I,F,S,H,g,z,V,P,q,n,l,f,y,x;for(af=0;af<M.length;af++){ab=ag[M[af].xyz];if(ab<w[0]){w[0]=ab}if(ab>w[1]){w[1]=ab}ab=ag[M[af].xyz+1];if(ab<w[2]){w[2]=ab}if(ab>w[3]){w[3]=ab}ab=ag[M[af].xyz+2];if(ab<w[4]){w[4]=ab}if(ab>w[5]){w[5]=ab}o[M[af].element]=1}Y=Math.ceil((w[1]-w[0]+(2*ah)+(2*1.8))/Q)+2;X=Math.ceil((w[3]-w[2]+(2*ah)+(2*1.8))/Q)+2;W=Math.ceil((w[5]-w[4]+(2*ah)+(2*1.8))/Q)+2;N=-w[0]+ah+1.8+Q;L=-w[2]+ah+1.8+Q;K=-w[4]+ah+1.8+Q;t=Y*X*W;for(af in o){A[af]=new Float32Array(t);O[af]=[];for(S=0;S<t;S++){A[af][S]=1e+99;O[af].push(null)}o[af]=molmil_dep.getKeyFromObject(s,af,s.DUMMY)}for(af=0;af<M.length;af++){u=A[M[af].element];D=O[M[af].element];U=o[M[af].element];J=ag[M[af].xyz]+N;I=ag[M[af].xyz+1]+L;F=ag[M[af].xyz+2]+K;p[0]=Math.min(0,Math.floor(J-U-ah));p[1]=Math.max(Math.ceil(J+U+ah),Y);p[2]=Math.min(0,Math.floor(I-U-ah));p[3]=Math.max(Math.ceil(I+U+ah),X);p[4]=Math.min(0,Math.floor(F-U-ah));p[5]=Math.max(Math.ceil(F+U+ah),W);p[0]=0;p[1]=Y;p[2]=0;p[3]=X;p[4]=0;p[5]=W;for(S=p[0];S<p[1];S++){V=S*Q;for(H=p[2];H<p[3];H++){P=H*Q;for(g=p[4];g<p[5];g++){q=g*Q;z=S+Y*(H+X*g);n=J-V;l=I-P;f=F-q;ab=n*n+l*l+f*f;if(ab<u[z]){u[z]=ab;D[z]=[n,l,f,U,J,I,F]}}}}}y=new Float32Array(t);x=new Float32Array(t*3);for(S=0;S<t;S++){z=1e+99;J=I=F=null;for(af in o){U=Math.sqrt(A[af][S]);ab=U;U-=ah+O[af][S][3];if(U<z){ab=1/ab;J=O[af][S][0]*ab*U*C;I=O[af][S][1]*ab*U*C;F=O[af][S][2]*ab*U*C;z=U}}U=S*3;y[S]=z*C;x[U]=J;x[U+1]=I;x[U+2]=F}var R=function(i,ai,j){var c=i+Y*(ai+X*j);return y[c]};var d=function(i,ai,j){var c=i+Y*(ai+X*j);c*=3;return[x[c],x[c+1],x[c+2]]};var E=molmil.surfaceNets([Y,X,W],R,d);var T=[],h=[],aa,Z,af=[0,0,0],ae=[0,0,0],ad;for(aa=0;aa<E.vertices.length;aa++){h.push([])}for(aa=0;aa<E.faces.length;aa++){af[0]=E.vertices[E.faces[aa][1]][0]-E.vertices[E.faces[aa][0]][0];af[1]=E.vertices[E.faces[aa][1]][1]-E.vertices[E.faces[aa][0]][1];af[2]=E.vertices[E.faces[aa][1]][2]-E.vertices[E.faces[aa][0]][2];ae[0]=E.vertices[E.faces[aa][2]][0]-E.vertices[E.faces[aa][0]][0];ae[1]=E.vertices[E.faces[aa][2]][1]-E.vertices[E.faces[aa][0]][1];ae[2]=E.vertices[E.faces[aa][2]][2]-E.vertices[E.faces[aa][0]][2];T.push([af[1]*ae[2]-af[2]*ae[1],af[2]*ae[0]-af[0]*ae[2],af[0]*ae[1]-af[1]*ae[0]]);h[E.faces[aa][0]].push(aa);h[E.faces[aa][1]].push(aa);h[E.faces[aa][2]].push(aa)}var G=[];for(aa=0;aa<E.vertices.length;aa++){af=[0,0,0];for(Z=0;Z<h[aa].length;Z++){af[0]+=T[h[aa][Z]][0];af[1]+=T[h[aa][Z]][1];af[2]+=T[h[aa][Z]][2]}vec3.normalize(af,af);G.push(af)}molmil.taubinSmoothing(G,E.faces,0.33,-0.331,50);for(aa=0;aa<G.length;aa++){vec3.normalize(G[aa],G[aa])}for(aa=0;aa<G.length;aa++){E.vertices[aa][0]=((E.vertices[aa][0]-G[aa][0]*ah*0.15)*Q)-N;E.vertices[aa][1]=((E.vertices[aa][1]-G[aa][1]*ah*0.15)*Q)-L;E.vertices[aa][2]=((E.vertices[aa][2]-G[aa][2]*ah*0.15)*Q)-K}molmil.taubinSmoothing(E.vertices,E.faces,0.33,-0.331,50);E.normals=G;return E};molmil.taubinSmoothing=function(q,d,p,x,s){var l,o,u,j=[0,0,0,0],c,h;var t=[],n=[];for(u=0;u<q.length;u++){t.push({});n.push([0,0,0])}for(o=0;o<d.length;o++){t[d[o][0]][d[o][1]]=true;t[d[o][0]][d[o][2]]=true;t[d[o][1]][d[o][0]]=true;t[d[o][1]][d[o][2]]=true;t[d[o][2]][d[o][0]]=true;t[d[o][2]][d[o][1]]=true}for(u=0;u<q.length;u++){t[u]=Object.keys(t[u])}var w=function(f){for(u=0;u<q.length;u++){j[0]=0;j[1]=0;j[2]=0;j[3]=0;for(l=0;l<t[u].length;l++){c=q[t[u][l]];j[0]+=c[0];j[1]+=c[1];j[2]+=c[2];j[3]+=1}if(j[3]==0){continue}h=1/j[3];j[0]*=h;j[1]*=h;j[2]*=h;n[u][0]=q[u][0]+f*(j[0]-q[u][0]);n[u][1]=q[u][1]+f*(j[1]-q[u][1]);n[u][2]=q[u][2]+f*(j[2]-q[u][2])}};for(var g=0;g<s;g++){w(p);for(u=0;u<q.length;u++){q[u][0]=n[u][0];q[u][1]=n[u][1];q[u][2]=n[u][2]}w(x);for(u=0;u<q.length;u++){q[u][0]=n[u][0];q[u][1]=n[u][1];q[u][2]=n[u][2]}}};var sn_cube_edges=new Int32Array(24),sn_edge_table=new Int32Array(256);(function(){var f=0;for(var l=0;l<8;++l){for(var g=1;g<=4;g<<=1){var n=l^g;if(l<=n){sn_cube_edges[f++]=l;sn_cube_edges[f++]=n}}}for(var l=0;l<256;++l){var h=0;for(var g=0;g<24;g+=2){var d=!!(l&(1<<sn_cube_edges[g])),c=!!(l&(1<<sn_cube_edges[g+1]));h|=d!==c?(1<<(g>>1)):0}sn_edge_table[l]=h}})();var sn_buffer=new Array(4096);(function(){for(var c=0;c<sn_buffer.length;++c){sn_buffer[c]=0}})();molmil.surfaceNets=function(H,F,h,t){if(!t){t=[[0,0,0],H]}var U=[0,0,0];var O=[0,0,0];for(var N=0;N<3;++N){U[N]=(t[1][N]-t[0][N])/H[N];O[N]=t[0][N]}var s=[],d=[],I=0,z=[0,0,0],q=[1,(H[0]+1),(H[0]+1)*(H[1]+1)],c=[0,0,0,0,0,0,0,0],Q=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],T=1;if(q[2]*2>sn_buffer.length){var B=sn_buffer.length;sn_buffer.length=q[2]*2;while(B<sn_buffer.length){sn_buffer[B++]=0}}for(z[2]=0;z[2]<H[2]-1;++z[2],I+=H[0],T^=1,q[2]=-q[2]){var J=1+(H[0]+1)*(1+T*(H[1]+1));for(z[1]=0;z[1]<H[1]-1;++z[1],++I,J+=2){for(z[0]=0;z[0]<H[0]-1;++z[0],++I,++J){var M=0,P=0;for(var K=0;K<2;++K){for(var L=0;L<2;++L){for(var N=0;N<2;++N,++P){var G=F(z[0]+N,z[1]+L,z[2]+K);c[P]=G;Q[P][0]=z[0]+N;Q[P][1]=z[1]+L;Q[P][2]=z[2]+K;M|=(G<0)?(1<<P):0}}}if(M===0||M===255){continue}var E=sn_edge_table[M];var y=[0,0,0],f=0,S;for(var N=0;N<12;++N){if(!(E&(1<<N))){continue}var w=sn_cube_edges[N<<1],u=sn_cube_edges[(N<<1)+1];S=h(Q[w][0],Q[w][1],Q[w][2]);y[0]+=Q[w][0]+S[0];y[1]+=Q[w][1]+S[1];y[2]+=Q[w][2]+S[2];S=h(Q[u][0],Q[u][1],Q[u][2]);y[0]+=Q[u][0]+S[0];y[1]+=Q[u][1]+S[1];y[2]+=Q[u][2]+S[2];f+=2}y[0]/=f;y[1]/=f;y[2]/=f;var A=[0,0,0];for(var N=0;N<3;++N){A[N]=U[N]*y[N]+O[N]}sn_buffer[J]=s.length;s.push(A);for(var N=0;N<3;++N){if(!(E&(1<<N))){continue}var o=(N+1)%3,l=(N+2)%3;if(z[o]===0||z[l]===0){continue}var D=q[o],C=q[l];if(M&1){d.push([sn_buffer[J],sn_buffer[J-D],sn_buffer[J-C]]);d.push([sn_buffer[J-C],sn_buffer[J-D],sn_buffer[J-D-C]])}else{d.push([sn_buffer[J],sn_buffer[J-C],sn_buffer[J-D]]);d.push([sn_buffer[J-D],sn_buffer[J-C],sn_buffer[J-D-C]])}}}}}return{vertices:s,faces:d}};molmil.surfaceNets2=function(f,G,F){if(!F){F=[[0,0,0],f]}var D=[0,0,0];var C=[0,0,0];for(var W=0;W<3;++W){D[W]=(F[1][W]-F[0][W])/f[W];C[W]=F[0][W]}var c=[],u=[],O=0,H=[0,0,0],q=[1,(f[0]+1),(f[0]+1)*(f[1]+1)],J=[0,0,0,0,0,0,0,0],M=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],w=1;if(q[2]*2>sn_buffer.length){var E=sn_buffer.length;sn_buffer.length=q[2]*2;while(E<sn_buffer.length){sn_buffer[E++]=0}}for(H[2]=0;H[2]<f[2]-1;++H[2],O+=f[0],w^=1,q[2]=-q[2]){var P=1+(f[0]+1)*(1+w*(f[1]+1));for(H[1]=0;H[1]<f[1]-1;++H[1],++O,P+=2){for(H[0]=0;H[0]<f[0]-1;++H[0],++O,++P){var Q=0,X=0;for(var S=0;S<2;++S){for(var U=0;U<2;++U){for(var W=0;W<2;++W,++X){var N=G(H[0]+W,H[1]+U,H[2]+S);J[X]=N;M[X][0]=H[0]+W;M[X][1]=H[1]+U;M[X][2]=H[2]+S;Q|=(N<0)?(1<<X):0}}}if(Q===0||Q===255){continue}var h=sn_edge_table[Q],I=[0,0,0],d=0;for(var W=0;W<12;++W){if(!(h&(1<<W))){continue}++d;var B=sn_cube_edges[W<<1],A=sn_cube_edges[(W<<1)+1],V=J[B],T=J[A],K=V-T;if(Math.abs(K)>0.000001){K=V/K}else{continue}for(var U=0,S=1;U<3;++U,S<<=1){var Z=B&S,Y=A&S;if(Z!==Y){I[U]+=Z?1-K:K}else{I[U]+=Z?1:0}}}var L=1/d;for(var W=0;W<3;++W){I[W]=D[W]*(H[W]+L*I[W])+C[W]}sn_buffer[P]=c.length;c.push(I);for(var W=0;W<3;++W){if(!(h&(1<<W))){continue}var z=(W+1)%3,y=(W+2)%3;if(H[z]===0||H[y]===0){continue}var o=q[z],l=q[y];if(Q&1){u.push([sn_buffer[P],sn_buffer[P-o],sn_buffer[P-l]]);u.push([sn_buffer[P-l],sn_buffer[P-o],sn_buffer[P-o-l]])}else{u.push([sn_buffer[P],sn_buffer[P-l],sn_buffer[P-o]]);u.push([sn_buffer[P-o],sn_buffer[P-l],sn_buffer[P-o-l]])}}}}}return{vertices:c,faces:u}};molmil.lighterRGB=function(h,d,f){var c=[h[0],h[1],h[2]];var g=c[0]+c[1]+c[2];var i=((255*3-g)*d)/3;c[0]+=i;c[1]+=i;c[2]+=i;c=molmil.redistributeRGB(c);if(f){return c}else{return[Math.round(c[0]),Math.round(c[1]),Math.round(c[2])]}};molmil.redistributeRGB=function(h){var g=255;var f=Math.max(Math.max(h[0],h[1]),h[2]);if(f<=g){return h}var i=h[0]+h[1]+h[2];if(i>=3*g){return[g,g,g]}var d=(3*g-i)/(3*f-i);var c=g-d*f;h[0]=c+d*h[0];h[1]=c+d*h[1];h[2]=c+d*h[2];return h};function buCheck(H,G,q,B,K){K=K||molmil.cli_soup;if(!B){for(var F=0;F<K.structures.length;F++){if(K.structures[F] instanceof molmil.entryObject){B=K.structures[F];break}}}var u={};u.displayedChains={};u.COR=JSON.parse(JSON.stringify(K.COR));u.geomRanges=JSON.parse(JSON.stringify(K.geomRanges));for(var I=0;I<B.chains.length;I++){if(B.chains[I].display){u.displayedChains[B.chains[I].name]=true}}var D=K.BUassemblies[H];var j,C;var j=JSON.parse(JSON.stringify(molmil.configBox.backboneAtoms4Display));j.CA=1;var A=0,F,I,E,J,y,t=[],o,d=[0,0,0,0],n=[0,0,0],g;var l={},x;for(A,I=0;A<D.length;A++){y=[];for(F=0;F<D[A][1].length;F++){if(K.poly_asym_ids.indexOf(D[A][1][F])!=-1){y.push(D[A][1][F])}else{l[D[A][1][F]]=y}}t.push(y);for(F=0,J=0;F<D[A][0].length;F++){E=K.BUmatrices[D[A][0][F]];if(E[0]=="identity operation"){continue}J++}I+=y.length*J}var h={},w=false,z=0;for(A=0;A<D.length;A++){y=t[A];for(F=0;F<y.length;F++){no_identity=true;if(!h.hasOwnProperty(y[F])){h[y[F]]=[]}for(I=0;I<D[A][0].length;I++){E=K.BUmatrices[D[A][0][I]];if(E[0]=="identity operation"){no_identity=false;continue}h[y[F]].push(E[1])}var f=[];if((G==1&&q==1)||(G==2&&q==1)||(G==2&&q==4)){for(I=0;I<D[A][0].length;I++){E=K.BUmatrices[D[A][0][I]];if(E[0]=="identity operation"){no_identity=false;continue}f.push(E[1])}}else{if((G==3||G==4)&&q==4){for(I=0;I<D[A][0].length;I++){E=K.BUmatrices[D[A][0][I]];if(E[0]=="identity operation"){no_identity=false;continue}f.push(E[1])}}else{if((G==3||G==4||G==5)&&(q==2||q==3||q==5)){for(I=0;I<D[A][0].length;I++){E=K.BUmatrices[D[A][0][I]];if(E[0]=="identity operation"){no_identity=false;continue}f.push(E[1])}}else{for(I=0;I<D[A][0].length;I++){E=K.BUmatrices[D[A][0][I]];if(E[0]=="identity operation"){no_identity=false;continue}f.push(E[1])}}}}for(I=0;I<f.length;I++){z++}if(!no_identity){w=true}}}u.chainInfo=h;u.NOC=z;u.no_identity=!w;var s=false;for(I=0;I<B.chains.length;I++){if(l.hasOwnProperty(B.chains[I].name)){y=l[B.chains[I].name];if(y instanceof Array){J=false;for(F=0;F<y.length;F++){if(l.hasOwnProperty(y[F])){J=true;break}}if(!J){u.displayedChains[B.chains[I].name]=false;continue}}if(!u.displayedChains[B.chains[I].name]){u.displayedChains[B.chains[I].name]=true}}else{if(u.displayedChains[B.chains[I].name]){u.displayedChains[B.chains[I].name]=false}}}u.assembly_id=H;return u}molmil.toggleBU=function(af,O,x,C,aw){aw=aw||molmil.cli_soup;if(!C){for(var an=0;an<aw.structures.length;an++){if(aw.structures[an] instanceof molmil.entryObject){C=aw.structures[an];break}}}var V=aw.renderer;var w=V.gl;var ae=aw.models;if(!aw.sceneBU){aw.sceneBU={};aw.sceneBU.displayedChains={};aw.sceneBU.COR=JSON.parse(JSON.stringify(aw.COR));aw.sceneBU.geomRanges=JSON.parse(JSON.stringify(aw.geomRanges))}for(ar=0;ar<C.chains.length;ar++){if(C.chains[ar].display){C.chains[ar].display=aw.sceneBU.displayedChains[C.chains[ar].name]=true}}for(var ah=0;ah<V.programs.length;ah++){if(V.programs[ah].BUprogram){V.programs.splice(ah,1);ah--}}if(af==-1){aw.COR=JSON.parse(JSON.stringify(aw.sceneBU.COR));aw.geomRanges=JSON.parse(JSON.stringify(aw.sceneBU.geomRanges));var R=false;for(ar=0;ar<C.chains.length;ar++){if(!C.chains[ar].display){C.chains[ar].display=aw.sceneBU.displayedChains[C.chains[ar].name]=true;R=true}}if(aw.sceneBU.no_identity){aw.renderer.program1.status=aw.renderer.program2.status=aw.renderer.program3.status=true;aw.sceneBU.no_identity=false}if(R){V.initBuffers()}aw.canvas.update=true;if(aw.sceneBU.assembly_id!=af){V.camera.z=aw.calcZ()}aw.sceneBU.assembly_id=af;return}var Q=aw.BUassemblies[af];var I,aq;var I=JSON.parse(JSON.stringify(molmil.configBox.backboneAtoms4Display));I.CA=1;var S,q,al,l,L,n,P,ad,Y;var ah=0,am,an,ar,ak,aj,at,N,o=[],T,g=[0,0,0,0],W=[0,0,0],f;var t=0;var U={},au;for(ah,ar=0;ah<Q.length;ah++){N=[];for(an=0;an<Q[ah][1].length;an++){if(aw.poly_asym_ids.indexOf(Q[ah][1][an])!=-1){N.push(Q[ah][1][an])}else{U[Q[ah][1][an]]=N}}o.push(N);for(an=0,at=0;an<Q[ah][0].length;an++){ak=aw.BUmatrices[Q[ah][0][an]];if(ak[0]=="identity operation"){continue}at++}t+=at;ar+=N.length*at}var aa=[],F=true,h;if(x==2){at=(o[0]||[]).length}else{if(x==3){at=ar}else{if(x instanceof Array){aa=x;if(!(aa[0] instanceof Array)){aa=[aa]}x=5;at=0}}}for(an=0,ak=0;an<at;an++,ak++){if(ak>=molmil.configBox.bu_colors.length){ak=0}if(O==5){aa.push(molmil.lighterRGB(molmil.configBox.bu_colors[ak],0.5))}else{aa.push(molmil.configBox.bu_colors[ak])}}var ao=1e+99,K=-1e+99,E=1e+99,ai=-1e+99,ac=1e+99,u=-1e+99,z=[0,0,0],y=[0,0,0];var J={},X=false,M=0,Z;for(ah=0,am=0;ah<Q.length;ah++){N=o[ah];for(an=0;an<N.length;an++){Z=null;F=true;if(!J.hasOwnProperty(N[an])){J[N[an]]=[]}if(aw.BUcache.hasOwnProperty(N[an])&&aw.BUcache[N[an]].hasOwnProperty(O)){ar=aw.BUcache[N[an]][O];ad=ar[0];Y=ar[1];T=ar[2];au=ar[3];Z=ar[4]}else{if(O==3||O==4){var H=[],ab=[],ag,D,s=[];var av=2;if(O==4){av=3}T=[0,0,0,0];z[0]=z[1]=z[2]=1e+99;y[0]=y[1]=y[2]=-1e+99;for(ar=0;ar<C.chains.length;ar++){if(C.chains[ar].molecules.length<1||C.chains[ar].isHet||C.chains[ar].molecules[0].water){continue}if(C.chains[ar].name!=N[an]){continue}s.push(C.chains[ar]);H.push(C.chains[ar].displayMode);C.chains[ar].displayMode=av;ab.push(ag=[]);for(ak=0;ak<C.chains[ar].molecules.length;ak++){ag.push(C.chains[ar].molecules[ak].rgba);C.chains[ar].molecules[ak].rgba=molmil_dep.getKeyFromObject(molmil.configBox.sndStrucColor,C.chains[ar].molecules[ak].sndStruc,molmil.configBox.sndStrucColor[1]);if(C.chains[ar].molecules[ak].CA){D=C.chains[ar].molecules[ak].CA.xyz;T[0]+=C.chains[ar].modelsXYZ[0][D];T[1]+=C.chains[ar].modelsXYZ[0][D+1];T[2]+=C.chains[ar].modelsXYZ[0][D+2];T[3]+=1;if(C.chains[ar].modelsXYZ[0][D]<z[0]){z[0]=C.chains[ar].modelsXYZ[0][D]}if(C.chains[ar].modelsXYZ[0][D+1]<z[1]){z[1]=C.chains[ar].modelsXYZ[0][D+1]}if(C.chains[ar].modelsXYZ[0][D+2]<z[2]){z[2]=C.chains[ar].modelsXYZ[0][D+2]}if(C.chains[ar].modelsXYZ[0][D]>y[0]){y[0]=C.chains[ar].modelsXYZ[0][D]}if(C.chains[ar].modelsXYZ[0][D+1]>y[1]){y[1]=C.chains[ar].modelsXYZ[0][D+1]}if(C.chains[ar].modelsXYZ[0][D+2]>y[2]){y[2]=C.chains[ar].modelsXYZ[0][D+2]}}}}T[0]/=T[3];T[1]/=T[3];T[2]/=T[3];molmil.geometry.reset();h=0;if(t>10){h--}if(t>100){h--}if(t>1000){h--}molmil.geometry.initChains(s,V,h);molmil.geometry.initCartoon(s);molmil.geometry.generateCartoon(s);ad=w.createBuffer();w.bindBuffer(w.ARRAY_BUFFER,ad);w.bufferData(w.ARRAY_BUFFER,molmil.geometry.buffer3.vertexBuffer,w.STATIC_DRAW);Y=w.createBuffer();w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,Y);w.bufferData(w.ELEMENT_ARRAY_BUFFER,molmil.geometry.buffer3.indexBuffer,w.STATIC_DRAW);if(!aw.BUcache.hasOwnProperty(N[an])){aw.BUcache[N[an]]={}}aw.BUcache[N[an]][O]=[ad,Y,T,au=molmil.geometry.buffer3.indexBuffer.length,[]];for(ar=0;ar<s.length;ar++){s[ar].displayMode=H[ar];for(ak=0;ak<s[ar].molecules.length;ak++){s[ar].molecules[ak].rgba=ab[ar][ak]}}molmil.geometry.reset()}else{if(O==5){var G;for(ar=0;ar<C.chains.length;ar++){if(C.chains[ar].molecules.length<1||C.chains[ar].isHet||C.chains[ar].molecules[0].water){continue}if(C.chains[ar].name!=N[an]){continue}G=molmil.coarseSurface(C.chains[ar],7.5,7.5*0.75);l=new Float32Array(G.vertices.length*8);L=new Uint8Array(l.buffer);n=new Uint32Array(G.faces.length*3);T=[0,0,0,0];z[0]=z[1]=z[2]=1e+99;y[0]=y[1]=y[2]=-1e+99;for(ar=0,ak=0,aj=0;ar<G.vertices.length;ar++,aj+=32){l[ak++]=G.vertices[ar][0];l[ak++]=G.vertices[ar][1];l[ak++]=G.vertices[ar][2];T[0]+=G.vertices[ar][0];T[1]+=G.vertices[ar][1];T[2]+=G.vertices[ar][2];T[3]+=1;if(G.vertices[ar][0]<z[0]){z[0]=G.vertices[ar][0]}if(G.vertices[ar][1]<z[1]){z[1]=G.vertices[ar][1]}if(G.vertices[ar][2]<z[2]){z[2]=G.vertices[ar][2]}if(G.vertices[ar][0]>y[0]){y[0]=G.vertices[ar][0]}if(G.vertices[ar][1]>y[1]){y[1]=G.vertices[ar][1]}if(G.vertices[ar][2]>y[2]){y[2]=G.vertices[ar][2]}l[ak++]=G.normals[ar][0];l[ak++]=G.normals[ar][1];l[ak++]=G.normals[ar][2];ak++;ak++}T[0]/=T[3];T[1]/=T[3];T[2]/=T[3];for(ar=0,ak=0;ar<G.faces.length;ar++){n[ak++]=G.faces[ar][0];n[ak++]=G.faces[ar][1];n[ak++]=G.faces[ar][2]}ad=w.createBuffer();w.bindBuffer(w.ARRAY_BUFFER,ad);w.bufferData(w.ARRAY_BUFFER,l,w.STATIC_DRAW);Y=w.createBuffer();w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,Y);w.bufferData(w.ELEMENT_ARRAY_BUFFER,n,w.STATIC_DRAW);if(!aw.BUcache.hasOwnProperty(N[an])){aw.BUcache[N[an]]={}}aw.BUcache[N[an]][O]=[ad,Y,T,au=G.faces.length*3,[]]}}else{S=[];q={};if(O==1){for(ar=0;ar<C.chains.length;ar++){aq=C.chains[ar];if(!aq.bondsOK){V.soup.buildBondList(aq,false)}for(at=0;at<aq.bonds.length;at++){if(I.hasOwnProperty(aq.bonds[at][0].atomName)&&I.hasOwnProperty(aq.bonds[at][1].atomName)&&aq.bonds[at][0].molecule.chain.name==N[an]&&aq.bonds[at][1].molecule.chain.name==N[an]){S.push(aq.bonds[at]);q[aq.bonds[at][0].AID]=aq.bonds[at][0];q[aq.bonds[at][1].AID]=aq.bonds[at][1]}}}}else{if(O==2){for(ar=0;ar<C.chains.length;ar++){aq=C.chains[ar];for(ak=0;ak<aq.molecules.length;ak++){if(aq.molecules[ak].CA&&aq.molecules[ak].next&&aq.molecules[ak].chain.name==N[an]){S.push([aq.molecules[ak].CA,aq.molecules[ak].next.CA]);q[aq.molecules[ak].CA.AID]=aq.molecules[ak].CA;q[aq.molecules[ak].next.CA.AID]=aq.molecules[ak].next.CA}}}}}AIDs=Object.keys(q);P={};l=new Float32Array((AIDs.length)*5);L=new Uint8Array(l.buffer);n=new Uint32Array(S.length*2);T=[0,0,0,0];z[0]=z[1]=z[2]=1e+99;y[0]=y[1]=y[2]=-1e+99;if(O==2&&x==4){for(ar=0,ak=0,aj=0;ar<AIDs.length;ar++,aj+=20){f=q[AIDs[ar]];aq=f.chain;l[ak++]=aq.modelsXYZ[0][f.xyz];l[ak++]=aq.modelsXYZ[0][f.xyz+1];l[ak++]=aq.modelsXYZ[0][f.xyz+2];T[0]+=l[ak-3];T[1]+=l[ak-2];T[2]+=l[ak-1];if(l[ak-3]<z[0]){z[0]=l[ak-3]}if(l[ak-2]<z[1]){z[1]=l[ak-2]}if(l[ak-1]<z[2]){z[2]=l[ak-1]}if(l[ak-3]>y[0]){y[0]=l[ak-3]}if(l[ak-2]>y[1]){y[1]=l[ak-2]}if(l[ak-1]>y[2]){y[2]=l[ak-1]}al=molmil_dep.getKeyFromObject(molmil.configBox.sndStrucColor,q[AIDs[ar]].molecule.sndStruc,molmil.configBox.sndStrucColor[1]);L[aj+12]=al[0];L[aj+13]=al[1];L[aj+14]=al[2];L[aj+15]=al[3];ak++;l[ak++]=AIDs[ar];P[AIDs[ar]]=ar}}else{for(ar=0,ak=0,aj=0;ar<AIDs.length;ar++,aj+=20){f=q[AIDs[ar]];aq=f.chain;l[ak++]=aq.modelsXYZ[0][f.xyz];l[ak++]=aq.modelsXYZ[0][f.xyz+1];l[ak++]=aq.modelsXYZ[0][f.xyz+2];T[0]+=l[ak-3];T[1]+=l[ak-2];T[2]+=l[ak-1];if(l[ak-3]<z[0]){z[0]=l[ak-3]}if(l[ak-2]<z[1]){z[1]=l[ak-2]}if(l[ak-1]<z[2]){z[2]=l[ak-1]}if(l[ak-3]>y[0]){y[0]=l[ak-3]}if(l[ak-2]>y[1]){y[1]=l[ak-2]}if(l[ak-1]>y[2]){y[2]=l[ak-1]}al=molmil_dep.getKeyFromObject(molmil.configBox.elementColors,q[AIDs[ar]].element,molmil.configBox.elementColors.DUMMY);L[aj+12]=al[0];L[aj+13]=al[1];L[aj+14]=al[2];L[aj+15]=al[3];ak++;l[ak++]=AIDs[ar];P[AIDs[ar]]=ar}}T[0]/=AIDs.length;T[1]/=AIDs.length;T[2]/=AIDs.length;T[3]=AIDs.length;for(ar=0,ak=0;ar<S.length;ar++){n[ak++]=P[S[ar][0].AID];n[ak++]=P[S[ar][1].AID]}ad=w.createBuffer();w.bindBuffer(w.ARRAY_BUFFER,ad);w.bufferData(w.ARRAY_BUFFER,l,w.STATIC_DRAW);Y=w.createBuffer();w.bindBuffer(w.ELEMENT_ARRAY_BUFFER,Y);w.bufferData(w.ELEMENT_ARRAY_BUFFER,n,w.STATIC_DRAW);if(!aw.BUcache.hasOwnProperty(N[an])){aw.BUcache[N[an]]={}}aw.BUcache[N[an]][O]=[ad,Y,T,au=n.length,[]]}}}for(ar=0;ar<Q[ah][0].length;ar++){ak=aw.BUmatrices[Q[ah][0][ar]];if(ak[0]=="identity operation"){F=false;continue}J[N[an]].push(ak[1])}var d={};d.BUprogram=true;d.gl=w;d.renderer=V;d.nElements=au;d.vertexBuffer=ad;d.indexBuffer=Y;d.angle=V.angle;d.matrices=[];if((O==1&&x==1)||(O==2&&x==1)||(O==2&&x==4)){for(ar=0;ar<Q[ah][0].length;ar++){ak=aw.BUmatrices[Q[ah][0][ar]];if(ak[0]=="identity operation"){F=false;continue}d.matrices.push(ak[1])}d.shader=V.shaders.lines;d.attributes=V.shaders.lines.attributes;d.render=function(c,A){var p=mat4.create();for(var j=0;j<this.matrices.length;j++){mat4.multiply(p,c,this.matrices[j]);this.gl.useProgram(this.shader.program);this.gl.uniform3f(this.shader.uniforms.COR,A[0],A[1],A[2]);this.gl.uniformMatrix4fv(this.shader.uniforms.modelViewMatrix,false,p);this.gl.uniformMatrix4fv(this.shader.uniforms.projectionMatrix,false,this.renderer.projectionMatrix);this.gl.uniform1f(this.shader.uniforms.focus,this.renderer.fogStart);this.gl.uniform1f(this.shader.uniforms.fogSpan,this.renderer.fogStart+(this.renderer.clearCut*2));this.render_internal()}};d.render_internal=function(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer);this.gl.vertexAttribPointer(this.attributes.in_Position,3,this.gl.FLOAT,false,20,0);this.gl.vertexAttribPointer(this.attributes.in_Colour,4,this.gl.UNSIGNED_BYTE,true,20,12);this.gl.vertexAttribPointer(2,4,this.gl.UNSIGNED_BYTE,true,20,12);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);if(this.angle){var i=0,c;while((c=Math.min(this.nElements-i,3000000))>0){this.gl.drawElements(this.gl.LINES,c,w.UNSIGNED_INT,i*4);i+=c}}else{this.gl.drawElements(this.gl.LINES,this.nElements,w.UNSIGNED_INT,0)}};d.renderPicking=function(){}}else{if((O==3||O==4)&&x==4){for(ar=0;ar<Q[ah][0].length;ar++){ak=aw.BUmatrices[Q[ah][0][ar]];if(ak[0]=="identity operation"){F=false;continue}d.matrices.push(ak[1])}d.shader=V.shaders.standard_alpha;d.attributes=d.shader.attributes;d.pickingShader=V.shaders.picking;d.pickingAttributes=d.pickingShader.attributes;d.render=function(c,A){var p=mat4.create(),B=mat3.create();for(var j=0;j<this.matrices.length;j++){mat4.multiply(p,c,this.matrices[j]);mat3.normalFromMat4(B,p);this.gl.useProgram(this.shader.program);this.gl.uniform3f(this.shader.uniforms.COR,A[0],A[1],A[2]);this.gl.uniformMatrix4fv(this.shader.uniforms.modelViewMatrix,false,p);this.gl.uniformMatrix3fv(this.shader.uniforms.normalMatrix,false,B);this.gl.uniformMatrix4fv(this.shader.uniforms.projectionMatrix,false,this.renderer.projectionMatrix);this.gl.uniform1f(this.shader.uniforms.focus,this.renderer.fogStart);this.gl.uniform1f(this.shader.uniforms.fogSpan,this.renderer.fogStart+(this.renderer.clearCut*2));this.render_internal()}};d.render_internal=function(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer);this.gl.vertexAttribPointer(this.attributes.in_Position,3,this.gl.FLOAT,false,32,0);this.gl.vertexAttribPointer(this.attributes.in_Normal,3,this.gl.FLOAT,false,32,12);this.gl.vertexAttribPointer(this.attributes.in_Colour,4,this.gl.UNSIGNED_BYTE,true,32,24);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);if(this.angle){var i=0,c;while((c=Math.min(this.nElements-i,3000000))>0){this.gl.drawElements(this.gl.TRIANGLES,c,w.UNSIGNED_INT,i*4);i+=c}}else{this.gl.drawElements(this.gl.TRIANGLES,this.nElements,w.UNSIGNED_INT,0)}};d.renderPicking=function(c,A){var p=mat4.create();for(var j=0;j<this.matrices.length;j++){mat4.multiply(p,c,this.matrices[j]);this.gl.useProgram(this.pickingShader.program);this.gl.uniform3f(this.pickingShader.uniforms.COR,A[0],A[1],A[2]);this.gl.uniformMatrix4fv(this.pickingShader.uniforms.modelViewMatrix,false,p);this.gl.uniformMatrix4fv(this.pickingShader.uniforms.projectionMatrix,false,this.renderer.projectionMatrix);this.renderPicking_internal()}};d.renderPicking_internal=function(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer);this.gl.vertexAttribPointer(this.pickingAttributes.in_Position,3,this.gl.FLOAT,false,32,0);this.gl.vertexAttribPointer(this.pickingAttributes.in_ID,1,this.gl.FLOAT,false,32,28);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);if(this.angle){var i=0,c;while((c=Math.min(this.nElements-i,3000000))>0){this.gl.drawElements(this.gl.TRIANGLES,c,w.UNSIGNED_INT,i*4);i+=c}}else{this.gl.drawElements(this.gl.TRIANGLES,this.nElements,w.UNSIGNED_INT,0)}}}else{if((O==3||O==4||O==5)&&(x==2||x==3||x==5)){d.uniform_color=[];for(ar=0;ar<Q[ah][0].length;ar++){ak=aw.BUmatrices[Q[ah][0][ar]];if(ak[0]=="identity operation"){F=false;continue}d.matrices.push(ak[1]);if(x==2){d.uniform_color.push(aa[an]||[255,255,255])}else{if(x==3){d.uniform_color.push(aa[am++]||[255,255,255])}else{if(x==5){d.uniform_color.push(aa[am++]||[255,255,255])}}}if(am>=aa.length){am=0}}d.shader=V.shaders.standard_uniform_color;d.attributes=d.shader.attributes;d.pickingShader=V.shaders.picking;d.pickingAttributes=d.pickingShader.attributes;d.render=function(c,A){var p=mat4.create(),B=mat3.create();for(var j=0;j<this.matrices.length;j++){mat4.multiply(p,c,this.matrices[j]);mat3.normalFromMat4(B,p);this.gl.useProgram(this.shader.program);this.gl.uniform3f(this.shader.uniforms.COR,A[0],A[1],A[2]);this.gl.uniform3f(this.shader.uniforms.uniform_color,this.uniform_color[j][0]/255,this.uniform_color[j][1]/255,this.uniform_color[j][2]/255);this.gl.uniformMatrix4fv(this.shader.uniforms.modelViewMatrix,false,p);this.gl.uniformMatrix3fv(this.shader.uniforms.normalMatrix,false,B);this.gl.uniformMatrix4fv(this.shader.uniforms.projectionMatrix,false,this.renderer.projectionMatrix);this.gl.uniform1f(this.shader.uniforms.focus,this.renderer.fogStart);this.gl.uniform1f(this.shader.uniforms.fogSpan,this.renderer.fogStart+(this.renderer.clearCut*2));this.render_internal()}};d.render_internal=function(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer);this.gl.vertexAttribPointer(this.attributes.in_Position,3,this.gl.FLOAT,false,32,0);this.gl.vertexAttribPointer(this.attributes.in_Normal,3,this.gl.FLOAT,false,32,12);this.gl.vertexAttribPointer(2,4,this.gl.UNSIGNED_BYTE,true,32,24);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);if(this.angle){var i=0,c;while((c=Math.min(this.nElements-i,3000000))>0){this.gl.drawElements(this.gl.TRIANGLES,c,w.UNSIGNED_INT,i*4);i+=c}}else{this.gl.drawElements(this.gl.TRIANGLES,this.nElements,w.UNSIGNED_INT,0)}};d.renderPicking=function(c,A){var p=mat4.create();for(var j=0;j<this.matrices.length;j++){mat4.multiply(p,c,this.matrices[j]);this.gl.useProgram(this.pickingShader.program);this.gl.uniform3f(this.pickingShader.uniforms.COR,A[0],A[1],A[2]);this.gl.uniformMatrix4fv(this.pickingShader.uniforms.modelViewMatrix,false,p);this.gl.uniformMatrix4fv(this.pickingShader.uniforms.projectionMatrix,false,this.renderer.projectionMatrix);this.renderPicking_internal()}};d.renderPicking_internal=function(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer);this.gl.vertexAttribPointer(this.pickingAttributes.in_Position,3,this.gl.FLOAT,false,32,0);this.gl.vertexAttribPointer(this.pickingAttributes.in_ID,1,this.gl.FLOAT,false,32,28);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);if(this.angle){var i=0,c;while((c=Math.min(this.nElements-i,3000000))>0){this.gl.drawElements(this.gl.TRIANGLES,c,w.UNSIGNED_INT,i*4);i+=c}}else{this.gl.drawElements(this.gl.TRIANGLES,this.nElements,w.UNSIGNED_INT,0)}}}else{d.uniform_color=[];for(ar=0;ar<Q[ah][0].length;ar++){ak=aw.BUmatrices[Q[ah][0][ar]];if(ak[0]=="identity operation"){F=false;continue}d.matrices.push(ak[1]);if(x==2){d.uniform_color.push(aa[an])}else{if(x==3){d.uniform_color.push(aa[am++])}else{if(x==5){d.uniform_color.push(aa[am++]||[255,255,255])}}}if(am>=aa.length){am=0}}d.shader=V.shaders.lines_uniform_color;d.attributes=V.shaders.lines_uniform_color.attributes;d.render=function(c,A){var p=mat4.create();for(var j=0;j<this.matrices.length;j++){mat4.multiply(p,c,this.matrices[j]);this.gl.useProgram(this.shader.program);this.gl.uniform3f(this.shader.uniforms.COR,A[0],A[1],A[2]);this.gl.uniform3f(this.shader.uniforms.uniform_color,this.uniform_color[j][0]/255,this.uniform_color[j][1]/255,this.uniform_color[j][2]/255);this.gl.uniformMatrix4fv(this.shader.uniforms.modelViewMatrix,false,p);this.gl.uniformMatrix4fv(this.shader.uniforms.projectionMatrix,false,this.renderer.projectionMatrix);this.gl.uniform1f(this.shader.uniforms.focus,this.renderer.fogStart);this.gl.uniform1f(this.shader.uniforms.fogSpan,this.renderer.fogStart+(this.renderer.clearCut*2));this.render_internal()}};d.render_internal=function(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer);this.gl.vertexAttribPointer(this.attributes.in_Position,3,this.gl.FLOAT,false,20,0);this.gl.vertexAttribPointer(1,3,this.gl.FLOAT,false,20,12);this.gl.vertexAttribPointer(2,3,this.gl.FLOAT,false,20,12);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);if(this.angle){var i=0,c;while((c=Math.min(this.nElements-i,3000000))>0){this.gl.drawElements(this.gl.LINES,c,w.UNSIGNED_INT,i*4);i+=c}}else{this.gl.drawElements(this.gl.LINES,this.nElements,w.UNSIGNED_INT,0)}};d.renderPicking=function(){}}}}if(d.matrices.length){V.programs.push(d)}if(Z){z=Z[0];y=Z[1]}else{try{aw.BUcache[N[an]][O][4]=[[z[0],z[1],z[2]],[y[0],y[1],y[2]]]}catch(ap){}}if(!F){if(T[3]!=0){g[0]+=T[0];g[1]+=T[1];g[2]+=T[2];g[3]+=1;if(z[0]<ao){ao=z[0]}if(z[1]<E){E=z[1]}if(z[2]<ac){ac=z[2]}if(y[0]>K){K=y[0]}if(y[1]>ai){ai=y[1]}if(y[2]>u){u=y[2]}}U[N[an]]=1}for(ar=0;ar<d.matrices.length;ar++){if(T[3]==0){continue}vec3.transformMat4(W,T,d.matrices[ar]);g[0]+=W[0];g[1]+=W[1];g[2]+=W[2];g[3]+=1;vec3.transformMat4(W,z,d.matrices[ar]);if(W[0]<ao){ao=W[0]}if(W[1]<E){E=W[1]}if(W[2]<ac){ac=W[2]}vec3.transformMat4(W,y,d.matrices[ar]);if(W[0]>K){K=W[0]}if(W[1]>ai){ai=W[1]}if(W[2]>u){u=W[2]}M++}if(!F){X=true}}}if(g[3]){g[0]/=g[3];g[1]/=g[3];g[2]/=g[3]}aw.COR[0]=g[0];aw.COR[1]=g[1];aw.COR[2]=g[2];aw.sceneBU.chainInfo=J;aw.sceneBU.NOC=M;if(!X){aw.renderer.program1.status=aw.renderer.program2.status=aw.renderer.program3.status=false}else{aw.renderer.program1.status=aw.renderer.program2.status=aw.renderer.program3.status=true}aw.sceneBU.no_identity=!X;var R=false;for(ar=0;ar<C.chains.length;ar++){if(U.hasOwnProperty(C.chains[ar].name)){N=U[C.chains[ar].name];if(N instanceof Array){at=false;for(an=0;an<N.length;an++){if(U.hasOwnProperty(N[an])){at=true;break}}if(!at){C.chains[ar].display=aw.sceneBU.displayedChains[C.chains[ar].name]=false;R=true;continue}}if(!C.chains[ar].display){C.chains[ar].display=aw.sceneBU.displayedChains[C.chains[ar].name]=true;R=true}}else{if(C.chains[ar].display){C.chains[ar].display=aw.sceneBU.displayedChains[C.chains[ar].name]=false;R=true}}}for(ar=0;ar<C.chains.length;ar++){if(C.chains[ar].display&&C.chains[ar].isHet){for(an=0;an<C.chains[ar].atoms.length;an++){if(!C.chains[ar].atoms[an].status){continue}at=C.chains[ar].atoms[an].xyz;if(C.chains[ar].modelsXYZ[0][at]<ao){ao=C.chains[ar].modelsXYZ[0][at]}if(C.chains[ar].modelsXYZ[0][at+1]<E){E=C.chains[ar].modelsXYZ[0][at+1]}if(C.chains[ar].modelsXYZ[0][at+2]<ac){ac=C.chains[ar].modelsXYZ[0][at+2]}if(C.chains[ar].modelsXYZ[0][at]>K){K=C.chains[ar].modelsXYZ[0][at]}if(C.chains[ar].modelsXYZ[0][at+1]>ai){ai=C.chains[ar].modelsXYZ[0][at+1]}if(C.chains[ar].modelsXYZ[0][at+2]>u){u=C.chains[ar].modelsXYZ[0][at+2]}}}}if(ao<1000000000){aw.geomRanges=[ao-g[0],K-g[0],E-g[1],ai-g[1],ac-g[2],u-g[2]]}if(g[3]==0){aw.COR=JSON.parse(JSON.stringify(aw.sceneBU.COR));aw.geomRanges=JSON.parse(JSON.stringify(aw.sceneBU.geomRanges))}if(R||!V.initBD){V.initBuffers()}if(aw.sceneBU.assembly_id!=af){V.camera.z=aw.calcZ()}aw.sceneBU.assembly_id=af;aw.canvas.update=true};molmil.hslToRgb123=function(n,u,j){var c,o,t;if(u==0){c=o=t=j}else{function i(l,h,g){if(g<0){g+=1}if(g>1){g-=1}if(g<1/6){return l+(h-l)*6*g}if(g<1/2){return h}if(g<2/3){return l+(h-l)*(2/3-g)*6}return l}var d=j<0.5?j*(1+u):j+u-j*u;var f=2*j-d;c=i(f,d,n+1/3);o=i(f,d,n);t=i(f,d,n-1/3)}return[c,o,t]};molmil.calcMMDistance=function(d,c,f){var j=f.renderer.modelId,i,h;i=[d.chain.modelsXYZ[j][d.xyz],d.chain.modelsXYZ[j][d.xyz+1],d.chain.modelsXYZ[j][d.xyz+2]];h=[c.chain.modelsXYZ[j][c.xyz],c.chain.modelsXYZ[j][c.xyz+1],c.chain.modelsXYZ[j][c.xyz+2]];try{return vec3.distance(i,h)}catch(g){return NaN}};molmil.calcMMAngle=function(g,f,d,l){var q=l.renderer.modelId,j,i,h;j=[g.chain.modelsXYZ[q][g.xyz],g.chain.modelsXYZ[q][g.xyz+1],g.chain.modelsXYZ[q][g.xyz+2]];i=[f.chain.modelsXYZ[q][f.xyz],f.chain.modelsXYZ[q][f.xyz+1],f.chain.modelsXYZ[q][f.xyz+2]];h=[d.chain.modelsXYZ[q][d.xyz],d.chain.modelsXYZ[q][d.xyz+1],d.chain.modelsXYZ[q][d.xyz+2]];var c=180/Math.PI,p=[0,0,0],o=[0,0,0];try{vec3.subtract(p,j,i);vec3.normalize(p,p);vec3.subtract(o,h,i);vec3.normalize(o,o);return Math.acos(vec3.dot(p,o))*c}catch(n){return NaN}};molmil.calcMMTorsion=function(g,f,d,w,p){var u=p.renderer.modelId,o,l,i,h;o=[g.chain.modelsXYZ[u][g.xyz],g.chain.modelsXYZ[u][g.xyz+1],g.chain.modelsXYZ[u][g.xyz+2]];l=[f.chain.modelsXYZ[u][f.xyz],f.chain.modelsXYZ[u][f.xyz+1],f.chain.modelsXYZ[u][f.xyz+2]];i=[d.chain.modelsXYZ[u][d.xyz],d.chain.modelsXYZ[u][d.xyz+1],d.chain.modelsXYZ[u][d.xyz+2]];h=[w.chain.modelsXYZ[u][w.xyz],w.chain.modelsXYZ[u][w.xyz+1],w.chain.modelsXYZ[u][w.xyz+2]];var c=180/Math.PI,t=[0,0,0],s=[0,0,0],n=[0,0,0],j=[0,0,0];try{vec3.subtract(t,l,o);vec3.subtract(s,i,o);vec3.cross(n,t,s);vec3.normalize(n,n);vec3.subtract(t,i,l);vec3.subtract(s,h,l);vec3.cross(j,t,s);vec3.normalize(j,j);return Math.acos(vec3.dot(n,j))*c}catch(q){return NaN}};molmil.linkCanvases=function(d){for(var c=1;c<d.length;c++){d[c].renderer.camera=d[0].renderer.camera}for(var c=0;c<d.length;c++){d[c].molmilViewer.canvases=d}};molmil.__webglNotSupported__=function(c){if(window.webglNotSupported){return webglNotSupported(c)}var d=molmil_dep.dcE("DIV");d.innerHTML='Your browser does not seem to support WebGL. Please visit the <a target="blank" class="external" href="http://get.webgl.org/">WebGL website</a> for more info on how to gain WebGL support on your browser.<br />';d.style.border="1px solid #ddd";d.style.margin=d.style.padding=".25em";c.parentNode.replaceChild(d,c);return d};molmil.calcRMSD=function(p,o,F){if(p.length!=o.length){console.log("ERROR: both structures should have the same number of atoms");return}var f=0,d=0,H=0,G=0,u=0,t=0,c=p.length,V,P;if(p instanceof Float32Array){V=p;P=o;c/=3;for(var T=0,O=0;T<c;T++,O+=3){f+=V[O];H+=V[O+1];u+=V[O+2];d+=P[O];G+=P[O+1];t+=P[O+2]}}else{V=new Float32Array(c*3);P=new Float32Array(c*3);for(var T=0,O=0;T<c;T++,O+=3){V[O]=p[T].xyz[0];V[O+1]=p[T].xyz[1];V[O+2]=p[T].xyz[2];P[O]=o[T].xyz[0];P[O+1]=o[T].xyz[1];P[O+2]=o[T].xyz[2];f+=V[O];H+=V[O+1];u+=V[O+2];d+=P[O];G+=P[O+1];t+=P[O+2]}}var Q=0,x=0;f/=c;H/=c;u/=c;d/=c;G/=c;t/=c;for(var T=0,O=0;T<c;T++,O+=3){V[O]-=f;V[O+1]-=H;V[O+2]-=u;P[O]-=d;P[O+1]-=G;P[O+2]-=t;Q+=V[O]*V[O]+V[O+1]*V[O+1]+V[O+2]*V[O+2];x+=P[O]*P[O]+P[O+1]*P[O+1]+P[O+2]*P[O+2]}var l=new Float64Array(9);for(var T=0;T<c*3;T+=3){l[0]+=V[T]*P[T];l[1]+=V[T]*P[T+1];l[2]+=V[T]*P[T+2];l[3]+=V[T+1]*P[T];l[4]+=V[T+1]*P[T+1];l[5]+=V[T+1]*P[T+2];l[6]+=V[T+2]*P[T];l[7]+=V[T+2]*P[T+1];l[8]+=V[T+2]*P[T+2]}var j=new Float64Array(16);j[0]=l[0]+l[4]+l[8];j[5]=l[0]-l[4]-l[8];j[10]=-l[0]+l[4]-l[8];j[15]=-l[0]-l[4]+l[8];j[1]=j[4]=l[5]-l[7];j[2]=j[8]=l[6]-l[2];j[3]=j[12]=l[1]-l[3];j[6]=j[9]=l[1]+l[3];j[7]=j[13]=l[2]+l[6];j[11]=j[14]=l[5]+l[7];var N=[1,1,1,1];var U=molmil.EVpowerMethod(N,j);vec4.negate(N,N);var D=[Math.sqrt(Math.max(0,(Q+x)-(2*U))/c)];if(F){var E=2*N[0],C=2*N[1],B=2*N[2],A=2*N[3];var M=E*N[0]-1,K=E*N[1],J=E*N[2],I=E*N[3],z=C*N[1],y=C*N[2],w=C*N[3],h=B*N[2],g=B*N[3],L=A*N[3];var s=new Float64Array(16);s[0]=M+z;s[1]=y-I;s[2]=w+J;s[4]=y+I;s[5]=M+h;s[6]=g-K;s[8]=w-J;s[9]=g+K;s[10]=M+L;s[15]=1;D.push(s,[f,H,u],[d,G,t])}return D};molmil.EVpowerMethod=function(h,c,l){l=l||10000;var g=1e-9,j=0,d=0,f=0,n=new Float64Array(4);f=Math.sqrt(h[0]*h[0]+h[1]*h[1]+h[2]*h[2]+h[3]*h[3]);h[0]/=f;h[1]/=f;h[2]/=f;h[3]/=f;while(j<=l){vec4.transformMat4(n,h,c);f=Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]+n[3]*n[3]);h[0]=n[0]/f;h[1]=n[1]/f;h[2]=n[2]/f;h[3]=n[3]/f;if(Math.abs((f-d)/f)<g){return f}d=f;j++}return null};molmil.invertColor=function(c){return"#"+("000000"+(16777215^parseInt(c.substring(1),16)).toString(16)).slice(-6)};molmil.componentToHex=function(f){var d=f.toString(16);return d.length==1?"0"+d:d};molmil.rgbToHex=function(f,d,c){return"#"+molmil.componentToHex(f)+molmil.componentToHex(d)+molmil.componentToHex(c)};molmil.hex2rgb=function(c){c=(c.charAt(0)=="#"?c.substr(1,7):c);return[parseInt(c.substring(0,2),16),parseInt(c.substring(2,4),16),parseInt(c.substring(4,6),16)]};molmil.commandLines={};molmil.commandLine=function(canvas){this.environment={};for(var e in window){this.environment[e]=undefined}this.environment.console={};this.environment.molmil=molmil;this.canvas=this.environment.cli_canvas=canvas;this.soup=this.environment.cli_soup=canvas.molmilViewer;canvas.commandLine=this;this.buildGUI();this.environment.console.log=function(){arguments=Array.prototype.slice.call(arguments,0);var tmp=document.createElement("div");tmp.textContent=arguments.join(", ");this.custom(tmp)};this.environment.console.warning=function(){arguments=Array.prototype.slice.call(arguments,0);var tmp=document.createElement("div");tmp.textContent=arguments.join(", ");tmp.style.color="yellow";this.custom(tmp)};this.environment.console.error=function(){arguments=Array.prototype.slice.call(arguments,0);var tmp=document.createElement("div");tmp.textContent=arguments.join(", ");tmp.style.color="red";this.custom(tmp)};this.environment.console.logCommand=function(){arguments=Array.prototype.slice.call(arguments,0);var tmp=document.createElement("div");tmp.textContent=arguments.join("\n");tmp.style.color="#00BFFF";this.custom(tmp,true)};this.environment.console.custom=function(obj,noPopup){if(!obj.textContent){return}this.logBox.appendChild(obj);this.logBox.scrollTop=this.logBox.scrollHeight;if(noPopup!=true){this.logBox.icon.onclick(true)}};this.environment.console.runCommand=function(command){if(!molmil.isBalancedStatement(command)){return}this.logCommand(command);this.cli.eval(command);this.backlog.unshift(command);this.buffer="";this.blSel=-1};this.environment.console.backlog=[];this.environment.console.buffer="";this.environment.console.blSel=-1;this.environment.console.logBox=this.logBox;this.environment.console.cli=this;this.bindPymolInterface();this.icon.onclick();this.icon.onclick()};molmil.commandLine.prototype.buildGUI=function(){this.consoleBox=this.canvas.parentNode.pushNode("span");this.consoleBox.className="molmil_UI_cl_box";this.consoleBox.style.overflow="initial";this.logBox=this.consoleBox.pushNode("span");this.logBox.icon=this.icon=this.consoleBox.pushNode("span");this.icon.innerHTML="<";this.icon.title="Display command line";this.icon.className="molmil_UI_cl_icon";this.icon.style.color=molmil.invertColor(molmil.rgbToHex(molmil.configBox.BGCOLOR[0]*255,molmil.configBox.BGCOLOR[1]*255,molmil.configBox.BGCOLOR[2]*255));this.icon.onclick=function(c){if(c==true){if(this.inp.style.display!=""){this.cli.logBox.style.display="";this.cli.consoleBox.style.height="8em";this.cli.logBox.style.pointerEvents="none";this.cli.logBox.style.overflow="hidden";var d=molmil.invertColor(molmil.rgbToHex(molmil.configBox.BGCOLOR[0]*255,molmil.configBox.BGCOLOR[1]*255,molmil.configBox.BGCOLOR[2]*255));this.cli.consoleBox.style.color=d;this.logBox.scrollTop=this.logBox.scrollHeight}return}if(this.inp.style.display==""){this.innerHTML="<";this.title="Display command line";this.inp.style.display="none";this.cli.logBox.style.display="none"}else{this.innerHTML=">";this.title="Hide command line";var d=molmil.invertColor(molmil.rgbToHex(molmil.configBox.BGCOLOR[0]*255,molmil.configBox.BGCOLOR[1]*255,molmil.configBox.BGCOLOR[2]*255));this.cli.logBox.style.border="1px solid "+d;this.cli.logBox.style.borderBottom="";this.cli.logBox.style.borderRadius=".33em";this.cli.consoleBox.style.color=d;this.cli.logBox.style.backgroundColor="rgba("+molmil.configBox.BGCOLOR[0]*255+","+molmil.configBox.BGCOLOR[1]*255+","+molmil.configBox.BGCOLOR[2]*255+",.5)";this.inp.style.backgroundColor="rgb("+molmil.configBox.BGCOLOR[0]*255+","+molmil.configBox.BGCOLOR[1]*255+","+molmil.configBox.BGCOLOR[2]*255+")";this.inp.style.display="";this.cli.logBox.style.display="";this.cli.consoleBox.style.height=this.cli.consoleBox.style.maxHeight="calc("+this.cli.canvas.clientHeight+"px - 6em)";this.cli.consoleBox.style.overflow="";this.cli.logBox.style.pointerEvents="";this.inp.focus()}};this.logBox.onmouseover=function(){this.style.backgroundColor="rgba("+molmil.configBox.BGCOLOR[0]*255+","+molmil.configBox.BGCOLOR[1]*255+","+molmil.configBox.BGCOLOR[2]*255+",.85)"};this.logBox.onmouseout=function(){this.style.backgroundColor="rgba("+molmil.configBox.BGCOLOR[0]*255+","+molmil.configBox.BGCOLOR[1]*255+","+molmil.configBox.BGCOLOR[2]*255+",.25)"};this.inp=this.icon.inp=this.consoleBox.pushNode("span");this.inp.className="molmil_UI_cl_input";this.inp.style.display="none";this.inp.contentEditable=true;this.inp.cli=this.icon.cli=this;this.icon.logBox=this.inp.logBox=this.logBox;this.logBox.className="molmil_UI_cl_logbox";this.logBox.style.display="none";this.inp.console=this.environment.console;this.inp.onkeydown=function(c){var d=this.textContent;if(c.keyCode==13&&!c.shiftKey&&molmil.isBalancedStatement(d)){this.console.runCommand(d);this.textContent="";return false}if(c.keyCode==38&&c.ctrlKey){this.console.blSel++;if(this.console.blSel>=this.console.backlog.length){this.console.blSel=this.console.backlog.length-1}this.textContent=this.console.backlog[this.console.blSel]}if(c.keyCode==40&&c.ctrlKey){this.console.blSel--;if(this.console.blSel<-1){this.console.blSel=0}if(this.console.blSel==-1){this.textContent=this.console.buffer}else{this.textContent=this.console.backlog[this.console.blSel]}}if(this.console.blSel==-1){this.console.buffer=d}}};molmil.commandLine.prototype.eval=function(c){if(!this.altCommandIF(this.environment,c)){this.runCommand.apply(this.environment,[c])}};molmil.commandLine.prototype.runCommand=function(command){molmil.cli_canvas=this.cli_canvas;molmil.cli_soup=this.cli_soup;command=(" "+command).replace(/(\s|;)var\s+(\w+)\s*=/g,"$1this.$2 =");command=command.replace(/(\s|;)function\s+(\w+)/g,"$1this.$2 = function");command=command.replace(/(\s|;)return\sthis;/g,"$1return window;");try{with(this){eval(command)}}catch(e){this.console.error(e.message)}molmil.cli_canvas=null;molmil.cli_soup=null};molmil.isBalancedStatement=function(f){var j="[]{}()",c=[],g,h,d;for(g=0;h=f[g];g++){d=j.indexOf(h);if(d===-1){continue}if(d%2===0){c.push(d+1)}else{if(c.pop()!==d){return false}}}return c.length===0};molmil.commandLine.prototype.bindNullInterface=function(){if(this.altCommandIF){this.environment.console.log("Previous command interface unbound.")}this.altCommandIF=function(c,d){return false}};molmil.commandLine.prototype.bindPymolInterface=function(){this.environment.console.log("Pymol-like command interface bound.");this.pyMol={};this.pyMol.keywords={select:molmil.commandLines.pyMol.selectCommand,color:molmil.commandLines.pyMol.colorCommand,set_color:molmil.commandLines.pyMol.setColorCommand,show:molmil.commandLines.pyMol.showCommand};this.altCommandIF=molmil.commandLines.pyMol.tryExecute};molmil.commandLines.pyMol={};molmil.commandLines.pyMol.tryExecute=function(c,f){var d=(f.match(/^[\S]+/)||[""])[0].toLowerCase();if(!this.pyMol.keywords.hasOwnProperty(d)||!this.pyMol.keywords[d].apply(null,[c,f])){return false}};molmil.commandLines.pyMol.selectCommand=function(c,f){f=f.match(/select[\s]+([a-zA-Z0-9_]+)[\s]*,[\s]*(.*)/);try{c[f[1]]=select.apply(c,[f[2]])}catch(d){return false}return true};molmil.commandLines.pyMol.colorCommand=function(c,f){f=f.match(/color[\s]+([a-zA-Z0-9_]+)[\s]*,[\s]*(.*)/);try{molmil.commandLines.pyMol.color.apply(c,[f[1],f[2]])}catch(d){return false}return true};molmil.commandLines.pyMol.setColorCommand=function(c,d){d=d.match(/set_color[\s]+([a-zA-Z0-9_]+)[\s]*,[\s]*(.*)/);molmil.commandLines.pyMol.set_color(d[1],JSON.parse(d[2]));return true};molmil.commandLines.pyMol.showCommand=function(c,d){d=d.match(/show[\s]+([a-zA-Z0-9_]+)[\s]*,[\s]*(.*)/);molmil.commandLines.pyMol.show(d[1],d[2]);return true};molmil.quickSelect=molmil.commandLines.pyMol.pymolSelectEngine=function(expr){if(!molmil.isBalancedStatement(expr)){throw"Incorrect statement"}var new_expr="";var word="",key,toUpper=false,ss=false,ss_conv={h:3,s:2,l:1};this.soupObject=this.soupObject||molmil.cli_soup;var sub_expr_handler=function(){if(key&&word){if(toUpper){word=word.toUpperCase()}else{if(ss){if(word){word=ss_conv[word]}tmp=ss_conv[tmp]}}new_expr+=key.replace("%s",word)}else{if(word=="hydro"){new_expr+="this.soupObject.atomRef[a].molecule.water == true"}else{if(word=="hetatm"){new_expr+="this.soupObject.atomRef[a].molecule.ligand == true"}}}};for(var i=0;i<expr.length;i++){if(expr[i].match(/\s/)){toUpper=false,ss=false;if(word=="name"){key="this.soupObject.atomRef[a].atomName == '%s'";toUpper=true}else{if(word=="symbol"){key="this.soupObject.atomRef[a].element == '%s'"}else{if(word=="resn"){key="this.soupObject.atomRef[a].molecule.name == '%s'"}else{if(word=="resi"){key="this.soupObject.atomRef[a].molecule.RSID == %s"}else{if(word=="ss"){key="this.soupObject.atomRef[a].molecule.sndStruc == %s";ss=true}else{if(word=="chain"){key="this.soupObject.atomRef[a].molecule.chain.name == '%s'"}else{if(word=="hydro"){new_expr+="this.soupObject.atomRef[a].molecule.water == true"}else{if(word=="hetatm"){new_expr+="this.soupObject.atomRef[a].molecule.ligand == true"}else{if(word=="and"){new_expr+=" && "}else{if(word=="or"){new_expr+=" || "}else{if(key&&word){new_expr+=key.replace("%s",word)}else{key=""}}}}}}}}}}}word=""}else{if(expr[i]=="+"&&key){var tmp=expr.substr(i+1),pos=tmp.search(/[^a-zA-Z0-9]/),tmp=pos!=-1?tmp.substr(0,pos):tmp;if(tmp){if(toUpper){tmp=tmp.toUpperCase();word=word.toUpperCase()}if(ss){if(word){word=ss_conv[word]}tmp=ss_conv[tmp]}new_expr+=(word?key.replace("%s",word):"")+" || "+key.replace("%s",tmp);word=""}i+=pos==-1?tmp.length:pos}else{if(expr[i]=="-"){var tmp=expr.substr(i+1),pos=tmp.search(/[^a-zA-Z0-9]/),tmp=pos!=-1?tmp.substr(0,pos):tmp;new_expr+="("+key.replace(/ == %s/," >= "+word)+" && "+key.replace(/ == %s/," <= "+tmp)+")";word="";i+=pos==-1?tmp.length:pos}else{if(expr[i].match(/\(|\)|!/)){sub_expr_handler();new_expr+=expr[i];key=word=""}else{word+=expr[i]}}}}}sub_expr_handler();var list=[];new_expr="for (var a in this.soupObject.atomRef) if ("+new_expr+") list.push(this.soupObject.atomRef[a]);";eval(new_expr);return list};molmil.commandLines.pyMol.select=function(c){return pymolSelectEngine.apply(this,[c])};molmil.commandLines.pyMol.color=function(f,d,h){if(typeof d!="object"){if(this.hasOwnProperty(d)){d=this[d]}else{d=select(expr)}}if(f=="default"){var c=[];for(var j=0;j<d.length;j++){c.push(d[j].molecule)}colorEntry(c,1,null,h)}else{if(f=="structure"){var c=[];for(var j=0;j<d.length;j++){c.push(d[j].molecule)}colorEntry(c,2,null,h)}else{if(f=="cpk"){colorEntry(d,3,null,h)}else{if(f=="group"){var c=[];for(var j=0;j<d.length;j++){c.push(d[j].molecule)}colorEntry(c,4,null,h)}else{if(f=="chain"){var c=[];for(var j=0;j<d.length;j++){c.push(d[j].molecule)}colorEntry(c,5,null,h)}else{if(typeof f=="string"){var g=EV.colors[f];if(!g){g=JSON.parse(f);if(g[0]>1||g[1]>1||g[2]>1){g=[g[0]/255,g[1]/255,g[2]/255]}}}else{var g=f}for(var j=0;j<d.length;j++){d[j].rgb=g;d[j].molecule.rgb=g}if(!h){this.soupObject.renderer.initBuffers();this.soupObject.renderer.canvas.update=true}}}}}}};molmil.commandLines.pyMol.set_color=function(d,c){if(c[0]>1||c[1]>1||c[2]>1){c=[c[0]/255,c[1]/255,c[2]/255]}EV.colors[d]=c};molmil.commandLines.pyMol.show=function(c,d,f){if(typeof d!="object"){if(this.hasOwnProperty(d)){d=this[d]}else{d=select(expr)}}if(c=="spheres"){}else{if(c=="ball-stick"){}else{if(c=="stick"){}else{if(c=="lines"){}else{if(c=="cartoon"){}else{if(c=="tube"){}else{if(c=="ca-trace"){}}}}}}}};molmil.bindCanvasInputs=function(d){var c=function(g){g.preventDefault();return false};var f=function(p){p.preventDefault();var o=0,n=[];try{n=p.dataTransfer.files;o=n.length}catch(q){}var g,l,h;for(l=0;l<o;l++){g=new FileReader();g.filename=n[l].name;g.fileHandle=n[l];for(h=0;h<this.inputFunctions.length;h++){if(this.inputFunctions[h](d,g)){break}}}return false};d.addEventListener("dragover",c);d.addEventListener("dragenter",c);d.addEventListener("drop",f);d.inputFunctions=[];d.inputFunctions.push(function(h,g){if(g.filename.indexOf(".pdb",g.filename.length-4)!==-1||g.filename.indexOf(".ent",g.filename.length-4)!==-1){g.onload=function(i){h.molmilViewer.loadStructureData(i.target.result,4,this.filename)};g.readAsText(g.fileHandle);return true}});d.inputFunctions.push(function(h,g){if(g.filename.indexOf(".cif",g.filename.length-4)!==-1){g.onload=function(i){h.molmilViewer.loadStructureData(i.target.result,"cif",this.filename)};g.readAsText(g.fileHandle);return true}});d.inputFunctions.push(function(h,g){if(g.filename.indexOf(".gro",g.filename.length-4)!==-1){g.onload=function(i){h.molmilViewer.loadStructureData(i.target.result,7,this.filename)};g.readAsText(g.fileHandle);return true}});d.inputFunctions.push(function(h,g){if(g.filename.indexOf(".trr",g.filename.length-4)!==-1){g.onload=function(i){h.molmilViewer.loadStructureData(i.target.result,"gromacs-trr",this.filename)};g.readAsArrayBuffer(g.fileHandle);return true}});d.inputFunctions.push(function(h,g){if(g.filename.indexOf(".xtc",g.filename.length-4)!==-1){g.onload=function(i){h.molmilViewer.loadStructureData(i.target.result,"gromacs-xtc",this.filename)};g.readAsArrayBuffer(g.fileHandle);return true}});d.inputFunctions.push(function(h,g){if(g.filename.indexOf(".cor",g.filename.length-4)!==-1){g.onload=function(i){h.molmilViewer.loadStructureData(i.target.result,"psygene-traj",this.filename)};g.readAsArrayBuffer(g.fileHandle);return true}});d.inputFunctions.push(function(h,g){if(g.filename.indexOf(".mpbf",g.filename.length-5)!==-1){g.onload=function(i){h.molmilViewer.loadStructureData(i.target.result,8,this.filename)};g.readAsArrayBuffer(g.fileHandle);return true}});d.inputFunctions.push(function(h,g){if(g.filename.indexOf(".ccp4",g.filename.length-5)!==-1){g.onload=function(i){h.molmilViewer.loadStructureData(i.target.result,"ccp4",this.filename)};g.readAsArrayBuffer(g.fileHandle);return true}});d.inputFunctions.push(function(h,g){if(g.filename.indexOf(".mdl",g.filename.length-4)!==-1){g.onload=function(i){h.molmilViewer.loadStructureData(i.target.result,"mdl",this.filename)};g.readAsText(g.fileHandle);return true}});d.inputFunctions.push(function(h,g){if(g.filename.indexOf(".mol2",g.filename.length-5)!==-1){g.onload=function(i){h.molmilViewer.loadStructureData(i.target.result,"mol2",this.filename)};g.readAsText(g.fileHandle);return true}})};molmil.initVideo=function(d){var c=new molmil_dep.CallRemote("POST");c.ASYNC=true;c.UI=d;c.OnDone=function(){var f=JSON.parse(this.request.responseText);if(!f.found){return this.OnError()}molmil_dep.asyncStart(this.UI.videoRenderer,[],this.UI,0)};c.OnError=function(){alert("The support server to construct the video could not be found...")};c.Send(molmil.settings.molmil_video_url+"has_molmil_video_support")};if(typeof(requestAnimationFrame)!="undefined"){molmil.animate_molmilViewers()}if(!window.molmil_dep){var dep=document.createElement("script");dep.src=molmil.settings.src+"molmil_dep.js";var head=document.getElementsByTagName("head")[0];head.appendChild(dep)}molmil.initSettings();