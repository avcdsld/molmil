var molmil_settings_default={src:"/molmil/molmil",pdb_url:"http://ipr.pdbj.org/rest/displayPDBfile?format=mmjson-all&id=__ID__",comp_url:"http://ipr.pdbj.org/rest/displayCOMPfile?format=mmjson&id=__ID__",promodeE_check_url:"http://ipr.pdbj.org/rest/quick_search?fields=5&query=__ID__",promodeE_base_structure_url:"http://ipr.pdbj.org/rest/displayPromodeEfile?format=min&id=__ID__",promodeE_mode_vectors_url:"http://ipr.pdbj.org/rest/displayPromodeEfile?format=vec&id=__ID_____MODE__",promodeE_animation_url:"http://ipr.pdbj.org/rest/displayPromodeEfile?format=anm&id=__ID_____MODE__"};var molmil_settings=molmil_settings||molmil_settings_default;for(var e in molmil_settings_default){if(!molmil_settings.hasOwnProperty(e)){molmil_settings[e]=molmil_settings_default[e]}}var molmilConfigBox={initFinished:false,elementInfo:{DUMMY:[0,0,0,1.7],H:[0,0,0,1.09],C:[0,0,0,1.7],N:[0,0,0,1.55],O:[0,0,0,1.52],S:[0,0,0,1.8],Cl:[0,0,0,1.8],B:[0,0,0,1.8],P:[0,0,0,1.8],Fe:[0,0,0,1.8],Ba:[0,0,0,1.8],So:[0,0,0,1.8],Mg:[0,0,0,1.8],Zn:[0,0,0,1.8],Cu:[0,0,0,1.8],Ni:[0,0,0,1.8],Br:[0,0,0,1.8],Ca:[0,0,0,1.8],Mn:[0,0,0,1.8],Al:[0,0,0,1.8],Ti:[0,0,0,1.8],Cr:[0,0,0,1.8],Ag:[0,0,0,1.8],F:[0,0,0,1.8],Si:[0,0,0,1.8],Au:[0,0,0,1.8],I:[0,0,0,1.8],Li:[0,0,0,1.8],He:[0,0,0,1.8]},sndStrucInfo:{1:[255/255,255/255,255/255],2:[255/255,255/255,0/255],3:[255/255,0/255,255/255],4:[0/255,0/255,255/255]},zNear:20,zFar:10000,QLV_SETTINGS:[{SPHERE_TESS_LV:0,CB_NOI:4,CB_NOVPR:4,CB_DOME_TESS_LV:0},{SPHERE_TESS_LV:1,CB_NOI:4,CB_NOVPR:8,CB_DOME_TESS_LV:1},{SPHERE_TESS_LV:2,CB_NOI:10,CB_NOVPR:16,CB_DOME_TESS_LV:2},{SPHERE_TESS_LV:3,CB_NOI:16,CB_NOVPR:32,CB_DOME_TESS_LV:3},{SPHERE_TESS_LV:4,CB_NOI:16,CB_NOVPR:32,CB_DOME_TESS_LV:4}],OES_element_index_uint:null,BGCOLOR:[0,0,0,1],backboneAtoms4Display:{N:1,C:1,O:1,P:1,"O5'":1,OP1:1,OP2:1,"C3'":1,"C4'":1,"C5'":1,"O4'":1,"C2'":1,"O3'":1,"O2'":1},xna_simple_base_atoms:{"O5'":1,"C5'":1,"C4'":1,"O4'":1,"C3'":1,"O3'":1,"C2'":1,O6:1,N2:1,N4:1,P:1,OP1:1,OP2:1,O2:1,"O2'":1,N6:1,O4:1},projectionMode:1,colorMode:1,glsl_shaders:[["/shaders/standard.glsl"],["/shaders/lines.glsl"],["/shaders/picking.glsl"],["/shaders/linesPicking.glsl"],["/shaders/atomSelection.glsl"],["/shaders/lines.glsl","lines_uniform_color","#define UNIFORM_COLOR 1\n"],["/shaders/standard.glsl","standard_alpha","#define ALPHA_MODE 1\n"]],glsl_fog:0};function initSettings(){var b,l=localStorage.getItem("molmil_settings_COLORS")||1;if(l==2){b={DUMMY:[255,20,147],H:[255,255,255],C:[144,144,144],N:[48,80,248],O:[255,13,13],S:[255,255,48],Cl:[31,240,31],B:[255,181,181],P:[255,128,0],Fe:[224,102,51],Ba:[0,201,0],Mg:[138,255,0],Zn:[125,128,176],Cu:[200,128,51],Ni:[80,208,80],Br:[165,42,42],Ca:[61,255,0],Mn:[156,122,199],Al:[191,166,166],Ti:[191,194,199],Cr:[138,153,199],Ag:[192,192,192],F:[144,224,80],Si:[240,200,160],Au:[255,209,35],I:[148,0,148],Li:[204,128,255],He:[217,255,255]}}else{if(l==3){b={DUMMY:[255,127,0],H:[204,204,204],C:[0,255,255],N:[0,0,255],O:[255,0,0],P:[255,255,0],S:[0,255,0]}}else{b={DUMMY:[255,20,147],H:[255,255,255],C:[200,200,200],N:[143,143,255],O:[240,0,0],S:[255,200,50],Cl:[0,255,0],B:[0,255,0],P:[255,165,0],Fe:[255,165,0],Ba:[255,165,0],Mg:[34,139,34],Zn:[165,42,42],Cu:[165,42,42],Ni:[165,42,42],Br:[165,42,42],Ca:[128,128,144],Mn:[128,128,144],Al:[128,128,144],Ti:[128,128,144],Cr:[128,128,144],Ag:[128,128,144],F:[218,165,32],Si:[218,165,32],Au:[218,165,32],I:[160,32,240],Li:[178,34,34],He:[255,192,203]}}}var g=1/255;for(var h in b){molmilConfigBox.elementInfo[h][0]=b[h][0]*g;molmilConfigBox.elementInfo[h][1]=b[h][1]*g;molmilConfigBox.elementInfo[h][2]=b[h][2]*g}molmilConfigBox.bu_colors=[[0,204,255],[255,51,255],[0,255,102],[153,102,255],[255,255,0],[204,102,102],[153,204,102],[204,153,204],[153,153,102],[0,204,204],[153,153,153],[51,153,204],[0,255,153],[51,153,255],[204,102,153],[0,255,204],[51,204,255],[204,102,204],[0,255,255],[102,153,204],[204,153,0],[51,204,102],[102,153,255],[204,153,51],[51,204,153],[102,204,255],[204,153,102],[51,204,204],[153,102,204],[204,153,153],[51,255,51],[51,255,102],[153,153,204],[204,204,0],[51,255,153],[153,153,255],[204,204,51],[51,255,204],[153,204,255],[204,204,102],[51,255,255],[204,102,255],[204,204,153],[102,153,153],[204,153,255],[204,204,204],[102,204,51],[204,204,255],[255,51,204],[102,204,102],[102,204,153],[255,102,51],[102,204,204],[255,102,102],[102,255,0],[255,102,153],[102,255,51],[255,102,204],[102,255,102],[255,102,255],[102,255,153],[255,153,0],[102,255,204],[255,153,51],[102,255,255],[255,153,102],[153,204,0],[255,153,153],[153,204,51],[255,153,204],[255,153,255],[153,204,153],[255,204,0],[153,204,204],[255,204,51],[153,255,0],[255,204,102],[153,255,51],[255,204,153],[153,255,102],[255,204,204],[153,255,153],[255,204,255],[153,255,204],[153,255,255],[255,255,51],[204,255,0],[255,255,102],[204,255,51],[255,255,153],[204,255,102],[255,255,204],[204,255,153],[255,255,255],[204,255,204],[204,255,255]];for(var f=0;f<molmilConfigBox.bu_colors.length;f++){molmilConfigBox.bu_colors[f][0]*=g;molmilConfigBox.bu_colors[f][1]*=g;molmilConfigBox.bu_colors[f][2]*=g}molmilConfigBox.glsl_fog=localStorage.getItem("molmil_settings_glsl_fog")==1;molmilConfigBox.projectionMode=localStorage.getItem("molmil_settings_PROJECTION")||1;var d=localStorage.getItem("molmil_settings_BGCOLOR");if(d){try{molmilConfigBox.BGCOLOR=JSON.parse(d)}catch(h){}}}var canvasList=[];var mouseDown,mouseDownS={},mouseMoved,Xcoord,Ycoord,Zcoord,activeCanvas,touchList,touchMode;function atomObject(b,i,h,f,d,g){this.xyz=[b,i,h];this.element=d.charAt(0).toUpperCase()+d.slice(1).toLowerCase();this.atomName=f;this.displayMode=0;this.status=1;this.rgb=[1,1,1];this.molecule=g;this.radius=0;this.AID=0}atomObject.prototype.toString=function(){return" Atom"};function molObject(b,f,d){this.atoms=[];this.name=b;this.id=f;this.RSID=f;this.chain=d;this.ligand=true;this.water=false;this.displayMode=0;this.status=1;this.next=null,this.previous=null;this.rgb=[1,1,1];this.smoothedPoint=[0,0,0];this.smooth=false;this.sndStruc=1;this.xna=false}molObject.prototype.toString=function(){return" Residue"};function chainObject(d,b){this.name=d;this.authName=d;this.molecules=[];this.model=b;this.AU_only=false}chainObject.prototype.toString=function(){return" Chain"};function modelObject(b,d){this.chains=[];this.display=true;this.molecules=[];this.atoms=[];this.bonds=[];this.model_num=b;this.id=d}modelObject.prototype.toString=function(){return" Model"};function polygonObject(){this.display=true;this.vertices=[];this.lines_lists=[];this.triangles_lists=[];this.filename=""}function animationObj(b){this.soup=b;this.renderer=b.renderer;this.frameNo=0;this.motionMode=1;this.init=false;this.delay=66;this.frameAction=function(){}}animationObj.prototype.initialise=function(){this.renderer.animationMode=true;if(this.soup.models.length>1){for(var b=0;b<this.soup.models.length;b++){this.renderer.framesDefinition.push([[this.soup.models[b]],[]])}}else{for(var b=0;b<this.soup.trajectory.length;b++){this.renderer.framesDefinition.push([[this.soup.models[0]],[],b])}}this.renderer.initBuffers();this.init=true};animationObj.prototype.beginning=function(){if(!this.init){this.initialise()}this.frameNo=0;this.renderer.selectFrame(this.frameNo);this.soup.canvas.update=true;this.frameAction()};animationObj.prototype.previous=function(){if(!this.init){this.initialise()}this.frameNo-=1;if(this.frameNo<0){this.frameNo=0}this.renderer.selectFrame(this.frameNo);this.soup.canvas.update=true;this.frameAction()};animationObj.prototype.pause=function(){if(this.TID){clearTimeout(this.TID);this.TID=null}};animationObj.prototype.play=function(){if(!this.init){this.initialise()}this.playing=true;if(this.motionMode==2){this.TID=molmil_dep.asyncStart(this.backwardRenderer,[],this,this.delay)}else{this.TID=molmil_dep.asyncStart(this.forwardRenderer,[],this,this.delay)}};animationObj.prototype.next=function(){if(!this.init){this.initialise()}this.frameNo+=1;if(this.frameNo>=this.renderer.framesBuffer.length){this.frameNo=this.renderer.framesBuffer.length-1}this.renderer.selectFrame(this.frameNo);this.soup.canvas.update=true;this.frameAction()};animationObj.prototype.end=function(){if(!this.init){this.initialise()}this.frameNo=this.renderer.framesBuffer.length-1;this.renderer.selectFrame(this.frameNo);this.soup.canvas.update=true;this.frameAction()};animationObj.prototype.forwardRenderer=function(){this.frameNo+=1;if(this.frameNo>=this.renderer.framesBuffer.length){if(this.motionMode==3){this.frameNo-=1;return this.backwardRenderer()}else{this.playing=false}}else{this.renderer.selectFrame(this.frameNo);this.soup.canvas.update=true;this.TID=molmil_dep.asyncStart(this.forwardRenderer,[],this,this.delay);this.frameAction()}};animationObj.prototype.backwardRenderer=function(){this.frameNo-=1;if(this.frameNo<0){if(this.motionMode==3){this.frameNo+=1;return this.forwardRenderer()}else{this.playing=false}}else{this.renderer.selectFrame(this.frameNo);this.soup.canvas.update=true;this.TID=molmil_dep.asyncStart(this.backwardRenderer,[],this,this.delay);this.frameAction()}};function pdbjViewer(b){this.canvas=b;this.clear();this.renderer=new jvRenderer(this);this.UI=new molmil_UI(this);this.defaultCanvas=[b,this.renderer];this.templates={sphere:{},cylinder:[],dome:{}};this.detail_lv=molmilConfigBox.QLV_SETTINGS[this.renderer.QLV].SPHERE_TESS_LV;this.detail_lvs=5;this.generateCylinder();this.onAtomPick=function(){};this.animation=new animationObj(this)}pdbjViewer.prototype.toString=function(){return" SOUP"};pdbjViewer.prototype.reloadSettings=function(){this.renderer.reloadSettings()};pdbjViewer.prototype.clear=function(){this.structureFiles=[];this.trajectory=[];this.models=[];this.files=[];this.bumats=[];this.BUmatrices={};this.BUassemblies={};this.poly_asym_ids=[];this.BUcache={};this.BUmode=false;this.avgX=0;this.avgY=0;this.avgZ=0;this.stdX=0;this.stdY=0;this.stdZ=0;this.avgXYZ=[];this.stdXYZ=[];this.COR=[0,0,0];this.geomRanges=[0,0,0,0,0,0];this.polygonData=[];this.atomRef={};this.AID=1;this.CID=1;this.MID=1;this.BU=false;this.atomSelection=[];this.hideWaters=false;this.hideHydrogens=false;this.sceneBU=null;this.canvases=[];if(this.canvas){this.canvas.atomCORset=false;this.canvases=[this.canvas]}};pdbjViewer.prototype.waterToggle=function(f){for(var b=0,d;b<this.models.length;b++){for(d=0;d<this.models[b].atoms.length;d++){if(this.models[b].atoms[d].molecule.water){this.models[b].atoms[d].status=f}}}this.hideWaters=!f};pdbjViewer.prototype.hydrogenToggle=function(f){for(var b=0,d;b<this.models.length;b++){for(d=0;d<this.models[b].atoms.length;d++){if(this.models[b].atoms[d].element=="H"){this.models[b].atoms[d].status=f}}}this.hideHydrogens=!f};pdbjViewer.prototype.restoreDefaultCanvas=function(b){this.canvas=this.defaultCanvas[0];this.renderer=this.defaultCanvas[1]};function setCanvas(d,b){d.canvas=b;if(!b.renderer){d.renderer=b.renderer=new jvRenderer(d)}}pdbjViewer.prototype.selectObject=function(n,m,b){m=this.canvas.height-m;var g=this.renderer.gl;if(!this.renderer.FBOs.pickingBuffer){this.renderer.FBOs.pickingBuffer=new FBO(g,this.renderer.width,this.renderer.height);this.renderer.FBOs.pickingBuffer.addTexture("colourBuffer",g.RGBA,g.RGBA);this.renderer.FBOs.pickingBuffer.setup()}else{if(this.renderer.FBOs.pickingBuffer.width!=this.renderer.width||this.renderer.FBOs.pickingBuffer.height!=this.renderer.height){this.renderer.FBOs.pickingBuffer.resize(this.renderer.width,this.renderer.height)}}this.renderer.FBOs.pickingBuffer.bind();this.renderer.renderPicking();var f=new Uint8Array(4);g.readPixels(n,m,1,1,g.RGBA,g.UNSIGNED_BYTE,f);var l=Math.round(vec4.dot([f[0]/255,f[1]/255,f[2]/255,f[3]/255],[1/(255*255*255),1/(255*255),1/255,1])*4228250625);this.renderer.FBOs.pickingBuffer.unbind();if(l!=0){var h=this.atomRef[l];if(h){console.log("Clicked on atom: ",h);if(b&&b.ctrlKey){var o=true;for(var d=0;d<this.atomSelection.length;d++){if(this.atomSelection[d]==h){o=false;break}}if(o){this.atomSelection.push(h)}if(this.atomSelection.length==2){console.log("Distance: ",calcMMDistance(this.atomSelection[0],this.atomSelection[1])," | ",this.atomSelection[0],this.atomSelection[1])}else{if(this.atomSelection.length==3){console.log("Angle: ",calcMMAngle(this.atomSelection[0],this.atomSelection[1],this.atomSelection[2])," | ",this.atomSelection[0],this.atomSelection[1],this.atomSelection[2])}else{if(this.atomSelection.length==4){console.log("Torsion: ",calcMMTorsion(this.atomSelection[0],this.atomSelection[1],this.atomSelection[2],this.atomSelection[3])," | ",this.atomSelection[0],this.atomSelection[1],this.atomSelection[2],this.atomSelection[3])}}}}else{this.atomSelection=[h]}this.onAtomPick(h);this.canvas.renderer.updateSelection()}}else{this.atomSelection=[];this.canvas.renderer.updateSelection()}this.canvas.update=true};pdbjViewer.prototype.loadStructure=function(i,h,b,f){var g=new molmil_dep.CallRemote("GET"),d=molmil_dep.getKeyFromObject(f||{},"async",true);g.ASYNC=d;g.target=this;if(this.onloaderror){g.OnError=this.onloaderror}g.filename=i.substr(i.lastIndexOf("/")+1);if(h==1||(h+"").toLowerCase()=="mmjson"){if(g.ASYNC){g.responseType="json"}g.parse=function(){var l=g.request.response;if(typeof l!="object"&&l!=null){l=JSON.parse(this.request.responseText)}return this.target.load_PDBx(l,this.pdbid,this.filename)}}else{if(h==2||(h+"").toLowerCase()=="mmcif"){g.parse=function(){return this.target.load_mmCIF(this.request.responseText,this.filename)}}else{if(h==3||(h+"").toLowerCase()=="pdbml"){g.parse=function(){return this.target.load_PDBML(this.request.responseXML,this.filename)}}else{if(h==4||(h+"").toLowerCase()=="pdb"){g.parse=function(){return this.target.load_PDB(this.request.responseText,this.filename)}}else{if(h==5||(h+"").toLowerCase()=="polygon-XML"){g.parse=function(){return this.target.load_polygonXML(this.request.responseXML||this.request.responseText,this.filename)}}else{if(h==6||(h+"").toLowerCase()=="polygon-json"){g.responseType="json";g.parse=function(){var l=g.request.response;if(typeof l!="object"&&l!=null){l=JSON.parse(this.request.responseText)}return this.target.load_polygonJSON(l,this.filename)}}else{if(h.toLowerCase()=="psygene-traj"){g.responseType="arraybuffer";g.parse=function(){var l=this.request.response;this.target.duplicateModelWithTrajectory(l,molmil_dep.getKeyFromObject(f||{},"fxcell",null));return this.target.models}}else{console.log("Unknown format: "+h);return}}}}}}}g.ondone=b;g.OnDone=function(){var m=this.parse();if(!m){return}safeStartViewer(this.target.canvas);if(m instanceof Array&&m.length){this.target.structureFiles.push([m[0].id||i,m])}if(b){b(this.target,m)}else{for(var l=1;l<m.length;l++){m[l].display=false}displayModels(this.target,m,this.target.AID>100000?5:1,true);colorModels(this.target,m,1)}};g.Send(i)};pdbjViewer.prototype.duplicateModelWithTrajectory=function(D,A){var s=0,w,E;this.trajectoryMD=[];var f=this.trajectory=[];while(true){w=[];Array.prototype.push.apply(w,new Int32Array(D,s,2));s+=8;Array.prototype.push.apply(w,new Float32Array(D,s,7));s+=28;Array.prototype.push.apply(w,new Int32Array(D,s,2));s+=8;Array.prototype.push.apply(w,new Float32Array(D,s,1));s+=4;Array.prototype.push.apply(w,new Int32Array(D,s,2));s+=8;this.trajectoryMD.push(w);E=new Float32Array(D,s,w[13]/4);s+=w[13];s+=4;f.push(E);if(s>=D.byteLength){break}}if(A&&A.length&&(A[0]!=0||A[1]!=0||A[2]!=0)){var h=this.models[0];var F,H,C,I,x,q,o,n,u,B,z,y,g,G,t,p=Math.round,J,l,d,b;for(F=0;F<f.length;F++){l=f[F];for(H=0;H<h.chains.length;H++){J=h.chains[H].molecules;for(C=0;C<J.length-1;C++){x=J[C].N||J[C].CA;if(!x){continue}u=J[C+1].N||J[C+1].CA;if(!u){continue}d=(u.AID-1)*3;b=(x.AID-1)*3;G=l[d]-l[b];t=p(G/A[0]);l[b]+=t*A[0];d++;b++;G=l[d]-l[b];t=p(G/A[1]);l[b]+=t*A[1];d++;b++;G=l[d]-l[b];t=p(G/A[2]);l[b]+=t*A[2]}for(C=1;C<J.length;C++){x=J[C].N||J[C].CA;if(!x){continue}u=J[C-1].N||J[C-1].CA;if(!u){continue}d=(u.AID-1)*3;b=(x.AID-1)*3;G=l[d]-l[b];t=p(G/A[0]);l[b]+=t*A[0];d++;b++;G=l[d]-l[b];t=p(G/A[1]);l[b]+=t*A[1];d++;b++;G=l[d]-l[b];t=p(G/A[2]);l[b]+=t*A[2];g=J[C].atoms;for(I=0;I<g.length;I++){d=(x.AID-1)*3;b=(g[I].AID-1)*3;G=l[d]-l[b];t=p(G/A[0]);l[b]+=t*A[0];d++;b++;G=l[d]-l[b];t=p(G/A[1]);l[b]+=t*A[1];d++;b++;G=l[d]-l[b];t=p(G/A[2]);l[b]+=t*A[2]}}}}}return[this.models.length?this.models[0]:{}]};pdbjViewer.prototype.loadStructureData=function(h,l,d,b,g){if(l==1){models=this.load_PDBx(typeof h=="string"?JSON.parse(h):h,d)}else{if(l==2){models=this.load_mmCIF(h,d)}else{if(l==3){models=this.load_PDBML(h,d)}else{if(l==4){models=this.load_PDB(h,d)}else{if(l==5){models=this.load_polygonXML(h,d)}else{if(l==6){models=this.load_polygonJSON(typeof h=="object"?h:JSON.parse(h),d)}else{if(l.toLowerCase()=="psygene-traj"){models=this.duplicateModelWithTrajectory(h,molmil_dep.getKeyFromObject(g||{},"fxcell",null))}}}}}}}if(!models){return}if(this.canvas){safeStartViewer(this.canvas)}this.structureFiles.push([models.length&&models[0].id?models[0].id:d,models]);if(b){b(this,models)}else{for(var f=1;f<models.length;f++){models[f].display=false}displayModels(this,models,this.AID>100000?5:1,true);colorModels(this,models,1)}};pdbjViewer.prototype.getSphere=function(d,f){var b;if(d in this.templates.sphere){return this.templates.sphere[d][f]}else{return this.generateSphere(d)[f]}};pdbjViewer.prototype.getCylinder=function(b){return this.templates.cylinder[b]};pdbjViewer.prototype.generateCylinder=function(){var f,l,d,b,n,m,i,h;for(var g=0;g<this.detail_lvs;g++){f=(g+1)*4;d=0;l=2/f;this.templates.cylinder.push({vertices:[],normals:[],indices:[]});for(b=0;b<f;b++){n=Math.cos(d*Math.PI);m=Math.sin(d*Math.PI);this.templates.cylinder[g].vertices.push(n,m,0);this.templates.cylinder[g].vertices.push(n,m,0.5);h=Math.sqrt(n*n+m*m);this.templates.cylinder[g].normals.push(n/h,m/h,0);this.templates.cylinder[g].normals.push(n/h,m/h,0);d+=l}for(b=0;b<(f-1)*2;b+=2){this.templates.cylinder[g].indices.push(b,b+2,b+3);this.templates.cylinder[g].indices.push(b+3,b+1,b)}this.templates.cylinder[g].indices.push(b,0,1);this.templates.cylinder[g].indices.push(1,b+1,b)}return this.templates.cylinder};pdbjViewer.prototype.getDome=function(d,f){var b;if(d in this.templates.dome){return this.templates.dome[d][f]}else{return this.generateDome(d)[f]}};pdbjViewer.prototype.generateDome=function(g){this.templates.dome[g]=[];var f,d,b,h;for(f=0;f<this.detail_lvs;f++){h=buildOctaDome(f);b={vertices:[],normals:[],indices:[],vertexList:[]};for(d=0;d<h.vertices.length;d++){b.vertices.push(h.vertices[d][0]*g,h.vertices[d][1]*g,h.vertices[d][2]*g);b.vertexList.push([h.vertices[d][0]*g,h.vertices[d][1]*g,h.vertices[d][2]*g])}for(d=0;d<h.faces.length;d++){b.indices.push(h.faces[d][0],h.faces[d][1],h.faces[d][2])}for(d=0;d<h.vertices.length;d++){b.normals.push(h.vertices[d][0],h.vertices[d][1],h.vertices[d][2])}this.templates.dome[g].push(b)}return this.templates.dome[g]};pdbjViewer.prototype.generateSphere=function(h){this.templates.sphere[h]=[];var g,f,d,b;for(g=0;g<this.detail_lvs;g++){d={vertices:[],normals:[],indices:[]};b=octaSphereBuilder(g);for(f=0;f<b.vertices.length;f++){d.vertices.push(b.vertices[f][0]*h,b.vertices[f][1]*h,b.vertices[f][2]*h)}for(f=0;f<b.faces.length;f++){d.indices.push(b.faces[f][0],b.faces[f][1],b.faces[f][2])}for(f=0;f<b.vertices.length;f++){d.normals.push(b.vertices[f][0],b.vertices[f][1],b.vertices[f][2])}this.templates.sphere[h].push(d)}return this.templates.sphere[h]};pdbjViewer.prototype.buildBondList=function(g){this.bonds=[];var q,p,d,b,i,f,l,h,n,o;for(var m=0;m<this.models.length;m++){l=this.models[m];l.bonds=[];for(q=0;q<l.molecules.length;q++){if(l.molecules[q].CA){h=l.molecules[q].xna?64:16;for(p=q+1;p<l.molecules.length;p++){if(l.molecules[q].xna!=l.molecules[p].xna){continue}if(l.molecules[q].C&&l.molecules[p].N){i=l.molecules[q].C.xyz;f=l.molecules[p].N.xyz;dx=i[0]-f[0];dx*=dx;dy=i[1]-f[1];dy*=dy;dz=i[2]-f[2];dz*=dz;r=dx+dy+dz;if(r<=3.24){l.molecules[q].next=l.molecules[p];l.molecules[p].previous=l.molecules[q];l.bonds.push([l.molecules[q].C,l.molecules[p].N,1]);break}}else{if(l.molecules[p].CA){i=l.molecules[q].CA.xyz;f=l.molecules[p].CA.xyz;dx=i[0]-f[0];dx*=dx;dy=i[1]-f[1];dy*=dy;dz=i[2]-f[2];dz*=dz;r=dx+dy+dz;if(r<=h){l.molecules[q].next=l.molecules[p];l.molecules[p].previous=l.molecules[q];break}}}}buildBondsList4Molecule(l.bonds,l.molecules[q]);if(l.molecules[q].name=="CYS"){d=getAtomFromMolecule(l.molecules[q],"SG");if(!d){continue}for(p=q+1;p<l.molecules.length;p++){if(l.molecules[q].CA){if(l.molecules[p].name!="CYS"){continue}b=getAtomFromMolecule(l.molecules[p],"SG");if(!b){continue}i=d.xyz;f=b.xyz;dx=i[0]-f[0];dx*=dx;dy=i[1]-f[1];dy*=dy;dz=i[2]-f[2];dz*=dz;r=dx+dy+dz;if(r<=5){l.bonds.push([d,b,1]);break}}}}}else{buildBondsList4Molecule(l.bonds,l.molecules[q])}}if(g){o=[];for(n=0;n<l.chains.length;n++){chainRef=l.chains[n];h=l.chains[n].molecules.length;for(q=0;q<h;q++){l.chains[n].molecules[q].chain=chainRef;if(((!l.chains[n].molecules[q].next&&q<h-1)||(!l.chains[n].molecules[q].previous&&q!=0))&&(!(l.chains[n].molecules[q].water||l.chains[n].molecules[q].ligand)||(q&&l.chains[n].molecules[q-1].name!=l.chains[n].molecules[q].name))){chainRef=new chainObject(molmil_dep.Strip(chainRef.name),chainRef.model);o.push(chainRef);if(!l.chains[n].molecules[q].previous){l.chains[n].molecules[q].chain=chainRef}}}}if(o.length){Array.prototype.push.apply(l.chains,o);for(n=0;n<l.chains.length;n++){l.chains[n].molecules=[]}for(q=0;q<l.molecules.length;q++){l.molecules[q].chain.molecules.push(l.molecules[q])}for(n=0;n<l.chains.length;n++){if(l.chains[n].molecules.length==0){l.chains.splice(n,1);n--;continue}if(l.chains[n].molecules[0].water||l.chains[n].molecules[0].ligand){l.chains[n].name=(l.chains[n].name?l.chains[n].name+" - ":"")+l.chains[n].molecules[0].name}}}}}};pdbjViewer.prototype.getChain=function(b,g){var d=[];for(var f=0;f<b.chains.length;f++){if(b.chains[f].name==g){d.push(b.chains[f])}}return d};pdbjViewer.prototype.getChainAuth=function(b,g){var d=[];for(var f=0;f<b.chains.length;f++){if(b.chains[f].authName==g){d.push(b.chains[f])}}return d};pdbjViewer.prototype.getMolObject4Chain=function(d,g){if(!d instanceof Array){d=[d]}for(var f=0,b;f<d.length;f++){for(b=0;b<d[f].molecules.length;b++){if(d[f].molecules[b].id==g){return d[f].molecules[b]}}}return null};pdbjViewer.prototype.getMolObject4ChainAlt=function(d,f){if(!d instanceof Array){d=[d]}for(var g=0,b;g<d.length;g++){for(b=0;b<d[g].molecules.length;b++){if(d[g].molecules[b].RSID==f){return d[g].molecules[b]}}}return null};pdbjViewer.prototype.load_PDB=function(O,H){var t=null;var l=null;var A=null;var D=null;var g;var O=O.split("\n");var q,M,d,N,B,w,u,s,h,J,L,F,p,o,G;var C=[];var K=[];var b=[];var n=this.models[0];if(this.models.length!=1||this.models[0].chains.length!=0){cmnum=null;n=null}for(var I=0;I<O.length;I++){if(O[I].substring(0,5)=="MODEL"||!n){if(!n||n.atoms.length){this.models.push(n=new modelObject(O[I].substr(5).trim()))}n.id=H;cmnum=O[I].substr(5).trim();l=D=null;b.push(n)}if(O[I].substring(0,4)=="ATOM"||O[I].substring(0,6)=="HETATM"){q=O[I].substring(21,22).trim();M=O[I].substring(22,28).trim();d=O[I].substring(11,16).trim();N=O[I].substring(17,21).trim();B=parseFloat(O[I].substring(30,38).trim());w=parseFloat(O[I].substring(38,46).trim());u=parseFloat(O[I].substring(46,54).trim());for(s=0;s<d.length;s++){if(!molmil_dep.isNumber(d[s])){break}}if(d.length>1&&!molmil_dep.isNumber(d[1])&&d[1]==d[1].toLowerCase()){h=d.substring(s,s+2)}else{h=d.substring(s,s+1)}if(q!=l){n.chains.push(t=new chainObject(q,n));t.CID=this.CID++;l=q;D=null}if(M!=D){t.molecules.push(A=new molObject(N,M,t));n.molecules.push(A);A.MID=this.MID++;D=M}A.atoms.push(g=new atomObject(B,w,u,d,h,A));if(O[I].substring(0,6)=="HETATM"||A.name=="WAT"){if(A.name=="HOH"||A.name=="WAT"){A.water=true;A.ligand=false}}else{if(g.atomName=="N"){A.N=g;A.ligand=false}else{if(g.atomName=="CA"){A.CA=g;A.ligand=false}else{if(g.atomName=="C"){A.C=g;A.ligand=false}else{if(g.atomName=="O"){A.O=g;A.ligand=false}else{if(g.atomName=="P"){A.N=g;A.xna=true;A.ligand=false}else{if(g.atomName=="C1'"){A.CA=g;A.xna=true;A.ligand=false}else{if(g.atomName=="O3'"){A.C=g;A.xna=true;A.ligand=false}}}}}}}}n.atoms.push(g);g.AID=this.AID++;this.atomRef[g.AID]=g}else{if(O[I].length>18&&O[I].substring(0,18)=="REMARK 350   BIOMT"){if(O[I].substring(18,19)=="1"){J=mat4.create();L=O[I].substring(22).trim().split(/\s+/);J[0]=parseFloat(L[1]);J[4]=parseFloat(L[2]);J[8]=parseFloat(L[3]);J[12]=parseFloat(L[4])}else{if(O[I].substring(18,19)=="2"){L=O[I].substring(22).trim().split(/\s+/);J[1]=parseFloat(L[1]);J[5]=parseFloat(L[2]);J[9]=parseFloat(L[3]);J[13]=parseFloat(L[4])}else{if(O[I].substring(18,19)=="3"){L=O[I].substring(22).trim().split(/\s+/);J[2]=parseFloat(L[1]);J[6]=parseFloat(L[2]);J[10]=parseFloat(L[3]);J[14]=parseFloat(L[4]);this.bumats.push(J)}}}}else{if(O[I].substring(0,5)=="HELIX"){C.push([O[I].substring(18,20).trim(),O[I].substring(20,25).trim(),O[I].substring(30,32).trim(),O[I].substring(32,37).trim()])}else{if(O[I].substring(0,5)=="SHEET"){K.push([O[I].substring(20,22).trim(),O[I].substring(22,26).trim(),O[I].substring(31,33).trim(),O[I].substring(33,37).trim()])}}}}}if(this.models.length>1&&this.models[0].molecules.length==0){this.models.shift()}this.calculateCOG();this.buildBondList(true);var f;for(var I=0,E;I<C.length;I++){for(E=0;E<b.length;E++){f=3;start=this.getMolObject4Chain(this.getChain(b[E],C[I][0]),C[I][1]);end=this.getMolObject4Chain(this.getChain(b[E],C[I][2]),C[I][3]);while(end){if(start==null){break}start.sndStruc=f;if(start==end){break}start=start.next}}}for(var I=0,E;I<K.length;I++){for(E=0;E<b.length;E++){start=this.getMolObject4Chain(this.getChain(b[E],K[I][0]),K[I][1]);end=this.getMolObject4Chain(this.getChain(b[E],K[I][2]),K[I][3]);while(end){if(start==null){break}start.sndStruc=2;if(start==end){break}start=start.next}}}if(!C.length&&!K.length){for(var I=0;I<b.length;I++){this.ssAssign(b[I])}}resetColors(this);this.renderer.camera.z=this.calcZ();this.files.push({models:b,id:H});return b};pdbjViewer.prototype.calcZ=function(){var b=Math.max(Math.abs(this.geomRanges[0]),Math.abs(this.geomRanges[1]),Math.abs(this.geomRanges[2]),Math.abs(this.geomRanges[3]),Math.abs(this.geomRanges[4]),Math.abs(this.geomRanges[5]));if(molmilConfigBox.projectionMode==1){return -b*molmilConfigBox.zFar/1500}else{return -(b/Math.min(this.renderer.width,this.renderer.height))*molmilConfigBox.zFar*(0.625)}};pdbjViewer.prototype.load_polygonJSON=function(d,b){var l=new polygonObject();l.filename=b;l.vertices=d.vertices||[];l.triangles_lists=d.triangles_lists||[];l.lines_lists=d.lines_lists||[];l.lineVertices=[];l.triangleVertices=[];var h;if(d.hasOwnProperty("vertices2")){for(var g=0;g<d.vertices2.length;g++){d.vertices2[g].splice(3,0,0,0,0)}Array.prototype.push.apply(l.vertices,d.vertices2)}for(var g=0,f;g<l.triangles_lists.length;g++){h=[];for(f=0;f<l.triangles_lists[g].length;f++){h.push(l.triangles_lists[g][f][0],l.triangles_lists[g][f][1],l.triangles_lists[g][f][2])}if(h.length){l.triangleVertices.push(h.unique())}}for(var g=0;g<l.lines_lists.length;g++){h=[];for(f=0;f<l.lines_lists[g].length;f++){h.push(l.lines_lists[g][f][0],l.lines_lists[g][f][1])}if(h.length){h.unique();l.lineVertices.push(h)}}this.polygonData.push(l);this.calculateCOG();this.renderer.camera.z=this.calcZ();this.files.push({polygon:l,filename:b});return l};pdbjViewer.prototype.load_polygonXML=function(o,b){if(typeof o=="string"){var d=new DOMParser();o=d.parseFromString(o,"text/xml")}var p={};var t=new polygonObject();t.filename=b;t.triangles_lists=[];t.lines_lists=[];var g=[],f=[],s,u;var q=o.documentElement.childNodes,w,l,n,h;for(var m=0;m<q.length;m++){if(q[m].tagName=="vertices"){w=q[m].childNodes;for(l=0;l<w.length;l++){if(w[l].tagName!="vertex"){continue}n=w[l].getAttribute("image").split(/\s+/);for(h=0;h<9;h++){n[h]=parseFloat(n[h])}n[6]=n[6]/255;n[7]=n[7]/255;n[8]=n[8]/255;p[w[l].getAttribute("id")]=t.vertices.length;t.vertices.push(n)}}else{if(q[m].tagName=="triangle_array"){w=q[m].childNodes;s=[];u=[];for(l=0;l<w.length;l++){if(w[l].tagName!="triangle"){continue}n=w[l].getAttribute("vertex").split(/\s+/);for(h=0;h<3;h++){n[h]=p[n[h]]}u.push(n);s.push(n[0],n[1],n[2])}if(s.length){f.push(s.unique());t.triangles_lists.push(u)}}else{if(q[m].tagName=="line_array"){w=q[m].childNodes;s=[];u=[];for(l=0;l<w.length;l++){if(w[l].tagName!="line"){continue}n=w[l].getAttribute("vertex").split(/\s+/);for(h=0;h<2;h++){n[h]=p[n[h]]}u.push(n);s.push(n[0],n[1])}if(s.length){g.push(s.unique());t.lines_lists.push(u)}}else{if(q[m].tagName=="polyline_array"){w=q[m].childNodes;s=[];u=[];for(l=0;l<w.length;l++){if(w[l].tagName!="polyline"){continue}n=w[l].getAttribute("vertex").split(/\s+/);for(h=0;h<n.length;h++){n[h]=p[n[h]]}for(h=0;h<n.length-1;h++){u.push([n[h],n[h+1]]);s.push(n[h],n[h+1])}}if(s.length){g.push(s.unique());t.lines_lists.push(u)}}}}}}t.lineVertices=g;t.triangleVertices=f;this.polygonData.push(t);this.calculateCOG();if(!this.skipCOGupdate){this.renderer.camera.z=this.calcZ()}this.files.push({polygon:t,filename:b});return t};pdbjViewer.prototype.load_mmCIF=function(d){var b=loadCIF(d);return this.load_PDBx(b)};pdbjViewer.prototype.load_PDBML=function(d){if(typeof d=="string"){var f=new DOMParser();d=f.parseFromString(d,"text/xml")}var b=loadPDBML(d);return this.load_PDBx(b)};pdbjViewer.prototype.load_PDBx=function(s){var p=Object.keys(s)[0].substr(5).split("-")[0];var B=s["data_"+p];var d=B.atom_site||B.chem_comp_atom||{group_PDB:[],Cartn_x:[],Cartn_y:[],Cartn_z:[]};var U=d.group_PDB||d.atom_id;var T=d.Cartn_x||(d.pdbx_model_Cartn_x_ideal[0]!=null?d.pdbx_model_Cartn_x_ideal:d.model_Cartn_x);var S=d.Cartn_y||(d.pdbx_model_Cartn_x_ideal[0]!=null?d.pdbx_model_Cartn_y_ideal:d.model_Cartn_y);var R=d.Cartn_z||(d.pdbx_model_Cartn_x_ideal[0]!=null?d.pdbx_model_Cartn_z_ideal:d.model_Cartn_z);var V=d.id;var q=d.auth_seq_id||[];var M=d.auth_comp_id;var D=d.label_seq_id||[];var L=d.label_comp_id||d.comp_id;var l=d.auth_asym_id||[];var h=d.label_asym_id||[];var F=d.label_alt_id||[];var y=d.auth_atom_id||d.atom_id;var w=d.label_atom_id||[];var am=d.type_symbol;var ae=d.pdbx_PDB_model_num;var E=null;var ac=null;var at=null;var X=null;var b;var P=ae?ae[0]:null;var f,u=[];for(var ar=0;ar<U.length;ar++){if((ae&&ae[ar]!=P)||!f){this.models.push(f=new modelObject(ae?ae[ar]:u.length,p));P=f.model_num;ac=X=null;u.push(f)}if(h[ar]!=ac||!E){f.chains.push(E=new chainObject(h[ar],f));E.authName=l[ar];E.CID=this.CID++;ac=h[ar];X=null}if((D[ar]||q[ar])!=X||!at){E.molecules.push(at=new molObject((L[ar]||M[ar]),(D[ar]||q[ar]),E));at.RSID=q[ar]||D[ar];f.molecules.push(at);at.MID=this.MID++;X=(D[ar]||q[ar])}at.atoms.push(b=new atomObject(T[ar],S[ar],R[ar],y[ar]||w[ar]||"",am[ar]||"",at));b.label_alt_id=F[ar];if(U[ar]!="ATOM"){if(at.name=="HOH"||at.name=="WAT"){at.water=true;at.ligand=false}}else{if(b.atomName=="N"){at.N=b;at.ligand=false}else{if(b.atomName=="CA"){at.CA=b;at.ligand=false}else{if(b.atomName=="C"){at.C=b;at.ligand=false}else{if(b.atomName=="O"){at.O=b;at.ligand=false}else{if(b.atomName=="P"){at.N=b;at.xna=true;at.ligand=false;if(!at.CA){at.CA=b}}else{if(b.atomName=="C1'"){at.CA=b;at.xna=true;at.ligand=false}else{if(b.atomName=="O3'"){at.C=b;at.xna=true;at.ligand=false}}}}}}}b.model_num=ae?ae[ar]:1}f.atoms.push(b);b.AID=this.AID++;this.atomRef[b.AID]=b}this.calculateCOG();if(B.chem_comp_bond){var ap={};for(var aj=0;aj<this.models[0].atoms.length;aj++){ap[this.models[0].atoms[aj].atomName]=this.models[0].atoms[aj]}var aa,Z;for(var aj=0;aj<B.chem_comp_bond.atom_id_1.length;aj++){aa=ap[B.chem_comp_bond.atom_id_1[aj]];Z=ap[B.chem_comp_bond.atom_id_2[aj]];this.models[0].bonds.push([aa,Z,B.chem_comp_bond.value_order[aj]=="DOUB"?2:1])}}else{this.buildBondList()}var Y,W,g,ah,t,J,A;var aq=B.struct_conf;if(aq&&U.length){for(var aj=0,ab;aj<aq.id.length;aj++){Y=aq.conf_type_id[aj];if(Y=="HELX_P"){Y=3}else{if(Y=="TURN_P"){Y=4}else{continue}}W=aq.beg_label_asym_id[aj];g=aq.beg_label_seq_id[aj];ah=aq.end_label_asym_id[aj];t=aq.end_label_seq_id[aj];for(ab=0;ab<u.length;ab++){J=this.getMolObject4Chain(this.getChain(u[ab],W),g);A=this.getMolObject4Chain(this.getChain(u[ab],ah),t);while(A){if(J==null){break}J.sndStruc=Y;if(J==A){break}J=J.next}}}}var ai=B.struct_sheet_range;if(ai&&U.length){for(var aj=0,ab;aj<ai.beg_label_asym_id.length;aj++){W=ai.beg_label_asym_id[aj];g=ai.beg_label_seq_id[aj];ah=ai.end_label_asym_id[aj];t=ai.end_label_seq_id[aj];for(ab=0;ab<u.length;ab++){J=this.getMolObject4Chain(this.getChain(u[ab],W),g);A=this.getMolObject4Chain(this.getChain(u[ab],ah),t);while(A){if(J==null){break}J.sndStruc=2;if(J==A){break}J=J.next}}}}var Q;if(B.hasOwnProperty("entity_poly")){Q=B.entity_poly.entity_id;for(var aj=0;aj<B.struct_asym.id.length;aj++){if(Q.indexOf(B.struct_asym.entity_id[aj])!=-1){this.poly_asym_ids.push(B.struct_asym.id[aj])}}}var G=B.pdbx_struct_oper_list;if(G){var aj,C=G.type.length;var z=!G.hasOwnProperty("matrix[1][1]");for(aj=0;aj<C;aj++){K=mat4.create();K[0]=G[z?"matrix11":"matrix[1][1]"][aj];K[4]=G[z?"matrix12":"matrix[1][2]"][aj];K[8]=G[z?"matrix13":"matrix[1][3]"][aj];K[12]=G[z?"vector1":"vector[1]"][aj];K[1]=G[z?"matrix21":"matrix[2][1]"][aj];K[5]=G[z?"matrix22":"matrix[2][2]"][aj];K[9]=G[z?"matrix23":"matrix[2][3]"][aj];K[13]=G[z?"vector2":"vector[2]"][aj];K[2]=G[z?"matrix31":"matrix[3][1]"][aj];K[6]=G[z?"matrix32":"matrix[3][2]"][aj];K[10]=G[z?"matrix33":"matrix[3][3]"][aj];K[14]=G[z?"vector3":"vector[3]"][aj];if(K[0]==1&&K[1]==0&&K[2]==0&&K[3]==0&&K[4]==0&&K[5]==1&&K[6]==0&&K[7]==0&&K[8]==0&&K[9]==0&&K[10]==1&&K[11]==0&&K[12]==0&&K[13]==0&&K[14]==0&&K[15]==1){this.BUmatrices[G.id[aj]]=["identity operation",K]}else{this.BUmatrices[G.id[aj]]=[G.type[aj],K]}}var N=B.pdbx_struct_assembly_gen,ao,al,ak=mat4.create(),ag,ad,I;C=N.assembly_id.length;var x=function(i){al=[];if(i.indexOf("-")!=-1){i=i.replace("(","").replace(")","").split("-");for(ad=parseInt(i[0]);ad<parseInt(i[1])+1;ad++){al.push(ad)}return al}else{return i.split(",")}};for(aj=0;aj<C;aj++){if(!this.BUassemblies.hasOwnProperty(N.assembly_id[aj])){this.BUassemblies[N.assembly_id[aj]]=[]}I=[];if(N.oper_expression[aj].indexOf(")(")!=-1){ao=N.oper_expression[aj].split(")(");ao[0]=x(ao[0].substr(1));ao[1]=x(ao[1].substr(0,ao[1].length-1));for(ag=0;ag<ao[0].length;ag++){for(ad=0;ad<ao[1].length;ad++){Q="combi_"+ao[0][ag]+"_"+ao[1][ad];if(!this.BUmatrices.hasOwnProperty(Q)){mat4.multiply(ak,this.BUmatrices[ao[0][ag]][1],this.BUmatrices[ao[1][ad]][1]);this.BUmatrices[Q]=["combined",JSON.parse(JSON.stringify(ak))]}I.push(Q)}}}else{I=x(N.oper_expression[aj])}this.BUassemblies[N.assembly_id[aj]].push([I,N.asym_id_list[aj].split(",")])}var K,n,af=[],aj,ag,H=false;var C=G.type.length,au;var z=!G.hasOwnProperty("matrix[1][1]");for(aj=0;aj<C;aj++){au=G.type[aj];if(au=="transform to point frame"||au=="transform to crystal frame"||au=="3D crystal symmetry operation"||au=="2D crystal symmetry operation"||au=="transform to helical frame"||au=="transform to crystal frame"||au=="transform to 2D crystal frame"||au=="transform to 3D crystal frame"||au=="build helical asymmetric unit"||au=="build 2D crystal asymmetric unit"||au=="build 3D crystal asymmetric unit"){continue}if(au=="point symmetry operation"){K=mat4.create();af.push(K)}else{K=mat4.create()}K[0]=G[z?"matrix11":"matrix[1][1]"][aj];K[4]=G[z?"matrix12":"matrix[1][2]"][aj];K[8]=G[z?"matrix13":"matrix[1][3]"][aj];K[12]=G[z?"vector1":"vector[1]"][aj];K[1]=G[z?"matrix21":"matrix[2][1]"][aj];K[5]=G[z?"matrix22":"matrix[2][2]"][aj];K[9]=G[z?"matrix23":"matrix[2][3]"][aj];K[13]=G[z?"vector2":"vector[2]"][aj];K[2]=G[z?"matrix31":"matrix[3][1]"][aj];K[6]=G[z?"matrix32":"matrix[3][2]"][aj];K[10]=G[z?"matrix33":"matrix[3][3]"][aj];K[14]=G[z?"vector3":"vector[3]"][aj];if(au=="build point asymmetric unit"){for(ag=0;ag<af.length;ag++){n=mat4.create();mat4.multiply(n,af[ag],K);this.bumats.push(n)}H=true}this.bumats.push(K)}if(!H){for(ag=0;ag<af.length;ag++){this.bumats.push(af[ag])}}if(this.bumats.length>1){this.BU=true}}var N=B.pdbx_struct_assembly_gen;if(N&&typeof(N.assembly_id)=="object"){this.noau=N.assembly_id.length;var aj,ag,o,ab,an,O;for(aj=1;aj<N.asym_id_list.length;aj++){o=N.asym_id_list[aj].split(",");for(ag=0;ag<o.length;ag++){for(ab=0;ab<u.length;ab++){an=this.getChain(u[ab],o[ag]);for(O=0;O<an.length;O++){this.BU=an[O].AU_only=true}}}}this.BU_operExp=N.oper_expression[0];o=N.asym_id_list[0].split(",");for(ag=0;ag<o.length;ag++){for(ab=0;ab<u.length;ab++){an=this.getChain(u[ab],o[ag]);for(O=0;O<an.length;O++){an[O].AU_only=false}}}}resetColors(this);this.smoothStructure();this.renderer.camera.z=this.calcZ();this.files.push({models:u,id:p});return u};pdbjViewer.prototype.smoothStructure=function(){};pdbjViewer.prototype.smoothStructure2=function(){return false};pdbjViewer.prototype.calculateCOG=function(){if(this.skipCOGupdate){return}this.avgX=0;this.avgY=0;this.avgZ=0;this.stdX=0;this.stdY=0;this.stdZ=0;this.avgXYZ=[0,0,0];this.stdXYZ=[0,0,0];var f=0;var x;var t;var y=[];this.geomRanges=[0,0,0,0,0,0];var q=this.models[0];if(q&&q.atoms.length){for(var g=0;g<q.molecules.length;g++){if(!q.molecules[g].status){continue}if(q.molecules[g].ligand||q.molecules[g].water){for(var u=0;u<q.molecules[g].atoms.length;u++){t=q.molecules[g].atoms[u].xyz;this.avgX+=t[0];this.avgY+=t[1];this.avgZ+=t[2];y.push(t);f++}}else{x=q.molecules[g].CA;if(x!=null){t=x.xyz;this.avgX+=t[0];this.avgY+=t[1];this.avgZ+=t[2];y.push(t);f+=1}}}}else{for(var o=0,h;o<this.polygonData.length;o++){for(h=0;h<this.polygonData[o].vertices.length;h++){t=[this.polygonData[o].vertices[h][0],this.polygonData[o].vertices[h][1],this.polygonData[o].vertices[h][2]];this.avgX+=t[0];this.avgY+=t[1];this.avgZ+=t[2];y.push(t);f++}}}if(f==0){return}this.avgX/=f;this.avgY/=f;this.avgZ/=f;var b=1e+99,p=-1e+99,w=1e+99,d=-1e+99,s=1e+99,z=-1e+99;var l;for(var o=0;o<f;o++){l=y[o][0]-this.avgX;this.stdX+=l*l;if(l<b){b=l}if(l>p){p=l}l=y[o][1]-this.avgY;this.stdY+=l*l;if(l<w){w=l}if(l>d){d=l}l=y[o][2]-this.avgZ;this.stdZ+=l*l;if(l<s){s=l}if(l>z){z=l}}this.stdX=Math.sqrt(this.stdX/f);this.stdY=Math.sqrt(this.stdY/f);this.stdZ=Math.sqrt(this.stdZ/f);this.avgXYZ=[this.avgX,this.avgY,this.avgZ];this.stdXYZ=[this.stdX,this.stdY,this.stdZ];this.COR=this.avgXYZ;this.geomRanges=[b,p,w,d,s,z]};pdbjViewer.prototype.gotoMol=function(d){return;var f=[0,0,0];if(d.CA){f=d.CA.xyz}else{for(var b=0;b<d.atoms.length;b++){vec3.add(out,out,d.atoms[b].xyz)}vec3.divide(out,out,d.atoms.length)}};pdbjViewer.prototype.ssAssign=function(d){var g,f;for(var N=0;N<d.molecules.length;N++){g=d.molecules[N];if(g.ligand||g.water||g.name=="PRO"||g.xna){continue}if(g.previous){try{g.NH={xyz:[0,0,0]};vec3.subtract(g.NH.xyz,g.previous.C.xyz,g.previous.O.xyz);vec3.normalize(g.NH.xyz,g.NH.xyz);vec3.add(g.NH.xyz,g.NH.xyz,g.N.xyz)}catch(S){g.NH=null}}else{g.NH=true}}var K,J,I;var D=function(m,i){K=i[0]-m[0];J=i[1]-m[1];I=i[2]-m[2];return K*K+J*J+I*I};var h={},b={},n=[],U;var R,Q,p,M,H,L,F;for(R=0;R<d.molecules.length;R++){g=d.molecules[R];if(g.ligand||g.water||g.xna){continue}if(!g.previous){n.push(U=[])}U.push(g);for(Q=R+2;Q<d.molecules.length;Q++){f=d.molecules[Q];if(f.ligand||f.water||g.xna||!g.N||!f.C||!g.C||!f.N){continue}M=D(g.N.xyz,f.C.xyz);if(M<25&&g.NH){M=Math.sqrt(M);H=Math.sqrt(D(g.N.xyz,f.O.xyz));if(g.NH==true){L=M-1;F=H-1}else{L=Math.sqrt(D(g.NH.xyz,f.C.xyz));F=Math.sqrt(D(g.NH.xyz,f.O.xyz))}p=0.084*((1/H)+(1/L)-(1/F)-(1/M))*332;if(p<-0.67){h[g.MID+"-"+f.MID]=p;if(!b.hasOwnProperty(g.MID)){b[g.MID]=[]}b[g.MID].push(f);if(!b.hasOwnProperty(f.MID)){b[f.MID]=[]}b[f.MID].push(g)}}M=D(f.N.xyz,g.C.xyz);if(M<25&&f.NH){M=Math.sqrt(M);H=Math.sqrt(D(f.N.xyz,g.O.xyz));if(f.NH==true){L=M-1;F=H-1}else{L=Math.sqrt(D(f.NH.xyz,g.C.xyz));F=Math.sqrt(D(f.NH.xyz,g.O.xyz))}p=0.084*((1/H)+(1/L)-(1/F)-(1/M))*332;if(p<-0.67){h[f.MID+"-"+g.MID]=p;if(!b.hasOwnProperty(g.MID)){b[g.MID]=[]}b[g.MID].push(f);if(!b.hasOwnProperty(f.MID)){b[f.MID]=[]}b[f.MID].push(g)}}}}var G=function(i){return i?i.MID:null};var A,w,l,o;var q=[],X,C,B,T,u,t;for(var W=0;W<n.length;W++){q.push(X=[]);for(R=0;R<n[W].length;R++){l=0;A=G(n[W][R]);C=B=[W,R];if(h.hasOwnProperty(G(n[W][R+3])+"-"+A)){l=3;C=[W,R];B=[W,R+3]}else{if(h.hasOwnProperty(A+"-"+G(n[W][R-3]))){l=3;C=[W,R-3];B=[W,R]}}if(h.hasOwnProperty(G(n[W][R+5])+"-"+A)){l=5;C=[W,R];B=[W,R+5]}else{if(h.hasOwnProperty(A+"-"+G(n[W][R-5]))){l=5;C=[W,R-5];B=[W,R]}}if(h.hasOwnProperty(G(n[W][R+4])+"-"+A)){l=4;C=[W,R];B=[W,R+4]}else{if(h.hasOwnProperty(A+"-"+G(n[W][R-4]))){l=4;C=[W,R-4];B=[W,R]}}X.push([l,C,B])}}l=0;for(var W=0;W<q.length;W++){X=q[W];o=[];for(R=0;R<X.length;R++){if(X[R][0]!=l){if(l==3||l==4||l==5){if((o.length>1&&l!=3)||o.length>2){for(Q=o[0][1][1];Q<o[o.length-1][2][1];Q++){n[W][Q].sndStruc=3}}else{if(o.length){var V=false;for(Q=o[0][1][1];Q<o[o.length-1][2][1];Q++){if(!n[W][Q].sndStruc){n[W][Q].sndStruc=4}}}}}l=0;o=[]}if(X[R][0]){o.push(X[R]);l=X[R][0]}}}var s;for(var W=0;W<n.length;W++){for(R=0;R<n[W].length;R++){if(n[W][R].sndStruc!=3){T=null;if(n[W][R].previous&&n[W][R].next){u=b[G(n[W][R].previous)];t=b[G(n[W][R].next)];if(u&&t){for(var P=0,O;P<u.length;P++){for(O=0;O<t.length;O++){if(u[P].previous&&u[P].previous==t[O].next){T=[u[P].previous];break}else{if(t[O].previous&&t[O].previous==u[P].next){T=[u[P].next];break}}}if(T){break}}}}if(!T){T=b[G(n[W][R])]}if(T){for(s=0;s<T.length;s++){if(T[s].sndStruc==2){n[W][R].sndStruc=2;break}u=[n[W][R].previous,n[W][R],n[W][R].next];t=[T[s].previous,T[s],T[s].next];if(h.hasOwnProperty(G(u[0])+"-"+G(t[1]))&&h.hasOwnProperty(G(t[1])+"-"+G(u[2]))){u[0].sndStruc=u[1].sndStruc=u[2].sndStruc=t[1].sndStruc=2}else{if(h.hasOwnProperty(G(u[1])+"-"+G(t[0]))&&h.hasOwnProperty(G(t[2])+"-"+G(u[1]))){u[1].sndStruc=t[0].sndStruc=t[1].sndStruc=t[2].sndStruc=2}else{if(h.hasOwnProperty(G(u[1])+"-"+G(t[1]))&&h.hasOwnProperty(G(t[1])+"-"+G(u[1]))){u[1].sndStruc=t[1].sndStruc=2}else{if(h.hasOwnProperty(G(u[0])+"-"+G(t[2]))&&h.hasOwnProperty(G(u[2])+"-"+G(t[0]))){u[0].sndStruc=u[1].sndStruc=u[2].sndStruc=t[0].sndStruc=t[1].sndStruc=t[2].sndStruc=2}}}}}}}}}};function cartoonBuilder(h,t,s){this.noi=molmilConfigBox.QLV_SETTINGS[s].CB_NOI;this.radius=0.5;this.novpr=molmilConfigBox.QLV_SETTINGS[s].CB_NOVPR;this.soup=h;this.gl=this.soup.renderer.gl;this.mainBuffer=t;this.dome=[buildOctaDome(molmilConfigBox.QLV_SETTINGS[s].CB_DOME_TESS_LV,0),buildOctaDome(molmilConfigBox.QLV_SETTINGS[s].CB_DOME_TESS_LV,1)];var q=mat4.create();mat4.rotateZ(q,q,(45*Math.PI)/180);for(var g=0;g<this.dome[0].vertices.length;g++){vec3.transformMat4(this.dome[0].vertices[g],this.dome[0].vertices[g],q);vec3.transformMat4(this.dome[1].vertices[g],this.dome[1].vertices[g],q)}this.ringTemplate=[];var f=this.novpr,d=0,m=2/f,o,n,b,l;for(b=0;b<f;b++){o=Math.cos(d*Math.PI);n=Math.sin(d*Math.PI);this.ringTemplate.push([o,n]);d+=m}this.squareVertices=[];this.squareVertices.push([-this.radius*2,this.radius]);this.squareVertices.push([this.radius*2,this.radius]);this.squareVertices.push([this.radius*2,-this.radius]);this.squareVertices.push([-this.radius*2,-this.radius]);this.someLines=[]}cartoonBuilder.prototype.interpolate=function(g,f,d,b,h){g=g.smooth?g.smoothedPoint:g.CA.xyz;f=f.smooth?f.smoothedPoint:f.CA.xyz;d=d.smooth?d.smoothedPoint:d.CA.xyz;b=b.smooth?b.smoothedPoint:b.CA.xyz;var l=[0.75*(d[0]-g[0]),0.75*(d[1]-g[1]),0.75*(d[2]-g[2])];var i=[0.75*(b[0]-f[0]),0.75*(b[1]-f[1]),0.75*(b[2]-f[2])];return hermiteInterpolate(f,d,l,i,this.noi,h)};cartoonBuilder.prototype.calcTangentHI=function(g,f,d,b){g=g.smooth?g.smoothedPoint:g.CA.xyz;f=f.smooth?f.smoothedPoint:f.CA.xyz;d=d.smooth?d.smoothedPoint:d.CA.xyz;b=b.smooth?b.smoothedPoint:b.CA.xyz;var i=[0.75*(d[0]-g[0]),0.75*(d[1]-g[1]),0.75*(d[2]-g[2])];var h=[0.75*(b[0]-f[0]),0.75*(b[1]-f[1]),0.75*(b[2]-f[2])];return calcTangentHI(f,d,i,h)};cartoonBuilder.prototype.upload=function(g){if(!g.buffers.CARTOONpositionBuffer){g.buffers.CARTOONpositionBuffer=this.gl.createBuffer()}this.gl.bindBuffer(this.gl.ARRAY_BUFFER,g.buffers.CARTOONpositionBuffer);this.gl.bufferData(this.gl.ARRAY_BUFFER,this.positions,this.gl.STATIC_DRAW);if(!g.buffers.CARTOONcolorBuffer){g.buffers.CARTOONcolorBuffer=this.gl.createBuffer()}this.gl.bindBuffer(this.gl.ARRAY_BUFFER,g.buffers.CARTOONcolorBuffer);this.gl.bufferData(this.gl.ARRAY_BUFFER,this.colors,this.gl.STATIC_DRAW);if(!g.buffers.CARTOONnormalBuffer){g.buffers.CARTOONnormalBuffer=this.gl.createBuffer()}this.gl.bindBuffer(this.gl.ARRAY_BUFFER,g.buffers.CARTOONnormalBuffer);this.gl.bufferData(this.gl.ARRAY_BUFFER,this.normals,this.gl.STATIC_DRAW);if(!g.buffers.CARTOONindexBuffer){g.buffers.CARTOONindexBuffer=this.gl.createBuffer()}this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,g.buffers.CARTOONindexBuffer);this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,this.indices,this.gl.STATIC_DRAW);g.buffers.CARTOONpositionBuffer.items=Math.floor(this.i);var f=new Float32Array(this.someLines.length*2*3);var d=new Float32Array(this.someLines.length*2*3);for(var b=0,h=0;b<this.someLines.length;b++,h+=6){f[h]=this.someLines[b][0][0];f[h+1]=this.someLines[b][0][1];f[h+2]=this.someLines[b][0][2];f[h+3]=this.someLines[b][1][0];f[h+4]=this.someLines[b][1][1];f[h+5]=this.someLines[b][1][2];if(this.someLines[b].length>2){d[h]=d[h+3]=this.someLines[b][2][0];d[h+1]=d[h+4]=this.someLines[b][2][1];d[h+2]=d[h+5]=this.someLines[b][2][2]}}if(!g.buffers.CTBpositionBuffer){g.buffers.CTBpositionBuffer=this.gl.createBuffer()}this.gl.bindBuffer(this.gl.ARRAY_BUFFER,g.buffers.CTBpositionBuffer);this.gl.bufferData(this.gl.ARRAY_BUFFER,f,this.gl.STATIC_DRAW);if(!g.buffers.CTBcolorBuffer){g.buffers.CTBcolorBuffer=this.gl.createBuffer()}this.gl.bindBuffer(this.gl.ARRAY_BUFFER,g.buffers.CTBcolorBuffer);this.gl.bufferData(this.gl.ARRAY_BUFFER,d,this.gl.STATIC_DRAW);g.buffers.CTBpositionBuffer.items=Math.floor(this.someLines.length*2)};cartoonBuilder.prototype.prepare=function(D){this.trace=D;this.commands=[];var b,ai,W,u,s,ab,Y,X,U,O,aa;var w=[0,0,0],T=[0,0,0],S=[0,0,0],M=Number.MAX_VALUE,R=0.0001,y,Z=[0,0,0],B=[0,0,0];var P=mat4.create(),z=mat4.create();function ad(i){if(i[0]<=M){M=i[0];T=[1,0,0]}if(i[1]<=M){M=i[1];T=[0,1,0]}if(i[2]<=M){M=i[2];T=[0,0,1]}vec3.cross(w,i,T);vec3.normalize(w,w);vec3.cross(T,i,w);vec3.cross(S,i,T)}function ae(p,i){vec3.cross(w,p,i);if(vec3.length(w)>R){vec3.normalize(w,w);y=Math.acos(Math.max(-1,Math.min(1,vec3.dot(p,i))));mat4.rotate(P,z,y,w);vec3.transformMat4(T,T,P)}vec3.cross(S,i,T)}function x(N,p){var aj=[0,0,0],i=[0,0];vec3.cross(aj,N,p);vec3.normalize(aj,aj);vec3.cross(i,aj,p);return[aj,i]}function I(i,p){S=[i[0],i[1],i[2]];vec3.scaleAndAdd(S,S,p,-vec3.dot(S,p)/vec3.dot(p,p));vec3.cross(T,S,p);B=[S[0],S[1],S[2]]}function V(i,N,ak,aj){vec3.lerp(S,i,N,ak);vec3.scaleAndAdd(S,S,aj,-vec3.dot(S,aj)/vec3.dot(aj,aj));vec3.normalize(S,S);vec3.cross(T,S,aj);vec3.normalize(T,T)}var h=this.noi*0.5+1;var L=[0,0,0],t;var A=function(N,p,al,i,ak){var am=null,aj=null;for(aa=0;aa<N.length;aa++){if((al[0]==0||al[0]==2)&&aa==0){this.commands.push([this.loopStart,[N[aa],p.rgb]]);if(al[1]==3&&i&&ak){am=[[0,0,0],[0,0,0]];vec3.lerp(am[0],i,ak,aa/N.length);vec3.scaleAndAdd(am[0],am[0],N[aa][1],-vec3.dot(am[0],N[aa][1])/vec3.dot(N[aa][1],N[aa][1]));vec3.cross(am[1],am[0],N[aa][1]);S=am[0];T=am[1]}else{ad(N[aa][1]);if(al[2]==3&&ak){L=[S[0],S[1],S[2]];y=vec3.dot(S,ak);if(y<=-0.5){t=true}else{t=false}}}this.mainBuffer.allocateVertices(this.dome[0].vertices.length,this.dome[0].faces.length);this.mainBuffer.allocateVerticesSplitable(this.novpr,this.novpr*2)}else{if(al[2]==0&&aa==this.noi+1){this.commands.push([this.loopEnd,[N[aa],p.rgb]]);N[aa].push([T[0],T[1],T[2]],[S[0],S[1],S[2]]);this.mainBuffer.allocateVerticesSplitable(this.novpr,this.novpr*2);this.mainBuffer.allocateVertices(this.dome[0].vertices.length,this.dome[0].faces.length)}else{if((al[1]==3||al[2]==3)&&i&&ak){am=[[0,0,0],[0,0,0],t];vec3.lerp(am[0],i,ak,aa/N.length);vec3.scaleAndAdd(am[0],am[0],N[aa][1],-vec3.dot(am[0],N[aa][1])/vec3.dot(N[aa][1],N[aa][1]));if(t){vec3.negate(am[0],am[0])}vec3.cross(am[1],am[0],N[aa][1]);if(al[1]==3){aj=1;if(al[0]!=al[1]){aj=Math.min(1,aa/N.length)}else{if(al[1]!=al[2]){aj=Math.max(0,1-(aa/N.length))}}aj=1+aj;S=am[0];vec3.normalize(S,S);T=am[1];vec3.normalize(T,T)}else{if(al[2]==3){if(aa==0){ae(this.commands[this.commands.length-1][1][0][1],N[aa][1]);L=[S[0],S[1],S[2]];vec3.normalize(L,L);y=vec3.dot(S,ak);if(y<=-0.5){t=true}else{t=false}}else{if(t){vec3.lerp(S,L,vec3.negate([0,0,0],ak),aa/N.length)}else{vec3.lerp(S,L,ak,aa/N.length)}vec3.scaleAndAdd(S,S,N[aa][1],-vec3.dot(S,N[aa][1])/vec3.dot(N[aa][1],N[aa][1]));vec3.normalize(S,S);vec3.cross(T,S,N[aa][1]);vec3.normalize(T,T)}}}}else{ae(this.commands[this.commands.length-1][1][0][1],N[aa][1]);t=false}this.commands.push([this.loopSegment,[N[aa],p.rgb,aj,am]]);this.mainBuffer.allocateVerticesSplitable(this.novpr,this.novpr*2)}}N[aa].push([T[0],T[1],T[2]],[S[0],S[1],S[2]],p)}};var n;var K=function(N,p,al,i,ak){var aj=null;if(al[2]!=al[1]){aj=N[N.length-1];N.splice(N.length-Math.floor(this.noi/2),Math.floor(this.noi/2))}for(aa=0;aa<N.length;aa++){if(al[0]!=al[1]&&aa==0){if(al[0]!=0){ae(this.commands[this.commands.length-1][1][0][1],N[aa][1]);var am=[N[aa][0],N[aa][1]];this.commands.push([this.loopSegment,[am,this.commands[this.commands.length-1][1][1],null,null,this.radius*0.5]]);am.push([T[0],T[1],T[2]],[S[0],S[1],S[2]]);this.mainBuffer.allocateVerticesSplitable(this.novpr,this.novpr*2)}n=[0,0];this.commands.push([this.sheetStart,[N[aa],p.rgb,n]]);if(i){I(i,N[aa][1])}else{ae(this.commands[this.commands.length-1][1][0][1],N[aa][1])}n[0]+=4+8;n[1]+=2}else{if(al[1]!=al[2]&&aa==N.length-1){if(i){V(i,ak,aa/N.length,N[aa][1])}else{ae(this.commands[this.commands.length-1][1][0][1],N[aa][1])}this.commands.push([this.sheetEnd,[N[aa],p.rgb,aj[0]]]);N[aa].push([T[0],T[1],T[2]],[S[0],S[1],S[2]]);n[0]+=8+4+12;n[1]+=8+2+4;this.mainBuffer.allocateVertices(n[0],n[1])}else{if(i){V(i,ak,aa/N.length,N[aa][1])}else{ae(this.commands[this.commands.length-1][1][0][1],N[aa][1])}this.commands.push([this.sheetSegment,[N[aa],p.rgb,0]]);n[0]+=8;n[1]+=8}}N[aa].push([T[0],T[1],T[2]],[S[0],S[1],S[2]],p)}};var q=[],l,F=[0,0,0],G;var H=Math.floor(this.noi/2),m,o,ag,af,g,C,f=[],d=[],E,Q=null,ac,J;for(ai=0;ai<D.length;ai++){O=D[ai].length;q=[];W=0;while(W<O-1){if(D[ai][W].displayMode==2||D[ai][W].sndStruc==1){q.push(1)}else{if(D[ai][W].displayMode==3){if(D[ai][W].sndStruc==2){q.push(2)}else{if(D[ai][W].sndStruc==3){q.push(3)}else{q.push(1)}}}else{if(D[ai][W].displayMode==4){if(D[ai][W].sndStruc==2){q.push(4)}else{if(D[ai][W].sndStruc==3){q.push(5)}else{q.push(1)}}}else{q.push(1)}}}W++}O=D[ai].length;G=[];C=this.commands.length;if(O<3){continue}ac={},J={};for(W=0;W<O-1;W++){if(W==0){F[0]=0}else{F[0]=q[W-1]}if(W==O-2){F[2]=0}else{F[2]=q[W+1]}F[1]=q[W];if(F[1]==3||F[0]==3||F[2]==3){if(q[W+1]==3&&q[W+2]==3&&q[W+3]==3&&q[W+4]==3&&q[W+5]==3){Q=[(D[ai][W+3].CA.xyz[0]+D[ai][W+4].CA.xyz[0]+D[ai][W+5].CA.xyz[0])-(D[ai][W+0].CA.xyz[0]+D[ai][W+1].CA.xyz[0]+D[ai][W+2].CA.xyz[0]),(D[ai][W+3].CA.xyz[1]+D[ai][W+4].CA.xyz[1]+D[ai][W+5].CA.xyz[1])-(D[ai][W+0].CA.xyz[1]+D[ai][W+1].CA.xyz[1]+D[ai][W+2].CA.xyz[1]),(D[ai][W+3].CA.xyz[2]+D[ai][W+4].CA.xyz[2]+D[ai][W+5].CA.xyz[2])-(D[ai][W+0].CA.xyz[2]+D[ai][W+1].CA.xyz[2]+D[ai][W+2].CA.xyz[2])];vec3.normalize(Q,Q)}else{if(Q==null){try{if(D[ai][W+4]==3){Q=[D[ai][W+4].CA.xyz[0]-D[ai][W+1].CA.xyz[0],D[ai][W+4].CA.xyz[1]-D[ai][W+1].CA.xyz[1],D[ai][W+4].CA.xyz[2]-D[ai][W+1].CA.xyz[2]]}else{Q=[D[ai][W+3].CA.xyz[0]-D[ai][W].CA.xyz[0],D[ai][W+3].CA.xyz[1]-D[ai][W].CA.xyz[1],D[ai][W+3].CA.xyz[2]-D[ai][W].CA.xyz[2]]}vec3.normalize(Q,Q)}catch(ah){}}}ac[W]=Q}else{Q=null}if(F[0]&&F[1]==2&&F[2]){J[W]=vec3.add(J[W]||[0,0,0],D[ai][W-1].CA.xyz,D[ai][W+1].CA.xyz);J[W][0]/=2;J[W][1]/=2;J[W][2]/=2;vec3.subtract(J[W],D[ai][W].CA.xyz,J[W]);vec3.normalize(J[W],J[W]);if(J[W-1]){if(vec3.dot(J[W-1],J[W])<0){vec3.negate(J[W],J[W])}}else{J[W-1]=J[W]}}}for(W=0;W<O-1;W++){s=null;if(W==0){F[0]=0}else{F[0]=q[W-1]}if(W==O-2){F[2]=0}else{F[2]=q[W+1]}F[1]=q[W];if(F[0]!=F[1]){g=this.commands.length}if(W==0){s=this.interpolate(D[ai][W],D[ai][W],D[ai][W+1],D[ai][W+2])}if(W==O-2){s=this.interpolate(D[ai][W-1],D[ai][W],D[ai][W+1],D[ai][W+1],true)}if(!s){s=this.interpolate(D[ai][W-1],D[ai][W],D[ai][W+1],D[ai][W+2])}if(F[1]==2){K.call(this,s,D[ai][W],F,J[W],molmil_dep.getKeyFromObject(J,W+1,J[W]))}else{A.call(this,s,D[ai][W],F,ac[W],molmil_dep.getKeyFromObject(ac,W+1,ac[W]))}}}this.previousRotationMatrix=null};cartoonBuilder.prototype.construct=function(){for(c=0;c<this.commands.length;c++){this.commands[c][0].apply(this,this.commands[c][1])}var f=new Float32Array(this.someLines.length*2*3);var d=new Float32Array(this.someLines.length*2*3);for(var b=0,g=0;b<this.someLines.length;b++,g+=6){f[g]=this.someLines[b][0][0];f[g+1]=this.someLines[b][0][1];f[g+2]=this.someLines[b][0][2];f[g+3]=this.someLines[b][1][0];f[g+4]=this.someLines[b][1][1];f[g+5]=this.someLines[b][1][2];if(this.someLines[b].length>2){d[g]=d[g+3]=this.someLines[b][2][0];d[g+1]=d[g+4]=this.someLines[b][2][1];d[g+2]=d[g+5]=this.someLines[b][2][2]}}if(!this.soup.renderer.buffers.CTBpositionBuffer){this.soup.renderer.buffers.CTBpositionBuffer=this.gl.createBuffer()}this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.soup.renderer.buffers.CTBpositionBuffer);this.gl.bufferData(this.gl.ARRAY_BUFFER,f,this.gl.STATIC_DRAW);if(!this.soup.renderer.buffers.CTBcolorBuffer){this.soup.renderer.buffers.CTBcolorBuffer=this.gl.createBuffer()}this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.soup.renderer.buffers.CTBcolorBuffer);this.gl.bufferData(this.gl.ARRAY_BUFFER,d,this.gl.STATIC_DRAW);this.soup.renderer.buffers.CTBpositionBuffer.items=Math.floor(this.someLines.length*2)};function smoothVector(d){var f=[0,0,0];for(var b=0;b<d.length;b++){f[0]+=d[b][0];f[1]+=d[b][1];f[2]+=d[b][2]}f[0]/=d.length;f[1]/=d.length;f[2]/=d.length;return f}cartoonBuilder.prototype.buildRadialFrame=function(d,b){b=b||this.radius;var h=[],f;for(var g=0;g<this.ringTemplate.length;g++){f=[0,0,0];f[0]=b*this.ringTemplate[g][0]*d[2][0]+b*this.ringTemplate[g][1]*d[3][0];f[1]=b*this.ringTemplate[g][0]*d[2][1]+b*this.ringTemplate[g][1]*d[3][1];f[2]=b*this.ringTemplate[g][0]*d[2][2]+b*this.ringTemplate[g][1]*d[3][2];h.push(f)}return h};cartoonBuilder.prototype.buildRectFrame=function(b,g){var h=[],d;for(var f=0;f<4;f++){d=[0,0,0];d[0]=this.squareVertices[f][0]*g*b[2][0]+this.squareVertices[f][1]*0.5*b[3][0];d[1]=this.squareVertices[f][0]*g*b[2][1]+this.squareVertices[f][1]*0.5*b[3][1];d[2]=this.squareVertices[f][0]*g*b[2][2]+this.squareVertices[f][1]*0.5*b[3][2];h.push(d)}return h};cartoonBuilder.prototype.sheetBuilderC=function(l,i,d,h,m,b){var g=this.p/this.mainBuffer.nodppv;for(var f=0;f<4;f++){vec3.normalize(i[f],i[f]);this.vBuffer[this.p++]=l[f][0]+d[0][0];this.vBuffer[this.p++]=l[f][1]+d[0][1];this.vBuffer[this.p++]=l[f][2]+d[0][2];this.vBuffer[this.p++]=i[f][0];this.vBuffer[this.p++]=i[f][1];this.vBuffer[this.p++]=i[f][2];this.vBuffer[this.p++]=h[0];this.vBuffer[this.p++]=h[1];this.vBuffer[this.p++]=h[2];this.vBuffer[this.p++]=b||0;vec3.normalize(i[f==3?0:f+1],i[f==3?0:f+1]);this.vBuffer[this.p++]=l[f][0]+d[0][0];this.vBuffer[this.p++]=l[f][1]+d[0][1];this.vBuffer[this.p++]=l[f][2]+d[0][2];this.vBuffer[this.p++]=i[f==3?0:f+1][0];this.vBuffer[this.p++]=i[f==3?0:f+1][1];this.vBuffer[this.p++]=i[f==3?0:f+1][2];this.vBuffer[this.p++]=h[0];this.vBuffer[this.p++]=h[1];this.vBuffer[this.p++]=h[2];this.vBuffer[this.p++]=b||0}if(!m){this.iBuffer[this.i++]=g-8;this.iBuffer[this.i++]=g-1;this.iBuffer[this.i++]=g+7;this.iBuffer[this.i++]=g-8;this.iBuffer[this.i++]=g+7;this.iBuffer[this.i++]=g+0;this.iBuffer[this.i++]=g-7;this.iBuffer[this.i++]=g+1;this.iBuffer[this.i++]=g+2;this.iBuffer[this.i++]=g-7;this.iBuffer[this.i++]=g+2;this.iBuffer[this.i++]=g-6;this.iBuffer[this.i++]=g-5;this.iBuffer[this.i++]=g+3;this.iBuffer[this.i++]=g+4;this.iBuffer[this.i++]=g-5;this.iBuffer[this.i++]=g+4;this.iBuffer[this.i++]=g-4;this.iBuffer[this.i++]=g-2;this.iBuffer[this.i++]=g-3;this.iBuffer[this.i++]=g+5;this.iBuffer[this.i++]=g-2;this.iBuffer[this.i++]=g+5;this.iBuffer[this.i++]=g+6}};cartoonBuilder.prototype.sheetStart=function(m,h,p,n){var b=this.buildRectFrame(m,n?2:1);var l=[b[0][0]-b[1][0],b[0][1]-b[1][1],b[0][2]-b[1][2]];var i=[b[0][0]-b[2][0],b[0][1]-b[2][1],b[0][2]-b[2][2]];var f=[0,0,0];vec3.cross(f,l,i);vec3.normalize(f,f);if(p){var d=this.mainBuffer.getBuffer(p[0],p[1]);this.vBuffer=d[0];this.p=d[1];this.iBuffer=d[2];this.i=d[3]}var o=this.p/this.mainBuffer.nodppv;vec3.normalize(f,f);var g=m[m.length-1].CA?m[m.length-1].CA.AID:0;for(v=0;v<4;v++){this.vBuffer[this.p++]=b[v][0]+m[0][0];this.vBuffer[this.p++]=b[v][1]+m[0][1];this.vBuffer[this.p++]=b[v][2]+m[0][2];this.vBuffer[this.p++]=f[0];this.vBuffer[this.p++]=f[1];this.vBuffer[this.p++]=f[2];this.vBuffer[this.p++]=h[0];this.vBuffer[this.p++]=h[1];this.vBuffer[this.p++]=h[2];this.vBuffer[this.p++]=g}this.iBuffer[this.i++]=o;this.iBuffer[this.i++]=o+1;this.iBuffer[this.i++]=o+2;this.iBuffer[this.i++]=o;this.iBuffer[this.i++]=o+2;this.iBuffer[this.i++]=o+3;this.sheetBuffer=[b,m,h];this.sheetStartPoint=true};cartoonBuilder.prototype.sheetSegment=function(n,h){var b=this.buildRectFrame(n,1);var m=[b[3][0]-b[0][0],b[3][1]-b[0][1],b[3][2]-b[0][2]];var i=[b[1][0]-b[0][0],b[1][1]-b[0][1],b[1][2]-b[0][2]];var g=[0,0,0];vec3.cross(g,m,n[1]);vec3.normalize(g,g);var d=[0,0,0];vec3.cross(d,n[1],i);vec3.normalize(d,d);var l=[g,d,[-g[0],-g[1],-g[2]],[-d[0],-d[1],-d[2]]];var f=n[n.length-1].CA?n[n.length-1].CA.AID:0;if(this.sheetStartPoint){this.sheetBuilderC(this.sheetBuffer[0],l,this.sheetBuffer[1],this.sheetBuffer[2],true,f)}this.sheetBuilderC(b,l,n,h,false,f);this.sheetBuffer=[b,n,h];this.sheetStartPoint=false};cartoonBuilder.prototype.sheetEnd=function(m,g,n){this.sheetSegment(m,g);this.sheetStart(m,g,null,2);var b=this.buildRectFrame(m,2);var i=[],l,h,d=[0,0,0];l=[b[0][0]-n[0],b[0][1]-n[1],b[0][2]-n[2]];h=[b[3][0]-n[0],b[3][1]-n[1],b[3][2]-n[2]];vec3.cross(d,h,l);vec3.normalize(d,d);i.push([d[0],d[1],d[2]]);l=[b[0][0]-n[0],b[0][1]-n[1],b[0][2]-n[2]];h=[b[1][0]-n[0],b[1][1]-n[1],b[1][2]-n[2]];vec3.cross(d,h,l);vec3.normalize(d,d);i.push([d[0],d[1],d[2]]);l=[b[1][0]-n[0],b[1][1]-n[1],b[1][2]-n[2]];h=[b[2][0]-n[0],b[2][1]-n[1],b[2][2]-n[2]];vec3.cross(d,h,l);vec3.normalize(d,d);i.push([d[0],d[1],d[2]]);l=[b[2][0]-n[0],b[2][1]-n[1],b[2][2]-n[2]];h=[b[3][0]-n[0],b[3][1]-n[1],b[3][2]-n[2]];vec3.cross(d,h,l);vec3.normalize(d,d);i.push([d[0],d[1],d[2]]);var o=this.p/this.mainBuffer.nodppv;var f=m[m.length-1].CA?m[m.length-1].CA.AID:0;for(v=0;v<4;v++){this.vBuffer[this.p++]=b[v][0]+m[0][0];this.vBuffer[this.p++]=b[v][1]+m[0][1];this.vBuffer[this.p++]=b[v][2]+m[0][2];this.vBuffer[this.p++]=i[v][0];this.vBuffer[this.p++]=i[v][1];this.vBuffer[this.p++]=i[v][2];this.vBuffer[this.p++]=g[0];this.vBuffer[this.p++]=g[1];this.vBuffer[this.p++]=g[2];this.vBuffer[this.p++]=f;this.vBuffer[this.p++]=b[v][0]+m[0][0];this.vBuffer[this.p++]=b[v][1]+m[0][1];this.vBuffer[this.p++]=b[v][2]+m[0][2];this.vBuffer[this.p++]=i[v==3?0:v+1][0];this.vBuffer[this.p++]=i[v==3?0:v+1][1];this.vBuffer[this.p++]=i[v==3?0:v+1][2];this.vBuffer[this.p++]=g[0];this.vBuffer[this.p++]=g[1];this.vBuffer[this.p++]=g[2];this.vBuffer[this.p++]=f;this.vBuffer[this.p++]=n[0];this.vBuffer[this.p++]=n[1];this.vBuffer[this.p++]=n[2];this.vBuffer[this.p++]=i[v==3?0:v+1][0];this.vBuffer[this.p++]=i[v==3?0:v+1][1];this.vBuffer[this.p++]=i[v==3?0:v+1][2];this.vBuffer[this.p++]=g[0];this.vBuffer[this.p++]=g[1];this.vBuffer[this.p++]=g[2];this.vBuffer[this.p++]=f}this.iBuffer[this.i++]=o+1;this.iBuffer[this.i++]=o+2;this.iBuffer[this.i++]=o+3;this.iBuffer[this.i++]=o+4;this.iBuffer[this.i++]=o+5;this.iBuffer[this.i++]=o+6;this.iBuffer[this.i++]=o+7;this.iBuffer[this.i++]=o+8;this.iBuffer[this.i++]=o+9;this.iBuffer[this.i++]=o+10;this.iBuffer[this.i++]=o+11;this.iBuffer[this.i++]=o;this.sheetBuffer=null;this.sheetStartPoint=false};cartoonBuilder.prototype.buildDomeFrame=function(b,g){var l=[],d;var m=this.dome[g];for(var f=0;f<m.vertices.length;f++){d=[0,0,0];d[0]=this.radius*m.vertices[f][0]*b[2][0]+this.radius*m.vertices[f][1]*b[3][0]+this.radius*m.vertices[f][2]*b[1][0];d[1]=this.radius*m.vertices[f][0]*b[2][1]+this.radius*m.vertices[f][1]*b[3][1]+this.radius*m.vertices[f][2]*b[1][1];d[2]=this.radius*m.vertices[f][0]*b[2][2]+this.radius*m.vertices[f][1]*b[3][2]+this.radius*m.vertices[f][2]*b[1][2];l.push(d)}var h=[];for(var f=0;f<m.faces.length;f++){h.push(m.faces[f][0]);h.push(m.faces[f][1]);h.push(m.faces[f][2])}return{frame:l,indices:h}};cartoonBuilder.prototype.loopStart=function(s,q){var g=this.buildDomeFrame(s,0);var f,l,b,m,h,t,o;f=this.mainBuffer.getBuffer(g.frame.length,g.indices.length/3);l=f[0];b=f[1];m=f[2];h=f[3];var n=s[s.length-1].CA?s[s.length-1].CA.AID:0;for(t=0;t<g.frame.length;t++){l[b++]=g.frame[t][0]+s[0][0];l[b++]=g.frame[t][1]+s[0][1];l[b++]=g.frame[t][2]+s[0][2];vec3.normalize(g.frame[t],g.frame[t]);l[b++]=g.frame[t][0];l[b++]=g.frame[t][1];l[b++]=g.frame[t][2];l[b++]=q[0];l[b++]=q[1];l[b++]=q[2];l[b++]=n}for(t=0;t<g.indices.length;t++){m[h++]=g.indices[t]+(f[1]/this.mainBuffer.nodppv)}var d=this.buildRadialFrame(s);f=this.mainBuffer.getBuffer(this.novpr,this.novpr*2);l=f[0];b=f[1];m=f[2];h=f[3];o=f[4];if(o){f=this.mainBuffer.getBuffer(this.novpr,this.novpr*2);l=f[0];b=f[1];m=f[2];h=f[3]}for(t=0;t<d.length;t++){l[b++]=d[t][0]+s[0][0];l[b++]=d[t][1]+s[0][1];l[b++]=d[t][2]+s[0][2];vec3.normalize(d[t],d[t]);l[b++]=d[t][0];l[b++]=d[t][1];l[b++]=d[t][2];l[b++]=q[0];l[b++]=q[1];l[b++]=q[2];l[b++]=n}};cartoonBuilder.prototype.loopSegment=function(z,d,w,E,m){var s=this.buildRadialFrame(z,m);var u=s;var o=z[z.length-1].CA?z[z.length-1].CA.AID:0;if(w){u=[];vec3.normalize(E[0],E[0]);vec3.normalize(E[1],E[1]);var D=[0,0,0],A=1-((w-1)*0.5),l,B,b,h;l=mat3.create();l[0]=E[0][0]*E[0][0];l[4]=E[0][1]*E[0][1];l[8]=E[0][2]*E[0][2];l[1]=l[3]=E[0][0]*E[0][1];l[2]=l[6]=E[0][0]*E[0][2];l[5]=l[7]=E[0][1]*E[0][2];for(B=0;B<s.length;B++){vec3.transformMat3(D,s[B],l);vec3.scaleAndAdd(s[B],s[B],D,(w-1)*2)}l=mat3.create();l[0]=E[1][0]*E[1][0];l[4]=E[1][1]*E[1][1];l[8]=E[1][2]*E[1][2];l[1]=l[3]=E[1][0]*E[1][1];l[2]=l[6]=E[1][0]*E[1][2];l[5]=l[7]=E[1][1]*E[1][2];for(B=0;B<s.length;B++){vec3.transformMat3(D,s[B],l);vec3.scaleAndAdd(s[B],s[B],D,A-1)}for(B=0;B<s.length;B++){b=B==0?s.length-1:B-1;h=B==s.length-1?0:B+1;b=[s[B][0]-s[b][0],s[B][1]-s[b][1],s[B][2]-s[b][2]];h=[s[B][0]-s[h][0],s[B][1]-s[h][1],s[B][2]-s[h][2]];vec3.normalize(b,b);vec3.normalize(h,h);u[B]=[b[0]+h[0],b[1]+h[1],b[2]+h[2]]}}var g,f,x,n,B,q,y;g=this.mainBuffer.getBuffer(this.novpr,this.novpr*2);f=g[0];x=g[1];n=g[2];B=g[3];y=g[4];var t=x/this.mainBuffer.nodppv;var F=t-this.novpr;for(q=0;q<s.length;q++){f[x++]=s[q][0]+z[0][0];f[x++]=s[q][1]+z[0][1];f[x++]=s[q][2]+z[0][2];vec3.normalize(u[q],u[q]);f[x++]=u[q][0];f[x++]=u[q][1];f[x++]=u[q][2];if(w>1){var C=Math.round(vec3.dot(u[q],E[1])*Math.pow(10,4))/Math.pow(10,4);if((E[2]&&C<0)||(!E[2]&&C>0)){f[x++]=1;f[x++]=1;f[x++]=1}else{f[x++]=d[0];f[x++]=d[1];f[x++]=d[2]}}else{f[x++]=d[0];f[x++]=d[1];f[x++]=d[2]}f[x++]=o}for(q=0;q<(this.novpr*2)-2;q+=2,t+=1,F+=1){n[B++]=t;n[B++]=F;n[B++]=F+1;n[B++]=F+1;n[B++]=t+1;n[B++]=t}n[B++]=t;n[B++]=F;n[B++]=F-(this.novpr-1);n[B++]=F-(this.novpr-1);n[B++]=t-(this.novpr-1);n[B++]=t;if(y){g=this.mainBuffer.getBuffer(this.novpr,this.novpr*2);f=g[0];x=g[1];n=g[2];B=g[3];for(q=0;q<s.length;q++){f[x++]=s[q][0]+z[0][0];f[x++]=s[q][1]+z[0][1];f[x++]=s[q][2]+z[0][2];vec3.normalize(u[q],u[q]);f[x++]=u[q][0];f[x++]=u[q][1];f[x++]=u[q][2];f[x++]=d[0];f[x++]=d[1];f[x++]=d[2];f[x++]=o}}};cartoonBuilder.prototype.loopEnd=function(t,s){var d=this.buildRadialFrame(t);var f,l,b,m,h,u,q;f=this.mainBuffer.getBuffer(this.novpr,this.novpr*2);l=f[0];b=f[1];m=f[2];h=f[3];var w=b/this.mainBuffer.nodppv;var o=w-this.novpr;var n=t[t.length-1].CA?t[t.length-1].CA.AID:0;for(u=0;u<d.length;u++){l[b++]=d[u][0]+t[0][0];l[b++]=d[u][1]+t[0][1];l[b++]=d[u][2]+t[0][2];vec3.normalize(d[u],d[u]);l[b++]=d[u][0];l[b++]=d[u][1];l[b++]=d[u][2];l[b++]=s[0];l[b++]=s[1];l[b++]=s[2];l[b++]=n}for(u=0;u<(this.novpr*2)-2;u+=2,w+=1,o+=1){m[h++]=w;m[h++]=o;m[h++]=o+1;m[h++]=o+1;m[h++]=w+1;m[h++]=w}m[h++]=w;m[h++]=o;m[h++]=o-(this.novpr-1);m[h++]=o-(this.novpr-1);m[h++]=w-(this.novpr-1);m[h++]=w;var g=this.buildDomeFrame(t,1);f=this.mainBuffer.getBuffer(g.frame.length,g.indices.length/3);l=f[0];b=f[1];m=f[2];h=f[3];for(u=0;u<g.frame.length;u++){l[b++]=g.frame[u][0]+t[0][0];l[b++]=g.frame[u][1]+t[0][1];l[b++]=g.frame[u][2]+t[0][2];vec3.normalize(g.frame[u],g.frame[u]);l[b++]=g.frame[u][0];l[b++]=g.frame[u][1];l[b++]=g.frame[u][2];l[b++]=s[0];l[b++]=s[1];l[b++]=s[2];l[b++]=n}for(u=0;u<g.indices.length;u++){m[h++]=g.indices[u]+(f[1]/this.mainBuffer.nodppv)}};cartoonBuilder.prototype.rocket=function(f,b,d){};function initTexture(d){var b=this.gl.createTexture();b.image=new Image();b.image.texture=b;b.loaded=false;b.image.onload=function(){handleLoadedTexture(this.texture)};b.image.src=d;return b}function handleLoadedTexture(b){this.gl.bindTexture(this.gl.TEXTURE_2D,b);this.gl.pixelStorei(this.gl.UNPACK_FLIP_Y_WEBGL,true);this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,b.image);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE);this.gl.bindTexture(this.gl.TEXTURE_2D,null);b.loaded=true}function safeStartViewer(b){for(var d in b.textures){if(!b.textures[d].loaded){return molmil_dep.asyncStart(safeStartViewer,[b],null,100)}}canvasList.push(b)}function animate_pdbjViewers(){molmil_settings.animationFrameID=requestAnimationFrame(animate_pdbjViewers);for(var b=0;b<canvasList.length;b++){canvasList[b].renderer.render()}}function jvRenderer(b){this.canvas=null;this.reloadSettings();this.programs=[];this.clearCut=0;this.fogStart=0;this.camera=new glCamera();this.soup=b;this.modelViewMatrix=mat4.create();this.projectionMatrix=mat4.create();this.pitch=0;this.heading=0;this.TransX=0;this.TransY=0;this.TransZ=0;this.pitchAngle=0;this.headingAngle=0;this.TransB=[0.5,0.5,0];this.animationMode=false;this.framesDefinition=[];this.framesBuffer=[];this.textures={};this.FBOs={};this.shaders={};this.buffers={};this.gl=null;this.mainBuffer=new dynamicBuffer();this.lineStripBuffer=new dynamicBuffer();this.standardRender=function(g){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffers[g]);this.gl.vertexAttribPointer(this.attributes.in_Position,3,this.gl.FLOAT,false,this.frameSize,0);this.gl.vertexAttribPointer(this.attributes.in_Normal,3,this.gl.FLOAT,false,this.frameSize,12);this.gl.vertexAttribPointer(this.attributes.in_Colour,3,this.gl.FLOAT,false,this.frameSize,24);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffers[g]);if(this.angle){var f=0,d;while(true){d=Math.min(this.items[g]-f,3000000);if(d<1){break}this.gl.drawElements(this.gl.TRIANGLES,d,this.indexFormat,f*4);f+=d}}else{this.gl.drawElements(this.gl.TRIANGLES,this.items[g],this.indexFormat,0)}};this.linesRender=function(g){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffers[g]);this.gl.vertexAttribPointer(this.attributes.in_Position,3,this.gl.FLOAT,false,this.frameSize,0);this.gl.vertexAttribPointer(this.attributes.in_Colour,3,this.gl.FLOAT,false,this.frameSize,12);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffers[g]);if(this.angle){var f=0,d;while(true){d=Math.min(this.items[g]-f,3000000);if(d<1){break}this.gl.drawElements(this.gl.LINES,d,this.indexFormat,f*4);f+=d}}else{this.gl.drawElements(this.gl.LINES,this.items[g],this.indexFormat,0)}};this.pickingRender=function(g){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffers[g]);this.gl.vertexAttribPointer(this.attributes.in_Position,3,this.gl.FLOAT,false,this.frameSize,0);this.gl.vertexAttribPointer(this.attributes.in_ID,1,this.gl.FLOAT,false,this.frameSize,36);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffers[g]);if(this.angle){var f=0,d;while(true){d=Math.min(this.items[g]-f,3000000);if(d<1){break}this.gl.drawElements(this.gl.TRIANGLES,d,this.indexFormat,f*4);f+=d}}else{this.gl.drawElements(this.gl.TRIANGLES,this.items[g],this.indexFormat,0)}};this.pickingRenderLines=function(g){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffers[g]);this.gl.vertexAttribPointer(this.attributes.in_Position,3,this.gl.FLOAT,false,this.frameSize,0);this.gl.vertexAttribPointer(this.attributes.in_ID,1,this.gl.FLOAT,false,this.frameSize,24);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffers[g]);if(this.angle){var f=0,d;while(true){d=Math.min(this.items[g]-f,3000000);if(d<1){break}this.gl.drawElements(this.gl.POINTS,d,this.indexFormat,f*4);f+=d}}else{this.gl.drawElements(this.gl.POINTS,this.items[g],this.indexFormat,0)}};this.mainBuffer.customRenderer=this.standardRender;this.lineStripBuffer.customRenderer=this.linesRender}jvRenderer.prototype.reloadSettings=function(){this.QLV=localStorage.getItem("molmil_settings_QLV");if(this.QLV==null){this.QLV=2;localStorage.setItem("molmil_settings_QLV",this.QLV)}else{this.QLV=parseInt(this.QLV)}if(this.gl){this.gl.clearColor.apply(this.gl,molmilConfigBox.BGCOLOR)}};jvRenderer.prototype.selectDefaultContext=function(){this.gl=this.defaultContext};jvRenderer.prototype.selectDataContext=function(){if(!this.dataContext){this.dataContext=this.canvas.getContext("webgl",{preserveDrawingBuffer:true})||this.canvas.getContext("experimental-webgl",{preserveDrawingBuffer:true})}this.gl=this.dataContext};jvRenderer.prototype.initGL=function(d,f,b){this.defaultContext=d.getContext("webgl")||d.getContext("experimental-webgl");d.renderer=this;if(!this.defaultContext){this.altCanvas=__webglNotSupported__(d);return false}this.gl=this.defaultContext;molmilConfigBox.OES_element_index_uint=this.gl.getExtension("OES_element_index_uint");this.width=f|d.width;this.height=b|d.height;this.gl.viewportWidth=this.width;this.gl.viewportHeight=this.height;d.onmousedown=handle_pdbjViewer_mouseDown;document.onmouseup=handle_pdbjViewer_mouseUp;document.onmousemove=handle_pdbjViewer_mouseMove;d.addEventListener(molmil_dep.dBT.MFF?"DOMMouseScroll":"mousewheel",handle_pdbjViewer_mouseScroll,false);d.addEventListener("touchstart",handle_pdbjViewer_touchStart,false);d.addEventListener("touchmove",handle_pdbjViewer_touchMove,false);d.addEventListener("touchend",handle_pdbjViewer_touchEnd,false);this.gl.clearColor.apply(this.gl,molmilConfigBox.BGCOLOR);this.gl.enable(this.gl.DEPTH_TEST);this.gl.enable(this.gl.CULL_FACE);this.gl.cullFace(this.gl.BACK);this.canvas=d;return true};jvRenderer.prototype.initRenderer=function(){this.initShaders(molmilConfigBox.glsl_shaders);this.resizeViewPort();this.mainBuffer.init(this.gl);this.mainBuffer.nodppv=10;this.mainBuffer.frameSize=40;this.mainBuffer.noipp=3;this.mainBuffer.attributes=this.shaders.standard.attributes;this.lineStripBuffer.init(this.gl);this.lineStripBuffer.nodppv=7;this.lineStripBuffer.frameSize=28;this.lineStripBuffer.noipp=2;this.lineStripBuffer.attributes=this.shaders.lines.attributes};jvRenderer.prototype.initShaders=function(h){this.shaders={};var f,b,m,l,d,g;for(var i=0;i<h.length;i++){d=h[i][0];f=h[i][1]||d.replace(/\\/g,"/").replace(/.*\//,"").split(".")[0];g=h[i][2]||"";this.shaders[f]=loadShader(molmil_settings.src+d,g);this.shaders[f].program=this.gl.createProgram();m=setupShader(this.gl,f+"_v",this.shaders[f].program,this.shaders[f].vertexShader,this.gl.VERTEX_SHADER);b=setupShader(this.gl,f+"_f",this.shaders[f].program,this.shaders[f].fragmentShader,this.gl.FRAGMENT_SHADER);this.gl.linkProgram(this.shaders[f].program);if(!this.gl.getProgramParameter(this.shaders[f].program,this.gl.LINK_STATUS)){console.log("Could not initialise shaders for "+f)}this.gl.useProgram(this.shaders[f].program);for(l in this.shaders[f].attributes){this.shaders[f].attributes[l]=this.gl.getAttribLocation(this.shaders[f].program,l);if(this.shaders[f].attributes[l]!=-1){this.gl.enableVertexAttribArray(this.shaders[f].attributes[l])}}for(l in this.shaders[f].uniforms){this.shaders[f].uniforms[l]=this.gl.getUniformLocation(this.shaders[f].program,l)}}this.gl.useProgram(null)};jvRenderer.prototype.updateSelection=function(){var l=new Float32Array(this.soup.atomSelection.length*8*6),d;var h,g;for(var f=0,m=0,b;f<this.soup.atomSelection.length;f++){g=molmil_dep.getKeyFromObject(molmilConfigBox.elementInfo,this.soup.atomSelection[f].element,molmilConfigBox.elementInfo.DUMMY);h=g[3]*1.5;if(f==0){d=[1,0,0]}else{if(f==1){d=[0,1,0]}else{if(f==2){d=[0,0,1]}else{d=[0.8,0.8,0.8]}}}for(b=0;b<6;b++){l[m++]=this.soup.atomSelection[f].xyz[0];l[m++]=this.soup.atomSelection[f].xyz[1];l[m++]=this.soup.atomSelection[f].xyz[2];l[m++]=d[0];l[m++]=d[1];l[m++]=d[2];if(b==0||b==5){l[m++]=-h;l[m++]=+h}else{if(b==1){l[m++]=+h;l[m++]=+h}else{if(b==2||b==3){l[m++]=+h;l[m++]=-h}else{if(b==4){l[m++]=-h;l[m++]=-h}}}}}}if(!this.buffers.atomSelectionBuffer){this.buffers.atomSelectionBuffer=this.gl.createBuffer()}this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.buffers.atomSelectionBuffer);this.gl.bufferData(this.gl.ARRAY_BUFFER,l,this.gl.STATIC_DRAW);this.buffers.atomSelectionBuffer.items=this.soup.atomSelection.length*6};jvRenderer.prototype.createBuffer=function(Z,R,P){if(typeof(P)!="undefined"){for(var av=0,ad;av<Z[0].atoms.length;av++){ad=(Z[0].atoms[av].AID-1)*3;Z[0].atoms[av].xyz=this.soup.trajectory[P].subarray(ad,ad+3)}if(this.soup.trajectoryColours){for(var av=0,ad;av<Z[0].atoms.length;av++){ad=(Z[0].atoms[av].AID-1)*3;Z[0].atoms[av].rgb=this.soup.trajectoryColours[P].subarray(ad,ad+3);if(Z[0].atoms[av].molecule.CA==Z[0].atoms[av]){Z[0].atoms[av].molecule.rgb=this.soup.trajectoryColours[P].subarray(ad,ad+3)}}}}var q=[],n=[],O=[],at={},J=[],h,av,ar,af,f,ae=0;var aa=[];for(var N=0;N<Z.length;N++){f=Z[N];if(!f.display){continue}for(var av=0;av<f.atoms.length;av++){if(f.atoms[av].displayMode==0||!f.atoms[av].status){continue}else{if(f.atoms[av].displayMode==4){aa.push(f.atoms[av])}else{q.push(f.atoms[av])}}}for(var ar=0;ar<f.bonds.length;ar++){if(f.bonds[ar][0].displayMode<2||f.bonds[ar][1].displayMode<2||!f.bonds[ar][0].status||!f.bonds[ar][1].status){continue}if(f.bonds[ar][0].displayMode==4||f.bonds[ar][1].displayMode==4){O.push(f.bonds[ar])}else{n.push(f.bonds[ar]);if(!at.hasOwnProperty(f.bonds[ar][0].AID)){at[f.bonds[ar][0].AID]=[]}if(!at.hasOwnProperty(f.bonds[ar][1].AID)){at[f.bonds[ar][1].AID]=[]}at[f.bonds[ar][0].AID].push(f.bonds[ar][1]);at[f.bonds[ar][1].AID].push(f.bonds[ar][0])}}for(var af=0;af<f.molecules.length;af++){if(!f.molecules[af].status){continue}if(f.molecules[af].displayMode==1&&f.molecules[af].CA&&f.molecules[af].next&&f.molecules[af].next.displayMode==1&&f.molecules[af].next.CA){q.push(f.molecules[af].CA);if(f.molecules[af].next){n.push([f.molecules[af].CA,f.molecules[af].next.CA])}}else{if(f.molecules[af].displayMode>=2&&f.molecules[af].CA){if(f.molecules[af].previous==null){h=[];J.push(h)}h.push(f.molecules[af]);ae++}}}}var aw=molmilConfigBox.QLV_SETTINGS[this.QLV].SPHERE_TESS_LV;var al=molmilConfigBox.QLV_SETTINGS[this.QLV].CB_NOI;var M=molmilConfigBox.QLV_SETTINGS[this.QLV].CB_NOVPR;var B=q.length*(6*Math.pow(4,aw+1));B+=n.length*(aw+1)*4*2;B+=ae*al*M;if(B>10000000){aw-=1}if(B>30000000){aw-=1}if(B>100000000){aw-=1}if(B<250000&&aw<3){aw+=1}aw=Math.max(aw,0);var Q=mat4.create();var F=[0,0,0,0],Y=[0,0,0,0],o,l,g,d,D,am,ak,s,E,C;this.mainBuffer.reset();var ax=new cartoonBuilder(this.soup,this.mainBuffer,aw);ax.prepare(J);sphere=this.soup.getSphere(1,aw);for(av=0;av<q.length;av++){this.mainBuffer.allocateVertices(sphere.vertices.length/3,sphere.indices.length/3)}var af;cylinder=this.soup.getCylinder(aw);for(ar=0;ar<n.length;ar++){af=n[ar][2]==2?4:2;this.mainBuffer.allocateVertices((cylinder.vertices.length/3)*af,(cylinder.indices.length/3)*af)}for(var ai=0,ag;ai<R.length;ai++){if(!R[ai].display){continue}for(ag=0;ag<R[ai].triangleVertices.length;ag++){this.mainBuffer.allocateVertices(R[ai].triangleVertices[ag].length,R[ai].triangles_lists[ag].length)}}this.mainBuffer.construct();ax.construct();var ao,A,w,ad,ai;for(av=0;av<q.length;av++){eInfo=molmil_dep.getKeyFromObject(molmilConfigBox.elementInfo,q[av].element,molmilConfigBox.elementInfo.DUMMY);if(q[av].displayMode==1){ac=eInfo[3]}else{if(q[av].displayMode==2){ac=0.33}else{ac=0.15}}sphere=this.soup.getSphere(ac,aw);ao=this.mainBuffer.getBuffer(sphere.vertices.length/3,sphere.indices.length/3);A=ao[0];ad=ao[1];w=ao[2];ai=ao[3];for(v=0;v<sphere.indices.length;v++,ai++){w[ai]=sphere.indices[v]+(ad/this.mainBuffer.nodppv)}xyz=q[av].xyz;for(v=0;v<sphere.vertices.length;v+=3){A[ad++]=sphere.vertices[v]+xyz[0];A[ad++]=sphere.vertices[v+1]+xyz[1];A[ad++]=sphere.vertices[v+2]+xyz[2];A[ad++]=sphere.normals[v];A[ad++]=sphere.normals[v+1];A[ad++]=sphere.normals[v+2];A[ad++]=q[av].rgb[0];A[ad++]=q[av].rgb[1];A[ad++]=q[av].rgb[2];A[ad++]=q[av].AID}}var K=this.mainBuffer;var ah=function(){for(v=0;v<cylinder.indices.length;v++,ai++){w[ai]=cylinder.indices[v]+(ad/K.nodppv)}for(v=0;v<cylinder.vertices.length;v+=3){vec4.transformMat4(F,[(cylinder.vertices[v]*ac)+X,(cylinder.vertices[v+1]*ac)+W,(cylinder.vertices[v+2]+U)*d,1],Q);vec4.transformMat4(Y,[cylinder.normals[v],cylinder.normals[v+1],cylinder.normals[v+2],1],Q);A[ad++]=F[0]+xyz[0];A[ad++]=F[1]+xyz[1];A[ad++]=F[2]+xyz[2];A[ad++]=Y[0];A[ad++]=Y[1];A[ad++]=Y[2];A[ad++]=s[0];A[ad++]=s[1];A[ad++]=s[2];A[ad++]=0}};var ac,X,W,U,au=[0,0,0],aq=[0,0,0],t=[0,0,0];for(ar=0;ar<n.length;ar++){af=n[ar][2]==2?4:2;ao=this.mainBuffer.getBuffer((cylinder.vertices.length/3)*af,(cylinder.indices.length/3)*af);A=ao[0];ad=ao[1];w=ao[2];ai=ao[3];xyz=n[ar][0].xyz;am=n[ar][1].xyz;E=n[ar][0].rgb;C=n[ar][1].rgb;o=xyz[0]-am[0];l=xyz[1]-am[1];g=xyz[2]-am[2];d=Math.sqrt((o*o)+(l*l)+(g*g));o/=d;l/=d;g/=d;D=Math.acos(-g);mat4.identity(Q);mat4.rotate(Q,Q,D,[l,-o,0]);ac=0.15;X=0;W=0;U=0;if(n[ar][2]==2){ac=0.075;X=-0.075;ak=null;s=at[n[ar][0].AID];if(s.length==1){s=at[n[ar][1].AID];for(v=0;v<s.length;v++){if(s[v]!=n[ar][0]){ak=s[v].xyz;break}}}else{for(v=0;v<s.length;v++){if(s[v]!=n[ar][1]){ak=s[v].xyz;break}}}}s=E;ah();U+=0.5;s=C;ah();if(n[ar][2]==2){ac=0.075;X=0.075;U=0;s=E;ah();U+=0.5;s=C;ah()}}var F,H;for(var V=0,T,ag;V<R.length;V++){if(!R[V].display||!R[V].triangleVertices.length){continue}for(ag=0;ag<R[V].triangleVertices.length;ag++){ao=this.mainBuffer.getBuffer(R[V].triangleVertices[ag].length,R[V].triangles_lists[ag].length);A=ao[0];ad=ao[1];w=ao[2];ai=ao[3];H={};for(T=0;T<R[V].triangleVertices[ag].length;T++){F=R[V].vertices[R[V].triangleVertices[ag][T]];H[R[V].triangleVertices[ag][T]]=ad/10;A[ad++]=F[0];A[ad++]=F[1];A[ad++]=F[2];A[ad++]=F[3];A[ad++]=F[4];A[ad++]=F[5];A[ad++]=F[6];A[ad++]=F[7];A[ad++]=F[8];A[ad++]=0}for(T=0;T<R[V].triangles_lists[ag].length;T++){w[ai++]=H[R[V].triangles_lists[ag][T][0]];w[ai++]=H[R[V].triangles_lists[ag][T][1]];w[ai++]=H[R[V].triangles_lists[ag][T][2]]}}}this.lineStripBuffer.reset();var L=this.lineStripBuffer;var u=function(b,i){L.allocateVertices(b.length,i.length)};var G=function(p,y){ao=L.getBuffer(p.length,y.length);A=ao[0];ad=ao[1];w=ao[2];ai=ao[3];var x={};for(var m=0;m<p.length;m++){x[p[m].AID]=ad/7;A[ad++]=p[m].xyz[0];A[ad++]=p[m].xyz[1];A[ad++]=p[m].xyz[2];A[ad++]=p[m].rgb[0];A[ad++]=p[m].rgb[1];A[ad++]=p[m].rgb[2];A[ad++]=p[m].AID}for(var i=0;i<y.length;i++){w[ai++]=x[y[i][0].AID];w[ai++]=x[y[i][1].AID]}};if(molmilConfigBox.OES_element_index_uint){u(aa,O)}else{var ap={},S;for(var av=0;av<aa.length;av++){S=aa[av].molecule.chain.CID;if(!ap.hasOwnProperty(S)){ap[S]={vertices:[],indices:[]}}ap[S].vertices.push(aa[av])}for(var ar=0;ar<O.length;ar++){S=O[ar][0].molecule.chain.CID;if(S!=O[ar][1].molecule.chain.CID||!ap.hasOwnProperty(S)){continue}ap[S].indices.push(O[ar])}for(var an in ap){u(ap[an].vertices,ap[an].indices)}}var ab=0,aj=0;for(var ai=0,ag;ai<R.length;ai++){if(!R[ai].display){continue}for(ag=0;ag<R[ai].lineVertices.length;ag++){this.lineStripBuffer.allocateVertices(R[ai].lineVertices[ag].length,R[ai].lines_lists[ag].length)}}this.lineStripBuffer.construct();if(molmilConfigBox.OES_element_index_uint){G(aa,O)}else{for(var an in ap){G(ap[an].vertices,ap[an].indices)}}var F,H,ad=0,z=0;for(var ai=0,ag,V;ai<R.length;ai++){if(!R[ai].display){continue}H={};for(ag=0;ag<R[ai].lineVertices.length;ag++){ao=this.lineStripBuffer.getBuffer(R[ai].lineVertices[ag].length,R[ai].lines_lists[ag].length);A=ao[0];ad=ao[1];w=ao[2];z=ao[3];for(V=0;V<R[ai].lineVertices[ag].length;V++){F=R[ai].vertices[R[ai].lineVertices[ag][V]];H[R[ai].lineVertices[ag][V]]=ad/7;A[ad++]=F[0];A[ad++]=F[1];A[ad++]=F[2];A[ad++]=F[6];A[ad++]=F[7];A[ad++]=F[8];A[ad++]=0}for(V=0;V<R[ai].lines_lists[ag].length;V++){w[z++]=H[R[ai].lines_lists[ag][V][0]];w[z++]=H[R[ai].lines_lists[ag][V][1]]}}}};jvRenderer.prototype.selectFrame=function(b){var d=this.framesBuffer[b];if(!d){return}for(var b=0;b<d.length;b++){d[b][0].uploadFrame(d[b][1],d[b][2])}};jvRenderer.prototype.initBuffers=function(){if(this.animationMode){this.framesBuffer.length=0;for(var b=0;b<this.framesDefinition.length;b++){this.createBuffer(this.framesDefinition[b][0],this.framesDefinition[b][1],this.framesDefinition[b][2]);this.framesBuffer.push([[this.mainBuffer,this.mainBuffer.vBuffers,this.mainBuffer.iBuffers],[this.lineStripBuffer,this.lineStripBuffer.vBuffers,this.lineStripBuffer.iBuffers]]);this.mainBuffer.unblock();this.lineStripBuffer.unblock()}this.selectFrame(0)}else{this.createBuffer(this.soup.models,this.soup.polygonData);this.mainBuffer.upload();this.lineStripBuffer.upload()}this.initBD=true};jvRenderer.prototype.renderPicking=function(){if(!this.initBD){return}this.gl.clearColor(0,0,0,0);this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT);var h=[0,0,0];var f=mat3.create();mat3.fromMat4(f,this.modelViewMatrix);vec3.transformMat3(h,this.soup.COR,f);this.mainBuffer.customRenderer=this.pickingRender;if(this.mainBuffer.render!=this.mainBuffer.renderMany){this.mainBuffer.render=this.pickingRender}this.mainBuffer.attributes=this.shaders.picking.attributes;this.lineStripBuffer.customRenderer=this.pickingRenderLines;if(this.lineStripBuffer.render!=this.lineStripBuffer.renderMany){this.lineStripBuffer.render=this.pickingRenderLines}this.lineStripBuffer.attributes=this.shaders.linesPicking.attributes;if(this.soup.BUmode){var d=mat4.create();var g=this.soup.bumats;if(this.soup.AU_only&&this.soup.BU_operExp){g=[this.soup.bumats[canvas.pdbjViewer.BU_operExp-1]]}for(var b=0;b<g.length;b++){mat4.multiply(d,this.modelViewMatrix,g[b]);this.renderBasicPicking(d,h);this.renderLinesPicking(d,h)}}else{this.renderBasicPicking(this.modelViewMatrix,h);this.renderLinesPicking(this.modelViewMatrix,h)}this.mainBuffer.customRenderer=this.standardRender;if(this.mainBuffer.render!=this.mainBuffer.renderMany){this.mainBuffer.render=this.standardRender}this.mainBuffer.attributes=this.shaders.standard.attributes;this.lineStripBuffer.customRenderer=this.linesRender;if(this.lineStripBuffer.render!=this.lineStripBuffer.renderMany){this.lineStripBuffer.render=this.linesRender}this.lineStripBuffer.attributes=this.shaders.lines.attributes;for(var l=0;l<this.programs.length;l++){this.programs[l].renderPicking()}this.gl.useProgram(null)};function unproject(d,b,g,f){d=2*d-1;b=2*b-1;g=2*g-1;var h=[d,b,g,1];vec4.transformMat4(h,h,f);h[3]=1/h[3];return[h[0]*h[3],h[1]*h[3],h[2]*h[3]]}jvRenderer.prototype.render=function(){if(!this.canvas.update||!this.initBD){return}if(this.canvas.update){for(var m=0;m<this.soup.canvases.length;m++){if(this.soup.canvases[m]!=this.canvas){this.soup.canvases[m].update=-1}}this.canvas.update=false;this.camera.pitchAngle=this.pitchAngle||this.pitch*Math.min(Math.max((Math.pow(Math.abs(this.camera.z),0.1)*0.25),0.5),2);this.camera.headingAngle=this.headingAngle||this.heading*Math.min(Math.max((Math.pow(Math.abs(this.camera.z),0.1)*0.25),0.5),2);if(this.TransX||this.TransY){var q=mat4.invert(mat4.create(),this.projectionMatrix);var t=(-this.camera.z-molmilConfigBox.zNear)/(molmilConfigBox.zFar-molmilConfigBox.zNear);var n=vec3.lerp([0,0,0],unproject(this.TransB[0],this.TransB[1],0,q),unproject(this.TransB[0],this.TransB[1],1,q),t);this.TransB[0]+=this.TransX/this.width;this.TransB[1]-=this.TransY/this.height;var o=vec3.lerp([0,0,0],unproject(this.TransB[0],this.TransB[1],0,q),unproject(this.TransB[0],this.TransB[1],1,q),t);this.camera.x+=2*(o[0]-n[0]);this.camera.y+=2*(o[1]-n[1])}this.camera.z+=this.TransZ*Math.max(-this.camera.z/(this.width*0.5),0.05);this.pitch=0,this.heading=0,this.TransX=0,this.TransY=0,this.TransZ=0,this.pitchAngle=0,this.headingAngle=0;this.camera.positionCamera();this.modelViewMatrix=this.camera.generateMatrix();if(molmilConfigBox.projectionMode==2){var d=-(this.camera.z*2)/molmilConfigBox.zFar;mat4.ortho(this.projectionMatrix,-this.width*d,this.width*d,-this.height*d,this.height*d,Math.max(molmilConfigBox.zNear,0.1),this.camera.z+(molmilConfigBox.zFar*2))}}else{this.canvas.update=false}this.clearCut=((1-Math.abs(this.camera.QView[0]))*this.soup.stdXYZ[0])+((1-Math.abs(this.camera.QView[1]))*this.soup.stdXYZ[1])+((1-Math.abs(this.camera.QView[2]))*this.soup.stdXYZ[2]);this.fogStart=-this.camera.z-(this.clearCut*0.5);if(this.fogStart<molmilConfigBox.zNear+1){this.fogStart=molmilConfigBox.zNear+1}this.gl.clearColor.apply(this.gl,molmilConfigBox.BGCOLOR);this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT);var l=[0,0,0];var g=mat3.create();mat3.fromMat4(g,this.modelViewMatrix);vec3.transformMat3(l,this.soup.COR,g);if(this.soup.BUmode){var h=this.soup.bumats;if(this.soup.AU_only&&this.soup.BU_operExp){h=[this.soup.bumats[this.soup.BU_operExp-1]]}var s=mat4.create();for(var f=0;f<h.length;f++){mat4.multiply(s,this.modelViewMatrix,h[f]);this.renderBasic(s,l);this.renderLines(s,l)}}else{this.renderBasic(this.modelViewMatrix,l);this.renderLines(this.modelViewMatrix,l);if(this.soup.atomSelection.length){this.renderAtomSelection(this.modelViewMatrix,l)}}for(var b=0;b<this.programs.length;b++){this.programs[b].render(this.modelViewMatrix,l)}if(this.onRenderFinish){this.onRenderFinish()}this.gl.useProgram(null)};jvRenderer.prototype.initFBOs=function(){if("scene" in this.FBOs){this.FBOs.depth.resize(this.width,this.height);this.FBOs.scene.resize(this.width,this.height)}else{this.FBOs.depth=new FBO(this.gl,this.width,this.height);this.FBOs.depth.addTexture("depthBuffer",this.gl.RGBA,this.gl.RGBA);this.FBOs.depth.setup();this.FBOs.scene=new FBO(this.gl,this.width,this.height);this.FBOs.scene.addTexture("colourBuffer",this.gl.RGBA,this.gl.RGBA);this.FBOs.scene.setup()}};jvRenderer.prototype.resizeViewPort=function(){this.width=this.canvas.width;this.height=this.canvas.height;if(molmilConfigBox.projectionMode==1){mat4.perspective(this.projectionMatrix,45*(Math.PI/360),this.width/this.height,molmilConfigBox.zNear,molmilConfigBox.zFar)}this.gl.viewport(0,0,this.width,this.height)};jvRenderer.prototype.renderAtomSelection=function(b,d){this.gl.useProgram(this.shaders.atomSelection.program);this.gl.uniform3f(this.shaders.atomSelection.uniforms.COR,d[0],d[1],d[2]);this.gl.uniformMatrix4fv(this.shaders.atomSelection.uniforms.modelViewMatrix,false,b);this.gl.uniformMatrix4fv(this.shaders.atomSelection.uniforms.projectionMatrix,false,this.projectionMatrix);this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.buffers.atomSelectionBuffer);this.gl.vertexAttribPointer(this.shaders.atomSelection.attributes.in_Position,3,this.gl.FLOAT,false,32,0);this.gl.vertexAttribPointer(this.shaders.atomSelection.attributes.in_Colour,3,this.gl.FLOAT,false,32,12);this.gl.vertexAttribPointer(this.shaders.atomSelection.attributes.in_ScreenSpaceOffset,2,this.gl.FLOAT,false,32,24);this.gl.enable(this.gl.BLEND);this.gl.disable(this.gl.CULL_FACE);this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA);this.gl.drawArrays(this.gl.TRIANGLES,0,this.buffers.atomSelectionBuffer.items);this.gl.enable(this.gl.CULL_FACE);this.gl.disable(this.gl.BLEND)};jvRenderer.prototype.renderLines=function(b,d){this.gl.useProgram(this.shaders.lines.program);this.gl.uniform3f(this.shaders.lines.uniforms.COR,d[0],d[1],d[2]);this.gl.uniformMatrix4fv(this.shaders.lines.uniforms.modelViewMatrix,false,b);this.gl.uniformMatrix4fv(this.shaders.lines.uniforms.projectionMatrix,false,this.projectionMatrix);this.gl.uniform1f(this.shaders.lines.uniforms.focus,this.fogStart);this.gl.uniform1f(this.shaders.lines.uniforms.fogSpan,this.fogStart+(this.clearCut*2));this.lineStripBuffer.render(0)};jvRenderer.prototype.renderBasicPicking=function(b,d){this.gl.useProgram(this.shaders.picking.program);this.gl.uniformMatrix4fv(this.shaders.picking.uniforms.modelViewMatrix,false,b);this.gl.uniformMatrix4fv(this.shaders.picking.uniforms.projectionMatrix,false,this.projectionMatrix);this.gl.uniform3f(this.shaders.picking.uniforms.COR,d[0],d[1],d[2]);this.mainBuffer.render(0)};jvRenderer.prototype.renderLinesPicking=function(b,d){this.gl.useProgram(this.shaders.linesPicking.program);this.gl.uniformMatrix4fv(this.shaders.linesPicking.uniforms.modelViewMatrix,false,b);this.gl.uniformMatrix4fv(this.shaders.linesPicking.uniforms.projectionMatrix,false,this.projectionMatrix);this.gl.uniform3f(this.shaders.linesPicking.uniforms.COR,d[0],d[1],d[2]);this.lineStripBuffer.render(0)};jvRenderer.prototype.renderBasic=function(b,d){var f=mat3.create();mat3.normalFromMat4(f,b);this.gl.useProgram(this.shaders.standard.program);this.gl.uniformMatrix4fv(this.shaders.standard.uniforms.modelViewMatrix,false,b);this.gl.uniformMatrix3fv(this.shaders.standard.uniforms.normalMatrix,false,f);this.gl.uniformMatrix4fv(this.shaders.standard.uniforms.projectionMatrix,false,this.projectionMatrix);this.gl.uniform3f(this.shaders.standard.uniforms.COR,d[0],d[1],d[2]);this.gl.uniform1f(this.shaders.standard.uniforms.focus,this.fogStart);this.gl.uniform1f(this.shaders.standard.uniforms.fogSpan,this.fogStart+(this.clearCut*2));this.mainBuffer.render(0)};function dynamicBuffer(){this.vBufferSizes=[0];this.iBufferSizes=[0];this.vBuffers=[];this.iBuffers=[];this.vertexBuffers=[];this.indexBuffers=[];this.items=[];this.bi=0;this.customRenderer=function(){};this.modelCache={}}dynamicBuffer.prototype.init=function(d){this.gl=d;this.mbs=65536;this.indexFormat=this.gl.UNSIGNED_SHORT;this.angle=false;if(molmilConfigBox.OES_element_index_uint){this.indexFormat=this.gl.UNSIGNED_INT;this.mbs=4294967296;var b=this.gl.getParameter(this.gl.ALIASED_LINE_WIDTH_RANGE);this.angle=b&&b.length==2&&b[0]==1&&b[1]==1}this.bufferSize=65536};dynamicBuffer.prototype.reset=function(){this.vBufferSizes.length=this.iBufferSizes.length=this.vBuffers.length=this.iBuffers.length=this.bi=0;this.vBufferSizes.push(0);this.iBufferSizes.push(0)};dynamicBuffer.prototype.unblock=function(){this.vBuffers=[];this.iBuffers=[]};dynamicBuffer.prototype.allocateVertices=function(b,d){if(this.vBuffers.length){throw"ERROR: buffers already created!"}if((this.vBufferSizes[this.bi]/this.nodppv)+b>this.mbs){this.vBufferSizes.push(0);this.iBufferSizes.push(0);this.bi+=1}this.vBufferSizes[this.bi]+=b*this.nodppv;this.iBufferSizes[this.bi]+=d*this.noipp};dynamicBuffer.prototype.allocateVerticesSplitable=function(b,d){this.allocateVertices(b,d);if((this.vBufferSizes[this.bi]/this.nodppv)+b>this.mbs){this.allocateVertices(b,d)}};dynamicBuffer.prototype.construct=function(){this.vPos=[];this.iPos=[];for(var b=0;b<this.bi+1;b++){this.vBuffers.push(new Float32Array(this.vBufferSizes[b]));if(molmilConfigBox.OES_element_index_uint){this.iBuffers.push(new Uint32Array(this.iBufferSizes[b]))}else{this.iBuffers.push(new Uint16Array(this.iBufferSizes[b]))}this.vPos.push(0);this.iPos.push(0)}this.bi=0};dynamicBuffer.prototype.getBuffer=function(d,f){if(!this.vBuffers.length){throw"ERROR: no buffers have been initialized!"}if(this.vPos[this.bi]>=this.vBufferSizes[this.bi]){this.bi+=1}var b=this.vPos[this.bi],g=this.iPos[this.bi];this.vPos[this.bi]+=d*this.nodppv;this.iPos[this.bi]+=f*this.noipp;return[this.vBuffers[this.bi],b,this.iBuffers[this.bi],g,this.vPos[this.bi]==this.vBufferSizes[this.bi]]};dynamicBuffer.prototype.uploadFrame=function(d,b){this.vBuffers=d;this.iBuffers=b;this.upload(true)};dynamicBuffer.prototype.upload=function(f){var d;for(d=this.vertexBuffers.length;d<this.vBuffers.length;d++){this.vertexBuffers.push(this.gl.createBuffer());this.indexBuffers.push(this.gl.createBuffer())}for(d=this.vBuffers.length;d<this.vertexBuffers.length;d++){this.gl.deleteBuffer(this.vertexBuffers[d]);this.gl.deleteBuffer(this.indexBuffers[d])}this.vertexBuffers.splice(this.vBuffers.length);this.indexBuffers.splice(this.vBuffers.length);this.items.splice(this.vBuffers.length);for(d=0;d<this.vBuffers.length;d++){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffers[d]);this.gl.bufferData(this.gl.ARRAY_BUFFER,this.vBuffers[d],this.gl.STATIC_DRAW);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffers[d]);this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,this.iBuffers[d],this.gl.STATIC_DRAW);this.items[d]=this.iBuffers[d].length}this.rbLen=this.vBuffers.length;if(!f){this.vBuffers.length=0;this.iBuffers.length=0}if(this.rbLen==1){this.render=this.customRenderer}else{this.render=this.renderMany}};dynamicBuffer.prototype.renderMany=function(){for(var d=0;d<this.rbLen;d++){this.customRenderer(d)}};function FBO(f,d,b){this.width=d;this.height=b;this.gl=f;this.textures={};this.colourNumber=0;this.fbo=null;this.depthBuffer=null}FBO.prototype.addTexture=function(g,b,f){if(g in this.textures){this.gl.bindTexture(this.gl.TEXTURE_2D,this.textures[g][0])}else{var d=this.gl.createTexture();this.textures[g]=[d,this.colourNumber++,b,f];this.gl.bindTexture(this.gl.TEXTURE_2D,d);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE);this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE)}this.gl.texImage2D(this.gl.TEXTURE_2D,0,b,this.width,this.height,0,f,this.gl.UNSIGNED_BYTE,null);this.gl.bindTexture(this.gl.TEXTURE_2D,null)};FBO.prototype.setup=function(){if(this.fbo!=null){this.rebindTextures(true)}else{this.fbo=this.gl.createFramebuffer();this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.fbo);this.rebindTextures(false);this.depthBuffer=this.gl.createRenderbuffer();this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.depthBuffer);this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_COMPONENT16,this.width,this.height);this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,this.depthBuffer);this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)}};FBO.prototype.rebindTextures=function(f){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.fbo);var d=[];for(var b in this.textures){this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0+this.textures[b][1],this.gl.TEXTURE_2D,this.textures[b][0],0);d.push(this.gl.COLOR_ATTACHMENT0+this.textures[b][1])}this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,this.depthBuffer);if(f){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)}};FBO.prototype.bindTextureToUniform=function(d,f,b){this.gl.activeTexture(this.gl.TEXTURE0+b);this.gl.bindTexture(this.gl.TEXTURE_2D,this.textures[d][0]);this.gl.uniform1i(f,b)};FBO.prototype.resize=function(f,b){if(f==this.width&&b==this.height){return}this.width=f;this.height=b;for(var d in this.textures){this.addTexture(d,this.textures[d][2],this.textures[d][3])}this.rebindTextures(false);this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.depthBuffer);this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_COMPONENT16,this.width,this.height);this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,this.depthBuffer);this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)};FBO.prototype.bind=function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.fbo)};FBO.prototype.unbind=function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null)};function glCamera(){this.reset()}glCamera.prototype.reset=function(){this.x=this.y=this.z=this.pitchAngle=this.headingAngle=0;this.QPitch=quat.create();this.QHeading=quat.create();this.QView=quat.create();this.pitchAngle=this.headingAngle=0};glCamera.prototype.generateMatrix=function(){var b=mat4.create();mat4.fromQuat(b,this.QView);b[12]=this.x;b[13]=this.y;b[14]=this.z;return b};glCamera.prototype.positionCamera=function(){quat.setAxisAngle(this.QPitch,[1,0,0],(this.pitchAngle/180)*Math.PI);quat.setAxisAngle(this.QHeading,[0,1,0],(this.headingAngle/180)*Math.PI);var b=quat.create();quat.multiply(b,this.QPitch,this.QHeading);quat.multiply(this.QView,b,this.QView);this.headingAngle=this.pitchAngle=0};function handle_pdbjViewer_mouseDown(b){activeCanvas=this;mouseDown=1;mouseDownS[b.which]=1;Xcoord=b.clientX;Ycoord=b.clientY;Zcoord=b.clientY;mouseMoved=false;document.oncontextmenu=disableContextMenu}function disableContextMenu(b){if(b.stopPropagation){b.stopPropagation()}if(b.preventDefault){b.preventDefault()}b.cancelBubble=true;b.cancel=true;b.returnValue=false;return false}function getOffset(d){var f=d.target,b=0,g=0;while(f&&!isNaN(f.offsetLeft)&&!isNaN(f.offsetTop)){b+=f.offsetLeft-f.scrollLeft;g+=f.offsetTop-f.scrollTop;f=f.offsetParent}b=d.clientX-b;g=d.clientY-g;return{x:b,y:g}}function handle_pdbjViewer_mouseUp(f){if(!mouseMoved&&activeCanvas){if(f.ctrlKey!=activeCanvas.atomCORset){if(f.ctrlKey){activeCanvas.pdbjViewer.setCOR()}else{activeCanvas.pdbjViewer.resetCOR()}activeCanvas.renderer.modelViewMatrix=activeCanvas.renderer.camera.generateMatrix()}if(activeCanvas.isFullScreen){var h={x:f.screenX,y:f.screenY}}else{var h=getOffset(f)}var d=window.devicePixelRatio||1;activeCanvas.renderer.soup.selectObject(h.x*d,h.y*d,f);if(f.which==3){activeCanvas.renderer.soup.UI.showContextMenuAtom(f.clientX,f.clientY)}}mouseDownS[f.which]=0;if(molmil_dep.dBT.mac&&!f.ctrlKey&&mouseDownS[3]){mouseDownS[3]=0}var b=true;for(var g in mouseDownS){if(mouseDownS[g]){b=false;break}}mouseDown=b?0:1;if(b){setTimeout(function(){document.oncontextmenu=null},10);activeCanvas=null}else{f.preventDefault();return false}}function handle_pdbjViewer_mouseMove(b){if(!mouseDown||!activeCanvas){return}mouseMoved=true;if(mouseDownS[2]||(mouseDownS[1]&&mouseDownS[3])||(mouseDownS[1]&&b.shiftKey)){activeCanvas.renderer.TransX=b.clientX-Xcoord;activeCanvas.renderer.TransY=b.clientY-Ycoord;Xcoord=b.clientX;Zcoord=Ycoord=b.clientY}else{if(mouseDownS[1]){activeCanvas.renderer.heading+=b.clientX-Xcoord;activeCanvas.renderer.pitch+=b.clientY-Ycoord;Xcoord=b.clientX;Ycoord=b.clientY}else{if(mouseDownS[3]){activeCanvas.renderer.TransZ=(b.clientY-Zcoord);Zcoord=b.clientY}}}if(b.ctrlKey!=activeCanvas.atomCORset){if(b.ctrlKey){activeCanvas.pdbjViewer.setCOR()}else{activeCanvas.pdbjViewer.resetCOR()}}activeCanvas.update=true;b.preventDefault()}function handle_pdbjViewer_mouseScroll(b){b.target.renderer.TransZ-=(b.wheelDelta||-b.detail*40);b.target.update=true;try{b.preventDefault()}catch(d){}return false}pdbjViewer.prototype.setCOR=function(){if(this.lastKnowAS){resetCOR()}this.lastKnownAS=null;if(!this.atomSelection.length){return}this.lastKnownAS=this.atomSelection[0].xyz;var d=mat3.create();mat3.fromMat4(d,this.renderer.modelViewMatrix);var f=vec3.subtract([0,0,0],this.lastKnownAS,this.avgXYZ);vec3.transformMat3(f,f,d);this.renderer.camera.x+=f[0];this.renderer.camera.y+=f[1];this.renderer.camera.z+=f[2];for(var b=0;b<this.canvases.length;b++){this.canvases[b].pdbjViewer.COR=this.atomSelection[0].xyz}this.canvas.atomCORset=true};pdbjViewer.prototype.resetCOR=function(){var d=mat3.create();mat3.fromMat4(d,this.renderer.modelViewMatrix);var f=vec3.subtract([0,0,0],this.avgXYZ,this.lastKnownAS);vec3.transformMat3(f,f,d);this.renderer.camera.x+=f[0];this.renderer.camera.y+=f[1];this.renderer.camera.z+=f[2];for(var b=0;b<this.canvases.length;b++){this.canvases[b].pdbjViewer.COR=this.avgXYZ}this.canvas.atomCORset=false;this.lastKnownAS=null};function onDocumentMouseMove(b){if(mouseXstart==null){mouseXstart=b.clientX;mouseYstart=b.clientY}mouseX=b.clientX-mouseXstart;mouseY=b.clientY-mouseYstart;mouseXstart=b.clientX;mouseYstart=b.clientY}var longTouchTID=null;var previousTouchEvent=null;function handle_pdbjViewer_touchStart(g){if(document.body.onmousedown){document.body.onmousedown();document.body.onmousedown=null}activeCanvas=this;touchList=[];for(var f=0;f<g.touches.length;f++){touchList.push([g.touches[f].clientX,g.touches[f].clientY])}if(touchList.length==1){touchMode=1;previousTouchEvent=g;longTouchTID=setTimeout(handle_pdbjViewer_touchHold,500)}else{if(touchList.length==2){var h=vec2.distance([0,0],[screen.width,screen.height]);var d=vec2.distance(touchList[0],touchList[1]);if(d/h<0.075){touchMode=3}else{touchMode=2}}}g.preventDefault()}function handle_pdbjViewer_touchHold(){if(!longTouchTID){return}if(previousTouchEvent){if(Math.sqrt((Math.pow(previousTouchEvent.touches[0].clientX-touchList[0][0],2))+(Math.pow(previousTouchEvent.touches[0].clientY-touchList[0][1],2)))<1){if(activeCanvas.isFullScreen){var d={x:previousTouchEvent.touches[0].screenX,y:previousTouchEvent.touches[0].screenY}}else{var d=getOffset(previousTouchEvent.touches[0])}var b=window.devicePixelRatio||1;activeCanvas.renderer.soup.selectObject(d.x*b,d.y*b,event)}activeCanvas.renderer.soup.UI.showContextMenuAtom(previousTouchEvent.touches[0].clientX,previousTouchEvent.touches[0].clientY)}longTouchTID=null;previousTouchEvent=null}function handle_pdbjViewer_touchMove(h){if(!touchList.length||!activeCanvas){return}if(longTouchTID){clearTimeout(longTouchTID);longTouchTID=null}var g=[];for(var f=0;f<h.touches.length;f++){g.push([h.touches[f].clientX,h.touches[f].clientY])}if(touchMode==1){activeCanvas.renderer.heading+=g[0][0]-touchList[0][0];activeCanvas.renderer.pitch+=g[0][1]-touchList[0][1]}else{if(touchMode==2){activeCanvas.renderer.TransZ=(vec2.distance(g[0],g[1])-vec2.distance(touchList[0],touchList[1]))*5}else{if(touchMode==3){var i=vec2.distance([0,0],[screen.width,screen.height]);var d=vec2.distance(touchList[0],touchList[1]);if(d/i<0.075){activeCanvas.renderer.TransX=((g[0][0]+g[1][0])/2)-((touchList[0][0]+touchList[1][0])/2);activeCanvas.renderer.TransY=((g[0][1]+g[1][1])/2)-((touchList[0][1]+touchList[1][1])/2)}}}}touchList=g;activeCanvas.update=true;h.preventDefault()}function handle_pdbjViewer_touchEnd(){if(previousTouchEvent&&touchMode==1){if(Math.sqrt((Math.pow(previousTouchEvent.touches[0].clientX-touchList[0][0],2))+(Math.pow(previousTouchEvent.touches[0].clientY-touchList[0][1],2)))<1){if(activeCanvas.isFullScreen){var d={x:previousTouchEvent.touches[0].screenX,y:previousTouchEvent.touches[0].screenY}}else{var d=getOffset(previousTouchEvent.touches[0])}var b=window.devicePixelRatio||1;activeCanvas.renderer.soup.selectObject(d.x*b,d.y*b,event)}}touchList=[];touchMode=0;longTouchTID=null}function loadShader(h,d){var f=new molmil_dep.CallRemote("GET");f.Send(h);var g=f.request.responseText.split("//#");var b=JSON.parse(g[0]);b.vertexShader=g[1].substr(7);b.fragmentShader=g[2].substr(9);if(!d){d=""}if(molmilConfigBox.glsl_fog){d+="#define ENABLE_FOG 1\n"}b.vertexShader=d+b.vertexShader;b.fragmentShader=d+b.fragmentShader;return b}function setupShader(i,d,b,h,f){var g=i.createShader(f);i.shaderSource(g,h);i.compileShader(g);if(!i.getShaderParameter(g,i.COMPILE_STATUS)){console.log(d+":\n"+i.getShaderInfoLog(g));return null}i.attachShader(b,g);return g}function hermiteInterpolate(C,B,x,u,f,y){var A=1e-10;var p=[];var q,w,d,b,l,i,h,g,z,m,o,n;for(q=0;q<(f+(y?2:1));q+=1){w=q/(f+1);d=w*w;b=w*w*w;l=2*b-3*d+1;i=-2*b+3*d;h=b-2*d+w;g=b-d;z=[(C[0]*l)+(B[0]*i)+(x[0]*h)+(u[0]*g),(C[1]*l)+(B[1]*i)+(x[1]*h)+(u[1]*g),(C[2]*l)+(B[2]*i)+(x[2]*h)+(u[2]*g)];o=w-A;n=w+A;w=o;d=w*w;b=w*w*w;l=2*b-3*d+1;i=-2*b+3*d;h=b-2*d+w;g=b-d;o=[(C[0]*l)+(B[0]*i)+(x[0]*h)+(u[0]*g),(C[1]*l)+(B[1]*i)+(x[1]*h)+(u[1]*g),(C[2]*l)+(B[2]*i)+(x[2]*h)+(u[2]*g)];w=n;d=w*w;b=w*w*w;l=2*b-3*d+1;i=-2*b+3*d;h=b-2*d+w;g=b-d;n=[(C[0]*l)+(B[0]*i)+(x[0]*h)+(u[0]*g),(C[1]*l)+(B[1]*i)+(x[1]*h)+(u[1]*g),(C[2]*l)+(B[2]*i)+(x[2]*h)+(u[2]*g)];m=vec3.subtract([0,0,0],n,o);vec3.normalize(m,m);p.push([z,m])}return p}function calcTangentHI(A,z,w,q){var y=1e-10;var o=[];var p,u,d,b,i,h,g,f,x,l,n,m;n=-y;m=y;u=n;d=u*u;b=u*u*u;i=2*b-3*d+1;h=-2*b+3*d;g=b-2*d+u;f=b-d;n=[(A[0]*i)+(z[0]*h)+(w[0]*g)+(q[0]*f),(A[1]*i)+(z[1]*h)+(w[1]*g)+(q[1]*f),(A[2]*i)+(z[2]*h)+(w[2]*g)+(q[2]*f)];u=m;d=u*u;b=u*u*u;i=2*b-3*d+1;h=-2*b+3*d;g=b-2*d+u;f=b-d;m=[(A[0]*i)+(z[0]*h)+(w[0]*g)+(q[0]*f),(A[1]*i)+(z[1]*h)+(w[1]*g)+(q[1]*f),(A[2]*i)+(z[2]*h)+(w[2]*g)+(q[2]*f)];l=vec3.subtract([0,0,0],m,n);vec3.normalize(l,l);return l}function hermiteInterpolateSpecific(A,z,w,q,u){var y=0.0001;var o=[];var p,d,b,i,h,g,f,x,l,n,m;d=u*u;b=u*u*u;i=2*b-3*d+1;h=-2*b+3*d;g=b-2*d+u;f=b-d;x=[(A[0]*i)+(z[0]*h)+(w[0]*g)+(q[0]*f),(A[1]*i)+(z[1]*h)+(w[1]*g)+(q[1]*f),(A[2]*i)+(z[2]*h)+(w[2]*g)+(q[2]*f)];n=Math.max(u-y,0);m=Math.min(u+y,1);u=n;d=u*u;b=u*u*u;i=2*b-3*d+1;h=-2*b+3*d;g=b-2*d+u;f=b-d;n=[(A[0]*i)+(z[0]*h)+(w[0]*g)+(q[0]*f),(A[1]*i)+(z[1]*h)+(w[1]*g)+(q[1]*f),(A[2]*i)+(z[2]*h)+(w[2]*g)+(q[2]*f)];u=m;d=u*u;b=u*u*u;i=2*b-3*d+1;h=-2*b+3*d;g=b-2*d+u;f=b-d;m=[(A[0]*i)+(z[0]*h)+(w[0]*g)+(q[0]*f),(A[1]*i)+(z[1]*h)+(w[1]*g)+(q[1]*f),(A[2]*i)+(z[2]*h)+(w[2]*g)+(q[2]*f)];l=vec3.subtract([0,0,0],m,n);vec3.normalize(l,l);return[x,l]}function octaSphereBuilder(m){var p=[],h=[],o=0,l,n,y,x,u,s,z,d,g,w,q={};d=function(b,i,f){g=Math.sqrt(b*b+i*i+f*f);p.push([b/g,i/g,f/g]);return o++};w=function(C,A){var b=C<A;smallerIndex=b?C:A;greaterIndex=b?A:C;key=[smallerIndex,greaterIndex];ret=molmil_dep.getKeyFromObject(q,key,null);if(ret!=null){return ret}var B=p[C];var t=p[A];var f=d((B[0]+t[0])*0.5,(B[1]+t[1])*0.5,(B[2]+t[2])*0.5);q[key]=f;return f};d(-1,1,0);d(1,1,0);d(1,-1,0);d(-1,-1,0);d(0,0,-1);d(0,0,1);h.push([0,1,4]);h.push([1,2,4]);h.push([2,3,4]);h.push([3,0,4]);h.push([5,1,0]);h.push([5,2,1]);h.push([5,3,2]);h.push([5,0,3]);for(l=0;l<m;l++){y=[];for(n=0;n<h.length;n++){x=w(h[n][0],h[n][1]);u=w(h[n][1],h[n][2]);s=w(h[n][2],h[n][0]);y.push([h[n][0],x,s]);y.push([h[n][1],u,x]);y.push([h[n][2],s,u]);y.push([x,u,s])}h=y}return{vertices:p,faces:h}}function icoSphereBuilder(m){var p=[],h=[],o=0,l,n,y,x,u,s,z,d,g,w,q={};d=function(b,i,f){g=Math.sqrt(b*b+i*i+f*f);p.push([b/g,i/g,f/g]);return o++};w=function(C,A){var b=C<A;smallerIndex=b?C:A;greaterIndex=b?A:C;key=[smallerIndex,greaterIndex];ret=molmil_dep.getKeyFromObject(q,key,null);if(ret!=null){return ret}var B=p[C];var t=p[A];var f=d((B[0]+t[0])*0.5,(B[1]+t[1])*0.5,(B[2]+t[2])*0.5);q[key]=f;return f};z=(1+Math.sqrt(5))/2;d(-1,z,0);d(1,z,0);d(-1,-z,0);d(1,-z,0);d(0,-1,z);d(0,1,z);d(0,-1,-z);d(0,1,-z);d(z,0,-1);d(z,0,1);d(-z,0,-1);d(-z,0,1);h.push([0,11,5]);h.push([0,5,1]);h.push([0,1,7]);h.push([0,7,10]);h.push([0,10,11]);h.push([1,5,9]);h.push([5,11,4]);h.push([11,10,2]);h.push([10,7,6]);h.push([7,1,8]);h.push([3,9,4]);h.push([3,4,2]);h.push([3,2,6]);h.push([3,6,8]);h.push([3,8,9]);h.push([4,9,5]);h.push([2,4,11]);h.push([6,2,10]);h.push([8,6,7]);h.push([9,8,1]);for(l=0;l<m;l++){y=[];for(n=0;n<h.length;n++){x=w(h[n][0],h[n][1]);u=w(h[n][1],h[n][2]);s=w(h[n][2],h[n][0]);y.push([h[n][0],x,s]);y.push([h[n][1],u,x]);y.push([h[n][2],s,u]);y.push([x,u,s])}h=y}return{vertices:p,faces:h}}function buildOctaDome(n,h){var b=octaSphereBuilder(n),p,o,m,g,l=[];for(var f=0;f<b.vertices.length;f++){p=b.vertices[4][0]-b.vertices[f][0];o=b.vertices[4][1]-b.vertices[f][1];m=b.vertices[4][2]-b.vertices[f][2];g=p*p+o*o+m*m;if((h==0&&g>2.00001)||(h==1&&g<1.99999)){l.push(f)}}for(var f=l.length-1;f>-1;f--){b.vertices.splice(l[f],1)}for(f=0;f<b.faces.length;f++){if(l.indexOf(b.faces[f][0])!=-1||l.indexOf(b.faces[f][1])!=-1||l.indexOf(b.faces[f][2])!=-1){b.faces.splice(f,1);f-=1}else{for(j=0;j<b.faces[f].length;j++){for(k=l.length-1;k>-1;k--){if(b.faces[f][j]>l[k]){b.faces[f][j]-=1}}}}}return b}function buildBondsList4Molecule(l,i){var o,n,m,b,f,d,h,g;for(f=0;f<i.atoms.length;f++){for(d=f+1;d<i.atoms.length;d++){if(i.atoms[f].label_alt_id!=i.atoms[d].label_alt_id){continue}h=i.atoms[f].xyz;g=i.atoms[d].xyz;o=h[0]-g[0];o*=o;n=h[1]-g[1];n*=n;m=h[2]-g[2];m*=m;b=o+n+m;maxDistance=3.24;if(i.atoms[f].element=="H"||i.atoms[d].element=="H"||i.atoms[f].element=="D"||i.atoms[d].element=="D"){maxDistance=1.6}if(i.atoms[f].element=="S"||i.atoms[d].element=="S"){maxDistance=3.6}if(b<=maxDistance){l.push([i.atoms[f],i.atoms[d],1])}}}}function molmil_UI(b){this.soup=b;this.canvas=b.canvas;this.LM=null;this.RM=null}molmil_UI.prototype.init=function(){var d,g;d=document.createElement("span");d.className="molmil_UI_LB unselectableText";this.LM=g=document.createElement("img");g.className="molmil_UI_LB_icon";g.src=molmil_settings.src+"/icons/molmil.png";g.UI=this;g.onclick=function(){this.UI.showLM(this)};d.appendChild(g);(this.canvas?this.canvas.parentNode:document.body).appendChild(d);d=document.createElement("span");d.className="molmil_UI_RB unselectableText";this.RM=g=document.createElement("div");if(molmilConfigBox.BGCOLOR[0]==0&&molmilConfigBox.BGCOLOR[1]==0&&molmilConfigBox.BGCOLOR[2]==0){g.style.color="white"}g.className="molmil_UI_RB_icon";g.innerHTML="&lt;<br/>&lt;<br/>&lt;";g.UI=this;g.onclick=function(){this.UI.showRM(this)};d.appendChild(g);d.menu=d.pushNode("div");d.menu.style.display="none";d.menu.className="molmil_UI_RM";(this.canvas?this.canvas.parentNode:document.body).appendChild(d);var b=this.canvas;var f=function(l){var h=document.molmil_FSC;if(h!=b){return}var i=window.devicePixelRatio||1;if(!h.isFullScreen){h.renderer.width=h.width=screen.width*i;h.renderer.height=h.height=screen.height*i;h.style.width=screen.width+"px";h.style.height=screen.height+"px";h.isFullScreen=true}else{h.renderer.width=h.width=h.defaultSize[0]*i;h.renderer.height=h.height=h.defaultSize[1]*i;h.style.width=h.defaultSize[0]+"px";h.style.height=h.defaultSize[1]+"px";h.isFullScreen=false;document.molmil_FSC=null}h.renderer.resizeViewPort();h.update=true;h.renderer.render()};document.addEventListener("webkitfullscreenchange",f,false);document.addEventListener("mozfullscreenchange",f,false);document.addEventListener("MSFullscreenChange",f,false);document.addEventListener("fullscreenchange",f,false)};molmil_UI.prototype.deleteEntry=function(b){};molmil_UI.prototype.displayEntry=function(d,b){if(d.ref){displayEntry(this.soup,d.ref,b)}document.body.onmousedown()};molmil_UI.prototype.colorEntry=function(f,b){if(f.ref){if(b==6){var d=[0,0,0];colorEntry(this.soup,f.ref,b,d)}else{colorEntry(this.soup,f.ref,b)}}document.body.onmousedown()};molmil_UI.prototype.showColorMenu=function(g,f){if(g.subMenu){clearTimeout(g.subMenu.TID);g.subMenu.style.display="";return}var l=molmil_dep.findPos(g);var i=g.subMenu=molmil_dep.dcE("div");i.className="contextMenu cM_sub";if(f.inv){i.style.left="auto";i.style.right="10.75em"}var d,h=this;var b=function(m,o,n){d=i.pushNode("div",m);d.className="contextMenu_E";d.UI=h;d.entry=f;d.onclick=o;if(n){d.onmouseover=o;d.next=d.pushNode("span",">")}else{d.addEventListener("touchstart",function(){this.onclick()},false)}};if(f.mtype!=3.1&&f.mtype!=3.2){b("Default",function(){this.UI.colorEntry(f,1)})}if(f.mtype!=3.2){b("Structure",function(){if(f.mtype==3.1){var m=f.ref;m.rgb=molmil_dep.getKeyFromObject(molmilConfigBox.sndStrucInfo,m.sndStruc,molmilConfigBox.sndStrucInfo[1]).slice(0,3);this.UI.soup.renderer.initBuffers();this.UI.soup.renderer.canvas.update=true;document.body.onmousedown()}else{this.UI.colorEntry(f,2)}})}if(f.mtype!=3.1){b("Atom (CPK)",function(){if(f.mtype==3.2){var m=f.ref;for(a=0;a<m.atoms.length;a++){m.atoms[a].rgb=molmil_dep.getKeyFromObject(molmilConfigBox.elementInfo,m.atoms[a].element,molmilConfigBox.elementInfo.DUMMY).slice(0,3)}this.UI.soup.renderer.initBuffers();this.UI.soup.renderer.canvas.update=true;document.body.onmousedown()}else{this.UI.colorEntry(f,3)}})}if(f.mtype==1||f.mtype==2||f.mtype==0.5){b("Group",function(){this.UI.colorEntry(f,4)})}if(f.mtype==1||f.mtype==0.5){b("Chain",function(){this.UI.colorEntry(f,5)})}g.onmouseout=function(){this.subMenu.TID=molmil_dep.asyncStart(function(){this.style.display="none"},[],g.subMenu,100)};g.pushNode(i)};molmil_UI.prototype.showDisplayMenuCM=function(g){var f=this.soup.atomSelection[this.soup.atomSelection.length-1];if(!f){return}if(g.subMenu){clearTimeout(g.subMenu.TID);g.subMenu.style.display="";return}var l=molmil_dep.findPos(g);var i=g.subMenu=molmil_dep.dcE("div");i.className="contextMenu cM_sub";var d,h=this;var b=function(m,o,n){d=i.pushNode("div",m);d.className="contextMenu_E";d.UI=h;d.entry=null;d.onclick=o;if(n){d.onmouseover=o;d.next=d.pushNode("span",">")}else{d.addEventListener("touchstart",function(){this.onclick()},false)}};b("Residue",function(){this.UI.showDisplayMenu(this,{mtype:3,ref:f.molecule})},true);b("Chain",function(){this.UI.showDisplayMenu(this,{mtype:2,ref:f.molecule.chain})},true);g.onmouseout=function(){this.subMenu.TID=molmil_dep.asyncStart(function(){this.style.display="none"},[],g.subMenu,100)};g.pushNode(i)};molmil_UI.prototype.showColorMenuCM=function(g){var f=this.soup.atomSelection[this.soup.atomSelection.length-1];if(!f){return}if(g.subMenu){clearTimeout(g.subMenu.TID);g.subMenu.style.display="";return}var l=molmil_dep.findPos(g);var i=g.subMenu=molmil_dep.dcE("div");i.className="contextMenu cM_sub";var d,h=this;var b=function(m,o,n){d=i.pushNode("div",m);d.className="contextMenu_E";d.UI=h;d.entry=null;d.onclick=o;if(n){d.onmouseover=o;d.next=d.pushNode("span",">")}else{d.addEventListener("touchstart",function(){this.onclick()},false)}};b("Atom",function(){this.UI.showColorMenu(this,{mtype:4,ref:f})},true);b("Residue",function(){this.UI.showColorMenu(this,{mtype:3,ref:f.molecule})},true);b("Residue (cartoon)",function(){this.UI.showColorMenu(this,{mtype:3.1,ref:f.molecule})},true);b("Residue (atoms)",function(){this.UI.showColorMenu(this,{mtype:3.2,ref:f.molecule})},true);b("Chain",function(){this.UI.showColorMenu(this,{mtype:2,ref:f.molecule.chain})},true);g.onmouseout=function(){this.subMenu.TID=molmil_dep.asyncStart(function(){this.style.display="none"},[],g.subMenu,100)};g.pushNode(i)};molmil_UI.prototype.showDisplayMenu=function(g,f){if(g.subMenu){clearTimeout(g.subMenu.TID);g.subMenu.style.display="";return}var m=molmil_dep.findPos(g);var l=g.subMenu=molmil_dep.dcE("div");l.className="contextMenu cM_sub";var d,h=this;if(f.inv){l.style.left="auto";l.style.right="10.75em"}var b=function(n,p,o){d=l.pushNode("div",n);d.className="contextMenu_E";d.UI=h;d.entry=f;d.onclick=p;if(o){d.onmouseover=p;d.next=d.pushNode("span",">")}else{d.addEventListener("touchstart",function(){this.onclick()},false)}};b("None",function(){this.UI.displayEntry(f,0)});if(f.mtype!=3){b("Default",function(){this.UI.displayEntry(f,1)})}if(f.mtype!=10){if(f.mtype==3&&(f.ref.ligand||f.ref.water)){b("Space fill",function(){this.UI.displayEntry(f,2)});b("Ball & stick",function(){this.UI.displayEntry(f,3)});b("Stick",function(){this.UI.displayEntry(f,4)});b("Wireframe",function(){this.UI.displayEntry(f,5)})}else{var i=function(n,s){if(n.subMenu){clearTimeout(n.subMenu.TID);n.subMenu.style.display="";return}var t=molmil_dep.findPos(n);var q=n.subMenu=molmil_dep.dcE("div");q.className="contextMenu cM_sub";var p;var o=function(u,x,w){p=q.pushNode("div",u);p.className="contextMenu_E";p.UI=h;p.entry=f;p.onclick=x;if(w){p.onmouseover=x;p.next=p.pushNode("span",">")}else{p.addEventListener("touchstart",function(){this.onclick()},false)}};o("Space fill",function(){this.UI.displayEntry(f,s==1?2:2.5)});o("Ball & stick",function(){this.UI.displayEntry(f,s==1?3:3.5)});o("Stick",function(){this.UI.displayEntry(f,s==1?4:4.5)});o("Wireframe",function(){this.UI.displayEntry(f,s==1?5:5.5)});n.onmouseout=function(){this.subMenu.TID=molmil_dep.asyncStart(function(){this.style.display="none"},[],n.subMenu,100)};n.pushNode(q)};b("Amino acid",function(){i(this,1)},true);b("Side chain",function(){i(this,2)},true)}if(f.mtype<3){b("Ca trace",function(){this.UI.displayEntry(f,6)});b("Tube",function(){this.UI.displayEntry(f,7)});b("Cartoon",function(){this.UI.displayEntry(f,8)})}}g.onmouseout=function(){this.subMenu.TID=molmil_dep.asyncStart(function(){this.style.display="none"},[],g.subMenu,100)};g.pushNode(l)};molmil_UI.prototype.showContextMenuAtom=function(m,l){if(document.body.onmousedown){document.body.onmousedown()}var i=this.soup.atomSelection[this.soup.atomSelection.length-1];if(!i){return}var n=0;var o=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth;if(o<m+(molmil_dep.fontSize*12)){n=(m+(molmil_dep.fontSize*12))-o}var d=molmil_dep.dcE("div");d.className="contextMenu";d.style.left=m-n+"px";d.style.top=l+"px";var h=i.molecule.atoms.length>1;var f=d.pushNode("div",(h?i.atomName:i.element)+" - "+(h?(i.molecule.name||"")+" ":"")+(i.molecule.RSID||"")+(i.molecule.chain.name?" - Chain "+i.molecule.chain.name:""));d.pushNode("HR");var g=this;var b=function(p,s,q){item=d.pushNode("div",p);if(!item.pushNode){return}item.className="contextMenu_E";item.UI=g;item.entry=null;item.onclick=s;if(q){item.onmouseover=s;item.next=item.pushNode("span",">")}else{item.addEventListener("touchstart",function(){this.onclick()},false)}};b("Display",function(){this.UI.showDisplayMenuCM(this)},true);b("Color",function(){this.UI.showColorMenuCM(this)},true);document.body.pushNode(d);document.body.onmousedown=function(q){if(q&&q.target.className.indexOf("contextMenu_E")!=-1){return}var p=document.getElementsByClassName("contextMenu");for(var s=0;s<p.length;s++){p[s].parentNode.removeChild(p[s])}p=document.getElementsByClassName("contextMenu_E_sel")[0];document.body.onmousedown=null};return false};molmil_UI.prototype.showCM=function(h,f){if(document.body.onmousedown){document.body.onmousedown()}var m=0;var l=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth;if(l<h.pageX+(molmil_dep.fontSize*12)){m=(h.pageX+(molmil_dep.fontSize*12))-l}f.inv=l<h.pageX+(molmil_dep.fontSize*30);var i=molmil_dep.dcE("div");i.className="contextMenu";i.style.left=h.pageX-m+"px";i.style.top=h.pageY+"px";var d,g=this;f.setClass("contextMenu_E_sel");var b=function(n,p,o){d=i.pushNode("div",n);d.className="contextMenu_E";d.UI=g;d.entry=f;d.onclick=p;if(o){d.onmouseover=p;d.next=d.pushNode("span",">")}else{d.addEventListener("touchstart",function(){this.onclick()},false)}};if(f.mtype==0.5||f.mtype==1){if(this.soup.hideWaters){b("Show waters",function(){this.UI.toggleWaters(1)})}else{b("Hide waters",function(){this.UI.toggleWaters(0)})}if(this.soup.hideHydrogens){b("Show hydrogens",function(){this.UI.toggleHydrogens(1)})}else{b("Hide hydrogens",function(){this.UI.toggleHydrogens(0)})}}b("Display",function(){this.UI.showDisplayMenu(this,f)},true);if(f.mtype!=10){b("Color",function(){this.UI.showColorMenu(this,f)},true)}document.body.pushNode(i);document.body.onmousedown=function(o){if(o&&o.target.className.indexOf("contextMenu_E")!=-1){return}var n=document.getElementsByClassName("contextMenu");for(var p=0;p<n.length;p++){n[p].parentNode.removeChild(n[p])}n=document.getElementsByClassName("contextMenu_E_sel")[0];if(n){f.removeClass("contextMenu_E_sel")}document.body.onmousedown=null};try{h.preventDefault()}catch(h){}return false};function setOnContextMenu(d,b){d.oncontextmenu=b;d.addEventListener("touchstart",handle_contextMenu_touchStart,false);d.addEventListener("touchend",handle_contextMenu_touchEnd,false)}function handle_contextMenu_touchStart(b){previousTouchEvent=b;longTouchTID=setTimeout(handle_contextMenu_touchHold,500);b.preventDefault()}function handle_contextMenu_touchHold(){if(!longTouchTID){return}longTouchTID=null;previousTouchEvent.touches[0].target.oncontextmenu(previousTouchEvent.touches[0]);previousTouchEvent=null}function handle_contextMenu_touchEnd(b){if(previousTouchEvent){previousTouchEvent.touches[0].target.onclick()}longTouchTID=null;clearTimeout(longTouchTID)}molmil_UI.prototype.showRM=function(g){var m=g.parentNode.menu;if(m.style.display=="none"){g.innerHTML="&gt;<br/>&gt;<br/>&gt;";m.style.maxHeight=((this.canvas?this.canvas:document.body)-32)+"px";m.style.display=""}else{g.innerHTML="&lt;<br/>&lt;<br/>&lt;";m.style.display="none"}if(m.childNodes.length==0){m.pushNode("span","Structures:").className="optCat_k";m.pushNode("hr");var b,l,f;var h=this.canvas?this.canvas.pdbjViewer.files:[];for(var d=0;d<h.length;d++){f=h[d];if(f.models){l=m.pushNode("div");l.plus=l.pushNode("a","+");l.plus.className="optCat_p";l.name=l.pushNode("a",f.id);l.name.className="optCat_n";l.plus.onclick=l.name.onclick=molmil_dep.expandCatTree;l.name.UI=l.UI=this;setOnContextMenu(l.name,function(i){this.UI.showCM(i,this)});if(f.models.length>1){l.name.mtype=0.5;l.name.ref=f.models;l.payload=f.models;l.expandFunc=this.showModels}else{l.name.mtype=1;l.name.ref=f.models[0];l.payload=f.models[0];l.expandFunc=this.showChains}}else{l=m.pushNode("div",f.filename);l.className="optCat_n";l.style.marginLeft="1.25em";l.UI=this;setOnContextMenu(l,function(i){this.UI.showCM(i,this)});l.mtype=10;l.ref=f.polygon}}}};molmil_UI.prototype.showModels=function(h,g){var b,f;h.pushNode("span","Models:").className="optCat_k";h.pushNode("hr");for(var d=0;d<g.length;d++){b=g[d];f=h.pushNode("div");f.plus=f.pushNode("a","+");f.plus.className="optCat_p";f.name=f.pushNode("a",d+1);f.name.className="optCat_n";f.plus.onclick=f.name.onclick=molmil_dep.expandCatTree;f.payload=b;f.name.UI=f.UI=this.UI;f.expandFunc=this.UI.showChains;setOnContextMenu(f.name,function(i){this.UI.showCM(i,this)});f.name.mtype=1;f.name.ref=b}};molmil_UI.prototype.showChains=function(h,g){var d,f;h.pushNode("span","Chains:").className="optCat_k";h.pushNode("hr");for(var b=0;b<g.chains.length;b++){d=g.chains[b];f=h.pushNode("div");f.plus=f.pushNode("a","+");f.plus.className="optCat_p";f.name=f.pushNode("a",d.name?d.name:b+1);f.name.className="optCat_n";f.plus.onclick=f.name.onclick=molmil_dep.expandCatTree;f.payload=d;f.name.UI=f.UI=this.UI;f.expandFunc=this.UI.showResidues;setOnContextMenu(f.name,function(i){this.UI.showCM(i,this)});f.name.mtype=2;f.name.ref=d}h.pushNode("hr")};molmil_UI.prototype.showResidues=function(h,g){h.pushNode("span","Residues/Ligands:").className="optCat_k";h.pushNode("hr");var f,d;for(var b=0;b<g.molecules.length;b++){f=g.molecules[b];d=h.pushNode("div",f.name+(f.id?" ("+f.id+")":""));d.className="optCat_n";d.payload=f;d.UI=this.UI;setOnContextMenu(d,function(i){this.UI.showCM(i,this)});d.mtype=3;d.ref=f;d.ondblclick=function(){this.UI.canvas.pdbjViewer.gotoMol(this.payload)}}h.pushNode("hr")};molmil_UI.prototype.showLM=function(b){try{if(b.parentNode.childNodes.length>1){b.parentNode.removeChild(b.nextSibling);b.parentNode.removeChild(b.nextSibling);return}}catch(d){}var f=document.createElement("div"),d;f.className="molmil_UI_LM";d=f.appendChild(document.createElement("div"));d.menu=f;d.UI=this;d.className="molmil_UI_ME";d.innerHTML="Open >";d.onclick=function(){molmil_dep.Clear(this.menu.sub);var g;this.menu.sub.style.display="";if(!molmil_dep.dBT.ios_version){g=this.menu.sub.pushNode("div","mmCIF (local)","molmil_UI_ME");g.UI=this.UI;g.onclick=function(){this.UI.open("mmCIF",2)};g=this.menu.sub.pushNode("div","PDBML (local)","molmil_UI_ME");g.UI=this.UI;g.onclick=function(){this.UI.open("PDBML",3)};g=this.menu.sub.pushNode("div","mmJSON (local)","molmil_UI_ME");g.UI=this.UI;g.onclick=function(){this.UI.open("mmJSON",1)};g=this.menu.sub.pushNode("div","PDB (flat) (local)","molmil_UI_ME");g.UI=this.UI;g.onclick=function(){this.UI.open("PDB (flat)",4)};g=this.menu.sub.pushNode("div","Polygon XML file (local)","molmil_UI_ME");g.UI=this.UI;g.onclick=function(){this.UI.open("Polygon XML file",5)};this.menu.sub.pushNode("hr")}g=this.menu.sub.pushNode("div","PDB (PDBj)","molmil_UI_ME");g.UI=this.UI;g.onclick=function(){this.UI.openID(1)};g=this.menu.sub.pushNode("div","PDB chem_comp (PDBj)","molmil_UI_ME");g.UI=this.UI;g.onclick=function(){this.UI.openID(2)};g=this.menu.sub.pushNode("div","Promode Elastic (PDBj)","molmil_UI_ME");g.UI=this.UI;g.onclick=function(){this.UI.openPMEID()}};d=f.appendChild(document.createElement("div"));d.menu=f;d.UI=this;d.className="molmil_UI_ME";d.innerHTML="Save >";d.onclick=function(){molmil_dep.Clear(this.menu.sub);var g;this.menu.sub.style.display="";g=this.menu.sub.pushNode("div","PNG","molmil_UI_ME");g.UI=this.UI;g.onclick=function(){this.UI.savePNG()}};f.pushNode("hr");d=f.appendChild(document.createElement("div"));d.UI=this;d.LM=b;d.className="molmil_UI_ME";d.innerHTML="Settings";d.onclick=function(){this.LM.onclick();this.UI.settings()};if(this.soup.trajectory.length>1||this.soup.models.length>1){d=f.appendChild(document.createElement("div"));d.menu=f;d.UI=this;d.className="molmil_UI_ME";d.innerHTML="Animation";d.canvas=this.canvas;d.LM=b;d.onclick=function(){this.UI.animationPopUp();this.LM.onclick()};f.pushNode("hr")}if(!molmil_dep.dBT.ios_version){d=f.pushNode("div");d.className="molmil_UI_ME";d.innerHTML="Enable full-screen";d.canvas=this.canvas;d.LM=b;d.onclick=function(){var g=this.canvas.requestFullScreen||this.canvas.webkitRequestFullScreen||this.canvas.mozRequestFullScreen||this.canvas.msRequestFullscreen||null;if(g){document.molmil_FSC=this.canvas;g.call(this.canvas)}this.LM.onclick()}}d=f.appendChild(document.createElement("div"));d.UI=this;d.className="molmil_UI_ME";d.innerHTML="Clear";d.onclick=function(){this.UI.clear()};f.pushNode("hr");d=f.appendChild(document.createElement("div"));d.UI=this;d.className="molmil_UI_ME";d.innerHTML="Help";d.LM=b;d.onclick=function(){window.open("http://pdbj.org/help/molmil");this.LM.onclick()};b.parentNode.appendChild(f);f.sub=b.parentNode.appendChild(document.createElement("div"));f.sub.className="molmil_UI_LM";f.sub.style.display="none"};molmil_UI.prototype.settings=function(){var b=molmil_dep.dcE("div");b.setClass("molmil_menu_popup");b.pushNode("div","Settings");b.pushNode("hr");var g=molmil_dep.dcE("button"),d;g.qlv=molmil_dep.dcE("input");g.qlv.type="range";g.qlv.min="0";g.qlv.max="4";g.qlv.step="1";g.qlv.value=localStorage.getItem("molmil_settings_QLV");g.qlv.ref=molmil_dep.dcE("span");g.qlv.ref.innerHTML=g.qlv.value;g.qlv.onmousemove=function(){this.ref.innerHTML=this.value};g.fog=molmil_dep.dcE("input");g.fog.type="checkbox";g.fog.checked=localStorage.getItem("molmil_settings_glsl_fog")==1;g.projectionMode=molmil_dep.dcE("select");d=g.projectionMode.pushNode("option","Perspective projection");d.value=1;d=g.projectionMode.pushNode("option","Orthographic projection");d.value=2;if(molmilConfigBox.projectionMode==2){d.selected=true}g.colorMode=molmil_dep.dcE("select");d=g.colorMode.pushNode("option","Rasmol");d.value=1;d=g.colorMode.pushNode("option","Jmol");d.value=2;if(localStorage.getItem("molmil_settings_COLORS")==2){d.selected=true}d=g.colorMode.pushNode("option","Basic");d.value=3;if(localStorage.getItem("molmil_settings_COLORS")==3){d.selected=true}g.bgcolor=molmil_dep.dcE("span");g.bgcolor.pushNode("span","R: ");g.bgcolor.R=g.bgcolor.pushNode("input");g.bgcolor.pushNode("span"," G: ");g.bgcolor.G=g.bgcolor.pushNode("input");g.bgcolor.pushNode("span"," B: ");g.bgcolor.B=g.bgcolor.pushNode("input");g.bgcolor.pushNode("span"," A: ");g.bgcolor.A=g.bgcolor.pushNode("input");g.bgcolor.R.style.width=g.bgcolor.G.style.width=g.bgcolor.B.style.width=g.bgcolor.A.style.width="2.5em";g.bgcolor.R.value=Math.round(molmilConfigBox.BGCOLOR[0]*255);g.bgcolor.G.value=Math.round(molmilConfigBox.BGCOLOR[1]*255);g.bgcolor.B.value=Math.round(molmilConfigBox.BGCOLOR[2]*255);g.bgcolor.A.value=Math.round(molmilConfigBox.BGCOLOR[3]*255);var h=b.pushNode("table"),f,d;f=h.pushNode("tr");f.pushNode("td","Quality:");d=molmil_dep.dcE("div");d.pushNode(g.qlv);d.pushNode(g.qlv.ref);f.pushNode("td").pushNode(d);f=h.pushNode("tr");f.pushNode("td","Fog:");d=molmil_dep.dcE("div");d.pushNode(g.fog);f.pushNode("td").pushNode(d);f=h.pushNode("tr");f.pushNode("td","Projection mode:");f.pushNode("td").pushNode(g.projectionMode);f=h.pushNode("tr");f.pushNode("td","Color scheme*:");f.pushNode("td").pushNode(g.colorMode);f.title="Atom (CPK) colors need to be manually re-applied to become effective";f=h.pushNode("tr");f.pushNode("td","BG color:");f.pushNode("td").pushNode(g.bgcolor);b.pushNode("hr");g.innerHTML="Apply";g.UI=this;g.popup=b;g.onclick=function(){localStorage.setItem("molmil_settings_QLV",this.qlv.value);localStorage.setItem("molmil_settings_glsl_fog",(molmilConfigBox.glsl_fog=this.fog.checked)?"1":"0");localStorage.setItem("molmil_settings_PROJECTION",this.projectionMode.value);localStorage.setItem("molmil_settings_COLORS",this.colorMode.value);localStorage.setItem("molmil_settings_BGCOLOR",JSON.stringify([parseFloat(this.bgcolor.R.value)/255,parseFloat(this.bgcolor.G.value)/255,parseFloat(this.bgcolor.B.value)/255,parseFloat(this.bgcolor.A.value)/255]));initSettings();this.UI.soup.reloadSettings();molmilConfigBox.projectionMode=this.projectionMode.value;this.UI.soup.renderer.resizeViewPort();this.UI.soup.renderer.initShaders(molmilConfigBox.glsl_shaders);this.UI.soup.renderer.initBuffers();this.UI.soup.canvas.update=true;this.popup.parentNode.removeChild(this.popup)};b.pushNode(g);this.LM.parentNode.pushNode(b)};molmil_UI.prototype.toggleWaters=function(b){this.soup.waterToggle(b);this.soup.renderer.initBuffers();this.soup.canvas.update=true;document.body.onmousedown()};molmil_UI.prototype.toggleHydrogens=function(b){this.soup.hydrogenToggle(b);this.soup.renderer.initBuffers();this.soup.canvas.update=true;document.body.onmousedown()};molmil_UI.prototype.animationPopUp=function(){var b=molmil_dep.dcE("div");b.setClass("molmil_menu_popup");b.pushNode("div","Animation controls");b.pushNode("hr");b.pushNode("span","Motion:");label=b.pushNode("label");inp=label.pushNode("input");inp.type="radio";inp.name="motion";if(this.soup.animation.motionMode==1){inp.checked=true}label.pushNode("span","Forward");label.AI=this.soup.animation;label.onclick=function(){this.AI.motionMode=1};label=b.pushNode("label");inp=label.pushNode("input");inp.type="radio";inp.name="motion";if(this.soup.animation.motionMode==2){inp.checked=true}label.pushNode("span","Backward");label.AI=this.soup.animation;label.onclick=function(){this.AI.motionMode=2};label=b.pushNode("label");inp=label.pushNode("input");inp.type="radio";inp.name="motion";if(this.soup.animation.motionMode==3){inp.checked=true}label.pushNode("span","Swing");label.AI=this.soup.animation;label.onclick=function(){this.AI.motionMode=3};b.pushNode("br");label=b.pushNode("div");label.setClass("unselectableText");label.style.fontStyle="normal";label.style.textAlign="center";inp=label.pushNode("span","|&#8920;");inp.setClass("smallButton");inp.AI=this.soup.animation;inp.onclick=function(){this.AI.beginning()};inp=label.pushNode("span","<");inp.setClass("smallButton");inp.AI=this.soup.animation;inp.onclick=function(){this.AI.previous()};inp=label.pushNode("span","ll");inp.setClass("smallButton");inp.AI=this.soup.animation;inp.onclick=function(){this.AI.pause()};inp=label.pushNode("span","&#9658;");inp.setClass("smallButton");inp.AI=this.soup.animation;inp.onclick=function(){this.AI.play()};inp=label.pushNode("span",">");inp.setClass("smallButton");inp.AI=this.soup.animation;inp.onclick=function(){this.AI.next()};inp=label.pushNode("span","&#8921;|");inp.setClass("smallButton");inp.AI=this.soup.animation;inp.onclick=function(){this.AI.end()};b.close=b.pushNode("button","Close");b.close.style.display="block";b.close.style.marginLeft=b.close.style.marginRight="auto";b.close.onclick=function(){this.popup.parentNode.removeChild(this.popup)};b.close.popup=b;this.LM.parentNode.pushNode(b)};molmil_UI.prototype.resetRM=function(){try{molmil_dep.Clear(this.RM.parentNode.menu);if(this.RM.parentNode.menu.style.display!="none"){this.showRM(this.RM)}}catch(b){}};molmil_UI.prototype.clear=function(){if(this.LM&&this.LM.parentNode.childNodes.length>1){this.LM.onclick()}var b=molmil_dep.dcE("div");b.setClass("molmil_menu_popup");b.pushNode("div","Do you want to clear all loaded structures?");b.yes=b.pushNode("button","Yes");b.yes.canvas=this.canvas;b.yes.UI=this;b.yes.onclick=function(){if(this.canvas){this.canvas.pdbjViewer.clear();this.canvas.renderer.initBuffers();this.canvas.renderer.camera.reset();this.canvas.update=true}this.UI.resetRM();b.cancel.onclick()};b.cancel=b.pushNode("button","Cancel");b.cancel.onclick=function(){this.popup.parentNode.removeChild(this.popup)};b.cancel.popup=b;this.LM.parentNode.pushNode(b)};molmil_UI.prototype.open=function(g,i,d,m,l){if(this.LM&&this.LM.parentNode.childNodes.length>1){this.LM.onclick()}var f=this.soup;var h=this;var b=molmil_dep.dcE("div");b.setClass("molmil_menu_popup");b.pushNode("div","Open "+g+" file: ");b.inp=b.pushNode("input");b.inp.type="file";b.load=b.pushNode("button","Load");b.load.fileFormat=i;b.settings={};b.load.onclick=function(){if(!b.inp.files.length){return}var n=new FileReader();n.fileFormat=this.fileFormat;n.filename=b.inp.files[0].name;n.onload=function(o){if(this.fileFormat){f.loadStructureData(o.target.result,this.fileFormat,this.filename,function(p,q){h.resetRM();if(d){d(p,q)}else{displayModels(p,q,p.AID>100000?5:1,true);colorModels(p,q,1)}},b.settings)}else{d(this.filename,o.target.result)}m=null;b.cancel.onclick()};if(l){n.readAsArrayBuffer(b.inp.files[0])}else{n.readAsText(b.inp.files[0])}};b.cancel=b.pushNode("button","Cancel");b.cancel.onclick=function(){this.popup.parentNode.removeChild(this.popup);if(m){m()}};b.cancel.popup=b;if(this.LM){this.LM.parentNode.pushNode(b)}return b};molmil_UI.prototype.openPMEID=function(){if(this.LM&&this.LM.parentNode.childNodes.length>1){this.LM.onclick()}var f=this;var b=molmil_dep.dcE("div");b.setClass("molmil_menu_popup");b.pushNode("div","Promode Elastic");b.pushNode("hr");b.pushNode("span","Display: ");b.dpm1=b.pushNode("label");b.dpm1.inp=b.dpm1.pushNode("input");b.dpm1.inp.type="radio";b.dpm1.inp.name="displayMode";b.dpm1.pushNode("span","Displacement vectors");b.dpm1.inp.checked=true;b.pushNode("br");b.dpm2=b.pushNode("label");b.dpm2.inp=b.dpm2.pushNode("input");b.dpm2.inp.type="radio";b.dpm2.inp.name="displayMode";b.dpm2.pushNode("span","Animation");b.pushNode("br");b.pushNode("span","Mode:").style.paddingRight="1.125em";b.mode=b.pushNode("select");b.mode.style.width="10em";for(var d=0;d<10;d++){b.mode.pushNode("option",d+1)}b.pushNode("br");b.pushNode("span","PDB ID: ");b.inp=b.pushNode("input");b.inp.type="text";b.inp.style.width="10em";b.inp.onkeyup=function(g){if(g.keyCode==13){this.load.onclick()}else{if(g.keyCode==27){this.cancel.onclick()}}};b.pushNode("br");b.pushNode("span","Variant:").style.paddingRight=".25em";b.sel=b.pushNode("select");b.sel.style.width="10em";b.pushNode("br");b.inp.load=b.load=b.pushNode("button","Load");b.load.canvas=this.canvas;b.load.inpBuf=null;b.load.doLoad=function(h){h=h||b.sel.childNodes[b.sel.selectedIndex].innerHTML;var g=b.mode.childNodes[b.mode.selectedIndex].innerHTML;if(b.dpm1.inp.checked){this.canvas.pdbjViewer.loadStructure(molmil_settings.promodeE_base_structure_url.replace("__ID__",h),4);this.canvas.pdbjViewer.loadStructure(molmil_settings.promodeE_mode_vectors_url.replace("__ID__",h).replace("__MODE__",g),5)}else{this.canvas.pdbjViewer.loadStructure(molmil_settings.promodeE_animation_url.replace("__ID__",h).replace("__MODE__",g),4,function(i,l){displayModels(i,l,i.AID>100000?5:1,true);colorModels(i,l,1,true);i.animation.motionMode=3;i.animation.play()})}b.cancel.onclick()};b.load.onclick=function(){if(b.inp.value!=this.inpBuf){this.inpBuf=b.inp.value;var g=new molmil_dep.CallRemote("GET");g.ASYNC=true;g.OnDone=function(){molmil_dep.Clear(b.sel);var h=JSON.parse(this.request.responseText);if(h.length==1){return b.load.doLoad(h[0][2])}for(var l=0;l<h.length;l++){b.sel.pushNode("option",h[l][2])}};g.Send(molmil_settings.promodeE_check_url.replace("__ID__",this.inpBuf))}else{if(b.sel.length){b.load.doLoad()}}};b.inp.cancel=b.cancel=b.pushNode("button","Cancel");b.cancel.onclick=function(){this.popup.parentNode.removeChild(this.popup)};b.cancel.popup=b;this.LM.parentNode.pushNode(b);b.inp.focus()};molmil_UI.prototype.openID=function(b){if(this.LM&&this.LM.parentNode.childNodes.length>1){this.LM.onclick()}var h,f;if(b==1){h="PDB ID";f=molmil_settings.pdb_url}else{if(b==2){h="Comp ID";f=molmil_settings.comp_url}else{return}}var g=this;var d=molmil_dep.dcE("div");d.setClass("molmil_menu_popup");d.pushNode("span",h+": ");d.inp=d.pushNode("input");d.inp.type="text";d.inp.onkeyup=function(i){if(i.keyCode==13){this.load.onclick()}else{if(i.keyCode==27){this.cancel.onclick()}}};d.inp.load=d.load=d.pushNode("button","Load");d.load.canvas=this.canvas;d.load.url=f;d.load.onclick=function(){if(!d.inp.value){return}this.canvas.pdbjViewer.loadStructure(this.url.replace("__ID__",d.inp.value),1,function(m,n){for(var l=1;l<n.length;l++){n[l].display=false}displayModels(m,n,m.AID>100000?5:1,true);colorModels(m,n,1);g.resetRM()});d.cancel.onclick()};d.inp.cancel=d.cancel=d.pushNode("button","Cancel");d.cancel.onclick=function(){this.popup.parentNode.removeChild(this.popup)};d.cancel.popup=d;this.LM.parentNode.pushNode(d);d.inp.focus()};molmil_UI.prototype.savePNG=function(){if(this.LM&&this.LM.parentNode.childNodes.length>1){this.LM.onclick()}var b=molmil_dep.dcE("div");b.setClass("molmil_menu_popup");b.pushNode("span"," ");b.range=b.pushNode("input");b.range.type="range";b.range.min="0.25";b.range.max="4";b.range.step=".25";b.range.value="1.0";b.range.onmousemove=function(){this.nfo.innerHTML=(this.canvas.width*this.value)+"px x "+(this.canvas.height*this.value)+"px"};b.range.nfo=b.pushNode("span");b.range.nfo.style.display="inline-block";b.save=b.pushNode("button","Save");b.range.canvas=b.save.canvas=this.canvas;b.save.onclick=function(){var h=parseInt(b.range.value);if(h!=1){var g=this.canvas.width;var d=this.canvas.height;var f=molmilConfigBox.BGCOLOR[3];this.canvas.width*=h;this.canvas.height*=h;this.canvas.renderer.selectDataContext();this.canvas.renderer.resizeViewPort();this.canvas.update=true;this.canvas.renderer.render();this.canvas.toBlob(function(i){saveAs(i,"image.png")});this.canvas.renderer.selectDefaultContext();this.canvas.width=g;this.canvas.height=d;this.canvas.renderer.resizeViewPort();this.canvas.update=true;this.canvas.renderer.render()}else{var f=molmilConfigBox.BGCOLOR[3];this.canvas.renderer.selectDataContext();this.canvas.update=true;this.canvas.renderer.render();this.canvas.toBlob(function(i){saveAs(i,"image.png")});this.canvas.renderer.selectDefaultContext();this.canvas.update=true;this.canvas.renderer.render()}b.cancel.onclick()};b.cancel=b.pushNode("button","Cancel");b.cancel.onclick=function(){this.popup.parentNode.removeChild(this.popup)};b.cancel.popup=b;b.range.onmousemove();this.LM.parentNode.pushNode(b)};function toggleEntry(h,l,f,n){var b,d,i,g=molmilConfigBox.backboneAtoms4Display;if(l instanceof modelObject){for(b=0;b<l.molecules.length;b++){i=l.molecules[b];if(!i.ligand&&!i.water){for(d=0;d<i.atoms.length;d++){i.atoms[d].status=f}}i.status=f}}else{if(l instanceof chainObject){for(b=0;b<l.molecules.length;b++){i=l.molecules[b];for(d=0;d<i.atoms.length;d++){i.atoms[d].status=f}i.status=f}}else{if(l instanceof molObject){for(d=0;d<l.atoms.length;d++){l.atoms[d].status=f}l.status=f}else{if(l instanceof atomObject){l.status=false}else{if(l instanceof polygonObject){l.display=f}else{return}}}}}if(!n){h.renderer.initBuffers();h.renderer.canvas.update=true}}function displayEntry(n,g,l,o){if(g instanceof Array){for(var h=0;h<g.length;h++){displayEntry(n,g[h],l,false)}if(!o){n.renderer.initBuffers();n.renderer.canvas.update=true}return}var b,q,f,p=molmilConfigBox.backboneAtoms4Display,d=molmilConfigBox.xna_simple_base_atoms;if(g instanceof modelObject){if(l==0){for(var q=0;q<g.atoms.length;q++){g.atoms[q].displayMode=0}for(var b=0;b<g.molecules.length;b++){g.molecules[b].displayMode=0}}else{if(l==1){for(b=0;b<g.molecules.length;b++){f=g.molecules[b];if(f.ligand||f.water){for(q=0;q<f.atoms.length;q++){f.atoms[q].displayMode=3}}else{if(f.xna){for(q=0;q<f.atoms.length;q++){f.atoms[q].displayMode=d.hasOwnProperty(f.atoms[q].atomName)||f.atoms[q].element=="H"?0:3}}else{for(q=0;q<f.atoms.length;q++){f.atoms[q].displayMode=0}}}f.displayMode=3}}else{if(l==2){for(var q=0;q<g.atoms.length;q++){g.atoms[q].displayMode=1}for(var b=0;b<g.molecules.length;b++){g.molecules[b].displayMode=0}}else{if(l==2.5){for(var q=0;q<g.atoms.length;q++){if(!g.atoms[q].molecule.ligand&&!g.atoms[q].molecule.water&&p.hasOwnProperty(g.atoms[q].atomName)){g.atoms[q].displayMode=0}else{g.atoms[q].displayMode=1}}}else{if(l==3){for(var q=0;q<g.atoms.length;q++){g.atoms[q].displayMode=2}for(var b=0;b<g.molecules.length;b++){g.molecules[b].displayMode=0}}else{if(l==3.5){for(var q=0;q<g.atoms.length;q++){if(!g.atoms[q].molecule.ligand&&!g.atoms[q].molecule.water&&p.hasOwnProperty(g.atoms[q].atomName)){g.atoms[q].displayMode=0}else{g.atoms[q].displayMode=2}}}else{if(l==4){for(var q=0;q<g.atoms.length;q++){g.atoms[q].displayMode=3}for(var b=0;b<g.molecules.length;b++){g.molecules[b].displayMode=0}}else{if(l==4.5){for(var q=0;q<g.atoms.length;q++){if(!g.atoms[q].molecule.ligand&&!g.atoms[q].molecule.water&&p.hasOwnProperty(g.atoms[q].atomName)){g.atoms[q].displayMode=0}else{g.atoms[q].displayMode=3}}}else{if(l==5){for(var q=0;q<g.atoms.length;q++){g.atoms[q].displayMode=4}for(var b=0;b<g.molecules.length;b++){g.molecules[b].displayMode=0}}else{if(l==5.5){for(var q=0;q<g.atoms.length;q++){if(!g.atoms[q].molecule.ligand&&!g.atoms[q].molecule.water&&p.hasOwnProperty(g.atoms[q].atomName)){g.atoms[q].displayMode=0}else{g.atoms[q].displayMode=4}}}else{if(l==6){for(b=0;b<g.molecules.length;b++){f=g.molecules[b];if(!f.ligand&&!f.water){for(q=0;q<f.atoms.length;q++){f.atoms[q].displayMode=0}}f.displayMode=1}}else{if(l==7){for(b=0;b<g.molecules.length;b++){f=g.molecules[b];if(!f.ligand&&!f.water){for(q=0;q<f.atoms.length;q++){f.atoms[q].displayMode=0}}f.displayMode=2}}else{if(l==8){for(b=0;b<g.molecules.length;b++){f=g.molecules[b];if(!f.ligand&&!f.water){for(q=0;q<f.atoms.length;q++){f.atoms[q].displayMode=0}}f.displayMode=3}}}}}}}}}}}}}}}else{if(g instanceof chainObject){if(l==0){for(b=0;b<g.molecules.length;b++){f=g.molecules[b];f.displayMode=0;for(q=0;q<f.atoms.length;q++){f.atoms[q].displayMode=0}}}else{if(l==1){for(b=0;b<g.molecules.length;b++){f=g.molecules[b];if(f.ligand&&!f.water){for(q=0;q<f.atoms.length;q++){f.atoms[q].displayMode=3}}else{if(f.xna){for(q=0;q<f.atoms.length;q++){f.atoms[q].displayMode=d.hasOwnProperty(f.atoms[q].atomName)||f.atoms[q].element=="H"?0:3}}else{for(q=0;q<f.atoms.length;q++){f.atoms[q].displayMode=0}}}f.displayMode=3}}else{if(l==2){for(b=0;b<g.molecules.length;b++){f=g.molecules[b];f.displayMode=0;for(q=0;q<f.atoms.length;q++){f.atoms[q].displayMode=1}}}else{if(l==2.5){for(b=0;b<g.molecules.length;b++){f=g.molecules[b];for(q=0;q<f.atoms.length;q++){if(!f.ligand&&!f.water&&p.hasOwnProperty(f.atoms[q].atomName)){f.atoms[q].displayMode=0}else{f.atoms[q].displayMode=1}}}}else{if(l==3){for(b=0;b<g.molecules.length;b++){f=g.molecules[b];f.displayMode=0;for(q=0;q<f.atoms.length;q++){f.atoms[q].displayMode=2}}}else{if(l==3.5){for(b=0;b<g.molecules.length;b++){f=g.molecules[b];for(q=0;q<f.atoms.length;q++){if(!f.ligand&&!f.water&&p.hasOwnProperty(f.atoms[q].atomName)){f.atoms[q].displayMode=0}else{f.atoms[q].displayMode=2}}}}else{if(l==4){for(b=0;b<g.molecules.length;b++){f=g.molecules[b];f.displayMode=0;for(q=0;q<f.atoms.length;q++){f.atoms[q].displayMode=3}}}else{if(l==4.5){for(b=0;b<g.molecules.length;b++){f=g.molecules[b];for(q=0;q<f.atoms.length;q++){if(!f.ligand&&!f.water&&p.hasOwnProperty(f.atoms[q].atomName)){f.atoms[q].displayMode=0}else{f.atoms[q].displayMode=3}}}}else{if(l==5){for(b=0;b<g.molecules.length;b++){f=g.molecules[b];f.displayMode=0;for(q=0;q<f.atoms.length;q++){f.atoms[q].displayMode=4}}}else{if(l==5.5){for(b=0;b<g.molecules.length;b++){f=g.molecules[b];for(q=0;q<f.atoms.length;q++){if(!f.ligand&&!f.water&&p.hasOwnProperty(f.atoms[q].atomName)){f.atoms[q].displayMode=0}else{f.atoms[q].displayMode=4}}}}else{if(l==6){for(b=0;b<g.molecules.length;b++){f=g.molecules[b];if(!f.ligand&&!f.water){for(q=0;q<f.atoms.length;q++){f.atoms[q].displayMode=0}}f.displayMode=1}}else{if(l==7){for(b=0;b<g.molecules.length;b++){f=g.molecules[b];if(!f.ligand&&!f.water){for(q=0;q<f.atoms.length;q++){f.atoms[q].displayMode=0}}f.displayMode=2}}else{if(l==8){for(b=0;b<g.molecules.length;b++){f=g.molecules[b];if(!f.ligand&&!f.water){for(q=0;q<f.atoms.length;q++){f.atoms[q].displayMode=0}}f.displayMode=3}}}}}}}}}}}}}}}else{if(g instanceof molObject){if(l==0){for(q=0;q<g.atoms.length;q++){g.atoms[q].displayMode=0}}else{if(l==1){if(g.ligand||g.water){for(q=0;q<g.atoms.length;q++){g.atoms[q].displayMode=3}}else{if(g.xna){for(q=0;q<g.atoms.length;q++){g.atoms[q].displayMode=d.hasOwnProperty(g.atoms[q].atomName)||g.atoms[q].element=="H"?0:3}}else{for(q=0;q<g.atoms.length;q++){g.atoms[q].displayMode=0}}}g.displayMode=3}else{if(l==2){for(q=0;q<g.atoms.length;q++){g.atoms[q].displayMode=1}}else{if(l==2.5){for(q=0;q<g.atoms.length;q++){if(!g.ligand&&!g.water&&p.hasOwnProperty(g.atoms[q].atomName)){g.atoms[q].displayMode=0}else{g.atoms[q].displayMode=1}}}else{if(l==3){for(q=0;q<g.atoms.length;q++){g.atoms[q].displayMode=2}}else{if(l==3.5){for(q=0;q<g.atoms.length;q++){if(!g.ligand&&!g.water&&p.hasOwnProperty(g.atoms[q].atomName)){g.atoms[q].displayMode=0}else{g.atoms[q].displayMode=2}}}else{if(l==4){for(q=0;q<g.atoms.length;q++){g.atoms[q].displayMode=3}}else{if(l==4.5){for(q=0;q<g.atoms.length;q++){if(!g.ligand&&!g.water&&p.hasOwnProperty(g.atoms[q].atomName)){g.atoms[q].displayMode=0}else{g.atoms[q].displayMode=3}}}else{if(l==5){for(q=0;q<g.atoms.length;q++){g.atoms[q].displayMode=4}}else{if(l==5.5){for(q=0;q<g.atoms.length;q++){if(!g.ligand&&!g.water&&p.hasOwnProperty(g.atoms[q].atomName)){g.atoms[q].displayMode=0}else{g.atoms[q].displayMode=4}}}else{if(l==6){if(!g.ligand&&!g.water){for(q=0;q<g.atoms.length;q++){g.atoms[q].displayMode=0}}g.displayMode=1}else{if(l==7){if(!g.ligand&&!g.water){for(q=0;q<g.atoms.length;q++){g.atoms[q].displayMode=0}}g.displayMode=2}else{if(l==8){if(!g.ligand&&!g.water){for(q=0;q<g.atoms.length;q++){g.atoms[q].displayMode=0}}g.displayMode=3}}}}}}}}}}}}}}else{if(g instanceof atomObject){}else{if(g instanceof polygonObject){if(l==0){g.display=false}else{if(l==1){g.display=true}}}else{return}}}}}if(!o){n.renderer.initBuffers();n.renderer.canvas.update=true}}function colorEntry(l,g,s,t,p){if(g instanceof Array){for(var h=0;h<g.length;h++){colorEntry(l,g[h],s,t,true)}if(!p){l.renderer.initBuffers();l.renderer.canvas.update=true}return}var d,q,f,o,b,n;if(g instanceof modelObject){if(s==1){for(d=0;d<g.molecules.length;d++){f=g.molecules[d];f.rgb=molmil_dep.getKeyFromObject(molmilConfigBox.sndStrucInfo,f.sndStruc,molmilConfigBox.sndStrucInfo[1]).slice(0,3);for(q=0;q<f.atoms.length;q++){f.atoms[q].rgb=molmil_dep.getKeyFromObject(molmilConfigBox.elementInfo,f.atoms[q].element,molmilConfigBox.elementInfo.DUMMY).slice(0,3)}}}else{if(s==2){for(d=0;d<g.molecules.length;d++){f=g.molecules[d];f.rgb=molmil_dep.getKeyFromObject(molmilConfigBox.sndStrucInfo,f.sndStruc,molmilConfigBox.sndStrucInfo[1]).slice(0,3);for(q=0;q<f.atoms.length;q++){f.atoms[q].rgb=f.rgb}}}else{if(s==3){for(d=0;d<g.molecules.length;d++){f=g.molecules[d];for(q=0;q<f.atoms.length;q++){f.atoms[q].rgb=molmil_dep.getKeyFromObject(molmilConfigBox.elementInfo,f.atoms[q].element,molmilConfigBox.elementInfo.DUMMY).slice(0,3)}f.rgb=molmil_dep.getKeyFromObject(molmilConfigBox.elementInfo,"C",molmilConfigBox.elementInfo.DUMMY).slice(0,3)}}else{if(s==4){n=[];for(o=0;o<g.chains.length;o++){b=g.chains[o];if(b.molecules.length>1){n=interpolateBR(b.molecules.length)}else{n=[[1,1,1]]}for(d=0;d<b.molecules.length;d++){f=b.molecules[d];f.rgb=n[d];for(q=0;q<f.atoms.length;q++){f.atoms[q].rgb=n[d]}}}}else{if(s==5){n=interpolateBR(g.chains.length);for(o=0;o<g.chains.length;o++){b=g.chains[o];for(d=0;d<b.molecules.length;d++){f=b.molecules[d];f.rgb=n[o];for(q=0;q<f.atoms.length;q++){f.atoms[q].rgb=n[o]}}}}else{if(s==6){for(d=0;d<g.molecules.length;d++){f=g.molecules[d];f.rgb=t;for(q=0;q<f.atoms.length;q++){f.atoms[q].rgb=f.rgb}}}}}}}}}else{if(g instanceof chainObject){if(s==1){for(d=0;d<g.molecules.length;d++){f=g.molecules[d];f.rgb=molmil_dep.getKeyFromObject(molmilConfigBox.sndStrucInfo,f.sndStruc,molmilConfigBox.sndStrucInfo[1]).slice(0,3);for(q=0;q<f.atoms.length;q++){f.atoms[q].rgb=molmil_dep.getKeyFromObject(molmilConfigBox.elementInfo,f.atoms[q].element,molmilConfigBox.elementInfo.DUMMY).slice(0,3)}}}else{if(s==2){for(d=0;d<g.molecules.length;d++){f=g.molecules[d];f.rgb=molmil_dep.getKeyFromObject(molmilConfigBox.sndStrucInfo,f.sndStruc,molmilConfigBox.sndStrucInfo[1]).slice(0,3);for(q=0;q<f.atoms.length;q++){f.atoms[q].rgb=f.rgb}}}else{if(s==3){for(d=0;d<g.molecules.length;d++){f=g.molecules[d];for(q=0;q<f.atoms.length;q++){f.atoms[q].rgb=molmil_dep.getKeyFromObject(molmilConfigBox.elementInfo,f.atoms[q].element,molmilConfigBox.elementInfo.DUMMY).slice(0,3)}f.rgb=molmil_dep.getKeyFromObject(molmilConfigBox.elementInfo,"C",molmilConfigBox.elementInfo.DUMMY).slice(0,3)}}else{if(s==4){n=[];b=g;if(b.molecules.length>1){n=interpolateBR(b.molecules.length)}else{n=[[1,1,1]]}for(d=0;d<b.molecules.length;d++){f=b.molecules[d];f.rgb=n[d];for(q=0;q<f.atoms.length;q++){f.atoms[q].rgb=n[d]}}}else{if(s==6){for(d=0;d<g.molecules.length;d++){f=g.molecules[d];f.rgb=t;for(q=0;q<f.atoms.length;q++){f.atoms[q].rgb=f.rgb}}}}}}}}else{if(g instanceof molObject){if(s==1){f=g;f.rgb=molmil_dep.getKeyFromObject(molmilConfigBox.sndStrucInfo,f.sndStruc,molmilConfigBox.sndStrucInfo[1]).slice(0,3);for(q=0;q<f.atoms.length;q++){f.atoms[q].rgb=molmil_dep.getKeyFromObject(molmilConfigBox.elementInfo,f.atoms[q].element,molmilConfigBox.elementInfo.DUMMY).slice(0,3)}}else{if(s==2){f=g;f.rgb=molmil_dep.getKeyFromObject(molmilConfigBox.sndStrucInfo,f.sndStruc,molmilConfigBox.sndStrucInfo[1]).slice(0,3);for(q=0;q<f.atoms.length;q++){f.atoms[q].rgb=f.rgb}}else{if(s==3){f=g;for(q=0;q<f.atoms.length;q++){f.atoms[q].rgb=molmil_dep.getKeyFromObject(molmilConfigBox.elementInfo,f.atoms[q].element,molmilConfigBox.elementInfo.DUMMY).slice(0,3)}f.rgb=molmil_dep.getKeyFromObject(molmilConfigBox.elementInfo,"C",molmilConfigBox.elementInfo.DUMMY).slice(0,3)}else{if(s==6){for(d=0;d<g.molecules.length;d++){f=g.molecules[d];f.rgb=t;for(q=0;q<f.atoms.length;q++){f.atoms[q].rgb=f.rgb}}}}}}}else{if(g instanceof atomObject){if(s==1||s==3){g.rgb=molmil_dep.getKeyFromObject(molmilConfigBox.elementInfo,g.element,molmilConfigBox.elementInfo.DUMMY).slice(0,3)}else{if(s==2){f=g.molecule;g.rgb=molmil_dep.getKeyFromObject(molmilConfigBox.sndStrucInfo,f.sndStruc,molmilConfigBox.sndStrucInfo[1]).slice(0,3)}else{if(s==6){g.rgb=t}}}}else{return}}}}if(!p){l.renderer.initBuffers();l.renderer.canvas.update=true}}function displayModels(f,h,d,g){if(h){for(var b=0;b<h.length;b++){displayEntry(f,h[b],d,true)}}if(!g){f.renderer.initBuffers();f.renderer.canvas.update=true}}function colorModels(f,h,d,g){if(h){for(var b=0;b<h.length;b++){colorEntry(f,h[b],d,[],true)}}if(!g){f.renderer.initBuffers();f.renderer.canvas.update=true}}function getAtomFromMolecule(b,f){for(var d=0;d<b.atoms.length;d++){if(b.atoms[d].atomName==f){return b.atoms[d]}}return null}function resetColors(f){var g;for(var b=0,d;b<f.models.length;b++){for(d=0;d<f.models[b].atoms.length;d++){g=molmil_dep.getKeyFromObject(molmilConfigBox.elementInfo,f.models[b].atoms[d].element,molmilConfigBox.elementInfo.DUMMY);f.models[b].atoms[d].rgb=[g[0],g[1],g[2]]}}for(var b=0,h;b<f.models.length;b++){for(h=0;h<f.models[b].molecules.length;h++){g=molmil_dep.getKeyFromObject(molmilConfigBox.sndStrucInfo,f.models[b].molecules[h].sndStruc,molmilConfigBox.sndStrucInfo[1]);f.models[b].molecules[h].rgb=[g[0],g[1],g[2]]}}}var ignoreBlackList=false;function isBlackListed(){if(ignoreBlackList){return false}if(navigator.userAgent.indexOf("Mac OS X 10.6")!=-1){return true}else{if(navigator.userAgent.indexOf("Mac OS X 10_6")!=-1){return true}}return false}function addEnableMomilButton(b){b.renderer=b.pdbjViewer.renderer;var f=molmil_dep.dcE("DIV");var d=f.pushNode(molmil_dep.createButton("Enable"));b.style.display="none";b.parentNode.pushNode(f);d.onclick=function(){ignoreBlackList=true;reloadPage()};return f}function createViewer(l,g,b,i,f){var d;var h=window.devicePixelRatio||1;if(l.tagName.toLowerCase()=="canvas"){d=l}else{d=l.pushNode("canvas")}g=g||d.width;b=b||d.height;d.width=g*h;d.height=b*h;d.defaultSize=[g,b];d.style.width=g+"px";d.style.height=b+"px";d.setSize=function(m,n){var o=window.devicePixelRatio||1;this.renderer.width=this.width=m*o;this.renderer.height=this.height=n*o;this.style.width=m+"px";this.style.height=n+"px";this.renderer.resizeViewPort();this.update=true;this.renderer.render()};if(i){d.pdbjViewer=i;setCanvas(i,d);d.pdbjViewer.renderer.camera=d.pdbjViewer.defaultCanvas[1].camera;d.pdbjViewer.renderer.QLV=d.pdbjViewer.defaultCanvas[1].QLV}else{d.pdbjViewer=new pdbjViewer(d);if(isBlackListed()){return addEnableMomilButton(d)}}if(!d.pdbjViewer.renderer.initGL(d)){return d.pdbjViewer.renderer.altCanvas}d.style.backgroundColor="rgb("+Math.round(molmilConfigBox.BGCOLOR[0]*255)+", "+Math.round(molmilConfigBox.BGCOLOR[1]*255)+", "+Math.round(molmilConfigBox.BGCOLOR[2]*255)+")";if(!f){d.pdbjViewer.UI.init()}d.pdbjViewer.renderer.initRenderer();if(i){d.renderer.initBuffers();d.update=true;safeStartViewer(d)}return d}function selectQLV(d,b,f){b=Math.min(Math.max(b,0),molmilConfigBox.QLV_SETTINGS.length-1);d.QLV=b;if(!f){d.initBuffers();d.canvas.update=true}}function interpolateBR(d){if(d==1){return[[0,0,1]]}var f=[];for(var b=0;b<d;b++){f.push(hslToRgb123((1-(b/(d-1)))*(2/3),1,0.5))}return f}function resetCOG(b,m){if(m){b.pdbjViewer.calculateCOG()}b.pdbjViewer.avgXYZ=[b.pdbjViewer.avgX,b.pdbjViewer.avgY,b.pdbjViewer.avgZ];b.pdbjViewer.stdXYZ=[b.pdbjViewer.stdX,b.pdbjViewer.stdY,b.pdbjViewer.stdZ];if(b.pdbjViewer.BUmode){b.pdbjViewer.avgXYZ=[0,0,0];b.pdbjViewer.stdXYZ=[0,0,0];var o=[b.pdbjViewer.avgX,b.pdbjViewer.avgY,b.pdbjViewer.avgZ];var d=[b.pdbjViewer.stdX,b.pdbjViewer.stdY,b.pdbjViewer.stdZ];var f=[0,0,0];var n=[];var l=b.pdbjViewer.bumats;if(b.pdbjViewer.AU_only&&b.pdbjViewer.BU_operExp){l=[b.pdbjViewer.bumats[b.pdbjViewer.BU_operExp-1]]}for(var h=0;h<l.length;h++){vec3.transformMat4(f,o,l[h]);vec3.add(b.pdbjViewer.avgXYZ,b.pdbjViewer.avgXYZ,f);n.push([f[0],f[1],f[2]])}b.pdbjViewer.avgXYZ[0]/=l.length;b.pdbjViewer.avgXYZ[1]/=l.length;b.pdbjViewer.avgXYZ[2]/=l.length;var g;for(var h=0;h<n.length;h++){g=n[h][0]-b.pdbjViewer.avgXYZ[0];b.pdbjViewer.stdXYZ[0]+=g*g;g=n[h][1]-b.pdbjViewer.avgXYZ[1];b.pdbjViewer.stdXYZ[1]+=g*g;g=n[h][2]-b.pdbjViewer.avgXYZ[2];b.pdbjViewer.stdXYZ[2]+=g*g}b.pdbjViewer.stdXYZ[0]=Math.sqrt(b.pdbjViewer.stdXYZ[0]/n.length);b.pdbjViewer.stdXYZ[1]=Math.sqrt(b.pdbjViewer.stdXYZ[0]/n.length);b.pdbjViewer.stdXYZ[2]=Math.sqrt(b.pdbjViewer.stdXYZ[0]/n.length);b.pdbjViewer.stdXYZ[0]=b.pdbjViewer.stdXYZ[0]+d[0];b.pdbjViewer.stdXYZ[1]=b.pdbjViewer.stdXYZ[1]+d[1];b.pdbjViewer.stdXYZ[2]=b.pdbjViewer.stdXYZ[2]+d[2]}b.pdbjViewer.COR=b.pdbjViewer.avgXYZ;b.renderer.camera.z=b.pdbjViewer.calcZ()}function toggleBU(q,P,A){var I=q.pdbjViewer.renderer;var t=I.gl;var O=q.pdbjViewer.models;if(!q.pdbjViewer.sceneBU){q.pdbjViewer.sceneBU={};q.pdbjViewer.sceneBU.displayedChains={};q.pdbjViewer.sceneBU.COR=JSON.parse(JSON.stringify(q.pdbjViewer.COR));q.pdbjViewer.sceneBU.geomRanges=JSON.parse(JSON.stringify(q.pdbjViewer.geomRanges))}for(var Q=0;Q<I.programs.length;Q++){if(I.programs[Q].BUprogram){I.programs.splice(Q,1);Q--}}if(P==-1){q.pdbjViewer.COR=JSON.parse(JSON.stringify(q.pdbjViewer.sceneBU.COR));q.pdbjViewer.geomRanges=JSON.parse(JSON.stringify(q.pdbjViewer.sceneBU.geomRanges));var E=false;for(V=0;V<O[0].chains.length;V++){if(!q.pdbjViewer.sceneBU.displayedChains[O[0].chains[V].name]&&q.pdbjViewer.poly_asym_ids.indexOf(O[0].chains[V].name)!=-1){displayEntry(q.pdbjViewer,O[0].chains[V],1,true);q.pdbjViewer.sceneBU.displayedChains[O[0].chains[V].name]=true;E=true}}if(E){I.initBuffers()}q.update=true;if(q.pdbjViewer.sceneBU.assembly_id!=P){I.camera.z=q.pdbjViewer.calcZ()}q.pdbjViewer.sceneBU.assembly_id=P;return}var B=0;if(A==1||A==2||A==3){B=1}if(A==4||A==5||A==6){B=2}var D=q.pdbjViewer.BUassemblies[P];var x;var x=JSON.parse(JSON.stringify(molmilConfigBox.backboneAtoms4Display));x.CA=1;var F,o,l,g,h,C,N,K;var Q=0,T,V,S,W,z,n=[],G,f=[0,0,0,0],J=[0,0,0];for(Q,V=0;Q<D.length;Q++){z=[];for(T=0;T<D[Q][1].length;T++){if(q.pdbjViewer.poly_asym_ids.indexOf(D[Q][1][T])!=-1){z.push(D[Q][1][T])}}n.push(z);for(T=0,W=0;T<D[Q][0].length;T++){S=q.pdbjViewer.BUmatrices[D[Q][0][T]];if(S[0]=="identity operation"){continue}W++}V+=z.length*W}var L=[],w;if(A==2||A==5){W=(n[0]||[]).length}else{if(A==3||A==6){W=V}}for(T=0,S=0;T<W;T++,S++){if(S>=molmilConfigBox.bu_colors.length){S=0}L.push(molmilConfigBox.bu_colors[S])}var U=1e+99,y=-1e+99,u=1e+99,R=-1e+99,M=1e+99,s=-1e+99;var Y=[q.pdbjViewer.sceneBU.geomRanges[0]+q.pdbjViewer.sceneBU.COR[0],q.pdbjViewer.sceneBU.geomRanges[2]+q.pdbjViewer.sceneBU.COR[1],q.pdbjViewer.sceneBU.geomRanges[4]+q.pdbjViewer.sceneBU.COR[2]];var W=[q.pdbjViewer.sceneBU.geomRanges[1]+q.pdbjViewer.sceneBU.COR[0],q.pdbjViewer.sceneBU.geomRanges[3]+q.pdbjViewer.sceneBU.COR[1],q.pdbjViewer.sceneBU.geomRanges[5]+q.pdbjViewer.sceneBU.COR[2]];var H={},X;for(Q=0,j=0;Q<D.length;Q++){z=n[Q];for(T=0;T<z.length;T++){if(q.pdbjViewer.BUcache.hasOwnProperty(z[T])&&q.pdbjViewer.BUcache[z[T]].hasOwnProperty(B)){V=q.pdbjViewer.BUcache[z[T]][B];N=V[0];K=V[1];G=V[2];X=V[3]}else{F=[];o={};if(B==1){for(W=0;W<O[0].bonds.length;W++){if(x.hasOwnProperty(O[0].bonds[W][0].atomName)&&x.hasOwnProperty(O[0].bonds[W][1].atomName)&&O[0].bonds[W][0].molecule.chain.name==z[T]&&O[0].bonds[W][1].molecule.chain.name==z[T]){F.push(O[0].bonds[W]);o[O[0].bonds[W][0].AID]=O[0].bonds[W][0];o[O[0].bonds[W][1].AID]=O[0].bonds[W][1]}}}else{if(B==2){for(S=0;S<O[0].molecules.length;S++){if(O[0].molecules[S].CA&&O[0].molecules[S].next&&O[0].molecules[S].chain.name==z[T]){F.push([O[0].molecules[S].CA,O[0].molecules[S].next.CA]);o[O[0].molecules[S].CA.AID]=O[0].molecules[S].CA;o[O[0].molecules[S].next.CA.AID]=O[0].molecules[S].next.CA}}}}AIDs=Object.keys(o);C={};g=new Float32Array((AIDs.length)*7);h=new Uint32Array(F.length*2);G=[0,0,0];for(V=0,S=0;V<AIDs.length;V++){g[S++]=o[AIDs[V]].xyz[0];g[S++]=o[AIDs[V]].xyz[1];g[S++]=o[AIDs[V]].xyz[2];G[0]+=o[AIDs[V]].xyz[0];G[1]+=o[AIDs[V]].xyz[1];G[2]+=o[AIDs[V]].xyz[2];l=molmil_dep.getKeyFromObject(molmilConfigBox.elementInfo,o[AIDs[V]].element,molmilConfigBox.elementInfo.DUMMY);g[S++]=l[0];g[S++]=l[1];g[S++]=l[2];g[S++]=AIDs[V];C[AIDs[V]]=V}G[0]/=AIDs.length;G[1]/=AIDs.length;G[2]/=AIDs.length;for(V=0,S=0;V<F.length;V++){h[S++]=C[F[V][0].AID];h[S++]=C[F[V][1].AID]}N=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,N);t.bufferData(t.ARRAY_BUFFER,g,t.STATIC_DRAW);K=t.createBuffer();t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,K);t.bufferData(t.ELEMENT_ARRAY_BUFFER,h,t.STATIC_DRAW);if(!q.pdbjViewer.BUcache.hasOwnProperty(z[T])){q.pdbjViewer.BUcache[z[T]]={}}q.pdbjViewer.BUcache[z[T]][B]=[N,K,G,X=h.length]}var d={};d.BUprogram=true;d.gl=t;d.renderer=I;d.nElements=X;d.vertexBuffer=N;d.indexBuffer=K;d.angle=false;d.matrices=[];w=true;if(A==1||A==4){for(V=0;V<D[Q][0].length;V++){S=q.pdbjViewer.BUmatrices[D[Q][0][V]];if(S[0]=="identity operation"){w=false;continue}d.matrices.push(S[1])}d.shader=I.shaders.lines;d.attributes=I.shaders.lines.attributes;d.render=function(b,Z){var p=mat4.create();for(var m=0;m<this.matrices.length;m++){mat4.multiply(p,b,this.matrices[m]);this.gl.useProgram(this.shader.program);this.gl.uniform3f(this.shader.uniforms.COR,Z[0],Z[1],Z[2]);this.gl.uniformMatrix4fv(this.shader.uniforms.modelViewMatrix,false,p);this.gl.uniformMatrix4fv(this.shader.uniforms.projectionMatrix,false,this.renderer.projectionMatrix);this.gl.uniform1f(this.shader.uniforms.focus,this.renderer.fogStart);this.gl.uniform1f(this.shader.uniforms.fogSpan,this.renderer.fogStart+(this.renderer.clearCut*2));this.render_internal()}};d.render_internal=function(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer);this.gl.vertexAttribPointer(this.attributes.in_Position,3,this.gl.FLOAT,false,28,0);this.gl.vertexAttribPointer(this.attributes.in_Colour,3,this.gl.FLOAT,false,28,12);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);if(this.angle){var i=0,b;while(true){b=Math.min(this.nElements[T]-i,3000000);if(b<1){break}this.gl.drawElements(this.gl.LINES,b,t.UNSIGNED_INT,i*4);i+=b}}else{this.gl.drawElements(this.gl.LINES,this.nElements,t.UNSIGNED_INT,0)}}}else{d.uniform_color=[];for(V=0;V<D[Q][0].length;V++){S=q.pdbjViewer.BUmatrices[D[Q][0][V]];if(S[0]=="identity operation"){w=false;continue}d.matrices.push(S[1]);if(A==2||A==5){d.uniform_color.push(L[T])}else{if(A==3||A==6){d.uniform_color.push(L[j++])}}}d.shader=I.shaders.lines_uniform_color;d.attributes=I.shaders.lines_uniform_color.attributes;d.render=function(b,Z){var p=mat4.create();for(var m=0;m<this.matrices.length;m++){mat4.multiply(p,b,this.matrices[m]);this.gl.useProgram(this.shader.program);this.gl.uniform3f(this.shader.uniforms.COR,Z[0],Z[1],Z[2]);this.gl.uniform3f(this.shader.uniforms.uniform_color,this.uniform_color[m][0],this.uniform_color[m][1],this.uniform_color[m][2]);this.gl.uniformMatrix4fv(this.shader.uniforms.modelViewMatrix,false,p);this.gl.uniformMatrix4fv(this.shader.uniforms.projectionMatrix,false,this.renderer.projectionMatrix);this.gl.uniform1f(this.shader.uniforms.focus,this.renderer.fogStart);this.gl.uniform1f(this.shader.uniforms.fogSpan,this.renderer.fogStart+(this.renderer.clearCut*2));this.render_internal()}};d.render_internal=function(){this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer);this.gl.vertexAttribPointer(this.attributes.in_Position,3,this.gl.FLOAT,false,28,0);this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);if(this.angle){var i=0,b;while(true){b=Math.min(this.nElements[T]-i,3000000);if(b<1){break}this.gl.drawElements(this.gl.LINES,b,t.UNSIGNED_INT,i*4);i+=b}}else{this.gl.drawElements(this.gl.LINES,this.nElements,t.UNSIGNED_INT,0)}}}d.renderPicking=function(){};if(d.matrices.length){I.programs.push(d)}if(!w){f[0]+=G[0];f[1]+=G[1];f[2]+=G[2];f[3]+=1;H[z[T]]=1}for(V=0;V<d.matrices.length;V++){vec3.transformMat4(J,G,d.matrices[V]);f[0]+=J[0];f[1]+=J[1];f[2]+=J[2];f[3]+=1;vec3.transformMat4(J,Y,d.matrices[V]);if(J[0]<U){U=J[0]}if(J[1]<u){u=J[1]}if(J[2]<M){M=J[2]}vec3.transformMat4(J,W,d.matrices[V]);if(J[0]>y){y=J[0]}if(J[1]>R){R=J[1]}if(J[2]>s){s=J[2]}}}}f[0]/=f[3];f[1]/=f[3];f[2]/=f[3];q.pdbjViewer.COR[0]=f[0];q.pdbjViewer.COR[1]=f[1];q.pdbjViewer.COR[2]=f[2];if(U<1000000000){q.pdbjViewer.geomRanges=[U-f[0],y-f[0],u-f[1],R-f[1],M-f[2],s-f[2]]}var E=false;for(V=0;V<O[0].chains.length;V++){if(H.hasOwnProperty(O[0].chains[V].name)){if(!q.pdbjViewer.sceneBU.displayedChains[O[0].chains[V].name]&&q.pdbjViewer.poly_asym_ids.indexOf(O[0].chains[V].name)!=-1){displayEntry(q.pdbjViewer,O[0].chains[V],1,true);q.pdbjViewer.sceneBU.displayedChains[O[0].chains[V].name]=true;E=true}}else{if(q.pdbjViewer.sceneBU.displayedChains[O[0].chains[V].name]&&q.pdbjViewer.poly_asym_ids.indexOf(O[0].chains[V].name)!=-1){displayEntry(q.pdbjViewer,O[0].chains[V],0,true);q.pdbjViewer.sceneBU.displayedChains[O[0].chains[V].name]=false;E=true}}}if(E||!I.initBD){I.initBuffers()}if(q.pdbjViewer.sceneBU.assembly_id!=P){I.camera.z=q.pdbjViewer.calcZ()}q.pdbjViewer.sceneBU.assembly_id=P;q.update=true}function enableBU(h,l){h.pdbjViewer.BUmode=true;var g=false;var n,d,f,i,b;if(h.pdbjViewer.models.length){for(var n=0;n<h.pdbjViewer.models[0].chains.length;n++){if(h.pdbjViewer.models[0].chains[n].AU_only){g=true;i=h.pdbjViewer.models[0].chains[n];for(d=0;d<i.molecules.length;d++){b=i.molecules[d];h.pdbjViewer.models[0].chains[n].molecules[d].status=0;for(f=0;f<b.atoms.length;f++){b.atoms[f].status=0}}}}}h.pdbjViewer.AU_only=g;resetCOG(h,g);if(!l){if(g){h.renderer.initBuffers()}h.update=true}}function disableBU(h,l){h.pdbjViewer.BUmode=false;var g=false;var n,d,f,i,b;if(h.pdbjViewer.models.length){for(var n=0;n<h.pdbjViewer.models[0].chains.length;n++){if(h.pdbjViewer.models[0].chains[n].AU_only){g=true;i=h.pdbjViewer.models[0].chains[n];for(d=0;d<i.molecules.length;d++){b=i.molecules[d];h.pdbjViewer.models[0].chains[n].molecules[d].status=1;for(f=0;f<b.atoms.length;f++){b.atoms[f].status=1}}}}}resetCOG(h,g);if(!l){if(g){h.renderer.initBuffers()}h.update=true}}function hslToRgb123(o,w,n){var d,t,u;if(w==0){d=t=u=n}else{function m(h,g,b){if(b<0){b+=1}if(b>1){b-=1}if(b<1/6){return h+(g-h)*6*b}if(b<1/2){return g}if(b<2/3){return h+(g-h)*(2/3-b)*6}return h}var f=n<0.5?n*(1+w):n+w-n*w;var i=2*n-f;d=m(i,f,o+1/3);t=m(i,f,o);u=m(i,f,o-1/3)}return[d,t,u]}function calcMMDistance(d,b){try{return vec3.distance(d.xyz,b.xyz)}catch(f){return NaN}}function calcMMAngle(d,b,l){var f=180/Math.PI,i=[0,0,0],h=[0,0,0];try{vec3.subtract(i,d.xyz,b.xyz);vec3.normalize(i,i);vec3.subtract(h,l.xyz,b.xyz);vec3.normalize(h,h);return Math.acos(vec3.dot(i,h))*f}catch(g){return NaN}}function calcMMTorsion(g,f,b,o){var d=180/Math.PI,n=[0,0,0],m=[0,0,0],i=[0,0,0],h=[0,0,0];try{vec3.subtract(n,f.xyz,g.xyz);vec3.subtract(m,b.xyz,g.xyz);vec3.cross(i,n,m);vec3.normalize(i,i);vec3.subtract(n,b.xyz,f.xyz);vec3.subtract(m,o.xyz,f.xyz);vec3.cross(h,n,m);vec3.normalize(h,h);return Math.acos(vec3.dot(i,h))*d}catch(l){return NaN}}function molmil_linkCanvases(d){for(var b=1;b<d.length;b++){d[b].renderer.camera=d[0].renderer.camera}for(var b=0;b<d.length;b++){d[b].pdbjViewer.canvases=d}}function __webglNotSupported__(b){if(window.webglNotSupported){return webglNotSupported(b)}var d=molmil_dep.dcE("DIV");d.innerHTML='Your browser seems to not support WebGL. Please visit the <a target="blank" class="external" href="http://get.webgl.org/">WebGL website</a> for more info on how to gain WebGL support on your browser.';d.style.border="1px solid #ddd";d.style.margin=d.style.padding=".25em";b.parentNode.replaceChild(d,b);return d}function calcRMSD(p,o,F){if(p.length!=o.length){console.log("ERROR: both structures should have the same number of atoms");return}var f=0,d=0,H=0,G=0,u=0,t=0,b=p.length,V,P;if(p instanceof Float32Array){V=p;P=o;b/=3;for(var T=0,O=0;T<b;T++,O+=3){f+=V[O];H+=V[O+1];u+=V[O+2];d+=P[O];G+=P[O+1];t+=P[O+2]}}else{V=new Float32Array(b*3);P=new Float32Array(b*3);for(var T=0,O=0;T<b;T++,O+=3){V[O]=p[T].xyz[0];V[O+1]=p[T].xyz[1];V[O+2]=p[T].xyz[2];P[O]=o[T].xyz[0];P[O+1]=o[T].xyz[1];P[O+2]=o[T].xyz[2];f+=V[O];H+=V[O+1];u+=V[O+2];d+=P[O];G+=P[O+1];t+=P[O+2]}}var Q=0,x=0;f/=b;H/=b;u/=b;d/=b;G/=b;t/=b;for(var T=0,O=0;T<b;T++,O+=3){V[O]-=f;V[O+1]-=H;V[O+2]-=u;P[O]-=d;P[O+1]-=G;P[O+2]-=t;Q+=V[O]*V[O]+V[O+1]*V[O+1]+V[O+2]*V[O+2];x+=P[O]*P[O]+P[O+1]*P[O+1]+P[O+2]*P[O+2]}var m=new Float64Array(9);for(var T=0;T<b*3;T+=3){m[0]+=V[T]*P[T];m[1]+=V[T]*P[T+1];m[2]+=V[T]*P[T+2];m[3]+=V[T+1]*P[T];m[4]+=V[T+1]*P[T+1];m[5]+=V[T+1]*P[T+2];m[6]+=V[T+2]*P[T];m[7]+=V[T+2]*P[T+1];m[8]+=V[T+2]*P[T+2]}var l=new Float64Array(16);l[0]=m[0]+m[4]+m[8];l[5]=m[0]-m[4]-m[8];l[10]=-m[0]+m[4]-m[8];l[15]=-m[0]-m[4]+m[8];l[1]=l[4]=m[5]-m[7];l[2]=l[8]=m[6]-m[2];l[3]=l[12]=m[1]-m[3];l[6]=l[9]=m[1]+m[3];l[7]=l[13]=m[2]+m[6];l[11]=l[14]=m[5]+m[7];var N=[1,1,1,1];var U=EVpowerMethod(N,l);vec4.negate(N,N);var D=[Math.sqrt(Math.max(0,(Q+x)-(2*U))/b)];if(F){var E=2*N[0],C=2*N[1],B=2*N[2],A=2*N[3];var M=E*N[0]-1,K=E*N[1],J=E*N[2],I=E*N[3],z=C*N[1],y=C*N[2],w=C*N[3],h=B*N[2],g=B*N[3],L=A*N[3];var s=new Float64Array(16);s[0]=M+z;s[1]=y-I;s[2]=w+J;s[4]=y+I;s[5]=M+h;s[6]=g-K;s[8]=w-J;s[9]=g+K;s[10]=M+L;s[15]=1;D.push(s,[f,H,u],[d,G,t])}return D}function EVpowerMethod(h,b,m){m=m||10000;var g=1e-9,l=0,d=0,f=0,n=new Float64Array(4);f=Math.sqrt(h[0]*h[0]+h[1]*h[1]+h[2]*h[2]+h[3]*h[3]);h[0]/=f;h[1]/=f;h[2]/=f;h[3]/=f;while(l<=m){vec4.transformMat4(n,h,b);f=Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]+n[3]*n[3]);h[0]=n[0]/f;h[1]=n[1]/f;h[2]=n[2]/f;h[3]=n[3]/f;if(Math.abs((f-d)/f)<g){return f}d=f;l++}return null}if(typeof(requestAnimationFrame)!="undefined"){animate_pdbjViewers()}if(!window.molmil_dep){var dep=document.createElement("script");dep.src=molmil_settings.src+"/molmil_dep.js";var head=document.getElementsByTagName("head")[0];head.appendChild(dep)}initSettings();