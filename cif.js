/*!
 * cif.js
 *
 * JavaScript CIF parser: https://github.com/gjbekker/cif-parsers
 * 
 * By Gert-Jan Bekker
 * License: MIT
 *   See https://github.com/gjbekker/cif-parsers/blob/master/LICENSE
 */
;function PDBMLparser(){this.data={}}PDBMLparser.prototype.parse=function(h){var m=h.documentElement;var d=this.data["data_"+m.getAttribute("datablockName")]={};var b,q,a,o,l,p,r,c;for(var g=0,f,e;g<m.childNodes.length;g++){o=m.childNodes[g];q=o.localName;if(!q){continue}q=q.substr(0,q.length-8);b=d[q]={};a=o.childNodes.length>3;c=0;for(f=0;f<o.childNodes.length;f++){l=o.childNodes[f];if(!l.localName){continue}p=[];for(e=0;e<l.attributes.length;e++){r=l.attributes.item(e);if(a){if(!b.hasOwnProperty(r.localName)){b[r.localName]=new Array(c)}b[r.localName].push(r.nodeValue);p.push(r.localName)}else{b[r.localName]=[r.nodeValue]}}for(e=0;e<l.childNodes.length;e++){r=l.childNodes[e];if(!r.localName){continue}if(a){if(!b.hasOwnProperty(r.localName)){b[r.localName]=new Array(c)}b[r.localName].push(r.textContent);p.push(r.localName)}else{b[r.localName]=[r.textContent]}}if(a){for(e in b){if(p.indexOf(e)==-1){b[e].push(null)}}}c++}}};function loadPDBML(f,d){var j=new PDBMLparser();j.parse(f);if(d){return j.data}if(!window.__CIFDICT__){loadCIFdic()}var b,h,g,c,a;for(h in j.data){for(g in j.data[h]){if(!__CIFDICT__.hasOwnProperty(g)){continue}for(c in j.data[h][g]){if(!__CIFDICT__[g].hasOwnProperty(c)){continue}b=__CIFDICT__[g][c];if(j.data[h][g][c] instanceof Array){for(a=0;a<j.data[h][g][c].length;a++){j.data[h][g][c][a]=b.call(null,j.data[h][g][c][a])}}else{j.data[h][g][c]=b.call(null,j.data[h][g][c])}}}}return j.data}function setupCIFTree(d,c,b){var a=d.pushNode("DIV");a.expandableTarget=b;a.popup=d.parentNode;a.topNode=true;renderChildCIFTree(a,c);if(a.childNodes.length==1&&a.childNodes[0].childNodes[0].className.indexOf("optCat_p")!=-1){a.childNodes[0].childNodes[0].onclick()}return a}function renderChildCIFTree(g,a){var f;var e=Object.keys(a);var d=null,h;if(a[e[0]] instanceof Array){var d=new drawTable(),h;if(!g.showAll||a[e[0]].length<10000){d.tbl.setClass("dTO eqSpacedTbl")}d.tbl.border="1";d.tbl.style.width="";h=d.addRowXH(e);for(var c=0,b;c<(g.showAll?a[e[0]].length:Math.min(a[e[0]].length,25));c++){h=d.addRow();for(b=0;b<e.length;b++){h.addCell(a[e[b]][c])}}g.pushNode(d.tbl);if(!g.showAll&&a[e[0]].length>25){h=g.pushNode("a","Show all ("+a[e[0]].length+(a[e[0]].length>2500?" rows, which will take some time to process and might cause your browser to become unresponsive. Alternatively, switch to flat file representation.":" rows")+")");h.targetObj=g;h.jso=a;h.style.cursor="pointer";h.onclick=function(){Clear(this.targetObj);this.targetObj.showAll=true;renderChildCIFTree(this.targetObj,this.jso)}}}else{for(var c=0;c<e.length;c++){f=g.pushNode("DIV");f.plus=f.pushNode("a","+");f.plus.setClass("optCat_p");f.name=f.pushNode("a",e[c]);f.name.setClass("optCat_n");f.plus.onclick=f.name.onclick=expandCatTree;f.payload=a[e[c]];f.expandFunc=renderChildCIFTree}}}function _loop(a){this.parserObj=a;this.length=0;this.refID=-1;this.refList=[];this.namesDefined=false}_loop.prototype.addName=function(b){var a=molmil_dep.Partition(b,".");var c=this.parserObj.currentTarget[this.parserObj.currentTarget.length-2];if(a[1]){if(!c.hasOwnProperty(a[0])){c[a[0]]={}}if(!c[a[0]].hasOwnProperty(a[2])){c[a[0]][a[2]]=[]}this.refList.push(c[a[0]][a[2]])}else{if(!c.hasOwnProperty(a[0])){c[a[0]]=[]}this.refList.push(c[a[0]])}this.length=this.refList.length};_loop.prototype.pushValue=function(a){this.namesDefined=true;var b=this.nextTarget();if(a=="stop_"){return this.stopPush()}b.push(a)};_loop.prototype.nextTarget=function(){this.refID=(this.refID+1)%this.length;return this.refList[this.refID]};_loop.prototype.stopPush=function(){this.refID=-1};function CIFparser(){this.data={};this.currentTarget=null;this.loopPointer=null;this.selectGlobal()}CIFparser.prototype.parse=function(f){var c=f.split("\n"),b,a=[],d=false,g;for(var e=0;e<c.length;e++){g=c[e].substr(0,1);b=c[e].trim();if(g==";"){if(d){this.setDataValue(a.join("\n"))}else{a=[]}d=!d;b=b.substr(1).trim()}if(d){a.push(b)}else{this.processContent(this.specialSplit(b))}}};CIFparser.prototype.specialSplit=function(f){var c=[["",false]],b=false,e=f.length,g,a=0;for(var d=0;d<e;d++){g=f[d]==" "||f[d]=="\t";if((f[d]=="'"||f[d]=='"')&&(d==0||f[d-1]==" "||f[d-1]=="\t"||d==e-1||f[d+1]==" "||f[d+1]=="\t")){b=!b}else{if(!b&&g&&c[a][0]!=""){c.push(["",false]);a++}else{if(!b&&f[d]=="#"){break}else{if(!g||b){c[a][0]+=f[d];c[a][1]=b}}}}}if(c[a][0]==""){c.pop()}return c};CIFparser.prototype.processContent=function(b){for(var a=0;a<b.length;a++){if(b[a][0]=="global_"&&!b[a][0]){this.loopPointer=null;this.selectGlobal()}else{if(b[a][0].substr(0,5)=="data_"&&!b[a][1]){this.loopPointer=null;this.selectData(b[a][0])}else{if(b[a][0].substr(0,5)=="save_"&&!b[a][1]){this.loopPointer=null;if(b[a][0].substr(5).length){this.selectFrame(b[a][0])}else{this.endFrame()}}else{if(b[a][0]=="loop_"&&!b[a][1]){this.loopPointer=new _loop(this)}else{if(b[a][0].substr(0,1)=="_"&&!b[a][1]){this.setDataName(b[a][0].substr(1))}else{this.setDataValue(b[a][0])}}}}}}};CIFparser.prototype.setDataName=function(a){if(this.loopPointer!=null){if(this.loopPointer.namesDefined){this.loopPointer=null}else{return this.loopPointer.addName(a)}}var a=molmil_dep.Partition(a,".");this.currentTarget.pop();if(a[1]){if(!this.currentTarget[this.currentTarget.length-1].hasOwnProperty(a[0])){this.currentTarget[this.currentTarget.length-1][a[0]]={}}this.currentTarget[this.currentTarget.length-1][a[0]][a[2]]="";this.currentTarget.push([this.currentTarget[this.currentTarget.length-1][a[0]],a[2]])}else{this.currentTarget[this.currentTarget.length-1][a[0]]="";this.currentTarget.push([this.currentTarget[this.currentTarget.length-1],a[0]])}};CIFparser.prototype.setDataValue=function(b){if(this.loopPointer!=null){this.loopPointer.pushValue(b)}else{var a=this.currentTarget[this.currentTarget.length-1];a[0][a[1]]=[b]}};CIFparser.prototype.selectGlobal=function(){this.currentTarget=[this.data,this.data,null]};CIFparser.prototype.selectData=function(a){if(!this.data.hasOwnProperty(a)){this.data[a]={}}this.currentTarget=[this.data,this.data[a],null]};CIFparser.prototype.selectFrame=function(a){if(!this.currentTarget[1].hasOwnProperty(a)){this.currentTarget[1][a]={}}this.currentTarget=this.currentTarget.slice(0,2);this.currentTarget.push(this.currentTarget[1][a]);this.currentTarget.push(null)};CIFparser.prototype.endData=function(){this.currentTarget=this.currentTarget.slice(0,2)};CIFparser.prototype.endFrame=function(){this.currentTarget=this.currentTarget.slice(0,3)};function loadCIFdic(){var f={};var d=new molmil_dep.CallRemote("GET");try{d.Send(molmil.settings.src+"mmcif_pdbx_v40_summary.json");f=JSON.parse(d.request.responseText)}catch(h){var d=new molmil_dep.CallRemote("GET");d.Send(molmil.settings.src+"mmcif_pdbx_v40.dic");var i=new CIFparser();i.parse(d.request.responseText);var c=i.data["data_mmcif_pdbx.dic"],a;for(var h in c){if(typeof c[h]!="object"||c[h] instanceof Array||!c[h].hasOwnProperty("item_type")){continue}a=molmil_dep.Partition(h.substr(6),".");if(!f.hasOwnProperty(a[0])){f[a[0]]={}}f[a[0]][a[2]]=c[h].item_type.code.trim()}}var b={},g;for(var h in f){for(g in f[h]){if(f[h][g]=="int"){if(!b.hasOwnProperty(h)){b[h]={}}b[h][g]=parseInt}else{if(f[h][g]=="float"){if(!b.hasOwnProperty(h)){b[h]={}}b[h][g]=parseFloat}else{if(f[h][g]=="int-range"){if(!b.hasOwnProperty(h)){b[h]={}}b[h][g]=parseIntRange}else{if(f[h][g]=="float-range"){if(!b.hasOwnProperty(h)){b[h]={}}b[h][g]=parseFloatRange}}}}}}__CIFDICT__=b}function parseIntRange(a){try{var c=a.indexOf("-",1);if(c==-1){throw -1}return[parseInt(a.substr(0,c)),parseInt(a.substr(c+1))]}catch(b){return[parseInt(a)]}}function parseFloatRange(a){try{var c=a.indexOf("-",1);if(c==-1){throw -1}return[parseFloat(a.substr(0,c)),parseFloat(a.substr(c+1))]}catch(b){return[parseFloat(a)]}}function loadCIF(f,d){var j=new CIFparser();j.parse(f);if(d){return j.data}if(!window.__CIFDICT__){loadCIFdic()}var h,g,c,a;for(h in j.data){for(g in j.data[h]){for(c in j.data[h][g]){if(j.data[h][g][c] instanceof Array){for(a=0;a<j.data[h][g][c].length;a++){j.data[h][g][c][a]=!(j.data[h][g][c][a]=="?"||j.data[h][g][c][a]==".")?j.data[h][g][c][a]:null}}else{j.data[h][g][c]=!(j.data[h][g][c]=="?"||j.data[h][g][c]==".")?j.data[h][g][c]:null}}}}var b;for(h in j.data){for(g in j.data[h]){if(!__CIFDICT__.hasOwnProperty(g)){continue}for(c in j.data[h][g]){if(!__CIFDICT__[g].hasOwnProperty(c)){continue}b=__CIFDICT__[g][c];if(j.data[h][g][c] instanceof Array){for(a=0;a<j.data[h][g][c].length;a++){j.data[h][g][c][a]=b.call(null,j.data[h][g][c][a])}}else{j.data[h][g][c]=b.call(null,j.data[h][g][c])}}}}return j.data};